{"version":3,"file":"GlobalConfig.5d516967a2de96322235.js","mappings":"gWAyBA,MAAMA,EAA4B,CAChC,iBAAkB,EACpB,EAEaC,EAAmB,CAAC,CAAE,OAAAC,EAAQ,uBAAAC,CAAuB,IAAa,CAC7E,MAAMC,KAAW,eAAY,KAE7BC,EAAA,GAAYC,GAAWA,EAAM,gBAAgB,aAAe,IAAyB,EAErF,KAAM,CAAE,QAAAC,EAAS,MAAAC,CAAM,KAAIC,EAAA,GAA4BH,GAAUA,EAAM,YAAY,EAC7EI,KAAW,MAA0CP,CAAsB,EAE3EQ,KAAU,MAAoB,CAElC,cAAe,KAAK,MAClB,KAAK,UAAU,CACb,GAAGX,EACH,GAAIE,EAAO,oBAAoB,QAAU,CAAC,CAC5C,CAAC,CACH,CACF,CAAC,EAEK,CACJ,aAAAU,EACA,UAAW,CAAE,OAAAC,CAAO,CACtB,EAAIF,EAEEG,EAAoBC,GAAuB,CAC/CX,KACE,MAA+B,CAC7B,UAAW,CACT,GAAGF,EACH,oBAAqB,CACnB,GAAGA,EAAO,oBACV,UAAQ,MAAgBa,CAAM,CAChC,CACF,EACA,UAAWb,EACX,uBAAAC,EACA,eAAgB,yBAChB,gBAAc,MAAW,0BAA2BA,CAAsB,CAC5E,CAAC,CACH,CACF,EAEA,SACE,OAAC,KAAY,CAAE,GAAGQ,EAChB,oBAAC,QAAK,SAAUC,EAAaE,CAAgB,EAC1C,UAAAN,MACC,OAACQ,EAAA,GACC,SAAS,QACT,SAAO,KAAE,0DAA2D,uBAAuB,EAE1F,SAAAR,EAAM,SAAW,OAAOA,CAAK,EAChC,EAED,IAAoB,IAAKS,MACxB,OAACC,EAAA,GACC,SAAAR,EACA,aAAcV,EAAciB,EAAO,YAAY,EAE/C,OAAAA,EACA,MAAOJ,EAAOI,EAAO,YAAY,EACjC,WAAY,IAHPA,EAAO,YAId,CACD,KACD,OAAC,OACC,oBAACE,EAAA,EAAK,CACH,WAACT,MACA,oBACG,UAAAH,MACC,OAACa,EAAA,GAAM,CAAC,SAAU,GAAM,KAAK,UAAU,QAAQ,UAC7C,mBAAC,KAAK,CAAC,QAAQ,qCAAqC,qBAAS,EAC/D,EAED,CAACb,MACA,OAACa,EAAA,GAAM,CAAC,KAAK,SACX,mBAAC,KAAK,CAAC,QAAQ,iDAAiD,8BAAkB,EACpF,GAEJ,KAEF,OAAC,MACC,SAAUb,EACV,KAAK,UACL,QAAQ,YACR,QAAM,MAAW,yBAA0BJ,CAAsB,EAEjE,mBAAC,KAAK,CAAC,QAAQ,yBAAyB,kBAAM,EAChD,GACF,EACF,GACF,EACF,CAEJ,EC/GMkB,EAAe,IAAM,CACzB,KAAM,CAAE,qBAAAC,CAAqB,KAAI,MAAgB,EAC3C,CAAE,KAAAC,EAAM,UAAAC,EAAW,MAAAhB,CAAM,KAAIiB,EAAA,GAAsBH,CAAoB,EAE7E,OAAIE,GAAa,CAACD,EACT,aAGLf,KAEA,OAACQ,EAAA,GACC,SAAS,QACT,SAAO,KACL,qEACA,uCACF,EAEC,gBAAOR,CAAK,EACf,EAICe,KAIE,OAACtB,EAAgB,CAAC,OAAQsB,EAAM,uBAAwBD,CAAA,CAAuB,EAH7E,IAIX,EAEA,SAASI,GAAmB,CAC1B,SACE,OAAC,IAAuB,CAAC,MAAM,YAAY,WAAW,eACpD,mBAACL,EAAA,EAAa,EAChB,CAEJ,CAEA,WAAeM,EAAA,GAAsBD,CAAgB,C,kDCnC9C,SAASD,EAAsBG,EAAuBC,EAAmB,CAC9E,MAAMC,EAAc,IAAgB,UAAU,6BAA6B,SAASF,GAAgB,GAAI,CAEtG,0BAA2B,GAC3B,GAAGC,EACH,KAAM,CAACD,CACT,CAAC,EAED,MAAO,CACL,GAAGE,EAEH,MAAOA,EAAY,KACrB,CACF,C","sources":["webpack://grafana/./public/app/features/alerting/unified/components/receivers/GlobalConfigForm.tsx","webpack://grafana/./public/app/features/alerting/unified/components/contact-points/components/GlobalConfig.tsx","webpack://grafana/./public/app/features/alerting/unified/hooks/useAlertmanagerConfig.ts"],"sourcesContent":["import { FormProvider, useForm } from 'react-hook-form';\n\nimport { Alert, Button, LinkButton, Stack } from '@grafana/ui';\nimport { useCleanup } from 'app/core/hooks/useCleanup';\nimport { Trans, t } from 'app/core/internationalization';\nimport { AlertManagerCortexConfig } from 'app/plugins/datasource/alertmanager/types';\nimport { useDispatch } from 'app/types';\n\nimport { useUnifiedAlertingSelector } from '../../hooks/useUnifiedAlertingSelector';\nimport { updateAlertManagerConfigAction } from '../../state/actions';\nimport { globalConfigOptions } from '../../utils/cloud-alertmanager-notifier-types';\nimport { isVanillaPrometheusAlertManagerDataSource } from '../../utils/datasource';\nimport { makeAMLink } from '../../utils/misc';\nimport { omitEmptyValues } from '../../utils/receiver-form';\nimport { initialAsyncRequestState } from '../../utils/redux';\n\nimport { OptionField } from './form/fields/OptionField';\n\ninterface Props {\n  config: AlertManagerCortexConfig;\n  alertManagerSourceName: string;\n}\n\ntype FormValues = Record<string, unknown>;\n\nconst defaultValues: FormValues = {\n  smtp_require_tls: true,\n} as const;\n\nexport const GlobalConfigForm = ({ config, alertManagerSourceName }: Props) => {\n  const dispatch = useDispatch();\n\n  useCleanup((state) => (state.unifiedAlerting.saveAMConfig = initialAsyncRequestState));\n\n  const { loading, error } = useUnifiedAlertingSelector((state) => state.saveAMConfig);\n  const readOnly = isVanillaPrometheusAlertManagerDataSource(alertManagerSourceName);\n\n  const formAPI = useForm<FormValues>({\n    // making a copy here beacuse react-hook-form will mutate these, and break if the object is frozen. for real.\n    defaultValues: JSON.parse(\n      JSON.stringify({\n        ...defaultValues,\n        ...(config.alertmanager_config.global ?? {}),\n      })\n    ),\n  });\n\n  const {\n    handleSubmit,\n    formState: { errors },\n  } = formAPI;\n\n  const onSubmitCallback = (values: FormValues) => {\n    dispatch(\n      updateAlertManagerConfigAction({\n        newConfig: {\n          ...config,\n          alertmanager_config: {\n            ...config.alertmanager_config,\n            global: omitEmptyValues(values),\n          },\n        },\n        oldConfig: config,\n        alertManagerSourceName,\n        successMessage: 'Global config updated.',\n        redirectPath: makeAMLink('/alerting/notifications', alertManagerSourceName),\n      })\n    );\n  };\n\n  return (\n    <FormProvider {...formAPI}>\n      <form onSubmit={handleSubmit(onSubmitCallback)}>\n        {error && (\n          <Alert\n            severity=\"error\"\n            title={t('alerting.global-config-form.title-error-saving-receiver', 'Error saving receiver')}\n          >\n            {error.message || String(error)}\n          </Alert>\n        )}\n        {globalConfigOptions.map((option) => (\n          <OptionField\n            readOnly={readOnly}\n            defaultValue={defaultValues[option.propertyName]}\n            key={option.propertyName}\n            option={option}\n            error={errors[option.propertyName]}\n            pathPrefix={''}\n          />\n        ))}\n        <div>\n          <Stack>\n            {!readOnly && (\n              <>\n                {loading && (\n                  <Button disabled={true} icon=\"spinner\" variant=\"primary\">\n                    <Trans i18nKey=\"alerting.global-config-form.saving\">Saving...</Trans>\n                  </Button>\n                )}\n                {!loading && (\n                  <Button type=\"submit\">\n                    <Trans i18nKey=\"alerting.global-config-form.save-global-config\">Save global config</Trans>\n                  </Button>\n                )}\n              </>\n            )}\n            <LinkButton\n              disabled={loading}\n              fill=\"outline\"\n              variant=\"secondary\"\n              href={makeAMLink('alerting/notifications', alertManagerSourceName)}\n            >\n              <Trans i18nKey=\"alerting.common.cancel\">Cancel</Trans>\n            </LinkButton>\n          </Stack>\n        </div>\n      </form>\n    </FormProvider>\n  );\n};\n","import { Alert } from '@grafana/ui';\nimport { t } from 'app/core/internationalization';\n\nimport { useAlertmanagerConfig } from '../../../hooks/useAlertmanagerConfig';\nimport { useAlertmanager } from '../../../state/AlertmanagerContext';\nimport { withPageErrorBoundary } from '../../../withPageErrorBoundary';\nimport { AlertmanagerPageWrapper } from '../../AlertingPageWrapper';\nimport { GlobalConfigForm } from '../../receivers/GlobalConfigForm';\n\nconst GlobalConfig = () => {\n  const { selectedAlertmanager } = useAlertmanager();\n  const { data, isLoading, error } = useAlertmanagerConfig(selectedAlertmanager);\n\n  if (isLoading && !data) {\n    return 'loading...';\n  }\n\n  if (error) {\n    return (\n      <Alert\n        severity=\"error\"\n        title={t(\n          'alerting.global-config.title-failed-to-fetch-notification-template',\n          'Failed to fetch notification template'\n        )}\n      >\n        {String(error)}\n      </Alert>\n    );\n  }\n\n  if (!data) {\n    return null;\n  }\n\n  return <GlobalConfigForm config={data} alertManagerSourceName={selectedAlertmanager!} />;\n};\n\nfunction GlobalConfigPage() {\n  return (\n    <AlertmanagerPageWrapper navId=\"receivers\" accessType=\"notification\">\n      <GlobalConfig />\n    </AlertmanagerPageWrapper>\n  );\n}\n\nexport default withPageErrorBoundary(GlobalConfigPage);\n","import { SerializedError } from '@reduxjs/toolkit';\n\nimport { alertmanagerApi } from '../api/alertmanagerApi';\n\ntype Options = {\n  refetchOnFocus: boolean;\n  refetchOnReconnect: boolean;\n};\n\n// TODO refactor this so we can just call \"alertmanagerApi.endpoints.getAlertmanagerConfiguration\" everywhere\n// and remove this hook since it adds little value\nexport function useAlertmanagerConfig(amSourceName?: string, options?: Options) {\n  const fetchConfig = alertmanagerApi.endpoints.getAlertmanagerConfiguration.useQuery(amSourceName ?? '', {\n    // we'll disable cache by default to prevent overwriting other changes made since last fetch\n    refetchOnMountOrArgChange: true,\n    ...options,\n    skip: !amSourceName,\n  });\n\n  return {\n    ...fetchConfig,\n    // TODO refactor to get rid of this type assertion\n    error: fetchConfig.error as SerializedError,\n  };\n}\n"],"names":["defaultValues","GlobalConfigForm","config","alertManagerSourceName","dispatch","useCleanup","state","loading","error","useUnifiedAlertingSelector","readOnly","formAPI","handleSubmit","errors","onSubmitCallback","values","Alert","option","OptionField","Stack","Button","GlobalConfig","selectedAlertmanager","data","isLoading","useAlertmanagerConfig","GlobalConfigPage","withPageErrorBoundary","amSourceName","options","fetchConfig"],"sourceRoot":""}