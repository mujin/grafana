"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[6134],{28947:(Ja,le,h)=>{h.r(le),h.d(le,{plugin:()=>Ua});var ue=h(94644),i=h(74848),v=h(22803),M=h(63142),F=h(45861),S=h(65307);const He=(0,S.VP)("init"),Ue=(0,S.VP)("time-range-changed"),Je=(0,S.VP)("queries-changed"),Ke=(0,S.VP)("query-changed"),Xe=(0,S.VP)("segment-value-changed"),Ye=(0,S.VP)("add-new-tag"),Ze=(0,S.VP)("tag-changed"),_e=(0,S.VP)("unpause"),et=(0,S.VP)("add-function"),tt=(0,S.VP)("remove-function"),at=(0,S.VP)("move-function"),rt=(0,S.VP)("change-function-param"),nt=(0,S.VP)("update-query"),st=(0,S.VP)("run-current-query"),it=(0,S.VP)("toggle-editor"),y={init:He,timeRangeChanged:Ue,queriesChanged:Je,queryChanged:Ke,segmentValueChanged:Xe,tagChanged:Ze,addNewTag:Ye,unpause:_e,addFunction:et,removeFunction:tt,moveFunction:at,updateFunctionParam:rt,updateQuery:nt,runQuery:st,toggleEditorMode:it};var f=h(96540),ot=h(84596),ce=h(59373),m=h(2543),lt=h(49344);const H=[170,170,181,181,186,186,192,214,216,246,248,705,710,721,736,740,748,748,750,750,880,884,886,887,890,893,902,902,904,906,908,908,910,929,931,1013,1015,1153,1162,1319,1329,1366,1369,1369,1377,1415,1488,1514,1520,1522,1568,1610,1646,1647,1649,1747,1749,1749,1765,1766,1774,1775,1786,1788,1791,1791,1808,1808,1810,1839,1869,1957,1969,1969,1994,2026,2036,2037,2042,2042,2048,2069,2074,2074,2084,2084,2088,2088,2112,2136,2308,2361,2365,2365,2384,2384,2392,2401,2417,2423,2425,2431,2437,2444,2447,2448,2451,2472,2474,2480,2482,2482,2486,2489,2493,2493,2510,2510,2524,2525,2527,2529,2544,2545,2565,2570,2575,2576,2579,2600,2602,2608,2610,2611,2613,2614,2616,2617,2649,2652,2654,2654,2674,2676,2693,2701,2703,2705,2707,2728,2730,2736,2738,2739,2741,2745,2749,2749,2768,2768,2784,2785,2821,2828,2831,2832,2835,2856,2858,2864,2866,2867,2869,2873,2877,2877,2908,2909,2911,2913,2929,2929,2947,2947,2949,2954,2958,2960,2962,2965,2969,2970,2972,2972,2974,2975,2979,2980,2984,2986,2990,3001,3024,3024,3077,3084,3086,3088,3090,3112,3114,3123,3125,3129,3133,3133,3160,3161,3168,3169,3205,3212,3214,3216,3218,3240,3242,3251,3253,3257,3261,3261,3294,3294,3296,3297,3313,3314,3333,3340,3342,3344,3346,3386,3389,3389,3406,3406,3424,3425,3450,3455,3461,3478,3482,3505,3507,3515,3517,3517,3520,3526,3585,3632,3634,3635,3648,3654,3713,3714,3716,3716,3719,3720,3722,3722,3725,3725,3732,3735,3737,3743,3745,3747,3749,3749,3751,3751,3754,3755,3757,3760,3762,3763,3773,3773,3776,3780,3782,3782,3804,3805,3840,3840,3904,3911,3913,3948,3976,3980,4096,4138,4159,4159,4176,4181,4186,4189,4193,4193,4197,4198,4206,4208,4213,4225,4238,4238,4256,4293,4304,4346,4348,4348,4352,4680,4682,4685,4688,4694,4696,4696,4698,4701,4704,4744,4746,4749,4752,4784,4786,4789,4792,4798,4800,4800,4802,4805,4808,4822,4824,4880,4882,4885,4888,4954,4992,5007,5024,5108,5121,5740,5743,5759,5761,5786,5792,5866,5870,5872,5888,5900,5902,5905,5920,5937,5952,5969,5984,5996,5998,6e3,6016,6067,6103,6103,6108,6108,6176,6263,6272,6312,6314,6314,6320,6389,6400,6428,6480,6509,6512,6516,6528,6571,6593,6599,6656,6678,6688,6740,6823,6823,6917,6963,6981,6987,7043,7072,7086,7087,7104,7141,7168,7203,7245,7247,7258,7293,7401,7404,7406,7409,7424,7615,7680,7957,7960,7965,7968,8005,8008,8013,8016,8023,8025,8025,8027,8027,8029,8029,8031,8061,8064,8116,8118,8124,8126,8126,8130,8132,8134,8140,8144,8147,8150,8155,8160,8172,8178,8180,8182,8188,8305,8305,8319,8319,8336,8348,8450,8450,8455,8455,8458,8467,8469,8469,8473,8477,8484,8484,8486,8486,8488,8488,8490,8493,8495,8505,8508,8511,8517,8521,8526,8526,8544,8584,11264,11310,11312,11358,11360,11492,11499,11502,11520,11557,11568,11621,11631,11631,11648,11670,11680,11686,11688,11694,11696,11702,11704,11710,11712,11718,11720,11726,11728,11734,11736,11742,11823,11823,12293,12295,12321,12329,12337,12341,12344,12348,12353,12438,12445,12447,12449,12538,12540,12543,12549,12589,12593,12686,12704,12730,12784,12799,13312,13312,19893,19893,19968,19968,40907,40907,40960,42124,42192,42237,42240,42508,42512,42527,42538,42539,42560,42606,42623,42647,42656,42735,42775,42783,42786,42888,42891,42894,42896,42897,42912,42921,43002,43009,43011,43013,43015,43018,43020,43042,43072,43123,43138,43187,43250,43255,43259,43259,43274,43301,43312,43334,43360,43388,43396,43442,43471,43471,43520,43560,43584,43586,43588,43595,43616,43638,43642,43642,43648,43695,43697,43697,43701,43702,43705,43709,43712,43712,43714,43714,43739,43741,43777,43782,43785,43790,43793,43798,43808,43814,43816,43822,43968,44002,44032,44032,55203,55203,55216,55238,55243,55291,63744,64045,64048,64109,64112,64217,64256,64262,64275,64279,64285,64285,64287,64296,64298,64310,64312,64316,64318,64318,64320,64321,64323,64324,64326,64433,64467,64829,64848,64911,64914,64967,65008,65019,65136,65140,65142,65276,65313,65338,65345,65370,65382,65470,65474,65479,65482,65487,65490,65495,65498,65500,65536,65547,65549,65574,65576,65594,65596,65597,65599,65613,65616,65629,65664,65786,65856,65908,66176,66204,66208,66256,66304,66334,66352,66378,66432,66461,66464,66499,66504,66511,66513,66517,66560,66717,67584,67589,67592,67592,67594,67637,67639,67640,67644,67644,67647,67669,67840,67861,67872,67897,68096,68096,68112,68115,68117,68119,68121,68147,68192,68220,68352,68405,68416,68437,68448,68466,68608,68680,69635,69687,69763,69807,73728,74606,74752,74850,77824,78894,92160,92728,110592,110593,119808,119892,119894,119964,119966,119967,119970,119970,119973,119974,119977,119980,119982,119993,119995,119995,119997,120003,120005,120069,120071,120074,120077,120084,120086,120092,120094,120121,120123,120126,120128,120132,120134,120134,120138,120144,120146,120485,120488,120512,120514,120538,120540,120570,120572,120596,120598,120628,120630,120654,120656,120686,120688,120712,120714,120744,120746,120770,120772,120779,131072,131072,173782,173782,173824,173824,177972,177972,177984,177984,178205,178205,194560,195101],U=[];for(let t=0;t<128;t++)U[t]=t>=48&&t<=57||t===36||t===126||t===124||t>=65&&t<=90||t===95||t===45||t===42||t===58||t===91||t===93||t===63||t===37||t===35||t===61||t===64||t>=97&&t<=122;const ut=U;class ct{constructor(e){this.input=e,this.char=1,this.from=1}peek(e){return this.input.charAt(e||0)}skip(e){e=e||1,this.char+=e,this.input=this.input.slice(e)}tokenize(){const e=[];let a=this.next();for(;a;)e.push(a),a=this.next();return e}next(){if(this.from=this.char,/\s/.test(this.peek())){for(;/\s/.test(this.peek());)this.from+=1,this.skip();if(this.peek()==="")return null}let e=this.scanStringLiteral();return e||(e=this.scanPunctuator()||this.scanNumericLiteral()||this.scanIdentifier()||this.scanTemplateSequence(),e?(this.skip(e.value.length),e):null)}scanTemplateSequence(){return this.peek()==="["&&this.peek(1)==="["?{type:"templateStart",value:"[[",pos:this.char}:this.peek()==="]"&&this.peek(1)==="]"?{type:"templateEnd",value:"[[",pos:this.char}:null}scanIdentifier(){let e="",a=0,r,n;function s(p){for(let g=0;g<H.length;){if(p<H[g++])return!1;if(p<=H[g++])return!0}return!1}function o(p){return/^[0-9a-fA-F]$/.test(p)}const l=(0,m.bind)(function(){if(a+=1,this.peek(a)!=="u")return null;const p=this.peek(a+1),g=this.peek(a+2),x=this.peek(a+3),j=this.peek(a+4);let O;return o(p)&&o(g)&&o(x)&&o(j)?(O=parseInt(p+g+x+j,16),s(O)?(a+=5,"\\u"+p+g+x+j):null):null},this),c=(0,m.bind)(function(){const p=this.peek(a),g=p.charCodeAt(0);return p==="*"?(a+=1,p):g===92?l():g<128?U[g]?(a+=1,p):null:s(g)?(a+=1,p):null},this),d=(0,m.bind)(function(){const p=this.peek(a),g=p.charCodeAt(0);return g===92?l():g<128?ut[g]?(a+=1,p):null:s(g)?(a+=1,p):null},this);if(n=c(),n===null)return null;for(e=n;n=d(),n!==null;)e+=n;switch(e){case"true":{r="bool";break}case"false":{r="bool";break}default:r="identifier"}return{type:r,value:e,pos:this.char}}scanNumericLiteral(){let e=0,a="";const r=this.input.length;let n=this.peek(e),s;function o(p){return/^[0-9]$/.test(p)}function l(p){return/^[0-7]$/.test(p)}function c(p){return/^[0-9a-fA-F]$/.test(p)}function d(p){return p==="$"||p==="_"||p==="\\"||p>="a"&&p<="z"||p>="A"&&p<="Z"}if(n==="-"&&(a+=n,e+=1,n=this.peek(e)),n!=="."&&!o(n))return null;if(n!=="."){if(a+=this.peek(e),e+=1,n=this.peek(e),a==="0"){if(n==="x"||n==="X"){for(e+=1,a+=n;e<r&&(n=this.peek(e),!!c(n));)a+=n,e+=1;return a.length<=2?{type:"number",value:a,isMalformed:!0,pos:this.char}:e<r&&(n=this.peek(e),d(n))?null:{type:"number",value:a,base:16,isMalformed:!1,pos:this.char}}if(l(n)){for(e+=1,a+=n,s=!1;e<r;){if(n=this.peek(e),o(n)&&(s=!0),!l(n)){if(!this.isPunctuator(n))return null;break}a+=n,e+=1}return e<r&&(n=this.peek(e),d(n))?null:{type:"number",value:a,base:8,isMalformed:s}}o(n)&&(e+=1,a+=n)}for(;e<r&&(n=this.peek(e),!!o(n));)a+=n,e+=1}if(n===".")for(a+=n,e+=1;e<r&&(n=this.peek(e),!!o(n));)a+=n,e+=1;if(n==="e"||n==="E")if(a+=n,e+=1,n=this.peek(e),(n==="+"||n==="-")&&(a+=this.peek(e),e+=1),n=this.peek(e),o(n))for(a+=n,e+=1;e<r&&(n=this.peek(e),!!o(n));)a+=n,e+=1;else return null;return e<r&&(n=this.peek(e),!this.isPunctuator(n))?null:{type:"number",value:a,base:10,pos:this.char,isMalformed:!isFinite(+a)}}isPunctuator(e){switch(e){case".":case"(":case")":case",":case"{":case"}":return!0}return!1}scanPunctuator(){const e=this.peek();return this.isPunctuator(e)?{type:e,value:e,pos:this.char}:null}scanStringLiteral(){const e=this.peek();if(e!=='"'&&e!=="'")return null;let a="";for(this.skip();this.peek()!==e;){if(this.peek()==="")return{type:"string",value:a,isUnclosed:!0,quote:e,pos:this.char};const r=this.peek(),n=1;a+=r,this.skip(n)}return this.skip(),{type:"string",value:a,isUnclosed:!1,quote:e,pos:this.char}}}function mt(t){if(t&&t.status===500&&t.data?.message?.startsWith("<body")){const e=(0,m.last)(t.data.message.replace(/(<([^>]+)>)/gi,"").trim().split(/\n/)).replace(/u?&#[^;]+;/g,"");t.data.message=`Graphite encountered an unexpected error while handling your request. ${e}`}return t}function pt(t){return typeof t=="object"&&t!==null&&"message"in t&&"pos"in t}class dt{constructor(e){this.expression=e,this.lexer=new ct(e),this.tokens=this.lexer.tokenize(),this.index=0}getAst(){return this.start()}start(){try{return this.functionCall()||this.metricExpression()}catch(e){if(pt(e))return{type:"error",message:e.message,pos:e.pos}}return null}curlyBraceSegment(){if(this.match("identifier","{")||this.match("{")){let e="";for(;!this.match("")&&!this.match("}");)e+=this.consumeToken().value;return this.match("}")||this.errorMark("Expected closing '}'"),e+=this.consumeToken().value,this.match("identifier")&&(e+=this.consumeToken().value),{type:"segment",value:e}}else return null}metricSegment(){const e=this.curlyBraceSegment();if(e)return e;if(this.match("identifier")||this.match("number")||this.match("bool")){const r=this.consumeToken().value,n=r&&typeof r=="string"?r.split("."):"";return n.length===2&&(this.tokens.splice(this.index,0,{type:"."}),this.tokens.splice(this.index+1,0,{type:"number",value:n[1]})),{type:"segment",value:n[0]}}this.match("templateStart")||this.errorMark("Expected metric identifier"),this.consumeToken(),this.match("identifier")||this.errorMark("Expected identifier after templateStart");const a={type:"template",value:this.consumeToken().value};return this.match("templateEnd")||this.errorMark("Expected templateEnd"),this.consumeToken(),a}metricExpression(){if(!this.match("templateStart")&&!this.match("identifier")&&!this.match("number")&&!this.match("{"))return null;const e={type:"metric",segments:[]},a=this.metricSegment();for(e.segments&&a&&e.segments.push(a);this.match(".");){this.consumeToken();const r=this.metricSegment();r||this.errorMark("Expected metric identifier"),e.segments&&r&&e.segments.push(r)}return e}functionCall(){if(!this.match("identifier","("))return null;let e="";const a=this.consumeToken();typeof a.value=="string"&&(e=a.value);const r={type:"function",name:e};return this.consumeToken(),r.params=this.functionParameters(),this.match(")")||this.errorMark("Expected closing parenthesis"),this.consumeToken(),r}boolExpression(){return this.match("bool")?{type:"bool",value:this.consumeToken().value==="true"}:null}functionParameters(){if(this.match(")")||this.match(""))return[];const e=this.functionCall()||this.numericLiteral()||this.seriesRefExpression()||this.boolExpression()||this.metricExpression()||this.stringLiteral();return!this.match(",")&&e?[e]:(this.consumeToken(),e?[e].concat(this.functionParameters()):[])}seriesRefExpression(){if(!this.match("identifier"))return null;const e=this.tokens[this.index].value;return e&&typeof e=="string"&&!e.match(/\#[A-Z]/)?null:{type:"series-ref",value:this.consumeToken().value}}numericLiteral(){if(!this.match("number"))return null;const e=this.consumeToken();return e&&e.value&&typeof e.value=="string"?{type:"number",value:parseFloat(e.value)}:null}stringLiteral(){if(!this.match("string"))return null;const e=this.consumeToken();if(e.isUnclosed&&e.pos)throw{message:"Unclosed string parameter",pos:e.pos};return{type:"string",value:e.value}}errorMark(e){const a=this.tokens[this.index],r=a?a.type:"end of string";throw{message:e+" instead found "+r,pos:a&&a.pos?a.pos:this.lexer.char}}consumeToken(){return this.index++,this.tokens[this.index-1]}matchToken(e,a){const r=this.tokens[this.index+a];return r===void 0&&e===""||r&&r.type===e}match(e,a){return this.matchToken(e,0)&&(!a||this.matchToken(a,1))}}class me{constructor(e,a,r,n){this.functions=[],this.segments=[],this.tags=[],this.seriesByTagUsed=!1,this.checkOtherSegmentsIndex=0,this.datasource=e,this.target=a,this.templateSrv=r,this.scopedVars=n,this.parseTarget(),this.removeTagValue="-- remove tag --"}parseTarget(){if(this.functions=[],this.segments=[],this.tags=[],this.seriesByTagUsed=!1,this.error=null,this.target.textEditor)return;const a=new dt(this.target.target).getAst();if(a===null){this.checkOtherSegmentsIndex=0;return}if(a.type==="error"){this.error=a.message+" at position: "+a.pos,this.target.textEditor=!0;return}try{if(this.parseTargetRecursive(a,null),this.target.target){const r=this.target.target,n=this.generateQueryString(),s=c=>c.replace(/\s|'|"|,/g,""),o=s(r),l=s(n);if(o&&l&&o!==l)throw new Error(`Failed to make a visual query builder query that is equivalent to the query.
Original query: ${r}
Query builder query: ${n}`)}}catch(r){r instanceof Error&&(console.error("error parsing target:",r.message),this.error=r.message),this.target.textEditor=!0}this.checkOtherSegmentsIndex=this.segments.length-1}getSegmentPathUpTo(e){const a=this.segments.slice(0,e);return(0,m.reduce)(a,(r,n)=>r?r+"."+n.value:n.value,"")}parseTargetRecursive(e,a){if(e===null)return null;switch(e.type){case"function":const r=this.datasource.createFuncInstance(e.name,{withDefaultParams:!1});ht(e),gt(e),(0,m.each)(e.params,n=>{this.parseTargetRecursive(n,r)}),r.updateText(),this.functions.push(r),r.def.name==="seriesByTag"&&!this.seriesByTagUsed&&(this.seriesByTagUsed=!0,r.hidden=!0,this.tags=this.splitSeriesByTagParams(r));break;case"series-ref":this.segments.length>0||this.getSeriesByTagFuncIndex()>=0?this.addFunctionParameter(a,e.value):this.segments.push(e);break;case"bool":case"string":case"number":this.addFunctionParameter(a,e.value);break;case"metric":this.segments.length||this.tags.length?this.addFunctionParameter(a,(0,m.join)((0,m.map)(e.segments,"value"),".")):this.segments=e.segments;break}}updateSegmentValue(e,a){this.segments[a].value=e.value}addSelectMetricSegment(){this.segments.push({value:"select metric"})}addFunction(e){this.functions.push(e)}addFunctionParameter(e,a){if(e.params.length>=e.def.params.length&&!(0,m.get)((0,m.last)(e.def.params),"multiple",!1))throw{message:"too many parameters for function "+e.def.name};e.params.push(a)}removeFunction(e){this.functions=(0,m.without)(this.functions,e)}moveFunction(e,a){const r=this.functions.indexOf(e);(0,lt.b)(this.functions,r,r+a)}generateQueryString(){const e=(r,n)=>n.render(r,s=>this.templateSrv?this.templateSrv.replace(s,this.scopedVars):s),a=this.getSegmentPathUpTo(this.segments.length).replace(/\.?select metric$/,"");return(0,m.reduce)(this.functions,e,a)}updateModelTarget(e){this.target.textEditor||(this.target.target=this.generateQueryString()),this.updateRenderedTarget(this.target,e);for(const a of e||[])a.refId!==this.target.refId&&this.updateRenderedTarget(a,e);this.functions.forEach(a=>a.added=!1)}updateRenderedTarget(e,a){const r=(0,m.keyBy)(a,"refId"),n=/\#([A-Z])/g;let s=e.target;for((0,m.each)(r,(o,l)=>{const c=RegExp(`#(${l})`,"g");let d=0;(0,m.each)(r,(p,g)=>{if(g!==l){const x=p.target.match(c);d+=x?.length??0}}),o.refCount=d});s.match(n);){const o=s.replace(n,(l,c)=>{const d=r[c];return d?(d.refCount===0&&delete r[c],d.refCount--,d.target):l});if(o===s)break;s=o}delete e.targetFull,e.target!==s&&(e.targetFull=s)}splitSeriesByTagParams(e){const a=/([^\!=~]+)(\!?=~?)(.*)/;return(0,m.flatten)((0,m.map)(e.params,r=>{const n=a.exec(r);if(n){const s=n.slice(1);if(s.length===3)return{key:s[0],operator:s[1],value:s[2]}}return[]}))}getSeriesByTagFuncIndex(){return(0,m.findIndex)(this.functions,e=>e.def.name==="seriesByTag")}getSeriesByTagFunc(){const e=this.getSeriesByTagFuncIndex();if(e>=0)return this.functions[e]}addTag(e){const a=pe(e);this.getSeriesByTagFunc().params.push(a),this.tags.push(e)}removeTag(e){this.getSeriesByTagFunc().params.splice(e,1),this.tags.splice(e,1)}updateTag(e,a){if(this.error=null,e.key===this.removeTagValue){if(this.removeTag(a),this.tags.length===0){const r=this.getSeriesByTagFunc();r&&this.removeFunction(r),this.checkOtherSegmentsIndex=0,this.seriesByTagUsed=!1}return}this.getSeriesByTagFunc().params[a]=pe(e),this.tags[a]=e}renderTagExpressions(e=-1){return(0,m.compact)((0,m.map)(this.tags,(a,r)=>{if(r!==e)return a.key+a.operator+a.value}))}}function pe(t){return t.key+t.operator+t.value}function ht(t){if(t.params&&t.params.length>=2){let e=0;t.params=t.params.map(a=>{if(a.type==="function"&&(e+=1),e===2&&a.type==="function"&&a.name==="seriesByTag"){const r=a.params&&a.params.reduce((n,s,o,l)=>o===0||o!==l.length-1?`${n}'${s.value}',`:`${n}'${s.value}'`,"");return{type:"string",value:`${a.name}(${r})`}}return a})}}function gt(t){return t.name==="divideSeriesLists"&&t.params&&t.params.length>=2&&(t.params=t.params.map((e,a)=>(a===1&&e.type==="function"&&(e={type:"string",value:e.name+"("+de(e,"")}),e))),t}function de(t,e){let a=0;if(t.params){a++;const r=t.params?.length??0;return t.params.forEach((n,s)=>{s<r-1?e+=J(n,e)+",":e+=J(n,e)}),e+")"}else return e+=J(t,e)}function J(t,e){switch(t.type){case"function":return e+=t.name+"(",de(t,e);case"metric":return(0,m.join)((0,m.map)(t.segments,"value"),".");default:return t.value}}var he=h(64762),ge=h(12066),fe=h(8535);const ft=["=","!=","=~","!=~"],ye="tag: ";async function q(t){t.queryModel.parseTarget(),await ve(t)}async function ve(t,e=!0){t.segments=(0,m.clone)(t.queryModel.segments);const a=t.queryModel.checkOtherSegmentsIndex||0;await V(t,a,e)}function K(t){t.queryModel.addSelectMetricSegment(),t.segments.push({value:"select metric",fake:!0})}async function V(t,e,a=!0){if(t.queryModel.segments.length===1&&t.queryModel.segments[0].type==="series-ref")return;if(e===0){K(t);return}const r=e+1,n=t.queryModel.getSegmentPathUpTo(r);if(n!=="")try{const s=await t.datasource.metricFindQuery(n);s.length===0?n!==""&&a&&(t.queryModel.segments=t.queryModel.segments.splice(0,r),t.segments=t.segments.splice(0,r),(0,m.some)(t.segments,{fake:!0})||K(t)):s[0].expandable&&(t.segments.length===e?K(t):await V(t,r))}catch(s){s instanceof Error&&Se(t,s)}}function yt(t,e){t.segments=t.segments.splice(0,e),t.queryModel.segments=t.queryModel.segments.splice(0,e)}function xe(t){t.queryModel.segments=[],t.segments=[]}async function vt(t,e){const a=t.datasource.createFuncInstance("seriesByTag",{withDefaultParams:!1}),r=`${e}=`;a.params=[r],t.queryModel.addFunction(a),a.added=!0,xe(t),T(t),await q(t)}function xt(t,e){if(e.def.name==="aliasByNode"){for(let a=0;a<t.segments.length;a++)if(t.segments[a].value.indexOf("*")>=0){e.params[0]=a,e.added=!1,T(t);return}}}function St(t){t.paused=!0}function Tt(t){return t.replace(ye,"")}function T(t){if(t.queryModel.error)return;let e=t.queryModel.target.target;t.queryModel.updateModelTarget((t.queries||[]).filter(r=>"target"in r&&typeof r.target=="string"));const a=t.queryModel.target.target.replace(/\s+/g,"");e=e.replace(/\s+/g,""),a!==e&&!t.paused&&t.refresh()}function Se(t,e){return t.metricAutoCompleteErrorShown||(t.metricAutoCompleteErrorShown=!0,(0,fe.JD)((0,ge.dx)((0,he.gi)(`Fetching metrics failed: ${e.message}.`)))),t}function Te(t,e){return t.tagsAutoCompleteErrorShown||(t.tagsAutoCompleteErrorShown=!0,(0,fe.JD)((0,ge.dx)((0,he.gi)(`Fetching tags failed: ${e.message}.`)))),t}const bt=async(t,e)=>{if(e={...e},y.init.match(t)){const a=t.payload;a.target.target=a.target.target||"",await a.datasource.waitForFuncDefsLoaded(),e={...e,...a,queryModel:new me(a.datasource,a.target,e.templateSrv),supportsTags:a.datasource.supportsTags,paused:!1,removeTagValue:"-- remove tag --",funcDefs:a.datasource.funcDefs,queries:a.queries},await ve(e,!1)}if(y.timeRangeChanged.match(t)&&(e.range=t.payload),y.queriesChanged.match(t)&&(e.queries=t.payload,T(e)),y.queryChanged.match(t)&&(e.target.target=t.payload.target||"",await q(e),T(e)),y.segmentValueChanged.match(t)){const{segment:a,index:r}=t.payload;let n;if(typeof a=="string"?n={value:a,expandable:!0,fake:!1}:n=a,e.error=null,e.segments[r]=n,e.queryModel.updateSegmentValue(n,r),e.queryModel.functions.length>0&&e.queryModel.functions[0].def.fake&&(e.queryModel.functions=[]),n.type==="tag"){const s=Tt(n.value);return St(e),await vt(e,s),e}n.expandable?await V(e,r+1):yt(e,r+1),T(e)}if(y.tagChanged.match(t)){const{tag:a,index:r}=t.payload;e.queryModel.updateTag(a,r),T(e),e.queryModel.tags.length===0&&(await V(e,0),e.paused=!1)}if(y.addNewTag.match(t)){const n={key:t.payload.segment.value,operator:"=",value:""};e.queryModel.addTag(n),T(e)}if(y.unpause.match(t)&&(e.paused=!1,e.refresh()),y.addFunction.match(t)){const a=e.datasource.createFuncInstance(t.payload.name,{withDefaultParams:!0});a.added=!0,e.queryModel.addFunction(a),xt(e,a),e.segments.length===1&&e.segments[0].fake&&xe(e),!a.params.length&&a.added&&T(e),a.def.name==="seriesByTag"&&await q(e)}if(y.removeFunction.match(t)&&(e.queryModel.removeFunction(t.payload.func),T(e)),y.moveFunction.match(t)){const{func:a,offset:r}=t.payload;e.queryModel.moveFunction(a,r),T(e)}if(y.updateFunctionParam.match(t)){const{func:a,index:r,value:n}=t.payload;a.updateParam(n,r),T(e)}return y.updateQuery.match(t)&&(e.target.target=t.payload.query,T(e)),y.runQuery.match(t)&&e.refresh(),y.toggleEditorMode.match(t)&&(e.target.textEditor=!e.target.textEditor,await q(e)),{...e}},jt=t=>{let e={};return async r=>{e=await bt(r,e),t(e)}},be=(0,f.createContext)({}),je=(0,f.createContext)({}),k=()=>(0,f.useContext)(be),Ct=()=>(0,f.useContext)(je),Pt=({datasource:t,onRunQuery:e,onChange:a,query:r,queries:n,range:s,children:o})=>{const[l,c]=(0,f.useState)(),[d,p]=(0,f.useState)(!1),g=(0,f.useMemo)(()=>jt(j=>{c(j)}),[]),x=(0,ot.A)(s);return(0,f.useEffect)(()=>{JSON.stringify(x?.raw)!==JSON.stringify(s?.raw)&&g(y.timeRangeChanged(s))},[g,s,x]),(0,f.useEffect)(()=>{l&&g(y.queriesChanged(n))},[JSON.stringify(n)]),(0,f.useEffect)(()=>{l&&l.target?.target!==r.target&&g(y.queryChanged(r))},[g,r]),(0,f.useEffect)(()=>{d&&l&&(p(!1),a({...r,target:l.target.target,targetFull:l.target.targetFull}),e())},[d,JSON.stringify(r)]),l?(0,i.jsx)(je.Provider,{value:l,children:(0,i.jsx)(be.Provider,{value:g,children:o})}):(g(y.init({target:{...r},datasource:t,range:s,templateSrv:(0,ce.w)(),queries:n||[],refresh:()=>{p(!0)}})),null)};var Ce=h(52042),X=h(61875),C=(t=>(t.Default="Default",t.Value="Value",t.MetricName="Metric Name",t))(C||{}),B=(t=>(t.Default="default",t.Metrictank="metrictank",t))(B||{});function Y(t){return t.map(e=>({value:e,label:e}))}function Pe(t){return t.map(e=>({label:e.value,value:e}))}function wt(t){const e={};return(0,m.forEach)(t,a=>{a.category&&(e[a.category]||(e[a.category]={label:a.category,value:a.category,options:[]}),e[a.category].options.push({label:a.name,value:a.name}))}),(0,m.sortBy)(e,"label")}function Z(t,e,a){return{name:t.name,value:a?.toString()||"",optional:!!t.optional||e,multiple:!!t.multiple,options:t.options?.map(r=>({value:r.toString(),label:r.toString()}))??[]}}function kt(t){const e=t.def.params.map((a,r)=>Z(a,!1,t.params[r]));for(;e.length<t.params.length;){const a=t.def.params[t.def.params.length-1],r=t.params[e.length];e.push(Z(a,!0,r))}if(e.length&&e[e.length-1].value&&e[e.length-1]?.multiple){const a=t.def.params[t.def.params.length-1];e.push(Z(a,!0,""))}return e}function we(t){return typeof t=="string"?{refId:"A",target:t,queryType:C.Default.toString()}:t}function Mt({funcDefs:t}){const e=k(),[a,r]=(0,f.useState)(void 0),n=(0,M.of)(Ft),s=(0,f.useMemo)(()=>wt(t),[t]);return(0,f.useEffect)(()=>{a?.value!==void 0&&(e(y.addFunction({name:a.value})),r(void 0))},[a,e]),(0,i.jsx)("div",{children:(0,i.jsx)(X.Y,{Component:(0,i.jsx)(F.$n,{icon:"plus",variant:"secondary",className:(0,v.cx)(n.button),"aria-label":"Add new function"}),options:s,onChange:r,inputMinWidth:150})})}function Ft(t){return{button:(0,v.css)({marginRight:t.spacing(.5)})}}var Et=h(41654),ke=h(79233),_=h(45967),E=h(30703);const It=(0,f.lazy)(async()=>({default(t){return(0,i.jsx)("div",{children:t.description})}})),At=t=>{if(t.description){let e=(0,i.jsx)(f.Suspense,{fallback:(0,i.jsx)("span",{children:"Loading description..."}),children:(0,i.jsx)(It,{description:t.description})});return(0,i.jsx)(_.m,{content:e,placement:"bottom-end",children:(0,i.jsx)(E.I,{className:t.description?void 0:"pointer",name:"question-circle"})})}return(0,i.jsx)(E.I,{className:"pointer",name:"question-circle",onClick:()=>{window.open("http://graphite.readthedocs.org/en/latest/functions.html#graphite.render.functions."+t.name,"_blank")}})},Rt=t=>{const{func:e,onMoveLeft:a,onMoveRight:r,onRemove:n}=t;return(0,i.jsxs)("div",{style:{display:"flex",width:"60px",justifyContent:"space-between"},children:[(0,i.jsx)(E.I,{name:"arrow-left",onClick:()=>a(e)}),(0,i.jsx)(At,{name:e.def.name,description:e.def.description}),(0,i.jsx)(E.I,{name:"times",onClick:()=>n(e)}),(0,i.jsx)(E.I,{name:"arrow-right",onClick:()=>r(e)})]})},Nt=t=>({icon:(0,v.css)({marginRight:t.spacing(.5)}),label:(0,v.css)({fontWeight:t.typography.fontWeightMedium,fontSize:t.typography.bodySmall.fontSize,cursor:"pointer",display:"inline-block"})}),Dt=({onMoveLeft:t,onMoveRight:e,func:a,...r})=>{const n=(0,M.of)(Nt),s=({updatePopperPosition:o})=>(0,i.jsx)(Rt,{...r,func:a,onMoveLeft:()=>{t(a),o?.()},onMoveRight:()=>{e(a),o?.()}});return(0,i.jsxs)(i.Fragment,{children:[a.def.unknown&&(0,i.jsx)(_.m,{content:(0,i.jsx)(Me,{}),placement:"bottom",interactive:!0,children:(0,i.jsx)(E.I,{"data-testid":"warning-icon",name:"exclamation-triangle",size:"xs",className:n.icon})}),(0,i.jsx)(_.m,{content:s,placement:"top",interactive:!0,children:(0,i.jsx)("span",{className:n.label,children:a.def.name})})]})},Me=(0,f.memo)(()=>(0,i.jsxs)("span",{children:["This function is not supported. Check your function for typos and"," ",(0,i.jsx)("a",{target:"_blank",className:"external-link",rel:"noreferrer noopener",href:"https://graphite.readthedocs.io/en/latest/functions.html",children:"read the docs"})," ","to see whether you need to upgrade your data source\u2019s version to make this function available."]}));Me.displayName="FunctionEditorTooltipContent";var Ot=h(3263);function qt({editableParam:t,onChange:e,onExpandedChange:a,autofocus:r}){const n=(0,M.of)(Vt);return t.options?.length>0?(0,i.jsx)(X.Y,{autofocus:r,value:t.value,inputPlaceholder:t.name,className:n.segment,options:t.options,placeholder:" +"+t.name,onChange:s=>{e(s.value||"")},onExpandedChange:a,inputMinWidth:150,allowCustomValue:!0,allowEmptyValue:!0}):(0,i.jsx)(Ot.o,{autofocus:r,className:n.input,value:t.value||"",placeholder:" +"+t.name,inputPlaceholder:t.name,onChange:s=>{e(s.toString())},onExpandedChange:a,style:{height:"25px",paddingTop:"2px",marginTop:"2px",paddingLeft:"4px",minWidth:"100px"}})}const Vt=t=>({segment:(0,v.css)({margin:0,padding:0}),input:(0,v.css)({margin:0,padding:0,input:{height:"25px"}})});function Bt({func:t}){const e=k(),a=(0,M.of)(Gt),[r,n]=(0,f.useState)(!1),[s,o]=(0,f.useState)(!1);let l=kt(t);return l=l.filter((c,d)=>d<t.def.params.length&&!c.optional||t.added||c.value||s||r),(0,i.jsx)("div",{className:(0,v.cx)(a.container,{[a.error]:t.def.unknown}),onBlur:()=>n(!1),onFocus:()=>n(!0),onMouseOver:()=>n(!0),onMouseOut:()=>n(!1),children:(0,i.jsxs)(Et.B,{gap:0,alignItems:"baseline",children:[(0,i.jsx)(Dt,{func:t,onMoveLeft:()=>{e(y.moveFunction({func:t,offset:-1}))},onMoveRight:()=>{e(y.moveFunction({func:t,offset:1}))},onRemove:()=>{e(y.removeFunction({func:t}))}}),(0,i.jsx)(ke.c,{className:a.label,width:"auto",children:"("}),l.map((c,d)=>(0,i.jsxs)(f.Fragment,{children:[(0,i.jsx)(qt,{autofocus:d===0&&t.added,editableParam:c,onChange:p=>{(p!==""||c.optional)&&e(y.updateFunctionParam({func:t,index:d,value:p})),o(!1),n(!1)},onExpandedChange:o}),d!==l.length-1?",":""]},d)),(0,i.jsx)(ke.c,{className:a.label,width:"auto",children:")"})]})})}const Gt=t=>({container:(0,v.css)({backgroundColor:t.colors.background.secondary,borderRadius:t.shape.radius.default,marginRight:t.spacing(.5),padding:`0 ${t.spacing(1)}`,height:`${t.v1.spacing.formInputHeight}px`}),error:(0,v.css)({border:`1px solid ${t.colors.error.main}`}),label:(0,v.css)({padding:0,margin:0}),button:(0,v.css)({padding:t.spacing(.5)})});function $t({functions:t=[],funcDefs:e}){return(0,i.jsxs)(Ce.L,{label:"Functions",fill:!0,children:[t.map((a,r)=>!a.hidden&&(0,i.jsx)(Bt,{func:a},r)),(0,i.jsx)(Mt,{funcDefs:e})]})}var Qt=h(92505);function Lt({rawQuery:t}){const e=k(),a=(0,f.useCallback)(n=>{e(y.updateQuery({query:n}))},[e]),r=(0,f.useCallback)(()=>{e(y.runQuery())},[e]);return(0,i.jsx)(Qt.X,{query:t,onChange:a,onBlur:r,onRunQuery:r,placeholder:"Enter a Graphite query (run with Shift+Enter)",portalOrigin:"graphite"})}var G=h(76671);const $=5e3;async function zt(t,e,a){let r=a.length>0?"*"+a+"*":"*";e>0&&(r=t.queryModel.getSegmentPathUpTo(e)+"."+r);const n={range:t.range,requestId:"get-alt-segments"};try{const s=await t.datasource.metricFindQuery(r,n),o=(0,m.map)(s,l=>({value:l.text,expandable:l.expandable}));return e>0&&o.length===0?o:(e===0&&(0,m.eachRight)(t.queries,l=>{l.refId!==t.queryModel.target.refId&&o.unshift({type:"series-ref",value:"#"+l.refId,expandable:!1})}),(0,m.eachRight)(t.templateSrv.getVariables(),l=>{o.unshift({type:"template",value:"$"+l.name,expandable:!0})}),o.unshift({value:"*",expandable:!0}),o.splice($),t.supportsTags&&e===0?(_t(o),await Zt(t,a,o)):o)}catch(s){s instanceof Error&&Se(t,s)}return[]}async function Wt(t,e,a){return Pe(await zt(t,e,a))}function Ht(){return Y(ft)}async function Ut(t,e,a){try{const r=t.queryModel.renderTagExpressions(e),n=await t.datasource.getTagsAutoComplete(r,a,{range:t.range,limit:$}),s=(0,m.map)(n,"text");return s.splice(0,0,t.removeTagValue),s}catch(r){r instanceof Error&&Te(t,r)}return[]}async function Jt(t,e,a){return Y(await Ut(t,e,a))}async function Fe(t,e){let a;try{const r=t.queryModel.renderTagExpressions(),n=await t.datasource.getTagsAutoComplete(r,e,{range:t.range,limit:$});a=(0,m.map)(n,s=>({value:s.text,type:"tag",expandable:!1}))}catch(r){a=[],r instanceof Error&&Te(t,r)}return a}async function Kt(t,e){return Pe(await Fe(t,e))}async function Xt(t,e,a,r){const n=t.queryModel.renderTagExpressions(a),s=e.key,o=await t.datasource.getTagValuesAutoComplete(n,s,r,{range:t.range,limit:$}),l=(0,m.map)(o,"text");return(0,m.eachRight)(t.templateSrv.getVariables(),c=>{l.push("${"+c.name+":regex}")}),l}async function Yt(t,e,a,r){return Y(await Xt(t,e,a,r))}async function Zt(t,e,a){let r=await Fe(t,e);return r=(0,m.map)(r,n=>(n.value=ye+n.value,n)),a.concat(...r)}function _t(t){(0,m.remove)(t,e=>e.value==="_tagged")}function ea({metricIndex:t,segment:e,state:a}){const r=k(),n=(0,f.useCallback)(c=>Wt(a,t,c||""),[a,t]),s=(0,f.useMemo)(()=>(0,m.debounce)(n,200,{leading:!0}),[n]),o=(0,f.useCallback)(c=>{r(y.segmentValueChanged({segment:c.value,index:t}))},[r,t]),l=(0,f.useMemo)(()=>(0,m.debounce)(o,100),[o]);return(0,i.jsx)(G.s,{value:e.value,inputMinWidth:150,allowCustomValue:!0,loadOptions:s,reloadOptionsOnChange:!0,onChange:l})}function ta({segments:t=[],state:e}){return(0,i.jsx)("div",{children:t.map((a,r)=>(0,i.jsx)(ea,{segment:a,metricIndex:r,state:e},r))})}function aa(){const t=k(),e=(0,f.useCallback)(()=>{t(y.unpause())},[t]);return(0,i.jsx)(F.$n,{icon:"play",onClick:e,type:"button",variant:"secondary","aria-label":"Unpause query"})}function ra({tag:t,tagIndex:e,state:a}){const r=k(),n=(0,f.useCallback)(c=>Jt(a,e,c||""),[a,e]),s=(0,f.useMemo)(()=>(0,m.debounce)(n,200,{leading:!0}),[n]),o=(0,f.useCallback)(c=>Yt(a,t,e,c||""),[a,e,t]),l=(0,f.useMemo)(()=>(0,m.debounce)(o,200,{leading:!0}),[o]);return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(G.s,{inputMinWidth:150,value:t.key,loadOptions:s,reloadOptionsOnChange:!0,onChange:c=>{r(y.tagChanged({tag:{...t,key:c.value},index:e}))},allowCustomValue:!0}),(0,i.jsx)(X.Y,{inputMinWidth:50,value:t.operator,options:Ht(),onChange:c=>{r(y.tagChanged({tag:{...t,operator:c.value},index:e}))}}),(0,i.jsx)(G.s,{inputMinWidth:150,value:t.value,loadOptions:l,reloadOptionsOnChange:!0,onChange:c=>{r(y.tagChanged({tag:{...t,value:c.value},index:e}))},allowCustomValue:!0})]})}function na({tags:t,state:e}){const a=k(),r=(0,M.of)(sa),n=(0,f.useCallback)(o=>Kt(e,o||""),[e]),s=(0,f.useMemo)(()=>(0,m.debounce)(n,200,{leading:!0}),[n]);return(0,i.jsxs)("div",{children:[t.map((o,l)=>(0,i.jsx)(ra,{tagIndex:l,tag:o,state:e},l)),t.length&&(0,i.jsx)(G.s,{inputMinWidth:150,onChange:o=>{a(y.addNewTag({segment:o.value}))},loadOptions:s,reloadOptionsOnChange:!0,Component:(0,i.jsx)(F.$n,{icon:"plus",variant:"secondary",className:r.button,"aria-label":"Add new tag"})}),e.paused&&(0,i.jsx)(aa,{})]})}function sa(t){return{button:(0,v.css)({marginRight:t.spacing(.5)})}}function ia({state:t}){const e=t.queryModel?.seriesByTagUsed?(0,i.jsx)(na,{tags:t.queryModel?.tags,state:t}):(0,i.jsx)(ta,{segments:t.segments,state:t});return(0,i.jsx)(Ce.L,{label:"Series",fill:!0,children:e})}function oa({datasource:t,onRunQuery:e,onChange:a,query:r,range:n,queries:s}){return(0,i.jsx)(Pt,{datasource:t,onRunQuery:e,onChange:a,query:r,queries:s,range:n,children:(0,i.jsx)(la,{})})}function la(){const t=k(),e=Ct(),a=(0,M.of)(ua);return(0,i.jsxs)("div",{className:a.container,children:[(0,i.jsxs)("div",{className:a.visualEditor,children:[e.target?.textEditor&&(0,i.jsx)(Lt,{rawQuery:e.target.target}),!e.target?.textEditor&&(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(ia,{state:e}),(0,i.jsx)($t,{functions:e.queryModel?.functions,funcDefs:e.funcDefs})]})]}),(0,i.jsx)(F.$n,{className:a.toggleButton,icon:"pen",variant:"secondary","aria-label":"Toggle editor mode",tooltip:e?.queryModel?.error,onClick:()=>{t(y.toggleEditorMode())}})]})}function ua(t){return{container:(0,v.css)({display:"flex"}),visualEditor:(0,v.css)({flexGrow:1}),toggleButton:(0,v.css)({marginLeft:t.spacing(.5)})}}var R=h(18027),ee=h(18857),te=h(63527);const ca=[{label:"Default Query",value:C.Default},{label:"Value Query",value:C.Value},{label:"Metric Name Query",value:C.MetricName}],ma=t=>{const{query:e,onChange:a}=t,[r,n]=(0,f.useState)(we(e));return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(R.I,{label:"Select query type",labelWidth:20,children:(0,i.jsx)(ee.l6,{"aria-label":"select query type",options:ca,width:25,value:r.queryType??C.Default,onChange:s=>{n({...r,queryType:s.value}),r.target&&a({...r,queryType:s.value},r.target??"")}})}),(0,i.jsx)(R.I,{label:"Query",labelWidth:20,grow:!0,children:(0,i.jsx)(te.p,{"aria-label":"Variable editor query input",value:r.target,onBlur:()=>a(r,r.target??""),onChange:s=>{n({...r,target:s.currentTarget.value})}})})]})};var Ee=h(17548),pa=h(65240),Ie=h(65642);function da(t){if(t)return parseInt(t,10)}function ha(t){if(t)return t==="true"?!0:t==="false"?!1:parseInt(t,10)}function Ae(t){for(const e of t){const a=e["archive-read"];if(a>0){const n=Ne(e["schema-retentions"])[a].interval,s=(e["consolidator-normfetch"]??"").replace("Consolidator","");return{text:`Data is rolled up, aggregated over ${n} using ${s} function`,severity:"info",inspect:"meta"}}}return null}function Re(t){for(const e of t){const a=e["aggnum-rc"];if(a>0){const r=(e["consolidator-rc"]??"").replace("Consolidator","");return{text:`Data is runtime consolidated, ${a} datapoints combined using ${r} function`,severity:"info",inspect:"meta"}}}return null}function Ne(t){return t?t.split(",").map(e=>{const a=e.split(":");return{interval:a[0],retention:a[1],chunkspan:a[2],numchunks:da(a[3]),ready:ha(a[4])}}):[]}class ga extends f.PureComponent{renderMeta(e,a){const r=fa(),n=Ne(e["schema-retentions"]),s=Ae([e]),o=Re([e]),l=(e["consolidator-normfetch"]??"").replace("Consolidator",""),c=n.reduce((d,p)=>d+(p.retention?Ee.intervalToSeconds(p.retention):0),0);return(0,i.jsxs)("div",{className:r.metaItem,children:[(0,i.jsxs)("div",{className:r.metaItemHeader,children:["Schema: ",e["schema-name"],(0,i.jsxs)("div",{className:"small muted",children:["Series count: ",e.count]})]}),(0,i.jsxs)("div",{className:r.metaItemBody,children:[(0,i.jsxs)("div",{className:r.step,children:[(0,i.jsx)("div",{className:r.stepHeading,children:"Step 1: Fetch"}),(0,i.jsx)("div",{className:r.stepDescription,children:"First data is fetched, either from raw data archive or a rollup archive"}),s&&(0,i.jsx)("p",{children:s.text}),!s&&(0,i.jsx)("p",{children:"No rollup archive was used"}),(0,i.jsx)("div",{children:n.map((d,p)=>{const x=(d.retention?Ee.intervalToSeconds(d.retention):0)/c*100,j=p===e["archive-read"];return(0,i.jsxs)("div",{className:r.bucket,children:[(0,i.jsx)("div",{className:r.bucketInterval,children:d.interval}),(0,i.jsx)("div",{className:(0,v.cx)(r.bucketRetention,{[r.bucketRetentionActive]:j}),style:{flexGrow:x}}),(0,i.jsx)("div",{style:{flexGrow:100-x},children:d.retention})]},d.retention)})})]}),(0,i.jsxs)("div",{className:r.step,children:[(0,i.jsx)("div",{className:r.stepHeading,children:"Step 2: Normalization"}),(0,i.jsx)("div",{className:r.stepDescription,children:"Normalization happens when series with different intervals between points are combined."}),e["aggnum-norm"]>1&&(0,i.jsxs)("p",{children:["Normalization did occur using ",l]}),e["aggnum-norm"]===1&&(0,i.jsx)("p",{children:"No normalization was needed"})]}),(0,i.jsxs)("div",{className:r.step,children:[(0,i.jsx)("div",{className:r.stepHeading,children:"Step 3: Runtime consolidation"}),(0,i.jsx)("div",{className:r.stepDescription,children:"If there are too many data points at this point Metrictank will consolidate them down to below max data points (set in queries tab)."}),o&&(0,i.jsx)("p",{children:o.text}),!o&&(0,i.jsx)("p",{children:"No runtime consolidation"})]})]})]},a)}render(){const{data:e}=this.props,a={};for(const r of e){const n=r?.meta?.custom?.seriesMetaList;if(n)for(const s of n){const o=`${JSON.stringify(s)}`;a[o]?a[o].count+=s.count:a[o]=s}}return Object.keys(a).length===0?(0,i.jsx)("div",{children:"No response meta data"}):(0,i.jsxs)("div",{children:[(0,i.jsx)("h2",{className:"page-heading",children:"Metrictank Lineage"}),Object.keys(a).map(r=>this.renderMeta(a[r],r))]})}}const fa=(0,pa.N)(()=>{const{theme:t}=Ie.$W,e=t.isDark?t.palette.gray25:t.palette.gray85,a=t.isDark?t.palette.dark1:t.palette.white,r=t.isDark?t.palette.gray15:t.palette.gray85;return{metaItem:(0,v.css)({background:a,border:`1px solid ${e}`,marginBottom:t.spacing.md}),metaItemHeader:(0,v.css)({background:r,padding:`${t.spacing.xs} ${t.spacing.md}`,fontSize:t.typography.size.md,display:"flex",justifyContent:"space-between"}),metaItemBody:(0,v.css)({padding:t.spacing.md}),stepHeading:(0,v.css)({fontSize:t.typography.size.md}),stepDescription:(0,v.css)({fontSize:t.typography.size.sm,color:t.colors.textWeak,marginBottom:t.spacing.sm}),step:(0,v.css)({marginBottom:t.spacing.lg,"&:last-child":{marginBottom:0}}),bucket:(0,v.css)({display:"flex",marginBottom:t.spacing.sm,borderRadius:t.border.radius.sm}),bucketInterval:(0,v.css)({flexGrow:0,width:"60px"}),bucketRetention:(0,v.css)({background:`linear-gradient(0deg, ${t.palette.blue85}, ${t.palette.blue95})`,textAlign:"center",color:t.palette.white,marginRight:t.spacing.md,borderRadius:t.border.radius.sm}),bucketRetentionActive:(0,v.css)({background:`linear-gradient(0deg, ${t.palette.greenBase}, ${t.palette.greenShade})`})}});var Q=h(48480),De=h(34999),ya=h(96004),va=h(16780),ae=h(37386),xa=h(21285),re=h(29043);const Oe=["0.9","1.0","1.1"],qe=(0,m.last)(Oe);var Ve=h(31286),Sa=h(97095);function Ta(t){return(0,i.jsxs)(De.F,{severity:"info",title:"How to map Graphite metrics to labels?",onRemove:t.onDismiss,children:[(0,i.jsx)("p",{children:"Mappings are currently supported only between Graphite and Loki queries."}),(0,i.jsx)("p",{children:"When you switch your data source from Graphite to Loki, your queries are mapped according to the mappings defined in the example below. To define a mapping, write the full path of the metric and replace nodes you want to map to label with the label name in parentheses. The value of the label is extracted from your Graphite query when you switch data sources."}),(0,i.jsx)("p",{children:"All tags are automatically mapped to labels regardless of the mapping configuration. Graphite matching patterns (using {}) are converted to Loki's regular expressions matching patterns. When you use functions in your queries, the metrics, and tags are extracted to match them with defined mappings."}),(0,i.jsxs)("p",{children:["Example: for a mapping = ",(0,i.jsx)("code",{children:"servers.(cluster).(server).*"}),":"]}),(0,i.jsxs)("table",{children:[(0,i.jsx)("thead",{children:(0,i.jsxs)("tr",{children:[(0,i.jsx)("th",{children:"Graphite query"}),(0,i.jsx)("th",{children:"Mapped to Loki query"})]})}),(0,i.jsxs)("tbody",{children:[(0,i.jsxs)("tr",{children:[(0,i.jsx)("td",{children:(0,i.jsxs)("code",{children:["alias(servers.",(0,i.jsx)("u",{children:"west"}),".",(0,i.jsx)("u",{children:"001"}),".cpu,1,2)"]})}),(0,i.jsx)("td",{children:(0,i.jsxs)("code",{children:['{cluster="',(0,i.jsx)("u",{children:"west"}),'", server="',(0,i.jsx)("u",{children:"001"}),'"}']})})]}),(0,i.jsxs)("tr",{children:[(0,i.jsx)("td",{children:(0,i.jsxs)("code",{children:["alias(servers.*.",(0,i.jsx)("u",{children:"{001,002}"}),".*,1,2)"]})}),(0,i.jsx)("td",{children:(0,i.jsxs)("code",{children:['{server=~"',(0,i.jsx)("u",{children:"(001|002)"}),'"}']})})]}),(0,i.jsxs)("tr",{children:[(0,i.jsx)("td",{children:(0,i.jsx)("code",{children:"interpolate(seriesByTag('foo=bar', 'server=002'), inf))"})}),(0,i.jsx)("td",{children:(0,i.jsx)("code",{children:'{foo="bar", server="002"}'})})]})]})]})]})}const ba=t=>{const[e,a]=(0,f.useState)(t.mappings||[]);return(0,i.jsxs)("div",{children:[(0,i.jsx)("h3",{className:"page-heading",children:"Label mappings"}),!t.showHelp&&(0,i.jsx)("p",{children:(0,i.jsx)(F.$n,{fill:"text",onClick:t.onRestoreHelp,children:"Learn how label mappings work"})}),t.showHelp&&(0,i.jsx)(Ta,{onDismiss:t.onDismiss}),(0,i.jsxs)(Ve.a,{marginBottom:5,children:[e.map((r,n)=>(0,i.jsxs)(Sa.C,{children:[(0,i.jsx)(R.I,{label:`Mapping (${n+1})`,children:(0,i.jsx)(te.p,{width:50,onChange:s=>{let o=e.concat();o[n]=s.target.value,a(o)},onBlur:()=>{t.onChange(e)},placeholder:"e.g. test.metric.(labelName).*",value:r})}),(0,i.jsx)(F.$n,{type:"button","aria-label":"Remove header",variant:"secondary",size:"xs",onClick:s=>{let o=e.concat();o.splice(n,1),a(o),t.onChange(o)},children:(0,i.jsx)(E.I,{name:"trash-alt"})})]},n)),(0,i.jsx)(F.$n,{variant:"secondary",icon:"plus",type:"button",onClick:()=>{a([...e,""])},children:"Add label mapping"})]})]})};function ja(t){return{matchers:t.split(".").map(e=>e.startsWith("(")&&e.endsWith(")")?{value:"*",labelName:e.slice(1,-1)}:{value:e})}}function Ca(t){return t.matchers.map(e=>e.labelName?`(${e.labelName})`:`${e.value}`).join(".")}const ne="grafana.datasources.graphite.config.showMappingsHelp",Be=Oe.map(t=>({label:`${t}.x`,value:t})),Ge=Object.entries(B).map(([t,e])=>({label:t,value:e}));class Pa extends f.PureComponent{constructor(e){super(e),this.state={showMappingsHelp:re.A.getObject(ne,!0)}}componentDidMount(){(0,Q.lO)(this.props,"graphiteVersion",this.currentGraphiteVersion)}render(){const{options:e,onOptionsChange:a}=this.props,r=Be.find(n=>n.value===this.currentGraphiteVersion);return(0,i.jsxs)(i.Fragment,{children:[e.access==="direct"&&(0,i.jsx)(De.F,{title:"Deprecation Notice",severity:"warning",children:"This data source uses browser access mode. This mode is deprecated and will be removed in the future. Please use server access mode instead."}),(0,i.jsx)(ya.t,{defaultUrl:"http://localhost:8080",dataSourceConfig:e,onChange:a,secureSocksDSProxyEnabled:Ie.$W.secureSocksDSProxyEnabled}),(0,i.jsxs)(va.n,{children:[(0,i.jsx)("legend",{className:"page-heading",children:"Graphite details"}),(0,i.jsx)(ae.D,{label:"Version",description:"This option controls what functions are available in the Graphite query editor.",children:(0,i.jsx)(ee.l6,{id:"graphite-version","aria-label":"Graphite version",value:r,options:Be,width:16,onChange:(0,Q.BD)(this.props,"graphiteVersion")})}),(0,i.jsx)(ae.D,{label:"Graphite backend type",description:`There are different types of Graphite compatible backends. Here you can specify the type you are using. For Metrictank, this will enable specific features, like query processing meta data. Metrictank
        is a multi-tenant timeseries engine for Graphite and friends.`,children:(0,i.jsx)(ee.l6,{id:"backend-type",options:Ge,value:Ge.find(n=>n.value===e.jsonData.graphiteType),width:16,onChange:(0,Q.BD)(this.props,"graphiteType")})}),e.jsonData.graphiteType===B.Metrictank&&(0,i.jsx)(ae.D,{label:"Rollup indicator",description:"Shows up as an info icon in panel headers when data is aggregated.",children:(0,i.jsx)(xa.d,{id:"rollup-indicator",value:!!e.jsonData.rollupIndicatorEnabled,onChange:(0,Q.EX)(this.props,"rollupIndicatorEnabled")})})]}),(0,i.jsx)(ba,{mappings:(e.jsonData.importConfiguration?.loki?.mappings||[]).map(Ca),showHelp:this.state.showMappingsHelp,onDismiss:()=>{this.setState({showMappingsHelp:!1}),re.A.setObject(ne,!1)},onRestoreHelp:()=>{this.setState({showMappingsHelp:!0}),re.A.setObject(ne,!0)},onChange:n=>{a({...e,jsonData:{...e.jsonData,importConfiguration:{...e.jsonData.importConfiguration,loki:{mappings:n.map(ja)}}}})}})]})}get currentGraphiteVersion(){return this.props.options.jsonData.graphiteVersion||qe}}var wa=h(88483),ka=h(44240),se=h(62467),b=h(75505),Ma=h(13288),Fa=h(81485),P=h(81160),ie=h(66847),I=h(46933),$e=h(41119),Ea=h(33239),Qe=h(94452),L=h(25229),Ia=h(68143);const Aa=/^(\d+)(?:\.(\d+))?(?:\.(\d+))?(?:-([0-9A-Za-z\.]+))?/;class z{constructor(e){this.major=0,this.minor=0,this.patch=0,this.meta="";const a=Aa.exec(e);a&&(this.major=Number(a[1]),this.minor=Number(a[2]||0),this.patch=Number(a[3]||0),this.meta=a[4])}isGtOrEq(e){const a=new z(e);for(let r=0;r<this.comparable.length;++r){if(this.comparable[r]>a.comparable[r])return!0;if(this.comparable[r]<a.comparable[r])return!1}return!0}isValid(){return(0,m.isNumber)(this.major)}get comparable(){return[this.major,this.minor,this.patch]}}function oe(t,e){return new z(t).isGtOrEq(e)}var Ra=h(10928);const Na=t=>{const{query:e,onChange:a}=t,[r,n]=(0,f.useState)(e.target??""),[s,o]=(0,f.useState)(e.tags??[]),l=(p,g)=>{a(p==="tags"?{...e,[p]:g,fromAnnotations:!0,queryType:p}:{...e,[p]:g,fromAnnotations:!0,textEditor:!0})},c=p=>{o(p),l("tags",p)},d=(0,M.of)(Da);return(0,i.jsxs)(Ve.a,{marginBottom:5,children:[(0,i.jsx)(R.I,{label:"Graphite Query",labelWidth:24,grow:!0,children:(0,i.jsx)(te.p,{value:r,onChange:p=>n(p.currentTarget.value||""),onBlur:()=>l("target",r),placeholder:"Example: statsd.application.counters.*.count"})}),(0,i.jsx)("h5",{className:d.heading,children:"Or"}),(0,i.jsx)(R.I,{label:"Graphite events tags",labelWidth:24,children:(0,i.jsx)(Ra.u,{id:"tags-input",width:50,tags:s,onChange:c,placeholder:"Example: event_tag"})})]})},Da=t=>({heading:(0,v.css)({fontSize:t.typography.body.fontSize,marginBottom:t.spacing(1)})}),N={};function u(t){t.params=t.params||[],t.defaultParams=t.defaultParams||[],N[t.name]=t,t.shortName&&(N[t.shortName]=t)}const w=[{name:"other",type:"value_or_series",optional:!0,multiple:!0}];u({name:"scaleToSeconds",category:"Transform",params:[{name:"seconds",type:"int"}],defaultParams:[1]}),u({name:"perSecond",category:"Transform",params:[{name:"max value",type:"int",optional:!0}],defaultParams:[]}),u({name:"holtWintersForecast",category:"Calculate"}),u({name:"holtWintersConfidenceBands",category:"Calculate",params:[{name:"delta",type:"int"}],defaultParams:[3]}),u({name:"holtWintersAberration",category:"Calculate",params:[{name:"delta",type:"int"}],defaultParams:[3]}),u({name:"nPercentile",category:"Calculate",params:[{name:"Nth percentile",type:"int"}],defaultParams:[95]}),u({name:"diffSeries",params:w,defaultParams:["#A"],category:"Combine"}),u({name:"stddevSeries",params:w,defaultParams:[""],category:"Combine"}),u({name:"divideSeries",params:w,defaultParams:["#A"],category:"Combine"}),u({name:"multiplySeries",params:w,defaultParams:["#A"],category:"Combine"}),u({name:"asPercent",params:w,defaultParams:["#A"],category:"Combine"}),u({name:"group",params:w,defaultParams:["#A","#B"],category:"Combine"}),u({name:"sumSeries",shortName:"sum",category:"Combine",params:w,defaultParams:[""]}),u({name:"averageSeries",shortName:"avg",category:"Combine",params:w,defaultParams:[""]}),u({name:"rangeOfSeries",category:"Combine"}),u({name:"percentileOfSeries",category:"Combine",params:[{name:"n",type:"int"},{name:"interpolate",type:"boolean",options:["true","false"]}],defaultParams:[95,"false"]}),u({name:"sumSeriesWithWildcards",category:"Combine",params:[{name:"node",type:"int",multiple:!0}],defaultParams:[3]}),u({name:"maxSeries",shortName:"max",category:"Combine"}),u({name:"minSeries",shortName:"min",category:"Combine"}),u({name:"averageSeriesWithWildcards",category:"Combine",params:[{name:"node",type:"int",multiple:!0}],defaultParams:[3]}),u({name:"alias",category:"Alias",params:[{name:"alias",type:"string"}],defaultParams:["alias"]}),u({name:"aliasSub",category:"Alias",params:[{name:"search",type:"string"},{name:"replace",type:"string"}],defaultParams:["","\\1"]}),u({name:"consolidateBy",category:"Special",params:[{name:"function",type:"string",options:["sum","average","min","max"]}],defaultParams:["max"]}),u({name:"cumulative",category:"Special",params:[],defaultParams:[]}),u({name:"groupByNode",category:"Combine",params:[{name:"node",type:"int",options:[0,1,2,3,4,5,6,7,8,9,10,12]},{name:"function",type:"string",options:["sum","avg","maxSeries"]}],defaultParams:[3,"sum"]}),u({name:"aliasByNode",category:"Alias",params:[{name:"node",type:"int",options:[0,1,2,3,4,5,6,7,8,9,10,12],multiple:!0}],defaultParams:[3]}),u({name:"substr",category:"Special",params:[{name:"start",type:"int",options:[-6,-5,-4,-3,-2,-1,0,1,2,3,4,5,6,7,8,9,10,12]},{name:"stop",type:"int",options:[-6,-5,-4,-3,-2,-1,0,1,2,3,4,5,6,7,8,9,10,12]}],defaultParams:[0,0]}),u({name:"sortByName",category:"Sorting",params:[{name:"natural",type:"boolean",options:["true","false"],optional:!0}],defaultParams:["false"]}),u({name:"sortByMaxima",category:"Sorting"}),u({name:"sortByMinima",category:"Sorting"}),u({name:"sortByTotal",category:"Sorting"}),u({name:"aliasByMetric",category:"Alias"}),u({name:"randomWalk",fake:!0,category:"Special",params:[{name:"name",type:"string"}],defaultParams:["randomWalk"]}),u({name:"countSeries",category:"Combine"}),u({name:"constantLine",category:"Special",params:[{name:"value",type:"int"}],defaultParams:[10]}),u({name:"cactiStyle",category:"Special"}),u({name:"keepLastValue",category:"Transform",params:[{name:"n",type:"int"}],defaultParams:[100]}),u({name:"changed",category:"Special",params:[],defaultParams:[]}),u({name:"scale",category:"Transform",params:[{name:"factor",type:"int"}],defaultParams:[1]}),u({name:"offset",category:"Transform",params:[{name:"amount",type:"int"}],defaultParams:[10]}),u({name:"transformNull",category:"Transform",params:[{name:"amount",type:"int"}],defaultParams:[0]}),u({name:"integral",category:"Transform"}),u({name:"derivative",category:"Transform"}),u({name:"nonNegativeDerivative",category:"Transform",params:[{name:"max value or 0",type:"int",optional:!0}],defaultParams:[""]}),u({name:"timeShift",category:"Transform",params:[{name:"amount",type:"select",options:["1h","6h","12h","1d","2d","7d","14d","30d"]}],defaultParams:["1d"]}),u({name:"timeStack",category:"Transform",params:[{name:"timeShiftUnit",type:"select",options:["1h","6h","12h","1d","2d","7d","14d","30d"]},{name:"timeShiftStart",type:"int"},{name:"timeShiftEnd",type:"int"}],defaultParams:["1d",0,7]}),u({name:"summarize",category:"Transform",params:[{name:"interval",type:"string"},{name:"func",type:"select",options:["sum","avg","min","max","last"]},{name:"alignToFrom",type:"boolean",optional:!0,options:["false","true"]}],defaultParams:["1h","sum","false"]}),u({name:"smartSummarize",category:"Transform",params:[{name:"interval",type:"string"},{name:"func",type:"select",options:["sum","avg","min","max","last"]}],defaultParams:["1h","sum"]}),u({name:"absolute",category:"Transform"}),u({name:"hitcount",category:"Transform",params:[{name:"interval",type:"string"}],defaultParams:["10s"]}),u({name:"log",category:"Transform",params:[{name:"base",type:"int"}],defaultParams:["10"]}),u({name:"averageAbove",category:"Filter Series",params:[{name:"n",type:"int"}],defaultParams:[25]}),u({name:"averageBelow",category:"Filter Series",params:[{name:"n",type:"int"}],defaultParams:[25]}),u({name:"currentAbove",category:"Filter Series",params:[{name:"n",type:"int"}],defaultParams:[25]}),u({name:"currentBelow",category:"Filter Series",params:[{name:"n",type:"int"}],defaultParams:[25]}),u({name:"maximumAbove",category:"Filter Series",params:[{name:"value",type:"int"}],defaultParams:[0]}),u({name:"maximumBelow",category:"Filter Series",params:[{name:"value",type:"int"}],defaultParams:[0]}),u({name:"minimumAbove",category:"Filter Series",params:[{name:"value",type:"int"}],defaultParams:[0]}),u({name:"minimumBelow",category:"Filter Series",params:[{name:"value",type:"int"}],defaultParams:[0]}),u({name:"limit",category:"Filter Series",params:[{name:"n",type:"int"}],defaultParams:[5]}),u({name:"mostDeviant",category:"Filter Series",params:[{name:"n",type:"int"}],defaultParams:[10]}),u({name:"exclude",category:"Filter Series",params:[{name:"exclude",type:"string"}],defaultParams:["exclude"]}),u({name:"highestCurrent",category:"Filter Series",params:[{name:"count",type:"int"}],defaultParams:[5]}),u({name:"highestMax",category:"Filter Series",params:[{name:"count",type:"int"}],defaultParams:[5]}),u({name:"lowestCurrent",category:"Filter Series",params:[{name:"count",type:"int"}],defaultParams:[5]}),u({name:"movingAverage",category:"Calculate",params:[{name:"windowSize",type:"int_or_interval",options:["5","7","10","5min","10min","30min","1hour"]}],defaultParams:[10]}),u({name:"movingMedian",category:"Calculate",params:[{name:"windowSize",type:"int_or_interval",options:["5","7","10","5min","10min","30min","1hour"]}],defaultParams:["5"]}),u({name:"stdev",category:"Calculate",params:[{name:"n",type:"int"},{name:"tolerance",type:"int"}],defaultParams:[5,.1]}),u({name:"highestAverage",category:"Filter Series",params:[{name:"count",type:"int"}],defaultParams:[5]}),u({name:"lowestAverage",category:"Filter Series",params:[{name:"count",type:"int"}],defaultParams:[5]}),u({name:"removeAbovePercentile",category:"Filter Data",params:[{name:"n",type:"int"}],defaultParams:[5]}),u({name:"removeAboveValue",category:"Filter Data",params:[{name:"n",type:"int"}],defaultParams:[5]}),u({name:"removeBelowPercentile",category:"Filter Data",params:[{name:"n",type:"int"}],defaultParams:[5]}),u({name:"removeBelowValue",category:"Filter Data",params:[{name:"n",type:"int"}],defaultParams:[5]}),u({name:"useSeriesAbove",category:"Filter Series",params:[{name:"value",type:"int"},{name:"search",type:"string"},{name:"replace",type:"string"}],defaultParams:[0,"search","replace"]}),u({name:"aggregateLine",category:"Calculate",params:[{name:"func",type:"select",options:["sum","avg","min","max","last"]}],defaultParams:["avg"],version:"1.0"}),u({name:"averageOutsidePercentile",category:"Filter Series",params:[{name:"n",type:"int"}],defaultParams:[95],version:"1.0"}),u({name:"delay",category:"Transform",params:[{name:"steps",type:"int"}],defaultParams:[1],version:"1.0"}),u({name:"exponentialMovingAverage",category:"Calculate",params:[{name:"windowSize",type:"int_or_interval",options:["5","7","10","5min","10min","30min","1hour"]}],defaultParams:[10],version:"1.0"}),u({name:"fallbackSeries",category:"Special",params:[{name:"fallback",type:"string"}],defaultParams:["constantLine(0)"],version:"1.0"}),u({name:"grep",category:"Filter Series",params:[{name:"grep",type:"string"}],defaultParams:["grep"],version:"1.0"}),u({name:"groupByNodes",category:"Combine",params:[{name:"function",type:"string",options:["sum","avg","maxSeries"]},{name:"node",type:"int",options:[0,1,2,3,4,5,6,7,8,9,10,12],multiple:!0}],defaultParams:["sum",3],version:"1.0"}),u({name:"integralByInterval",category:"Transform",params:[{name:"intervalUnit",type:"select",options:["1h","6h","12h","1d","2d","7d","14d","30d"]}],defaultParams:["1d"],version:"1.0"}),u({name:"interpolate",category:"Transform",params:[{name:"limit",type:"int",optional:!0}],defaultParams:[],version:"1.0"}),u({name:"invert",category:"Transform",version:"1.0"}),u({name:"isNonNull",category:"Combine",version:"1.0"}),u({name:"linearRegression",category:"Calculate",params:[{name:"startSourceAt",type:"select",options:["-1h","-6h","-12h","-1d","-2d","-7d","-14d","-30d"],optional:!0},{name:"endSourceAt",type:"select",options:["-1h","-6h","-12h","-1d","-2d","-7d","-14d","-30d"],optional:!0}],defaultParams:[],version:"1.0"}),u({name:"mapSeries",shortName:"map",params:[{name:"node",type:"int"}],defaultParams:[3],category:"Combine",version:"1.0"}),u({name:"movingMin",category:"Calculate",params:[{name:"windowSize",type:"int_or_interval",options:["5","7","10","5min","10min","30min","1hour"]}],defaultParams:[10],version:"1.0"}),u({name:"movingMax",category:"Calculate",params:[{name:"windowSize",type:"int_or_interval",options:["5","7","10","5min","10min","30min","1hour"]}],defaultParams:[10],version:"1.0"}),u({name:"movingSum",category:"Calculate",params:[{name:"windowSize",type:"int_or_interval",options:["5","7","10","5min","10min","30min","1hour"]}],defaultParams:[10],version:"1.0"}),u({name:"multiplySeriesWithWildcards",category:"Combine",params:[{name:"position",type:"int",options:[0,1,2,3,4,5,6,7,8,9,10,12],multiple:!0}],defaultParams:[2],version:"1.0"}),u({name:"offsetToZero",category:"Transform",version:"1.0"}),u({name:"pow",category:"Transform",params:[{name:"factor",type:"int"}],defaultParams:[10],version:"1.0"}),u({name:"powSeries",category:"Transform",params:w,defaultParams:[""],version:"1.0"}),u({name:"reduceSeries",shortName:"reduce",params:[{name:"function",type:"string",options:["asPercent","diffSeries","divideSeries"]},{name:"reduceNode",type:"int",options:[0,1,2,3,4,5,6,7,8,9,10,11,12,13]},{name:"reduceMatchers",type:"string",multiple:!0}],defaultParams:["asPercent",2,"used_bytes"],category:"Combine",version:"1.0"}),u({name:"removeBetweenPercentile",category:"Filter Series",params:[{name:"n",type:"int"}],defaultParams:[95],version:"1.0"}),u({name:"removeEmptySeries",category:"Filter Series",version:"1.0"}),u({name:"squareRoot",category:"Transform",version:"1.0"}),u({name:"timeSlice",category:"Transform",params:[{name:"startSliceAt",type:"select",options:["-1h","-6h","-12h","-1d","-2d","-7d","-14d","-30d"]},{name:"endSliceAt",type:"select",options:["-1h","-6h","-12h","-1d","-2d","-7d","-14d","-30d"],optional:!0}],defaultParams:["-1h"],version:"1.0"}),u({name:"weightedAverage",category:"Combine",params:[{name:"other",type:"value_or_series",optional:!0},{name:"node",type:"int",options:[0,1,2,3,4,5,6,7,8,9,10,12]}],defaultParams:["#A",4],version:"1.0"}),u({name:"seriesByTag",category:"Special",params:[{name:"tagExpression",type:"string",multiple:!0}],version:"1.1"}),u({name:"groupByTags",category:"Combine",params:[{name:"function",type:"string",options:["sum","avg","maxSeries"]},{name:"tag",type:"string",multiple:!0}],defaultParams:["sum","tag"],version:"1.1"}),u({name:"aliasByTags",category:"Alias",params:[{name:"tag",type:"string",multiple:!0}],defaultParams:["tag"],version:"1.1"});function Le(t,e){return!t.version||oe(e,t.version)}class Oa{constructor(e,a){this.text="",this.def=e,this.params=[],a&&a.withDefaultParams&&e.defaultParams&&(this.params=e.defaultParams.slice(0)),this.updateText()}render(e,a){const r=this.def.name+"(",n=(0,m.map)(this.params,(s,o)=>{let l;o<this.def.params.length?l=this.def.params[o].type:(0,m.get)((0,m.last)(this.def.params),"multiple")&&(l=(0,m.get)((0,m.last)(this.def.params),"type"));const c=["value_or_series","boolean","int","float","node","int_or_infinity"],d=["asPercent"];if((0,m.includes)(c,l)||(0,m.includes)(d,this.def.name))return s;const p=(0,m.isString)(s)?a(s):s;return(0,m.includes)(["int_or_interval","node_or_tag"],l)&&(0,m.isFinite)(+p)?(0,m.toString)(s):"'"+s+"'"});for(;n[n.length-1]==="";)n.pop();return e&&n.unshift(e),r+n.join(", ")+")"}_hasMultipleParamsInString(e,a){return e.indexOf(",")===-1?!1:!!(this.def.params[a+1]&&this.def.params[a+1].optional||a+1>=this.def.params.length&&(0,m.get)((0,m.last)(this.def.params),"multiple"))}updateParam(e,a){if(this._hasMultipleParamsInString(e,a)){(0,m.each)(e.split(","),(r,n)=>{this.updateParam(r.trim(),a+n)});return}e===""&&(a>=this.def.params.length||this.def.params[a].optional)?this.params.splice(a,1):this.params[a]=e,this.updateText()}updateText(){if(this.params.length===0){this.text=this.def.name+"()";return}let e=this.def.name+"(";e+=this.params.join(", "),e+=")",this.text=e}}function qa(t,e,a){return(0,m.isString)(t)&&(t=ze(t,a)),new Oa(t,e)}function ze(t,e){return(e||N)[t]?(e||N)[t]:{name:t,params:[{name:"",type:"",multiple:!0}],defaultParams:[""],unknown:!0}}function Va(t,e){const a={};return(0,m.forEach)(e||N,r=>{Le(r,t)&&(a[r.name]=(0,m.assign)({},r,{params:(0,m.filter)(r.params,n=>Le(n,t))}))}),a}function Ba(t){const e={};return(0,m.forEach)(t||{},(a,r)=>{if(a.group==="Graph")return;let n=a.description;n&&(n=n.replace(/:py:func:`(.+)( <[^>]*>)?`/g,"``$1``").replace(/.. seealso:: /g,"See also: ").replace(/.. code-block *:: *none/g,".. code-block::"));const s={name:a.name,description:n,category:a.group,params:[],defaultParams:[],fake:!1};/^seriesLists?$/.test((0,m.get)(a,"params[0].type",""))?a.params[0].multiple?a.params[0].required=!1:a.params.shift():s.fake=!0,(0,m.forEach)(a.params,o=>{const l={name:o.name,type:"string",optional:!o.required,multiple:!!o.multiple,options:void 0};o.default!==void 0?o.default===1/0?s.defaultParams.push("inf"):s.defaultParams.push((0,m.toString)(o.default)):o.suggestions?s.defaultParams.push((0,m.toString)(o.suggestions[0])):s.defaultParams.push(""),o.type==="boolean"?(l.type="boolean",l.options=["true","false"]):o.type==="integer"?l.type="int":o.type==="float"?l.type="float":o.type==="node"?(l.type="node",l.options=["0","1","2","3","4","5","6","7","8","9","10","11","12"]):o.type==="nodeOrTag"?(l.type="node_or_tag",l.options=["name","0","1","2","3","4","5","6","7","8","9","10","11","12"]):o.type==="intOrInterval"?l.type="int_or_interval":o.type==="seriesList"?l.type="value_or_series":o.type==="intOrInf"&&(l.type="int_or_infinity"),o.options?l.options=(0,m.map)(o.options,m.toString):o.suggestions&&(l.options=(0,m.map)(o.suggestions,m.toString)),s.params.push(l)}),e[r]=s}),e}const D={createFuncInstance:qa,getFuncDef:ze,getFuncDefs:Va,parseFuncDefs:Ba},Ga=t=>typeof t.target=="string"&&t.target?{fromAnnotations:!0,target:t.target,textEditor:!0}:{queryType:"tags",tags:(t.tags||"").split(" "),fromAnnotations:!0},$a=t=>{const e=t.target&&typeof t.target!="string"?t.target:Ga(t);return t.target=e,t},Qa={"=":I.D_.Equal,"!=":I.D_.NotEqual,"=~":I.D_.EqualRegEx,"!=~":I.D_.NotEqualRegEx};function La(t){return t.includes("*")||t.includes("{")?"^"+t.replace(/\*/g,".*").replace(/\{/g,"(").replace(/}/g,")").replace(/,/g,"|"):t}class za extends ue.mA{constructor(e,a=(0,ce.w)()){super(e),this.templateSrv=a,this.funcDefs=null,this.funcDefsPromise=null,this.requestCounter=100,this.convertResponseToDataFrames=(r,n)=>{const s=[];if(!r||!r.data)return{data:s};const o=r.data.series||r.data;if(!(0,m.isArray)(o))throw{message:"Missing series in result",data:r};for(let l=0;l<o.length;l++){const c=o[l];let d="";const p=c.target.split(" ");p.length>1&&(d=p.pop()||"",c.target=p.join(" ")),c.title=c.target;for(let x=0;x<c.datapoints.length;x++)c.datapoints[x][1]*=1e3;const g=(0,$e.Vc)(c);if(g.refId=n[d],c.meta){if(g.meta={custom:{requestMetaList:r.data.meta,seriesMetaList:c.meta}},this.rollupIndicatorEnabled){const x=Ae(c.meta),j=Re(c.meta);x?g.meta.notices=[x]:j&&(g.meta.notices=[j])}l===0&&r.data.meta.stats&&(g.meta.stats=this.getRequestStats(r.data.meta))}s.push(g)}return{data:s}},this.basicAuth=e.basicAuth,this.url=e.url,this.name=e.name,this.graphiteVersion=e.jsonData.graphiteVersion||qe,this.metricMappings=e.jsonData.importConfiguration?.loki?.mappings||[],this.isMetricTank=e.jsonData.graphiteType===B.Metrictank,this.supportsTags=Wa(this.graphiteVersion),this.cacheTimeout=e.cacheTimeout,this.rollupIndicatorEnabled=e.jsonData.rollupIndicatorEnabled,this.withCredentials=e.withCredentials,this.funcDefs=null,this.funcDefsPromise=null,this._seriesRefLetters="ABCDEFGHIJKLMNOPQRSTUVWXYZ",this.annotations={QueryEditor:Na,prepareAnnotation:$a}}getQueryOptionsInfo(){return{maxDataPoints:!0,cacheTimeout:!0,links:[{text:"Help",url:"http://docs.grafana.org/features/datasources/graphite/#using-graphite-in-grafana"}]}}getImportQueryConfiguration(){return{loki:{mappings:this.metricMappings}}}async exportToAbstractQueries(e){return e.map(a=>this.exportToAbstractQuery(a))}exportToAbstractQuery(e){const a=new me(this,{...e,target:e.target||"",textEditor:!1},this.templateSrv);a.parseTarget();let r=[];const n=this.getImportQueryConfiguration().loki;if(a.seriesByTagUsed)a.tags.forEach(s=>{r.push({name:s.key,operator:Qa[s.operator],value:s.value})});else{const s=a.segments.map(l=>l.value);let o=n.mappings.filter(l=>l.matchers.length<=s.length);for(let l of o)l.matchers.concat().every((d,p)=>{if(d.labelName){let g=s[p];if(g==="*")return!0;const x=La(g);return r.push({name:d.labelName,operator:x!==g?I.D_.EqualRegEx:I.D_.Equal,value:x}),!0}return s[p]===d.value||d.value==="*"})}return{refId:e.refId,labelMatchers:r}}query(e){if(e.targets.some(l=>l.fromAnnotations)){const l=[];for(const c of e.targets)l.push(new wa.c(d=>{this.annotationEvents(e.range,c).then(p=>d.next({data:[(0,$e.Vc)(p)]})).catch(p=>d.error(new Error(p))).finally(()=>d.complete())}));return(0,ka.h)(...l)}const a={},r={};for(const l of e.targets){const c=l.refId.replaceAll(" ","_");a[c]=l.refId,r[l.refId]=l.target||"";const d=`aliasSub(${l.target}, "(^.*$)", "\\1 ${c}")`;l.target=d}const n={from:this.translateTime(e.range.from,!1,e.timezone),until:this.translateTime(e.range.to,!0,e.timezone),targets:e.targets,format:e.format,cacheTimeout:e.cacheTimeout||this.cacheTimeout,maxDataPoints:e.maxDataPoints},s=this.buildGraphiteParams(n,r,e.scopedVars);if(s.length===0)return(0,se.of)({data:[]});this.isMetricTank&&s.push("meta=true");const o={method:"POST",url:"/render",data:s.join("&"),headers:{"Content-Type":"application/x-www-form-urlencoded"}};return this.addTracingHeaders(o,e),e.panelId&&(o.requestId=this.name+".panelId."+e.panelId),this.doGraphiteRequest(o).pipe((0,P.T)(l=>this.convertResponseToDataFrames(l,a)))}addTracingHeaders(e,a){const r=!this.url.match(/^http/);e.headers||(e.headers={}),r&&(a.dashboardId&&(e.headers["X-Dashboard-Id"]=a.dashboardId),a.panelId&&(e.headers["X-Panel-Id"]=a.panelId),a.panelPluginId&&(e.headers["X-Panel-Plugin-Id"]=a.panelPluginId))}getRequestStats(e){const a=[];for(const r in e.stats){let n;r.endsWith(".ms")&&(n="ms"),a.push({displayName:r,value:e.stats[r],unit:n})}return a}parseTags(e){let a=[];return a=e.split(","),a.length===1&&(a=e.split(" "),a[0]===""&&(a=[])),a}interpolateVariablesInQueries(e,a){let r=e;return e&&e.length>0&&(r=e.map(n=>({...n,datasource:this.getRef(),target:this.templateSrv.replace(n.target??"",a)}))),r}annotationEvents(e,a){if(a.target){const r=this.templateSrv.replace(a.target,{},"glob"),n={range:e,targets:[{target:r}],format:"json",maxDataPoints:100};return(0,b.s)(this.query(n).pipe((0,P.T)(s=>{const o=[];for(let l=0;l<s.data.length;l++){const c=s.data[l];for(let d=0;d<c.length;d++){const p=c.fields[0].values[d];c.fields[1].values[d]&&o.push({annotation:c,time:p,title:c.name})}}return o})))}else{const r=this.templateSrv.replace(a.tags?.join(" "));return this.events({range:e,tags:r}).then(n=>{const s=[];if(!(0,m.isArray)(n.data))return console.error(`Unable to get annotations from ${n.url}.`),[];for(let o=0;o<n.data.length;o++){const l=n.data[o];let c=l.tags;(0,m.isString)(l.tags)&&(c=this.parseTags(l.tags)),s.push({annotation:a,time:l.when*1e3,title:l.what,tags:c,text:l.data})}return s})}}events(e){try{let a="";return e.tags&&(a="&tags="+e.tags),(0,b.s)(this.doGraphiteRequest({method:"GET",url:"/events/get_data?from="+this.translateTime(e.range.raw.from,!1,e.timezone)+"&until="+this.translateTime(e.range.raw.to,!0,e.timezone)+a}))}catch(a){return Promise.reject(a)}}targetContainsTemplate(e){return this.templateSrv.containsTemplate(e.target??"")}translateTime(e,a,r){if((0,m.isString)(e)){if(e==="now")return"now";if(e.indexOf("now-")>=0&&e.indexOf("/")===-1)return e=e.substring(3),e=e.replace("m","min"),e=e.replace("M","mon"),e;e=Ea.parse(e,a,r)}return a?e.get("s")&&e.add(1,"s"):a===!1&&e.get("s")&&e.subtract(1,"s"),e.unix()}metricFindQuery(e,a){const r=a||{},n=we(e);if(n.queryType===C.Value||n.queryType===C.MetricName)return this.requestMetricRender(n,r,n.queryType);let s=n.target??"",o=this.templateSrv.replace(s,(0,Qe.c)({query:s,wildcardChar:"",options:a})),l=o.match(/^tag_values\((.*)\)$/),c=l?l[1].split(/,(?![^{]*\})/).filter(g=>!!g):void 0;if(c)return r.limit=1e4,this.getTagValuesAutoComplete(c.slice(1),c[0],void 0,r);if(l=o.match(/^tags\((.*)\)$/),c=l?l[1].split(",").filter(g=>!!g):void 0,c)return r.limit=1e4,this.getTagsAutoComplete(c,void 0,r);let d=s.match(/^expand\((.*)\)$/);s=d?d[1]:s,o=this.templateSrv.replace(s,(0,Qe.c)({query:s,wildcardChar:"*",options:a}));let p;return r.range&&(p={from:this.translateTime(r.range.from,!1,r.timezone),until:this.translateTime(r.range.to,!0,r.timezone)}),d?this.requestMetricExpand(o,r.requestId,p):this.requestMetricFind(o,r.requestId,p)}async requestMetricRender(e,a,r){const n=a.requestId??`Q${this.requestCounter++}`,s=a.range??{from:(0,L.KQ)().subtract(6,"hour"),to:(0,L.KQ)(),raw:{from:"now - 6h",to:"now"}},o={app:"graphite-variable-editor",interval:"1s",intervalMs:1e4,startTime:Date.now(),targets:[{...e}],timezone:"browser",scopedVars:{},requestId:n,range:s},l=await(0,b.s)(this.query(o));let c;return r===C.Value?c=l.data[0].fields[1].values.filter(d=>!!d).map(d=>({text:d.toString(),value:d,expandable:!1})):r===C.MetricName?c=l.data.map(d=>({text:d.name,value:d.name,expandable:!1})):c=[],Promise.resolve(c)}requestMetricFind(e,a,r){const n={};r&&(n.from=r.from,n.until=r.until);const s={method:"POST",url:"/metrics/find",params:n,data:`query=${e}`,headers:{"Content-Type":"application/x-www-form-urlencoded"},requestId:a};return(0,b.s)(this.doGraphiteRequest(s).pipe((0,P.T)(o=>(0,m.map)(o.data,l=>({text:l.text,expandable:!!l.expandable})))))}requestMetricExpand(e,a,r){const n={query:e};r&&(n.from=r.from,n.until=r.until);const s={method:"GET",url:"/metrics/expand",params:n,headers:{"Content-Type":"application/x-www-form-urlencoded"},requestId:a};return(0,b.s)(this.doGraphiteRequest(s).pipe((0,P.T)(o=>(0,m.map)(o.data.results,l=>({text:l,expandable:!1})))))}getTags(e){const a=e||{},r={};a.range&&(r.from=this.translateTime(a.range.from,!1,a.timezone),r.until=this.translateTime(a.range.to,!0,a.timezone));const n={method:"GET",url:"/tags",requestId:a.requestId,params:r};return(0,b.s)(this.doGraphiteRequest(n).pipe((0,P.T)(s=>(0,m.map)(s.data,o=>({text:o.tag,id:o.id})))))}getTagValues(e={}){const a={};e.range&&(a.from=this.translateTime(e.range.from,!1,e.timezone),a.until=this.translateTime(e.range.to,!0,e.timezone));const r={method:"GET",url:"/tags/"+this.templateSrv.replace(e.key),requestId:e.requestId,params:a};return(0,b.s)(this.doGraphiteRequest(r).pipe((0,P.T)(n=>n.data&&n.data.values?(0,m.map)(n.data.values,s=>({text:s.value,id:s.id})):[])))}getTagsAutoComplete(e,a,r){const n=r||{},s={expr:(0,m.map)(e,l=>this.templateSrv.replace((l||"").trim()))};a&&(s.tagPrefix=a),n.limit&&(s.limit=n.limit),n.range&&(s.from=this.translateTime(n.range.from,!1,n.timezone),s.until=this.translateTime(n.range.to,!0,n.timezone));const o={method:"GET",url:"/tags/autoComplete/tags",params:s,requestId:n.requestId};return(0,b.s)(this.doGraphiteRequest(o).pipe(We()))}getTagValuesAutoComplete(e,a,r,n){const s=n||{},o={expr:(0,m.map)(e,c=>this.templateSrv.replace((c||"").trim())),tag:this.templateSrv.replace((a||"").trim())};r&&(o.valuePrefix=r),s.limit&&(o.limit=s.limit),s.range&&(o.from=this.translateTime(s.range.from,!1,s.timezone),o.until=this.translateTime(s.range.to,!0,s.timezone));const l={method:"GET",url:"/tags/autoComplete/values",params:o,requestId:s.requestId};return(0,b.s)(this.doGraphiteRequest(l).pipe(We()))}getVersion(e){const r={method:"GET",url:"/version",requestId:(e||{}).requestId};return(0,b.s)(this.doGraphiteRequest(r).pipe((0,P.T)(n=>n.data&&new z(n.data).isValid()?n.data:""),(0,ie.W)(()=>(0,se.of)(""))))}createFuncInstance(e,a){return D.createFuncInstance(e,a,this.funcDefs)}getFuncDef(e){return D.getFuncDef(e,this.funcDefs)}waitForFuncDefsLoaded(){return this.getFuncDefs()}getFuncDefs(){if(this.funcDefsPromise!==null)return this.funcDefsPromise;if(!Ha(this.graphiteVersion))return this.funcDefs=D.getFuncDefs(this.graphiteVersion),this.funcDefsPromise=Promise.resolve(this.funcDefs),this.funcDefsPromise;const e={method:"GET",url:"/functions",responseType:"text"};return(0,b.s)(this.doGraphiteRequest(e).pipe((0,P.T)(a=>{const r=JSON.parse(a.data.replace(/"default": ?Infinity/g,'"default": 1e9999'));return this.funcDefs=D.parseFuncDefs(r),this.funcDefs}),(0,ie.W)(a=>(console.error("Fetching graphite functions error",a),this.funcDefs=D.getFuncDefs(this.graphiteVersion),(0,se.of)(this.funcDefs)))))}testDatasource(){const e={app:"graphite",interval:"10ms",intervalMs:10,requestId:"reqId",scopedVars:{},startTime:0,timezone:"browser",panelId:3,rangeRaw:{from:"now-1h",to:"now"},range:{from:(0,L.KQ)("now-1h"),to:(0,L.KQ)("now"),raw:{from:"now-1h",to:"now"}},targets:[{refId:"A",target:"constantLine(100)"}],maxDataPoints:300};return(0,b.s)(this.query(e)).then(()=>({status:"success",message:"Data source is working"}))}doGraphiteRequest(e){return(this.basicAuth||this.withCredentials)&&(e.withCredentials=!0),this.basicAuth&&(e.headers=e.headers||{},e.headers.Authorization=this.basicAuth),e.url=this.url+e.url,e.inspect={type:"graphite"},(0,Ia.AI)().fetch(e).pipe((0,ie.W)(a=>(0,Ma.$)(mt(a))))}buildGraphiteParams(e,a,r){const n=["from","until","rawData","format","maxDataPoints","cacheTimeout"],s=[],o={};let l,c,d;const p=/\#([A-Z])/g,g=/'(\d+)m'/gi;let x=!1;e.format="json";function j(A){return A.replace("m","min").replace("M","mon")}for(d=0;d<e.targets.length;d++)l=e.targets[d],l.target&&(l.refId||(l.refId=this._seriesRefLetters[d]),c=this.templateSrv.replace(l.target,r),c=c.replace(g,j),o[l.refId]=c);function O(A,W){return a[W].replace(p,O)||A}for(d=0;d<e.targets.length;d++)l=e.targets[d],l.target&&(c=o[l.refId],c=this.templateSrv.replace(c.replace(p,O)),o[l.refId]=c,l.hide||(x=!0,s.push("target="+encodeURIComponent(c))));return(0,m.each)(e,(A,W)=>{(0,m.indexOf)(n,W)!==-1&&A&&s.push(W+"="+encodeURIComponent(A))}),x?s:[]}}function Wa(t){return oe(t,"1.1")}function Ha(t){return oe(t,"1.1")}function We(){return(0,Fa.F)((0,P.T)(t=>t.data?(0,m.map)(t.data,e=>({text:e})):[]))}const Ua=new ue.tD(za).setQueryEditor(oa).setConfigEditor(Pa).setVariableQueryEditor(ma).setMetadataInspector(ga)}}]);

//# sourceMappingURL=graphitePlugin.9a4671d0ae6de9cc3f63.js.map