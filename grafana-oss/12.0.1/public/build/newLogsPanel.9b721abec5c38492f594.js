"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[1477,3976,9604],{6567:(Q,w,e)=>{e.r(w),e.d(w,{plugin:()=>W});var i=e(16207),c=e(739),E=e(67770),s=e(74848),J=e(22803),g=e(96540),B=e(28105),D=e(57852),u=e(1906),f=e(75234),ie=e(43173),ce=e(63142),U=e(64400),ue=e(94340),de=e(88642),X=e(37234),fe=e(78368),ge=e(24567);function me(o){return typeof o=="function"}function ve(o){return typeof o=="function"}function pe(o){return o!==null&&typeof o=="object"&&Object.getPrototypeOf(o)===Object.prototype}function he(o){return o===u.Jk.CloudAlerting||o===u.Jk.Correlations||o===u.Jk.Dashboard||o===u.Jk.Explore||o===u.Jk.PanelEditor||o===u.Jk.PanelViewer||o===u.Jk.UnifiedAlerting||o===u.Jk.Unknown}const Ce=({data:o,timeZone:T,fieldConfig:N,options:{dedupStrategy:S,enableInfiniteScrolling:Le,grammar:_,onLogOptionsChange:ee,onNewLogsReceived:G,showControls:te,showTime:xe,sortOrder:V,syntaxHighlighting:Pe,wrapLogMessage:Fe},id:Re})=>{const Ee=(0,ce.of)(ye),[K,t]=(0,g.useState)(null),[l,m]=(0,g.useState)(o),M=(0,ge.O)(o.request?.targets),C=(0,g.useRef)(!1),L=(0,g.useRef)(!1),{app:k,eventBus:A}=(0,U.d2)(),v=(0,g.useMemo)(()=>{const p=l?(0,X.HT)(l.series,l.request?.intervalMs,void 0,l.request?.targets):null;return p?(0,X.M0)(p.rows,S):[]},[S,l]);(0,g.useEffect)(()=>{(0,f.J7)().publish(new E.Df({order:V}))},[V]),(0,g.useEffect)(()=>{o.state!==B.Gu.Loading&&m(o)},[o]);const x=(0,g.useCallback)(async p=>{if(!o.request||!ie.$.featureToggles.logsInfiniteScrolling||L.current)return;L.current=!0;const ne=me(G)?G:void 0;let $=[];try{$=await(0,fe.g)(M,l,p,T,ne)}catch(se){console.error(se)}finally{L.current=!1}C.current=!0,m({...l,series:$})},[o.request,M,G,l,T]),O=(0,g.useCallback)(p=>{p&&A.publish(new D.b_({point:{time:p.timeEpochMs}}))},[A]),P=(0,g.useMemo)(()=>(o.request?.app===u.Jk.Dashboard||o.request?.app===u.Jk.PanelEditor)&&V===c.uH.Ascending?"bottom":"top",[o.request?.app,V]);return v.length?(0,s.jsx)("div",{className:Ee.container,ref:p=>t(p),children:v.length>0&&K&&(0,s.jsx)(ue.Z,{app:he(k)?k:u.Jk.Dashboard,containerElement:K,dedupStrategy:S,displayedFields:[],grammar:pe(_)?_:void 0,initialScrollPosition:P,logs:v,loadMore:Le?x:void 0,onLogOptionsChange:ve(ee)?ee:void 0,onLogLineHover:O,showControls:te,showTime:xe,sortOrder:V,syntaxHighlighting:Pe,timeRange:o.timeRange,timeZone:T,wrapLogMessage:Fe})}):(0,s.jsx)(de.a,{fieldConfig:N,panelId:Re,data:o,needsStringField:!0})},ye=o=>({container:(0,J.css)({marginBottom:o.spacing(1.5),minHeight:"100%",maxHeight:"100%",display:"flex",flex:1,flexDirection:"column"})});var Z=e(38919),q=e(73495);class Se{getSuggestionsForData(T){const N=T.getListAppender({name:"",pluginId:"logs-new",options:{},fieldConfig:{defaults:{custom:{}},overrides:[]}}),{dataSummary:S}=T;!S.hasData||!S.hasTimeField||!S.hasStringField||(S.preferredVisualisationType==="logs"?N.append({name:q.m.Logs,score:Z.nQ.Best}):N.append({name:q.m.Logs}))}}const W=new i.m(Ce).setPanelOptions(o=>{o.addBooleanSwitch({path:"showTime",name:"Time",description:"",defaultValue:!1}).addBooleanSwitch({path:"wrapLogMessage",name:"Wrap lines",description:"",defaultValue:!1}).addBooleanSwitch({path:"syntaxHighlighting",name:"Enable syntax highlighting",description:"Use a predefined syntax coloring grammar to highlight relevant parts of the log lines",defaultValue:!0}).addBooleanSwitch({path:"enableLogDetails",name:"Enable log details",description:"",defaultValue:!0}).addBooleanSwitch({path:"showControls",name:"Show controls",description:"Display controls to jump to the last or first log line, and filters by log level",defaultValue:!1}).addBooleanSwitch({path:"enableInfiniteScrolling",name:"Enable infinite scrolling",description:"Experimental. Request more results by scrolling to the bottom of the logs list.",defaultValue:!1}).addRadio({path:"dedupStrategy",name:"Deduplication",description:"",settings:{options:[{value:c.fY.none,label:"None",description:E._C[c.fY.none]},{value:c.fY.exact,label:"Exact",description:E._C[c.fY.exact]},{value:c.fY.numbers,label:"Numbers",description:E._C[c.fY.numbers]},{value:c.fY.signature,label:"Signature",description:E._C[c.fY.signature]}]},defaultValue:c.fY.none}).addRadio({path:"sortOrder",name:"Order",description:"",settings:{options:[{value:c.uH.Descending,label:"Newest first"},{value:c.uH.Ascending,label:"Oldest first"}]},defaultValue:c.uH.Descending})}).setSuggestionsSupplier(new Se)},78368:(Q,w,e)=>{e.d(w,{q:()=>Pe,g:()=>K});var i=e(74848),c=e(22803),E=e(2543),s=e(96540),J=e(50832),g=e(75505),B=e(739),D=e(67770),u=e(57852),f=e(1906),ie=e(28105),ce=e(5556),U=e(25229),ue=e(17548),de=e(75234),X=e(43173),fe=e(63142),ge=e(64400),me=e(92807),ve=e(78529),pe=e(17896),he=e(27789),Ce=e(88642),ye=e(23235),Z=e(71673),q=e(59896),Se=e(20444),W=e(37234);function o(t){return typeof t=="function"}function T(t){return typeof t=="function"}function N(t){return typeof t=="function"}function S(t){return typeof t=="function"}function Le(t){return typeof t=="function"}function _(t){return typeof t=="function"}function ee(t){return typeof t=="function"}function G(t){return typeof t=="function"}function te(t){return Array.isArray(t)&&t.every(s.isValidElement)}var xe=e(24567);const V={},Pe=({data:t,timeZone:l,fieldConfig:m,options:{showLabels:M,showTime:C,wrapLogMessage:L,showCommonLabels:k,prettifyLogMessage:A,sortOrder:v,dedupStrategy:x,enableLogDetails:O,showLogContextToggle:P,onClickFilterLabel:p,onClickFilterOutLabel:ne,onClickFilterOutString:$,onClickFilterString:se,isFilterLabelActive:Te,logRowMenuIconsBefore:ke,logRowMenuIconsAfter:Ie,enableInfiniteScrolling:we,onNewLogsReceived:Me,...I},id:Be})=>{const F=v===B.uH.Ascending,oe=(0,fe.of)(Fe),Oe=(0,s.useRef)(null),[ae,je]=(0,s.useState)(null),[d,Ue]=(0,s.useState)(null),[b,be]=(0,s.useState)(I.displayedFields??[]),[Ne,Je]=(0,s.useState)(!1),De=(0,s.useRef)(!1),[a,Ve]=(0,s.useState)(t),y=(0,xe.O)(a.request?.targets),j=(0,s.useRef)(null);let z=(0,s.useRef)();const{eventBus:le,onAddAdHocFilter:Y}=(0,ge.d2)();(0,s.useEffect)(()=>{(0,de.J7)().publish(new D.Df({order:v}))},[v]);const Ye=(0,s.useCallback)(n=>{n&&le.publish(new u.b_({point:{time:n.timeEpochMs}}))},[le]),We=(0,s.useCallback)(()=>{le.publish(new u.ql)},[le]),Ge=(0,s.useCallback)(()=>{je(null),z.current&&z.current()},[z]),Ke=(0,s.useCallback)((n,r)=>{je(n),z.current=r},[z]),$e=(0,s.useCallback)(n=>{if(!n.dataFrame.refId||!y||!P&&a.request?.app!==f.Jk.Dashboard&&a.request?.app!==f.Jk.PanelEditor&&a.request?.app!==f.Jk.PanelViewer)return!1;const r=y.get(n.dataFrame.refId);return(0,D.Ol)(r)},[y,P,a.request?.app]),ze=(0,s.useCallback)(()=>!(a.request?.app!==f.Jk.Dashboard&&a.request?.app!==f.Jk.PanelEditor&&a.request?.app!==f.Jk.PanelViewer),[a.request?.app]),Qe=(0,s.useCallback)(async(n,r,h)=>{if(!r.dataFrame.refId||!y)return Promise.resolve({data:[]});const R=a.request?.targets[0];if(!R)return Promise.resolve({data:[]});const re=y.get(r.dataFrame.refId);return(0,D.Ol)(re)?(h.scopedVars=a.request?.scopedVars,re.getLogRowContext(n,h,R)):Promise.resolve({data:[]})},[a.request?.targets,a.request?.scopedVars,y]),Xe=(0,s.useCallback)((n,r)=>{if(!n.dataFrame.refId||!y)return(0,i.jsx)(i.Fragment,{});const h=a.request?.targets[0];if(!h)return(0,i.jsx)(i.Fragment,{});const R=y.get(n.dataFrame.refId);return(0,D.wj)(R)?R.getLogRowContextUi?R.getLogRowContextUi(n,r,h,a.request?.scopedVars):(0,i.jsx)(i.Fragment,{}):(0,i.jsx)(i.Fragment,{})},[a.request?.targets,a.request?.scopedVars,y]),[H,Ze,Ae]=(0,s.useMemo)(()=>{const n=a?(0,W.HT)(a.series,a.request?.intervalMs,void 0,a.request?.targets):null,r=n?.rows||[],h=n?.meta?.find(re=>re.label===W.yR),R=(0,W.M0)(r,x);return[r,R,h]},[x,a]),qe=(0,s.useCallback)(async n=>await Ee(n,H,a.timeRange),[a.timeRange,H]);(0,s.useEffect)(()=>{t.state!==ie.Gu.Loading&&Ve(t)},[t]),(0,s.useLayoutEffect)(()=>{if(!Oe.current||!d||j.current){j.current=j.current==="infinite-scroll"?null:j.current;return}(a.request?.app===f.Jk.Dashboard||a.request?.app===f.Jk.PanelEditor)&&d.scrollTo(0,F?Oe.current.scrollHeight:0)},[a.request?.app,F,d,H]);const _e=(0,s.useCallback)((n,r)=>(0,ve.QL)({field:n,rowIndex:r,range:a.timeRange}),[a]),et=(0,s.useCallback)(n=>{d?.scrollTo({top:n.offsetTop,behavior:"smooth"})},[d]),tt=(0,s.useCallback)((n,r)=>{Y?.({key:n,value:r,operator:"="})},[Y]),nt=(0,s.useCallback)((n,r)=>{Y?.({key:n,value:r,operator:"!="})},[Y]),st=(0,s.useCallback)(n=>{b?.indexOf(n)===-1&&be(b?.concat(n))},[b]),ot=(0,s.useCallback)(n=>{const r=b?.indexOf(n);r!==void 0&&r>-1&&be(b?.filter(h=>n!==h))},[b]);(0,s.useEffect)(()=>{I.displayedFields&&be(I.displayedFields)},[I.displayedFields]),(0,s.useEffect)(()=>{function n(){if(!d)return;j.current="user";const r=d.scrollHeight-d.scrollTop-d.clientHeight===0;(d.scrollTop===0&&!F||r&&F)&&(j.current=null)}return d?.addEventListener("scroll",n),d?.addEventListener("wheel",n),()=>{d?.removeEventListener("scroll",n),d?.removeEventListener("wheel",n)}},[F,d]);const at=(0,s.useCallback)(async n=>{if(!t.request||!X.$.featureToggles.logsInfiniteScrolling||De.current)return;De.current=!0,Je(!0);const r=G(Me)?Me:void 0;let h=[];try{h=await K(y,a,n,l,r)}catch(R){console.error(R)}finally{Je(!1),De.current=!1}j.current="infinite-scroll",Ve({...a,series:h})},[t.request,y,Me,a,l]);if(!t||H.length===0)return(0,i.jsx)(Ce.a,{fieldConfig:m,panelId:Be,data:t,needsStringField:!0});const He=()=>(0,i.jsxs)("div",{className:(0,c.cx)(oe.labelContainer,F&&oe.labelContainerAscending),children:[(0,i.jsx)("span",{className:oe.label,children:"Common labels:"}),(0,i.jsx)(q.h,{labels:typeof Ae?.value=="object"?Ae?.value:V,emptyMessage:"(no common labels)"})]}),lt=Y?tt:void 0,rt=Y?nt:void 0,it=_(I.onClickShowField)?I.onClickShowField:st,ct=ee(I.onClickHideField)?I.onClickHideField:ot;return(0,i.jsxs)(i.Fragment,{children:[ae&&(0,i.jsx)(he.V,{open:ae!==null,row:ae,onClose:Ge,getRowContext:(n,r)=>Qe(n,ae,r),logsSortOrder:v,timeZone:l,getLogRowContextUi:Xe}),(0,i.jsx)(me.P,{ref:n=>Ue(n),children:(0,i.jsxs)("div",{onMouseLeave:We,className:oe.container,ref:Oe,children:[k&&!F&&He(),(0,i.jsx)(pe.u8,{loading:Ne,loadMoreLogs:we?at:void 0,range:t.timeRange,timeZone:l,rows:H,scrollElement:d,sortOrder:v,children:(0,i.jsx)(Se.k,{scrollElement:d,scrollIntoView:et,permalinkedRowId:Re()?.logs?.id??void 0,onPermalinkClick:ze()?qe:void 0,logRows:H,showContextToggle:$e,deduplicatedRows:Ze,dedupStrategy:x,showLabels:M,showTime:C,wrapLogMessage:L,prettifyLogMessage:A,timeZone:l,getFieldLinks:_e,logsSortOrder:v,enableLogDetails:O,previewLimit:F?H.length:void 0,onLogRowHover:Ye,app:f.Jk.Dashboard,onOpenContext:Ke,onClickFilterLabel:o(p)?p:lt,onClickFilterOutLabel:T(ne)?ne:rt,onClickFilterString:N(se)?se:void 0,onClickFilterOutString:S($)?$:void 0,isFilterLabelActive:Le(Te)?Te:void 0,displayedFields:b,onClickShowField:b!==void 0?it:void 0,onClickHideField:b!==void 0?ct:void 0,logRowMenuIconsBefore:te(ke)?ke:void 0,logRowMenuIconsAfter:te(Ie)?Ie:void 0,renderPreview:!F})}),k&&F&&He()]})})]})},Fe=t=>({container:(0,c.css)({marginBottom:t.spacing(1.5)}),labelContainer:(0,c.css)({margin:t.spacing(0,0,.5,.5),display:"flex",alignItems:"center"}),labelContainerAscending:(0,c.css)({margin:t.spacing(.5,0,.5,0)}),label:(0,c.css)({marginRight:t.spacing(.5),fontSize:t.typography.bodySmall.fontSize,fontWeight:t.typography.fontWeightMedium})});function Re(){const l=ce.kM.getUrlSearchParams()?.panelState;if(l&&Array.isArray(l)&&l?.length>0&&typeof l[0]=="string")try{return JSON.parse(l[0])}catch(m){console.error("error parsing logsPanelState",m)}}async function Ee(t,l,m){if(t.rowId===void 0||!t.dataFrame.refId)return;const M={logs:{id:t.uid}},C=new URL(window.location.href);C.searchParams.set("panelState",JSON.stringify(M));const L=(0,Z.sU)(t,l,{from:(0,U.yT)(m.from).valueOf(),to:(0,U.yT)(m.to).valueOf()});return C.searchParams.set("from",L.from.toString()),C.searchParams.set("to",L.to.toString()),await(0,Z.VP)(C.toString()),Promise.resolve()}async function K(t,l,m,M,C){if(!l.request)return[];const L=ue.convertRawToRange({from:(0,U.oZ)(M,m.from),to:(0,U.oZ)(M,m.to)}),k=(0,E.groupBy)(l.request.targets,"datasource.uid"),A=[];for(const O in k){const P=t.get(l.request.targets[0].refId);if(!P){console.warn(`Could not resolve data source for target ${l.request.targets[0].refId}`);continue}A.push(P.query({...l.request,range:L,targets:k[O]}))}const v=await Promise.all(A);let x=l.series;for(const O of v){const P=(0,J.A)(O)?await(0,g.s)(O):O;x=(0,ye.Wn)({data:x},{data:P.data}).data,C&&C(x,P.data)}return x}},24567:(Q,w,e)=>{e.d(w,{O:()=>s});var i=e(96540),c=e(16817),E=e(78282);const s=J=>{const[g,B]=(0,i.useState)(new Map);return(0,c.A)(async()=>{if(!J){B(new Map);return}const D=await Promise.all(J.filter(u=>!!u.datasource?.uid).map(u=>(0,E.l)().get(u.datasource?.uid).then(f=>({key:u.refId,ds:f}))));B(new Map(D.map(({key:u,ds:f})=>[u,f])))},[J]),g}},51814:Q=>{Q.exports={id:"loki"}}}]);

//# sourceMappingURL=newLogsPanel.9b721abec5c38492f594.js.map