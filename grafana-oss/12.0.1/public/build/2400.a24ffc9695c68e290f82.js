"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[2400],{52400:(U,h,t)=>{t.r(h),t.d(h,{plugin:()=>dt});var D=t(94644),s=t(74848),E=t(22803),x=t(92145),T=t(55127),p=t.n(T),f=t(96540),m=t(16817),v=t(739),d=t(62955),r=t(63142),O=t(41654),g=t(37386),V=t(18857),b=t(77824),X=t(21285),Y=t(68079),K=t(65642),Q=t(22429),H=t(39385),R=t(28998),J=t(67042),F=t(18615),$=t(9931);function Z(c){return JSON.stringify(c)}function w(c,a){let e=a;return window.__grafanaSceneContext&&window.__grafanaSceneContext instanceof H.H$&&(e=window.__grafanaSceneContext.state.editPanel?.getPanelId()),c===e}const k=[{label:"All data",value:!1},{label:"Annotations",value:!0,description:"Include annotations as regular data"}],q="Contains a shared dashboard query";function _({data:c,query:a,onChange:e,onRunQuery:i}){const{value:o}=(0,m.A)(()=>(0,R.tR)().get()),C=(0,f.useMemo)(()=>(0,Q.UA)().getCurrent()?.getPanelById(a.panelId??-124134),[a.panelId]),{value:A,loading:u}=(0,m.A)(async()=>{if(!C||!c)return[];const n=await(0,R.tR)().get(C.datasource);return Promise.all(C.targets.map(async l=>{const P=l.datasource?await(0,R.tR)().get(l.datasource):n,j=P.getQueryDisplayText||Z,G=(0,J.E)(c,l.refId)??c;return{refId:l.refId,query:j(l),name:P.name,img:P.meta.info.logos.small,data:G.series,error:G.error}}))},[c,C]),I=(0,f.useCallback)(n=>{e(n),i()},[e,i]),M=(0,f.useCallback)(n=>{I({...a,panelId:n})},[a,I]),it=(0,f.useCallback)(()=>{I({...a,withTransforms:!a.withTransforms})},[a,I]),ut=(0,f.useCallback)(n=>{I({...a,topic:n?v.QR.Annotations:void 0})},[a,I]),ct=n=>n.datasource?.uid===F.uv&&n.targets.some(l=>l.datasource?.uid===$.K),z=(0,f.useCallback)(n=>{const l=n.datasource??o,P=(0,R.tR)().getInstanceSettings(l)?.name,j=n.targets.length;return`${j} ${p()("query",j)} to ${P}`},[o]),B=(0,Q.UA)().getCurrent(),ft=!!(a.withTransforms||C?.transformations?.length),W=(0,f.useMemo)(()=>B?.panels.filter(n=>K.Ay.panels[n.type]&&n.targets&&!w(n.id,B.panelInEdit?.id)).map(n=>{let l=z(n),P=!1;return(n.datasource?.uid===$.K||ct(n))&&(l=q,P=!0),{value:n.id,label:n.title??"Panel "+n.id,imgUrl:K.Ay.panels[n.type].info.logos.small,description:l,isDisabled:P}})??[],[B,z]),vt=(0,r.of)(tt),mt=(0,x.Bi)();if(!B)return null;if(W.length<1)return(0,s.jsx)("p",{className:vt.noQueriesText,children:"This dashboard does not have any other panels. Add queries to other panels and try again."});const gt=W.find(n=>n.value===a.panelId);return(0,s.jsx)(d.i,{children:(0,s.jsxs)(O.B,{direction:"column",children:[(0,s.jsxs)(O.B,{gap:3,children:[(0,s.jsx)(g.D,{label:"Source panel",description:"Use query results from another panel",children:(0,s.jsx)(V.l6,{inputId:mt,placeholder:"Choose panel",isSearchable:!0,options:W,value:gt,onChange:n=>M(n.value)})}),(0,s.jsx)(g.D,{label:"Data",description:"Use data or annotations from the panel",children:(0,s.jsx)(b.z,{options:k,value:a.topic===v.QR.Annotations,onChange:ut})}),ft&&(0,s.jsx)(g.D,{label:"Transform",description:"Apply transformations from the source panel",children:(0,s.jsx)(X.K,{value:!!a.withTransforms,onChange:it})})]}),u?(0,s.jsx)(Y.y,{}):(0,s.jsx)(s.Fragment,{children:A&&!!A.length&&(0,s.jsx)(g.D,{label:"Queries from panel",children:(0,s.jsx)(O.B,{direction:"column",children:A.map((n,l)=>(0,s.jsxs)(O.B,{alignItems:"center",gap:1,children:[(0,s.jsx)("div",{children:n.refId}),(0,s.jsx)("img",{src:n.img,alt:n.name,title:n.name,width:16}),(0,s.jsx)("div",{children:n.query})]},l))})})})]})})}function tt(c){return{noQueriesText:(0,E.css)({padding:c.spacing(1.25)})}}var S=t(62467),nt=t(72316),at=t(81160),st=t(69850),et=t(51575),N=t(96083),ot=t(57532),y=t(28105),rt=t(56838),L=t(8285);class lt extends D.mA{constructor(a){super(a)}getCollapsedText(a){return`Dashboard Reference: ${a.panelId}`}query(a){const e=a.scopedVars?.__sceneObject;let i=e?e.value.valueOf():void 0;if(!i)throw new Error("Can only be called from a scene");const o=a.targets[0];if(!o)return(0,S.of)({data:[]});const C=o.panelId;if(!C)return(0,S.of)({data:[]});let A=this.findSourcePanel(i,C);if(!A)return(0,S.of)({data:[],error:{message:"Could not find source panel"}});let u=A.state.$data;return!o.withTransforms&&u instanceof rt.Es&&(u=u.state.$data),!u||!u.getResultsStream?(0,S.of)({data:[]}):(0,nt.v)(()=>{!u.isActive&&u?.setContainerWidth&&u?.setContainerWidth(500);const I=(0,L.sf)(u);return u.getResultsStream().pipe((0,at.T)(M=>({data:this.getDataFramesForQueryTopic(M.data,o),state:M.data.state,errors:M.data.errors,error:M.data.error,key:"source-ds-provider"})),this.emitFirstLoadedDataIfMixedDS(a.requestId),(0,st.j)(()=>I?.()))})}getDataFramesForQueryTopic(a,e){const i=a.annotations??[];return e.topic===v.QR.Annotations?i.map(o=>({...o,meta:{...o.meta,dataTopic:v.QR.Series}})):[...a.series,...i]}findSourcePanel(a,e){return(0,L.EX)(a,(0,L.XA)(e))}emitFirstLoadedDataIfMixedDS(a){return e=>{if(a.includes(F.bG)){let i=0;return e.pipe((0,et.s)(o=>[y.Gu.Done,y.Gu.Error].includes(o.state)&&i===0?(i++,(0,N.Y)(400)):(i++,(0,N.Y)(0))),(0,ot.$)(o=>o.state===y.Gu.Done||o.state===y.Gu.Error))}return e}}testDatasource(){return Promise.resolve({message:"",status:""})}}const dt=new D.tD(lt).setQueryEditor(_)},72316:(U,h,t)=>{t.d(h,{v:()=>E});var D=t(88483),s=t(15964);function E(x){return new D.c(function(T){(0,s.Tg)(x()).subscribe(T)})}},51575:(U,h,t)=>{t.d(h,{s:()=>T});var D=t(92908),s=t(92357),E=t(64878),x=t(15964);function T(p){return(0,D.N)(function(f,m){var v=!1,d=null,r=null,O=function(){if(r?.unsubscribe(),r=null,v){v=!1;var g=d;d=null,m.next(g)}};f.subscribe((0,E._)(m,function(g){r?.unsubscribe(),v=!0,d=g,r=(0,E._)(m,O,s.l),(0,x.Tg)(p(g)).subscribe(r)},function(){O(),m.complete()},void 0,function(){d=r=null}))})}},62955:(U,h,t)=>{t.d(h,{i:()=>m});var D=t(22803),s=t(96540),E=t(63142),x=t(2543),T=t(46936),p=t(70713),f=t(27633);function m({children:d}){const r=(0,E.of)(v);return s.createElement("div",{className:r.root},s.createElement(T.C,{gap:1},d))}const v=d=>({root:(0,D.css)({padding:d.spacing(1,1,0,1),backgroundColor:d.colors.background.secondary,borderRadius:d.shape.radius.default})})}}]);

//# sourceMappingURL=2400.a24ffc9695c68e290f82.js.map