"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[8622],{74572:(Ae,oe,t)=>{t.d(oe,{B:()=>me});var e=t(74848),x=t(96540),R=t(36490),re=t(34999),W=t(56840),S=t(91984),Y=t(97507),G=t(51740),D=t(52161),j=t(22316),le=t(49785),ce=t(37386),d=t(32635);const Q=({pathPrefix:C,className:T,readOnly:B=!1})=>{const{register:F}=(0,le.xW)();return(0,e.jsx)("div",{className:T,children:(0,e.jsx)(ce.D,{disabled:B,children:(0,e.jsx)(d.S,{...F(`${C}sendResolved`),label:(0,W.t)("alerting.cloud-common-channel-settings.label-send-resolved","Send resolved"),disabled:B,description:(0,W.t)("alerting.cloud-common-channel-settings.description-whether-notify-about-resolved-alerts","Whether or not to notify about resolved alerts.")})})})};var _=t(45517);const X=Object.freeze({__id:"",sendResolved:!0,secureSettings:{},settings:{},secureFields:{},type:"email"}),de=G.r.map(C=>({dto:C})),{useGetAlertmanagerConfigurationQuery:P}=S.m,me=({contactPoint:C,alertManagerSourceName:T,readOnly:B=!1,editMode:F})=>{const{isLoading:ge,data:Z}=P(T),ee=(0,D.AL)(T),[te]=(0,Y.Kt)({alertmanager:T}),[ue]=(0,Y.Pm)({alertmanager:T}),[fe]=(0,x.useMemo)(()=>C?(0,j.Iq)(C,G.r):[void 0,{}],[C]),ne=async se=>{const ae=(0,j.QX)(se,X);try{F&&C?await ue.execute({contactPoint:ae,originalName:C.name}):await te.execute({contactPoint:ae}),R.Ny.push("/alerting/notifications")}catch{}},w=!B&&!ee;return(0,e.jsxs)(e.Fragment,{children:[!ee&&(0,e.jsx)(re.F,{title:(0,W.t)("alerting.cloud-receiver-form.title-info","Info"),severity:"info",children:"Note that empty string values will be replaced with global defaults where appropriate."}),(0,e.jsx)(_.k,{showDefaultRouteWarning:!ge&&!Z?.alertmanager_config.route,isEditable:w,isTestable:w,onSubmit:ne,initialValues:fe,notifiers:de,alertManagerSourceName:T,defaultItem:X,commonSettingsComponent:Q})]})}},75887:(Ae,oe,t)=>{t.d(oe,{a:()=>Se});var e=t(74848),x=t(96540),R=t(36490),re=t(6975),W=t(34999),S=t(56840),Y=t(97507),G=t(66056),D=t(52161),j=t(56476),le=t(96673),ce=t(91984),d=t(11018),Q=t(22316),_=t(1972),X=t(6135),de=t(53226),P=t(49785),me=t(37386),C=t(32635);const T=({pathPrefix:a,className:n,readOnly:i=!1})=>{const{register:o}=(0,P.xW)();return(0,e.jsx)("div",{className:n,children:(0,e.jsx)(me.D,{children:(0,e.jsx)(C.S,{...o(`${a}disableResolveMessage`),label:(0,S.t)("alerting.grafana-common-channel-settings.label-disable-resolved-message","Disable resolved message"),description:"Disable the resolve message [OK] that is sent when alerting state returns to false",disabled:i})})})};var B=t(45517),F=t(22803),ge=t(63142),Z=t(22787),ee=t(72636),te=t(77824),ue=t(45861),fe=t(95443),ne=t(25471),w=t(8402),se=(a=>(a.predefined="Predefined",a.custom="Custom",a))(se||{});const ae=Object.values(se).map(a=>({label:a,value:a})),ye={annotations:[...fe.kl],labels:[{key:"",value:""}]},je=({isOpen:a,onDismiss:n,onTest:i})=>{const[o,N]=(0,x.useState)("Predefined"),v=(0,ge.of)(Ce),h=(0,P.mN)({defaultValues:ye,mode:"onBlur"}),A=m=>{if(o==="Custom"){const V={annotations:m.annotations.filter(({key:g,value:s})=>!!g&&!!s).reduce((g,{key:s,value:b})=>({...g,[s]:b}),{}),labels:m.labels.filter(({key:g,value:s})=>!!g&&!!s).reduce((g,{key:s,value:b})=>({...g,[s]:b}),{})};i(V)}else i()};return(0,e.jsxs)(Z.a,{onDismiss:n,isOpen:a,title:(0,S.t)("alerting.test-contact-point-modal.title-test-contact-point","Test contact point"),children:[(0,e.jsxs)("div",{className:v.section,children:[(0,e.jsx)(ee.J,{children:(0,e.jsx)(S.x6,{i18nKey:"alerting.test-contact-point-modal.notification-message",children:"Notification message"})}),(0,e.jsx)(te.z,{options:ae,value:o,onChange:m=>N(m)})]}),(0,e.jsx)(P.Op,{...h,children:(0,e.jsxs)("form",{onSubmit:h.handleSubmit(A),children:[o==="Predefined"&&(0,e.jsxs)("div",{className:v.section,children:["You will send a test notification that uses a predefined alert. If you have defined a custom template or message, for better results switch to ",(0,e.jsx)("strong",{children:"custom"})," notification message, from above."]}),o==="Custom"&&(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)("div",{className:v.section,children:"You will send a test notification that uses the annotations defined below. This is a good option if you use custom templates and messages."}),(0,e.jsx)("div",{className:v.section,children:(0,e.jsx)(ne.A,{})}),(0,e.jsx)("div",{className:v.section,children:(0,e.jsx)(w.Ay,{})})]}),(0,e.jsx)(Z.a.ButtonRow,{children:(0,e.jsx)(ue.$n,{type:"submit",children:(0,e.jsx)(S.x6,{i18nKey:"alerting.test-contact-point-modal.send-test-notification",children:"Send test notification"})})})]})})]})},Ce=a=>({flexRow:(0,F.css)({display:"flex",flexDirection:"row",alignItems:"flex-start",marginBottom:a.spacing(1)}),section:(0,F.css)({marginBottom:a.spacing(2)})}),ve=Object.freeze({__id:"",secureSettings:{},settings:{},secureFields:{},disableResolveMessage:!1,type:"email"}),{useGrafanaNotifiersQuery:Fe}=ce.m,Se=({contactPoint:a,readOnly:n=!1,editMode:i})=>{const o=(0,le.useDispatch)(),N=(0,j.dM)(D.hY),[v]=(0,Y.Kt)({alertmanager:D.hY}),[h]=(0,Y.Pm)({alertmanager:D.hY}),{onCallNotifierMeta:A,extendOnCallNotifierFeatures:m,extendOnCallReceivers:V,onCallFormValidators:g,isLoadingOnCallIntegration:s,hasOnCallError:b}=(0,de.VY)(),{data:O=[],isLoading:y}=Fe(),[l,E]=(0,x.useState)(),[M,U]=(0,x.useMemo)(()=>!a||y||s?[void 0,{}]:(0,Q.Xo)(V(a),O),[a,y,O,V,s]),k=async p=>{const L=(0,Q.bB)(p,U,ve,O);try{i?N&&a&&a.id?await h.execute({contactPoint:L,id:a.id,resourceVersion:a?.metadata?.resourceVersion}):a&&await h.execute({contactPoint:L,originalName:a.name}):await v.execute({contactPoint:L}),R.Ny.push("/alerting/notifications")}catch{}},he=p=>{E(p)},H=p=>{if(l){const L=U[l.__id],K=(0,Q.qg)(l,ve,"test",L),xe={alertManagerSourceName:D.hY,receivers:[{name:"test",grafana_managed_receiver_configs:[K]}],alert:p};o((0,d.bO)(xe))}},z=!!((!n||a&&(0,j.Au)(a))&&!a?.provisioned),J=!n;if(y||s)return(0,e.jsx)(re._,{text:(0,S.t)("alerting.grafana-receiver-form.text-loading-notifiers","Loading notifiers...")});const q=O.map(p=>p.type===X.J4.OnCall?{dto:m(p),meta:A}:{dto:p});return(0,e.jsxs)(e.Fragment,{children:[b&&(0,e.jsx)(W.F,{severity:"error",title:(0,S.t)("alerting.grafana-receiver-form.title-loading-on-call-integration-failed","Loading OnCall integration failed"),children:"Grafana OnCall plugin has been enabled in your Grafana instances but it is not reachable. Please check the plugin configuration"}),a?.provisioned&&(0,e.jsx)(_.Yi,{resource:_.hk.ContactPoint}),(0,e.jsx)(B.k,{contactPointId:a?.id,isEditable:z,isTestable:J,onSubmit:k,initialValues:M,onTestChannel:he,notifiers:q,alertManagerSourceName:D.hY,defaultItem:{...ve},commonSettingsComponent:T,customValidators:{[X.J4.OnCall]:g},canManagePermissions:i&&a&&(0,G.T8)(D.hY,a)}),(0,e.jsx)(je,{onDismiss:()=>E(void 0),isOpen:!!l,onTest:p=>H(p)})]})}},45517:(Ae,oe,t)=>{t.d(oe,{k:()=>Fe});var e=t(74848),x=t(22803),R=t(49785),re=t(68143),W=t(63142),S=t(34999),Y=t(41654),G=t(37386),D=t(63527),j=t(45861),le=t(64762),ce=t(38396),d=t(56840),Q=t(97507),_=t(28141),X=t(47797),de=t(74268),P=t(77788),me=t(82203),C=t(77256),T=t(36200),B=t(2543),F=t(96540),ge=t(18857),Z=t(66404),ee=t(98127),te=t(53226),ue=t(48767),fe=t(28365);function ne({defaultValues:n,selectedChannelOptions:i,onResetSecureField:o,secureFields:N,errors:v,pathPrefix:h="",readOnly:A=!1,customValidators:m={}}){const{watch:V}=(0,R.xW)(),g=V();return(0,e.jsx)(e.Fragment,{children:i.map((s,b)=>{const O=`${s.label}-${b}`,y=h.split("."),l=y.length>=2?g.items?.[Number(y[1])].settings?.[s.showWhen.field]:void 0;if(s.showWhen.field&&l!==s.showWhen.is)return null;if(N&&N[s.propertyName])return(0,e.jsx)(G.D,{label:s.label,description:s.description,children:(0,e.jsx)(ue.L4,{onReset:()=>o(s.propertyName),isConfigured:!0})},O);const E=(s.secure?v?.secureSettings:v?.settings)?.[s.propertyName],M=n?.settings?.[s.propertyName];return(0,e.jsx)(fe.e,{onResetSecureField:o,secureFields:N,defaultValue:M,readOnly:A,error:E,pathPrefix:h,pathSuffix:s.secure?"secureSettings.":"settings.",option:s,customValidator:m[s.propertyName]},O)})})}var w=t(83904);function se({defaultValues:n,initialValues:i,pathPrefix:o,onDuplicate:N,onDelete:v,onTest:h,notifiers:A,errors:m,secureFields:V,commonSettingsComponent:g,isEditable:s=!0,isTestable:b,customValidators:O={}}){const y=(0,W.of)(ae),l=(0,F.useCallback)(c=>`${o}${c}`,[o]),{control:E,watch:M,register:U,trigger:k,formState:he,setValue:H}=(0,R.xW)(),z=M(l("type"))??n.type,J=M(l("settings.parse_mode")),{loading:q}=(0,ee.$)(c=>c.testReceivers),L=M(l("settings.integration_type"))!==te.U0.NewIntegration;(0,F.useEffect)(()=>{U(`${o}.__id`),U(`${o}.secureFields`)},[U,o]),(0,F.useEffect)(()=>{const c=M((I,{name:$,type:Te})=>{const $e=$?I[$]:"";i&&$===l("type")&&$e===i.type&&Te==="change"&&H(l("settings"),i.settings),i&&$===l("settings.integration_type")&&$e===te.U0.ExistingIntegration&&H(l("settings.url"),i.settings.url)});return()=>c.unsubscribe()},[z,i,H,l,M]);const[K,xe]=(0,F.useState)(V??{}),pe=c=>{if(K[c]){const I={...K};I[c]="",xe(I),H(`${o}.secureFields`,I)}},u=(0,F.useMemo)(()=>(0,B.sortBy)(A,({dto:c,meta:I})=>[I?.order??0,c.name]).map(({dto:{name:c,type:I},meta:$})=>({label:(0,e.jsxs)(Y.B,{alignItems:"center",gap:1,children:[c,$?.badge]}),value:I,description:$?.description,isDisabled:$?!$.enabled:!1})),[A]),r=async()=>{await k(),Object.keys(he.errors).length===0&&h&&h()},f=A.find(({dto:{type:c}})=>c===z),Re=z==="telegram"&&!(J==="None"||!J),be=f?.dto.options.filter(c=>c.required),Oe=f?.dto.options.filter(c=>!c.required),Ie=`contact-point-type-${o}`;return(0,e.jsxs)("div",{className:y.wrapper,"data-testid":"item-container",children:[(0,e.jsxs)("div",{className:y.topRow,children:[(0,e.jsx)("div",{children:(0,e.jsx)(G.D,{label:(0,d.t)("alerting.channel-sub-form.label-integration","Integration"),htmlFor:Ie,"data-testid":`${o}type`,children:(0,e.jsx)(R.xI,{name:l("type"),defaultValue:n.type,render:({field:{ref:c,onChange:I,...$}})=>(0,e.jsx)(ge.l6,{disabled:!s,inputId:Ie,...$,width:37,options:u,onChange:Te=>I(Te?.value)}),control:E,rules:{required:!0}})})}),(0,e.jsxs)("div",{className:y.buttons,children:[b&&h&&L&&(0,e.jsx)(j.$n,{disabled:q,size:"xs",variant:"secondary",type:"button",onClick:()=>r(),icon:q?"spinner":"message",children:(0,e.jsx)(d.x6,{i18nKey:"alerting.channel-sub-form.test",children:"Test"})}),s&&(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)(j.$n,{size:"xs",variant:"secondary",type:"button",onClick:()=>N(),icon:"copy",children:(0,e.jsx)(d.x6,{i18nKey:"alerting.channel-sub-form.duplicate",children:"Duplicate"})}),v&&(0,e.jsx)(j.$n,{"data-testid":`${o}delete-button`,size:"xs",variant:"secondary",type:"button",onClick:()=>v(),icon:"trash-alt",children:(0,e.jsx)(d.x6,{i18nKey:"alerting.channel-sub-form.delete",children:"Delete"})})]})]})]}),f&&(0,e.jsxs)("div",{className:y.innerContent,children:[Re&&(0,e.jsx)(S.F,{title:(0,d.t)("alerting.contact-points.telegram.parse-mode-warning-title","Telegram messages are limited to 4096 UTF-8 characters."),severity:"warning",children:(0,e.jsxs)(d.x6,{i18nKey:"alerting.contact-points.telegram.parse-mode-warning-body",children:["If you use a ",(0,e.jsx)(Z.E,{variant:"code",children:"parse_mode"})," option other than ",(0,e.jsx)(Z.E,{variant:"code",children:"None"}),", truncation may result in an invalid message, causing the notification to fail. For longer messages, we recommend using an alternative contact method."]})}),(0,e.jsx)(ne,{defaultValues:n,selectedChannelOptions:be?.length?be:Oe,secureFields:K,errors:m,onResetSecureField:pe,pathPrefix:o,readOnly:!s,customValidators:O}),!!(be?.length&&Oe?.length)&&(0,e.jsxs)(w.i,{label:`Optional ${f.dto.name} settings`,children:[f.dto.info!==""&&(0,e.jsx)(S.F,{title:"",severity:"info",children:f.dto.info}),(0,e.jsx)(ne,{defaultValues:n,selectedChannelOptions:Oe,secureFields:K,onResetSecureField:pe,errors:m,pathPrefix:o,readOnly:!s,customValidators:O})]}),(0,e.jsx)(w.i,{label:(0,d.t)("alerting.channel-sub-form.label-notification-settings","Notification settings"),children:(0,e.jsx)(g,{pathPrefix:o,readOnly:!s})})]})]})}const ae=n=>({buttons:(0,x.css)({"& > * + *":{marginLeft:n.spacing(1)}}),innerContent:(0,x.css)({maxWidth:"536px"}),wrapper:(0,x.css)({margin:n.spacing(2,0),padding:n.spacing(1),border:`solid 1px ${n.colors.border.medium}`,borderRadius:n.shape.radius.default}),topRow:(0,x.css)({display:"flex",flexDirection:"row",justifyContent:"space-between"}),channelSettingsHeader:(0,x.css)({marginTop:n.spacing(2)})});function ye({pathPrefix:n}){const{register:i}=(0,R.xW)();return(0,F.useEffect)(()=>{i(`${n}.__id`),i(`${n}.__deleted`)},[i,n]),(0,e.jsx)(e.Fragment,{children:null})}function je(n){if(n)return{...n,items:n.items.map(i=>({...i,settings:{...i.settings,http_config:i.settings?.http_config?Ce(i.settings?.http_config):void 0}}))}}function Ce(n){return ve(n)?n:{...(0,B.omit)(n,"authorization"),bearer_token:n.authorization?.credentials,bearer_token_file:n.authorization?.credentials_file}}function ve(n){return["bearer_token","bearer_token_file"].some(i=>i in n)}function Fe({initialValues:n,defaultItem:i,notifiers:o,alertManagerSourceName:N,onSubmit:v,onTestChannel:h,commonSettingsComponent:A,isEditable:m,isTestable:V,customValidators:g,showDefaultRouteWarning:s,contactPointId:b,canManagePermissions:O}){const y=(0,le._2)(),l=(0,W.of)(Se),E=(0,Q.cB)({alertmanager:N}),U=je(n)??{name:"",items:[{...i,__id:String(Math.random())}]},k=(0,R.mN)({defaultValues:structuredClone(U)});(0,ce.o)(u=>u.unifiedAlerting.saveAMConfig=T.jA);const{handleSubmit:he,register:H,formState:{errors:z,isSubmitting:J},getValues:q}=k,{fields:p,append:L,remove:K}=(0,me.r)({name:"items",formAPI:k,softDelete:!0}),xe=async u=>{u.items.forEach(r=>{r.secureFields&&Object.keys(r.secureFields).forEach(f=>{(r.secureFields[f]===!0||r.secureFields[f]===!1)&&delete r.secureFields[f]})});try{await v({...u,items:u.items.filter(r=>!r.__deleted)})}catch(r){if(r instanceof Error||(0,re.NF)(r)){y.error("Failed to save the contact point",a(r));const f=new Error("Failed to save the contact point");f.cause=r,(0,de.vV)(f)}throw r}},pe=()=>{y.error("There are errors in the form. Please correct them and try again!")};return(0,e.jsxs)(R.Op,{...k,children:[s&&(0,e.jsx)(S.F,{severity:"warning",title:(0,d.t)("alerting.receiver-form.title-attention","Attention"),children:"Because there is no default policy configured yet, this contact point will automatically be set as default."}),(0,e.jsxs)("form",{onSubmit:he(xe,pe),className:l.wrapper,children:[(0,e.jsxs)(Y.B,{justifyContent:"space-between",alignItems:"center",children:[(0,e.jsx)("h2",{className:l.heading,children:m?n?"Update contact point":"Create contact point":"Contact point"}),O&&b&&(0,e.jsx)(_.k,{resource:"receivers",resourceId:b,resourceName:n?.name,title:(0,d.t)("alerting.receiver-form.title-manage-contact-point-permissions","Manage contact point permissions")})]}),(0,e.jsx)(G.D,{label:(0,d.t)("alerting.receiver-form.label-name","Name"),invalid:!!z.name,error:z.name&&z.name.message,required:!0,children:(0,e.jsx)(D.p,{readOnly:!m,id:"name",...H("name",{required:"Name is required",validate:async u=>{const r=n?.name;return E(u,r)}}),width:39,placeholder:(0,d.t)("alerting.receiver-form.name-placeholder-name","Name")})}),p.map((u,r)=>{const f=`items.${r}.`;if(u.__deleted)return(0,e.jsx)(ye,{pathPrefix:f},u.__id);const Ne=n?.items.find(({__id:ie})=>ie===u.__id);return(0,e.jsx)(se,{defaultValues:u,initialValues:Ne,onDuplicate:()=>{const ie=q().items[r];L({...ie,__id:String(Math.random())})},onTest:h?()=>{const ie=q().items[r];h(ie)}:void 0,onDelete:()=>K(r),pathPrefix:f,notifiers:o,secureFields:Ne?.secureFields,errors:z?.items?.[r],commonSettingsComponent:A,isEditable:m,isTestable:V,customValidators:g?g[u.type]:void 0},u.__id)}),m&&(0,e.jsx)(j.$n,{type:"button",icon:"plus",variant:"secondary",onClick:()=>L({...i,__id:String(Math.random())}),children:(0,e.jsx)(d.x6,{i18nKey:"alerting.receiver-form.add-contact-point-integration",children:"Add contact point integration"})}),(0,e.jsxs)("div",{className:l.buttons,children:[m&&(0,e.jsxs)(e.Fragment,{children:[J&&(0,e.jsx)(j.$n,{disabled:!0,icon:"spinner",variant:"primary",children:(0,e.jsx)(d.x6,{i18nKey:"alerting.receiver-form.saving",children:"Saving..."})}),!J&&(0,e.jsx)(j.$n,{type:"submit",children:(0,e.jsx)(d.x6,{i18nKey:"alerting.receiver-form.save-contact-point",children:"Save contact point"})})]}),(0,e.jsx)(j.z9,{disabled:J,variant:"secondary","data-testid":"cancel-button",href:(0,C.nL)("/alerting/notifications",N),children:(0,e.jsx)(d.x6,{i18nKey:"alerting.common.cancel",children:"Cancel"})})]})]})]})}const Se=n=>({heading:(0,x.css)({margin:n.spacing(2,0,3,0)}),buttons:(0,x.css)({marginTop:n.spacing(4),"& > * + *":{marginLeft:n.spacing(1)}}),wrapper:(0,x.css)({maxWidth:`${n.breakpoints.values.xl}px`})});function a(n){return(0,P.uz)(n)?n.data.detail:(0,X.q6)(n)}}}]);

//# sourceMappingURL=8622.307a281e3fa11e9dccaa.js.map