"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[3375],{37011:(ve,$,a)=>{a.d($,{R:()=>k});var n=a(74848),Q=a(22803),Y=a(63142),G=a(76319),X=a(56840);const k=({labelKey:v,value:R,operator:q="=",onRemoveLabel:N})=>{const U=(0,Y.of)(F);return(0,n.jsxs)("div",{className:U.wrapper,children:[v,q,R,!!N&&(0,n.jsx)(G.K,{name:"times",size:"xs",onClick:N,tooltip:(0,X.t)("alerting.alert-label.tooltip-remove-label","Remove label")})]})},F=v=>({wrapper:(0,Q.css)({padding:v.spacing(.5,1),borderRadius:v.shape.radius.default,border:`solid 1px ${v.colors.border.medium}`,fontSize:v.typography.bodySmall.fontSize,backgroundColor:v.colors.background.secondary,fontWeight:v.typography.fontWeightBold,color:v.colors.text.primary,display:"inline-block",lineHeight:"1.2"})})},12915:(ve,$,a)=>{a.r($),a.d($,{plugin:()=>tt});var n=a(74848),Q=a(16207),Y=a(41654),G=a(45861),X=a(39989),k=a(76792),F=a(52161),v=a(2543),R=a(96540),q=a(18857),N=a(30703),U=a(98127),z=a(11018),w=a(36200),oe=a(96673),y=a(24619),pe=a(39659);const ye=e=>{const{onChange:s,id:t,defaultValue:o,dataSource:l}=e,r=(0,oe.useDispatch)();(0,R.useEffect)(()=>{l?l&&r((0,z.mB)({rulesSourceName:l})):r((0,z.nV)())},[r,l]);const i=(0,U.$)(m=>m.promRules),p=(0,w.p0)(i),A=(0,w.Vf)(i),c=(0,R.useMemo)(()=>{if((0,v.isEmpty)(i))return[];if(!p)return[];const m=Object.keys(i).flatMap(d=>i[d].result??[]).flatMap(d=>d.groups).flatMap(d=>d.rules.filter(x=>x.type===y.JS.Alerting)).flatMap(d=>d.alerts??[]).map(d=>Object.keys(d.labels??{})).flatMap(d=>d.filter(x=>!(0,pe.F2)(x)));return(0,v.uniq)(m)},[p,i]);return(0,n.jsx)(q.KF,{id:t,isLoading:A,defaultValue:o,"aria-label":"group by label keys",placeholder:"Group by",prefix:(0,n.jsx)(N.I,{name:"tag-alt"}),onChange:m=>{s(m.map(d=>d.value??""))},options:c.map(m=>({label:m,value:m}))})};var u=a(22803),xe=a(42941),Ae=a(94701),Re=a(75234),V=a(63142),Se=a(92807),K=a(97611),Fe=a(6975),je=a(34999),Ie=a(65642),ie=a(2954),De=a(70327),C=a(90186),be=a(23265),Be=a(95443),ce=a(63895),S=a(29609),de=a(22429),P=a(16692),g=a(21834),Ne=a(37011),Ce=a(55127),Me=a.n(Ce),Ee=a(75983),Le=a(77256),we=a(95943),Ve=a(86017),j=a(86791);function Pe(e,s){const t=(0,ce.Zc)(e);return(0,Ve.Av)(s,t)}function _(e,s){const{stateFilter:t,alertInstanceLabelFilter:o}=e;return(0,v.isEmpty)(t)?s:s.filter(l=>(t.firing&&((0,j.SA)(l,y.Gi.Alerting)||(0,j.SA)(l,y.cF.Firing))||t.pending&&((0,j.SA)(l,y.Gi.Pending)||(0,j.SA)(l,y.cF.Pending))||t.recovering&&((0,j.SA)(l,y.Gi.Recovering)||(0,j.SA)(l,y.cF.Recovering))||t.noData&&(0,j.SA)(l,y.Gi.NoData)||t.normal&&(0,j.SA)(l,y.Gi.Normal)||t.error&&(0,j.SA)(l,y.Gi.Error)||t.inactive&&(0,j.SA)(l,y.cF.Inactive))&&(o?Pe(e.alertInstanceLabelFilter,l.labels):!0))}const ue=({rule:e,alerts:s,options:t,grafanaTotalInstances:o,handleInstancesLimit:l,limitInstances:r,grafanaFilteredInstancesTotal:i})=>{const p=t.groupMode===g.r6.Custom?!0:t.showInstances,[A,c]=(0,R.useState)(p),m=(0,V.of)(Oe),d=(0,V.of)(G.my),x=(0,R.useCallback)(()=>{c(L=>!L)},[]),h=(0,R.useMemo)(()=>_(t,(0,Le.Cp)(t.sortOrder,s))??[],[s,t]),f=o!==void 0,D=o&&i?o-i:0,I=s.length-h.length,B=f?D:I,M=h.length>0,T=M?x:v.noop;(0,R.useEffect)(()=>{h.length===0&&c(!1)},[h]);const E=async()=>{l&&(l(!1),c(!0))},te=async()=>{l&&(l(!0),c(!0))},ae=r?i:h.length,se=h.length,H=f?ae:se,ne=r?`Showing ${C.Ys} of ${o} instances`:`Showing all ${o} instances`,le=r?"View all instances":`Limit the result to ${C.Ys} instances`,re=o&&C.Ys===h.length&&o>h.length,Z=o&&C.Ys<h.length&&!r,J=re||Z?(0,n.jsxs)("div",{className:m.footerRow,children:[(0,n.jsx)("div",{children:ne}),(0,n.jsx)(G.$n,{size:"sm",variant:"secondary",onClick:r?E:te,children:le})]}):void 0;return(0,n.jsxs)("div",{children:[t.groupMode===g.r6.Default&&(0,n.jsxs)("button",{className:(0,u.cx)(d,M?m.clickable:""),onClick:()=>T(),children:[M&&(0,n.jsx)(N.I,{name:A?"angle-down":"angle-right",size:"md"}),(0,n.jsx)("span",{children:`${H} ${Me()("instance",H)}`}),B>0&&(0,n.jsxs)("span",{children:[", ",`${B} hidden by filters`]})]}),A&&(0,n.jsx)(Ee.D,{rule:e,instances:h,pagination:{itemsPerPage:2*we.FG},footerRow:J})]})},Oe=e=>({clickable:(0,u.css)({cursor:"pointer"}),footerRow:(0,u.css)({display:"flex",flexDirection:"column",gap:e.spacing(1),justifyContent:"space-between",alignItems:"center",width:"100%"})}),O="__ungrouped__",Ge=({rules:e,options:s})=>{const t=(0,V.of)(ee),o=s.groupBy,l=(0,R.useMemo)(()=>{const r=new Map,i=c=>o?$e(c,o):!0;e.forEach(c=>{const m=(0,S.TU)(c),d=i(c);(m?.alerts??[]).forEach(x=>{const h=d?Ue(o,x.labels):O,f=r.get(h)?.alerts??[];r.set(h,{rule:c,alerts:[...f,x]})})});const p=r.get(O)?.alerts??[];return r.delete(O),r.set(O,{alerts:p}),Array.from(r.entries()).reduce((c,[m,{rule:d,alerts:x}])=>{const h=_(s,x);return h.length>0&&c.set(m,{rule:d,alerts:h}),c},new Map)},[o,e,s]);return(0,n.jsx)(n.Fragment,{children:Array.from(l).map(([r,{rule:i,alerts:p}])=>(0,n.jsx)("li",{className:t.alertRuleItem,"data-testid":r,children:(0,n.jsxs)("div",{children:[(0,n.jsx)("div",{className:t.customGroupDetails,children:(0,n.jsxs)("div",{className:t.alertLabels,children:[r!==O&&Te(r).map(([A,c])=>(0,n.jsx)(Ne.R,{labelKey:A,value:c},A)),r===O&&"No grouping"]})}),(0,n.jsx)(ue,{rule:i,alerts:p,options:s})]})},r))})};function Ue(e,s){return new URLSearchParams(e.map(t=>[t,s[t]])).toString()}function Te(e){return[...new URLSearchParams(e)]}function $e(e,s){const t=(0,S.TU)(e);return s.every(o=>(t?.alerts??[]).some(l=>l.labels[o]))}const Ye=Ge;var ze=a(87586),Ke=a(74529),We=a(49779),ge=a(94646),He=a(92367);function fe(e){return Object.values(e).filter(s=>s!==void 0).reduce((s,t)=>s+t,0)}const Ze=({rules:e,options:s,handleInstancesLimit:t,limitInstances:o,hideViewRuleLinkText:l})=>{const r=(0,V.of)(ee),i=(0,V.of)(Je),{href:p}=(0,ze.A)(),A=e.length<=s.maxItems?e:e.slice(0,s.maxItems);return(0,n.jsx)(n.Fragment,{children:(0,n.jsx)("ol",{className:r.alertRuleList,children:A.map((c,m)=>{const{namespaceName:d,groupName:x,dataSourceName:h}=c,f=S.R$.alertingRule(c.promRule)?c.promRule:void 0,D=(0,S.Om)(f),I=(0,ge.UP)(c.dataSourceName,c),B=(0,ge.$9)(I),M=c.dataSourceName===F.hY?fe(c.instanceTotals):void 0,T=c.dataSourceName===F.hY?fe(c.filteredInstanceTotals):void 0,E=(0,He.G)(`/alerting/${encodeURIComponent(h)}/${encodeURIComponent(B)}/view`,{returnTo:p??""});return f?(0,n.jsxs)("li",{className:r.alertRuleItem,children:[(0,n.jsx)("div",{className:i.icon,children:(0,n.jsx)(N.I,{name:ie.A.getStateDisplayModel(f.state).iconClass,className:i[(0,S.Wy)(f.state)],size:"lg"})}),(0,n.jsxs)("div",{className:r.alertNameWrapper,children:[(0,n.jsxs)("div",{className:r.instanceDetails,children:[(0,n.jsxs)(Y.B,{direction:"row",gap:1,children:[(0,n.jsx)("div",{className:r.alertName,title:c.name,children:c.name}),(0,n.jsx)(We.h,{}),E&&(0,n.jsxs)("a",{href:E,target:"__blank",className:r.link,rel:"noopener","aria-label":"View alert rule",children:[(0,n.jsx)("span",{className:(0,u.cx)({[r.hidden]:l}),children:"View alert rule"}),(0,n.jsx)(N.I,{name:"external-link-alt",size:"sm"})]})]}),(0,n.jsxs)("div",{className:r.alertDuration,children:[(0,n.jsx)("span",{className:i[(0,S.Wy)(f.state)],children:(0,S.XI)(f.state)})," ",D&&f.state!==y.cF.Inactive&&(0,n.jsxs)(n.Fragment,{children:["for"," ",(0,n.jsx)("span",{children:(0,Ke.dU)({start:D,end:Date.now()})})]})]})]}),(0,n.jsx)(ue,{rule:c,alerts:f.alerts??[],options:s,grafanaTotalInstances:M,grafanaFilteredInstancesTotal:T,handleInstancesLimit:t,limitInstances:o})]})]},`alert-${d}-${x}-${c.name}-${m}`):null})})})},Je=e=>({icon:(0,u.css)({marginTop:e.spacing(2.5),alignSelf:"flex-start"}),good:(0,u.css)({color:e.colors.success.main}),bad:(0,u.css)({color:e.colors.error.main}),warning:(0,u.css)({color:e.colors.warning.main}),neutral:(0,u.css)({color:e.colors.secondary.main}),info:(0,u.css)({color:e.colors.primary.main})}),Qe=Ze;function Xe(e){const s=(t,[o,l])=>l?[...t,o]:t;return Object.entries(e).reduce(s,[])}const W=({dispatch:e,limitInstances:s,matcherList:t,dataSourceName:o,stateList:l})=>{e(o?(0,z.Lc)({rulesSourceName:o,limitAlerts:s?C.Ys:void 0,matcher:t,state:l}):(0,z.yo)(!1,{limitAlerts:s?C.Ys:void 0,matcher:t,state:l}))};function ke(e){const s=(0,oe.useDispatch)(),[t,o]=(0,xe.A)(!0),[,l]=(0,P.Ej)(P.RY.ViewAlertRule),{usePrometheusRulesByNamespaceQuery:r}=De.hK,i=(0,U.$)(b=>b.promRules),p=(0,U.$)(b=>b.rulerRules),A=(0,w.t4)(i),c=e.width<320;(0,R.useEffect)(()=>{e.options.stateFilter.inactive===!0&&(e.options.stateFilter.normal=!0),e.options.stateFilter.inactive=void 0},[e.options.stateFilter]);let m;(0,Ae.A)(()=>{m=(0,de.UA)().getCurrent()});const d=(0,R.useMemo)(()=>Xe(e.options.stateFilter),[e.options.stateFilter]),{options:x,replaceVariables:h}=e,f=x.datasource===F.vv?F.hY:x.datasource,D={...e.options,alertName:h(x.alertName),alertInstanceLabelFilter:h(x.alertInstanceLabelFilter)},I=(0,R.useMemo)(()=>(0,ce.Zc)(D.alertInstanceLabelFilter),[D.alertInstanceLabelFilter]),B=(!f||f===F.hY)&&l,{currentData:M=[],isLoading:T,refetch:E}=r({limitAlerts:t?C.Ys:void 0,matcher:I,state:d},{skip:!B});(0,R.useEffect)(()=>{i.loading||W({dispatch:s,limitInstances:t,matcherList:I,dataSourceName:f,stateList:d});const b=m?.events.subscribe(Re.sR,()=>{B&&E(),(!f||f!==F.hY)&&W({dispatch:s,limitInstances:t,matcherList:I,dataSourceName:f,stateList:d})});return()=>{b?.unsubscribe()}},[s,m,I,d,t,f,E,B,i.loading]);const te=b=>{b?(W({dispatch:s,limitInstances:t,matcherList:I,dataSourceName:f,stateList:d}),o(!0)):(W({dispatch:s,limitInstances:!1,matcherList:I,dataSourceName:f,stateList:d}),o(!1))},ae=(0,be.dy)(void 0,M),se=(0,w.t4)(p),H=(0,w.BU)(i),ne=A||se,le=(0,w.Vf)(i),re=(0,V.of)(ee),Z=(0,S.dS)(ae),J=e.options.sortOrder,L=(0,R.useMemo)(()=>_e(e,qe(J,Z)),[Z,J,e]),me=L.length===0?"No alerts matching filters":void 0,at=T||ne&&le&&!H,he=Object.values(i).some(b=>b.result);return(0,n.jsxs)(Se.P,{minHeight:"100%",children:[he&&me&&(0,n.jsx)("div",{className:re.noAlertsMessage,children:me}),he&&(0,n.jsxs)("section",{children:[e.options.viewMode===g.nE.Stat&&(0,n.jsx)(K.yV,{width:e.width,height:e.height,graphMode:K.$p.None,textMode:K.SV.Auto,justifyMode:K.F8.Auto,theme:Ie.$W.theme2,value:{text:`${L.length}`,numeric:L.length}}),e.options.viewMode===g.nE.List&&e.options.groupMode===g.r6.Custom&&(0,n.jsx)(Ye,{rules:L,options:D}),e.options.viewMode===g.nE.List&&e.options.groupMode===g.r6.Default&&(0,n.jsx)(Qe,{rules:L,options:D,handleInstancesLimit:te,limitInstances:t,hideViewRuleLinkText:c})]}),at&&(0,n.jsx)(Fe._,{text:"Loading..."})]})}function qe(e,s){if(e===g.xB.Importance)return(0,v.sortBy)(s,o=>ie.A.alertStateSortScore[o.state]);if(e===g.xB.TimeAsc)return(0,v.sortBy)(s,o=>{const l=(0,S.TU)(o)??void 0;return(0,S.Om)(l)||new Date});if(e===g.xB.TimeDesc)return(0,v.sortBy)(s,o=>{const l=(0,S.TU)(o)??void 0;return(0,S.Om)(l)||new Date}).reverse();const t=(0,v.sortBy)(s,o=>o.name.toLowerCase());return e===g.xB.AlphaDesc&&t.reverse(),t}function _e(e,s){const{options:t,replaceVariables:o}=e;let l=[...s];if(t.dashboardAlerts){const r=(0,de.UA)().getCurrent()?.uid;l=l.filter(({annotations:i={}})=>Object.entries(i).some(([p,A])=>p===Be.YH.dashboardUID&&A===r))}if(t.alertName){const r=o(t.alertName);l=l.filter(({name:i})=>i.toLocaleLowerCase().includes(r.toLocaleLowerCase()))}if(l=l.filter(r=>{const i=(0,S.TU)(r);return i?t.stateFilter.firing&&i.state===y.cF.Firing||t.stateFilter.pending&&i.state===y.cF.Pending||t.stateFilter.normal&&i.state===y.cF.Inactive||t.stateFilter.recovering&&i.state===y.cF.Recovering:!1}),t.folder&&t.folder.uid&&(l=l.filter(r=>r.namespace.uid===t.folder.uid)),t.datasource){const r=t.datasource===F.vv;l=l.filter(r?({dataSourceName:i})=>i===F.hY:({dataSourceName:i})=>i===t.datasource)}return l=l.reduce((r,i)=>{const p=(0,S.TU)(i);return((p?_({stateFilter:t.stateFilter,alertInstanceLabelFilter:o(t.alertInstanceLabelFilter)},p.alerts??[]):[]).length||p?.state===y.cF.Inactive&&t.showInactiveAlerts&&!t.alertInstanceLabelFilter.length)&&r.push(i),r},[]),l}const ee=e=>({cardContainer:(0,u.css)({padding:e.spacing(.5,0,.25,0),lineHeight:e.typography.body.lineHeight,marginBottom:0}),alertRuleList:(0,u.css)({display:"flex",flexWrap:"wrap",justifyContent:"space-between",listStyleType:"none"}),alertRuleItem:(0,u.css)({display:"flex",alignItems:"center",width:"100%",height:"100%",background:e.colors.background.secondary,padding:e.spacing(.5,1),borderRadius:e.shape.radius.default,marginBottom:e.spacing(.5),gap:e.spacing(2)}),alertName:(0,u.css)({fontSize:e.typography.h6.fontSize,fontWeight:e.typography.fontWeightBold,whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"}),alertNameWrapper:(0,u.css)({display:"flex",flex:1,flexWrap:"nowrap",flexDirection:"column",minWidth:"100px"}),alertLabels:(0,u.css)({"> *":{marginRight:e.spacing(.5)}}),alertDuration:(0,u.css)({fontSize:e.typography.bodySmall.fontSize}),alertRuleItemText:(0,u.css)({fontWeight:e.typography.fontWeightBold,fontSize:e.typography.bodySmall.fontSize,margin:0}),alertRuleItemTime:(0,u.css)({color:e.colors.text.secondary,fontWeight:"normal",whiteSpace:"nowrap"}),alertRuleItemInfo:(0,u.css)({fontWeight:"normal",flexGrow:2,display:"flex",alignItems:"flex-end"}),noAlertsMessage:(0,u.css)({display:"flex",alignItems:"center",justifyContent:"center",width:"100%",height:"100%"}),alertIcon:(0,u.css)({marginRight:e.spacing(.5)}),instanceDetails:(0,u.css)({minWidth:"1px",whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"}),customGroupDetails:(0,u.css)({marginBottom:e.spacing(.5)}),link:(0,u.css)({wordBreak:"break-all",color:e.colors.primary.text,display:"flex",alignItems:"center",gap:e.spacing(1)}),hidden:(0,u.css)({display:"none"})});function et(e){const[,s]=(0,P.Ej)(P.RY.ViewAlertRule),[,t]=(0,P.Ej)(P.RY.ViewExternalAlertRule);return!s&&!t?(0,n.jsx)(je.F,{title:"Permission required",children:"Sorry, you do not have the required permissions to read alert rules"}):(0,n.jsx)(ke,{...e})}const tt=new Q.m(et).setPanelOptions(e=>{e.addRadio({path:"viewMode",name:"View mode",description:"Toggle between list view and stat view",defaultValue:g.nE.List,settings:{options:[{label:"List",value:g.nE.List},{label:"Stat",value:g.nE.Stat}]},category:["Options"]}).addRadio({path:"groupMode",name:"Group mode",description:"How alert instances should be grouped",defaultValue:g.r6.Default,settings:{options:[{value:g.r6.Default,label:"Default grouping"},{value:g.r6.Custom,label:"Custom grouping"}]},category:["Options"]}).addCustomEditor({path:"groupBy",name:"Group by",description:"Filter alerts using label querying",id:"groupBy",defaultValue:[],showIf:s=>s.groupMode===g.r6.Custom,category:["Options"],editor:s=>(0,n.jsx)(ye,{id:s.id??"groupBy",defaultValue:s.value.map(t=>({label:t,value:t})),onChange:s.onChange,dataSource:s.context.options.datasource})}).addNumberInput({name:"Max items",path:"maxItems",description:"Maximum alerts to display",defaultValue:20,category:["Options"]}).addSelect({name:"Sort order",path:"sortOrder",description:"Sort order of alerts and alert instances",settings:{options:[{label:"Alphabetical (asc)",value:g.xB.AlphaAsc},{label:"Alphabetical (desc)",value:g.xB.AlphaDesc},{label:"Importance",value:g.xB.Importance},{label:"Time (asc)",value:g.xB.TimeAsc},{label:"Time (desc)",value:g.xB.TimeDesc}]},defaultValue:g.xB.AlphaAsc,category:["Options"]}).addBooleanSwitch({path:"dashboardAlerts",name:"Alerts linked to this dashboard",description:"Only show alerts linked to this dashboard",defaultValue:!1,category:["Options"]}).addTextInput({path:"alertName",name:"Alert name",description:"Filter for alerts containing this text",defaultValue:"",category:["Filter"]}).addTextInput({path:"alertInstanceLabelFilter",name:"Alert instance label",description:'Filter alert instances using label querying, ex: {severity="critical", instance=~"cluster-us-.+"}',defaultValue:"",category:["Filter"]}).addCustomEditor({path:"datasource",name:"Datasource",description:"Filter from alert source",id:"datasource",defaultValue:null,editor:function(t){return(0,n.jsxs)(Y.B,{gap:1,children:[(0,n.jsx)(k.s,{...t,type:F.o_,noDefault:!0,current:t.value,onChange:o=>(o.uid!=="grafana"&&(t.context.options.folder=null),t.onChange(o.name))}),(0,n.jsx)(G.$n,{variant:"secondary",onClick:()=>t.onChange(null),children:"Clear"})]})},category:["Filter"]}).addCustomEditor({showIf:s=>s.datasource===F.vv||!s.datasource,path:"folder",name:"Folder",description:"Filter for alerts in the selected folder (for Grafana-managed alert rules only)",id:"folder",defaultValue:null,editor:function(t){return(0,n.jsx)(X.NestedFolderPicker,{clearable:!0,showRootFolder:!1,...t,onChange:(o,l)=>t.onChange({uid:o,title:l}),value:t.value?.uid,permission:"view"})},category:["Filter"]}).addBooleanSwitch({path:"showInactiveAlerts",name:"Show alerts with 0 instances",description:"Include alert rules which have 0 (zero) instances. Because these rules have no instances, they remain hidden if the Alert instance label filter is configured.",defaultValue:!1,category:["Filter"]}).addBooleanSwitch({path:"stateFilter.firing",name:"Alerting / Firing",defaultValue:!0,category:["Alert state filter"]}).addBooleanSwitch({path:"stateFilter.pending",name:"Pending",defaultValue:!0,category:["Alert state filter"]}).addBooleanSwitch({path:"stateFilter.recovering",name:"Recovering",defaultValue:!0,category:["Alert state filter"]}).addBooleanSwitch({path:"stateFilter.noData",name:"No Data",defaultValue:!1,category:["Alert state filter"]}).addBooleanSwitch({path:"stateFilter.normal",name:"Normal",defaultValue:!1,category:["Alert state filter"]}).addBooleanSwitch({path:"stateFilter.error",name:"Error",defaultValue:!0,category:["Alert state filter"]})})}}]);

//# sourceMappingURL=alertListPanel.60fbee3b0671459949fa.js.map