"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[9668],{25471:(ve,ee,n)=>{n.d(ee,{A:()=>f});var e=n(74848),a=n(22803),C=n(1932),p=n(96540),B=n(49785),O=n(42941),N=n(63142),V=n(41654),$=n(66404),K=n(63527),M=n(87105),T=n(37386),F=n(45861),l=n(56840),m=n(95443),ae=n(29609);const Z=({field:t})=>{const o=(0,N.of)(X);return(0,e.jsxs)("div",{children:[(0,e.jsx)("span",{className:o.annotationTitle,children:(0,e.jsx)(l.x6,{i18nKey:"alerting.custom-annotation-header-field.custom-annotation-name-and-content",children:"Custom annotation name and content"})}),(0,e.jsx)(K.p,{placeholder:(0,l.t)("alerting.custom-annotation-header-field.placeholder-enter-custom-annotation-name","Enter custom annotation name..."),width:18,...t,className:o.customAnnotationInput})]})},X=t=>({annotationTitle:(0,a.css)({color:t.colors.text.primary,marginBottom:"3px"}),customAnnotationInput:(0,a.css)({marginTop:"5px",width:"100%"})}),x=Z,j=({annotationField:t,annotations:o,annotation:d,index:y,labelId:u})=>{const{control:i}=(0,B.xW)();return(0,e.jsxs)(V.B,{direction:"column",gap:0,children:[(0,e.jsx)("label",{htmlFor:u,children:(0,e.jsx)(B.xI,{name:`annotations.${y}.key`,defaultValue:t.key,render:({field:{ref:r,...H}})=>{if(!m.J3[d])return(0,e.jsx)(x,{field:H});let h;switch(t.key){case m.YH.dashboardUID:h="Dashboard and panel";break;case m.YH.panelID:h="";break;default:h=m.J3[d]&&m.J3[d]+" (optional)"}return(0,e.jsx)("span",{"data-testid":`annotation-key-${y}`,children:(0,e.jsx)($.E,{color:"primary",variant:"bodySmall",children:h})})},control:i,rules:{required:{value:!!o[y]?.value,message:"Required."}}})}),(0,e.jsx)($.E,{variant:"bodySmall",color:"secondary",children:m.H8[d]})]})};var g=n(30703),S=n(77256);const E=({dashboard:t,panel:o,dashboardUid:d,panelId:y,onEditClick:u,onDeleteClick:i})=>{const r=(0,N.of)(k),H=(0,S.JM)(t?.uid||d),h=(0,S.D2)(t?.uid||d,o?.id?.toString()||y);return(0,e.jsxs)("div",{className:r.container,children:[t&&(0,e.jsxs)("a",{href:H,className:r.link,target:"_blank",rel:"noreferrer","data-testid":"dashboard-annotation",children:[t.title," ",(0,e.jsx)(g.I,{name:"external-link-alt"})]}),!t&&(0,e.jsxs)("span",{className:r.noLink,children:["Dashboard ",d," "]}),o&&(0,e.jsxs)("a",{href:h,className:r.link,target:"_blank",rel:"noreferrer","data-testid":"panel-annotation",children:[o.title||"<No title>"," ",(0,e.jsx)(g.I,{name:"external-link-alt"})]}),!o&&(0,e.jsxs)("span",{className:r.noLink,children:[" - Panel ",y]}),(t||o)&&(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)(g.I,{name:"pen",onClick:u,className:r.icon}),(0,e.jsx)(g.I,{name:"trash-alt",onClick:i,className:r.icon})]})]})},k=t=>({container:(0,a.css)({marginTop:"5px"}),noLink:(0,a.css)({color:t.colors.text.secondary}),link:(0,a.css)({color:t.colors.text.link,marginRight:t.spacing(1.5)}),icon:(0,a.css)({marginRight:t.spacing(1),cursor:"pointer"})}),U=E;var ue=n(2543),Re=n(40996),ge=n(70713),ye=n(91793),be=n(45967),je=n(22787),De=n(34999),he=n(12737),Se=n(6975),le=n(5709);const me=le.H.injectEndpoints({endpoints:t=>({search:t.query({query:({query:o})=>{const d=new URLSearchParams({type:"dash-db",limit:"1000",page:"1",sort:"name_sort"});return o&&d.set("query",o),{url:`/api/search?${d.toString()}`}}}),dashboard:t.query({query:({uid:o})=>({url:`/api/dashboards/uid/${o}`})})})});var Pe=n(41811),pe=n(7817);const Me=(0,Pe.default)(t=>{const{dashboard:o,meta:d}=structuredClone(t);return new pe.G(o,d)});function Ie(t){return me.endpoints.dashboard.useQuery({uid:t??""},{skip:!t,selectFromResult:({currentData:d,data:y,...u})=>({dashboardModel:d?Me(d):void 0,...u})})}function Te(t,o){return t.title&&o.title?t.title.localeCompare(o.title):t.title&&!o.title?1:!t.title&&o.title?-1:0}const Be=({dashboardUid:t,panelId:o,isOpen:d,onChange:y,onDismiss:u})=>{const i=(0,N.of)(Oe),[r,H]=(0,p.useState)(t),[h,se]=(0,p.useState)(o),[te,re]=(0,p.useState)(""),[q,J]=(0,p.useState)(""),[z,w]=(0,p.useState)(""),{useSearchQuery:A}=me,{currentData:R=[],isFetching:_}=A({query:q}),{dashboardModel:W,isFetching:G}=Ie(r),Ne=(0,p.useCallback)(I=>{H(I),se(void 0)},[]),Le=fe(W),Ce=Le.filter(I=>I.title?.toLowerCase().includes(z.toLowerCase())).sort(Te)??[],xe=Le.find(I=>ce(I)&&I.id?.toString()===h),de=(0,p.useMemo)(()=>R.map(I=>I.uid).indexOf(r??""),[R,r]),L=t&&t===r,P=de>=0,ne=(0,p.useCallback)(I=>{const Y=de>=0;L&&Y&&I?.scrollToItem(de,"smart")},[L,de]);(0,Re.A)(()=>{J(te)},500,[te]);const oe=({index:I,style:Y})=>{const Q=R[I],Ee=r===Q.uid;return(0,e.jsxs)("button",{type:"button",title:Q.title,style:Y,className:(0,a.cx)(i.rowButton,{[i.rowOdd]:I%2===1,[i.rowSelected]:Ee}),onClick:()=>Ne(Q.uid),children:[(0,e.jsx)("div",{className:(0,a.cx)(i.dashboardTitle,i.rowButtonTitle),children:Q.title}),(0,e.jsxs)("div",{className:i.dashboardFolder,children:[(0,e.jsx)(g.I,{name:"folder"})," ",Q.folderTitle??"Dashboards"]})]})},ie=({index:I,style:Y})=>{const Q=Ce[I],Ee=Q.title||"<No title>",Fe=!!Q.id&&h===Q.id,ke=Q.type==="graph"||Q.type==="timeseries",Ae=!ce(Q);return(0,e.jsxs)("button",{type:"button",style:Y,disabled:Ae,className:(0,a.cx)(i.rowButton,i.panelButton,{[i.rowOdd]:I%2===1,[i.rowSelected]:Fe}),onClick:()=>Ae?ue.noop:se(Q.id),children:[(0,e.jsx)("div",{className:i.rowButtonTitle,title:Ee,children:Ee}),!ke&&!Ae&&(0,e.jsx)(be.m,{content:"The alert tab and alert annotations are only supported on graph and timeseries panels.",children:(0,e.jsx)(g.I,{name:"exclamation-triangle",className:i.warnIcon,"data-testid":"warning-icon"})}),Ae&&(0,e.jsx)(be.m,{content:"This panel does not have a valid identifier.",children:(0,e.jsx)(g.I,{name:"info-circle","data-testid":"info-icon"})})]})};return(0,e.jsxs)(je.a,{title:(0,l.t)("alerting.dashboard-picker.title-select-dashboard-and-panel","Select dashboard and panel"),closeOnEscape:!0,isOpen:d,onDismiss:u,className:i.modal,contentClassName:i.modalContent,children:[!P&&t&&W&&(0,e.jsxs)(De.F,{title:(0,l.t)("alerting.dashboard-picker.title-current-selection","Current selection"),severity:"info",topSpacing:0,bottomSpacing:1,className:i.modalAlert,children:[(0,e.jsxs)("div",{children:["Dashboard: ",W.title," (",W.uid,") in folder"," ",W.meta?.folderTitle??"Dashboards"]}),xe&&(0,e.jsxs)("div",{children:["Panel: ",xe.title," (",xe.id,")"]})]}),(0,e.jsxs)("div",{className:i.container,children:[(0,e.jsx)(he.Z,{value:te,onChange:re,title:(0,l.t)("alerting.dashboard-picker.title-search-dashboard","Search dashboard"),placeholder:(0,l.t)("alerting.dashboard-picker.placeholder-search-dashboard","Search dashboard"),autoFocus:!0}),(0,e.jsx)(he.Z,{value:z,onChange:w,title:(0,l.t)("alerting.dashboard-picker.title-search-panel","Search panel"),placeholder:(0,l.t)("alerting.dashboard-picker.placeholder-search-panel","Search panel")}),(0,e.jsxs)("div",{className:i.column,children:[_&&(0,e.jsx)(Se._,{text:(0,l.t)("alerting.dashboard-picker.text-loading-dashboards","Loading dashboards..."),className:i.loadingPlaceholder}),!_&&(0,e.jsx)(ge.default,{children:({height:I,width:Y})=>(0,e.jsx)(ye.Y1,{ref:ne,itemSize:50,height:I,width:Y,itemCount:R.length,children:oe})})]}),(0,e.jsxs)("div",{className:i.column,children:[!r&&!G&&(0,e.jsx)("div",{className:i.selectDashboardPlaceholder,children:(0,e.jsx)("div",{children:(0,e.jsx)(l.x6,{i18nKey:"alerting.dashboard-picker.select-dashboard-available-panels",children:"Select a dashboard to get a list of available panels"})})}),G&&(0,e.jsx)(Se._,{text:(0,l.t)("alerting.dashboard-picker.text-loading-dashboard","Loading dashboard..."),className:i.loadingPlaceholder}),r&&!G&&(0,e.jsx)(ge.default,{children:({width:I,height:Y})=>(0,e.jsx)(ye.Y1,{itemSize:32,height:Y,width:I,itemCount:Ce.length,children:ie})})]})]}),(0,e.jsxs)(je.a.ButtonRow,{children:[(0,e.jsx)(F.$n,{type:"button",variant:"secondary",onClick:u,fill:"text",children:(0,e.jsx)(l.x6,{i18nKey:"alerting.common.cancel",children:"Cancel"})}),(0,e.jsx)(F.$n,{type:"button",variant:"primary",disabled:!(r&&h),onClick:()=>{r&&h&&y(r,h)},children:(0,e.jsx)(l.x6,{i18nKey:"alerting.dashboard-picker.confirm",children:"Confirm"})})]})]})};function fe(t){if(!t)return[];const o=t.panels.filter(u=>u.type!=="row"),d=t.panels.filter(u=>u.collapsed).flatMap(u=>u.panels??[]);return[...o,...d]}const ce=t=>{const o=typeof t.id=="number",d=typeof t.type=="string",y="libraryPanel"in t;return o&&(d||y)},Oe=t=>{const o=(0,F.my)(t);return{container:(0,a.css)({display:"grid",gridTemplateColumns:"1fr 1fr",gridTemplateRows:"min-content auto",gap:t.spacing(2),flex:1}),column:(0,a.css)({flex:"1 1 auto"}),dashboardTitle:(0,a.css)({height:"22px",fontWeight:t.typography.fontWeightBold}),dashboardFolder:(0,a.css)({height:"20px",fontSize:t.typography.bodySmall.fontSize,color:t.colors.text.secondary,display:"flex",flexDirection:"row",justifyContent:"flex-start",columnGap:t.spacing(1),alignItems:"center"}),rowButton:(0,a.css)(o,{padding:t.spacing(.5),overflow:"hidden",textOverflow:"ellipsis",textAlign:"left",whiteSpace:"nowrap",cursor:"pointer",border:"2px solid transparent","&:disabled":{cursor:"not-allowed",color:t.colors.text.disabled}}),rowButtonTitle:(0,a.css)({textOverflow:"ellipsis",overflow:"hidden"}),rowSelected:(0,a.css)({borderColor:t.colors.primary.border}),rowOdd:(0,a.css)({backgroundColor:t.colors.background.secondary}),panelButton:(0,a.css)({display:"flex",gap:t.spacing(1),justifyContent:"space-between",alignItems:"center"}),loadingPlaceholder:(0,a.css)({height:"100%",display:"flex",justifyContent:"center",alignItems:"center"}),selectDashboardPlaceholder:(0,a.css)({width:"100%",height:"100%",display:"flex",flexDirection:"column",justifyContent:"center",textAlign:"center",fontWeight:t.typography.fontWeightBold}),modal:(0,a.css)({height:"100%"}),modalContent:(0,a.css)({flex:1,display:"flex",flexDirection:"column"}),modalAlert:(0,a.css)({flexGrow:0}),warnIcon:(0,a.css)({fill:t.colors.warning.main})}};var s=n(25521),c=n(58872);const D=()=>{const t=(0,N.of)(v),[o,d]=(0,O.A)(!1),{control:y,register:u,watch:i,formState:{errors:r},setValue:H}=(0,B.xW)(),h=i("annotations"),se=i("type"),{fields:te,append:re,remove:q}=(0,B.jz)({control:y,name:"annotations"}),J=h.find(L=>L.key===m.YH.dashboardUID)?.value,z=Number(h.find(L=>L.key===m.YH.panelID)?.value),[w,A]=(0,p.useState)(void 0),[R,_]=(0,p.useState)(void 0),{dashboardModel:W,isFetching:G}=Ie(J);(0,p.useEffect)(()=>{if(G||!W)return;A(W);const P=fe(W).find(ne=>ne.id===z);_(P)},[z,W,G]);const Ne=(L,P)=>{const ne=(0,C.jM)(h,oe=>{const ie=oe.find(Y=>Y.key===m.YH.dashboardUID),I=oe.find(Y=>Y.key===m.YH.panelID);ie?ie.value=L:oe.push({key:m.YH.dashboardUID,value:L}),I?I.value=P.toString():oe.push({key:m.YH.panelID,value:P.toString()})});H("annotations",ne),d(!1)},Le=()=>{const L=h.filter(P=>P.key!==m.YH.dashboardUID&&P.key!==m.YH.panelID);H("annotations",L),A(void 0),_(void 0)},Ce=()=>{d(!0)};function xe(){return(0,e.jsxs)(V.B,{direction:"row",gap:.5,alignItems:"center",children:[(0,e.jsx)($.E,{variant:"bodySmall",color:"secondary",children:(0,e.jsx)(l.x6,{i18nKey:"alerting.annotations.description",children:"Add more context to your alert notifications."})}),(0,e.jsx)(s.G,{externalLink:"https://grafana.com/docs/grafana/latest/alerting/fundamentals/alert-rules/annotation-label/#annotations",linkText:"Read about annotations",contentText:(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)("p",{children:(0,l.t)("alerting.rule-form.annotations.description1","Annotations add additional information to alerts, helping alert responders identify and address potential issues.")}),(0,e.jsx)("p",{children:(0,l.t)("alerting.rule-form.annotations.description2","For example, add a Summary annotation to tell you which value caused the alert to fire or which server it happened on.")}),(0,l.t)("alerting.rule-form.annotations.description3","Annotations can contain a combination of text and template code, which is used to include data from queries.")]}),title:(0,l.t)("alerting.annotations-step.get-annotations-section-description.title-annotations","Annotations")})]})}const de=(0,ae.H2)(se)?6:5;return(0,e.jsx)(c.P,{stepNo:de,title:(0,l.t)("alerting.annotations.title","Configure notification message"),description:xe(),fullWidth:!0,children:(0,e.jsxs)(V.B,{direction:"column",gap:1,children:[te.map((L,P)=>{const ne=h[P]?.key?.toLocaleLowerCase().endsWith("url"),oe=ne?K.p:M.f,ie=L.key;return(0,e.jsx)("div",{className:t.flexRow,children:(0,e.jsxs)("div",{children:[(0,e.jsx)(j,{annotationField:L,annotations:h,annotation:ie,index:P,labelId:`annotation-${P}`}),J&&z&&L.key===m.YH.dashboardUID&&(0,e.jsx)(U,{dashboard:w,panel:R,dashboardUid:J.toString(),panelId:z.toString(),onEditClick:Ce,onDeleteClick:Le}),(0,e.jsxs)("div",{className:t.annotationValueContainer,children:[(0,e.jsx)(T.D,{hidden:L.key===m.YH.dashboardUID||L.key===m.YH.panelID,className:(0,a.cx)(t.flexRowItemMargin,t.field),invalid:!!r.annotations?.[P]?.value?.message,error:r.annotations?.[P]?.value?.message,children:(0,e.jsx)(oe,{"data-testid":`annotation-value-${P}`,id:`annotation-${P}`,className:(0,a.cx)(t.annotationValueInput,{[t.textarea]:!ne}),...u(`annotations.${P}.value`),placeholder:ne?"https://":L.key&&`Enter a ${L.key}...`||"Enter custom annotation content...",defaultValue:L.value})}),!m.J3[ie]&&(0,e.jsx)(F.$n,{type:"button",className:t.deleteAnnotationButton,"aria-label":(0,l.t)("alerting.annotations-step.aria-label-delete-annotation","delete annotation"),icon:"trash-alt",variant:"secondary",onClick:()=>q(P)})]})]})},L.id)}),(0,e.jsx)(V.B,{direction:"row",gap:1,children:(0,e.jsxs)("div",{className:t.addAnnotationsButtonContainer,children:[(0,e.jsx)(F.$n,{icon:"plus",type:"button",variant:"secondary",onClick:()=>{re({key:"",value:""})},children:(0,e.jsx)(l.x6,{i18nKey:"alerting.annotations-step.add-custom-annotation",children:"Add custom annotation"})}),!w&&(0,e.jsx)(F.$n,{type:"button",variant:"secondary",icon:"dashboard",onClick:()=>d(!0),children:(0,e.jsx)(l.x6,{i18nKey:"alerting.annotations-step.link-dashboard-and-panel",children:"Link dashboard and panel"})})]})}),o&&(0,e.jsx)(Be,{isOpen:!0,dashboardUid:J,panelId:z,onChange:Ne,onDismiss:()=>d(!1)})]})})},v=t=>({annotationValueInput:(0,a.css)({width:"394px"}),textarea:(0,a.css)({height:"76px"}),addAnnotationsButtonContainer:(0,a.css)({marginTop:t.spacing(1),gap:t.spacing(1),display:"flex"}),field:(0,a.css)({marginBottom:t.spacing(.5)}),flexRow:(0,a.css)({display:"flex",flexDirection:"row",justifyContent:"flex-start"}),flexRowItemMargin:(0,a.css)({marginTop:t.spacing(1)}),deleteAnnotationButton:(0,a.css)({display:"inline-block",marginTop:"10px",marginLeft:"10px"}),annotationTitle:(0,a.css)({color:t.colors.text.primary,marginBottom:"3px"}),annotationContainer:(0,a.css)({marginTop:"5px"}),annotationDescription:(0,a.css)({color:t.colors.text.secondary}),annotationValueContainer:(0,a.css)({display:"flex"})}),f=D},25521:(ve,ee,n)=>{n.d(ee,{G:()=>$});var e=n(74848),a=n(22803),C=n(63142),p=n(59243),B=n(41654),O=n(30703),N=n(66404),V=n(56840);function $({contentText:M,externalLink:T,linkText:F,title:l="Need help?"}){const m=(0,C.of)(K);return(0,e.jsx)(p.G,{content:(0,e.jsx)("div",{className:m.mutedText,children:M}),title:(0,e.jsxs)(B.B,{gap:.5,direction:"row",alignItems:"center",children:[(0,e.jsx)(O.I,{name:"question-circle"}),l]}),footer:T?(0,e.jsx)("a",{href:T,target:"_blank",rel:"noreferrer",children:(0,e.jsx)(B.B,{direction:"row",gap:.5,alignItems:"center",children:(0,e.jsxs)(N.E,{color:"link",children:[F," ",(0,e.jsx)(O.I,{size:"sm",name:"external-link-alt"})]})})}):void 0,closeButton:!0,placement:"bottom-start",children:(0,e.jsx)("div",{className:m.helpInfo,children:(0,e.jsxs)(B.B,{direction:"row",alignItems:"center",gap:.5,children:[(0,e.jsx)(O.I,{name:"question-circle",size:"sm"}),(0,e.jsx)(N.E,{variant:"bodySmall",color:"primary",children:(0,e.jsx)(V.x6,{i18nKey:"alerting.need-help-info.need-help",children:"Need help?"})})]})})})}const K=M=>({mutedText:(0,a.css)({color:M.colors.text.secondary,fontSize:M.typography.size.sm}),helpInfo:(0,a.css)({cursor:"pointer",textDecoration:"underline"})})},58872:(ve,ee,n)=>{n.d(ee,{P:()=>K});var e=n(74848),a=n(22803),C=n(85629),p=n(63142),B=n(16780),O=n(41654),N=n(66404),V=n(21285),$=n(56840);const K=({title:T,stepNo:F,children:l,fullWidth:m=!1,description:ae,switchMode:Z})=>{const X=(0,p.of)(M),x=C.Tp.components.AlertRules;return(0,e.jsx)("div",{className:X.parent,"data-testid":x.step(F.toString()),children:(0,e.jsx)(B.n,{className:(0,a.cx)(m&&X.fullWidth),label:(0,e.jsxs)(O.B,{direction:"row",alignItems:"center",justifyContent:"space-between",children:[(0,e.jsxs)(N.E,{variant:"h3",children:[F,". ",T]}),Z&&(0,e.jsx)(N.E,{variant:"bodySmall",children:(0,e.jsx)(V.K,{"data-testid":x.stepAdvancedModeSwitch(F.toString()),value:Z.isAdvancedMode,onChange:b=>{Z.setAdvancedMode(b.currentTarget.checked)},label:(0,$.t)("alerting.rule-editor-section.label-advanced-options","Advanced options"),showLabel:!0,transparent:!0,className:X.reverse})})]}),children:(0,e.jsxs)(O.B,{direction:"column",children:[ae&&(0,e.jsx)("div",{className:X.description,children:ae}),l]})})})},M=T=>({parent:(0,a.css)({display:"flex",flexDirection:"row",border:`solid 1px ${T.colors.border.weak}`,borderRadius:T.shape.radius.default,padding:`${T.spacing(2)} ${T.spacing(3)}`}),description:(0,a.css)({marginTop:`-${T.spacing(2)}`}),fullWidth:(0,a.css)({width:"100%"}),reverse:(0,a.css)({flexDirection:"row-reverse",gap:T.spacing(1)})})},8402:(ve,ee,n)=>{n.d(ee,{DI:()=>me,C1:()=>Pe,Ay:()=>Oe});var e=n(74848),a=n(22803),C=n(96540),p=n(49785),B=n(63142),O=n(41654),N=n(66404),V=n(35137),$=n(45861),K=n(6975),M=n(37386),T=n(79233),F=n(63527),l=n(56840),m=n(2869),ae=n(5709);const Z=ae.H.injectEndpoints({endpoints:s=>({getLabels:s.query({query:()=>({url:`/api/plugins/${m.W.Labels}/resources/v1/labels/keys`}),providesTags:["GrafanaLabels"]}),getLabelValues:s.query({query:({key:c})=>({url:`/api/plugins/${m.W.Labels}/resources/v1/labels/name/${c}`}),providesTags:["GrafanaLabels"]})})});var X=n(3986),x=n(67817),b=n(39659),j=n(29609),g=n(52866),S=n(18857);const E=(0,g.c)({ignoreCase:!1});function k(s,c){return E({label:s.label??"",value:s.value??"",data:{}},c)}const U=(s,c,D)=>{const v=D.some(t=>t.label===s),f=s.trim().length;return!v&&!!f},ue=(0,C.forwardRef)(function({onChange:c,options:D,defaultValue:v,type:f,onOpenMenu:t=()=>{}},o){const d=(0,B.of)(Re);return(0,e.jsx)("div",{ref:o,children:(0,e.jsx)(M.D,{disabled:!1,"data-testid":`alertlabel-${f}-picker`,className:d.resetMargin,children:(0,e.jsx)(S.l6,{placeholder:`Choose ${f}`,width:29,className:"ds-picker select-container",backspaceRemovesValue:!1,onChange:c,onOpenMenu:t,filterOption:k,isValidNewOption:U,options:D,maxMenuHeight:500,noOptionsMessage:"No labels found",defaultValue:v,allowCustomValue:!0})})})}),Re=()=>({resetMargin:(0,a.css)({marginBottom:0})}),ge=ue;var ye=n(7840),be=n(25521),je=n(59672);function De({remove:s,index:c}){return(0,e.jsx)($.$n,{"aria-label":(0,l.t)("alerting.remove-button.aria-label-delete-label","delete label"),icon:"trash-alt","data-testid":`delete-label-${c}`,variant:"secondary",onClick:()=>{s(c)}})}function he({append:s}){return(0,e.jsx)($.$n,{icon:"plus",type:"button",variant:"secondary",onClick:s,children:(0,e.jsx)(l.x6,{i18nKey:"alerting.add-button.add-more",children:"Add more"})})}const Se=s=>{const{currentData:c,isLoading:D}=Z.endpoints.getLabels.useQuery(void 0,{skip:s});return{loading:D,labelsOpsKeys:c}};function le(s=[],c){const D=new Set(c?c.map(v=>v.key):[]);return Array.from(s,v=>({label:v,value:v,isDisabled:D.has(v)}))}const me=({labels:s})=>{const c=s.reduce((D,v)=>(v.key&&(D[v.key]=v.value),D),{});return(0,e.jsx)(ye.m,{labels:c})};function Pe({dataSourceName:s,onClose:c,initialLabels:D}){const v=(0,B.of)(ce),{watch:f}=(0,p.xW)(),t=f("type")??x.Z.grafana,o=i=>{c(i.labelsInSubform)},d=()=>{c()},y=(0,C.useMemo)(()=>({labelsInSubform:D}),[D]),u=(0,p.mN)({defaultValues:y});return(0,e.jsx)(p.Op,{...u,children:(0,e.jsx)("form",{onSubmit:u.handleSubmit(o),children:(0,e.jsxs)(O.B,{direction:"column",gap:4,children:[(0,e.jsx)(N.E,{children:fe(t)}),(0,e.jsxs)(O.B,{direction:"column",gap:1,children:[(0,e.jsx)(Ie,{dataSourceName:s}),(0,e.jsx)(V.$,{v:2}),(0,e.jsx)(me,{labels:u.watch("labelsInSubform")}),(0,e.jsx)(V.$,{v:1}),(0,e.jsxs)("div",{className:v.confirmButton,children:[(0,e.jsx)($.$n,{type:"button",variant:"secondary",onClick:d,children:(0,e.jsx)(l.x6,{i18nKey:"alerting.common.cancel",children:"Cancel"})}),(0,e.jsx)($.$n,{type:"submit",children:(0,e.jsx)(l.x6,{i18nKey:"alerting.labels-sub-form.save",children:"Save"})})]})]})]})})})}const pe=s=>!(0,b.F2)(s);function Me(s,c,D,v,f){const{labels:t,isLoading:o}=(0,je.DJ)(s),{loading:d,labelsOpsKeys:y=[]}=Se(!c||D),u=(0,C.useMemo)(()=>y.reduce((R,_)=>(R[_.name]=new Set,R),{}),[y]),i=(0,C.useMemo)(()=>le(Object.keys(u).filter(pe),v),[u,v]),r=(0,C.useMemo)(()=>le(Array.from(t.keys()).filter(pe),v),[t,v]),H=[{label:"From alerts",options:r,expanded:!0},{label:"From system",options:i,expanded:!0}],h=t.has(f),se=u[f]!==void 0&&u[f]?.size>0,te=!h&&!se,re=!h&&u[f]?.size>0,{currentData:q,isLoading:J=!1,error:z}=Z.endpoints.getLabelValues.useQuery({key:f},{skip:!c||!f||h||re||te}),w=(0,C.useMemo)(()=>{if(h)return[];const R=u[f];if(R?.size>0)return le(R);if(!J&&q?.values?.length&&!z){const W=q?.values.map(G=>G.name);return u[f]=new Set(W),le(W)}return[]},[h,u,f,J,q,z]),A=(0,C.useCallback)(R=>pe(R)?h||!c?le(t.get(R)):w:[],[t,c,w,h]);return{loading:o||d,keysFromExistingAlerts:r,groupedOptions:H,getValuesForLabel:A}}function Ie({dataSourceName:s}){const c=(0,B.of)(ce),{control:D,watch:v,formState:{errors:f}}=(0,p.xW)(),t=v("labelsInSubform"),{fields:o,remove:d,append:y}=(0,p.jz)({control:D,name:"labelsInSubform"}),u=(0,C.useCallback)(()=>{y({key:"",value:""})},[y]),{installed:i=!1,loading:r}=(0,X._)(m.W.Labels),[H,h]=(0,C.useState)(""),{loading:se,keysFromExistingAlerts:te,groupedOptions:re,getValuesForLabel:q}=Me(s,i,r,t,H),J=(0,C.useMemo)(()=>q(H),[H,q]),z=se||r;return(0,e.jsxs)(e.Fragment,{children:[z&&(0,e.jsx)(K._,{text:(0,l.t)("alerting.labels-with-suggestions.text-loading-existing-labels","Loading existing labels")}),!z&&(0,e.jsxs)(O.B,{direction:"column",gap:1,alignItems:"flex-start",children:[o.map((w,A)=>(0,e.jsxs)("div",{className:(0,a.cx)(c.flexRow,c.centerAlignRow),children:[(0,e.jsx)(M.D,{className:c.labelInput,invalid:!!f.labelsInSubform?.[A]?.key?.message,error:f.labelsInSubform?.[A]?.key?.message,"data-testid":`labelsInSubform-key-${A}`,children:(0,e.jsx)(p.xI,{name:`labelsInSubform.${A}.key`,control:D,rules:{required:t[A]?.value?"Required.":!1},render:({field:{onChange:R,ref:_,...W}})=>(0,e.jsx)(ge,{...W,defaultValue:w.key?{label:w.key,value:w.key}:void 0,options:i?re:te,onChange:G=>{R(G.value),h(G.value)},type:"key"})})}),(0,e.jsx)(T.c,{className:c.equalSign,children:"="}),(0,e.jsx)(M.D,{className:c.labelInput,invalid:!!f.labelsInSubform?.[A]?.value?.message,error:f.labelsInSubform?.[A]?.value?.message,"data-testid":`labelsInSubform-value-${A}`,children:(0,e.jsx)(p.xI,{control:D,name:`labelsInSubform.${A}.value`,rules:{required:t[A]?.value?"Required.":!1},render:({field:{onChange:R,ref:_,...W}})=>(0,e.jsx)(ge,{...W,defaultValue:w.value?{label:w.value,value:w.value}:void 0,options:J,onChange:G=>{R(G.value)},onOpenMenu:()=>{h(t[A].key)},type:"value"})})}),(0,e.jsx)(De,{index:A,remove:d})]},w.id)),(0,e.jsx)(he,{append:u})]})]})}const Te=()=>{const s=(0,B.of)(ce),{register:c,control:D,watch:v,formState:{errors:f}}=(0,p.xW)(),t=v("labels"),{fields:o,remove:d,append:y}=(0,p.jz)({control:D,name:"labels"}),u=(0,C.useCallback)(()=>{y({key:"",value:""})},[y]);return(0,e.jsxs)(e.Fragment,{children:[o.map((i,r)=>(0,e.jsx)("div",{children:(0,e.jsxs)("div",{className:(0,a.cx)(s.flexRow,s.centerAlignRow),"data-testid":"alertlabel-input-wrapper",children:[(0,e.jsx)(M.D,{className:s.labelInput,invalid:!!f.labels?.[r]?.key?.message,error:f.labels?.[r]?.key?.message,children:(0,e.jsx)(F.p,{...c(`labels.${r}.key`,{required:{value:!!t[r]?.value,message:"Required."}}),placeholder:(0,l.t)("alerting.labels-without-suggestions.placeholder-key","key"),"data-testid":`label-key-${r}`,defaultValue:i.key})}),(0,e.jsx)(T.c,{className:s.equalSign,children:"="}),(0,e.jsx)(M.D,{className:s.labelInput,invalid:!!f.labels?.[r]?.value?.message,error:f.labels?.[r]?.value?.message,children:(0,e.jsx)(F.p,{...c(`labels.${r}.value`,{required:{value:!!t[r]?.key,message:"Required."}}),placeholder:(0,l.t)("alerting.labels-without-suggestions.placeholder-value","value"),"data-testid":`label-value-${r}`,defaultValue:i.value})}),(0,e.jsx)(De,{index:r,remove:d})]})},i.id)),(0,e.jsx)(he,{append:u})]})};function Be(){const{watch:s}=(0,p.xW)(),c=s("type")??x.Z.grafana;return(0,e.jsxs)("div",{children:[(0,e.jsxs)(O.B,{direction:"column",gap:1,children:[(0,e.jsx)(N.E,{element:"h5",children:(0,e.jsx)(l.x6,{i18nKey:"alerting.labels-field.labels",children:"Labels"})}),(0,e.jsxs)(O.B,{direction:"row",gap:1,children:[(0,e.jsx)(N.E,{variant:"bodySmall",color:"secondary",children:fe(c)}),(0,e.jsx)(be.G,{externalLink:"https://grafana.com/docs/grafana/latest/alerting/fundamentals/alert-rules/annotation-label/",linkText:"Read about labels",contentText:`The dropdown only displays labels that you have previously used for alerts.
            Select a label from the options below or type in a new one.`,title:(0,l.t)("alerting.labels-field.title-labels","Labels")})]})]}),(0,e.jsx)(Te,{})]})}function fe(s){return(s?(0,j.vE)(s):!1)?(0,l.t)("alerting.alertform.labels.recording","Add labels to your rule."):(0,l.t)("alerting.alertform.labels.alerting","Add labels to your rule for searching, silencing, or routing to a notification policy.")}const ce=s=>({flexColumn:(0,a.css)({display:"flex",flexDirection:"column"}),flexRow:(0,a.css)({display:"flex",flexDirection:"row",justifyContent:"flex-start"}),centerAlignRow:(0,a.css)({alignItems:"center",gap:s.spacing(.5)}),equalSign:(0,a.css)({alignSelf:"flex-start",width:"28px",justifyContent:"center",margin:0}),labelInput:(0,a.css)({width:"175px",margin:0}),confirmButton:(0,a.css)({display:"flex",flexDirection:"row",gap:s.spacing(1),marginLeft:"auto"})}),Oe=Be},59672:(ve,ee,n)=>{n.d(ee,{$i:()=>F,DJ:()=>T,h$:()=>l});var e=n(10378),a=n(96540),C=n(70327),p=n(55143),B=n(74869);const{usePrometheusRuleNamespacesQuery:O,useLazyRulerRulesQuery:N,useRulerRulesQuery:V}=C.hK,{useDiscoverDsFeaturesQuery:$}=p.L,K=(0,B.wS)(),M={};function T(x){const{data:b,isLoading:j}=$({rulesSourceName:x}),[g,{data:S=M,isLoading:E}]=N(),{data:k=[],isLoading:U}=O({ruleSourceName:x},{skip:!K});return(0,a.useEffect)(()=>{b?.rulerConfig&&!K&&g({rulerConfig:b.rulerConfig})},[b?.rulerConfig,g]),{labels:(0,a.useMemo)(()=>U||E?new Map:K?Z(k):X(S),[k,S,U,E]),isLoading:U||E||j}}function F(x){const{data:b,isLoading:j}=$(x?{rulesSourceName:x}:e.hT,{skip:!x}),[g,{data:S=M,isLoading:E}]=N(),{data:k=[],isLoading:U}=O(x&&K?{ruleSourceName:x}:e.hT);return(0,a.useEffect)(()=>{b?.rulerConfig&&!K&&g({rulerConfig:b.rulerConfig})},[b?.rulerConfig,g]),{namespaceGroups:(0,a.useMemo)(()=>U||E?new Map:K?m(k):ae(S),[k,S,U,E]),isLoading:U||E||j,promNamespaces:k}}function l(x){const{data:b,isLoading:j}=$(x?{rulesSourceName:x}:e.hT),{data:g=M,isLoading:S}=V(b?.rulerConfig?{rulerConfig:b.rulerConfig}:e.hT);return{isLoading:S||j,rulerRules:g}}function m(x){const b=new Map;return x.forEach(j=>{b.set(j.name,j.groups.map(g=>g.name))}),b}function ae(x){const b=new Map;return Object.entries(x).forEach(([j,g])=>{b.set(j,g.map(S=>S.name))}),b}function Z(x){return x.flatMap(j=>j.groups).flatMap(j=>j.rules).reduce((j,g)=>(g.labels&&Object.entries(g.labels).forEach(([S,E])=>{if(!S||!E)return;const k=j.get(S);k?k.add(E):j.set(S,new Set([E]))}),j),new Map)}function X(x){const b=new Map;return Object.entries(x).flatMap(([g,S])=>S).flatMap(g=>g.rules).reduce((g,S)=>(S.labels&&Object.entries(S.labels).forEach(([E,k])=>{if(!E||!k)return;const U=g.get(E);U?U.add(k):g.set(E,new Set([k]))}),g),b)}}}]);

//# sourceMappingURL=9668.62d94b422bbd0640bf07.js.map