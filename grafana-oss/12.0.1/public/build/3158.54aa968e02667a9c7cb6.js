"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[3158],{58843:(_t,We,i)=>{i.d(We,{L5:()=>c,hr:()=>V,jN:()=>P});var t=i(79609),u=i(56840);function c(re){}function V(re){switch(re){case t.CC.Logfmt:return{label:(0,u.t)("correlations.trans-details.logfmt-label","Logfmt"),value:t.CC.Logfmt,description:(0,u.t)("correlations.trans-details.logfmt-description","Parse provided field with logfmt to get variables"),expressionDetails:{show:!1},mapValueDetails:{show:!1}};case t.CC.Regex:return{label:(0,u.t)("correlations.trans-details.regex-label","Regular expression"),value:t.CC.Regex,description:(0,u.t)("correlations.trans-details.regex-description","Field will be parsed with regex. Use named capture groups to return multiple variables, or a single unnamed capture group to add variable to named map value. Regex is case insensitive."),expressionDetails:{show:!0,required:!0,helpText:(0,u.t)("correlations.trans-details.regex-expression","Use capture groups to extract a portion of the field.")},mapValueDetails:{show:!0,required:!1,helpText:(0,u.t)("correlations.trans-details.regex-map-values","Defines the name of the variable if the capture group is not named.")}};default:return{label:re,value:re,expressionDetails:{show:!1},mapValueDetails:{show:!1}}}}const P=()=>Object.values(t.CC).map(re=>{const Oe=V(re);return{label:Oe.label,value:Oe.value,description:Oe.description}})},53158:(_t,We,i)=>{i.r(We),i.d(We,{default:()=>jl});var t=i(74848),u=i(22803),c=i(96540),V=i(43173),P=i(63142),re=i(36303),Oe=i(77808),et=i(27963),ht=i(45776),d=i(56840),D=i(96673),tt=i(2739),es=function(e,s){e===void 0&&(e=!0);var o=(0,c.useCallback)(function(n){var r=typeof e=="function"?e():!0;if(r)return n.preventDefault(),s&&(n.returnValue=s),s},[e,s]);(0,c.useEffect)(function(){if(e)return(0,tt.on)(window,"beforeunload",o),function(){return(0,tt.AU)(window,"beforeunload",o)}},[e,o])};const Ft=es;var ft=i(64305),mt=i(6773),k=i(27489),A=i(41654),J=i(45967),K=i(30703),B=i(45861),Ne=i(83560),Pe=i(22787);const xt=({onSave:e,onDiscard:s,onCancel:o,message:n})=>(0,t.jsxs)(Pe.a,{isOpen:!0,title:"Unsaved changes to correlation",onDismiss:o,icon:"exclamation-triangle",className:(0,u.css)({width:"600px"}),children:[(0,t.jsx)("h5",{children:n}),(0,t.jsxs)(Pe.a.ButtonRow,{children:[(0,t.jsx)(B.$n,{variant:"secondary",onClick:o,fill:"outline",children:(0,t.jsx)(d.x6,{i18nKey:"explore.correlation-unsaved-changes-modal.cancel",children:"Cancel"})}),(0,t.jsx)(B.$n,{variant:"destructive",onClick:s,children:(0,t.jsx)(d.x6,{i18nKey:"explore.correlation-unsaved-changes-modal.continue-without-saving",children:"Continue without saving"})}),(0,t.jsx)(B.$n,{variant:"primary",onClick:e,children:(0,t.jsx)(d.x6,{i18nKey:"explore.correlation-unsaved-changes-modal.save-correlation",children:"Save correlation"})})]})]});var ne=i(2543),Se=(e=>(e.SOURCE_TARGET_CHANGE="cause the query in the right pane to be re-ran and links added to that data",e.FULL_QUERY_LOSS="lose the changed query",e.FULL_CORR_LOSS="cause the correlation in progress to be lost",e.INVALID_VAR="remove the variables, and your changed query may no longer be valid",e))(Se||{});const un=(e,s,o,n)=>{const r=(0,ne.template)("<%= actionStr %> will <%= consequenceStr %>. Would you like to save before continuing?");let a="",l="";if(e===D.CORRELATION_EDITOR_POST_CONFIRM_ACTION.CLOSE_PANE)if(a="Closing the pane",s)if(o)l="cause the correlation in progress to be lost";else if(n)l="cause the query in the right pane to be re-ran and links added to that data";else return;else if(o)l="cause the correlation in progress to be lost";else if(n)l="lose the changed query";else return;else if(e===D.CORRELATION_EDITOR_POST_CONFIRM_ACTION.CHANGE_DATASOURCE)if(a="Changing the datasource",s)if(o)l="cause the correlation in progress to be lost";else return;else if(n)l="lose the changed query";else return;else if(e===D.CORRELATION_EDITOR_POST_CONFIRM_ACTION.CLOSE_EDITOR)if(a="Closing the editor",o)l="cause the correlation in progress to be lost";else if(n)l="remove the variables, and your changed query may no longer be valid";else return;return r({actionStr:a,consequenceStr:l})};var pn=i(80763),ke=i(707),Me=i(51845),X=i(35231),Z=i(19050),_=i(20718);const gn=({panes:e})=>{const s=(0,D.useDispatch)(),o=(0,P.of)(hn),n=(0,D.useSelector)(_.vC),r=(0,D.useSelector)(_.st),[a,l]=(0,c.useState)(void 0);Ft(n?.correlationDirty||!1,"Save correlation?"),Ft(!n?.correlationDirty&&n?.queryEditorDirty||!1,"The query editor was changed. Save correlation before continuing?"),(0,c.useEffect)(()=>{if(n?.isExiting){const{correlationDirty:h,queryEditorDirty:m}=n;let y,T;n.postConfirmAction?(y=n.postConfirmAction.isActionLeft,T=n.postConfirmAction.action):(T=D.CORRELATION_EDITOR_POST_CONFIRM_ACTION.CLOSE_EDITOR,y=!1);const b=un(T,y,h,m);if(b!==void 0)l(b);else if(T===D.CORRELATION_EDITOR_POST_CONFIRM_ACTION.CHANGE_DATASOURCE&&n.postConfirmAction){const{exploreId:C,changeDatasourceUid:S}=n?.postConfirmAction;C&&S&&(s((0,ke.wh)({exploreId:C,datasource:S,options:{importQueries:!0}})),s((0,X.am)({isExiting:!1})))}else if(T===D.CORRELATION_EDITOR_POST_CONFIRM_ACTION.CLOSE_PANE&&n.postConfirmAction){const{exploreId:C}=n?.postConfirmAction;C!==void 0&&(s((0,X.J8)(C)),s((0,X.am)({isExiting:!1})))}else T===D.CORRELATION_EDITOR_POST_CONFIRM_ACTION.CLOSE_EDITOR&&s((0,X.am)({editorMode:!1}))}},[n,s,r]),(0,ft.A)(()=>{s((0,X.am)({editorMode:!1,isExiting:!1,correlationDirty:!1,label:void 0,description:void 0,canSave:!1})),e.forEach(h=>{s((0,Me.nE)({exploreId:h[0],correlationEditorHelperData:void 0})),s((0,Z.Od)({exploreId:h[0]}))})});const p=()=>{s((0,X.am)({editorMode:!0,isExiting:!1,correlationDirty:!1,label:void 0,description:void 0,canSave:!1})),e.forEach(h=>{s((0,Me.nE)({exploreId:h[0],correlationEditorHelperData:void 0})),s((0,Z.Od)({exploreId:h[0]}))})},f=h=>{l(void 0),s((0,X.J8)(h)),(0,k.rR)("grafana_explore_split_view_closed")},x=(h,m)=>{l(void 0),s((0,ke.wh)({exploreId:h,datasource:m,options:{importQueries:!0}}))},g=h=>{if(s((0,pn.v)(n?.label,n?.description,n?.transformations)),!h&&n?.postConfirmAction!==void 0){const{exploreId:m,action:y,changeDatasourceUid:T}=n?.postConfirmAction;y===D.CORRELATION_EDITOR_POST_CONFIRM_ACTION.CLOSE_PANE?(f(m),p()):y===D.CORRELATION_EDITOR_POST_CONFIRM_ACTION.CHANGE_DATASOURCE&&T!==void 0&&((0,ke.wh)({exploreId:m,datasource:T}),p())}else s((0,X.am)({editorMode:!1,correlationDirty:!1,isExiting:!1}))};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(Ne.X,{message:h=>h.pathname!=="/explore"&&n?.editorMode&&n?.correlationDirty?"You have unsaved correlation data. Continue?":!0}),a!==void 0&&(0,t.jsx)(xt,{onDiscard:()=>{if(n?.postConfirmAction!==void 0){const{exploreId:h,action:m,changeDatasourceUid:y}=n?.postConfirmAction;m===D.CORRELATION_EDITOR_POST_CONFIRM_ACTION.CLOSE_PANE?f(h):m===D.CORRELATION_EDITOR_POST_CONFIRM_ACTION.CHANGE_DATASOURCE&&y!==void 0&&x(h,y),s((0,X.am)({isExiting:!1}))}else s((0,X.am)({editorMode:!1,correlationDirty:!1,isExiting:!1}))},onCancel:()=>{s((0,X.am)({isExiting:!1})),l(void 0)},onSave:()=>{g(!1)},message:a}),(0,t.jsx)("div",{className:o.correlationEditorTop,children:(0,t.jsxs)(A.B,{gap:2,justifyContent:"flex-end",alignItems:"center",children:[(0,t.jsx)(J.m,{content:"Correlations editor in Explore is an experimental feature.",children:(0,t.jsx)(K.I,{className:o.iconColor,name:"info-circle",size:"xl"})}),(0,t.jsx)(B.$n,{variant:"secondary",disabled:!n?.canSave,fill:"outline",className:n?.canSave?o.buttonColor:o.disabledButtonColor,onClick:()=>{g(!0)},children:(0,t.jsx)(d.x6,{i18nKey:"explore.correlation-editor-mode-bar.save",children:"Save"})}),(0,t.jsx)(B.$n,{variant:"secondary",fill:"outline",className:o.buttonColor,icon:"times",onClick:()=>{s((0,X.am)({isExiting:!0})),(0,k.rR)("grafana_explore_correlation_editor_exit_pressed")},children:(0,t.jsx)(d.x6,{i18nKey:"explore.correlation-editor-mode-bar.exit-correlation-editor",children:"Exit correlation editor"})})]})})]})},hn=e=>{const s=e.colors.getContrastText(e.colors.primary.main),o=mt.MV.lighten(e.colors.primary.main,.1),n=mt.MV.darken(e.colors.primary.main,.2),r=mt.MV.darken(s,.2);return{correlationEditorTop:(0,u.css)({backgroundColor:e.colors.primary.main,marginTop:"3px",padding:e.spacing(1)}),iconColor:(0,u.css)({color:s}),buttonColor:(0,u.css)({color:s,borderColor:s,"&:hover":{color:s,borderColor:s,backgroundColor:o}}),disabledButtonColor:(0,u.css)({color:`${r} !important`,backgroundColor:`${n} !important`})}};var ts=i(1503),Dt=i(15130),st=i(18615);const fn=()=>{const[e,s]=(0,c.useState)([]),{query:o}=(0,ts.useKBar)(),n=(0,D.useDispatch)(),r=(0,D.useSelector)(_.Qb),a=(0,D.useSelector)(_.pF),l=Dt.TP.hasPermission(D.AccessControlAction.DataSourcesWrite);return(0,c.useEffect)(()=>{const p=Object.keys(r),f={name:"Explore",priority:ts.Priority.HIGH+1},x=[];if(a)x.push({id:"explore/run-query-left",name:"Run query (left)",keywords:"query left",perform:()=>{n((0,Z.Od)({exploreId:p[0]}))},section:f}),r[1]&&(x.push({id:"explore/run-query-right",name:"Run query (right)",keywords:"query right",perform:()=>{n((0,Z.Od)({exploreId:p[1]}))},section:f}),x.push({id:"explore/split-view-close-left",name:"Close split view left",keywords:"split",perform:()=>{n((0,X.J8)(p[0]))},section:f}),x.push({id:"explore/split-view-close-right",name:"Close split view right",keywords:"split",perform:()=>{n((0,X.J8)(p[1]))},section:f}));else{const g=Object.values(r).some(h=>h?.datasourceInstance?.uid===st.uv);V.$.featureToggles.correlations&&l&&!g&&x.push({id:"explore/correlations-editor",name:"Correlations editor",perform:()=>{n((0,X.am)({editorMode:!0})),n((0,Z.Od)({exploreId:p[0]}))},section:f}),x.push({id:"explore/run-query",name:"Run query",keywords:"query",perform:()=>{n((0,Z.Od)({exploreId:p[0]}))},section:f}),x.push({id:"explore/split-view-open",name:"Open split view",keywords:"split",perform:()=>{n((0,X.ve)())},section:f})}s(x)},[r,a,o,n,l]),(0,ts.useRegisterActions)(o?e:[],[e,o]),null};var zs=i(33149),mn=i(45897);function Qs(e){const{children:s,onResize:o,initialHeight:n}=e,r=(0,P.$j)(),a=(0,P.of)(yn),l=(0,mn.l)(r),p=n||`${r.components.horizontalDrawer.defaultHeight}px`;return(0,t.jsx)(zs.c,{className:(0,u.cx)(a.fixed,a.container,a.drawerActive),defaultSize:{width:"100%",height:p},handleClasses:{top:l.dragHandleHorizontal},enable:{top:!0,right:!1,bottom:!1,left:!1,topRight:!1,bottomRight:!1,bottomLeft:!1,topLeft:!1},maxHeight:"100vh",onResize:o,children:s})}const xn=e=>(0,u.keyframes)`
  0% {
    transform: translateY(${e.components.horizontalDrawer.defaultHeight}px);
  }

  100% {
    transform: translateY(0px);
  }
`,yn=e=>({fixed:(0,u.css)({position:"absolute !important"}),container:(0,u.css)({bottom:0,background:e.colors.background.primary,borderTop:`1px solid ${e.colors.border.weak}`,boxShadow:e.shadows.z3,zIndex:e.zIndex.navbarFixed}),drawerActive:(0,u.css)({opacity:1,[e.transitions.handleMotion("no-preference")]:{animation:`0.5s ease-out ${xn(e)}`}})});var Le=i(71468),ss=i(19379),Us=i(60188),Ge=i(85629),yt=i(62635),vn=i(70713),ot=i(78012),ie=i(67770),be=i(28105),Ks=i(39796),qe=i(78282),os=i(92807),ns=i(3023),Gs=i(36100),vt=i(53222),At=i(34984),qs=i(42941),bn=i(23535),Cn=function(e){var s=(0,bn.A)({x:0,y:0}),o=s[0],n=s[1];return(0,c.useEffect)(function(){var r=function(){e.current&&n({x:e.current.scrollLeft,y:e.current.scrollTop})};return e.current&&(0,tt.on)(e.current,"scroll",r,{capture:!1,passive:!0}),function(){e.current&&(0,tt.AU)(e.current,"scroll",r)}},[e]),o};const Sn=Cn,Zs=(0,c.createContext)(void 0);function jn({children:e,refreshDependencies:s}){const[o,n]=(0,c.useState)([]),r=(0,c.useRef)({}),a=(0,c.useCallback)(g=>{const h=g.id?g.id:(0,ne.uniqueId)(`${g.panelId}-${g.title}-${g.icon}_`);return n(m=>{if(g.level==="root"){const y=r.current[g.panelId]||[];return y.length>0&&r.current[g.panelId].forEach(b=>{b.type==="filter"&&(b.ref=g.ref)}),r.current[g.panelId]=[],[...m,{...g,id:h,children:y}].sort(Ys)}if(g.level==="child"){let y=!1;if(Object.keys(r.current).forEach(v=>{if(r.current[v].find(j=>j.title===g.title&&g.type==="filter"&&g.panelId===j.panelId)){y=!0;return}}),y)return[...m];const T=m.findIndex(v=>v.panelId===g.panelId&&v.level==="root");if(T===-1)return Object.keys(r.current).find(L=>L===g.panelId)?r.current[g.panelId].push({...g,id:h}):r.current[g.panelId]=[{...g,id:h}],[...m];const b=[...m],C={...b[T]},S=C.children?.find(v=>v.title===g.title&&g.type==="filter"&&g.panelId===v.panelId);if(S&&S.highlight!==g.highlight)return C.children?.map(v=>{v.title===S?.title&&(v.highlight=g.highlight)}),[...m];if(S)return[...m];let E=g.ref;g.type==="filter"&&(E=C.ref);let w=[{...g,id:h,ref:E},...C.children||[]];return g.childOnTop||(w=Js(w)),b[T]={...C,children:w},b}return[...m]}),h},[]),l=(0,c.useCallback)(g=>{n(h=>h.filter(m=>m.id!==g).map(m=>(m.children&&(m.children=m.children.filter(y=>y.id!==g)),m)))},[]),p=(0,c.useCallback)(g=>{n(g)},[]),f=(0,c.useCallback)((g,h)=>{n(m=>m.map(y=>y.id===g?{...y,...h}:y))},[]),x=(0,c.useCallback)((g,h)=>{n(m=>{const y=g(m);return y?m.map(T=>(T.id===y&&(T.children=T.children?.filter(b=>b.type!==h)),T)):m})},[]);return(0,c.useEffect)(()=>{n(g=>{const h=[...g];for(const m of h){const y=Js(m.children||[]);m.children=y}return h})},[s]),(0,t.jsx)(Zs.Provider,{value:{outlineItems:o,register:a,unregister:l,updateOutlineItems:p,unregisterAllChildren:x,updateItem:f},children:e})}function Ys(e,s){if(e.ref&&s.ref){const o=e.ref.compareDocumentPosition(s.ref);if(o===Node.DOCUMENT_POSITION_PRECEDING)return 1;if(o===Node.DOCUMENT_POSITION_FOLLOWING)return-1}return 0}function Js(e){const[s,o]=e.reduce((n,r)=>(r.childOnTop?n[0].push(r):n[1].push(r),n),[[],[]]);return o.sort(Ys),[...s,...o]}function rs(){return(0,c.useContext)(Zs)}var Tn=i(30360);function as({contentOutlineExpanded:e,title:s,icon:o,tooltip:n,tooltipPlacement:r="bottom",className:a,indentStyle:l,collapsible:p,collapsed:f,isActive:x,extraHighlight:g,sectionId:h,toggleCollapsed:m,color:y,onRemove:T,...b}){const C=(0,P.$j)(),S=Rn(C,y),E=(0,u.cx)(S.button,a),w=(0,c.useRef)(null),[v,L]=(0,c.useState)(!1);(0,c.useEffect)(()=>{w.current&&L(w.current?.scrollWidth>w.current?.clientWidth)},[s]);const j=(0,t.jsxs)("div",{className:(0,u.cx)(S.buttonContainer,l),children:[p&&(0,t.jsx)("button",{className:S.collapseButton,onClick:m,"aria-label":(0,d.t)("explore.content-outline-item-button.body.aria-label-content-outline-item-collapse-button","Content outline item collapse button"),"aria-expanded":!f,"aria-controls":h,children:(0,t.jsx)(Xs,{icon:f?"angle-right":"angle-down"})}),(0,t.jsxs)("button",{className:(0,u.cx)(E,{[S.active]:x,[S.extraHighlight]:g}),"aria-label":n,...b,children:[(0,t.jsx)(Xs,{icon:o}),s&&(0,t.jsx)("span",{className:S.textContainer,ref:w,children:s})]}),T&&(0,t.jsx)(B.$n,{variant:"destructive",className:S.deleteButton,icon:"times",onClick:()=>T(),"data-testid":"content-outline-item-delete-button"})]});return n&&(!e||v)?(0,t.jsx)(J.m,{content:n,placement:r,children:j}):j}function Xs({icon:e}){return e?(0,Tn.n6)(e)?(0,t.jsx)(K.I,{name:e,size:"lg",title:e}):e:null}const Rn=(e,s)=>({buttonContainer:(0,u.css)({position:"relative",display:"flex",alignItems:"center",flexGrow:1,gap:e.spacing(.25),width:"100%",overflow:"hidden"}),button:(0,u.css)({label:"content-outline-item-button",display:"flex",alignItems:"center",height:e.spacing(e.components.height.md),gap:e.spacing(.5),color:e.colors.text.secondary,width:"100%",background:"transparent",overflow:"hidden",border:"none"}),collapseButton:(0,u.css)({display:"flex",alignItems:"center",justifyContent:"center",width:e.spacing(3),height:e.spacing(4),borderRadius:e.shape.radius.default,color:e.colors.text.secondary,background:"transparent",border:"none",overflow:"hidden","&:hover":{color:e.colors.text.primary,background:e.colors.secondary.shade}}),textContainer:(0,u.css)({whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis",fontSize:e.typography.bodySmall.fontSize,marginLeft:e.spacing(.5)}),active:(0,u.css)({backgroundColor:e.colors.background.secondary,borderTopRightRadius:e.shape.radius.default,borderBottomRightRadius:e.shape.radius.default,position:"relative",height:e.spacing(e.components.height.md),"&::before":{backgroundImage:s!==void 0?"none":e.colors.gradients.brandVertical,backgroundColor:s!==void 0?s:"none",borderRadius:e.shape.radius.default,content:'" "',display:"block",height:"100%",position:"absolute",transform:"translateX(-50%)",width:e.spacing(.5),left:"2px"}}),extraHighlight:(0,u.css)({backgroundColor:e.colors.background.secondary,borderTopRightRadius:e.shape.radius.default,borderBottomRightRadius:e.shape.radius.default,position:"relative","&::before":{backgroundImage:s!==void 0?"none":e.colors.gradients.brandVertical,backgroundColor:s!==void 0?s:"none",borderRadius:e.shape.radius.default,content:'" "',display:"block",height:"100%",position:"absolute",transform:"translateX(-50%)",width:e.spacing(.5),left:"2px"}}),deleteButton:(0,u.css)({width:e.spacing(1),height:e.spacing(1),padding:e.spacing(.75,.75),marginRight:e.spacing(.5)})});function _s(e){return e.children?.filter(s=>s.type!=="filter")||[]}function eo(e,s,o,n){const r=s===e.id,a=o===e.id,l=!n[e.id],p=_s(e).length>0,f=kt(e,o)&&!n[e.id];return p?l&&(r||f):r||a}const Nt={visible:"grafana.explore.contentOutline.visible",expanded:"grafana.explore.contentOutline.expanded"};function Ln({scroller:e,panelId:s}){const[o,n]=(0,qs.A)(ot.M.getBool(Nt.expanded,!0)),r=(0,P.of)(wn,o),a=(0,c.useRef)(e||null),{y:l}=Sn(a),{outlineItems:p}=rs()??{outlineItems:[]},[f,x]=(0,c.useState)(p[0]?.id),[g,h]=(0,c.useState)(p[0]?.children?.[0]?.id),m=p.some(v=>v.children&&!(v.mergeSingleChild&&v.children?.length===1)&&v.children.length>0),y=p.some(v=>v.children?.some(L=>L.onRemove)),[T,b]=(0,c.useState)(()=>p.reduce((v,L)=>(v[L.id]=!!L.expanded,v),{})),C=(v,L=0)=>{let j=0,F=v;if(F){do j+=F?.offsetTop||0,F=F?.offsetParent instanceof HTMLElement?F.offsetParent:void 0;while(F&&F!==e);e?.scroll({top:j+L,behavior:"smooth"})}},S=v=>{if(v.level==="child"&&v.type==="filter"){const L=p.find(j=>j.children?.find(F=>F.id===v.id));L&&C(L.ref,L.customTopOffset)}else C(v.ref,v.customTopOffset),(0,k.rR)("explore_toolbar_contentoutline_clicked",{item:"select_section",type:v.panelId})},E=()=>{ot.M.set(Nt.expanded,!o),n(),(0,k.rR)("explore_toolbar_contentoutline_clicked",{item:"outline",type:o?"minimize":"expand"})},w=v=>{b(L=>({...L,[v]:!L[v]})),(0,k.rR)("explore_toolbar_contentoutline_clicked",{item:"section",type:T[v]?"expand":"minimize"})};return(0,c.useEffect)(()=>{let v;for(const L of p){let j=L?.ref?.getBoundingClientRect().top;j&&j>=0&&(v=L);const F=_s(L).find($=>{const z=$.customTopOffset||0;let U=$?.ref?.getBoundingClientRect().top;return U&&U>=z});if(F&&Pt(L)){h(F.id),x(L.id);break}if(v){x(v.id),h(void 0);break}}},[p,l]),(0,t.jsx)(ns._,{className:r.wrapper,id:s,children:(0,t.jsx)(os.P,{children:(0,t.jsxs)("div",{className:r.content,children:[(0,t.jsx)(as,{icon:"arrow-from-right",tooltip:o?"Collapse outline":"Expand outline",tooltipPlacement:o?"right":"bottom",onClick:E,className:(0,u.cx)(r.toggleContentOutlineButton,{[r.justifyCenter]:!o&&!m}),"aria-expanded":o}),p.map(v=>(0,t.jsxs)(c.Fragment,{children:[(0,t.jsx)(as,{title:o?v.title:void 0,contentOutlineExpanded:o,className:(0,u.cx)(r.buttonStyles,{[r.justifyCenter]:!o&&!y,[r.sectionHighlighter]:kt(v,g)&&!o}),indentStyle:(0,u.cx)({[r.indentRoot]:!Pt(v)&&m,[r.sectionHighlighter]:kt(v,g)&&!o&&T[v.id]}),icon:v.icon,onClick:()=>S(v),tooltip:v.title,collapsible:Pt(v),collapsed:!T[v.id],toggleCollapsed:()=>w(v.id),isActive:eo(v,f,g,T),sectionId:v.id,color:v.color},v.id),(0,t.jsx)("div",{id:v.id,"data-testid":`section-wrapper-${v.id}`,children:v.children&&Pt(v)&&T[v.id]&&v.children.map((L,j)=>(0,t.jsxs)("div",{className:r.itemWrapper,children:[o&&(0,t.jsx)("div",{className:(0,u.cx)(r.itemConnector,{[r.firstItemConnector]:j===0,[r.lastItemConnector]:j===(v.children?.length||0)-1})}),(0,t.jsx)(as,{title:o?L.title:void 0,contentOutlineExpanded:o,icon:o?void 0:v.icon,className:(0,u.cx)(r.buttonStyles,{[r.justifyCenter]:!o&&!y,[r.sectionHighlighter]:kt(v,g)&&!o}),indentStyle:r.indentChild,onClick:F=>{S(L),L.onClick?.(F)},tooltip:L.title,isActive:eo(L,f,g,T),extraHighlight:L.highlight,color:L.color,onRemove:L.onRemove?()=>L.onRemove?.(L.id):void 0},L.id)]},L.id))})]},v.id))]})})})}const wn=(e,s)=>({wrapper:(0,u.css)({label:"wrapper",position:"relative",display:"flex",justifyContent:"center",marginRight:e.spacing(1),height:"100%",backgroundColor:e.colors.background.primary,width:s?"160px":void 0,minWidth:s?"160px":void 0}),content:(0,u.css)({label:"content",marginLeft:e.spacing(.5),top:0}),buttonStyles:(0,u.css)({display:"flex","&:hover":{color:e.colors.text.primary,textDecoration:"underline"}}),toggleContentOutlineButton:(0,u.css)({"&:hover":{color:e.colors.text.primary},transform:s?"rotate(180deg)":"",marginRight:s?e.spacing(.5):void 0}),indentRoot:(0,u.css)({paddingLeft:e.spacing(3)}),indentChild:(0,u.css)({paddingLeft:s?e.spacing(5):e.spacing(2.75)}),itemWrapper:(0,u.css)({display:"flex",height:e.spacing(4),alignItems:"center"}),itemConnector:(0,u.css)({position:"relative",height:"100%",width:e.spacing(1.5),"&::before":{borderRight:`1px solid ${e.colors.border.medium}`,content:'""',height:"100%",left:e.spacing(4.75),position:"absolute",transform:"translateX(50%)"}}),firstItemConnector:(0,u.css)({"&::before":{top:e.spacing(1),height:`calc(100% - ${e.spacing(1)})`}}),lastItemConnector:(0,u.css)({"&::before":{height:`calc(100% - ${e.spacing(1)})`}}),justifyCenter:(0,u.css)({justifyContent:"center"}),sectionHighlighter:(0,u.css)({backgroundColor:e.colors.background.secondary})});function Pt(e){return!!(e.children&&e.children.length>0&&(!e.mergeSingleChild||e.children.length!==1))}function kt(e,s){return e.children?.some(o=>o.id===s)}function we({panelId:e,title:s,icon:o,customTopOffset:n,children:r,className:a,level:l="root",mergeSingleChild:p,type:f="scrollIntoView",onClick:x}){const{register:g,unregister:h}=rs()??{},m=(0,c.useRef)(null);return(0,c.useEffect)(()=>{if(!g||!h)return;const y=g({panelId:e,title:s,icon:o,ref:m.current,customTopOffset:n,level:l,mergeSingleChild:p,type:f});return()=>h(y)},[e,s,o,n,l,p,g,h,f,x]),(0,t.jsx)("div",{className:a,ref:m,children:r})}var Mt=i(49785),is=i(16817),nt=i(34999),Bt=i(89599),Be=i(37386),bt=i(63527),Ht=i(8073),rt=i(76319),In=i(44458),ls=i(70191),En=i(6219),On=i(23257),Fn=i.n(On),Dn=i(72636),Ve=i(18857),cs=i(58843);const to=({label:e,tooltipText:s})=>(0,t.jsxs)(A.B,{gap:1,direction:"row",wrap:"wrap",alignItems:"flex-start",children:[(0,t.jsx)(Dn.J,{children:e}),(0,t.jsx)(J.m,{content:s,children:(0,t.jsx)(K.I,{name:"info-circle",size:"sm"})})]}),An=({onSave:e,onCancel:s,fieldList:o,transformationToEdit:n})=>{const[r,a]=(0,c.useState)(void 0),[l,p]=(0,c.useState)({}),[f,x]=(0,c.useState)({mapValueDetails:{show:!1},expressionDetails:{show:!1}}),[g,h]=(0,c.useState)(!1),[m,y]=(0,c.useState)(!1),{getValues:T,control:b,register:C,watch:S}=(0,Mt.mN)({defaultValues:(0,c.useMemo)(()=>{if(n){const w=o[n?.field];a(w),n?.expression&&h(!0);const v=(0,cs.hr)(n?.type);x({mapValueDetails:v.mapValueDetails,expressionDetails:v.expressionDetails});const L=(0,ls.k)({type:n?.type,expression:n?.expression,mapValue:n?.mapValue},w||"",n?.field);return p({...L}),y(!0),{type:n?.type,field:n?.field,mapValue:n?.mapValue,expression:n?.expression}}else return},[o,n])}),E=(0,c.useId)();return(0,c.useEffect)(()=>{const w=S(v=>{const L=v.expression;let j=!1;if(L!==void 0){j=!0;try{new RegExp(L)}catch{j=!1}}else j=!f.expressionDetails.show;h(j);let F=[];if(v.type){const $=(0,ls.k)({type:v.type,expression:j?L:"",mapValue:v.mapValue},o[v.field]||"",v.field);F=Object.keys($),p(F.length>0?{...$}:{})}F.length===0||!j?y(!1):y(!0)});return()=>w.unsubscribe()},[o,f.expressionDetails.show,S]),(0,t.jsxs)(Pe.a,{isOpen:!0,title:`${n?"Edit":"Add"} transformation`,onDismiss:s,className:(0,u.css)({width:"700px"}),children:[(0,t.jsx)("p",{children:"A transformation extracts variables out of a single field. These variables will be available along with your field variables."}),(0,t.jsx)(Be.D,{label:(0,d.t)("explore.correlation-transformation-add-modal.label-field","Field"),children:(0,t.jsx)(Mt.xI,{control:b,render:({field:{onChange:w,ref:v,...L}})=>(0,t.jsx)(Ve.l6,{...L,onChange:j=>{j.value&&(w(j.value),a(o[j.value]))},options:Object.entries(o).map(j=>({label:j[0],value:j[0]})),"aria-label":(0,d.t)("explore.correlation-transformation-add-modal.aria-label-field","Field")}),name:"field"})}),r&&(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)("pre",{children:(0,t.jsx)(Fn(),{textToHighlight:r,searchWords:[g?T("expression")??"":""],autoEscape:!1})}),(0,t.jsx)(Be.D,{label:(0,d.t)("explore.correlation-transformation-add-modal.label-type","Type"),children:(0,t.jsx)(Mt.xI,{control:b,render:({field:{onChange:w,ref:v,...L}})=>(0,t.jsx)(Ve.l6,{...L,onChange:j=>{w(j.value);const F=(0,cs.hr)(j.value);x({mapValueDetails:F.mapValueDetails,expressionDetails:F.expressionDetails})},options:(0,cs.jN)(),"aria-label":(0,d.t)("explore.correlation-transformation-add-modal.aria-label-type","Type")}),name:"type"})}),f.expressionDetails.show&&(0,t.jsx)(Be.D,{label:f.expressionDetails.helpText?(0,t.jsx)(to,{label:(0,d.t)("explore.correlation-transformation-add-modal.label-expression","Expression"),tooltipText:f.expressionDetails.helpText}):"Expression",htmlFor:`${E}-expression`,required:f.expressionDetails.required,children:(0,t.jsx)(bt.p,{...C("expression"),id:`${E}-expression`})}),f.mapValueDetails.show&&(0,t.jsx)(Be.D,{label:f.mapValueDetails.helpText?(0,t.jsx)(to,{label:(0,d.t)("explore.correlation-transformation-add-modal.label-variable-name","Variable name"),tooltipText:f.mapValueDetails.helpText}):"Variable name",htmlFor:`${E}-mapValue`,children:(0,t.jsx)(bt.p,{...C("mapValue"),id:`${E}-mapValue`})}),Object.entries(l).length>0&&(0,t.jsxs)(t.Fragment,{children:["This transformation will add the following variables:",(0,t.jsx)("pre",{children:Object.entries(l).map(w=>`\${${w[0]}} = ${w[1]?.value}
`)})]})]}),(0,t.jsxs)(Pe.a.ButtonRow,{children:[(0,t.jsx)(B.$n,{variant:"secondary",onClick:s,fill:"outline",children:(0,t.jsx)(d.x6,{i18nKey:"explore.correlation-transformation-add-modal.cancel",children:"Cancel"})}),(0,t.jsx)(B.$n,{variant:"primary",onClick:()=>e(T()),disabled:!m,children:n?"Edit transformation":"Add transformation to correlation"})]})]})},Nn=({exploreId:e,correlations:s})=>{const o=(0,D.useDispatch)(),n=(0,P.of)(Pn),r=(0,D.useSelector)(_.Qb),a=Object.values(r),{value:l,loading:p}=(0,is.A)(async()=>await(0,En.tZ)(a[0],a[1]),[a[0]?.datasourceInstance,a[0]?.queries[0].datasource,a[1]?.datasourceInstance,a[1]?.queries[0].datasource]),{register:f,watch:x,getValues:g,setValue:h}=(0,Mt.mN)(),[m,y]=(0,c.useState)(!1),[T,b]=(0,c.useState)(!1),[C,S]=(0,c.useState)(!1),[E,w]=(0,c.useState)([]),[v,L]=(0,c.useState)(void 0),j=(0,D.useSelector)(_.vC),F=(0,c.useId)();return(0,c.useEffect)(()=>(o((0,X.am)({canSave:!0})),()=>{o((0,X.am)({canSave:!1}))}),[o]),(0,c.useEffect)(()=>{!p&&l!==void 0&&!j?.correlationDirty&&g("label")!==""&&h("label",l)},[j?.correlationDirty,l,g,p,h]),(0,c.useEffect)(()=>{const $=x(z=>{let U=j?.correlationDirty||!1,M=z.description||"";!U&&(z.label!==l||M!=="")?U=!0:U&&z.label===l&&M.trim()===""&&(U=!1),o((0,X.am)({label:z.label,description:z.description,correlationDirty:U}))});return()=>$.unsubscribe()},[j?.correlationDirty,l,o,x]),(0,c.useEffect)(()=>{const $=!j?.correlationDirty&&E.length>0?!0:j?.correlationDirty;o((0,X.am)({transformations:E,correlationDirty:$}));let z={};E.forEach(U=>{const M=(0,ls.k)({type:U.type,expression:U.expression,mapValue:U.mapValue},s.vars[U.field],U.field);Object.keys(M).forEach(Y=>{z[Y]=M[Y]?.value})}),o((0,Me.nE)({exploreId:e,correlationEditorHelperData:{resultField:s.resultField,origVars:s.origVars,vars:{...s.origVars,...z}}}))},[o,E]),(0,t.jsxs)(t.Fragment,{children:[C&&(0,t.jsx)(An,{onCancel:()=>{L(void 0),S(!1)},onSave:$=>{if(v!==void 0){const z=[...E];z[v]=$,w(z),L(void 0)}else w([...E,$]);S(!1)},fieldList:s.origVars,transformationToEdit:v!==void 0?E[v]:void 0}),(0,t.jsxs)(nt.F,{title:(0,d.t)("explore.correlation-helper.title-correlation-details","Correlation details"),severity:"info",children:["The correlation link will appear by the ",(0,t.jsx)("code",{children:s.resultField})," field. You can use the following variables to set up your correlations:",(0,t.jsx)("pre",{children:Object.entries(s.vars).map($=>`\${${$[0]}} = ${$[1]}
`)}),(0,t.jsxs)(Bt.S,{collapsible:!0,isOpen:m,onToggle:()=>{y(!m)},label:(0,t.jsxs)(A.B,{gap:1,direction:"row",wrap:"wrap",alignItems:"center",children:["Label / Description",!m&&!p&&(0,t.jsx)("span",{className:n.labelCollapseDetails,children:`Label: ${g("label")||l}`})]}),children:[(0,t.jsx)(Be.D,{label:(0,d.t)("explore.correlation-helper.label-label","Label"),htmlFor:`${F}-label`,children:(0,t.jsx)(bt.p,{...f("label"),id:`${F}-label`,onBlur:()=>{g("label")===""&&l!==void 0&&h("label",l)}})}),(0,t.jsx)(Be.D,{label:(0,d.t)("explore.correlation-helper.label-description","Description"),htmlFor:`${F}-description`,children:(0,t.jsx)(bt.p,{...f("description"),id:`${F}-description`})})]}),(0,t.jsxs)(Bt.S,{collapsible:!0,isOpen:T,onToggle:()=>{b(!T)},label:(0,t.jsxs)(A.B,{gap:1,direction:"row",wrap:"wrap",alignItems:"center",children:["Transformations",(0,t.jsx)(J.m,{content:"A transformation extracts one or more variables out of a single field.",children:(0,t.jsx)(K.I,{name:"info-circle",size:"sm"})})]}),children:[(0,t.jsx)(B.$n,{variant:"secondary",fill:"outline",onClick:()=>{S(!0)},className:n.transformationAction,children:(0,t.jsx)(d.x6,{i18nKey:"explore.correlation-helper.add-transformation",children:"Add transformation"})}),E.map(($,z)=>{const{type:U,field:M,expression:Y,mapValue:q}=$,G=[(q??"").length>0?`Variable name: ${q}`:void 0,(Y??"").length>0?(0,t.jsxs)(t.Fragment,{children:["Expression: ",(0,t.jsx)("code",{children:Y})]}):void 0].filter(ue=>ue);return(0,t.jsxs)(Ht.Z,{children:[(0,t.jsxs)(Ht.Z.Heading,{children:[M,": ",U]}),G.length>0&&(0,t.jsx)(Ht.Z.Meta,{className:n.transformationMeta,children:G}),(0,t.jsxs)(Ht.Z.SecondaryActions,{children:[(0,t.jsx)(rt.K,{name:"edit","aria-label":(0,d.t)("explore.correlation-helper.aria-label-edit-transformation","Edit transformation"),onClick:()=>{L(z),S(!0)}},"edit"),(0,t.jsx)(In.e,{"aria-label":(0,d.t)("explore.correlation-helper.aria-label-delete-transformation","Delete transformation"),onConfirm:()=>w(E.filter((ue,I)=>z!==I)),closeOnConfirm:!0})]})]},`trans-${z}`)})]})]})]})},Pn=e=>({labelCollapseDetails:(0,u.css)({marginLeft:e.spacing(2),...e.typography.bodySmall,fontStyle:"italic"}),transformationAction:(0,u.css)({marginBottom:e.spacing(2)}),transformationMeta:(0,u.css)({alignItems:"baseline"})});var kn=i(60311),Mn=i(64400),He=i(67522),Bn=i(92391),Hn=i(89381);function $n({width:e,height:s,timeZone:o,state:n,pluginId:r,frames:a,timeRange:l,splitOpenFn:p,eventBus:f}){const x=(0,Bn.d4)(r),h={dataLinkPostProcessor:(0,Hn.h)(p,l),eventBus:f,eventsScope:"explore"};return(0,t.jsx)(Mn.XF,{value:h,children:(0,t.jsx)(He.NR,{title:x.name,width:e,height:s,loadingState:n,children:(m,y)=>(0,t.jsx)(kn.m,{data:{series:a,state:n,timeRange:l},pluginId:r,title:"",width:m,height:y,timeZone:o})})})}var Wn=i(78685);function Vn(e){const s=["prometheus","grafana-amazonprometheus-datasource","grafana-azureprometheus-datasource","loki","tempo","grafana-pyroscope-datasource"].includes(e.datasourceType),[o,n]=(0,Wn.A)("grafana.explore.drilldownsBoxDismissed",!1);return s&&!o&&(0,t.jsx)(nt.F,{severity:"info",title:(0,d.t)("explore.drilldownInfo.title","Explore Metrics, Logs, Traces and Profiles have moved!"),onRemove:()=>{n(!0)},children:(0,t.jsxs)(A.B,{gap:1,alignItems:"flex-end",justifyContent:"space-between",children:[(0,t.jsx)("span",{children:(0,t.jsxs)(d.x6,{i18nKey:"explore.drilldownInfo.description",children:["Looking for the Grafana Explore apps? They are now called the Grafana Drilldown apps and can be found under ",(0,t.jsx)("b",{children:"Menu > Drilldown"})]})}),(0,t.jsx)(B.z9,{variant:"secondary",href:"/drilldown",children:(0,t.jsx)(d.x6,{i18nKey:"explore.drilldownInfo.action",children:"Go to Grafana Drilldown"})})]})})}var zn=i(82143),Qn=i(84600),me=i(7895),ds=i(93256),$t=i(90811),Un=i(43707),Kn=i(76792),us=i(72265),je=i(52763),ps=i(73427),so=i(69289),at=i(25229),oo=i(33239),Gn=i(51158),no=i(23237);function qn(e){const{onClick:s,isSynced:o}=e,n=()=>{const{isSynced:r}=e,a=r?"Unsync all views":"Sync all views to this time range";return(0,t.jsx)(t.Fragment,{children:a})};return(0,t.jsx)(J.m,{content:n,placement:"bottom",children:(0,t.jsx)(me.I,{icon:"link",variant:o?"active":"canvas","aria-label":o?"Synced times":"Unsynced times",onClick:s})})}class Zn extends c.Component{constructor(){super(...arguments),this.onMoveTimePicker=s=>{const{range:o,onChangeTime:n,timeZone:r}=this.props,{from:a,to:l}=(0,no.Wb)(s,o),p={from:(0,at.oZ)(r,a),to:(0,at.oZ)(r,l)};n(p)},this.onMoveForward=()=>this.onMoveTimePicker(1),this.onMoveBack=()=>this.onMoveTimePicker(-1),this.onChangeTimePicker=s=>{const o=oo.isMathString(s.raw.from)?s.raw.from:s.from,n=oo.isMathString(s.raw.to)?s.raw.to:s.to;this.props.onChangeTime({from:o,to:n}),(0,k.rR)("grafana_explore_time_picker_time_range_changed",{timeRangeFrom:o,timeRangeTo:n})},this.onZoom=()=>{const{range:s,onChangeTime:o,timeZone:n}=this.props,{from:r,to:a}=(0,no.Zk)(s,2),l={from:(0,at.oZ)(n,r),to:(0,at.oZ)(n,a)};o(l)}}render(){const{range:s,timeZone:o,fiscalYearStartMonth:n,splitted:r,syncedTimes:a,onChangeTimeSync:l,hideText:p,onChangeTimeZone:f,onChangeFiscalYearStartMonth:x}=this.props,g=r?(0,t.jsx)(qn,{onClick:l,isSynced:a}):void 0,h={value:s,timeZone:o,fiscalYearStartMonth:n,onMoveBackward:this.onMoveBack,onMoveForward:this.onMoveForward,onZoom:this.onZoom,hideText:p};return(0,t.jsx)(Gn.m,{isOnCanvas:!0,...h,timeSyncButton:g,isSynced:a,widthOverride:r?window.innerWidth/2:void 0,onChange:this.onChangeTimePicker,onChangeTimeZone:f,onChangeFiscalYearStartMonth:x})}}var ro=i(86634);function Yn(e){const s=(0,c.useRef)(null),{start:o,pause:n,resume:r,isLive:a,isPaused:l,stop:p,splitted:f}=e,x=a&&!l?"active":"canvas",g=a?l?r:n:o;return(0,t.jsxs)(ds.e,{children:[(0,t.jsx)(J.m,{content:a&&!l?(0,t.jsx)(t.Fragment,{children:(0,t.jsx)(d.x6,{i18nKey:"explore.live-tail-button.pause-the-live-stream",children:"Pause the live stream"})}):(0,t.jsx)(t.Fragment,{children:(0,t.jsx)(d.x6,{i18nKey:"explore.live-tail-button.start-live-stream-your-logs",children:"Start live stream your logs"})}),placement:"bottom",children:(0,t.jsx)(me.I,{iconOnly:f,variant:x,icon:!a||l?"play":"pause",onClick:g,children:a&&l?"Paused":"Live"})}),(0,t.jsx)(ro.A,{mountOnEnter:!0,unmountOnExit:!0,timeout:100,in:a,classNames:{enter:Wt.stopButtonEnter,enterActive:Wt.stopButtonEnterActive,exit:Wt.stopButtonExit,exitActive:Wt.stopButtonExitActive},nodeRef:s,children:(0,t.jsx)(J.m,{content:(0,t.jsx)(t.Fragment,{children:(0,t.jsx)(d.x6,{i18nKey:"explore.live-tail-button.stop-and-exit-the-live-stream",children:"Stop and exit the live stream"})}),placement:"bottom",children:(0,t.jsx)(me.I,{ref:s,variant:x,onClick:p,icon:"square-shape"})})})]})}const Wt={stopButtonEnter:(0,u.css)({label:"stopButtonEnter",width:0,opacity:0,overflow:"hidden"}),stopButtonEnterActive:(0,u.css)({label:"stopButtonEnterActive",opacity:1,width:"32px"}),stopButtonExit:(0,u.css)({label:"stopButtonExit",width:"32px",opacity:1,overflow:"hidden"}),stopButtonExitActive:(0,u.css)({label:"stopButtonExitActive",opacity:0,width:0})};var it=i(52830),ze=i(87063),Jn=i(30930),Ct=i(88559),Vt=i(71673),lt=i(78529);const Xn={key:"copy-link",label:(0,d.t)("explore.toolbar.copy-shortened-link","Copy shortened URL"),icon:"share-alt",getUrl:()=>{},shorten:!0,absTime:!1};function _n(){const e=(0,D.useSelector)(_.Qb),[s,o]=(0,c.useState)(!1),[n,r]=(0,c.useState)(Xn),a=(f,x,g)=>{f?((0,Vt.VP)(g||i.g.location.href),(0,k.rR)("grafana_explore_shortened_link_clicked",{isAbsoluteTime:x})):((0,yt.uJ)(g!==void 0?`${window.location.protocol}//${window.location.host}${V.$.appSubUrl}${g}`:i.g.location.href),(0,k.rR)("grafana_explore_copy_link_clicked",{isAbsoluteTime:x}))},l=[{key:"normal",label:(0,d.t)("explore.toolbar.copy-links-normal-category","Normal URL links"),items:[{key:"copy-shortened-link",icon:"link",label:(0,d.t)("explore.toolbar.copy-shortened-link","Copy shortened URL"),getUrl:()=>{},shorten:!0,absTime:!1},{key:"copy-link",icon:"link",label:(0,d.t)("explore.toolbar.copy-link","Copy URL"),getUrl:()=>{},shorten:!1,absTime:!1}]},{key:"timesync",label:(0,d.t)("explore.toolbar.copy-links-absolute-category","Time-sync URL links (share with time range intact)"),items:[{key:"copy-short-link-abs-time",icon:"clock-nine",label:(0,d.t)("explore.toolbar.copy-shortened-link-abs-time","Copy absolute shortened URL"),shorten:!0,getUrl:()=>(0,lt._O)(e),absTime:!0},{key:"copy-link-abs-time",icon:"clock-nine",label:(0,d.t)("explore.toolbar.copy-link-abs-time","Copy absolute URL"),shorten:!1,getUrl:()=>(0,lt._O)(e),absTime:!0}]}],p=(0,t.jsx)(ze.W,{children:l.map(f=>(0,t.jsx)(Jn.r,{label:f.label,children:f.items.map(x=>(0,t.jsx)(ze.W.Item,{label:x.label,icon:x.icon,onClick:()=>{const g=x.getUrl();a(x.shorten,x.absTime,g),r(x)}},x.key))},f.key))});return(0,t.jsxs)(ds.e,{children:[(0,t.jsx)(B.$n,{tooltip:n.label,icon:n.icon,size:"sm",variant:"secondary",onClick:()=>{const f=n.getUrl();a(n.shorten,n.absTime,f)},"aria-label":(0,d.t)("explore.toolbar.copy-shortened-link","Copy shortened URL"),children:(0,t.jsx)(d.x6,{i18nKey:"explore.toolbar.copy-shortened-link-label",children:"Share"})}),(0,t.jsx)(Ct.m,{overlay:p,placement:"bottom-end",onVisibleChange:o,children:(0,t.jsx)(B.$n,{variant:"secondary",size:"sm",icon:s?"angle-up":"angle-down","aria-label":(0,d.t)("explore.toolbar.copy-shortened-link-menu","Open copy link options")})})]})}var er=i(54092),tr=i(46907),sr=i(20806),ao=i(11257),io=i(9860);const or=(0,c.lazy)(()=>i.e(8224).then(i.bind(i,38224)).then(({AddToDashboard:e})=>({default:e})));function nr(e){const{exploreId:s,links:o,setSelectedExtension:n,setIsModalOpen:r,isModalOpen:a,noQueriesInPane:l}=e;if(o.length<=1)return Dt.TP.hasPermission(ao.w.DashboardsCreate)||Dt.TP.hasPermission(ao.w.DashboardsWrite)?(0,t.jsx)(c.Suspense,{fallback:null,children:(0,t.jsx)(or,{exploreId:s})}):null;const p=(0,t.jsx)(io.w,{extensions:o,onSelect:n});return(0,t.jsx)(t.Fragment,{children:(0,t.jsx)(Ct.m,{onVisibleChange:r,placement:"bottom-start",overlay:p,children:(0,t.jsx)(me.I,{"aria-label":(0,d.t)("explore.basic-extensions.aria-label-add","Add"),disabled:!l,variant:"canvas",isOpen:a,children:(0,t.jsx)(d.x6,{i18nKey:"explore.toolbar.add-to-extensions",children:"Add"})})})})}function rr(e){const{links:s,setSelectedExtension:o,setIsModalOpen:n,isModalOpen:r,noQueriesInPane:a}=e;if(s.length===0)return;const l=(0,t.jsx)(io.w,{extensions:s,onSelect:o});if(s.length===1){const p=(0,ne.first)(s);return(0,t.jsx)(me.I,{variant:"canvas",icon:p.icon,onClick:()=>o(p),children:(0,t.jsx)(d.x6,{i18nKey:"explore.toolbar.add-to-queryless-extensions",children:"Go queryless"})})}return(0,t.jsx)(t.Fragment,{children:(0,t.jsx)(Ct.m,{onVisibleChange:n,placement:"bottom-start",overlay:l,children:(0,t.jsx)(me.I,{"aria-label":(0,d.t)("explore.queryless-apps-extensions.aria-label-go-queryless","Go queryless"),disabled:!a,variant:"canvas",isOpen:r,children:(0,t.jsx)(d.x6,{i18nKey:"explore.toolbar.add-to-queryless-extensions",children:"Go queryless"})})})})}const lo=["grafana-pyroscope-app","grafana-lokiexplore-app","grafana-exploretraces-app","grafana-metricsdrilldown-app"];function co(e){const{exploreId:s,extensionsToShow:o}=e,[n,r]=(0,c.useState)(),[a,l]=(0,c.useState)(!1),p=ar(e),{links:f}=(0,tr.U)({extensionPointId:er.S.ExploreToolbarAction,context:p,limitPerPlugin:3}),x=(0,_.qq)(s),g=!!(0,D.useSelector)(x)?.queries?.length,h=f.filter(y=>lo.includes(y.pluginId)),m=f.filter(y=>!lo.includes(y.pluginId));return(0,t.jsxs)(t.Fragment,{children:[o==="queryless"&&(0,t.jsx)(rr,{links:h,noQueriesInPane:g,exploreId:s,setSelectedExtension:y=>{r(y),(0,k.rR)("grafana_explore_queryless_app_link_clicked",{pluginId:y.pluginId})},setIsModalOpen:l,isModalOpen:a}),o==="basic"&&(0,t.jsx)(nr,{links:m,noQueriesInPane:g,exploreId:s,setSelectedExtension:r,setIsModalOpen:l,isModalOpen:a}),!!n&&!!n.path&&(0,t.jsx)(sr.s,{path:n.path,title:n.title,onDismiss:()=>r(void 0)})]})}function ar(e){const{exploreId:s,timeZone:o}=e,r=(0,D.useSelector)(_.vC)?.editorMode||!1,{queries:a,queryResponse:l,range:p}=(0,D.useSelector)((0,_.qq)(s)),f=(0,D.useSelector)((0,_.Jr)(s)),x=a.map(m=>m?.datasource?.uid).filter(m=>m!==void 0),g=[...new Set(x)].length,h=Dt.TP.hasPermission(D.AccessControlAction.DataSourcesWrite);return(0,c.useMemo)(()=>({exploreId:s,targets:a,data:l,timeRange:p.raw,timeZone:(0,Us.O)({timeZone:o}),shouldShowAddCorrelation:V.$.featureToggles.correlations===!0&&h&&!r&&f&&g===1}),[s,a,l,p.raw,o,h,r,f,g])}var Te=i(94543);function ir(e){const s=(0,D.useDispatch)(),o=(0,c.useCallback)(()=>{s((0,Z.qk)({exploreId:e,isPaused:!0}))},[e,s]),n=(0,c.useCallback)(()=>{s((0,Z.qk)({exploreId:e,isPaused:!1}))},[e,s]),r=(0,c.useCallback)(()=>{o(),s((0,Te.hO)({exploreId:e,refreshInterval:$t.cC.offOption.value})),s((0,Z.Od)({exploreId:e}))},[e,s,o]),a=(0,c.useCallback)(()=>{s((0,Te.hO)({exploreId:e,refreshInterval:$t.cC.liveOption.value}))},[e,s]),l=(0,c.useCallback)(()=>{s((0,Z.rR)({exploreId:e}))},[e,s]);return{pause:o,resume:n,stop:r,start:a,clear:l}}function uo(e){const s=ir(e.exploreId);return e.children(s)}const lr=(e,s)=>({rotateIcon:(0,u.css)({"> div > svg":{transform:"rotate(180deg)"}}),toolbarButton:(0,u.css)({display:"flex",justifyContent:"center",marginRight:e.spacing(.5),width:s&&e.spacing(6)})});function cr({exploreId:e,onChangeTime:s,onContentOutlineToogle:o,isContentOutlineOpen:n}){const r=(0,je.wA)(),a=(0,je.d4)(_.pF),l=(0,P.of)(lr,a),p=(0,je.d4)(O=>(0,At.O)(O.user)),f=(0,je.d4)(O=>(0,At.q)(O.user)),{refreshInterval:x,datasourceInstance:g,range:h,isLive:m,isPaused:y,syncedTimes:T}=(0,je.d4)(O=>({...(0,ne.pick)(O.explore.panes[e],"refreshInterval","datasourceInstance","range","isLive","isPaused"),syncedTimes:O.explore.syncedTimes}),Le.shallowEqual),b=(0,je.d4)((0,Z.h1)(e)),C=(0,je.d4)(O=>O.explore.largerExploreId===e),S=(0,je.d4)(O=>a||O.explore.panes[e].containerWidth<1210),E=(0,je.d4)(O=>O.explore.panes[e].containerWidth<(a?700:800)),w=(0,je.d4)(_.K6),v=(0,je.d4)(_.vC),L=v?.editorMode||!1,j=(0,je.d4)((0,_.Jr)(e)),{drawerOpened:F,setDrawerOpened:$}=(0,it.sz)(),z=(0,c.useMemo)(()=>j&&C||!j&&!C,[j,C]),U=b?(0,d.t)("explore.toolbar.refresh-picker-cancel","Cancel"):(0,d.t)("explore.toolbar.refresh-picker-run","Run query"),M=async O=>{L?v?.correlationDirty||v?.queryEditorDirty?r((0,X.am)({isExiting:!0,postConfirmAction:{exploreId:e,action:us.IW.CHANGE_DATASOURCE,changeDatasourceUid:O.uid,isActionLeft:j}})):(j&&w.forEach(ye=>{r((0,Me.nE)({exploreId:ye[0],correlationEditorHelperData:void 0}))}),r((0,ke.wh)({exploreId:e,datasource:O.uid,options:{importQueries:!0}}))):r((0,ke.wh)({exploreId:e,datasource:O.uid,options:{importQueries:!0}}))},Y=(O=!1)=>r(O?(0,Z.hS)(e):(0,Z.Od)({exploreId:e})),q=O=>r((0,so.Cj)(O)),G=()=>{r((0,X.ve)()),(0,k.rR)("grafana_explore_split_view_opened",{origin:"menu"})},ue=()=>{L?v?.correlationDirty||v?.queryEditorDirty?r((0,X.am)({isExiting:!0,postConfirmAction:{exploreId:e,action:us.IW.CLOSE_PANE,isActionLeft:j}})):(w.forEach(O=>{r((0,Me.nE)({exploreId:O[0],correlationEditorHelperData:void 0}))}),r((0,X.J8)(e)),(0,k.rR)("grafana_explore_split_view_closed")):(r((0,X.J8)(e)),(0,k.rR)("grafana_explore_split_view_closed"))},I=()=>{r(C?(0,X.JA)():(0,X.tP)({exploreId:e}))},N=()=>{r((0,Te.iO)(e))},W=O=>r((0,so.c1)(O)),Q=O=>{r((0,Te.hO)({exploreId:e,refreshInterval:O}))},se=[(0,t.jsx)(B.$n,{size:"sm",variant:"secondary","aria-label":(0,d.t)("explore.secondary-actions.query-history-button-aria-label","Query history"),onClick:()=>$(!F),"data-testid":Ge.XF.QueryTab.queryHistoryButton,icon:"history",children:(0,t.jsx)(d.x6,{i18nKey:"explore.secondary-actions.query-history-button",children:"Query history"})},"query-history"),(0,t.jsx)(_n,{},"share")];return(0,t.jsxs)("div",{children:[x&&(0,t.jsx)(zn.u,{func:Y,interval:x,loading:b}),(0,t.jsx)(Un.H,{actions:se}),(0,t.jsx)(Qn.d,{"aria-label":(0,d.t)("explore.toolbar.aria-label","Explore toolbar"),leftItems:[(0,t.jsx)(me.I,{variant:"canvas",tooltip:(0,d.t)("explore.explore-toolbar.tooltip-content-outline","Content outline"),icon:"list-ui-alt",iconOnly:a,onClick:o,"aria-expanded":n,"aria-controls":n?"content-outline-container":void 0,className:l.toolbarButton,children:(0,t.jsx)(d.x6,{i18nKey:"explore.explore-toolbar.outline",children:"Outline"})},"content-outline"),(0,t.jsx)(Kn.s,{mixed:!L,onChange:M,current:g?.getRef(),hideTextValue:E,width:E?8:void 0},`${e}-ds-picker`),(0,t.jsx)(co,{exploreId:e,timeZone:p,extensionsToShow:"queryless"},"toolbar-extension-point")].filter(Boolean),forceShowLeftItems:!0,children:[a?(0,t.jsxs)(ds.e,{children:[(0,t.jsx)(me.I,{variant:"canvas",tooltip:C?(0,d.t)("explore.toolbar.split-narrow","Narrow pane"):(0,d.t)("explore.toolbar.split-widen","Widen pane"),onClick:I,icon:C?"gf-movepane-left":"gf-movepane-right",iconOnly:!0,className:(0,u.cx)(z&&l.rotateIcon)}),(0,t.jsx)(me.I,{tooltip:(0,d.t)("explore.toolbar.split-close-tooltip","Close split pane"),onClick:ue,icon:"times",variant:"canvas",children:(0,t.jsx)(d.x6,{i18nKey:"explore.toolbar.split-close",children:" Close "})})]},"split-controls"):(0,t.jsx)(me.I,{variant:"canvas",tooltip:(0,d.t)("explore.toolbar.split-tooltip","Split the pane"),onClick:G,icon:"columns",disabled:m,children:(0,t.jsx)(d.x6,{i18nKey:"explore.toolbar.split-title",children:"Split"})},"split"),(0,t.jsx)(co,{exploreId:e,timeZone:p,extensionsToShow:"basic"},"toolbar-extension-point"),!m&&(0,t.jsx)(Zn,{exploreId:e,range:h,timeZone:p,fiscalYearStartMonth:f,onChangeTime:s,splitted:a,syncedTimes:T,onChangeTimeSync:N,hideText:S,onChangeTimeZone:q,onChangeFiscalYearStartMonth:W},"timeControls"),(0,t.jsx)($t.cC,{onIntervalChanged:Q,value:x,isLoading:b,text:S?void 0:U,tooltip:S?U:void 0,intervals:ps.TP.getValidIntervals($t.cb),isLive:m,onRefresh:()=>Y(b),noIntervalPicker:m,primary:!0,width:(S?35:108)+"px"},"refreshPicker"),g?.meta.streaming&&(0,t.jsx)(uo,{exploreId:e,children:O=>{const ye={...O,start:()=>{(0,k.rR)("grafana_explore_logs_live_tailing_clicked",{datasourceType:g?.type}),O.start()}};return(0,t.jsx)(Yn,{splitted:a,isLive:m,isPaused:y,start:ye.start,pause:ye.pause,resume:ye.resume,stop:ye.stop})}},"liveControls")].filter(Boolean)})]})}var $e=i(1906),dr=i(10020);function zt(e,s={}){(0,k.rR)(`grafana_flamegraph_${e}`,{app:$e.Jk.Unknown,grafana_version:V.$.buildInfo.version,...s})}const ur=e=>{const s=(0,P.of)(o=>pr(o));return(0,t.jsx)("div",{className:s.container,children:(0,t.jsx)(dr.A,{data:e.dataFrames[0],stickyHeader:!0,getTheme:()=>V.$.theme2,onTableSymbolClick:()=>zt("table_item_selected"),onViewSelected:o=>zt("view_selected",{view:o}),onTextAlignSelected:o=>zt("text_align_selected",{align:o}),onTableSort:o=>zt("table_sort_selected",{sort:o})})})},pr=e=>({container:(0,u.css)({background:e.colors.background.primary,display:"flow-root",padding:e.spacing(0,1,1,1),border:`1px solid ${e.components.panel.borderColor}`,borderRadius:e.shape.radius.default})});var gr=i(5929),po=i(84140),ce=i(739),go=i(80011),hr=i(25461),fr=i(21429),xe=i(74746),mr=i(10940),xr=i(55555);const ho=150,yr=({resetKey:e,humanize:s,className:o})=>{const[n,r]=(0,c.useState)(0);return(0,mr.A)(()=>r(n+ho),ho),(0,c.useEffect)(()=>r(0),[e]),(0,t.jsx)(xr.g,{timeInMs:n,className:o,humanize:s})};var vr=i(83953);const br=e=>{const s=(0,u.keyframes)({from:{backgroundColor:(0,po.A)(e.colors.info.transparent).setAlpha(.25).toString()},to:{backgroundColor:"transparent"}});return{logsRowsLive:(0,u.css)({label:"logs-rows-live",fontFamily:e.typography.fontFamilyMonospace,fontSize:e.typography.bodySmall.fontSize,display:"flex",flexFlow:"column nowrap",height:"60vh",overflowY:"scroll",":first-child":{marginTop:"auto !important"}}),logsRowFade:(0,u.css)({label:"logs-row-fresh",color:e.colors.text.primary,backgroundColor:(0,po.A)(e.colors.info.transparent).setAlpha(.25).toString(),[e.transitions.handleMotion("no-preference","reduce")]:{animation:`${s} 1s ease-out 1s 1 normal forwards`}}),logsRowsIndicator:(0,u.css)({fontSize:e.typography.h6.fontSize,paddingTop:e.spacing(1),display:"flex",alignItems:"center"}),button:(0,u.css)({marginRight:e.spacing(1)}),fullWidth:(0,u.css)({width:"100%"})}};class Cr extends c.PureComponent{constructor(s){super(s),this.liveEndDiv=null,this.scrollContainerRef=c.createRef(),this.onScroll=o=>{const{isPaused:n,onPause:r}=this.props,{scrollTop:a,clientHeight:l,scrollHeight:p}=o.currentTarget;p-(a+l)>=5&&!n&&r()},this.rowsToRender=()=>{const{isPaused:o}=this.props;let{logRowsToRender:n=[]}=this.state;return o||(n=(0,xe.oR)(n,ce.uH.Ascending).slice(-100)),n},this.state={logRowsToRender:s.logRows}}static getDerivedStateFromProps(s,o){return s.isPaused&&s.clearedAtIndex?{logRowsToRender:(0,vr.pg)(s.clearedAtIndex,o.logRowsToRender)}:s.isPaused?null:{logRowsToRender:s.logRows}}render(){const{theme:s,timeZone:o,onPause:n,onResume:r,onClear:a,isPaused:l}=this.props,p=br(s),{logsRow:f,logsRowLocalTime:x,logsRowMessage:g}=(0,fr.D)(s);return(0,t.jsxs)("div",{children:[(0,t.jsx)("table",{className:p.fullWidth,children:(0,t.jsxs)("tbody",{onScroll:l?void 0:this.onScroll,className:p.logsRowsLive,ref:this.scrollContainerRef,children:[this.rowsToRender().map(h=>(0,t.jsxs)("tr",{className:(0,u.cx)(f,p.logsRowFade),children:[(0,t.jsx)("td",{className:x,children:(0,go.LE)(h.timeEpochMs,{timeZone:o})}),(0,t.jsx)("td",{className:g,children:h.hasAnsi?(0,t.jsx)(hr.$,{value:h.raw}):h.entry})]},h.uid)),(0,t.jsx)("tr",{ref:h=>{this.liveEndDiv=h,this.liveEndDiv&&this.scrollContainerRef.current?.scrollTo&&!l&&this.scrollContainerRef.current?.scrollTo(0,this.scrollContainerRef.current.scrollHeight)}})]})}),(0,t.jsxs)("div",{className:p.logsRowsIndicator,children:[(0,t.jsx)(B.$n,{icon:l?"play":"pause",variant:"secondary",onClick:l?r:n,className:p.button,children:l?"Resume":"Pause"}),(0,t.jsx)(B.$n,{icon:"trash-alt",variant:"secondary",onClick:a,className:p.button,children:(0,t.jsx)(d.x6,{i18nKey:"explore.live-logs.clear-logs",children:"Clear logs"})}),(0,t.jsx)(B.$n,{icon:"square-shape",variant:"secondary",onClick:this.props.stopLive,className:p.button,children:(0,t.jsx)(d.x6,{i18nKey:"explore.live-logs.exit-live-mode",children:"Exit live mode"})}),l||this.rowsToRender().length>0&&(0,t.jsxs)("span",{children:["Last line received: ",(0,t.jsx)(yr,{resetKey:this.props.logRows,humanize:!0})," ago"]})]})]})}}const Sr=(0,P.cV)(Cr);var jr=i(84596),Tr=i(17548),fo=i(57852),mo=i(5556),gs=i(49256),Qt=i(77824),Rr=i(97095),Fe=i(18027),Ze=i(21285),Lr=i(96384),he=i(29043),xo=i(46072);function wr(e){return{searchWrap:(0,u.css)({padding:`${e.spacing(.4)} 0 ${e.spacing(.4)} ${e.spacing(.4)}`})}}function Ir(e){const s=(0,P.$j)(),o=wr(s);return(0,t.jsx)(Be.D,{className:o.searchWrap,children:(0,t.jsx)(bt.p,{value:e.value,type:"text",placeholder:(0,d.t)("explore.logs-column-search.placeholder-search-fields-by-name","Search fields by name"),onChange:e.onChange})})}var Er=i(67155),hs=i(57095);function Or(e){return{empty:(0,u.css)({marginBottom:e.spacing(2),marginLeft:e.spacing(1.75),fontSize:e.typography.fontSize})}}function yo(){const e=(0,P.$j)(),s=Or(e);return(0,t.jsx)("div",{className:s.empty,children:(0,t.jsx)(d.x6,{i18nKey:"explore.logs-table-empty-fields.no-fields",children:"No fields"})})}var Fr=i(32635);function Dr(e){return{dragIcon:(0,u.css)({cursor:"drag",marginLeft:e.spacing(1),opacity:.4}),labelCount:(0,u.css)({marginLeft:e.spacing(.5),marginRight:e.spacing(.5),appearance:"none",background:"none",border:"none",fontSize:e.typography.pxToRem(11),opacity:.6}),contentWrap:(0,u.css)({display:"flex",alignItems:"center",justifyContent:"space-between",width:"100%"}),checkboxLabel:(0,u.css)({"> span":{overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",display:"block",maxWidth:"100%"}})}}function vo(e){const s=(0,P.$j)(),o=Dr(s);if(e.labels[e.label])return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)("div",{className:o.contentWrap,children:[(0,t.jsx)(Fr.S,{className:o.checkboxLabel,label:e.label,onChange:e.onChange,checked:e.labels[e.label]?.active??!1}),e.showCount&&(0,t.jsxs)("button",{className:o.labelCount,onClick:e.onChange,children:[e.labels[e.label]?.percentOfLinesWithLabel,"%"]})]}),e.draggable&&(0,t.jsx)(K.I,{"aria-label":(0,d.t)("explore.logs-table-nav-field.aria-label-drag-and-drop-icon","Drag and drop icon"),title:(0,d.t)("explore.logs-table-nav-field.title-drag-and-drop-to-reorder","Drag and drop to reorder"),name:"draggabledots",size:"lg",className:o.dragIcon})]})}function bo(e){return{wrap:(0,u.css)({marginTop:e.spacing(1),marginBottom:e.spacing(1),display:"flex",background:e.colors.background.primary}),dragging:(0,u.css)({background:e.colors.background.secondary}),columnWrapper:(0,u.css)({marginBottom:e.spacing(1.5),paddingLeft:e.spacing(.5)})}}function Ar(e){return(s,o)=>{const n=e[s],r=e[o];return n.index!=null&&r.index!=null?n.index-r.index:0}}const Nr=e=>{const{reorderColumn:s,labels:o,valueFilter:n,toggleColumn:r}=e,a=(0,P.$j)(),l=bo(a),p=Object.keys(o).filter(g=>n(g)),f=g=>{g.destination&&s(g.source.index,g.destination.index)},x=g=>{const h=o[g];if(h)return`${g} appears in ${h?.percentOfLinesWithLabel}% of log lines`};return p.length?(0,t.jsx)(hs.DragDropContext,{onDragEnd:f,children:(0,t.jsx)(hs.Droppable,{droppableId:"order-fields",direction:"vertical",children:g=>(0,t.jsxs)("div",{className:l.columnWrapper,...g.droppableProps,ref:g.innerRef,children:[p.sort(Ar(o)).map((h,m)=>(0,t.jsx)(hs.Draggable,{draggableId:h,index:m,children:(y,T)=>(0,t.jsx)("div",{className:(0,u.cx)(l.wrap,T.isDragging?l.dragging:void 0),ref:y.innerRef,...y.draggableProps,...y.dragHandleProps,title:x(h),children:(0,t.jsx)(vo,{label:h,onChange:()=>r(h),labels:o,draggable:!0})})},h)),g.placeholder]})})}):(0,t.jsx)(yo,{})},Pr=new Intl.Collator(void 0,{sensitivity:"base"});function kr(e){return(s,o)=>{const n=e[s],r=e[o];return n!=null&&r!=null?+(r.type==="TIME_FIELD")-+(n.type==="TIME_FIELD")||+(r.type==="BODY_FIELD")-+(n.type==="BODY_FIELD")||Pr.compare(s,o):0}}const Mr=e=>{const{labels:s,valueFilter:o,toggleColumn:n}=e,r=(0,P.$j)(),a=bo(r),l=Object.keys(s).filter(p=>o(p));return l.length?(0,t.jsx)("div",{className:a.columnWrapper,children:l.sort(kr(s)).map((p,f)=>(0,t.jsx)("div",{className:a.wrap,title:`${p} appears in ${s[p]?.percentOfLinesWithLabel}% of log lines`,children:(0,t.jsx)(vo,{showCount:!0,label:p,onChange:()=>n(p),labels:s})},p))}):(0,t.jsx)(yo,{})};function Br(e){return{sidebarWrap:(0,u.css)({overflowY:"scroll",height:"calc(100% - 50px)","&::-webkit-scrollbar":{display:"none"},scrollbarWidth:"none"}),columnHeaderButton:(0,u.css)({appearance:"none",background:"none",border:"none",fontSize:e.typography.pxToRem(11)}),columnHeader:(0,u.css)({display:"flex",justifyContent:"space-between",fontSize:e.typography.h6.fontSize,background:e.colors.background.secondary,position:"sticky",top:0,left:0,paddingTop:e.spacing(.75),paddingRight:e.spacing(.75),paddingBottom:e.spacing(.75),paddingLeft:e.spacing(1.5),zIndex:3,marginBottom:e.spacing(2)})}}const Hr=e=>{const s=(0,P.$j)(),o=Br(s);return(0,t.jsx)("div",{className:o.sidebarWrap,children:(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)("div",{className:o.columnHeader,children:["Selected fields",(0,t.jsx)("button",{onClick:e.clear,className:o.columnHeaderButton,children:"Reset"})]}),(0,t.jsx)(Nr,{reorderColumn:e.reorderColumn,toggleColumn:e.toggleColumn,labels:e.filteredColumnsWithMeta??e.columnsWithMeta,valueFilter:n=>e.columnsWithMeta[n]?.active??!1,id:"selected-fields"}),(0,t.jsx)("div",{className:o.columnHeader,children:(0,t.jsx)(d.x6,{i18nKey:"explore.logs-table-multi-select.fields",children:"Fields"})}),(0,t.jsx)(Mr,{toggleColumn:e.toggleColumn,labels:e.filteredColumnsWithMeta??e.columnsWithMeta,valueFilter:n=>!e.columnsWithMeta[n]?.active})]})})};var Co=i(84139);const $r=new Co.A({intraMode:1,intraIns:1,intraSub:1,intraTrn:1,intraDel:1});function So(e,s,o){const[n,r,a]=$r.search(e,s,0,1e5);let l=[],p=new Set;if(n&&a){const f=(x,g)=>{g&&p.add(x)};for(let x=0;x<a.length;x++){let g=a[x];Co.A.highlight(e[r.idx[g]],r.ranges[g],f),l.push(e[r.idx[g]])}o([l,[...p]])}else s||o([[],[]])}const Yl=(0,ne.debounce)(So,300);function jo(e){const{logsFrames:s,updatePanelState:o,panelState:n}=e,r=n?.columns,[a,l]=(0,c.useState)(void 0),[p,f]=(0,c.useState)(void 0),[x,g]=(0,c.useState)(""),h=To(),m=e?.panelState?.refId,[y,T]=(0,c.useState)(s.find(I=>I.refId===m)??s[0]),b=(0,c.useCallback)(I=>{const N=e.panelState?.columns;return N&&Object.values(N).forEach((W,Q)=>{I[W]&&(I[W].active=!0,I[W].index=Q)}),I},[e.panelState?.columns]),C=(0,xo.Os)(y);(0,c.useEffect)(()=>{if(C?.timeField.name&&C?.bodyField.name&&!r){const I={0:C?.timeField.name??"",1:C?.bodyField.name??""};o({columns:Object.values(I),visualisationType:"table",labelFieldName:C?.getLabelFieldName()??void 0})}},[C,r,o]),(0,c.useEffect)(()=>{const I=s.find(N=>N.refId===m)??s[0];I&&T(I)},[s,m]),(0,c.useEffect)(()=>{if(!a||!p)return;let I={...p},N=!1;Object.keys(a).forEach(W=>{I[W]&&I[W].active!==a[W].active&&(I[W]=a[W],N=!0)}),N&&f(I)},[a,p]),(0,c.useEffect)(()=>{if(!y.length)return;const I=y?y.length:0,N=(0,xo.Os)(y),W=N?.getLogFrameLabelsAsLabels(),Q=[];N&&Q.push(...N.extraFields.filter(oe=>!oe?.config?.custom?.hidden)),N?.severityField&&Q.push(N?.severityField),N?.bodyField&&Q.push(N?.bodyField),N?.timeField&&Q.push(N?.timeField);const se=new Map;let O={};W?.length&&I&&(W.forEach(oe=>{Object.keys(oe).forEach(ae=>{if(se.has(ae)){const pe=se.get(ae);pe&&(pe?.active?se.set(ae,{percentOfLinesWithLabel:pe.percentOfLinesWithLabel+1,active:!0,index:pe.index}):se.set(ae,{percentOfLinesWithLabel:pe.percentOfLinesWithLabel+1,active:!1,index:void 0}))}else se.set(ae,{percentOfLinesWithLabel:1,active:!1,index:void 0})})}),O=Object.fromEntries(se),Object.keys(O).forEach(oe=>{O[oe].percentOfLinesWithLabel=fs(O[oe].percentOfLinesWithLabel,I)})),Q.forEach(oe=>{const Qe=O[oe.name]?.active,ae=O[oe.name]?.index;Qe&&ae!==void 0?O[oe.name]={percentOfLinesWithLabel:fs(oe.values.filter(pe=>pe!=null).length,I),active:!0,index:ae}:O[oe.name]={percentOfLinesWithLabel:fs(oe.values.filter(pe=>pe!=null).length,I),active:!1,index:void 0}}),O=b(O),Object.keys(O).filter(oe=>O[oe].active).length===0&&(N?.bodyField?.name&&(O[N.bodyField.name].active=!0),N?.timeField?.name&&(O[N.timeField.name].active=!0)),N?.bodyField?.name&&N?.timeField?.name&&(O[N.bodyField.name].type="BODY_FIELD",O[N.timeField.name].type="TIME_FIELD"),l(O)},[y,b]);const[S,E]=(0,c.useState)(220),w=e.width-S;if(!a)return null;function v(I){if(a){const N=!a[I]?.active,W=Object.keys(a).filter(se=>a[se]?.active)?.length,Q={columnAction:N?"add":"remove",columnCount:N?W+1:W-1,datasourceType:e.datasourceType};(0,k.rR)("grafana_explore_logs_table_column_filter_clicked",Q)}}function L(I){(0,k.rR)("grafana_explore_logs_table_text_search_result_count",{resultCount:I,datasourceType:e.datasourceType??"unknown"})}const j=()=>{const I={...a};let N=0;Object.keys(I).forEach(W=>{const Q=!!I[W].type;I[W].active=Q,I[W].index=Q?N++:void 0}),l(I)},F=(I,N)=>{if(I===N)return;const W={...a},Q=Object.keys(W).filter(O=>W[O].active).map(O=>({fieldName:O,index:W[O].index??0})).sort((O,ye)=>O.index-ye.index),[se]=Q.splice(I,1);Q.splice(N,0,se),Q.forEach((O,ye)=>{W[O.fieldName].index=ye}),l(W),$(W)};function $(I){const N=Object.keys(I).filter(O=>I[O]?.active).sort((O,ye)=>{const oe=I[O],Qe=I[ye];return oe.index!==void 0&&Qe.index!==void 0?oe.index-Qe.index:0}),W=Object.assign({},N),Q={0:C?.timeField.name??"",1:C?.bodyField.name??""},se={...e.panelState,columns:Object.keys(W).length?W:Q,refId:y.refId,visualisationType:"table",labelFieldName:C?.getLabelFieldName()??void 0};o(se)}const z=I=>{if(!a||!(I in a)){console.warn("failed to get column",a);return}const N=Object.keys(a).filter(se=>a[se].active).length,W=a[I].active?void 0:!0;let Q;if(W?Q={...a,[I]:{...a[I],active:W,index:N}}:Q={...a,[I]:{...a[I],active:!1,index:void 0}},v(I),l(Q),p){const se=!p[I]?.active;let O;se?O={...p,[I]:{...p[I],active:se,index:N}}:O={...p,[I]:{...p[I],active:!1,index:void 0}},f(O)}$(Q)},U=I=>{const N=I[0];let W={},Q=0;N.forEach(se=>{se in a&&(W[se]=a[se],Q++)}),f(W),L(Q)},M=I=>{So(Object.keys(a),I,U)},Y=I=>{const N=I.currentTarget?.value;g(N),N?M(N):f(void 0)},q=I=>{s.find(W=>W.refId===I.value)&&T(s.find(W=>W.refId===I.value)??s[0]),e.updatePanelState({refId:I.value,labelFieldName:C?.getLabelFieldName()??void 0})},G=Wr(e.theme,h,S),ue=(I,N,W)=>{const Q=Number(W.style.width.slice(0,-2));isNaN(Q)||E(Q)};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)("div",{children:s.length>1&&(0,t.jsx)("div",{children:(0,t.jsx)(Fe.I,{label:(0,d.t)("explore.logs-table-wrap.label-select-query","Select query"),htmlFor:"explore_logs_table_frame_selector",labelWidth:22,tooltip:(0,d.t)("explore.logs-table-wrap.tooltip-select-query-visualize-table","Select a query to visualize in the table"),children:(0,t.jsx)(Ve.l6,{inputId:"explore_logs_table_frame_selector","aria-label":(0,d.t)("explore.logs-table-wrap.aria-label-select-query-by-name","Select query by name"),value:y.refId,options:s.map(I=>({label:I.refId,value:I.refId})),onChange:q})})})}),(0,t.jsxs)("div",{className:G.wrapper,children:[(0,t.jsx)(zs.c,{enable:{right:!0},handleClasses:{right:G.rzHandle},onResize:ue,children:(0,t.jsxs)("section",{className:G.sidebar,children:[(0,t.jsx)(Ir,{value:x,onChange:Y}),(0,t.jsx)(Hr,{reorderColumn:F,toggleColumn:z,filteredColumnsWithMeta:p,columnsWithMeta:a,clear:j})]})}),(0,t.jsx)(Er.O,{logsFrame:C,onClickFilterLabel:e.onClickFilterLabel,onClickFilterOutLabel:e.onClickFilterOutLabel,logsSortOrder:e.logsSortOrder,range:e.range,splitOpen:e.splitOpen,timeZone:e.timeZone,width:w,dataFrame:y,columnsWithMeta:a,height:h})]})]})}const fs=(e,s)=>Math.ceil(100*e/s);function Wr(e,s,o){return{wrapper:(0,u.css)({display:"flex"}),sidebar:(0,u.css)({height:s,fontSize:e.typography.pxToRem(11),overflowY:"hidden",width:o,paddingRight:e.spacing(3)}),rzHandle:(0,u.css)({background:e.colors.secondary.main,[e.transitions.handleMotion("no-preference","reduce")]:{transition:"0.3s background ease-in-out"},position:"relative",height:"50% !important",width:`${e.spacing(1)} !important`,top:"25% !important",right:`${e.spacing(1)} !important`,cursor:"grab",borderRadius:e.shape.radius.pill,"&:hover":{background:e.colors.secondary.shade}})}}const To=()=>Math.max(window.innerHeight-500,500);var St=i(29457),Ro=i(92252);const Vr=({loading:e,loadMoreLogs:s,deduplicatedRows:o=[],range:n,splitOpen:r,onClickFilterLabel:a,onClickFilterOutLabel:l,panelState:p,datasourceType:f,updatePanelState:x,width:g,logsTableFrames:h,visualisationType:m,...y})=>{const{sortOrder:T}=(0,St.fl)(),b=(0,c.useMemo)(()=>new ss.o,[]),C=(0,P.$j)(),S=zr(C);return(0,t.jsxs)("div",{className:S.logRowsContainer,children:[(0,t.jsx)(Ro.V,{eventBus:b,visualisationType:m}),(0,t.jsx)("div",{className:S.logRows,"data-testid":"logRowsTable",children:(0,t.jsx)(jo,{logsSortOrder:T,range:n,splitOpen:r,timeZone:y.timeZone,width:g-45,logsFrames:h??[],onClickFilterLabel:a,onClickFilterOutLabel:l,panelState:p,theme:C,updatePanelState:x,datasourceType:f})})]})},zr=e=>({logRows:(0,u.css)({overflowY:"visible",width:"100%"}),logRowsContainer:(0,u.css)({display:"flex",flexDirection:"row-reverse"})});var Lo=i(17896),ms=i(20444),Qr=i(55439);const Ur=({deduplicatedRows:e,dedupStrategy:s,hasUnescapedContent:o,showLabels:n,showTime:r,logsMeta:a,logOptionsStorageKey:l,logsSortOrder:p,prettifyLogMessage:f,onLogOptionsChange:x,wrapLogMessage:g,...h})=>(0,t.jsxs)(St.vv,{app:h.app||$e.Jk.Unknown,displayedFields:[],dedupStrategy:s,hasUnescapedContent:o,logOptionsStorageKey:l,logs:e??[],logsMeta:a,prettifyJSON:f,showControls:!0,showTime:r,showUniqueLabels:n,sortOrder:p||ce.uH.Descending,onLogOptionsChange:x,wrapLogMessage:g,children:[h.visualisationType==="logs"&&(0,t.jsx)(Kr,{...h,deduplicatedRows:e}),h.visualisationType==="table"&&(0,t.jsx)(Vr,{...h})]}),Kr=({loading:e,loadMoreLogs:s,deduplicatedRows:o=[],range:n,...r})=>{const{app:a,dedupStrategy:l,filterLevels:p,forceEscape:f,prettifyJSON:x,sortOrder:g,showTime:h,showUniqueLabels:m,wrapLogMessage:y}=(0,St.fl)(),T=(0,c.useMemo)(()=>new ss.o,[]),b=(0,c.useRef)(null);(0,c.useEffect)(()=>{const S=T.subscribe(Qr._B,E=>Gr(E,b.current));return()=>S.unsubscribe()},[T]);const C=(0,c.useMemo)(()=>p.length===0?o:o.filter(S=>p.includes(S.logLevel)),[p,o]);return(0,t.jsxs)("div",{className:xs.logRowsContainer,children:[(0,t.jsx)(Ro.V,{eventBus:T}),(0,t.jsx)("div",{ref:b,className:V.$.featureToggles.logsInfiniteScrolling?xs.scrollableLogRows:xs.logRows,children:(0,t.jsx)(Lo.u8,{loading:e,loadMoreLogs:s,range:n,timeZone:r.timeZone,rows:C,scrollElement:b.current,sortOrder:g,children:(0,t.jsx)(ms.k,{...r,app:a,dedupStrategy:l,deduplicatedRows:C,forceEscape:f,logRows:C,logsSortOrder:g,scrollElement:b.current,prettifyLogMessage:!!x,showLabels:!!m,showTime:h,wrapLogMessage:y})})})]})};function Gr(e,s){e.payload.scrollTo==="top"?s?.scrollTo(0,0):s&&s.scrollTo(0,s.scrollHeight)}const xs={scrollableLogRows:(0,u.css)({overflowY:"scroll",width:"100%",maxHeight:"75vh"}),logRows:(0,u.css)({overflowX:"scroll",overflowY:"visible",width:"100%"}),logRowsContainer:(0,u.css)({display:"flex",flexDirection:"row-reverse"})};var qr=i(27789),Zr=i(94340),Ye=i(37234),Ut=i(7795),Yr=i(24162),jt=i(8535);function Jr(){(0,k.rR)("explore_toolbar_contentoutline_clicked",{item:"section",type:"Logs:pinned:pinned-log-added"})}function Xr(){(0,k.rR)("explore_toolbar_contentoutline_clicked",{item:"section",type:"Logs:pinned:pinned-log-deleted"})}function _r(){(0,k.rR)("explore_toolbar_contentoutline_clicked",{item:"section",type:"Logs:pinned:pinned-log-limit-reached"})}function ea(){(0,k.rR)("explore_toolbar_contentoutline_clicked",{item:"section",type:"Logs:pinned:pinned-log-clicked"})}function ta(){(0,k.rR)("explore_toolbar_contentoutline_clicked",{item:"section",type:"Logs:pinned:pinned-log-deleted"})}function sa(e){(0,k.rR)("explore_toolbar_contentoutline_clicked",{item:"section",type:`Logs:filter:${e}`})}var wo=i(55133);function oa({feedbackUrl:e}){const s=(0,P.of)(na);return(0,t.jsx)(A.B,{children:(0,t.jsxs)("a",{href:e,className:s.link,title:"The logs table is new, please let us know how we can improve it",target:"_blank",rel:"noreferrer noopener",children:[(0,t.jsx)(K.I,{name:"comment-alt-message"})," Give feedback"]})})}function na(e){return{link:(0,u.css)({color:e.colors.text.secondary,fontSize:e.typography.bodySmall.fontSize,":hover":{color:e.colors.text.link}})}}var Io=i(59896);const Eo=e=>({metaContainer:(0,u.css)({flex:1,color:e.colors.text.secondary,marginBottom:e.spacing(2),minWidth:"30%",display:"flex",flexWrap:"wrap"}),metaItem:(0,u.css)({marginRight:e.spacing(2),marginTop:e.spacing(.5),display:"flex",alignItems:"center",".logs-meta-item__error":{color:e.colors.error.text}}),metaLabel:(0,u.css)({marginRight:`calc(${e.spacing(2)} / 2)`,fontSize:e.typography.bodySmall.fontSize,fontWeight:e.typography.fontWeightMedium,whiteSpace:"nowrap"}),metaValue:(0,u.css)({fontFamily:e.typography.fontFamilyMonospace,fontSize:e.typography.bodySmall.fontSize})}),ra=(0,c.memo)(function(s){const o=(0,P.of)(Eo),{label:n,value:r}=s;return(0,t.jsxs)("div",{"data-testid":"meta-info-text-item",className:o.metaItem,children:[n&&(0,t.jsxs)("span",{className:o.metaLabel,children:[n,":"]}),(0,t.jsx)("span",{className:o.metaValue,children:r})]})}),ys=(0,c.memo)(function(s){const o=(0,P.of)(Eo),{metaItems:n}=s;return(0,t.jsx)("div",{className:o.metaContainer,"data-testid":"meta-info-text",children:n.map((r,a)=>(0,t.jsx)(ra,{label:r.label,value:r.value},`${a}-${r.label}`))})});var de=i(70159);const aa=()=>({metaContainer:(0,u.css)({flex:1,display:"flex",flexWrap:"wrap","& span":{fontWeight:"normal",lineHeight:"1.25em"}})}),Oo=(0,c.memo)(({meta:e,dedupStrategy:s,dedupCount:o,displayedFields:n,clearDetectedFields:r,logRows:a})=>{const l=(0,P.of)(aa),p=[...e];s!==ce.fY.none&&p.push({label:"Deduplication count",value:o,kind:ie.tG.Number}),n?.length>0&&p.push({label:"Showing only selected fields",value:(0,t.jsx)(Io.A,{labels:n})},{label:"",value:(0,t.jsx)(B.$n,{variant:"primary",fill:"outline",size:"sm",onClick:r,children:(0,t.jsx)(d.x6,{i18nKey:"explore.logs-meta-row.show-original-line",children:"Show original line"})})});function f(m){(0,k.rR)("grafana_logs_download_logs_clicked",{app:$e.Jk.Explore,format:m,area:"logs-meta-row"}),(0,xe.K7)(m,a,e)}const x=(0,t.jsxs)(ze.W,{children:[(0,t.jsx)(ze.W.Item,{label:"txt",onClick:()=>f(xe.s.Text)}),(0,t.jsx)(ze.W.Item,{label:"json",onClick:()=>f(xe.s.Json)}),(0,t.jsx)(ze.W.Item,{label:"csv",onClick:()=>f(xe.s.CSV)})]}),h={onDisplayMaxToggle:m=>{ot.M.set(de.$Z.commonLabels,m)},displayMax:3,displayAll:ot.M.getBool(de.$Z.commonLabels,!1)};return(0,t.jsx)(t.Fragment,{children:p&&(0,t.jsxs)("div",{className:l.metaContainer,children:[(0,t.jsx)(ys,{metaItems:p.map(m=>({label:m.label,value:"kind"in m?ia(m.value,m.kind,h):m.value}))}),!V.$.featureToggles.logsPanelControls&&!V.$.exploreHideLogsDownload&&(0,t.jsx)(Ct.m,{overlay:x,children:(0,t.jsx)(me.I,{isOpen:!1,variant:"canvas",icon:"download-alt",children:(0,t.jsx)(d.x6,{i18nKey:"explore.logs-meta-row.download",children:"Download"})})})]})})});Oo.displayName="LogsMetaRow";function ia(e,s,o){return typeof e=="string"||typeof e=="number"?(0,t.jsx)(t.Fragment,{children:e}):s===ie.tG.LabelsMap?(0,t.jsx)(Io.h,{labels:e,...o}):s===ie.tG.Error?(0,t.jsx)("span",{className:"logs-meta-item__error",children:e.toString()}):(console.error(`Meta type ${typeof e} ${e} not recognized.`),(0,t.jsx)(t.Fragment,{}))}var vs=i(68079),la=i(31937),ca=i(5421);function da({pages:e,currentPageIndex:s,oldestLogsFirst:o,timeZone:n,loading:r,onClick:a}){const l=g=>`${(0,go.LE)(g,{format:ca.WC.interval.second,timeZone:n})}`,p=(g,h)=>{if(s===h&&r)return(0,t.jsx)(vs.y,{});const m=l(o?g.logsRange.from:g.logsRange.to),y=l(o?g.logsRange.to:g.logsRange.from);return`${m} \u2014 ${y}`},f=(0,P.$j)(),x=ua(f,r);return(0,t.jsx)(os.P,{children:(0,t.jsx)("div",{className:x.pagesWrapper,"data-testid":"logsNavigationPages",children:(0,t.jsx)("div",{className:x.pagesContainer,children:e.map((g,h)=>(0,t.jsxs)("button",{type:"button","data-testid":`page${h+1}`,className:(0,u.cx)((0,B.my)(f),x.page),onClick:()=>{a(g,h+1)},disabled:r,children:[(0,t.jsx)("div",{className:(0,u.cx)(x.line,{selectedBg:s===h})}),(0,t.jsx)("div",{className:(0,u.cx)(x.time,{selectedText:s===h}),children:p(g,h)})]},g.queryRange.to))})})})}const ua=(e,s)=>({pagesWrapper:(0,u.css)({height:"100%",paddingLeft:e.spacing(.5),display:"flex",flexDirection:"column","&::after":{content:"''",display:"block",background:`repeating-linear-gradient(135deg, ${e.colors.background.primary}, ${e.colors.background.primary} 5px, ${e.colors.background.secondary} 5px, ${e.colors.background.secondary} 15px)`,width:"3px",height:"inherit",marginBottom:e.spacing(1)}}),pagesContainer:(0,u.css)({display:"flex",padding:0,flexDirection:"column"}),page:(0,u.css)({display:"flex",margin:e.spacing(2,0),cursor:s?"auto":"pointer",whiteSpace:"normal",".selectedBg":{background:e.colors.primary.main},".selectedText":{color:e.colors.primary.main}}),line:(0,u.css)({width:"3px",height:"100%",alignItems:"center",background:e.colors.text.secondary}),time:(0,u.css)({width:"60px",minHeight:"80px",fontSize:e.v1.typography.size.sm,paddingLeft:e.spacing(.5),display:"flex",alignItems:"center"})});function pa({absoluteRange:e,logsSortOrder:s,timeZone:o,loading:n,onChangeTime:r,scrollToTopLogs:a,scrollToBottomLogs:l,visibleRange:p,queries:f,clearCache:x,addResultsToCache:g}){const[h,m]=(0,c.useState)([]),y=(0,c.useRef)(),T=(0,c.useRef)(),b=(0,c.useRef)(0),C=(0,c.useMemo)(()=>h.findIndex(q=>q.queryRange.to===e.to),[e.to,h]),S=s===ce.uH.Ascending,E=S?C===h.length-1:C===0,w=S?C===0:C===h.length-1,v=(0,P.$j)(),L=ha(v,S);(0,c.useEffect)(()=>{const q={logsRange:p,queryRange:e};let G=[];!(0,ne.isEqual)(T.current,e)||!(0,ne.isEqual)(y.current,f)?(x(),m([q]),y.current=f,b.current=e.to-e.from):m(ue=>(G=ue.filter(I=>!(0,ne.isEqual)(q.queryRange,I.queryRange)),G=[...G,q].sort((I,N)=>F(I,N,s)),G))},[p,e,s,f,x,g]);const j=(0,c.useCallback)(({from:q,to:G})=>{g(),T.current={from:q,to:G},r({from:q,to:G})},[r,g]),F=(q,G,ue)=>ue===ce.uH.Ascending?q.queryRange.to>G.queryRange.to?1:-1:q.queryRange.to>G.queryRange.to?-1:1,$=(0,t.jsx)(B.$n,{"data-testid":"olderLogsButton",className:L.navButton,variant:"secondary",onClick:()=>{if((0,k.rR)("grafana_explore_logs_pagination_clicked",{pageType:"olderLogsButton"}),w)j({from:p.from-b.current,to:p.from});else{const q=S?-1:1;j({from:h[C+q].queryRange.from,to:h[C+q].queryRange.to})}a()},disabled:n,children:(0,t.jsxs)("div",{className:L.navButtonContent,children:[n?(0,t.jsx)(vs.y,{}):(0,t.jsx)(K.I,{name:S?"angle-up":"angle-down",size:"lg"}),(0,t.jsx)(d.x6,{i18nKey:"logs.logs-navigation.older-logs",children:"Older logs"})]})}),z=(0,t.jsx)(B.$n,{"data-testid":"newerLogsButton",className:L.navButton,variant:"secondary",onClick:()=>{if((0,k.rR)("grafana_explore_logs_pagination_clicked",{pageType:"newerLogsButton"}),!E){const q=S?1:-1;j({from:h[C+q].queryRange.from,to:h[C+q].queryRange.to})}a()},disabled:n||E,children:(0,t.jsxs)("div",{className:L.navButtonContent,children:[n&&(0,t.jsx)(vs.y,{}),E||n?null:(0,t.jsx)(K.I,{name:S?"angle-down":"angle-up",size:"lg"}),E?(0,d.t)("logs.logs-navigation.start-of-range","Start of range"):(0,d.t)("logs.logs-navigation.newer-logs","Newer logs")]})}),U=(0,c.useCallback)((q,G)=>{(0,k.rR)("grafana_explore_logs_pagination_clicked",{pageType:"page",pageNumber:G}),j({from:q.queryRange.from,to:q.queryRange.to}),a()},[j,a]),M=(0,c.useCallback)(()=>{(0,k.rR)("grafana_explore_logs_scroll_top_clicked"),a()},[a]),Y=(0,c.useCallback)(()=>{(0,k.rR)("grafana_explore_logs_scroll_bottom_clicked"),l?.()},[l]);return(0,t.jsxs)("div",{className:L.navContainer,children:[!V.$.featureToggles.logsInfiniteScrolling&&(0,t.jsxs)(t.Fragment,{children:[S?$:z,(0,t.jsx)(da,{pages:h,currentPageIndex:C,oldestLogsFirst:S,timeZone:o,loading:n,onClick:U}),S?z:$]}),l&&(0,t.jsx)(B.$n,{"data-testid":"scrollToBottom",className:L.scrollToBottomButton,variant:"secondary",onClick:Y,title:(0,d.t)("logs.logs-navigation.scroll-bottom","Scroll to bottom"),children:(0,t.jsx)(K.I,{name:"arrow-down",size:"lg"})}),(0,t.jsx)(B.$n,{"data-testid":"scrollToTop",className:L.scrollToTopButton,variant:"secondary",onClick:M,title:(0,d.t)("logs.logs-navigation.scroll-top","Scroll to top"),children:(0,t.jsx)(K.I,{name:"arrow-up",size:"lg"})})]})}const ga=(0,c.memo)(pa),ha=(e,s)=>{const o=`calc(100vh - 2*${e.spacing(2)} - 2*${(0,la.vn)()}px)`;return{navContainer:(0,u.css)({maxHeight:o,width:s&&!V.$.featureToggles.newLogsPanel?"58px":"auto",display:"flex",flexDirection:"column",justifyContent:V.$.featureToggles.logsInfiniteScrolling?"flex-end":s?"flex-start":"space-between",position:"sticky",top:e.spacing(2),right:0}),navButton:(0,u.css)({width:"58px",height:"68px",display:"flex",flexDirection:"column",justifyContent:"center",alignItems:"center",lineHeight:1}),navButtonContent:(0,u.css)({display:"flex",flexDirection:"column",justifyContent:"center",alignItems:"center",width:"100%",height:"100%",whiteSpace:"normal"}),scrollToBottomButton:(0,u.css)({width:"40px",height:"40px",display:"flex",flexDirection:"column",justifyContent:"center",alignItems:"center",position:"absolute",top:0}),scrollToTopButton:(0,u.css)({width:"40px",height:"40px",display:"flex",flexDirection:"column",justifyContent:"center",alignItems:"center",marginTop:e.spacing(1)})}},fa=100;function Kt(e){const[s,o]=(0,c.useState)(!1),[n,r]=(0,c.useState)(!1),{dismissable:a,error:l,title:p,suggestedAction:f,onSuggestedAction:x,onRemove:g,severity:h="warning"}=e,m=e.message??l?.message??l?.data?.message??"",y=typeof m=="string"&&m.length>fa,T=(0,P.$j)(),b=ma(T),C=(0,c.useCallback)(()=>{r(!0)},[]),S=a?C:g;return n?null:(0,t.jsx)("div",{className:b.supplementaryErrorContainer,children:(0,t.jsx)(nt.F,{title:p,severity:h,onRemove:S,children:y?(0,t.jsx)("div",{className:b.messageWrapper,children:s?m:(0,t.jsx)(B.$n,{variant:"secondary",size:"xs",onClick:()=>{o(!0)},children:(0,t.jsx)(d.x6,{i18nKey:"explore.supplementary-result-error.show-details",children:"Show details"})})}):(0,t.jsxs)("div",{className:`${b.messageWrapper} ${b.suggestedActionWrapper}`,children:[m,f&&x&&(0,t.jsx)(B.$n,{variant:"primary",size:"xs",onClick:x,children:f})]})})})}const ma=e=>({supplementaryErrorContainer:(0,u.css)({width:"60%",minWidth:`${e.breakpoints.values.sm}px`,maxWidth:`${e.breakpoints.values.md}px`,margin:"0 auto"}),messageWrapper:(0,u.css)({minHeight:e.spacing(3),ul:{paddingLeft:e.spacing(2)},button:{position:"absolute",bottom:e.spacing(2),right:e.spacing(2)}}),suggestedActionWrapper:(0,u.css)({paddingBottom:e.spacing(5)})});var xa=i(97486);function ya(e){const{width:s,timeZone:o,splitOpen:n,onUpdateTimeRange:r,onHiddenSeriesChanged:a,allLogsVolumeMaximum:l,toggleLegendRef:p}=e,f=(0,P.$j)(),x=(0,P.of)(va),g=parseInt(f.spacing(2).slice(0,-2),10),h=150,m=e.logsVolumeData,y=(0,xe.Dm)(m?.data);let T=y?`${y.name}`:"";(0,xe.e3)(m.data)&&(T=[T,"This datasource does not support full-range histograms. The graph below is based on the logs seen in the response."].filter(ne.identity).join(". "));let b=(0,t.jsx)("span",{children:T});return m.state===be.Gu.Streaming&&(b=(0,t.jsxs)(t.Fragment,{children:[b,(0,t.jsx)(J.m,{content:"Streaming",children:(0,t.jsx)(K.I,{name:"circle-mono",size:"md",className:x.streaming,"data-testid":"logs-volume-streaming"})})]})),(0,t.jsxs)("div",{style:{height:h},className:x.contentContainer,children:[(0,t.jsx)(xa.k,{toggleLegendRef:p,vizLegendOverrides:{calcs:["sum"]},graphStyle:"lines",loadingState:m.state??be.Gu.Done,data:m.data,height:h,width:s-g*2,timeRange:e.timeRange,onChangeTime:r,timeZone:o,splitOpenFn:n,tooltipDisplayMode:ce.$N.Multi,onHiddenSeriesChanged:a,anchorToZero:!0,yAxisMaximum:l,eventBus:e.eventBus,annotations:e.annotations}),b&&(0,t.jsx)("div",{className:x.extraInfoContainer,children:b})]})}const va=e=>({extraInfoContainer:(0,u.css)({display:"flex",justifyContent:"end",position:"absolute",right:"5px",top:"-10px",fontSize:e.typography.bodySmall.fontSize,color:e.colors.text.secondary}),contentContainer:(0,u.css)({display:"flex",alignItems:"center",justifyContent:"center",position:"relative"}),streaming:(0,u.css)({color:e.colors.success.text})});function ba(e){return!e||!e.error&&!e.errors?!1:(e.error?[e.error]:e.errors||[]).some(o=>(`${o.message||o.data?.message}`?.toLowerCase()).includes("timeout"))}const Ca=({logsVolumeData:e,absoluteRange:s,onUpdateTimeRange:o,width:n,onLoadLogsVolume:r,onHiddenSeriesChanged:a,eventBus:l,splitOpen:p,timeZone:f,onClose:x,toggleLegendRef:g})=>{const{logVolumes:h,maximumValue:m,maximumRange:y,annotations:T}=(0,c.useMemo)(()=>{let F=-1/0;const $=e?.data.filter(G=>G.meta?.dataTopic!==ce.QR.Annotations),z=e?.data.filter(G=>G.meta?.dataTopic===ce.QR.Annotations)||[],U=(0,ne.sortBy)($||[],"meta.custom.datasourceName"),M=(0,ne.groupBy)(U,"meta.custom.datasourceName"),Y=(0,ne.mapValues)(M,G=>{const ue=(0,xe.oT)(G);return F=Math.max(F,ue.maximum),ue.dataFrames}),q=(0,xe.Dx)((0,ne.flatten)(Object.values(Y)));return{maximumValue:F,maximumRange:q,logVolumes:Y,annotations:z}},[e]),b=(0,P.of)(Sa),C=Object.keys(h).length,S=Object.values(h).some(F=>{const $=ja(F,s);return!(0,xe.e3)(F)&&$&&$<1}),E=V.$.featureToggles.lokiShardSplitting&&e&&e.data.length>0,w=ba(e),v=(0,at.KQ)(Math.max(s.from,y.from)),L=(0,at.KQ)(Math.min(s.to,y.to)),j={from:v,to:L,raw:{from:v,to:L}};return e?.state===be.Gu.Loading?(0,t.jsx)("span",{children:(0,t.jsx)(d.x6,{i18nKey:"explore.logs-volume-panel-list.loading",children:"Loading..."})}):w&&!E?(0,t.jsx)(Kt,{title:(0,d.t)("explore.logs-volume-panel-list.title-unable-to-show-log-volume","Unable to show log volume"),message:(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)("p",{children:(0,t.jsx)(d.x6,{i18nKey:"explore.logs.logs-volume.much-data",children:"The query is trying to access too much data. Try one or more of the following:"})}),(0,t.jsxs)("ul",{children:[(0,t.jsx)("li",{children:(0,t.jsx)(d.x6,{i18nKey:"explore.logs.logs-volume.add-filters",children:"Add more labels to your query to narrow down your search."})}),(0,t.jsx)("li",{children:(0,t.jsx)(d.x6,{i18nKey:"explore.logs.logs-volume.decrease-timerange",children:"Decrease the time range of your query."})})]})]}),severity:"info",suggestedAction:"Retry",onSuggestedAction:r,onRemove:x}):e?.error!==void 0&&!E?(0,t.jsx)(Kt,{error:e.error,title:(0,d.t)("explore.logs-volume-panel-list.title-failed-volume-query","Failed to load log volume for this query")}):C===0&&e?.state!==be.Gu.Streaming?(0,t.jsx)("div",{className:b.alertContainer,children:(0,t.jsx)(nt.F,{severity:"info",title:(0,d.t)("explore.logs-volume-panel-list.title-no-logs-volume-available","No logs volume available"),children:"No volume information available for the current queries and time range."})}):(0,t.jsxs)("div",{className:b.listContainer,children:[w&&E&&(0,t.jsx)(Kt,{title:(0,d.t)("explore.logs-volume-panel-list.title-showing-partial-data","Showing partial data"),message:"The query is trying to access too much data and some sharded requests could not be completed. Try decreasing the time range or adding more labels to your query.",severity:"info",dismissable:!0}),Object.keys(h).map((F,$)=>(0,t.jsx)(ya,{toggleLegendRef:g,timeRange:j,allLogsVolumeMaximum:m,width:n,logsVolumeData:{data:h[F],state:e?.state},onUpdateTimeRange:o,timeZone:f,splitOpen:p,onLoadLogsVolume:r,onHiddenSeriesChanged:C>1?()=>{}:a,eventBus:l,annotations:T},$)),S&&(0,t.jsx)("div",{className:b.extraInfoContainer,children:(0,t.jsx)(Fe.I,{label:(0,d.t)("explore.logs-volume-panel-list.label-reload-log-volume","Reload log volume"),transparent:!0,children:(0,t.jsx)(B.$n,{size:"xs",icon:"sync",variant:"secondary",onClick:r,id:"reload-volume"})})})]})},Sa=e=>({listContainer:(0,u.css)({paddingTop:"10px"}),extraInfoContainer:(0,u.css)({display:"flex",justifyContent:"end",position:"absolute",right:"5px",top:"5px"}),oldInfoText:(0,u.css)({fontSize:e.typography.bodySmall.fontSize,color:e.colors.text.secondary}),alertContainer:(0,u.css)({width:"50%",minWidth:`${e.breakpoints.values.sm}px`,margin:"0 auto"})});function ja(e,s){const o=e&&e[0]&&e[0].meta?.custom?.absoluteRange;return o?(s.from-s.to)/(o.from-o.to):void 0}const Ta=[ce.fY.none,ce.fY.exact,ce.fY.numbers,ce.fY.signature],bs=()=>{const e=he.A.get(de.r3);return e==="table"?"table":e==="logs"?"logs":V.$.featureToggles.logsExploreTableDefaultVisualization?"table":"logs"},Gt=10,Cs="Pinned log",Fo="Pin to content outline",ct="Logs",Ra=e=>{const{width:s,splitOpen:o,logRows:n,logsMeta:r,logsVolumeEnabled:a,logsVolumeData:l,loadLogsVolumeData:p,loading:f=!1,onClickFilterLabel:x,onClickFilterOutLabel:g,timeZone:h,scanning:m,scanRange:y,showContextToggle:T,absoluteRange:b,onChangeTime:C,getFieldLinks:S,theme:E,logsQueries:w,clearCache:v,addResultsToCache:L,exploreId:j,getRowContext:F,getLogRowContextUi:$,getRowContextQuery:z,loadMoreLogs:U,panelState:M,eventBus:Y,onPinLineCallback:q,scrollElement:G}=e,[ue,I]=(0,c.useState)(he.A.getBool(de.$Z.showLabels,!1)),[N,W]=(0,c.useState)(he.A.getBool(de.$Z.showTime,!0)),[Q,se]=(0,c.useState)(he.A.getBool(de.$Z.wrapLogMessage,!0)),[O,ye]=(0,c.useState)(he.A.getBool(de.$Z.prettifyLogMessage,!1)),[oe,Qe]=(0,c.useState)(ce.fY.none),[ae,pe]=(0,c.useState)([]),[Ue,Ll]=(0,c.useState)(he.A.get(de.$Z.logsSortOrder)||ce.uH.Descending),[wl,Zo]=(0,c.useState)(!1),[Re,Zt]=(0,c.useState)([]),[Il,Yo]=(0,c.useState)(!1),[_e,Jo]=(0,c.useState)(void 0),[Os,Xo]=(0,c.useState)(Fo),[ve,_o]=(0,c.useState)(M?.logs?.visualisationType??bs()),Ie=(0,c.useRef)(null),Ke=(0,D.useDispatch)(),en=(0,jr.A)(f),El=Y.newScopedBus("logsvolume",{onlyLocal:!1}),{register:Lt,unregister:Fs,outlineItems:dt,updateItem:Ds,unregisterAllChildren:As}=rs()??{},Ns=(0,c.useRef)(void 0),Ps=(0,c.useRef)(void 0),ut=(0,c.useRef)(()=>{}),ks=(0,c.useRef)(null),Yt=(0,c.useRef)(null),Ol=To(),ee=wa(E,Q||ve==="table",Ol),wt=n&&n.length>0,Fl=y?`Scanning ${Tr.describeTimeRange(y)}`:"Scanning...",tn=dt?.find(R=>R.panelId===ct&&R.level==="root"),It=(0,c.useMemo)(()=>tn?.children?.filter(R=>R.title===Cs).map(R=>R.id),[tn?.children]),Et=(0,c.useCallback)(()=>dt?.find(H=>H.panelId===ct&&H.level==="root")?.children?.filter(H=>H.title===Cs).length??0,[dt]),sn=(0,c.useCallback)(()=>{const R=Object.keys(Ye.cZ),H=new Set(l?.data),te=l?.data.filter(Ce=>Ce.meta?.dataTopic!==ce.QR.Annotations),le=(0,ne.groupBy)(te,"meta.custom.datasourceName"),ge=Object.keys(le).length;As&&As(Ce=>Ce?.find(Xt=>Xt.panelId===ct&&Xt.level==="root")?.id,"filter");const Ee=[];H.forEach(Ce=>{const{level:gt}=(0,xe.tX)(Ce,l?.data??[]);Ee.push((0,xe.EK)(gt))});const Zl=Ee.sort((Ce,gt)=>R.indexOf(Ce)>R.indexOf(gt)?1:-1),Ws=new Set(Zl);Yt.current=Array.from(Ws),Ws.size>1&&a&&ge===1&&Ws.forEach(Ce=>{const gt=ae.length===0,Xt=!ae.find(Vs=>Vs===Ce);Lt&&Lt({title:Ce,icon:"gf-logs",panelId:ct,level:"child",type:"filter",highlight:Xt&&!gt,onClick:Vs=>{ut.current?.(Ce,(0,Lr.W)(Vs)),sa(Ce)},ref:null,color:Ye.cZ[Ce]})})},[l?.data,As,a,ae,Lt,ut]);(0,c.useEffect)(()=>{Et()===Gt?Xo((0,t.jsxs)("span",{style:{display:"flex",textAlign:"center"},children:["\u2757\uFE0F",(0,t.jsxs)(d.x6,{i18nKey:"explore.logs.maximum-pinned-logs",children:["Maximum of ",{PINNED_LOGS_LIMIT:Gt}," pinned logs reached. Unpin a log to add another."]})]})):Xo(Fo)},[dt,Et]),(0,c.useEffect)(()=>{f&&!en&&M?.logs?.id&&(delete M.logs.id,Ke((0,Me.EA)(j,"logs",{...M})))},[Ke,j,f,M,en]),(0,c.useEffect)(()=>{const R=M?.logs?.visualisationType??bs();_o(R),he.A.set(de.r3,R)},[M?.logs?.visualisationType]),(0,c.useEffect)(()=>{let R=[];Array.isArray(M?.logs?.displayedFields)?R=M?.logs?.displayedFields:M?.logs?.displayedFields&&typeof M?.logs?.displayedFields=="object"&&(R=Object.values(M?.logs?.displayedFields)),Zt(R)},[M?.logs?.displayedFields]),(0,c.useEffect)(()=>{sn()},[l?.data,ae,sn]),(0,ft.A)(()=>{Ns&&window.clearTimeout(Ns.current),Ps&&window.clearTimeout(Ps.current)}),(0,ft.A)(()=>{(M?.logs?.columns||M?.logs?.refId||M?.logs?.labelFieldName||M?.logs?.displayedFields)&&Ke((0,Me.EA)(j,"logs",{...M?.logs,columns:void 0,visualisationType:ve,labelFieldName:void 0,refId:void 0,displayedFields:void 0}))});const Ae=(0,c.useCallback)(R=>{const H=(0,jt.Gu)().explore.panes[j];H?.panelsState&&Ke((0,Me.EA)(j,"logs",{...H.panelsState.logs,columns:R.columns??M?.logs?.columns,visualisationType:R.visualisationType??ve,labelFieldName:R.labelFieldName,refId:R.refId??M?.logs?.refId,displayedFields:R.displayedFields??M?.logs?.displayedFields}))},[Ke,j,M?.logs?.columns,M?.logs?.displayedFields,M?.logs?.refId,ve]),Ms=(0,c.useCallback)(R=>{R?e.eventBus.publish(new fo.b_({point:{time:R.timeEpochMs}})):e.eventBus.publish(new fo.ql)},[e.eventBus]),on=(0,c.useCallback)(R=>{if(V.$.featureToggles.logsInfiniteScrolling){Ie.current&&(ks.current?.scrollIntoView(),Ie.current.scroll({behavior:"smooth",top:Ie.current.scrollTop+R.getBoundingClientRect().top-window.innerHeight/2}));return}G&&G.scroll({behavior:"smooth",top:G.scrollTop+R.getBoundingClientRect().top-window.innerHeight/2})},[G]),Jt=(0,c.useCallback)(R=>{if(!w)return;let H=!1;const te=w.map(le=>{if(le.datasource?.type!=="loki"||!(0,Yr.kr)(le)||le.direction===Ut.ti.Scan)return le;H=!0;const ge=R===ce.uH.Ascending?Ut.ti.Forward:Ut.ti.Backward;return ge!==le.direction&&(le.direction=ge),le});H&&(Ke((0,Z.bO)({exploreId:j,queries:te})),Ke((0,Z.Od)({exploreId:j})))},[Ke,j,w]),Dl=(0,c.useCallback)(R=>{Zo(!0),Ns.current=window.setTimeout(()=>{he.A.set(de.$Z.logsSortOrder,R),Jt(R),Ll(R)},0),Ps.current=window.setTimeout(()=>Zo(!1),1e3)},[Jt]),Al=(0,c.useCallback)(R=>{_o(R);const H={...M?.logs,visualisationType:R};Ae(H),(0,k.rR)("grafana_explore_logs_visualisation_changed",{newVisualizationType:R,datasourceType:e.datasourceType??"unknown",defaultVisualisationType:V.$.featureToggles.logsExploreTableDefaultVisualization?"table":"logs"})},[M?.logs,e.datasourceType,Ae]),Nl=(0,c.useCallback)(R=>{(0,k.rR)("grafana_explore_logs_deduplication_clicked",{deduplicationType:R,datasourceType:e.datasourceType}),Qe(R)},[e.datasourceType]),Pl=(0,c.useCallback)(R=>{const{target:H}=R;if(H){const te=H.checked;I(te),he.A.set(de.$Z.showLabels,te)}},[]),kl=(0,c.useCallback)(R=>{const{target:H}=R;if(H){const te=H.checked;W(te),he.A.set(de.$Z.showTime,te)}},[]),Ml=(0,c.useCallback)(R=>{const{target:H}=R;if(H){const te=H.checked;se(te),he.A.set(de.$Z.wrapLogMessage,te)}},[]),Bl=(0,c.useCallback)(R=>{const{target:H}=R;if(H){const te=H.checked;ye(te),he.A.set(de.$Z.prettifyLogMessage,te)}},[]),Hl=(0,c.useCallback)(R=>{const H=R.map(xe.EK);pe(H)},[]),nn=(0,c.useCallback)(R=>{e.onSetLogsVolumeEnabled(!R),(0,k.rR)("grafana_explore_logs_histogram_toggle_clicked",{datasourceType:e.datasourceType,type:R?"close":"open"})},[e]),$l=(0,c.useCallback)(R=>{R.preventDefault(),e.onStartScanning&&(e.onStartScanning(),(0,k.rR)("grafana_explore_logs_scanning_button_clicked",{type:"start",datasourceType:e.datasourceType}))},[e]),Wl=(0,c.useCallback)(R=>{R.preventDefault(),e.onStopScanning&&e.onStopScanning()},[e]),rn=(0,c.useCallback)(R=>{if(Re.indexOf(R)===-1){const te=Re.concat(R);Zt(te),Ae({...M?.logs,displayedFields:te})}},[Re,M?.logs,Ae]),an=(0,c.useCallback)(R=>{if(Re.indexOf(R)>-1){const te=Re.filter(le=>R!==le);Zt(te),Ae({...M?.logs,displayedFields:te})}},[Re,M?.logs,Ae]),Vl=(0,c.useCallback)(()=>{Ae({...M?.logs,displayedFields:[]}),Zt([])},[M?.logs,Ae]),Bs=(0,c.useRef)(()=>{});let zl=(0,c.useCallback)(()=>{Yo(!1),Jo(void 0),(0,k.rR)("grafana_explore_logs_log_context_closed",{datasourceType:_e?.datasourceType,logRowUid:_e?.uid}),Bs?.current()},[_e?.datasourceType,_e?.uid,Bs]);const Ot=(0,c.useCallback)((R,H)=>{Yo(!0),Jo(R),(0,k.rR)("grafana_explore_logs_log_context_opened",{datasourceType:R.datasourceType,logRowUid:R.uid}),Bs.current=H},[]),Hs=(0,c.useCallback)(async R=>{if(R.rowId===void 0)return;const H=(0,wo.m)((0,jt.Gu)().explore.panes[j]);H.panelsState={...M,logs:{id:R.uid,visualisationType:ve??bs(),displayedFields:Re}},H.range=(0,Vt.sU)(R,n,b);const te=(0,mo.Pp)(H),le=/.*(?=\/explore)/.exec(`${window.location.href}`)[0],ge=mo.kM.renderUrl(`${le}/explore`,{left:te});await(0,Vt.VP)(ge),(0,k.rR)("grafana_explore_logs_permalink_clicked",{datasourceType:R.datasourceType??"unknown",logRowUid:R.uid,logRowLevel:R.logLevel})},[b,Re,j,n,M,ve]),Ql=(0,c.useCallback)(()=>{V.$.featureToggles.logsInfiniteScrolling&&Ie.current&&Ie.current.scroll({behavior:"auto",top:0}),ks.current?.scrollIntoView()},[]),pt=(0,c.useCallback)((R,H=!0)=>{if(Et()===Gt&&!H){_r();return}const te=dt?.find(ge=>ge.panelId===ct&&ge.level==="root");te&&Ds&&Ds(te.id,{expanded:!0});const le=It?.find(ge=>ge===R.rowId);le&&R.rowId&&H?(Fs?.(R.rowId),Xr()):Et()!==Gt&&!le&&(Lt?.({id:R.rowId,icon:"gf-logs",title:Cs,panelId:ct,level:"child",ref:null,color:Ye.cZ[R.logLevel],childOnTop:!0,onClick:()=>{Ot(R,()=>{}),ea()},onRemove:ge=>{Fs?.(ge),ta()}}),Jr()),q?.()},[Et,Ot,q,dt,It,Lt,Fs,Ds]),Ul=(0,c.useMemo)(()=>Ia(n),[n]),ln=(0,c.useMemo)(()=>Oa(n,ae),[ae,n]),{dedupedRows:$s,dedupCount:Kl}=(0,c.useMemo)(()=>Ea(ln,oe),[oe,ln]),Gl=(0,c.useMemo)(()=>Fa(n),[n]),cn=(0,c.useMemo)(()=>!w?.some(R=>"direction"in R&&R.direction===Ut.ti.Scan),[w]),dn=(0,c.useCallback)((R,H)=>{if(R==="sortOrder"&&(0,St.Q4)(H))Jt(H);else if(R==="filterLevels"&&Array.isArray(H)){if(H.length===0){pe([]);return}const te=Yt.current??Object.keys(Ye.cZ).map(xe.EK);if(ae.length===0){ut.current?.(H[0],gs.B.ToggleSelection),pe(te.filter(Ee=>Ee!==H[0]));return}const le=H.find(Ee=>ae.includes((0,xe.EK)(Ee))),ge=te.find(Ee=>!H.includes(Ee)&&!ae.includes(Ee));if(le){ut.current?.(le,gs.B.AppendToSelection),pe(ae.filter(Ee=>Ee===le));return}else ge&&(ut.current?.(ge,gs.B.AppendToSelection),pe([...ae,ge]))}else R==="dedupStrategy"&&(0,St.KB)(H)&&Qe(H)},[ae,Jt]),ql=(0,c.useMemo)(()=>Yt.current?Yt.current.filter(R=>ae.length>0&&!ae.includes(R)):void 0,[ae]);return(0,t.jsxs)(t.Fragment,{children:[F&&_e&&(0,t.jsx)(qr.V,{open:Il,row:_e,onClose:zl,getRowContext:(R,H)=>F(R,_e,H),getRowContextQuery:z,getLogRowContextUi:$,logsSortOrder:Ue,timeZone:h}),(0,t.jsx)(He.NR,{title:(0,d.t)("explore.unthemed-logs.title-logs-volume","Logs volume"),collapsible:!0,collapsed:!a,onToggleCollapse:nn,children:a&&(0,t.jsx)(Ca,{toggleLegendRef:ut,absoluteRange:b,width:s,logsVolumeData:l,onUpdateTimeRange:C,timeZone:h,splitOpen:o,onLoadLogsVolume:p,onHiddenSeriesChanged:Hl,eventBus:El,onClose:()=>nn(!0)})}),(0,t.jsxs)(He.NR,{titleItems:[V.$.featureToggles.logsExploreTableVisualisation?ve==="logs"?null:(0,t.jsx)(He.NR.TitleItem,{title:(0,d.t)("explore.unthemed-logs.title-feedback","Feedback"),children:(0,t.jsx)(oa,{feedbackUrl:"https://forms.gle/5YyKdRQJ5hzq4c289"})},"A"):null],title:(0,d.t)("explore.unthemed-logs.title-logs","Logs"),actions:(0,t.jsx)(t.Fragment,{children:V.$.featureToggles.logsExploreTableVisualisation&&(0,t.jsx)("div",{className:ee.visualisationType,children:(0,t.jsx)(Qt.z,{className:ee.visualisationTypeRadio,options:[{label:"Logs",value:"logs",description:"Show results in logs visualisation"},{label:"Table",value:"table",description:"Show results in table visualisation"}],size:"sm",value:ve,onChange:Al})})}),loadingState:f?be.Gu.Loading:be.Gu.Done,children:[(0,t.jsxs)("div",{className:ee.stickyNavigation,children:[ve!=="table"&&!V.$.featureToggles.newLogsPanel&&!V.$.featureToggles.logsPanelControls&&(0,t.jsxs)("div",{className:ee.logOptions,children:[(0,t.jsxs)(Rr.C,{children:[(0,t.jsx)(Fe.I,{label:(0,d.t)("explore.unthemed-logs.label-time","Time"),className:ee.horizontalInlineLabel,transparent:!0,children:(0,t.jsx)(Ze.K,{value:N,onChange:kl,className:ee.horizontalInlineSwitch,transparent:!0,id:`show-time_${j}`})}),(0,t.jsx)(Fe.I,{label:(0,d.t)("explore.unthemed-logs.label-unique-labels","Unique labels"),className:ee.horizontalInlineLabel,transparent:!0,children:(0,t.jsx)(Ze.K,{value:ue,onChange:Pl,className:ee.horizontalInlineSwitch,transparent:!0,id:`unique-labels_${j}`})}),(0,t.jsx)(Fe.I,{label:(0,d.t)("explore.unthemed-logs.label-wrap-lines","Wrap lines"),className:ee.horizontalInlineLabel,transparent:!0,children:(0,t.jsx)(Ze.K,{value:Q,onChange:Ml,className:ee.horizontalInlineSwitch,transparent:!0,id:`wrap-lines_${j}`})}),(0,t.jsx)(Fe.I,{label:(0,d.t)("explore.unthemed-logs.label-prettify-json","Prettify JSON"),className:ee.horizontalInlineLabel,transparent:!0,children:(0,t.jsx)(Ze.K,{value:O,onChange:Bl,className:ee.horizontalInlineSwitch,transparent:!0,id:`prettify_${j}`})}),(0,t.jsx)(Fe.I,{label:(0,d.t)("explore.unthemed-logs.label-deduplication","Deduplication"),className:ee.horizontalInlineLabel,transparent:!0,children:(0,t.jsx)(Qt.z,{options:Ta.map(R=>({label:(0,ne.capitalize)(R),value:R,description:ie._C[R]})),value:oe,onChange:Nl,className:ee.radioButtons})})]}),(0,t.jsx)("div",{children:(0,t.jsx)(Fe.I,{label:(0,d.t)("explore.unthemed-logs.label-display-results","Display results"),className:ee.horizontalInlineLabel,transparent:!0,disabled:wl||f,children:(0,t.jsx)(Qt.z,{options:[{label:"Newest first",value:ce.uH.Descending,description:"Show results newest to oldest"},{label:"Oldest first",value:ce.uH.Ascending,description:"Show results oldest to newest"}],value:Ue,onChange:Dl,className:ee.radioButtons})})})]}),(0,t.jsx)("div",{ref:ks}),(0,t.jsx)(Oo,{logRows:n,meta:r||[],dedupStrategy:oe,dedupCount:Kl,displayedFields:Re,clearDetectedFields:Vl})]}),(0,t.jsxs)("div",{className:(0,u.cx)(ee.logsSection,ve==="table"?ee.logsTable:void 0),children:[!V.$.featureToggles.logsPanelControls&&ve==="table"&&wt&&(0,t.jsx)("div",{className:ee.logRows,"data-testid":"logRowsTable",children:(0,t.jsx)(jo,{logsSortOrder:Ue,range:e.range,splitOpen:o,timeZone:h,width:s-80,logsFrames:e.logsFrames??[],onClickFilterLabel:x,onClickFilterOutLabel:g,panelState:M?.logs,theme:E,updatePanelState:Ae,datasourceType:e.datasourceType})}),!V.$.featureToggles.newLogsPanel&&V.$.featureToggles.logsPanelControls&&wt&&(0,t.jsx)("div",{className:ee.logRowsWrapper,"data-testid":"logRows",children:(0,t.jsx)(Ur,{logsTableFrames:e.logsFrames,width:s,updatePanelState:Ae,panelState:M?.logs,datasourceType:e.datasourceType,splitOpen:o,visualisationType:ve,loading:f,loadMoreLogs:cn?U:void 0,range:e.range,pinnedLogs:It,logRows:n,deduplicatedRows:$s,dedupStrategy:oe,onClickFilterLabel:x,onClickFilterOutLabel:g,showContextToggle:T,getRowContextQuery:z,showLabels:ue,showTime:N,enableLogDetails:!0,wrapLogMessage:Q,prettifyLogMessage:O,timeZone:h,getFieldLinks:S,logsSortOrder:Ue,displayedFields:Re,onClickShowField:rn,onClickHideField:an,app:$e.Jk.Explore,onLogRowHover:Ms,onOpenContext:Ot,onPermalinkClick:Hs,permalinkedRowId:M?.logs?.id,scrollIntoView:on,isFilterLabelActive:e.isFilterLabelActive,onClickFilterString:e.onClickFilterString,onClickFilterOutString:e.onClickFilterOutString,onUnpinLine:pt,onPinLine:pt,pinLineButtonTooltipTitle:Os,logsMeta:r,logOptionsStorageKey:de.OY,onLogOptionsChange:dn,hasUnescapedContent:Ul})}),!V.$.featureToggles.logsPanelControls&&!V.$.featureToggles.newLogsPanel&&ve==="logs"&&wt&&(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)("div",{className:V.$.featureToggles.logsInfiniteScrolling?ee.scrollableLogRows:ee.logRows,"data-testid":"logRows",ref:Ie,children:(0,t.jsx)(Lo.u8,{loading:f,loadMoreLogs:cn?U:void 0,range:e.range,timeZone:h,rows:n,scrollElement:Ie.current,sortOrder:Ue,app:$e.Jk.Explore,children:(0,t.jsx)(ms.k,{pinnedLogs:It,logRows:n,deduplicatedRows:$s,dedupStrategy:oe,onClickFilterLabel:x,onClickFilterOutLabel:g,showContextToggle:T,getRowContextQuery:z,showLabels:ue,showTime:N,enableLogDetails:!0,wrapLogMessage:Q,prettifyLogMessage:O,timeZone:h,getFieldLinks:S,logsSortOrder:Ue,displayedFields:Re,onClickShowField:rn,onClickHideField:an,app:$e.Jk.Explore,onLogRowHover:Ms,onOpenContext:Ot,onPermalinkClick:Hs,permalinkedRowId:M?.logs?.id,scrollIntoView:on,isFilterLabelActive:e.isFilterLabelActive,scrollElement:Ie.current,onClickFilterString:e.onClickFilterString,onClickFilterOutString:e.onClickFilterOutString,onUnpinLine:pt,onPinLine:pt,pinLineButtonTooltipTitle:Os,renderPreview:!0})})}),(0,t.jsx)(ga,{logsSortOrder:Ue,visibleRange:Gl??b,absoluteRange:b,timeZone:h,onChangeTime:C,loading:f,queries:w??[],scrollToTopLogs:Ql,addResultsToCache:L,clearCache:v})]}),V.$.featureToggles.newLogsPanel&&ve==="logs"&&wt&&(0,t.jsx)("div",{"data-testid":"logRows",ref:Ie,className:ee.logRowsWrapper,children:Ie.current&&(0,t.jsx)(Zr.Z,{app:$e.Jk.Explore,containerElement:Ie.current,dedupStrategy:oe,displayedFields:Re,filterLevels:ql,getFieldLinks:S,getRowContextQuery:z,loadMore:U,logOptionsStorageKey:de.OY,logs:$s,logsMeta:r,logSupportsContext:T,onLogOptionsChange:dn,onLogLineHover:Ms,onOpenContext:Ot,onPermalinkClick:Hs,onPinLine:pt,onUnpinLine:pt,pinLineButtonTooltipTitle:Os,pinnedLogs:It,showControls:!0,showTime:N,sortOrder:Ue,timeRange:e.range,timeZone:h,wrapLogMessage:Q})}),!f&&!wt&&!m&&(0,t.jsx)("div",{className:ee.noDataWrapper,children:(0,t.jsxs)("div",{className:ee.noData,children:[(0,t.jsx)(d.x6,{i18nKey:"explore.logs.no-logs-found",children:"No logs found."}),(0,t.jsx)(B.$n,{size:"sm",variant:"secondary",className:ee.scanButton,onClick:$l,children:(0,t.jsx)(d.x6,{i18nKey:"explore.logs.scan-for-older-logs",children:"Scan for older logs"})})]})}),m&&(0,t.jsx)("div",{className:ee.noDataWrapper,children:(0,t.jsxs)("div",{className:ee.noData,children:[(0,t.jsx)("span",{children:Fl}),(0,t.jsx)(B.$n,{size:"sm",variant:"secondary",className:ee.scanButton,onClick:Wl,children:(0,t.jsx)(d.x6,{i18nKey:"explore.logs.stop-scan",children:"Stop scan"})})]})})]})]})]})},La=(0,P.cV)(Ra),wa=(e,s,o)=>({noDataWrapper:(0,u.css)({display:"flex",justifyContent:"center",width:"100%",paddingBottom:e.spacing(2)}),noData:(0,u.css)({display:"inline-block"}),scanButton:(0,u.css)({marginLeft:e.spacing(1)}),logOptions:(0,u.css)({display:"flex",justifyContent:"space-between",alignItems:"baseline",flexWrap:"wrap",backgroundColor:e.colors.background.primary,padding:`${e.spacing(1)} ${e.spacing(2)}`,borderRadius:e.shape.radius.default,margin:`${e.spacing(0,0,1)}`,border:`1px solid ${e.colors.border.medium}`}),headerButton:(0,u.css)({margin:`${e.spacing(.5,0,0,1)}`}),horizontalInlineLabel:(0,u.css)({"& > label":{marginRight:"0"}}),horizontalInlineSwitch:(0,u.css)({padding:`0 ${e.spacing(1)} 0 0`}),radioButtons:(0,u.css)({margin:"0"}),logsSection:(0,u.css)({display:"flex",flexDirection:"row",justifyContent:"space-between",position:"relative"}),logsTable:(0,u.css)({maxHeight:`${o}px`}),scrollableLogRows:(0,u.css)({overflowY:"scroll",width:"100%",maxHeight:"75vh"}),logRows:(0,u.css)({overflowX:`${s?"unset":"scroll"}`,overflowY:"visible",width:"100%"}),logRowsWrapper:(0,u.css)({width:"100%"}),visualisationType:(0,u.css)({display:"flex",flex:"1",justifyContent:"space-between"}),visualisationTypeRadio:(0,u.css)({margin:`0 0 0 ${e.spacing(1)}`}),stickyNavigation:(0,u.css)({overflow:"visible",...V.$.featureToggles.logsInfiniteScrolling&&{marginBottom:"0px"}})}),Ia=e=>e.some(s=>s.hasUnescapedContent),Ea=(e,s)=>{const o=(0,Ye.M0)(e,s),n=o.reduce((r,a)=>a.duplicates?r+a.duplicates:r,0);return{dedupedRows:o,dedupCount:n}},Oa=(e,s)=>(0,Ye.ct)(e,new Set(s)),Fa=e=>{if(!e||e.length===0)return;const s=e[0].timeEpochMs,o=e[e.length-1].timeEpochMs;return o<s?{from:o,to:s}:{from:s,to:o}},Ss=500,js=100,Da=e=>({logsEnter:(0,u.css)({label:"logsEnter",position:"absolute",opacity:0,height:"auto",width:"100%"}),logsEnterActive:(0,u.css)({label:"logsEnterActive",opacity:1,[e.transitions.handleMotion("no-preference","reduce")]:{transition:`opacity ${Ss}ms ease-out ${js}ms`}}),logsExit:(0,u.css)({label:"logsExit",position:"absolute",opacity:1,height:"auto",width:"100%"}),logsExitActive:(0,u.css)({label:"logsExitActive",opacity:0,[e.transitions.handleMotion("no-preference","reduce")]:{transition:`opacity ${Ss}ms ease-out ${js}ms`}})});function Do(e){const{visible:s,children:o}=e,n=(0,c.useRef)(null),r=(0,P.of)(Da);return(0,t.jsx)(ro.A,{in:s,mountOnEnter:!0,unmountOnExit:!0,timeout:Ss+js,classNames:{enter:r.logsEnter,enterActive:r.logsEnterActive,exit:r.logsExit,exitActive:r.logsExitActive},nodeRef:n,children:(0,t.jsx)("div",{ref:n,children:o})})}class Aa extends c.PureComponent{constructor(){super(...arguments),this.state={dsInstances:{}},this.onChangeTime=s=>{const{exploreId:o,updateTimeRange:n}=this.props;n({exploreId:o,absoluteRange:s})},this.loadMoreLogs=s=>{const{exploreId:o,loadMoreLogs:n}=this.props;n({exploreId:o,absoluteRange:s})},this.getLogRowContext=async(s,o,n)=>{const{logsQueries:r}=this.props;if(!o.dataFrame.refId||!this.state.dsInstances[o.dataFrame.refId])return Promise.resolve({data:[]});const a=this.state.dsInstances[o.dataFrame.refId];if(!(0,ie.Ol)(a))return Promise.resolve({data:[]});const l=this.getQuery(r,o,a);return l?a.getLogRowContext(s,n,l):Promise.resolve({data:[]})},this.getLogRowContextQuery=async(s,o,n=!0)=>{const{logsQueries:r}=this.props;if(!s.dataFrame.refId||!this.state.dsInstances[s.dataFrame.refId])return Promise.resolve(null);const a=this.state.dsInstances[s.dataFrame.refId];if(!(0,ie.Ol)(a))return Promise.resolve(null);const l=this.getQuery(r,s,a);return l&&a.getLogRowContextQuery?a.getLogRowContextQuery(s,o,l,n):Promise.resolve(null)},this.getLogRowContextUi=(s,o)=>{const{logsQueries:n}=this.props;if(!s.dataFrame.refId||!this.state.dsInstances[s.dataFrame.refId])return(0,t.jsx)(t.Fragment,{});const r=this.state.dsInstances[s.dataFrame.refId];if(!(0,ie.Ol)(r))return(0,t.jsx)(t.Fragment,{});const a=this.getQuery(n,s,r);return a&&(0,ie.wj)(r)&&r.getLogRowContextUi?r.getLogRowContextUi(s,o,a):(0,t.jsx)(t.Fragment,{})},this.showContextToggle=s=>!s?.dataFrame.refId||!this.state.dsInstances[s.dataFrame.refId]?!1:(0,ie.Ol)(this.state.dsInstances[s.dataFrame.refId]),this.getFieldLinks=(s,o,n)=>{const{splitOpenFn:r,range:a}=this.props;return(0,lt.QL)({field:s,rowIndex:o,splitOpenFn:r,range:a,dataFrame:n})},this.logDetailsFilterAvailable=()=>Object.values(this.state.dsInstances).some(s=>s?.modifyQuery||(0,ie._0)(s)||(0,ie.FP)(s)),this.filterValueAvailable=()=>Object.values(this.state.dsInstances).some(s=>(0,ie._0)(s)&&s?.getSupportedQueryModifications().includes("ADD_STRING_FILTER")),this.filterOutValueAvailable=()=>Object.values(this.state.dsInstances).some(s=>(0,ie._0)(s)&&s?.getSupportedQueryModifications().includes("ADD_STRING_FILTER_OUT")),this.addResultsToCache=()=>{this.props.addResultsToCache(this.props.exploreId)},this.clearCache=()=>{this.props.clearCache(this.props.exploreId)},this.loadLogsVolumeData=()=>{this.props.loadSupplementaryQueryData(this.props.exploreId,ie.cF.LogsVolume)},this.onSetLogsVolumeEnabled=s=>{this.props.setSupplementaryQueryEnabled(this.props.exploreId,s,ie.cF.LogsVolume)}}componentDidMount(){this.updateDataSourceInstances()}componentDidUpdate(s){s.logsQueries!==this.props.logsQueries&&this.updateDataSourceInstances()}updateDataSourceInstances(){const{logsQueries:s,datasourceInstance:o}=this.props;if(!s||!o)return;const n={};if(o.uid!==st.uv){s.forEach(({refId:a})=>{n[a]=o}),this.setState({dsInstances:n});return}const r=[];for(const a of s){if(!a.datasource)continue;(!n[a.refId]||n[a.refId].uid!==a.datasource.uid)&&r.push(new Promise(p=>{(0,qe.l)().get(a.datasource).then(f=>{p({ds:f,refId:a.refId})})}))}r.length&&Promise.all(r).then(a=>{a.forEach(({ds:l,refId:p})=>{n[p]=l}),this.setState({dsInstances:n})})}getQuery(s,o,n){return(s??[]).find(r=>r.refId===o.dataFrame.refId&&r.datasource!=null&&r.datasource.type===n.type)}render(){const{loading:s,loadingState:o,logRows:n,logsMeta:r,logsSeries:a,logsQueries:l,onClickFilterLabel:p,onClickFilterOutLabel:f,onStartScanning:x,onStopScanning:g,absoluteRange:h,timeZone:m,visibleRange:y,scanning:T,range:b,width:C,splitOpenFn:S,isLive:E,exploreId:w,logsVolume:v,scrollElement:L,onPinLineCallback:j}=this.props;return n?(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(Do,{visible:E,children:(0,t.jsx)(Bt.S,{label:(0,d.t)("explore.logs-container.label-logs","Logs"),loading:!1,isOpen:!0,children:(0,t.jsx)(uo,{exploreId:w,children:F=>(0,t.jsx)(Sr,{logRows:n,timeZone:m,stopLive:F.stop,isPaused:this.props.isPaused,onPause:F.pause,onResume:F.resume,onClear:F.clear,clearedAtIndex:this.props.clearedAtIndex})})})}),(0,t.jsx)(Do,{visible:!E,children:(0,t.jsx)(La,{exploreId:w,datasourceType:this.props.datasourceInstance?.type,logRows:n,logsMeta:r,logsSeries:a,logsVolumeEnabled:v.enabled,onSetLogsVolumeEnabled:this.onSetLogsVolumeEnabled,logsVolumeData:v.data,logsQueries:l,width:C,splitOpen:S,loading:s,loadingState:o,loadLogsVolumeData:this.loadLogsVolumeData,onChangeTime:this.onChangeTime,loadMoreLogs:this.loadMoreLogs,onClickFilterLabel:this.logDetailsFilterAvailable()?p:void 0,onClickFilterOutLabel:this.logDetailsFilterAvailable()?f:void 0,onStartScanning:x,onStopScanning:g,absoluteRange:h,visibleRange:y,timeZone:m,scanning:T,scanRange:b.raw,showContextToggle:this.showContextToggle,getRowContext:this.getLogRowContext,getRowContextQuery:this.getLogRowContextQuery,getLogRowContextUi:this.getLogRowContextUi,getFieldLinks:this.getFieldLinks,addResultsToCache:this.addResultsToCache,clearCache:this.clearCache,eventBus:this.props.eventBus,panelState:this.props.panelState,logsFrames:this.props.logsFrames,scrollElement:L,isFilterLabelActive:this.logDetailsFilterAvailable()?this.props.isFilterLabelActive:void 0,range:b,onPinLineCallback:j,onClickFilterString:this.filterValueAvailable()?this.props.onClickFilterString:void 0,onClickFilterOutString:this.filterOutValueAvailable()?this.props.onClickFilterOutString:void 0})})]}):null}}function Na(e,{exploreId:s}){const n=e.explore.panes[s],{logsResult:r,scanning:a,datasourceInstance:l,isLive:p,isPaused:f,clearedAtIndex:x,range:g,absoluteRange:h,supplementaryQueries:m}=n,y=(0,Z.h1)(s)(e),T=n.panelsState,b=(0,At.O)(e.user),C=m[ie.cF.LogsVolume];return{loading:y,logRows:r?.rows,logsMeta:r?.meta,logsSeries:r?.series,logsQueries:r?.queries,visibleRange:r?.visibleRange,scanning:a,timeZone:b,datasourceInstance:l,isLive:p,isPaused:f,clearedAtIndex:x,range:g,absoluteRange:h,logsVolume:C,panelState:T,logsFrames:n.queryResponse.logsFrames}}const Pa={updateTimeRange:Te.GH,loadMoreLogs:Te.zY,addResultsToCache:Z.He,clearCache:Z.IL,loadSupplementaryQueryData:Z.Az,setSupplementaryQueryEnabled:Z.TO},ka=(0,Le.connect)(Na,Pa)(Aa);function Ma(e){const{queryResponse:s,timeZone:o,enabled:n,setLogsSampleEnabled:r,datasourceInstance:a,queries:l,splitOpen:p}=e,f=(0,P.of)(Ba),x=m=>{r(m),(0,k.rR)("grafana_explore_logs_sample_toggle_clicked",{datasourceType:a?.type??"unknown",type:m?"open":"close"})},g=()=>{if(!a||!(0,ie.Nc)(a,ie.cF.LogsSample))return null;const m=l.map(T=>a.getSupplementaryQuery({type:ie.cF.LogsSample},T)).filter(T=>!!T);if(!m.length)return null;const y=()=>{p({queries:m,datasourceUid:a.uid}),(0,k.rR)("grafana_explore_logs_sample_split_button_clicked",{datasourceType:a?.type??"unknown",queriesCount:m.length})};return(0,t.jsx)(B.$n,{size:"sm",className:f.logSamplesButton,onClick:y,children:(0,t.jsx)(d.x6,{i18nKey:"explore.logs-sample-panel.open-in-split-view-button.open-logs-in-split-view",children:"Open logs in split view"})})};let h;if(s===void 0)h=null;else if(s.error!==void 0)h=(0,t.jsx)(Kt,{error:s.error,title:(0,d.t)("explore.logs-sample-panel.title-failed-sample-query","Failed to load logs sample for this query")});else if(s.state===be.Gu.Loading)h=(0,t.jsx)("span",{children:(0,t.jsx)(d.x6,{i18nKey:"explore.logs-sample-panel.logs-sample-is-loading",children:"Logs sample is loading..."})});else if(s.data.length===0||s.data.every(m=>m.length===0))h=(0,t.jsx)("span",{children:(0,t.jsx)(d.x6,{i18nKey:"explore.logs-sample-panel.no-logs-sample-data",children:"No logs sample data."})});else{const m=(0,Ye.HT)(s.data);h=(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(g,{}),(0,t.jsx)("div",{className:f.logContainer,children:(0,t.jsx)(ms.k,{logRows:m.rows,dedupStrategy:ce.fY.none,showLabels:he.A.getBool(de.$Z.showLabels,!1),showTime:he.A.getBool(de.$Z.showTime,!0),wrapLogMessage:he.A.getBool(de.$Z.wrapLogMessage,!0),prettifyLogMessage:he.A.getBool(de.$Z.prettifyLogMessage,!1),timeZone:o,enableLogDetails:!0,scrollElement:null})})]})}return s?.state!==be.Gu.NotStarted?(0,t.jsx)(Bt.S,{label:(0,t.jsxs)("div",{children:["Logs sample",(0,t.jsx)(J.m,{content:"Show log lines that contributed to visualized metrics",children:(0,t.jsx)(K.I,{name:"info-circle",className:f.infoTooltip})})]}),isOpen:n,collapsible:!0,onToggle:x,children:h}):null}const Ba=e=>({logSamplesButton:(0,u.css)({position:"absolute",top:e.spacing(1),right:e.spacing(1)}),logContainer:(0,u.css)({overflow:"scroll"}),infoTooltip:(0,u.css)({marginLeft:e.spacing(1)})}),Ha=()=>{const e=(0,P.of)($a);return(0,t.jsx)(t.Fragment,{children:(0,t.jsx)(ns._,{"data-testid":"explore-no-data",className:e.wrapper,children:(0,t.jsx)("span",{className:e.message,children:"No data"})})})},$a=e=>({wrapper:(0,u.css)({label:"no-data-card",padding:e.spacing(3),background:e.colors.background.primary,borderRadius:e.shape.radius.default,display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",flexGrow:1}),message:(0,u.css)({fontSize:e.typography.h2.fontSize,padding:e.spacing(4),color:e.colors.text.disabled})});var Wa=i(43951);function Va(e){return(0,u.css)({maxWidth:`${e.breakpoints.values.lg}px`,marginTop:e.spacing(2),alignSelf:"center"})}const za=()=>{const e=(0,P.of)(Va),s=ps.TP.hasPermission(D.AccessControlAction.DataSourcesCreate)&&ps.TP.hasPermission(D.AccessControlAction.DataSourcesWrite),o="Explore requires at least one data source. Once you have added a data source, you can query it here.",n=(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(K.I,{name:"rocket"}),(0,t.jsx)(t.Fragment,{children:(0,t.jsxs)(d.x6,{i18nKey:"explore.no-data-source-call-to-action.footer.pro-tip-define-sources-through-configuration-files",children:[" ","ProTip: You can also define data sources through configuration files."," "]})}),(0,t.jsx)("a",{href:"http://docs.grafana.org/administration/provisioning/?utm_source=explore#data-sources",target:"_blank",rel:"noreferrer",className:"text-link",children:(0,t.jsx)(d.x6,{i18nKey:"explore.no-data-source-call-to-action.footer.learn-more",children:"Learn more"})})]}),r=(0,t.jsx)(B.z9,{size:"lg",href:"datasources/new",icon:"database",disabled:!s,children:(0,t.jsx)(d.x6,{i18nKey:"explore.no-data-source-call-to-action.cta-element.add-data-source",children:"Add data source"})});return(0,t.jsx)(Wa.c,{callToActionElement:r,className:e,footer:n,message:o})};var Ts=i(52908),Rs=i(60519),Ao=i(29147),No=i(18209),Qa=i(81753);const Ua=e=>({warningText:(0,u.css)({label:"warningText",display:"flex",alignItems:"center",fontSize:e.typography.bodySmall.fontSize,color:e.colors.text.secondary})});function Ka(e){const{dataFrames:s,range:o,splitOpenFn:n,withTraceView:r,datasourceType:a}=e,l=(0,lt.JQ)(o,n),p=(0,P.$j)(),f=(0,P.of)(Ua),x=(0,Rs.we)({fieldConfig:{defaults:{},overrides:[]},data:s,replaceVariables:j=>j,theme:p}),{nodes:g}=(0,Qa.d)(x),[h,m]=(0,qs.A)(!0),T=(g[0]?.length||0)>Ao.E?No.S.Force:No.S.Layered,b=()=>{m(),(0,k.rR)("grafana_traces_node_graph_panel_clicked",{datasourceType:a,grafana_version:V.$.buildInfo.version,isExpanded:!open})},{height:C}=(0,Ts.A)(),S=(0,c.useRef)(null),[E,w]=(0,c.useState)(250);(0,c.useEffect)(()=>{if(S.current){const{top:j}=S.current.getBoundingClientRect();w(j)}},[S]);const v=C-E-32,L=r&&g[0]?.length>1e3?(0,t.jsxs)("span",{className:f.warningText,children:[" (",g[0].length," nodes, can be slow to load)"]}):null;return(0,t.jsx)(He.NR,{title:"Node graph",titleItems:L,collapsible:!!r,collapsed:r?h:!1,onToggleCollapse:r?b:void 0,children:(0,t.jsx)("div",{ref:S,style:r?{height:500}:{minHeight:600,height:v},children:(0,t.jsx)(Ao.F,{dataFrames:x,getLinks:l,layoutAlgorithm:T})})})}function Ga(e,{exploreId:s}){return{range:e.explore.panes[s].range}}const qa=(0,Le.connect)(Ga,{})(Ka);var Tt=i(25508),Za=i(28998),Ya=i(65966);const Ja=e=>{const s=(0,_.qq)(e);return{getQueries:(0,Tt.Mz)(s,o=>o.queries),getQueryResponse:(0,Tt.Mz)(s,o=>o.queryResponse),getHistory:(0,Tt.Mz)(s,o=>o.history),getEventBridge:(0,Tt.Mz)(s,o=>o.eventBridge),getDatasourceInstanceSettings:(0,Tt.Mz)(s,o=>(0,Za.tR)().getInstanceSettings(o.datasourceInstance?.uid))}},Xa=({exploreId:e})=>{const s=(0,D.useDispatch)(),{getQueries:o,getDatasourceInstanceSettings:n,getQueryResponse:r,getHistory:a,getEventBridge:l}=(0,c.useMemo)(()=>Ja(e),[e]),p=(0,D.useSelector)(o),f=(0,D.useSelector)(n),x=(0,D.useSelector)(r),g=(0,D.useSelector)(a),h=(0,D.useSelector)(l),m=(0,c.useCallback)(()=>{s((0,Z.Od)({exploreId:e}))},[s,e]),y=(0,c.useCallback)(v=>{s((0,Z.bO)({exploreId:e,queries:v}))},[s,e]),T=(0,c.useCallback)(v=>{s((0,ke.wh)({exploreId:e,datasource:v}))},[s,e]),b=(0,c.useCallback)(v=>{y([...p,{...v,refId:(0,Ks.M)(p)}])},[y,p]),C=()=>{(0,k.rR)("grafana_explore_query_row_copy")},S=()=>{(0,k.rR)("grafana_explore_query_replaced_from_library")},E=()=>{(0,k.rR)("grafana_explore_query_row_remove")},w=v=>{(0,k.rR)("grafana_query_row_toggle",v===void 0?{}:{queryEnabled:v})};return(0,t.jsx)(Ya.L,{dsSettings:f,queries:p,onQueriesChange:y,onUpdateDatasources:T,onAddQuery:b,onRunQueries:m,onQueryCopied:C,onQueryRemoved:E,onQueryToggled:w,onQueryReplacedFromLibrary:S,data:x,app:$e.Jk.Explore,history:g,eventBus:h,queryRowWrapper:(v,L)=>(0,t.jsx)(we,{title:L,icon:"arrow",panelId:"Queries",customTopOffset:-10,level:"child",children:v},L)})};var qt=i(2863),Po=i(24343),Ls=i(65642),_a=i(95943),ei=i(91793),ti=i(44720),si=i(3642),ko=i(53593);const Rt={wrapper:(0,u.css)({height:"100%",overflow:"scroll"}),switchWrapper:(0,u.css)({display:"flex",flexDirection:"row",marginBottom:0}),switchLabel:(0,u.css)({marginLeft:"15px",marginBottom:0}),switch:(0,u.css)({marginLeft:"10px"}),resultCount:(0,u.css)({marginBottom:"4px"}),header:(0,u.css)({display:"flex",justifyContent:"space-between",alignItems:"center",padding:"10px 0",fontSize:"12px",lineHeight:1.25})},oi=480,ni=2,ri=e=>{const{tableResult:s}=e,o=(0,ne.cloneDeep)(s),n=(0,c.useRef)(null),r=o.fields.filter(y=>y.name.includes("Value")),a=(0,ko.E)(o),{width:l}=(0,Ts.A)(),[p,f]=(0,c.useState)(l<=oi||r.length>ni),x=()=>{f(!p);const y={isExpanded:!p};(0,k.rR)("grafana_explore_prometheus_instant_query_ui_raw_toggle_expand",y)};(0,c.useEffect)(()=>{n.current?.resetAfterIndex(0,!0)},[p]);const g=y=>{if(y<10){let C=0;for(let S=0;S<y;S++)C+=h(S,!0);return Math.min(600,C)}return 600},h=(y,T)=>{if(!T)return 32;const S=a[y];return 1.5*32+(Object.keys(S).length-r.length)*22},m=`isExpandedView ${(0,c.useId)()}`;return(0,t.jsxs)("section",{children:[(0,t.jsxs)("header",{className:Rt.header,children:[(0,t.jsx)(Be.D,{className:Rt.switchWrapper,label:"Expand results",htmlFor:"isExpandedView",children:(0,t.jsx)("div",{className:Rt.switch,children:(0,t.jsx)(Ze.d,{onChange:x,id:m,value:p,label:"Expand results"})})}),(0,t.jsxs)("div",{className:Rt.resultCount,children:["Result series: ",a.length]})]}),(0,t.jsx)("div",{role:"table",children:(0,t.jsxs)(t.Fragment,{children:[r.length>1&&!p&&(0,t.jsx)(ti.d,{valueLabels:r,expanded:p}),(0,t.jsx)(ei._m,{ref:n,itemCount:a.length,className:Rt.wrapper,itemSize:y=>h(y,p),height:g(a.length),width:"100%",children:({index:y,style:T})=>{let b;return p&&(b=r.filter(C=>{const S=a[y][C.name];return S&&S!==ko.M})),(0,t.jsx)("div",{role:"row",style:{...T,overflow:"hidden"},children:(0,t.jsx)(si.Ay,{isExpandedView:p,valueLabels:b,totalNumberOfValues:r.length,listKey:a[y].__name__,listItemData:a[y]})})}})]})})]})};function ai(e,{exploreId:s}){const n=e.explore.panes[s],{tableResult:r,rawPrometheusResult:a,range:l,queryResponse:p}=n,f=a?[a]:[],x=(r?.length??0)>0&&a?r:f;return{loading:p.state,tableResult:x,range:l}}const ii=(0,Le.connect)(ai,{});class li extends c.PureComponent{constructor(s){super(s),this.onChangeResultsStyle=o=>{this.setState({resultsStyle:o})},this.renderLabel=()=>{const o=(0,u.css)({display:"flex",justifyContent:"space-between",flex:"1"}),n=us.jH.map(r=>({value:r,label:r[0].toUpperCase()+r.slice(1).replace(/_/," ")}));return(0,t.jsx)("div",{className:o,children:(0,t.jsx)(Qt.z,{onClick:()=>{const r={state:this.state.resultsStyle===D.TABLE_RESULTS_STYLE.table?D.TABLE_RESULTS_STYLE.raw:D.TABLE_RESULTS_STYLE.table};(0,k.rR)("grafana_explore_prometheus_instant_query_ui_toggle_clicked",r)},size:"sm",options:n,value:this.state?.resultsStyle,onChange:this.onChangeResultsStyle})})},s.showRawPrometheus&&(this.state={resultsStyle:D.TABLE_RESULTS_STYLE.raw})}getTableHeight(){const{tableResult:s}=this.props;return!s||s.length===0?200:Math.max(Math.min(600,s[0].length*35)+35)}render(){const{loading:s,onCellFilterAdded:o,tableResult:n,width:r,splitOpenFn:a,range:l,ariaLabel:p,timeZone:f}=this.props,x=this.getTableHeight(),g=r-Ls.$W.theme.panelPadding*2-_a.IZ;let h=n;const m=(0,lt.YV)(a,l);h?.length&&(h=(0,Rs.we)({data:h,timeZone:f,theme:Ls.$W.theme2,replaceVariables:(0,qt.w)().replace.bind((0,qt.w)()),fieldConfig:{defaults:{},overrides:[]},dataLinkPostProcessor:m}));const y=h?.filter(S=>!!S&&S.length!==0),T=this.state.resultsStyle===D.TABLE_RESULTS_STYLE.raw?"Raw":"Table",b=this.state?.resultsStyle!==void 0?this.renderLabel():"Table",C=!this.state?.resultsStyle||this.state?.resultsStyle===D.TABLE_RESULTS_STYLE.table;return(0,t.jsxs)(He.NR,{title:T,actions:b,loadingState:s,children:[y?.length&&(0,t.jsxs)(t.Fragment,{children:[C&&(0,t.jsx)(Po.X,{ariaLabel:p,data:y[0],width:g,height:x,onCellFilterAdded:o}),this.state?.resultsStyle===D.TABLE_RESULTS_STYLE.raw&&(0,t.jsx)(ri,{tableResult:y[0]})]}),!y?.length&&(0,t.jsx)(ys,{metaItems:[{value:"0 series returned"}]})]})}}const ci=ii(li);var di=i(22669);const ui=e=>{const s=(0,c.useRef)(null),o={transition:`opacity ${e.duration}ms linear`,opacity:0},n={exited:{opacity:0,display:"none"},entering:{opacity:0},entered:{opacity:1},exiting:{opacity:0}};return(0,t.jsx)(di.Ay,{in:e.in,timeout:e.duration,unmountOnExit:e.unmountOnExit||!1,onExited:e.onExited,nodeRef:s,children:r=>(0,t.jsx)("div",{ref:s,style:{...o,...n[r]},children:e.children})})},pi=e=>{const{queryError:s}=e,o=!!s,n=o?100:10,r=s?"Query error":"Unknown error",a=s?.message||s?.data?.message||null;return(0,t.jsx)(ui,{in:o,duration:n,children:(0,t.jsx)(nt.F,{severity:"error",title:r,topSpacing:2,children:a})})};function gi(e){const s=(0,D.useSelector)(n=>n.explore.panes[e.exploreId].queryResponse),o=s?.state===be.Gu.Error?s?.error:void 0;return o?.refId?null:(0,t.jsx)(pi,{queryError:o})}var fe=i(81970),Mo=i(98838);const hi=e=>({containerMargin:(0,u.css)({display:"flex",flexWrap:"wrap",gap:e.spacing(1),marginTop:e.spacing(2)})});function fi({addQueryRowButtonDisabled:e,addQueryRowButtonHidden:s,onClickAddQueryRowButton:o,onClickQueryInspectorButton:n,onSelectQueryFromLibrary:r,queryInspectorButtonActive:a}){const l=(0,P.$j)(),p=hi(l),f=(0,D.useSelector)(_.Kl),x=(0,fe.TR)(),g=f.dsToExplore.map(y=>x.find(T=>T.uid===y.datasource?.uid)?.name).filter(y=>!!y&&y!==st.uv),{queryLibraryEnabled:h,openDrawer:m}=(0,Mo.Y)();return(0,t.jsxs)("div",{className:p.containerMargin,children:[!s&&(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(me.I,{variant:"canvas","aria-label":(0,d.t)("explore.secondary-actions.query-add-button-aria-label","Add query"),onClick:o,disabled:e,icon:"plus",children:(0,t.jsx)(d.x6,{i18nKey:"explore.secondary-actions.query-add-button",children:"Add query"})}),h&&(0,t.jsx)(me.I,{"data-testid":Ge.Tp.pages.Explore.General.addFromQueryLibrary,"aria-label":(0,d.t)("explore.secondary-actions.add-from-query-library","Add query from library"),variant:"canvas",onClick:()=>m(g,r),icon:"plus",children:(0,t.jsx)(d.x6,{i18nKey:"explore.secondary-actions.add-from-query-library",children:"Add query from library"})})]}),(0,t.jsx)(me.I,{variant:a?"active":"canvas","aria-label":(0,d.t)("explore.secondary-actions.query-inspector-button-aria-label","Query inspector"),onClick:n,icon:"info-circle",children:(0,t.jsx)(d.x6,{i18nKey:"explore.secondary-actions.query-inspector-button",children:"Query inspector"})})]})}var mi=i(95004),Bo=i(32776),xi=i(15757);const Ho=20;function yi(e,{exploreId:s}){const n=e.explore.panes[s],{tableResult:r,range:a}=n,l=(0,Z.h1)(s);return{loading:r&&r.length>0?!1:l,tableResult:r,range:a}}const vi=(0,Le.connect)(yi,{});class $o extends c.PureComponent{constructor(){super(...arguments),this.state={showAll:!1},this.hasSubFrames=s=>s.fields.some(o=>o.type===mi.PU.nestedFrames)}getTableHeight(s,o){return s===0?200:Math.min(600,Math.max(s*36,o?300:0)+40+46)}getTableTitle(s,o,n){let r=o.name;return!r&&(s?.length??0)>1&&(r=o.refId||`${n}`),r?(0,d.t)("explore.table.title-with-name","Table - {{name}}",{name:r,interpolation:{escapeValue:!1}}):(0,d.t)("explore.table.title","Table")}showAll(){this.setState({showAll:!0})}render(){const{loading:s,onCellFilterAdded:o,tableResult:n,width:r,splitOpenFn:a,range:l,ariaLabel:p,timeZone:f,theme:x}=this.props,{showAll:g}=this.state;let h=(0,Bo.gy)(n)?(0,Bo.S5)(n):n;const m=(0,lt.YV)(a,l);let y=!1;h?.length&&(h=h.map(b=>(b.fields.forEach((C,S)=>{const E=g?!1:S>=Ho;C.config.custom={hidden:E},y=y||E}),b)),h=(0,Rs.we)({data:h,timeZone:f,theme:Ls.$W.theme2,replaceVariables:(0,qt.w)().replace.bind((0,qt.w)()),fieldConfig:{defaults:{},overrides:[]},dataLinkPostProcessor:m}));const T=h?.filter(b=>!!b&&b.length!==0);return(0,t.jsxs)(t.Fragment,{children:[T&&T.length===0&&(0,t.jsx)(He.NR,{title:(0,d.t)("explore.table.title","Table"),width:r,height:200,children:()=>(0,t.jsx)(ys,{metaItems:[{value:(0,d.t)("explore.table.no-data","0 series returned")}]})}),T&&T.length>0&&(0,t.jsx)("div",{className:(0,u.css)({display:"flex",flexDirection:"column",gap:x.spacing(1)}),children:T.map((b,C)=>(0,t.jsx)(He.NR,{title:this.getTableTitle(h,b,C),titleItems:[!g&&y&&(0,t.jsx)(xi.m,{toggleShowAllSeries:()=>this.showAll(),info:(0,t.jsxs)(d.x6,{i18nKey:"table.container.show-only-series",children:["Showing only ",{MAX_NUMBER_OF_COLUMNS:Ho}," columns"]}),tooltip:(0,d.t)("table.container.content","Showing too many columns in a single table may impact performance and make data harder to read. Consider refining your queries."),buttonLabel:(0,t.jsx)(d.x6,{i18nKey:"table.container.show-all-series",children:"Show all columns"})})],width:r,height:this.getTableHeight(b.length,this.hasSubFrames(b)),loadingState:s?be.Gu.Loading:void 0,children:(S,E)=>(0,t.jsx)(Po.X,{ariaLabel:p,data:b,width:S,height:E,onCellFilterAdded:o})},b.refId||`table-${C}`))})]})}}const ec=(0,P.cV)($o),bi=(0,P.cV)(vi($o));var Ci=i(51603),Si=i(17523);function ji(e){const s=e.dataFrames[0],{dataFrames:o,splitOpenFn:n,exploreId:r,scrollElement:a,timeRange:l}=e,p=(0,c.useMemo)(()=>(0,Si.L)(s),[s]),f=(0,D.useSelector)(x=>x.explore.panes[e.exploreId]?.datasourceInstance??void 0);return p?(0,t.jsx)(He.NR,{padding:"none",title:(0,d.t)("explore.trace-view-container.title-trace","Trace"),children:(0,t.jsx)(Ci.V,{exploreId:r,dataFrames:o,splitOpenFn:n,scrollElement:a,traceProp:p,datasource:f,timeRange:l})}):null}const Ti=e=>({exploreMain:(0,u.css)({label:"exploreMain",position:"relative",marginTop:"21px",display:"flex",flexDirection:"column",gap:e.spacing(1)}),queryContainer:(0,u.css)({label:"queryContainer",padding:e.spacing(1)}),exploreContainer:(0,u.css)({label:"exploreContainer",display:"flex",flexDirection:"column",paddingRight:e.spacing(2),marginBottom:e.spacing(2)}),wrapper:(0,u.css)({position:"absolute",top:0,left:e.spacing(2),right:0,bottom:0,display:"flex"})});class Ri extends c.PureComponent{constructor(s){super(s),this.onChangeTime=o=>{const{updateTimeRange:n,exploreId:r}=this.props;n({exploreId:r,rawRange:o})},this.onClickExample=o=>{this.props.setQueries(this.props.exploreId,[o])},this.onCellFilterAdded=o=>{const{value:n,key:r,operator:a}=o;a===Gs.mc&&this.onClickFilterLabel(r,n),a===Gs.Zi&&this.onClickFilterOutLabel(r,n)},this.onContentOutlineToogle=()=>{ot.M.set(Nt.visible,!this.state.contentOutlineVisible),this.setState(o=>((0,k.rR)("explore_toolbar_contentoutline_clicked",{item:"outline",type:o.contentOutlineVisible?"close":"open"}),{contentOutlineVisible:!o.contentOutlineVisible}))},this.isFilterLabelActive=async(o,n,r)=>{const a=this.props.queries.find(p=>p.refId===r);if(!a)return!1;const l=await(0,qe.l)().get(a.datasource);return!!((0,ie.FP)(l)&&l.queryHasFilter(a,{key:o,value:n.toString()}))},this.onClickFilterLabel=(o,n,r)=>{this.onModifyQueries({type:"ADD_FILTER",options:{key:o,value:n.toString()},frame:r},r?.refId)},this.onClickFilterOutLabel=(o,n,r)=>{this.onModifyQueries({type:"ADD_FILTER_OUT",options:{key:o,value:n.toString()},frame:r},r?.refId)},this.onClickFilterString=(o,n)=>{this.onModifyQueries({type:"ADD_STRING_FILTER",options:{value:o.toString()}},n)},this.onClickFilterOutString=(o,n)=>{this.onModifyQueries({type:"ADD_STRING_FILTER_OUT",options:{value:o.toString()}},n)},this.onClickAddQueryRowButton=()=>{const{exploreId:o,queryKeys:n}=this.props;this.props.addQueryRow(o,n.length)},this.onModifyQueries=(o,n)=>{const r=async(a,l)=>{if(n&&n!==a.refId)return a;const{datasource:p}=a;if(p==null)return a;const f=await(0,qe.l)().get(p),x=["ADD_FILTER","ADD_FILTER_OUT"];return(0,ie.FP)(f)&&x.includes(l.type)?f.toggleQueryFilter(a,{type:l.type==="ADD_FILTER"?"FILTER_FOR":"FILTER_OUT",options:l.options??{},frame:l.frame}):f.modifyQuery?f.modifyQuery(a,l):a};this.props.modifyQueries(this.props.exploreId,o,r)},this.onResize=o=>{this.props.changeSize(this.props.exploreId,o)},this.onStartScanning=()=>{this.props.scanStart(this.props.exploreId)},this.onStopScanning=()=>{this.props.scanStopAction({exploreId:this.props.exploreId})},this.onUpdateTimeRange=o=>{const{exploreId:n,updateTimeRange:r}=this.props;r({exploreId:n,absoluteRange:o})},this.onSplitOpen=o=>async n=>{if(this.props.splitOpen(n),n&&this.props.datasourceInstance){const r=(await(0,qe.l)().get(n.datasourceUid)).type,a=this.props.datasourceInstance.uid===st.uv?(0,ne.get)(this.props.queries,"0.datasource.type"):this.props.datasourceInstance.type,l={origin:"panel",panelType:o,source:a,target:r,exploreId:this.props.exploreId};(0,k.rR)("grafana_explore_split_view_opened",l)}},this.onPinLineCallback=()=>{this.setState({contentOutlineVisible:!0})},this.splitOpenFnLogs=this.onSplitOpen("logs"),this.state={contentOutlineVisible:ot.M.getBool(Nt.visible,!0)},this.graphEventBus=s.eventBus.newScopedBus("graph",{onlyLocal:!1}),this.logsEventBus=s.eventBus.newScopedBus("logs",{onlyLocal:!1})}renderEmptyState(s){return(0,t.jsx)("div",{className:(0,u.cx)(s),children:(0,t.jsx)(za,{})})}renderNoData(){return(0,t.jsx)(Ha,{})}renderCustom(s){const{timeZone:o,queryResponse:n,eventBus:r}=this.props,a=(0,ne.groupBy)(n?.customFrames,"meta.preferredVisualisationPluginId");return Object.entries(a).map(([l,p],f)=>(0,t.jsx)(we,{panelId:l,title:l,icon:"plug",children:(0,t.jsx)($n,{timeZone:o,pluginId:l,frames:p,state:n.state,timeRange:n.timeRange,height:400,width:s,splitOpenFn:this.onSplitOpen(l),eventBus:r},f)},f))}renderGraphPanel(s){const{graphResult:o,timeZone:n,queryResponse:r,showFlameGraph:a}=this.props;return(0,t.jsx)(we,{panelId:"Graph",title:(0,d.t)("explore.explore.title-graph","Graph"),icon:"graph-bar",children:(0,t.jsx)(gr.y,{data:o,height:a?180:400,width:s,timeRange:r.timeRange,timeZone:n,onChangeTime:this.onUpdateTimeRange,annotations:r.annotations,splitOpenFn:this.onSplitOpen("graph"),loadingState:r.state,eventBus:this.graphEventBus})})}renderTablePanel(s){const{exploreId:o,timeZone:n}=this.props;return(0,t.jsx)(we,{panelId:"Table",title:(0,d.t)("explore.explore.title-table","Table"),icon:"table",children:(0,t.jsx)(bi,{ariaLabel:Ge.Tp.pages.Explore.General.table,width:s,exploreId:o,onCellFilterAdded:this.onCellFilterAdded,timeZone:n,splitOpenFn:this.onSplitOpen("table")})})}renderRawPrometheus(s){const{exploreId:o,datasourceInstance:n,timeZone:r}=this.props;return(0,t.jsx)(we,{panelId:"Raw Prometheus",title:(0,d.t)("explore.explore.title-raw-prometheus","Raw Prometheus"),icon:"gf-prometheus",children:(0,t.jsx)(ci,{showRawPrometheus:!0,ariaLabel:Ge.Tp.pages.Explore.General.table,width:s,exploreId:o,onCellFilterAdded:n?.modifyQuery?this.onCellFilterAdded:void 0,timeZone:r,splitOpenFn:this.onSplitOpen("table")})})}renderLogsPanel(s){const{exploreId:o,syncedTimes:n,theme:r,queryResponse:a}=this.props,l=parseInt(r.spacing(2).slice(0,-2),10),p=(0,u.css)({display:"flex",flexDirection:"column",gap:r.spacing(1)});return(0,t.jsx)(we,{panelId:"Logs",title:(0,d.t)("explore.explore.title-logs","Logs"),icon:"gf-logs",className:p,children:(0,t.jsx)(ka,{exploreId:o,loadingState:a.state,syncedTimes:n,width:s-l,onClickFilterLabel:this.onClickFilterLabel,onClickFilterOutLabel:this.onClickFilterOutLabel,onStartScanning:this.onStartScanning,onStopScanning:this.onStopScanning,eventBus:this.logsEventBus,splitOpenFn:this.splitOpenFnLogs,scrollElement:this.scrollElement,isFilterLabelActive:this.isFilterLabelActive,onClickFilterString:this.onClickFilterString,onClickFilterOutString:this.onClickFilterOutString,onPinLineCallback:this.onPinLineCallback})})}renderLogsSamplePanel(){const{logsSample:s,timeZone:o,setSupplementaryQueryEnabled:n,exploreId:r,datasourceInstance:a,queries:l}=this.props;return(0,t.jsx)(we,{panelId:"Logs Sample",title:(0,d.t)("explore.explore.title-logs-sample","Logs sample"),icon:"gf-logs",children:(0,t.jsx)(Ma,{queryResponse:s.data,timeZone:o,enabled:s.enabled,queries:l,datasourceInstance:a,splitOpen:this.onSplitOpen("logsSample"),setLogsSampleEnabled:p=>n(r,p,ie.cF.LogsSample)})})}renderNodeGraphPanel(){const{exploreId:s,showTrace:o,queryResponse:n,datasourceInstance:r}=this.props,a=r?r?.type:"unknown";return(0,t.jsx)(we,{panelId:"Node Graph",title:(0,d.t)("explore.explore.title-node-graph","Node graph"),icon:"code-branch",children:(0,t.jsx)(qa,{dataFrames:n.nodeGraphFrames,exploreId:s,withTraceView:o,datasourceType:a,splitOpenFn:this.onSplitOpen("nodeGraph")})})}renderFlameGraphPanel(){const{queryResponse:s}=this.props;return(0,t.jsx)(we,{panelId:"Flame Graph",title:(0,d.t)("explore.explore.title-flame-graph","Flame graph"),icon:"fire",children:(0,t.jsx)(ur,{dataFrames:s.flameGraphFrames})})}renderTraceViewPanel(){const{queryResponse:s,exploreId:o}=this.props,n=s.series.filter(r=>r.meta?.preferredVisualisationType==="trace");return n.length&&(0,t.jsx)(we,{panelId:"Traces",title:(0,d.t)("explore.explore.title-traces","Traces"),icon:"file-alt",children:(0,t.jsx)(ji,{exploreId:o,dataFrames:n,splitOpenFn:this.onSplitOpen("traceView"),scrollElement:this.scrollElement,timeRange:s.timeRange})})}render(){const{datasourceInstance:s,exploreId:o,graphResult:n,queryResponse:r,isLive:a,theme:l,showMetrics:p,showTable:f,showRawPrometheus:x,showLogs:g,showTrace:h,showCustom:m,showNodeGraph:y,showFlameGraph:T,showLogsSample:b,correlationEditorDetails:C,correlationEditorHelperData:S,showQueryInspector:E,setShowQueryInspector:w}=this.props,{contentOutlineVisible:v}=this.state,L=Ti(l),j=r&&r.state!==be.Gu.NotStarted,F=!(0,vt.gQ)().queryHistoryAvailable,$=r.state===be.Gu.Done&&[r.logsFrames,r.graphFrames,r.nodeGraphFrames,r.flameGraphFrames,r.tableFrames,r.rawPrometheusFrames,r.traceFrames,r.customFrames].every(Y=>Y.length===0);let z;const U=C?.editorMode;return!!(U||C?.correlationDirty)&&S!==void 0&&(z=(0,t.jsx)(Nn,{exploreId:o,correlations:S})),(0,t.jsxs)(jn,{refreshDependencies:this.props.queries,children:[(0,t.jsx)(cr,{exploreId:o,onChangeTime:this.onChangeTime,onContentOutlineToogle:this.onContentOutlineToogle,isContentOutlineOpen:v}),(0,t.jsx)("div",{style:{position:"relative",height:"100%",paddingLeft:l.spacing(2)},children:(0,t.jsxs)("div",{className:L.wrapper,children:[v&&(0,t.jsx)(Ln,{scroller:this.scrollElement,panelId:`content-outline-container-${o}`}),(0,t.jsx)(os.P,{"data-testid":Ge.Tp.pages.Explore.General.scrollView,ref:Y=>this.scrollElement=Y||void 0,children:(0,t.jsx)("div",{className:L.exploreContainer,children:s?(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(we,{panelId:"Queries",title:(0,d.t)("explore.explore.title-queries","Queries"),icon:"arrow",mergeSingleChild:!0,children:(0,t.jsxs)(ns._,{className:L.queryContainer,children:[(0,t.jsx)(Vn,{datasourceType:s?.type||""}),z,(0,t.jsx)(Xa,{exploreId:o}),(0,t.jsx)(fi,{addQueryRowButtonDisabled:a||U&&s.meta.mixed,addQueryRowButtonHidden:!1,richHistoryRowButtonHidden:F,queryInspectorButtonActive:E,onClickAddQueryRowButton:this.onClickAddQueryRowButton,onClickQueryInspectorButton:()=>w(!E),onSelectQueryFromLibrary:async Y=>{const{changeDatasource:q,queries:G,setQueries:ue}=this.props,I=[...G,{...Y,refId:(0,Ks.M)(G)}];if(ue(o,I),Y.datasource?.uid){const Q={uid:new Set(I.map(O=>O.datasource?.uid)).size>1?st.uv:Y.datasource.uid};s.uid!==Q.uid&&await q({exploreId:o,datasource:Q})}}}),(0,t.jsx)(gi,{exploreId:o})]})}),(0,t.jsx)(vn.default,{onResize:this.onResize,disableHeight:!0,children:({width:Y})=>Y===0?null:(0,t.jsx)("main",{className:(0,u.cx)(L.exploreMain),style:{width:Y},children:(0,t.jsx)(re.Xw,{children:j&&(0,t.jsxs)(t.Fragment,{children:[p&&n&&(0,t.jsx)(re.Xw,{children:this.renderGraphPanel(Y)}),x&&(0,t.jsx)(re.Xw,{children:this.renderRawPrometheus(Y)}),f&&(0,t.jsx)(re.Xw,{children:this.renderTablePanel(Y)}),g&&(0,t.jsx)(re.Xw,{children:this.renderLogsPanel(Y)}),y&&(0,t.jsx)(re.Xw,{children:this.renderNodeGraphPanel()}),T&&(0,t.jsx)(re.Xw,{children:this.renderFlameGraphPanel()}),h&&(0,t.jsx)(re.Xw,{children:this.renderTraceViewPanel()}),b&&(0,t.jsx)(re.Xw,{children:this.renderLogsSamplePanel()}),m&&(0,t.jsx)(re.Xw,{children:this.renderCustom(Y)}),$&&(0,t.jsx)(re.Xw,{children:this.renderNoData()})]})})})})]}):this.renderEmptyState(L.exploreContainer)})})]})})]})}}function Li(e,{exploreId:s}){const o=e.explore,{syncedTimes:n}=o,r=o.panes[s],a=(0,At.O)(e.user),{datasourceInstance:l,queryKeys:p,queries:f,isLive:x,graphResult:g,tableResult:h,logsResult:m,showLogs:y,showMetrics:T,showTable:b,showTrace:C,showCustom:S,queryResponse:E,showNodeGraph:w,showFlameGraph:v,showRawPrometheus:L,supplementaryQueries:j,correlationEditorHelperData:F}=r,$=(0,Z.h1)(s)(e),z=j[ie.cF.LogsSample],U=!!(z.dataProvider!==void 0&&!m&&(g||h));return{datasourceInstance:l,queryKeys:p,queries:f,isLive:x,graphResult:g,logsResult:m??void 0,queryResponse:E,syncedTimes:n,timeZone:a,showLogs:y,showMetrics:T,showTable:b,showTrace:C,showCustom:S,showNodeGraph:w,showRawPrometheus:L,showFlameGraph:v,splitted:(0,_.pF)(e),loading:$,logsSample:z,showLogsSample:U,correlationEditorHelperData:F,correlationEditorDetails:o.correlationEditorDetails,exploreActiveDS:(0,_.Kl)(e)}}const wi={changeDatasource:ke.wh,changeSize:Me.QZ,modifyQueries:Z.PD,scanStart:Z.GI,scanStopAction:Z.q9,setQueries:Z.Rk,updateTimeRange:Te.GH,addQueryRow:Z._0,splitOpen:X.ve,setSupplementaryQueryEnabled:Z.TO},Ii=(0,Le.connect)(Li,wi),Ei=(0,P.cV)(Ii(Ri));var Wo=i(86848),Oi=i(42836),Fi=i(80307),Di=i(82049),Ai=i(55072),Ni=i(96065);function Pi(e){const{onClose:s,queryResponse:o,timeZone:n,isMixed:r,exploreId:a}=e,[l,p]=(0,c.useState)({withTransforms:!1,withFieldConfig:!0}),f=o?.series||[];let x=o?.errors;!x?.length&&o?.error&&(x=[o.error]);const g=(0,P.of)(Bi);(0,c.useEffect)(()=>{(0,k.rR)("grafana_explore_query_inspector_opened")},[]);const h={label:"Stats",value:"stats",icon:"chart-line",content:(0,t.jsx)(Ai.N,{data:o,timeZone:o?.request?.timezone??ce.vp})},m={label:"JSON",value:"json",icon:"brackets-curly",content:(0,t.jsx)(Di.w,{data:o,onClose:s})},y={label:"Data",value:"data",icon:"database",content:(0,t.jsx)(Oi.q,{data:f,dataName:"Explore",isLoading:o.state===be.Gu.Loading,options:l,timeZone:n,app:$e.Jk.Explore,formattedDataDescription:"Matches the format in the panel",onOptionsChange:p})},T={label:"Query",value:"query",icon:"info-circle",content:(0,t.jsx)("div",{className:g.queryInspectorWrapper,children:(0,t.jsx)(Ni.e,{instanceId:r?(0,st.qM)(0,(0,yt.uq)(a)):(0,yt.uq)(a),data:o,onRefreshQuery:()=>e.runQueries({exploreId:a})})})},b=[h,T,m,y];if(x?.length){const C={label:"Error",value:"error",icon:"exclamation-triangle",content:(0,t.jsx)(Fi.y,{errors:x})};b.push(C)}return(0,t.jsx)(Qs,{children:(0,t.jsx)(Wo.q,{tabs:b,onClose:s,closeIconTooltip:"Close query inspector"})})}function ki(e,{exploreId:s}){const n=e.explore.panes[s],{queryResponse:r}=n;return{queryResponse:r,isMixed:n.datasourceInstance?.meta.mixed||!1}}const Mi={runQueries:Z.Od},Bi=e=>({queryInspectorWrapper:(0,u.css)({paddingBottom:e.spacing(3)})}),Hi=(0,Le.connect)(ki,Mi)(Pi),$i=(0,u.css)({label:"explorePaneContainer",display:"flex",flexDirection:"column",minWidth:"600px",height:"100%"});function Wi({exploreId:e}){Qi(e);const s=(0,c.useRef)(new ss.o),o=(0,c.useRef)(null),[n,r]=(0,c.useState)(!1);return(0,c.useEffect)(()=>{const a=s.current;return()=>a.removeAllListeners()},[]),(0,t.jsxs)("div",{className:$i,ref:o,"data-testid":Ge.Tp.pages.Explore.General.container,children:[(0,t.jsx)(Ei,{exploreId:e,eventBus:s.current,showQueryInspector:n,setShowQueryInspector:r}),n&&(0,t.jsx)(Hi,{exploreId:e,onClose:()=>r(!1),timeZone:(0,Us.O)()})]})}function Vi(e,s){return{pane:e.explore.panes[s.exploreId]}}const zi=(0,Le.connect)(Vi)(Wi);function Qi(e){const s=(0,c.useMemo)(()=>(0,_.qq)(e),[e]),o=(0,c.useRef)();o.current=(0,D.useSelector)(s),(0,c.useEffect)(()=>()=>{(0,yt._u)(o.current?.querySubscription)},[])}var De=i(11280);const Ui={queryLibrary:(0,d.t)("explore.rich-history.query-library","Query library"),queryHistory:(0,d.t)("explore.rich-history.query-history","Query history")};var Ki=i(21103),Vo=i(12737),Je=i(75234),Gi=i(87105),ws=i(6890),Is=i(64762),Xe=i(87745);const qi={setQueries:Z.Rk,changeDatasource:ke.wh},Zi=(0,Le.connect)(void 0,qi);function Yi({rootDatasourceUid:e,queries:s,disabled:o=!1,onClick:n,changeDatasource:r,setQueries:a}){const[l,p]=(0,c.useState)(!1),f=(0,D.useSelector)(_.pF),x=(0,D.useSelector)(_.Kl),g=(0,D.useSelector)(_.K6),h=(b,C)=>!x.dsToExplore.find(S=>S.datasource.uid===b)?.exploreIds.includes(C),m=(b,C)=>C!==void 0&&b!==void 0&&h(C,b)?{fallbackText:"Switch data source and run query",translation:(0,d.t)("explore.run-query.switch-datasource-button","Switch data source and run query")}:{fallbackText:"Run query",translation:(0,d.t)("explore.run-query.run-query-button","Run query")},y=async b=>{const C=h(e,b);C&&await r({exploreId:b,datasource:e}),a(b,s),(0,k.rR)("grafana_explore_query_history_run",{queryHistoryEnabled:V.$.queryHistoryEnabled,differentDataSource:C})},T=()=>{const b=o||s.length===0||e===void 0;if(f){const C=(0,t.jsx)(ze.W,{children:g.map((S,E)=>{const w=m(S[0],e),v=E===0?(0,d.t)("explore.run-query.left-pane","Left pane"):(0,d.t)("explore.run-query.right-pane","Right pane");return(0,t.jsx)(ze.W.Item,{ariaLabel:w.fallbackText,onClick:()=>{y(S[0]),n?.()},label:`${v}: ${w.translation}`,disabled:b||S[0]===void 0},E)})});return(0,t.jsx)(Ct.m,{onVisibleChange:S=>p(S),placement:"bottom-start",overlay:C,children:(0,t.jsx)(me.I,{"aria-label":(0,d.t)("explore.explore-run-query-button.run-button.aria-label-run-query-options","Run query options"),variant:"canvas",isOpen:l,children:(0,d.t)("explore.run-query.run-query-button","Run query")})})}else{const C=x.exploreToDS[0]?.exploreId,S=m(C,e);return(0,t.jsx)(B.$n,{variant:"primary","aria-label":S.translation,onClick:()=>{y(C),n?.()},disabled:b||C===void 0,children:S.translation})}};return(0,t.jsx)(t.Fragment,{children:T()})}const Ji=Zi(Yi),Xi=({query:e})=>{const[s,o]=(0,c.useState)(!1),{openAddQueryModal:n,queryLibraryEnabled:r}=(0,Mo.Y)(),a=(0,d.t)("explore.rich-history-card.add-to-library","Add to library");return r&&!s?(0,t.jsx)(t.Fragment,{children:(0,t.jsx)(B.$n,{variant:"secondary","aria-label":a,onClick:()=>{n(e,{onSave:()=>o(!0),context:"richHistory"})},children:a})}):void 0},_i={changeDatasource:ke.wh,deleteHistoryItem:De.VM,commentHistoryItem:De.H9,starHistoryItem:De.sh,setQueries:Z.Rk},el=(0,Le.connect)(void 0,_i),tl=e=>{const s="240px",o="170px",n=e.colors.background.secondary;return{queryCard:(0,u.css)({position:"relative",display:"flex",flexDirection:"column",border:`1px solid ${e.colors.border.weak}`,margin:e.spacing(1,0),backgroundColor:n,borderRadius:e.shape.radius.default,".starred":{color:e.v1.palette.orange}}),cardRow:(0,u.css)({display:"flex",alignItems:"center",justifyContent:"space-between",padding:e.spacing(1),borderBottom:"none",":first-of-type":{borderBottom:`1px solid ${e.colors.border.weak}`,padding:e.spacing(.5,1)},img:{height:`${e.typography.fontSize}px`,maxWidth:`${e.typography.fontSize}px`,marginRight:e.spacing(1)}}),queryActionButtons:(0,u.css)({maxWidth:o,display:"flex",justifyContent:"flex-end",fontSize:e.typography.size.base,button:{marginLeft:e.spacing(1)}}),queryContainer:(0,u.css)({fontWeight:e.typography.fontWeightMedium,width:`calc(100% - ${s})`}),updateCommentContainer:(0,u.css)({width:`calc(100% + ${s})`,marginTop:e.spacing(1)}),comment:(0,u.css)({overflowWrap:"break-word",fontSize:e.typography.bodySmall.fontSize,fontWeight:e.typography.fontWeightRegular,marginTop:e.spacing(.5)}),commentButtonRow:(0,u.css)({"> *":{marginTop:e.spacing(1),marginRight:e.spacing(1)}}),textArea:(0,u.css)({width:"100%"}),runButton:(0,u.css)({maxWidth:o,display:"flex",justifyContent:"flex-end",button:{height:"auto",padding:e.spacing(.5,2),lineHeight:1.4,span:{whiteSpace:"normal !important"}}}),loader:(0,u.css)({position:"absolute",width:"100%",height:"100%",display:"flex",alignItems:"center",justifyContent:"center",backgroundColor:e.colors.background.secondary})}};function sl(e){const{queryHistoryItem:s,commentHistoryItem:o,starHistoryItem:n,deleteHistoryItem:r,datasourceInstances:a}=e,[l,p]=(0,c.useState)(!1),[f,x]=(0,c.useState)(s.comment),g=(0,P.of)(tl),h=a?a.find(j=>j.uid===s.datasourceUid):void 0,m=async()=>{const j=[...s.queries.map($=>$.datasource?.type||"unknown")];(0,k.rR)("grafana_explore_query_history_copy_query",{datasources:j,mixed:!!h?.meta.mixed});const F=s.queries.map($=>{let z=a?.find(U=>U.uid===s.datasourceUid);return z?.meta.mixed&&(z=a?.find(U=>U.uid===$.datasource?.uid)),(0,fe.Ax)($,z)}).join(`
`);(0,yt.uJ)(F),(0,jt.JD)((0,ws.dx)((0,Is.tZ)((0,d.t)("explore.rich-history-notification.query-copied","Query copied to clipboard"))))},y=async()=>{const j=(0,fe.U3)(s);await(0,Vt.VP)(j)},T=()=>{const j=F=>{r(F),(0,jt.JD)((0,ws.dx)((0,Is.tZ)((0,d.t)("explore.rich-history-notification.query-deleted","Query deleted")))),(0,k.rR)("grafana_explore_query_history_deleted",{queryHistoryEnabled:V.$.queryHistoryEnabled})};s.starred?(0,Je.J7)().publish(new Xe.bY({title:(0,d.t)("explore.rich-history-card.delete-query-confirmation-title","Delete"),text:(0,d.t)("explore.rich-history-card.delete-starred-query-confirmation-text","Are you sure you want to permanently delete your starred query?"),yesText:(0,d.t)("explore.rich-history-card.confirm-delete","Delete"),icon:"trash-alt",onConfirm:()=>j(s.id)})):j(s.id)},b=()=>{n(s.id,!s.starred),(0,k.rR)("grafana_explore_query_history_starred",{queryHistoryEnabled:V.$.queryHistoryEnabled,newValue:!s.starred})},C=()=>p(!l),S=()=>{o(s.id,f),p(!1),(0,k.rR)("grafana_explore_query_history_commented",{queryHistoryEnabled:V.$.queryHistoryEnabled})},E=()=>{p(!1),x(s.comment)},w=j=>{j.key==="Enter"&&(j.shiftKey||j.ctrlKey)&&S(),j.key==="Escape"&&E()},v=(0,t.jsxs)("div",{className:g.updateCommentContainer,"aria-label":f?(0,d.t)("explore.rich-history-card.update-comment-form","Update comment form"):(0,d.t)("explore.rich-history-card.add-comment-form","Add comment form"),children:[(0,t.jsx)(Gi.f,{onKeyDown:w,value:f,placeholder:f?void 0:(0,d.t)("explore.rich-history-card.optional-description","An optional description of what the query does."),onChange:j=>x(j.currentTarget.value),className:g.textArea}),(0,t.jsxs)("div",{className:g.commentButtonRow,children:[(0,t.jsx)(B.$n,{onClick:S,children:(0,t.jsx)(d.x6,{i18nKey:"explore.rich-history-card.save-comment",children:"Save comment"})}),(0,t.jsx)(B.$n,{variant:"secondary",onClick:E,children:(0,t.jsx)(d.x6,{i18nKey:"explore.rich-history-card.cancel",children:"Cancel"})})]})]}),L=(0,t.jsxs)("div",{className:g.queryActionButtons,children:[(0,t.jsx)(rt.K,{name:"comment-alt",onClick:C,tooltip:s.comment?.length>0?(0,d.t)("explore.rich-history-card.edit-comment-tooltip","Edit comment"):(0,d.t)("explore.rich-history-card.add-comment-tooltip","Add comment")}),(0,t.jsx)(rt.K,{name:"copy",onClick:m,tooltip:(0,d.t)("explore.rich-history-card.copy-query-tooltip","Copy query to clipboard")}),h&&(0,t.jsx)(rt.K,{name:"share-alt",onClick:y,tooltip:(0,t.jsx)(d.x6,{i18nKey:"explore.rich-history-card.copy-shortened-link-tooltip",children:"Copy shortened link to clipboard"})}),(0,t.jsx)(rt.K,{name:"trash-alt",title:(0,d.t)("explore.rich-history-card.delete-query-title","Delete query"),tooltip:(0,d.t)("explore.rich-history-card.delete-query-tooltip","Delete query"),onClick:T}),(0,t.jsx)(rt.K,{name:s.starred?"favorite":"star",iconType:s.starred?"mono":"default",onClick:b,tooltip:s.starred?(0,d.t)("explore.rich-history-card.unstar-query-tooltip","Unstar query"):(0,d.t)("explore.rich-history-card.star-query-tooltip","Star query")})]});return(0,t.jsxs)("div",{className:g.queryCard,children:[(0,t.jsxs)("div",{className:g.cardRow,children:[(0,t.jsx)(zo,{dsApi:h,size:"sm"}),L]}),(0,t.jsxs)("div",{className:(0,u.cx)(g.cardRow),children:[(0,t.jsxs)("div",{className:g.queryContainer,children:[s?.queries.map((j,F)=>{const $=a?.find(z=>z.uid===j.datasource?.uid);return(0,t.jsx)(nl,{query:{query:j,datasource:$},showDsInfo:h?.meta.mixed},`${j}-${F}`)}),!l&&s.comment&&(0,t.jsx)("div",{"aria-label":(0,d.t)("explore.rich-history-card.query-comment-label","Query comment"),className:g.comment,children:s.comment}),l&&v]}),!l&&(0,t.jsx)(Xi,{query:s?.queries[0]}),!l&&(0,t.jsx)("div",{className:g.runButton,children:(0,t.jsx)(Ji,{queries:s.queries,rootDatasourceUid:h?.uid})})]})]})}const ol=e=>({queryRow:(0,u.css)({borderTop:`1px solid ${e.colors.border.weak}`,display:"flex",flexDirection:"row",padding:e.spacing(.5,0),gap:e.spacing(.5),":first-child":{borderTop:"none"}}),dsInfoContainer:(0,u.css)({display:"flex",alignItems:"center"}),queryText:(0,u.css)({wordBreak:"break-all"})}),nl=({query:e,showDsInfo:s=!1})=>{const o=(0,P.of)(ol);return(0,t.jsxs)("div",{className:o.queryRow,children:[s&&(0,t.jsxs)("div",{className:o.dsInfoContainer,children:[(0,t.jsx)(zo,{dsApi:e.datasource,size:"md"}),": "]}),(0,t.jsx)("span",{"aria-label":(0,d.t)("explore.rich-history-card.query-text-label","Query text"),className:o.queryText,children:(0,fe.Ax)(e.query,e.datasource)})]})},rl=e=>s=>(0,u.css)({display:"flex",alignItems:"center",fontSize:s.typography[e==="sm"?"bodySmall":"body"].fontSize,fontWeight:s.typography.fontWeightMedium,whiteSpace:"nowrap"});function zo({dsApi:e,size:s}){const o=(0,c.useCallback)(r=>rl(s)(r),[s]),n=(0,P.of)(o);return(0,t.jsxs)("div",{className:n,children:[(0,t.jsx)("img",{src:e?.meta.info.logos.small||"public/img/icn-datasource.svg",alt:e?.type||(0,d.t)("explore.rich-history-card.datasource-not-exist","Data source does not exist anymore"),"aria-label":(0,d.t)("explore.rich-history-card.datasource-icon-label","Data source icon")}),(0,t.jsx)("div",{"aria-label":(0,d.t)("explore.rich-history-card.datasource-name-label","Data source name"),children:e?.name||(0,d.t)("explore.rich-history-card.datasource-not-exist","Data source does not exist anymore")})]})}const Qo=el(sl),al=(e,s)=>({container:(0,u.css)({display:"flex"}),labelSlider:(0,u.css)({fontSize:e.typography.bodySmall.fontSize,"&:last-of-type":{marginTop:e.spacing(3)},"&:first-of-type":{fontWeight:e.typography.fontWeightMedium,marginBottom:e.spacing(2)}}),containerContent:(0,u.css)({width:"calc(100% - 134px)"}),containerSlider:(0,u.css)({width:"129px",marginRight:e.spacing(1)}),fixedSlider:(0,u.css)({position:"fixed"}),slider:(0,u.css)({bottom:"10px",height:`${s-180}px`,width:"129px",padding:e.spacing(1,0)}),selectors:(0,u.css)({display:"flex",justifyContent:"space-between",flexWrap:"wrap"}),filterInput:(0,u.css)({marginBottom:e.spacing(1)}),multiselect:(0,u.css)({width:"100%",marginBottom:e.spacing(1)}),sort:(0,u.css)({width:"170px"}),sessionName:(0,u.css)({display:"flex",alignItems:"flex-start",justifyContent:"flex-start",marginTop:e.spacing(3),h4:{margin:"0 10px 0 0"}}),heading:(0,u.css)({fontSize:e.typography.h4.fontSize,margin:e.spacing(2,.25,1,.25)}),footer:(0,u.css)({height:"60px",display:"flex",justifyContent:"center",alignItems:"center",fontWeight:e.typography.fontWeightLight,fontSize:e.typography.bodySmall.fontSize,a:{fontWeight:e.typography.fontWeightMedium,marginLeft:e.spacing(.25)}}),queries:(0,u.css)({fontSize:e.typography.bodySmall.fontSize,fontWeight:e.typography.fontWeightRegular,marginLeft:e.spacing(.5)})});function il(e){const{queries:s,totalQueries:o,loading:n,richHistorySearchFilters:r,updateFilters:a,clearRichHistoryResults:l,loadMoreRichHistory:p,richHistorySettings:f,height:x,listOfDatasources:g,activeDatasources:h}=e,m=(0,P.of)(al,x);(0,c.useEffect)(()=>{const w=!f.activeDatasourcesOnly&&f.lastUsedDatasourceFilters?f.lastUsedDatasourceFilters:h,v={search:"",sortOrder:fe.xB.Descending,datasourceFilters:w,from:0,to:f.retentionPeriod,starred:!1};return a(v),()=>{l()}},[]);const{value:y,loading:T}=(0,is.A)(async()=>{const v=g.map(L=>L.uid).map(async L=>{try{return(0,qe.l)().get(L)}catch{return Promise.resolve()}});return v!==void 0?(await Promise.all(v)).filter(j=>!!j):[]},[r?.datasourceFilters]);if(!r)return(0,t.jsx)("span",{children:(0,t.jsx)(d.x6,{i18nKey:"explore.rich-history-queries-tab.loading",children:"Loading..."})});const b=(0,fe.x8)(s,r.sortOrder),C=Ko(),S=s.length&&s.length!==o,E=[r.from||0,r.to||f.retentionPeriod];return(0,t.jsxs)("div",{className:m.container,children:[(0,t.jsx)("div",{className:m.containerSlider,children:(0,t.jsxs)("div",{className:m.fixedSlider,children:[(0,t.jsx)("div",{className:m.labelSlider,children:(0,t.jsx)(d.x6,{i18nKey:"explore.rich-history-queries-tab.filter-history",children:"Filter history"})}),(0,t.jsx)("div",{className:m.labelSlider,children:(0,fe.IA)(E[0])}),(0,t.jsx)("div",{className:m.slider,children:(0,t.jsx)(Ki.F,{tooltipAlwaysVisible:!1,min:0,max:f.retentionPeriod,value:E,orientation:"vertical",formatTooltipResult:fe.IA,reverse:!0,onAfterChange:w=>{a({from:w[0],to:w[1]})}})}),(0,t.jsx)("div",{className:m.labelSlider,children:(0,fe.IA)(E[1])})]})}),(0,t.jsxs)("div",{className:m.containerContent,"data-testid":"query-history-queries-tab",children:[(0,t.jsxs)("div",{className:m.selectors,children:[!f.activeDatasourcesOnly&&(0,t.jsx)(Ve.KF,{className:m.multiselect,options:g.map(w=>({value:w.name,label:w.name})),value:r.datasourceFilters,placeholder:(0,d.t)("explore.rich-history-queries-tab.filter-placeholder","Filter queries for data sources(s)"),"aria-label":(0,d.t)("explore.rich-history-queries-tab.filter-aria-label","Filter queries for data sources(s)"),onChange:w=>{a({datasourceFilters:w.map(v=>v.value)})}}),(0,t.jsx)("div",{className:m.filterInput,children:(0,t.jsx)(Vo.Z,{escapeRegex:!1,placeholder:(0,d.t)("explore.rich-history-queries-tab.search-placeholder","Search queries"),value:r.search,onChange:w=>a({search:w})})}),(0,t.jsx)("div",{"aria-label":(0,d.t)("explore.rich-history-queries-tab.sort-aria-label","Sort queries"),className:m.sort,children:(0,t.jsx)(Ve.l6,{value:C.filter(w=>w.value===r.sortOrder),options:C,placeholder:(0,d.t)("explore.rich-history-queries-tab.sort-placeholder","Sort queries by"),onChange:w=>a({sortOrder:w.value})})})]}),(n||T)&&(0,t.jsx)("span",{children:(0,t.jsx)(d.x6,{i18nKey:"explore.rich-history-queries-tab.loading-results",children:"Loading results..."})}),!(n||T)&&Object.keys(b).map(w=>(0,t.jsxs)("div",{children:[(0,t.jsxs)("div",{className:m.heading,children:[w," ",(0,t.jsx)("span",{className:m.queries,children:S?(0,t.jsx)(d.x6,{i18nKey:"explore.rich-history-queries-tab.displaying-partial-queries",defaults:"Displaying {{ count }} queries",values:{count:b[w].length}}):(0,t.jsx)(d.x6,{i18nKey:"explore.rich-history-queries-tab.displaying-queries",defaults:"{{ count }} queries",values:{count:b[w].length}})})]}),b[w].map(v=>(0,t.jsx)(Qo,{datasourceInstances:y,queryHistoryItem:v},v.id))]},w)),S?(0,t.jsx)("div",{children:(0,t.jsx)(d.x6,{i18nKey:"explore.rich-history-queries-tab.showing-queries",defaults:"Showing {{ shown }} of {{ total }} <0>Load more</0>",values:{shown:s.length,total:o},components:[(0,t.jsx)(B.$n,{onClick:p,children:"Load more"},"loadMoreButton")]})}):null,(0,t.jsx)("div",{className:m.footer,children:V.$.queryHistoryEnabled?"":(0,d.t)("explore.rich-history-queries-tab.history-local","The history is local to your browser and is not shared with others.")})]})]})}var ll=i(66594);const cl=e=>({container:(0,u.css)({fontSize:e.typography.bodySmall.fontSize}),spaceBetween:(0,u.css)({marginBottom:e.spacing(3)}),input:(0,u.css)({maxWidth:"200px"}),bold:(0,u.css)({fontWeight:e.typography.fontWeightBold}),bottomMargin:(0,u.css)({marginBottom:e.spacing(1)})}),Uo=[{value:2,label:(0,d.t)("explore.rich-history-settings-tab.retention-period.2-days","2 days")},{value:5,label:(0,d.t)("explore.rich-history-settings-tab.retention-period.5-days","5 days")},{value:7,label:(0,d.t)("explore.rich-history-settings-tab.retention-period.1-week","1 week")},{value:14,label:(0,d.t)("explore.rich-history-settings-tab.retention-period.2-weeks","2 weeks")}];function dl(e){const{retentionPeriod:s,starredTabAsFirstTab:o,activeDatasourcesOnly:n,onChangeRetentionPeriod:r,toggleStarredTabAsFirstTab:a,toggleActiveDatasourcesOnly:l,deleteRichHistory:p}=e,f=(0,P.of)(cl),x=Uo.find(h=>h.value===s),g=()=>{(0,Je.J7)().publish(new Xe.bY({title:(0,d.t)("explore.rich-history-settings-tab.delete-title","Delete"),text:(0,d.t)("explore.rich-history-settings-tab.delete-confirm-text","Are you sure you want to permanently delete your query history?"),yesText:(0,d.t)("explore.rich-history-settings-tab.delete-confirm","Delete"),icon:"trash-alt",onConfirm:()=>{p(),(0,jt.JD)((0,ws.dx)((0,Is.tZ)((0,d.t)("explore.rich-history-settings-tab.query-history-deleted","Query history deleted"))))}}))};return(0,t.jsxs)("div",{className:f.container,children:[(0,vt.gQ)().changeRetention?(0,t.jsx)(Be.D,{label:(0,d.t)("explore.rich-history-settings-tab.history-time-span","History time span"),description:(0,d.t)("explore.rich-history-settings-tab.history-time-span-description","Select the period of time for which Grafana will save your query history. Up to {{MAX_HISTORY_ITEMS}} entries will be stored.",{MAX_HISTORY_ITEMS:ll.$H}),children:(0,t.jsx)("div",{className:f.input,children:(0,t.jsx)(Ve.l6,{value:x,options:Uo,onChange:r})})}):(0,t.jsx)(nt.F,{severity:"info",title:(0,d.t)("explore.rich-history-settings-tab.history-time-span","History time span"),children:(0,d.t)("explore.rich-history-settings-tab.alert-info","Grafana will keep entries up to {{optionLabel}}.Starred entries won't be deleted.",{optionLabel:x?.label})}),(0,t.jsx)(Fe.I,{label:(0,d.t)("explore.rich-history-settings-tab.change-default-tab","Change the default active tab from \u201CQuery history\u201D to \u201CStarred\u201D"),className:f.spaceBetween,children:(0,t.jsx)(Ze.K,{id:"explore-query-history-settings-default-active-tab",value:o,onChange:a})}),(0,vt.gQ)().onlyActiveDataSource&&(0,t.jsx)(Fe.I,{label:(0,d.t)("explore.rich-history-settings-tab.only-show-active-datasource","Only show queries for data source currently active in Explore"),className:f.spaceBetween,children:(0,t.jsx)(Ze.K,{id:"explore-query-history-settings-data-source-behavior",value:n,onChange:l})}),(0,vt.gQ)().clearHistory&&(0,t.jsxs)("div",{children:[(0,t.jsx)("div",{className:f.bold,children:(0,t.jsx)(d.x6,{i18nKey:"explore.rich-history-settings-tab.clear-query-history",children:"Clear query history"})}),(0,t.jsx)("div",{className:f.bottomMargin,children:(0,t.jsx)(d.x6,{i18nKey:"explore.rich-history-settings-tab.clear-history-info",children:"Delete all of your query history, permanently."})}),(0,t.jsx)(B.$n,{variant:"destructive",onClick:g,children:(0,t.jsx)(d.x6,{i18nKey:"explore.rich-history-settings-tab.clear-query-history-button",children:"Clear query history"})})]})]})}const ul=e=>({container:(0,u.css)({display:"flex"}),containerContent:(0,u.css)({width:"100%"}),selectors:(0,u.css)({display:"flex",justifyContent:"space-between",flexWrap:"wrap"}),multiselect:(0,u.css)({width:"100%",marginBottom:e.spacing(1)}),filterInput:(0,u.css)({marginBottom:e.spacing(1)}),sort:(0,u.css)({width:"170px"}),footer:(0,u.css)({height:"60px",display:"flex",justifyContent:"center",alignItems:"center",fontWeight:e.typography.fontWeightLight,fontSize:e.typography.bodySmall.fontSize,a:{fontWeight:e.typography.fontWeightMedium,marginLeft:e.spacing(.25)}})});function pl(e){const{updateFilters:s,clearRichHistoryResults:o,loadMoreRichHistory:n,richHistorySettings:r,queries:a,totalQueries:l,loading:p,richHistorySearchFilters:f}=e,x=(0,P.of)(ul),g=(0,D.useSelector)(_.Kl),h=(0,fe.TR)();(0,c.useEffect)(()=>{const b=r.activeDatasourcesOnly&&r.lastUsedDatasourceFilters?r.lastUsedDatasourceFilters:g.dsToExplore.map(S=>h.find(E=>E.uid===S.datasource?.uid)?.name).filter(S=>!!S),C={search:"",sortOrder:fe.xB.Descending,datasourceFilters:b,from:0,to:r.retentionPeriod,starred:!0};return s(C),()=>{o()}},[]);const{value:m,loading:y}=(0,is.A)(async()=>{const C=await(f?.datasourceFilters&&f?.datasourceFilters.length>0?f?.datasourceFilters:h.map(S=>S.uid)).map(async S=>{try{return(0,qe.l)().get(S)}catch{return Promise.resolve()}});return C!==void 0?(await Promise.all(C)).filter(E=>!!E):[]},[f?.datasourceFilters]);if(!f)return(0,t.jsxs)("span",{children:[(0,t.jsx)(d.x6,{i18nKey:"explore.rich-history-starred-tab.loading",children:"Loading..."}),";"]});const T=Ko();return(0,t.jsx)("div",{className:x.container,children:(0,t.jsxs)("div",{className:x.containerContent,children:[(0,t.jsxs)("div",{className:x.selectors,children:[!r.activeDatasourcesOnly&&(0,t.jsx)(Ve.KF,{className:x.multiselect,options:h.map(b=>({value:b.name,label:b.name})),value:f.datasourceFilters,placeholder:(0,d.t)("explore.rich-history-starred-tab.filter-queries-placeholder","Filter queries for data sources(s)"),"aria-label":(0,d.t)("explore.rich-history-starred-tab.filter-queries-aria-label","Filter queries for data sources(s)"),onChange:b=>{s({datasourceFilters:b.map(C=>C.value)})}}),(0,t.jsx)("div",{className:x.filterInput,children:(0,t.jsx)(Vo.Z,{escapeRegex:!1,placeholder:(0,d.t)("explore.rich-history-starred-tab.search-queries-placeholder","Search queries"),value:f.search,onChange:b=>s({search:b})})}),(0,t.jsx)("div",{"aria-label":(0,d.t)("explore.rich-history-starred-tab.sort-queries-aria-label","Sort queries"),className:x.sort,children:(0,t.jsx)(Ve.l6,{value:T.filter(b=>b.value===f.sortOrder),options:T,placeholder:(0,d.t)("explore.rich-history-starred-tab.sort-queries-placeholder","Sort queries by"),onChange:b=>s({sortOrder:b.value})})})]}),p&&y&&(0,t.jsx)("span",{children:(0,t.jsx)(d.x6,{i18nKey:"explore.rich-history-starred-tab.loading-results",children:"Loading results..."})}),!(p&&y)&&a.map(b=>(0,t.jsx)(Qo,{queryHistoryItem:b,datasourceInstances:m},b.id)),a.length&&a.length!==l?(0,t.jsx)("div",{children:(0,t.jsx)(d.x6,{i18nKey:"explore.rich-history-starred-tab.showing-queries",defaults:"Showing {{ shown }} of {{ total }} <0>Load more</0>",values:{shown:a.length,total:l},components:[(0,t.jsx)(B.$n,{onClick:n,children:"Load more"},"loadMoreButton")]})}):null,(0,t.jsx)("div",{className:x.footer,children:V.$.queryHistoryEnabled?"":(0,d.t)("explore.rich-history-starred-tab.local-history-message","The history is local to your browser and is not shared with others.")})]})})}const Ko=()=>[{label:(0,d.t)("explore.rich-history.newest-first","Newest first"),value:fe.xB.Descending},{label:(0,d.t)("explore.rich-history.oldest-first","Oldest first"),value:fe.xB.Ascending},{label:(0,d.t)("explore.rich-history.datasource-a-z","Data source A-Z"),value:fe.xB.DatasourceAZ},{label:(0,d.t)("explore.rich-history.datasource-z-a","Data source Z-A"),value:fe.xB.DatasourceZA}].filter(e=>(0,vt.gQ)().availableFilters.includes(e.value));function gl(e){const{richHistory:s,richHistoryTotal:o,height:n,deleteRichHistory:r,onClose:a,firstTab:l}=e,[p,f]=(0,c.useState)(!1),x=j=>{e.updateHistorySettings({...e.richHistorySettings,...j})},g=j=>{const F={...e.richHistorySearchFilters,...j,page:1};e.updateHistorySearchFilters(F),h()},h=(0,ne.debounce)(()=>{e.loadRichHistory(),f(!0)},300),m=j=>{j.value!==void 0&&x({retentionPeriod:j.value})},y=()=>x({starredTabAsFirstTab:!e.richHistorySettings.starredTabAsFirstTab}),T=()=>x({activeDatasourcesOnly:!e.richHistorySettings.activeDatasourcesOnly});(0,c.useEffect)(()=>{f(!1)},[s]);const b=(0,D.useSelector)(_.Kl),C=(0,fe.TR)(),S=b.dsToExplore.map(j=>C.find(F=>F.uid===j.datasource?.uid)?.name).filter(j=>!!j),E={label:Ui.queryHistory,value:it.tU.RichHistory,content:(0,t.jsx)(il,{queries:s,totalQueries:o||0,loading:p,updateFilters:g,clearRichHistoryResults:()=>e.clearRichHistoryResults(),loadMoreRichHistory:()=>e.loadMoreRichHistory(),richHistorySettings:e.richHistorySettings,richHistorySearchFilters:e.richHistorySearchFilters,height:n,activeDatasources:S,listOfDatasources:C}),icon:"history"},w={label:(0,d.t)("explore.rich-history.starred","Starred"),value:it.tU.Starred,content:(0,t.jsx)(pl,{queries:s,totalQueries:o||0,loading:p,updateFilters:g,clearRichHistoryResults:()=>e.clearRichHistoryResults(),loadMoreRichHistory:()=>e.loadMoreRichHistory(),richHistorySettings:e.richHistorySettings,richHistorySearchFilters:e.richHistorySearchFilters}),icon:"star"},v={label:(0,d.t)("explore.rich-history.settings","Settings"),value:it.tU.Settings,content:(0,t.jsx)(dl,{retentionPeriod:e.richHistorySettings.retentionPeriod,starredTabAsFirstTab:e.richHistorySettings.starredTabAsFirstTab,activeDatasourcesOnly:e.richHistorySettings.activeDatasourcesOnly,onChangeRetentionPeriod:m,toggleStarredTabAsFirstTab:y,toggleActiveDatasourcesOnly:T,deleteRichHistory:r}),icon:"sliders-v-alt"};let L=[E,w,v];return(0,t.jsx)(Wo.q,{tabs:L,onClose:a,defaultTab:l,closeIconTooltip:(0,d.t)("explore.rich-history.close-tooltip","Close query history"),testId:Ge.Tp.pages.Explore.QueryHistory.container})}function hl(e){const s=e.explore,o=s.richHistorySearchFilters,{richHistorySettings:n,richHistory:r,richHistoryTotal:a}=s;return{richHistory:r,richHistoryTotal:a,richHistorySettings:n,richHistorySearchFilters:o}}const fl={initRichHistory:De.PA,loadRichHistory:De.jX,loadMoreRichHistory:De.Uu,clearRichHistoryResults:De.wk,updateHistorySettings:De.fP,updateHistorySearchFilters:De.Bj,deleteRichHistory:De.s1},ml=(0,Le.connect)(hl,fl);function xl(e){const s=(0,P.$j)(),{richHistory:o,richHistoryTotal:n,deleteRichHistory:r,initRichHistory:a,loadRichHistory:l,loadMoreRichHistory:p,clearRichHistoryResults:f,richHistorySettings:x,updateHistorySettings:g,richHistorySearchFilters:h,updateHistorySearchFilters:m,onClose:y}=e;(0,c.useEffect)(()=>{a()},[a]);const{selectedTab:T}=(0,it.sz)(),[b,C]=(0,c.useState)(!1);return(0,c.useEffect)(()=>{b||(C(!0),(0,k.rR)("grafana_explore_query_history_opened",{queryHistoryEnabled:V.$.queryHistoryEnabled,selectedTab:T}))},[b,T]),x?(0,t.jsx)(gl,{richHistory:o,richHistoryTotal:n,firstTab:T,onClose:y,height:s.components.horizontalDrawer.defaultHeight,deleteRichHistory:r,richHistorySettings:x,richHistorySearchFilters:h,updateHistorySettings:g,updateHistorySearchFilters:m,loadRichHistory:l,loadMoreRichHistory:p,clearRichHistoryResults:f}):(0,t.jsx)("span",{children:(0,t.jsx)(d.x6,{i18nKey:"explore.rich-history-container.loading",children:"Loading..."})})}const yl=ml(xl);var Go=i(92948),qo=i(8692);function vl(e){const s=(0,ht.C)("explore"),{chrome:o}=(0,et.Il)();(0,c.useEffect)(()=>{if(!e.panes||typeof e.panes!="string")return;let n;try{n=JSON.parse(e.panes)}catch{return}typeof n!="object"||n===null||Promise.allSettled(Object.values(n).map(r=>!r||typeof r!="object"||!(0,qo.C)("datasource",r)||!r.datasource||typeof r.datasource!="string"?Promise.reject():(0,qe.l)().get(r.datasource))).then(r=>r.filter(qo.s).map(a=>a.value)).then(r=>{if(r.length===0){i.g.document.title=`${s.main.text} - ${Go.M.AppTitle}`,o.update({pageNav:void 0});return}const a=r.map(l=>l.name).join(" | ");o.update({pageNav:{text:a}}),i.g.document.title=`${s.main.text} - ${a} - ${Go.M.AppTitle}`})},[e.panes,s.main.text,o])}function bl(){const{keybindings:e}=(0,et.Il)(),s=(0,D.useDispatch)();(0,c.useEffect)(()=>{e.setupTimeRangeBindings(!1);const o=[];return o.push((0,Je.J7)().subscribe(Xe.Rh,()=>{s((0,Te.$_)())})),o.push((0,Je.J7)().subscribe(Xe.Io,n=>{s((0,Te.Iy)(n.payload.direction))})),o.push((0,Je.J7)().subscribe(Xe.U0,n=>{s((0,Te.ke)(n.payload.scale))})),o.push((0,Je.J7)().subscribe(Xe.Bt,()=>{s((0,Te.Xk)())})),o.push((0,Je.J7)().subscribe(Xe.VZ,()=>{s((0,Te.GA)())})),()=>{o.forEach(n=>n.unsubscribe())}},[s,e])}const Cl=e=>{const s=(0,D.useDispatch)(),{width:o}=(0,Ts.A)(),n=(0,D.useSelector)(_.K6),r=(0,D.useSelector)(_.pF),[a,l]=(0,c.useState)(.5),p=(0,D.useSelector)(g=>g.explore),f=g=>{const h=o/2,m=(0,ne.inRange)(g,h-100,h+100);s(m?(0,X.nD)({largerExploreId:void 0}):(0,X.nD)({largerExploreId:g>h?n[1][0]:n[0][0]})),l(g/o)};let x=0;return r&&(!p.evenSplitPanes&&p.maxedExploreId?x=p.maxedExploreId===n[1][0]?o-e:e:p.evenSplitPanes?x=Math.floor(o/2):a!==void 0&&(x=o*a)),{updateSplitSize:f,widthCalc:x}};function Sl(){const{location:e}=(0,et.Il)();(0,c.useEffect)(()=>{const s=e.getSearchObject();(s.from||s.to)&&e.partial({from:void 0,to:void 0},!0)},[e])}const Es=200;function jl(e){return(0,t.jsx)(Tl,{...e})}function Tl(e){const s=(0,P.of)(Rl),o=(0,P.$j)();Sl(),(0,wo.s)(e.queryParams),vl(e.queryParams);const{chrome:n}=(0,et.Il)(),r=(0,ht.C)("explore"),{updateSplitSize:a,widthCalc:l}=Cl(Es),p=(0,D.useSelector)(_.K6),f=(0,D.useSelector)(_.pF),x=(0,D.useSelector)(_.vC),{drawerOpened:g,setDrawerOpened:h}=(0,it.sz)(),m=V.$.featureToggles.correlations&&(x?.editorMode||!1);return(0,c.useEffect)(()=>{n.update({sectionNav:r})},[n,r]),bl(),(0,t.jsxs)("div",{className:(0,u.cx)(s.pageScrollbarWrapper,{[s.correlationsEditorIndicator]:m}),children:[(0,t.jsx)("h1",{className:"sr-only",children:(0,t.jsx)(d.x6,{i18nKey:"nav.explore.title"})}),(0,t.jsx)(fn,{}),m&&(0,t.jsx)(gn,{panes:p}),(0,t.jsx)(Oe.g,{splitOrientation:"vertical",paneSize:l,minSize:Es,maxSize:Es*-1,primary:"second",splitVisible:f,parentStyle:m?{height:`calc(100% - ${o.spacing(6)}`}:{},paneStyle:{overflow:"auto",display:"flex",flexDirection:"column"},onDragFinished:y=>y&&a(y),children:p.map(([y])=>(0,t.jsx)(re.Xw,{style:"page",children:(0,t.jsx)(zi,{exploreId:y})},y))}),g&&(0,t.jsx)(Qs,{children:(0,t.jsx)(yl,{onClose:()=>{h(!1)}})})]})}const Rl=e=>({pageScrollbarWrapper:(0,u.css)({width:"100%",flexGrow:1,minHeight:0,height:"100%",position:"relative",overflow:"hidden"}),correlationsEditorIndicator:(0,u.css)({borderLeft:`4px solid ${e.colors.primary.main}`,borderRight:`4px solid ${e.colors.primary.main}`,borderBottom:`4px solid ${e.colors.primary.main}`,overflow:"scroll"})})},32776:(_t,We,i)=>{i.d(We,{S5:()=>mt,fq:()=>re,gy:()=>k,l1:()=>Ft});var t=i(2543),u=i.n(t),c=i(57866),V=i(33553),P=i(95004);const re=A=>(!A.pluginVersion&&"columns"in A&&console.log("Was angular table",A),A.options),Oe={timeseries_to_rows:"seriesToRows",timeseries_to_columns:"seriesToColumns",timeseries_aggregations:"reduce",table:"merge"},et={avg:"mean",min:"min",max:"max",total:"sum",current:"lastNotNull",count:"count"},ht={cell:"color-background",row:"color-background",value:"color-text"},d=(A,J)=>[-1/0,...A].map((K,B)=>({color:J[B],value:(0,t.isNumber)(K)?K:parseInt(K,10)})),D=(A,J)=>{const K=A.transformations??[];if(Object.keys(Oe).includes(J.transform)){const B={reducers:[]};J.transform==="timeseries_aggregations"&&(B.includeTimeField=!1,B.reducers=J.columns.map(Ne=>et[Ne.value])),K.push({id:Oe[J.transform],options:B})}return K},tt=A=>{const K={matcher:{id:/^\/.*\/$/.test(A.pattern)?c.Ct.byRegexp:c.Ct.byName,options:A.pattern},properties:[]};return A.alias&&K.properties.push({id:"displayName",value:A.alias}),A.unit&&K.properties.push({id:"unit",value:A.unit}),A.decimals&&K.properties.push({id:"decimals",value:A.decimals}),A.type==="date"&&K.properties.push({id:"unit",value:`time: ${A.dateFormat}`}),A.type==="hidden"&&K.properties.push({id:"custom.hidden",value:!0}),A.link&&K.properties.push({id:"links",value:[{title:(0,t.defaultTo)(A.linkTooltip,""),url:(0,t.defaultTo)(A.linkUrl,""),targetBlank:(0,t.defaultTo)(A.linkTargetBlank,!1)}]}),A.colorMode&&K.properties.push({id:"custom.cellOptions",value:{type:ht[A.colorMode]}}),A.align&&K.properties.push({id:"custom.align",value:A.align==="auto"?null:A.align}),A.thresholds?.length&&K.properties.push({id:"thresholds",value:{mode:V.O.Absolute,steps:d(A.thresholds,A.colors)}}),K},es=A=>{let J={custom:{}};if(A){if(J=(0,t.omitBy)({unit:A.unit,decimals:A.decimals,displayName:A.alias,custom:{align:A.align==="auto"?null:A.align}},t.isNil),A.thresholds.length){const K={mode:V.O.Absolute,steps:d(A.thresholds,A.colors)};J.thresholds=K}A.colorMode&&(J.custom.cellOptions={type:ht[A.colorMode]})}return J},Ft=(A,J,K)=>{if(J==="table-old"&&K.angular){const B=K.angular,Ne=D(A,B),Pe=B.styles.find(Se=>Se.pattern==="/.*/"),xt=es(Pe),ne=B.styles.filter(Se=>Se.pattern!=="/.*/").map(tt);A.transformations=Ne,A.fieldConfig={defaults:xt,overrides:ne}}return{}},ft=A=>A?.filter(J=>J.meta?.custom?.parentRowIndex===void 0)||[A?.[0]],mt=A=>{const J=[];return ft(A).filter(B=>!!B&&B.length!==0)?.forEach(B=>{const Ne=A?.filter(Se=>B.refId===Se.refId&&Se.meta?.custom?.parentRowIndex!==void 0),Pe=(0,t.groupBy)(Ne,Se=>Se.meta?.custom?.parentRowIndex),xt=Object.keys(Pe).map(Se=>Pe[Se]),ne={...B};Ne&&Ne.length>0&&ne.fields.push({name:"nested",type:P.PU.nestedFrames,config:{},values:xt}),J.push(ne)}),J},k=A=>A?.some(J=>J.meta?.custom?.parentRowIndex!==void 0)},10940:(_t,We,i)=>{i.d(We,{A:()=>c});var t=i(96540),u=function(V,P){var re=(0,t.useRef)(function(){});(0,t.useEffect)(function(){re.current=V}),(0,t.useEffect)(function(){if(P!==null){var Oe=setInterval(function(){return re.current()},P||0);return function(){return clearInterval(Oe)}}},[P])};const c=u}}]);

//# sourceMappingURL=3158.54aa968e02667a9c7cb6.js.map