"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[168],{45071:(J,M,o)=>{o.r(M),o.d(M,{default:()=>vt});var e=o(74848),u=o(96540),T=o(16817),C=o(41778),B=o(35137),$=o(81045),E=o(25274),P=o(73287),b=o(85629),F=o(6904),V=o(75686),z=o(40263),D=o(32300),R=o(30048),Q=o(27489),Z=o(21285),N=o(45861),ie=o(45967),ce=o(77824),X=o(11194),I=o(22803),W=o(63142),ae=o(22787),se=o(30703);function Se({isOpen:t,onCancel:n,onDiscard:a,onCopy:s}){const i=(0,u.useRef)(null),l=(0,W.of)(Ce);return(0,u.useEffect)(()=>{t&&i.current?.focus()},[t]),(0,e.jsxs)(ae.a,{title:(0,e.jsxs)("div",{className:l.modalHeaderTitle,children:[(0,e.jsx)(se.I,{name:"exclamation-triangle",size:"lg"}),(0,e.jsx)("span",{className:l.titleText,children:"Warning"})]}),onDismiss:n,isOpen:t,children:[(0,e.jsx)("p",{children:"Builder mode does not display changes made in code. The query builder will display the last changes you made in builder mode."}),(0,e.jsx)("p",{children:"Do you want to copy your code to the clipboard?"}),(0,e.jsxs)(ae.a.ButtonRow,{children:[(0,e.jsx)(N.$n,{type:"button",variant:"secondary",onClick:n,fill:"outline",children:"Cancel"}),(0,e.jsx)(N.$n,{variant:"destructive",type:"button",onClick:a,ref:i,children:"Discard code and switch"}),(0,e.jsx)(N.$n,{variant:"primary",onClick:s,children:"Copy code and switch"})]})]})}const Ce=t=>({titleText:(0,I.css)({paddingLeft:t.spacing(2)}),modalHeaderTitle:(0,I.css)({fontSize:t.typography.size.lg,float:"left",paddingTop:t.spacing(1),margin:t.spacing(0,2)})});var A=o(18857),re=o(97890);const be=({dataset:t,db:n,dialect:a,onChange:s,inputId:i,preconfiguredDataset:l})=>{const d=!!l||a==="postgres",r=(0,T.A)(async()=>(0,re.C)()&&d?(s((0,X.zL)(l)),[(0,X.zL)(l)]):(t&&s((0,X.zL)(t)),(await n.datasets()).map(X.zL)),[]);return(0,u.useEffect)(()=>{(0,re.C)()||(t?r.value&&r.value.find(p=>p.value===t)===void 0&&r.value.length>0&&s(r.value[0]):r.value&&r.value[0]&&s(r.value[0]))},[r.value,s,t]),(0,e.jsx)(A.l6,{"aria-label":"Dataset selector",inputId:i,value:t,options:r.value,onChange:s,disabled:r.loading,isLoading:r.loading,menuShouldPortal:!0})};var U=o(47184);const we=({db:t,dataset:n,table:a,className:s,onChange:i,inputId:l})=>{const d=(0,T.A)(async()=>n?(await t.tables(n)).map(U.z):[],[n]);return(0,e.jsx)(A.l6,{className:s,disabled:d.loading,"aria-label":"Table selector",inputId:l,"data-testid":b.Tp.components.SQLQueryEditor.headerTableSelector,value:a,options:d.value,onChange:i,isLoading:d.loading,menuShouldPortal:!0,placeholder:d.loading?"Loading tables":"Select table"})},Ee=[{label:"Builder",value:C.lX.Builder},{label:"Code",value:C.lX.Code}];function Te({db:t,dialect:n,isQueryRunnable:a,onChange:s,onQueryRowChange:i,onRunQuery:l,preconfiguredDataset:d,query:r,queryRowFilter:p}){const{editorMode:m}=r,[v,y]=(0,P.A)(),[f,c]=(0,u.useState)(!1),h=t.toRawSql,x=(0,u.useId)(),j=(0,u.useCallback)(g=>{if(g===C.lX.Code&&(0,Q.rR)("grafana_sql_editor_mode_changed",{datasource:r.datasource?.type,selectedEditorMode:C.lX.Code}),m===C.lX.Code){c(!0);return}s({...r,editorMode:g})},[m,s,r]),L=g=>{const G={...r,format:g.value!==void 0?g.value:X.gv.Table};(0,Q.rR)("grafana_sql_format_changed",{datasource:r.datasource?.type,selectedFormat:G.format}),s(G)},w=g=>{if(g.value===r.dataset)return;const G={...r,dataset:g.value,table:void 0,sql:void 0,rawSql:""};s(G)},O=g=>{if(g.value===r.table)return;const G={...r,table:g.value,sql:void 0,rawSql:""};s(G)},K=()=>!(n==="influx"||!(0,re.C)()&&n==="postgres");return(0,e.jsxs)(e.Fragment,{children:[(0,e.jsxs)(F.X,{children:[(0,e.jsx)(V.W,{label:"Format",value:r.format,placeholder:"Select format",menuShouldPortal:!0,onChange:L,options:X.cO}),m===C.lX.Builder&&(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)(Z.K,{id:`sql-filter-${x}`,label:"Filter","data-testid":b.Tp.components.SQLQueryEditor.headerFilterSwitch,transparent:!0,showLabel:!0,value:p.filter,onChange:g=>{g.target instanceof HTMLInputElement&&((0,Q.rR)("grafana_sql_filter_toggled",{datasource:r.datasource?.type,displayed:g.target.checked}),i({...p,filter:g.target.checked}))}}),(0,e.jsx)(Z.K,{id:`sql-group-${x}`,label:"Group","data-testid":b.Tp.components.SQLQueryEditor.headerGroupSwitch,transparent:!0,showLabel:!0,value:p.group,onChange:g=>{g.target instanceof HTMLInputElement&&((0,Q.rR)("grafana_sql_group_toggled",{datasource:r.datasource?.type,displayed:g.target.checked}),i({...p,group:g.target.checked}))}}),(0,e.jsx)(Z.K,{id:`sql-order-${x}`,label:"Order","data-testid":b.Tp.components.SQLQueryEditor.headerOrderSwitch,transparent:!0,showLabel:!0,value:p.order,onChange:g=>{g.target instanceof HTMLInputElement&&((0,Q.rR)("grafana_sql_order_toggled",{datasource:r.datasource?.type,displayed:g.target.checked}),i({...p,order:g.target.checked}))}}),(0,e.jsx)(Z.K,{id:`sql-preview-${x}`,label:"Preview","data-testid":b.Tp.components.SQLQueryEditor.headerPreviewSwitch,transparent:!0,showLabel:!0,value:p.preview,onChange:g=>{g.target instanceof HTMLInputElement&&((0,Q.rR)("grafana_sql_preview_toggled",{datasource:r.datasource?.type,displayed:g.target.checked}),i({...p,preview:g.target.checked}))}})]}),(0,e.jsx)(z.Z,{grow:1}),a?(0,e.jsx)(N.$n,{icon:"play",variant:"primary",size:"sm",onClick:()=>l(),children:"Run query"}):(0,e.jsx)(ie.m,{theme:"error",content:(0,e.jsxs)(e.Fragment,{children:["Your query is invalid. Check below for details. ",(0,e.jsx)("br",{}),"However, you can still run this query."]}),placement:"top",children:(0,e.jsx)(N.$n,{icon:"exclamation-triangle",variant:"secondary",size:"sm",onClick:()=>l(),children:"Run query"})}),(0,e.jsx)(ce.z,{options:Ee,size:"sm",value:m,onChange:j}),(0,e.jsx)(Se,{isOpen:f,onCopy:()=>{(0,Q.rR)("grafana_sql_editor_mode_changed",{datasource:r.datasource?.type,selectedEditorMode:C.lX.Builder,type:"copy"}),c(!1),y(r.rawSql),s({...r,rawSql:h(r),editorMode:C.lX.Builder})},onDiscard:()=>{(0,Q.rR)("grafana_sql_editor_mode_changed",{datasource:r.datasource?.type,selectedEditorMode:C.lX.Builder,type:"discard"}),c(!1),s({...r,rawSql:h(r),editorMode:C.lX.Builder})},onCancel:()=>{(0,Q.rR)("grafana_sql_editor_mode_changed",{datasource:r.datasource?.type,selectedEditorMode:C.lX.Builder,type:"cancel"}),c(!1)}})]}),m===C.lX.Builder&&(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)(B.$,{v:.5}),(0,e.jsxs)(D.U,{children:[K()&&(0,e.jsx)(R.c,{label:"Dataset",width:25,children:(0,e.jsx)(be,{db:t,inputId:`sql-dataset-${x}`,dataset:r.dataset,dialect:n,preconfiguredDataset:d,onChange:w})}),(0,e.jsx)(R.c,{label:"Table",width:25,children:(0,e.jsx)(we,{db:t,inputId:`sql-tableselect-${x}`,dataset:r.dataset||d,table:r.table,onChange:O})})]})]})]})}var de=o(49185),Fe=o(70713),Ie=o(97504);function $e({children:t,onChange:n,query:a,width:s,height:i,editorLanguageDefinition:l}){const d=(0,u.useRef)(a);(0,u.useEffect)(()=>{d.current=a},[a]);const r=(0,u.useCallback)((p,m)=>{const v={...d.current,rawQuery:!0,rawSql:p};n(v,m)},[n]);return(0,e.jsx)(Ie.Y,{width:s,height:i,query:a.rawSql,onChange:r,language:l,children:t})}var Oe=o(32881),ue=o(76319),Be=o(41053),Me=o(75198),me=o(55386),Re=o(68079);function Le({db:t,query:n,onValidate:a,range:s}){const[i,l]=(0,u.useState)(),d=(0,W.$j)(),r=(0,u.useMemo)(()=>(0,me.j_)("bytes"),[]),p=(0,u.useMemo)(()=>({error:(0,I.css)({color:d.colors.error.text,fontSize:d.typography.bodySmall.fontSize,fontFamily:d.typography.fontFamilyMonospace}),valid:(0,I.css)({color:d.colors.success.text}),info:(0,I.css)({color:d.colors.text.secondary})}),[d]),[m,v]=(0,Be.A)(async f=>f.rawSql?.trim()===""?null:await t.validateQuery(f,s),[t]),[,]=(0,Me.A)(async()=>{const f=await v(n);return f&&l(f),null},1e3,[n,v]);if((0,u.useEffect)(()=>{i?.isError&&a(!1),i?.isValid&&a(!0)},[i,a]),!m.value&&!m.loading)return null;const y=m.value?.error?Qe(m.value.error):"";return(0,e.jsxs)(e.Fragment,{children:[m.loading&&(0,e.jsxs)("div",{className:p.info,children:[(0,e.jsx)(Re.y,{inline:!0,size:"xs"})," Validating query..."]}),!m.loading&&m.value&&(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)(e.Fragment,{children:m.value.isValid&&m.value.statistics&&(0,e.jsxs)("div",{className:p.valid,children:[(0,e.jsx)(se.I,{name:"check"})," This query will process"," ",(0,e.jsx)("strong",{children:(0,me.cN)(r(m.value.statistics.TotalBytesProcessed))})," ","when run."]})}),(0,e.jsx)(e.Fragment,{children:m.value.isError&&(0,e.jsx)("div",{className:p.error,children:y})})]})]})}function Qe(t){const n=t.split(":");return n.length>2?n.slice(2).join(":"):t}function pe({showTools:t,onFormatCode:n,onExpand:a,isExpanded:s,...i}){const l=(0,W.$j)(),[d,r]=(0,u.useState)(),p=(0,u.useMemo)(()=>({container:(0,I.css)({border:`1px solid ${l.colors.border.medium}`,borderTop:"none",padding:l.spacing(.5,.5,.5,.5),display:"flex",flexGrow:1,justifyContent:"space-between",fontSize:l.typography.bodySmall.fontSize}),error:(0,I.css)({color:l.colors.error.text,fontSize:l.typography.bodySmall.fontSize,fontFamily:l.typography.fontFamilyMonospace}),valid:(0,I.css)({color:l.colors.success.text}),info:(0,I.css)({color:l.colors.text.secondary}),hint:(0,I.css)({color:l.colors.text.disabled,whiteSpace:"nowrap",cursor:"help"})}),[l]);let m={};return!t&&d===void 0&&(m={height:0,padding:0,visibility:"hidden"}),(0,e.jsxs)("div",{className:p.container,style:m,children:[(0,e.jsx)("div",{children:i.onValidate&&(0,e.jsx)(Le,{...i,onValidate:v=>{r(v),i.onValidate(v)}})}),t&&(0,e.jsx)("div",{children:(0,e.jsxs)(Oe.Gy,{spacing:"sm",children:[n&&(0,e.jsx)(ue.K,{onClick:()=>{(0,Q.rR)("grafana_sql_query_formatted",{datasource:i.query.datasource?.type}),n()},name:"brackets-curly",size:"xs",tooltip:"Format query"}),a&&(0,e.jsx)(ue.K,{onClick:()=>{(0,Q.rR)("grafana_sql_editor_expand",{datasource:i.query.datasource?.type,expanded:!s}),a(!s)},name:s?"angle-up":"angle-down",size:"xs",tooltip:s?"Collapse editor":"Expand editor"}),(0,e.jsx)(ie.m,{content:"Hit CTRL/CMD+Return to run query",children:(0,e.jsx)(se.I,{className:p.hint,name:"keyboard"})})]})})]})}function Ae({db:t,query:n,onChange:a,onRunQuery:s,onValidate:i,queryToValidate:l,range:d}){const r=(0,W.$j)(),p=(0,W.of)(De),[m,v]=(0,u.useState)(!1),[y,f]=(0,de.A)(),[c,h]=(0,de.A)(),x=(0,u.useMemo)(()=>t.getEditorLanguageDefinition(),[t]),j=(O,K)=>(0,e.jsx)($e,{editorLanguageDefinition:x,query:n,width:O,height:K?K-f.height:void 0,onChange:a,children:({formatQuery:g})=>(0,e.jsx)("div",{ref:y,children:(0,e.jsx)(pe,{db:t,query:l,onValidate:i,onFormatCode:g,showTools:!0,range:d,onExpand:v,isExpanded:m})})}),L=(O=!1)=>O?(0,e.jsx)(Fe.default,{children:({width:K,height:g})=>j(K,g)}):(0,e.jsx)("div",{ref:c,children:j()}),w=()=>(0,e.jsx)("div",{style:{width:h.width,height:h.height,background:r.colors.background.primary,display:"flex",alignItems:"center",justifyContent:"center"},children:"Editing in expanded code editor"});return(0,e.jsxs)(e.Fragment,{children:[m?w():L(),m&&(0,e.jsx)(ae.a,{title:`Query ${n.refId}`,closeOnBackdropClick:!1,closeOnEscape:!1,className:p.modal,contentClassName:p.modalContent,isOpen:m,onDismiss:()=>{(0,Q.rR)("grafana_sql_editor_expand",{datasource:n.datasource?.type,expanded:!1}),v(!1)},children:L(!0)})]})}function De(t){return{modal:(0,I.css)({width:"95vw",height:"95vh"}),modalContent:(0,I.css)({height:"100%",paddingTop:0})}}var Pe=o(1667),ze=o(27074);function q({query:t,onQueryChange:n,db:a}){return{onSqlChange:(0,u.useCallback)(i=>{const l=a.toRawSql,d=l({sql:i,dataset:t.dataset,table:t.table,refId:t.refId}),r={...t,sql:i,rawSql:d};n(r)},[a,n,t])}}var Ne=o(26774),fe=o(72500),Ve=o(20301);function We({sql:t,columns:n,onSqlChange:a}){const s=(0,u.useCallback)(i=>{const l=i.map(r=>(0,E.xG)(r.property?.name)),d={...t,groupBy:l};a(d)},[a,t]);return(0,e.jsx)(Ne.o,{items:t.groupBy,onChange:s,renderItem:Ke({options:n})})}function Ke({options:t}){return function(a,s,i){return(0,e.jsxs)(fe.M,{children:[(0,e.jsx)(A.l6,{value:a.property?.name?(0,U.z)(a.property.name):null,"aria-label":"Group by",options:t,menuShouldPortal:!0,onChange:({value:l})=>l&&s((0,E.xG)(l))}),(0,e.jsx)(Ve.Z,{title:"Remove group by column",icon:"times",variant:"secondary",onClick:i})]})}}function Ge({fields:t,query:n,onQueryChange:a,db:s}){const{onSqlChange:i}=q({query:n,onQueryChange:a,db:s});return(0,e.jsx)(We,{columns:t,sql:n.sql,onSqlChange:i})}var Y=o(2543),k=o(63527);const Xe=[{description:"Sort by ascending",value:"ASC",icon:"sort-amount-up"},{description:"Sort by descending",value:"DESC",icon:"sort-amount-down"}];function Ue({sql:t,onSqlChange:n,columns:a,showOffset:s}){const i=(0,u.useCallback)(p=>{const m={...t,orderByDirection:p};n(m)},[n,t]),l=(0,u.useCallback)(p=>{const m={...t,limit:Number.parseInt(p.currentTarget.value,10)};n(m)},[n,t]),d=(0,u.useCallback)(p=>{const m={...t,offset:Number.parseInt(p.currentTarget.value,10)};n(m)},[n,t]),r=(0,u.useCallback)(p=>{const m={...t,orderBy:(0,E.Kj)(p?.value)};p===null&&(m.orderByDirection=void 0),n(m)},[n,t]);return(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)(R.c,{label:"Order by",width:25,children:(0,e.jsxs)(fe.M,{children:[(0,e.jsx)(A.l6,{"aria-label":"Order by",options:a,value:t.orderBy?.property.name?(0,U.z)(t.orderBy.property.name):null,isClearable:!0,menuShouldPortal:!0,onChange:r}),(0,e.jsx)(B.$,{h:1.5}),(0,e.jsx)(ce.z,{options:Xe,disabled:!t?.orderBy?.property.name,value:t.orderByDirection,onChange:i})]})}),(0,e.jsx)(R.c,{label:"Limit",optional:!0,width:25,children:(0,e.jsx)(k.p,{type:"number",min:0,id:(0,Y.uniqueId)("limit-"),value:t.limit||"",onChange:l})}),s&&(0,e.jsx)(R.c,{label:"Offset",optional:!0,width:25,children:(0,e.jsx)(k.p,{type:"number",id:(0,Y.uniqueId)("offset-"),value:t.offset||"",onChange:d})})]})}function ke({fields:t,query:n,onQueryChange:a,db:s}){const{onSqlChange:i}=q({query:n,onQueryChange:a,db:s});let l=[];return t&&(l=[{value:"",label:"Selected columns",options:n.sql?.columns?.map((r,p)=>{const m=r.name?`${r.name}(${r.parameters?.map(v=>v.name)})`:r.parameters?.map(v=>v.name);return{value:m,label:`${p+1} - ${m}`}}),expanded:!0},...t]),(0,e.jsx)(Ue,{sql:n.sql,onSqlChange:i,columns:l})}var He=o(24705),Je=o(2863),S=o(63930),ge=o(25229),Ye=o(27282);const oe={add:"Add",remove:"Remove"},he={id:S.Aq.uuid(),type:"group"},ve="timeFilter",xe=[ve],Ze={...S.d$.widgets,text:{...S.d$.widgets.text,factory:function(n){return(0,e.jsx)(k.p,{value:n?.value||"",placeholder:n?.placeholder,onChange:a=>n?.setValue(a.currentTarget.value)})}},number:{...S.d$.widgets.number,factory:function(n){return(0,e.jsx)(k.p,{value:n?.value,placeholder:n?.placeholder,type:"number",onChange:a=>n?.setValue(Number.parseInt(a.currentTarget.value,10))})}},datetime:{...S.d$.widgets.datetime,factory:function(n){if(n?.operator==="macros")return(0,e.jsx)(A.l6,{id:n.id,"aria-label":"Macros value selector",menuShouldPortal:!0,options:xe.map(U.z),value:n?.value,onChange:s=>n.setValue(s.value)});const a=(0,ge.KQ)(n?.value).isValid()?(0,ge.KQ)(n?.value).utc():void 0;return(0,e.jsx)(Ye.K,{onChange:s=>{n?.setValue(s?.format(S.d$.widgets.datetime.valueFormat))},date:a})},sqlFormatValue:(t,n,a,s,i,l)=>s==="macros"?xe.includes(t)?t:void 0:typeof S.d$.widgets.datetime.sqlFormatValue=="string"||typeof S.d$.widgets.datetime.sqlFormatValue=="object"?void 0:S.d$.widgets.datetime.sqlFormatValue?.call(S.d$.ctx,t,n,a,s,i,l)||""}},qe={...S.d$.settings,canRegroup:!1,maxNesting:1,canReorder:!1,showNot:!1,addRuleLabel:oe.add,deleteLabel:oe.remove,renderConjs:function(n){return(0,e.jsx)(A.l6,{id:n?.id,"aria-label":"Conjunction","data-testid":b.Tp.components.SQLQueryEditor.filterConjunction,menuShouldPortal:!0,options:n?.conjunctionOptions?Object.keys(n?.conjunctionOptions).map(U.z):void 0,value:n?.selectedConjunction,onChange:a=>n?.setConjunction(a.value)})},renderField:function(n){const a=n?.config?.fields||{};return(0,e.jsx)(A.l6,{id:n?.id,width:25,"aria-label":"Field","data-testid":b.Tp.components.SQLQueryEditor.filterField,menuShouldPortal:!0,options:n?.items.map(s=>{const i=a[s.key].mainWidgetProps?.customProps?.icon;return{label:s.label,value:s.key,icon:i}}),value:n?.selectedKey,onChange:s=>{n?.setField(s.label)}})},renderButton:function(n){return(0,e.jsx)(N.$n,{type:"button",title:`${n?.label} filter`,onClick:n?.onClick,variant:"secondary",size:"md",icon:n?.label===oe.add?"plus":"times"})},renderOperator:function(n){return(0,e.jsx)(A.l6,{options:n?.items.map(a=>({label:a.label,value:a.key})),"aria-label":"Operator","data-testid":b.Tp.components.SQLQueryEditor.filterOperator,menuShouldPortal:!0,value:n?.selectedKey,onChange:a=>{n?.setField(a.value||"")}})}};var _e=(t=>(t.IN="select_any_in",t.NOT_IN="select_not_any_in",t.MACROS="macros",t))(_e||{});const et=rt(S.d$),ye=S.d$.types.text.widgets.text,tt=[...ye.operators||[],"select_any_in","select_not_any_in"],nt={...ye,operators:tt},at={...S.d$.types,text:{...S.d$.types.text,widgets:{...S.d$.types.text.widgets,text:nt}},datetime:{...S.d$.types.datetime,widgets:{...S.d$.types.datetime.widgets,datetime:{...S.d$.types.datetime.widgets.datetime,operators:["macros",...S.d$.types.datetime.widgets.datetime.operators||[]]}}}},st={...S.d$,widgets:Ze,settings:qe,operators:et,types:at},_=()=>"";function rt(t){const{...n}=t.operators,a=n.select_any_in.sqlFormatOp?.bind(t.ctx)||_,s=n.select_any_in.formatOp?.bind(t.ctx)||_,i=(m,v,y,f,c,h,x,j)=>a(m,v,ee(y),f,c,h,x,j),l=n.select_not_any_in.sqlFormatOp?.bind(t.ctx)||_,d=n.select_not_any_in.formatOp?.bind(t.ctx)||_,r=(m,v,y,f,c,h,x,j)=>l(m,v,ee(y),f,c,h,x,j);return{...n,select_any_in:{...n.select_any_in,formatOp:(m,v,y,f)=>s(m,v,ee(y),f),sqlFormatOp:i},select_not_any_in:{...n.select_not_any_in,formatOp:(m,v,y,f)=>d(m,v,ee(y),f),sqlFormatOp:r},macros:{label:"Macros",sqlFormatOp:(m,v,y)=>{if(y===ve)return`$__timeFilter(${m})`;throw new Error("Invalid macro")}}}}function ee(t){return(0,Y.isString)(t)?t.split(","):t}function ot({sql:t,config:n,onSqlChange:a}){const[s,i]=(0,u.useState)(),l=(0,u.useMemo)(()=>({...st,...n}),[n]);(0,u.useEffect)(()=>{if(!s){const r=S.Aq.checkTree(S.Aq.loadTree(t.whereJsonTree??he),l);i(r)}},[l,t.whereJsonTree,s]),(0,u.useEffect)(()=>{t.whereJsonTree||i(S.Aq.checkTree(S.Aq.loadTree(he),l))},[l,t.whereJsonTree]);const d=(0,u.useCallback)((r,p)=>{i(r);const m={...t,whereJsonTree:S.Aq.getTree(r),whereString:S.Aq.sqlFormat(r,p)};a(m)},[a,t]);return s?(0,e.jsx)(S.XK,{...l,value:s,onChange:d,renderBuilder:r=>(0,e.jsx)(S.M$,{...r})}):null}function te(t){return`
    display: flex;
    gap: 8px;
    flex-direction: ${t};`}(0,I.injectGlobal)`
  .group--header {
    ${te("row")}
  }

  .group-or-rule {
    ${te("column")}
    .rule {
      flex-direction: row;
    }
  }

  .rule--body {
    ${te("row")}
  }

  .group--children {
    ${te("column")}
  }

  .group--conjunctions:empty {
    display: none;
  }
`;function lt({query:t,fields:n,onQueryChange:a,db:s}){const i=(0,He.A)(async()=>it(n),[n]),{onSqlChange:l}=q({query:t,onQueryChange:a,db:s});return(0,e.jsx)(ot,{config:{fields:i.value||{}},sql:t.sql,onSqlChange:d=>{const r=(0,Je.w)().getVariables();ct(d,r),l(d)}},JSON.stringify(i.value))}function it(t){const n={};for(const a of t)n[a.value]={type:a.raqbFieldType||"text",valueSources:["value"],mainWidgetProps:{customProps:{icon:a.icon}}};return n}function ct(t,n){const a=s=>"multi"in s&&s.multi&&(t.whereString?.includes(`\${${s.name}}`)||t.whereString?.includes(`$${s.name}`));n.some(s=>a(s))&&(t.whereString=t.whereString?.replaceAll("')",")"),t.whereString=t.whereString?.replaceAll("('","("))}var ne=o(41654),le=o(36656),H=o(79233);function je({columns:t,onParameterChange:n,value:a}){const s=(0,u.useId)();return(0,e.jsx)(R.c,{label:"Column",width:25,children:(0,e.jsx)(A.l6,{value:a,"data-testid":b.Tp.components.SQLQueryEditor.selectColumn,inputId:s,menuShouldPortal:!0,options:[{label:"*",value:"*"},...t],allowCustomValue:!0,onChange:i=>n(i.value)})})}function dt({columns:t,query:n,onSqlChange:a,onParameterChange:s,currentColumnIndex:i}){const l=(0,W.of)(ut),d=n.sql?.columns?.[i],r=(0,u.useCallback)(v=>{const y=n.sql?.columns?.[v];if(!y)return;y.parameters=y.parameters?[...y.parameters,{type:le._.FunctionParameter,name:""}]:[];const f={...n.sql,columns:n.sql?.columns?.map((c,h)=>h===v?y:c)};a(f)},[a,n.sql]),p=(0,u.useCallback)((v,y)=>{const f=n.sql?.columns?.[v];if(!f?.parameters)return;f.parameters=f.parameters?.filter((h,x)=>x!==y);const c={...n.sql,columns:n.sql?.columns?.map((h,x)=>x===v?f:h)};a(c)},[a,n.sql]);function m(v){return!d?.parameters||d.parameters.length<=1?null:d.parameters.map((f,c)=>c===0?null:(0,e.jsxs)(ne.B,{gap:2,children:[(0,e.jsx)(H.c,{className:l.label,children:","}),(0,e.jsx)(k.p,{onChange:h=>s(c)(h.currentTarget.value),value:f.name,"aria-label":`Parameter ${c} for column ${v}`,"data-testid":b.Tp.components.SQLQueryEditor.selectInputParameter,addonAfter:(0,e.jsx)(N.$n,{title:"Remove parameter",type:"button",icon:"times",variant:"secondary",size:"md",onClick:()=>p(v,c)})})]},c))}return(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)(H.c,{className:l.label,children:"("}),(0,e.jsx)(je,{columns:t,onParameterChange:v=>s(0)(v),value:(0,E.oG)(d?.parameters?.[0])}),m(i),(0,e.jsx)(N.$n,{type:"button",onClick:()=>r(i),variant:"secondary",size:"md",icon:"plus",title:"Add parameter"}),(0,e.jsx)(H.c,{className:l.label,children:")"})]})}const ut=()=>({label:(0,I.css)({padding:0,margin:0,width:"unset"})});function mt({query:t,onSqlChange:n,currentColumnIndex:a,db:s,columns:i}){const l=(0,u.useId)(),d=t.sql?.columns?.[a],r=(0,W.of)(pt),p=s.functions().find(c=>c.name===d?.name),[m,v]=(0,u.useState)([]);(0,u.useEffect)(()=>{(async()=>{if(!p)return;const h=[];for(const x of p.parameters??[])x.options?h.push(await x.options(t)):h.push([]);v(h)})()},[d?.name]);const y=(0,u.useCallback)((c,h)=>x=>{const j=t.sql?.columns?.[a];if(!j)return;j.parameters||(j.parameters=[]),j.parameters[c]===void 0?j.parameters[c]={type:le._.FunctionParameter,name:x}:x==null&&h?(j.parameters=j.parameters.map((w,O)=>O===c?{...w,name:""}:w),j.parameters[j.parameters.length-1]?.name===""&&(j.parameters=j.parameters.filter(w=>w.name!==""))):x==null?j.parameters=j.parameters.filter((w,O)=>O!==c):j.parameters=j.parameters.map((w,O)=>O===c?{...w,name:x}:w);const L={...t.sql,columns:t.sql?.columns?.map((w,O)=>O===a?j:w)};n(L)},[a,n,t.sql]);function f(){return p?.parameters?p?.parameters.map((c,h)=>(0,e.jsxs)(ne.B,{alignItems:"flex-end",gap:2,children:[(0,e.jsx)(R.c,{label:c.name,width:25,optional:!c.required,children:(0,e.jsx)(e.Fragment,{children:c.options?(0,e.jsx)(A.l6,{value:(0,E.oG)(d?.parameters[h]),options:m?.[h],"data-testid":b.Tp.components.SQLQueryEditor.selectFunctionParameter(c.name),inputId:l,menuShouldPortal:!0,allowCustomValue:!0,isClearable:!0,onChange:x=>y(h,!0)(x?.value)}):(0,e.jsx)(k.p,{onChange:x=>y(h,!0)(x.currentTarget.value),value:d?.parameters[h]?.name,"data-testid":b.Tp.components.SQLQueryEditor.selectInputParameter})})}),p.parameters.length!==h+1&&(0,e.jsx)(H.c,{className:r.label,children:","})]},h)):null}return d?.name===void 0?(0,e.jsx)(je,{columns:i,onParameterChange:c=>y(0)(c),value:(0,E.oG)(d?.parameters?.[0])}):p?(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)(H.c,{className:r.label,children:"("}),f(),(0,e.jsx)(H.c,{className:r.label,children:")"})]}):(0,e.jsx)(dt,{query:t,onSqlChange:n,currentColumnIndex:a,columns:i,onParameterChange:y})}const pt=()=>({label:(0,I.css)({padding:0,margin:0,width:"unset"})});function ft({query:t,onQueryChange:n,db:a,columns:s}){const i=(0,W.of)(gt),{onSqlChange:l}=q({query:t,onQueryChange:n,db:a}),d=[];t.format===X.gv.Timeseries&&(d.push({label:"time",value:"time"}),d.push({label:"value",value:"value"}));const r=(0,u.useCallback)((f,c)=>h=>{const x={...f,name:h?.value,parameters:[{type:le._.FunctionParameter,name:f.parameters?.[0]?.name||""}]},j={...t.sql,columns:t.sql?.columns?.map((L,w)=>w===c?x:L)};l(j)},[l,t.sql]),p=(0,u.useCallback)((f,c)=>h=>{let x={...f};h!==null?x={...f,alias:`"${h?.value?.trim()}"`}:delete x.alias;const j={...t.sql,columns:t.sql?.columns?.map((L,w)=>w===c?x:L)};l(j)},[l,t.sql]),m=(0,u.useCallback)(f=>()=>{const c=[...t.sql?.columns||[]];c.splice(f,1);const h={...t.sql,columns:c};l(h)},[l,t.sql]),v=(0,u.useCallback)(()=>{const f={...t.sql,columns:[...t.sql?.columns||[],(0,E.JD)()]};l(f)},[l,t.sql]),y=()=>{const f=[{label:"Aggregations",options:[]},{label:"Macros",options:[]}];for(const c of a.functions())c.name.startsWith("$__")?f[1].options.push({label:c.name,value:c.name}):f[0].options.push({label:c.name,value:c.name});return f};return(0,e.jsxs)(ne.B,{gap:2,wrap:"wrap",direction:"column",children:[t.sql?.columns?.map((f,c)=>(0,e.jsx)("div",{children:(0,e.jsxs)(ne.B,{gap:2,alignItems:"end",children:[(0,e.jsx)(R.c,{label:"Data operations",optional:!0,width:25,children:(0,e.jsx)(A.l6,{value:f.name?(0,U.z)(f.name):null,inputId:`select-aggregation-${c}-${(0,Y.uniqueId)()}`,"data-testid":b.Tp.components.SQLQueryEditor.selectAggregation,isClearable:!0,menuShouldPortal:!0,allowCustomValue:!0,options:y(),onChange:r(f,c)})}),(0,e.jsx)(mt,{currentColumnIndex:c,columns:s,onSqlChange:l,query:t,db:a}),(0,e.jsx)(R.c,{label:"Alias",optional:!0,width:15,children:(0,e.jsx)(A.l6,{value:f.alias?(0,U.z)(f.alias):null,inputId:`select-alias-${c}-${(0,Y.uniqueId)()}`,"data-testid":b.Tp.components.SQLQueryEditor.selectAlias,options:d,onChange:p(f,c),isClearable:!0,menuShouldPortal:!0,allowCustomValue:!0})}),(0,e.jsx)(N.$n,{title:"Remove column",type:"button",icon:"trash-alt",variant:"secondary",size:"md",onClick:m(c)})]})},c)),(0,e.jsx)(N.$n,{type:"button",onClick:v,variant:"secondary",title:"Add column",size:"md",icon:"plus",className:i.addButton})]})}const gt=()=>({addButton:(0,I.css)({alignSelf:"flex-start"}),label:(0,I.css)({padding:0,margin:0,width:"unset"})}),ht=({query:t,db:n,queryRowFilter:a,onChange:s,onValidate:i,range:l})=>{const d=(0,T.A)(async()=>await n.fields(t),[n,t.dataset,t.table]);return(0,e.jsxs)(e.Fragment,{children:[(0,e.jsxs)(Pe.D,{children:[(0,e.jsx)(D.U,{children:(0,e.jsx)(ft,{columns:d.value||[],query:t,onQueryChange:s,db:n})}),a.filter&&(0,e.jsx)(D.U,{children:(0,e.jsx)(R.c,{label:"Filter by column value",optional:!0,children:(0,e.jsx)(lt,{fields:d.value||[],query:t,onQueryChange:s,db:n})})}),a.group&&(0,e.jsx)(D.U,{children:(0,e.jsx)(R.c,{label:"Group by column",children:(0,e.jsx)(Ge,{fields:d.value||[],query:t,onQueryChange:s,db:n})})}),a.order&&(0,e.jsx)(D.U,{children:(0,e.jsx)(ke,{fields:d.value||[],query:t,onQueryChange:s,db:n})}),a.preview&&t.rawSql&&(0,e.jsx)(D.U,{children:(0,e.jsx)(ze.l,{rawSql:t.rawSql,datasourceType:t.datasource?.type})})]}),(0,e.jsx)(pe,{db:n,query:t,onValidate:i,range:l})]})};function vt({datasource:t,query:n,onChange:a,onRunQuery:s,range:i,queryHeaderProps:l}){const[d,r]=(0,u.useState)(!0),p=t.getDB(),{preconfiguredDatabase:m}=t,v=l?.dialect??"other",{loading:y,error:f}=(0,T.A)(async()=>()=>{t.getDB(t.id).init!==void 0&&t.getDB(t.id).init()},[t]),c=(0,$.T)(n),[h,x]=(0,u.useState)({filter:!!c.sql?.whereString,group:!!c.sql?.groupBy?.[0]?.property.name,order:!!c.sql?.orderBy?.property.name,preview:!0}),[j,L]=(0,u.useState)(c);(0,u.useEffect)(()=>()=>{t.getDB(t.id).dispose!==void 0&&t.getDB(t.id).dispose()},[t]);const w=(0,u.useCallback)(g=>{xt(g)&&s&&s()},[s]),O=(g,G=!0)=>{L(g),a(g),(0,E.YW)(g.sql?.columns)&&g.sql?.columns.some(yt=>yt.name)&&!h.group&&x({...h,group:!0}),G&&w(g)},K=g=>{L(g),a(g)};return y||f?null:(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)(Te,{db:p,preconfiguredDataset:m,onChange:K,onRunQuery:s,onQueryRowChange:x,queryRowFilter:h,query:c,isQueryRunnable:d,dialect:v}),(0,e.jsx)(B.$,{v:.5}),c.editorMode!==C.lX.Code&&(0,e.jsx)(ht,{db:p,query:c,onChange:g=>O(g,!1),queryRowFilter:h,onValidate:r,range:i}),c.editorMode===C.lX.Code&&(0,e.jsx)(Ae,{db:p,query:c,queryToValidate:j,onChange:O,onRunQuery:s,onValidate:r,range:i})]})}const xt=t=>!!t.rawSql},75198:(J,M,o)=>{var e;e={value:!0};var u=o(31635),T=o(96540),C=u.__importDefault(o(93182));function B($,E,P){E===void 0&&(E=0),P===void 0&&(P=[]);var b=C.default($,E),F=b[0],V=b[1],z=b[2];return T.useEffect(z,P),[F,V]}M.A=B},93182:(J,M,o)=>{Object.defineProperty(M,"__esModule",{value:!0});var e=o(96540);function u(T,C){C===void 0&&(C=0);var B=e.useRef(!1),$=e.useRef(),E=e.useRef(T),P=e.useCallback(function(){return B.current},[]),b=e.useCallback(function(){B.current=!1,$.current&&clearTimeout($.current),$.current=setTimeout(function(){B.current=!0,E.current()},C)},[C]),F=e.useCallback(function(){B.current=null,$.current&&clearTimeout($.current)},[]);return e.useEffect(function(){E.current=T},[T]),e.useEffect(function(){return b(),F},[C]),[P,F,b]}M.default=u},6904:(J,M,o)=>{o.d(M,{X:()=>C});var e=o(22803),u=o(96540),T=o(63142);const C=({children:$})=>{const E=(0,T.of)(B);return u.createElement("div",{className:E.root},$)},B=$=>({root:(0,e.css)({display:"flex",flexWrap:"wrap",alignItems:"center",gap:$.spacing(3),minHeight:$.spacing(4)})})},40263:(J,M,o)=>{o.d(M,{Z:()=>u});var e=o(96540);const u=({grow:T,shrink:C})=>e.createElement("div",{style:{display:"block",flexGrow:T,flexShrink:C}})},75686:(J,M,o)=>{o.d(M,{W:()=>$});var e=o(22803),u=o(96540),T=o(63142),C=o(18857),B=o(73744);function $({label:F,...V}){const[z]=(0,u.useState)(()=>Math.random().toString(16).slice(2)),D=(0,T.of)(b),R={SelectContainer:E,ValueContainer:P,SingleValue:P};return u.createElement("div",{className:D.root},F&&u.createElement("label",{className:D.label,htmlFor:z},F,":","\xA0"),u.createElement(C.l6,{openMenuOnFocus:!0,inputId:z,...V,components:R}))}const E=F=>{const{children:V}=F,z=(0,T.of)(b);return u.createElement(B.K,{...F,className:(0,e.cx)(F.className,z.container)},V)},P=F=>{const{className:V,children:z}=F,D=(0,T.of)(b);return u.createElement("div",{className:(0,e.cx)(V,D.valueContainer)},z)},b=F=>({root:(0,e.css)({display:"flex",fontSize:12,alignItems:"center"}),label:(0,e.css)({color:F.colors.text.secondary,whiteSpace:"nowrap"}),container:(0,e.css)({background:"none",borderColor:"transparent"}),valueContainer:(0,e.css)({display:"flex",alignItems:"center",flex:"initial",color:F.colors.text.secondary,fontSize:12})})}}]);

//# sourceMappingURL=sql-query-editor.e58e085116050d22952e.js.map