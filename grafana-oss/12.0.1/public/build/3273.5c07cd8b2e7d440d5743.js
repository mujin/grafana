"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[3273],{13273:(ie,F,i)=>{i.r(F),i.d(F,{plugin:()=>Ms});var A=i(94644),R=i(57852),U=i(75234),a=i(74848),p=i(22803),I=i(2543),n=i(96540),k=i(27489),w=i(63142),Q=i(22420);const re=['{job="default/prometheus"}'],pt=["job","app","k8s_app"],gt=5,mt=[{title:"Log pipeline",expression:'{job="mysql"} |= "metrics" | logfmt | duration > 10s',label:'This query targets the MySQL job, keeps logs that contain the substring "metrics", and then parses and filters the logs further.'},{title:"Count over time",expression:'count_over_time({job="mysql"}[5m])',label:"This query counts all the log lines within the last five minutes for the MySQL job."},{title:"Rate",expression:'rate(({job="mysql"} |= "error" != "timeout")[10s])',label:"This query gets the per-second rate of all non-timeout errors within the last ten seconds for the MySQL job."},{title:"Aggregate, count, and group",expression:'sum(count_over_time({job="mysql"}[5m])) by (level)',label:"Get the count of logs during the last five minutes, grouping by level."}];class ht extends n.PureComponent{constructor(){super(...arguments),this.state={userExamples:[]},this.checkUserLabels=async()=>{const t=this.props.datasource?.languageProvider;if(t.started){const s=t.getLabelKeys()||[],l=pt.find(r=>s.includes(r));if(l){const r=await t.fetchLabelValues(l),o=(0,I.shuffle)(r).slice(0,gt).map(c=>`{${l}="${(0,Q.Qn)(c)}"}`);this.setState({userExamples:o})}}else this.scheduleUserLabelChecking()}}componentDidMount(){this.scheduleUserLabelChecking(),(0,k.rR)("grafana_loki_cheatsheet_opened",{})}componentWillUnmount(){clearTimeout(this.userLabelTimer)}scheduleUserLabelChecking(){this.userLabelTimer=setTimeout(this.checkUserLabels,1e3)}renderExpression(t){const{onClickExample:s,theme:l}=this.props,r=Ae(l),o=c=>{s(c),(0,k.rR)("grafana_loki_cheatsheet_example_clicked",{})};return(0,a.jsx)("button",{type:"button",className:r.cheatSheetExample,onClick:()=>o({refId:"A",expr:t}),children:(0,a.jsx)("code",{children:t})},t)}render(){const{userExamples:t}=this.state,{theme:s}=this.props,l=t.length>0,r=Ae(s);return(0,a.jsxs)("div",{children:[(0,a.jsx)("h2",{children:"Loki Cheat Sheet"}),(0,a.jsxs)("div",{className:r.cheatSheetItem,children:[(0,a.jsx)("div",{className:r.cheatSheetItemTitle,children:"See your logs"}),"Start by selecting a log stream from the Label browser, or alternatively you can write a stream selector into the query field.",l?(0,a.jsxs)("div",{children:["Here are some example streams from your logs:",t.map(o=>this.renderExpression(o))]}):(0,a.jsxs)("div",{children:["Here is an example of a log stream:",this.renderExpression(re[0])]})]}),(0,a.jsxs)("div",{className:r.cheatSheetItem,children:[(0,a.jsx)("div",{className:r.cheatSheetItemTitle,children:"Combine stream selectors"}),this.renderExpression('{app="cassandra",namespace="prod"}'),"Returns all log lines from streams that have both labels."]}),(0,a.jsxs)("div",{className:r.cheatSheetItem,children:[(0,a.jsx)("div",{className:r.cheatSheetItemTitle,children:"Filtering for search terms."}),this.renderExpression('{app="cassandra"} |~ "(duration|latency)s*(=|is|of)s*[d.]+"'),this.renderExpression('{app="cassandra"} |= "exact match"'),this.renderExpression('{app="cassandra"} != "do not match"'),(0,a.jsx)("a",{href:"https://grafana.com/docs/loki/latest/logql/#log-pipeline",target:"logql",children:"LogQL"})," ","supports exact and regular expression filters."]}),mt.map(o=>(0,a.jsxs)("div",{className:r.cheatSheetItem,children:[(0,a.jsx)("div",{className:r.cheatSheetItemTitle,children:o.title}),this.renderExpression(o.expression),o.label]},o.expression))]})}}const ft=(0,w.cV)(ht),Ae=e=>({cheatSheetItem:(0,p.css)({margin:e.spacing(3,0)}),cheatSheetItemTitle:(0,p.css)({fontSize:e.typography.h3.fontSize}),cheatSheetExample:(0,p.css)({margin:e.spacing(.5,0),textAlign:"left",border:"none",background:"transparent",display:"block"})});var z=i(1906),J=i(84596),ve=i(28105),ce=i(85629),V=i(55060),vt=i(6904),de=i(21285),te=i(46936),Rs=i(70713),$s=i(27633);function yt({label:e,...t}){const s=e.replace(" ","-"),l=(0,n.useRef)((0,I.uniqueId)(`switch-${s}`)),r=(0,w.of)(xt);return n.createElement(te.C,{gap:1},n.createElement("label",{htmlFor:l.current,className:r.switchLabel},e),n.createElement(de.d,{...t,id:l.current}))}const xt=e=>({switchLabel:(0,p.css)({color:e.colors.text.secondary,cursor:"pointer",fontSize:e.typography.bodySmall.fontSize,"&:hover":{color:e.colors.text.primary}})});var ue=i(40263),ye=i(77824);const bt=[{label:"Builder",value:V.f.Builder},{label:"Code",value:V.f.Code}];function Et({mode:e,onChange:t}){return n.createElement("div",{"data-testid":"QueryEditorModeToggle"},n.createElement(ye.z,{options:bt,size:"sm",value:e,onChange:t}))}var Ue=i(1667),Z=i(43173),St=i(71599),le=i(41654),D=i(45861),Lt=i(35137),jt=i(66615),ze=i(22787),Ve=i(6975),Ct=i(91793),Ot=i(63267),pe=i(72636),xe=i(88977),ae=i(63527);const be=1e3,Ee=1e4,Nt=4,Se="{}";function G(e){const t=[];for(const s of e)if(s.selected&&s.values&&s.values.length>0){const l=s.values.filter(r=>r.selected).map(r=>r.name);l.length>1?t.push(`${s.name}=~"${l.map(Q.Cs).join("|")}"`):l.length===1&&t.push(`${s.name}="${(0,Q.Qn)(l[0])}"`)}return["{",t.join(","),"}"].join("")}function Tt(e,t,s){return e.map(l=>{const r=t[l.name];if(r){let o;if(l.name===s&&l.values)o=l.values;else{const c=new Set(l.values?.filter(d=>d.selected).map(d=>d.name)||[]);o=r.map(d=>({name:d,selected:c.has(d)}))}return{...l,loading:!1,values:o,facets:o.length}}return{...l,loading:!1,hidden:!r,values:void 0,facets:0}})}const Dt=e=>({wrapper:(0,p.css)({backgroundColor:e.colors.background.secondary,width:"100%"}),wrapperPadding:(0,p.css)({padding:e.spacing(2)}),list:(0,p.css)({marginTop:e.spacing(1),display:"flex",flexWrap:"wrap",maxHeight:"200px",overflow:"auto"}),section:(0,p.css)({"& + &":{margin:e.spacing(2,0)},position:"relative"}),footerSectionStyles:(0,p.css)({padding:e.spacing(1),backgroundColor:e.colors.background.primary,position:"sticky",bottom:e.spacing(-3),left:0}),selector:(0,p.css)({fontFamily:e.typography.fontFamilyMonospace,marginBottom:e.spacing(1),width:"100%"}),status:(0,p.css)({marginBottom:e.spacing(1),color:e.colors.text.secondary,whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis",[e.transitions.handleMotion("no-preference","reduce")]:{transition:"opacity 100ms linear"},opacity:0,fontSize:e.typography.bodySmall.fontSize,height:`calc(${e.typography.bodySmall.fontSize} + 10px)`}),statusShowing:(0,p.css)({opacity:1}),error:(0,p.css)({color:e.colors.error.main}),valueList:(0,p.css)({marginRight:e.spacing(1),resize:"horizontal"}),valueListWrapper:(0,p.css)({borderLeft:`1px solid ${e.colors.border.medium}`,margin:e.spacing(1,0),padding:e.spacing(1,0,1,1)}),valueListArea:(0,p.css)({display:"flex",flexWrap:"wrap",marginTop:e.spacing(1)}),valueTitle:(0,p.css)({marginLeft:e.spacing(-.5),marginBottom:e.spacing(1)}),validationStatus:(0,p.css)({padding:e.spacing(.5),marginBottom:e.spacing(1),color:e.colors.text.maxContrast,whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"})});class wt extends n.Component{constructor(){super(...arguments),this.state={labels:[],searchTerm:"",status:"Ready",error:"",validationStatus:""},this.onChangeSearch=t=>{this.setState({searchTerm:t.target.value})},this.onClickRunLogsQuery=()=>{(0,k.rR)("grafana_loki_label_browser_closed",{app:this.props.app,closeType:"showLogsButton"});const t=G(this.state.labels);this.props.onChange(t)},this.onClickRunMetricsQuery=()=>{(0,k.rR)("grafana_loki_label_browser_closed",{app:this.props.app,closeType:"showLogsRateButton"});const s=`rate(${G(this.state.labels)}[$__auto])`;this.props.onChange(s)},this.onClickClear=()=>{this.setState(t=>({labels:t.labels.map(l=>({...l,values:void 0,selected:!1,loading:!1,hidden:!1,facets:void 0})),searchTerm:"",status:"",error:"",validationStatus:""})),this.props.deleteLastUsedLabels()},this.onClickLabel=(t,s,l)=>{const r=this.state.labels.find(d=>d.name===t);if(!r)return;const o=!r.selected;let c={selected:o};if(r.values&&!o){const d=r.values.map(u=>({...u,selected:!1}));c={...c,facets:0,values:d}}this.setState({searchTerm:""}),this.updateLabelState(t,c,"",()=>this.doFacettingForLabel(t))},this.onClickValue=(t,s,l)=>{const r=this.state.labels.find(c=>c.name===t);if(!r||!r.values)return;this.setState({searchTerm:""});const o=r.values.map(c=>({...c,selected:c.name===s?!c.selected:c.selected}));this.updateLabelState(t,{values:o},"",()=>this.doFacetting(t))},this.onClickValidate=()=>{const t=G(this.state.labels);this.validateSelector(t)},this.doFacetting=t=>{const s=G(this.state.labels);if(s===Se){const l=this.state.labels.map(r=>({...r,facets:0,values:void 0,hidden:!1}));this.setState({labels:l},()=>{this.state.labels.forEach(r=>r.selected&&this.fetchValues(r.name,s))})}else this.fetchSeries(s,t)}}updateLabelState(t,s,l="",r){this.setState(o=>{const c=o.labels.map(u=>u.name===t?{...u,...s}:u),d=l?"":o.error;return{labels:c,status:l,error:d,validationStatus:""}},r)}componentDidMount(){const{languageProvider:t,autoSelect:s=Nt,lastUsedLabels:l,timeRange:r}=this.props;if(t){const o=l;t.start(r).then(()=>{let c=t.getLabelKeys();if(c.length>be){const u=`Too many labels found (showing only ${be} of ${c.length})`;c=c.slice(0,be),this.setState({error:u})}const d=c.map((u,g,f)=>({name:u,selected:f.length<=s&&o.length===0||o.includes(u),loading:!1}));this.setState({labels:d},()=>{this.state.labels.forEach(u=>{u.selected&&this.fetchValues(u.name,Se)})})})}}doFacettingForLabel(t){const s=this.state.labels.find(r=>r.name===t);if(!s)return;const l=this.state.labels.filter(r=>r.selected).map(r=>r.name);this.props.storeLastUsedLabels(l),s.selected?s.values||this.fetchValues(t,G(this.state.labels)):this.doFacetting()}async fetchValues(t,s){const{languageProvider:l,timeRange:r}=this.props;this.updateLabelState(t,{loading:!0},`Fetching values for ${t}`);try{let o=await l.fetchLabelValues(t,{timeRange:r});if(s!==G(this.state.labels)){this.updateLabelState(t,{loading:!1},"");return}if(o.length>Ee){const d=`Too many values for ${t} (showing only ${Ee} of ${o.length})`;o=o.slice(0,Ee),this.setState({error:d})}const c=o.map(d=>({name:d}));this.updateLabelState(t,{values:c,loading:!1})}catch(o){console.error(o)}}async fetchSeries(t,s){const{languageProvider:l,timeRange:r}=this.props;s&&this.updateLabelState(s,{loading:!0},`Loading labels for ${t}`);try{const o=await l.fetchSeriesLabels(t,{timeRange:r});if(t!==G(this.state.labels)){s&&this.updateLabelState(s,{loading:!1});return}if(Object.keys(o).length===0){this.setState({error:`Empty results, no matching label for ${t}`});return}const c=Tt(this.state.labels,o,s);this.setState({labels:c,error:""}),s&&this.updateLabelState(s,{loading:!1})}catch(o){console.error(o)}}async validateSelector(t){const{languageProvider:s,timeRange:l}=this.props;this.setState({validationStatus:`Validating selector ${t}`,error:""});const r=await s.fetchSeries(t,{timeRange:l});this.setState({validationStatus:`Selector is valid (${r.length} streams found)`})}render(){const{theme:t}=this.props,{labels:s,searchTerm:l,status:r,error:o,validationStatus:c}=this.state;if(s.length===0)return(0,a.jsx)(Ve._,{text:"Loading labels..."});const d=Dt(t),u=G(this.state.labels),g=u===Se;let f=s.filter(m=>m.selected&&m.values);return l?f=f.map(m=>{const S=m.values.filter(y=>{if(y.selected)return y.highlightParts=void 0,!0;const C=(0,Ot.I)(y.name.toLowerCase(),l.toLowerCase());return C.found?(y.highlightParts=C.ranges,y.order=C.distance,!0):!1});return{...m,values:(0,I.sortBy)(S,y=>y.selected?-1/0:y.order)}}):f=this.state.labels.filter(m=>m.selected&&m.values).map(m=>({...m,values:m?.values?m.values.map(S=>({...S,highlightParts:void 0})):[]})),(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)("div",{className:d.wrapper,children:[(0,a.jsxs)("div",{className:(0,p.cx)(d.section,d.wrapperPadding),children:[(0,a.jsx)(pe.J,{description:"Which labels would you like to consider for your search?",children:"1. Select labels to search in"}),(0,a.jsx)("div",{className:d.list,children:s.map(m=>(0,a.jsx)(xe.J,{name:m.name,loading:m.loading,active:m.selected,hidden:m.hidden,facets:m.facets,onClick:this.onClickLabel},m.name))})]}),(0,a.jsxs)("div",{className:(0,p.cx)(d.section,d.wrapperPadding),children:[(0,a.jsx)(pe.J,{description:"Choose the label values that you would like to use for the query. Use the search field to find values across selected labels.",children:"2. Find values for the selected labels"}),(0,a.jsx)("div",{children:(0,a.jsx)(ae.p,{onChange:this.onChangeSearch,"aria-label":"Filter expression for values",value:l,placeholder:"Enter a label value"})}),(0,a.jsx)("div",{className:d.valueListArea,children:f.map(m=>(0,a.jsxs)("div",{role:"list",className:d.valueListWrapper,children:[(0,a.jsx)("div",{className:d.valueTitle,"aria-label":`Values for ${m.name}`,children:(0,a.jsx)(xe.J,{name:m.name,loading:m.loading,active:m.selected,hidden:m.hidden,facets:m.facets||m.values?.length,onClick:this.onClickLabel})}),(0,a.jsx)(Ct.Y1,{height:200,itemCount:m.values?.length||0,itemSize:28,itemKey:S=>m.values?.[S].name??S,width:200,className:d.valueList,children:({index:S,style:y})=>{const C=m.values?.[S];return C?(0,a.jsx)("div",{style:y,children:(0,a.jsx)(xe.J,{name:m.name,value:C?.name,active:C?.selected,highlightParts:C?.highlightParts,onClick:this.onClickValue,searchTerm:l})}):null}})]},m.name))})]})]}),(0,a.jsxs)("div",{className:d.footerSectionStyles,children:[(0,a.jsx)(pe.J,{children:"3. Resulting selector"}),(0,a.jsx)("pre",{"aria-label":"selector",className:d.selector,children:u}),c&&(0,a.jsx)("div",{className:d.validationStatus,children:c}),(0,a.jsx)("div",{className:(0,p.cx)(d.status,(r||o)&&d.statusShowing),children:(0,a.jsx)("span",{className:o?d.error:"",children:o||r})}),(0,a.jsxs)(le.B,{gap:1,children:[(0,a.jsx)(D.$n,{"aria-label":"Use selector as logs button",disabled:g,onClick:this.onClickRunLogsQuery,children:"Show logs"}),(0,a.jsx)(D.$n,{"aria-label":"Use selector as metrics button",variant:"secondary",disabled:g,onClick:this.onClickRunMetricsQuery,children:"Show logs rate"}),(0,a.jsx)(D.$n,{"aria-label":"Validate submit button",variant:"secondary",disabled:g,onClick:this.onClickValidate,children:"Validate selector"}),(0,a.jsx)(D.$n,{"aria-label":"Selector clear button",variant:"secondary",onClick:this.onClickClear,children:"Clear"})]})]})]})}}const It=(0,w.cV)(wt),Mt=e=>{const{isOpen:t,onClose:s,datasource:l,app:r,timeRange:o}=e,[c,d]=(0,n.useState)(!1),[u,g]=(0,n.useState)(!1),f="grafana.datasources.loki.browser.labels",m=(0,w.of)(kt);(0,n.useEffect)(()=>{t&&l.languageProvider.fetchLabels({timeRange:o}).then(O=>{d(!0),g(O.length>0)})},[l,t,o]);const S=O=>{const{query:E,onChange:v,onRunQuery:h}=e,j={...E,expr:O};v(j),h()},y=O=>{S(O),s()},C=()=>{(0,k.rR)("grafana_loki_label_browser_closed",{app:r,closeType:"modalClose"}),s()};return(0,a.jsxs)(ze.a,{isOpen:t,title:"Label browser",onDismiss:C,className:m.modal,children:[!c&&(0,a.jsx)(Ve._,{text:"Loading labels..."}),c&&!u&&(0,a.jsx)("p",{children:"No labels found."}),c&&u&&(0,a.jsx)(jt.b,{storageKey:f,defaultValue:[],children:(O,E,v)=>(0,a.jsx)(It,{languageProvider:l.languageProvider,onChange:y,lastUsedLabels:O,storeLastUsedLabels:E,deleteLastUsedLabels:v,app:r,timeRange:o})})]})},kt=e=>({modal:(0,p.css)({width:"85vw",[e.breakpoints.down("md")]:{width:"100%"}})});var Bt=i(65307),P=i(18362),X=i(32783),Pt=i(22592),Le=i(32300),Y=i(30048),We=i(75349),Qt=i(26774),He=i(30394),q=i(47184),_=i(18027),K=i(18857),Rt=i(72500),$t=i(20301);const Ft="You have conflicting label filters";function At({item:e,items:t,defaultOp:s,onChange:l,onDelete:r,onGetLabelNames:o,onGetLabelValues:c,invalidLabel:d,invalidValue:u,multiValueSeparator:g="|"}){var f;const[m,S]=(0,n.useState)({}),[y,C]=(0,n.useState)(!1),[O,E]=(0,n.useState)(!1),v=(b=e.op)=>{var T;return(T=Ge.find(L=>L.label===b))==null?void 0:T.isMultiValue},h=b=>b?b.indexOf(g)>0?b.split(g):[b]:[],j=()=>{const b=m.labelValues?[...m.labelValues]:[],T=h(e?.value).map(q.z);return(0,I.uniqBy)([...T,...b],"value")},x=Ut(e,t),{current:N}=(0,n.useRef)((0,He.A)());return n.createElement("div",{"data-testid":"visual-query-builder-dimensions-filter-item"},n.createElement(_.I,{error:Ft,invalid:x?!0:void 0},n.createElement(Rt.M,null,n.createElement(K.l6,{placeholder:"Select label","data-testid":ce.Tp.components.QueryBuilder.labelSelect,inputId:`visual-query-builder-dimensions-filter-item-key-${N}`,width:"auto",value:e.label?(0,q.z)(e.label):null,allowCustomValue:!0,onOpenMenu:async()=>{S({isLoadingLabelNames:!0});const b=await o(e);C(!0),S({labelNames:b,isLoadingLabelNames:void 0})},onCloseMenu:()=>{C(!1)},isOpen:y,isLoading:m.isLoadingLabelNames,options:m.labelNames,onChange:b=>{var T;b.value&&l({...e,op:(T=e.op)!=null?T:s,label:b.value})},invalid:x||d}),n.createElement(K.l6,{"data-testid":ce.Tp.components.QueryBuilder.matchOperatorSelect,value:(0,q.z)((f=e.op)!=null?f:s),options:Ge,width:"auto",onChange:b=>{b.value&&l({...e,op:b.value,value:v(b.value)?e.value:h(e?.value)[0]})},invalid:x}),n.createElement(K.l6,{placeholder:"Select value","data-testid":ce.Tp.components.QueryBuilder.valueSelect,inputId:`visual-query-builder-dimensions-filter-item-value-${N}`,width:"auto",value:v()?h(e?.value).map(q.z):h(e?.value).map(q.z)[0],allowCustomValue:!0,onOpenMenu:async()=>{S({isLoadingLabelValues:!0});const b=await c(e);S({...m,labelValues:b,isLoadingLabelValues:void 0}),E(!0)},onCloseMenu:()=>{E(!1)},isOpen:O,isMulti:v(),isLoading:m.isLoadingLabelValues,options:j(),onChange:b=>{var T,L;if(b.value)l({...e,value:b.value,op:(T=e.op)!=null?T:s});else{const M=b.map(H=>{if(H.value)return H.value}).filter(H=>H!==void 0).join(g);l({...e,value:M,op:(L=e.op)!=null?L:s})}},invalid:x||u}),n.createElement($t.Z,{"aria-label":"remove",icon:"times",variant:"secondary",onClick:r}))))}const Ge=[{label:"=",value:"=",description:"Equals",isMultiValue:!1},{label:"!=",value:"!=",description:"Does not equal",isMultiValue:!1},{label:"=~",value:"=~",description:"Matches regex",isMultiValue:!0},{label:"!~",value:"!~",description:"Does not match regex",isMultiValue:!0}];function Ut(e,t){if(!e.label||!e.op||!e.value||t.length<2)return!1;const s=e.op.toString().startsWith("!");return t.filter(o=>o.label===e.label&&o.value===e.value&&o.op!==e.op).some(o=>{var c,d;return!!(s&&((c=o?.op)==null?void 0:c.toString().startsWith("!"))===!1||s===!1&&((d=o?.op)!=null&&d.toString().startsWith("!")))})}const zt="Select at least 1 label filter (label and value)";function Vt({labelsFilters:e,onChange:t,onGetLabelNames:s,onGetLabelValues:l,labelFilterRequired:r,multiValueSeparator:o}){const c="=",[d,u]=(0,n.useState)([{op:c}]);(0,n.useEffect)(()=>{e.length>0?u(e):u([{op:c}])},[e]);const g=m=>{u(m);const S=m.filter(y=>y.label!==void 0&&y.value!==void 0);(0,I.isEqual)(S,e)||t(S)},f=d.some(m=>m.label&&m.value);return n.createElement(We.B,null,n.createElement(Y.c,{label:"Label filters",error:zt,invalid:r&&!f},n.createElement(Qt.o,{items:d,onChange:g,renderItem:(m,S,y)=>n.createElement(At,{item:m,items:d,defaultOp:c,onChange:S,onDelete:y,onGetLabelNames:s,onGetLabelValues:l,invalidLabel:r&&!m.label,invalidValue:r&&!m.value,multiValueSeparator:o})})))}var Ke=i(67458);function je({title:e,stepNumber:t,markdown:s,children:l}){const r=(0,w.of)(Wt);return n.createElement("div",{className:r.box},t!==void 0&&n.createElement("div",{className:r.stepNumber},t),n.createElement("div",{className:r.boxInner},e&&n.createElement("div",{className:r.header},n.createElement("span",null,e)),n.createElement("div",{className:r.body},s&&n.createElement("div",{dangerouslySetInnerHTML:{__html:(0,Ke.G)(s)}}),l)))}const Wt=e=>({box:(0,p.css)({background:e.colors.background.secondary,padding:e.spacing(1),borderRadius:e.shape.radius.default,position:"relative"}),boxInner:(0,p.css)({marginLeft:e.spacing(4)}),stepNumber:(0,p.css)({fontWeight:e.typography.fontWeightMedium,background:e.colors.secondary.main,width:"20px",height:"20px",borderRadius:e.shape.radius.circle,display:"flex",alignItems:"center",justifyContent:"center",position:"absolute",top:"10px",left:"11px",fontSize:e.typography.bodySmall.fontSize}),header:(0,p.css)({paddingBottom:e.spacing(.5),display:"flex",alignItems:"center",fontFamily:e.typography.fontFamilyMonospace}),body:(0,p.css)({color:e.colors.text.secondary,"p:last-child":{margin:0},a:{color:e.colors.text.link,textDecoration:"underline"}})});var oe=i(54078),Ht=i(62955),Ce=i(57095),Gt=i(1604),Kt=i(64913),ge=i(45967),Oe=i(30703),Jt=i(20479),Zt=i(15245);const Je=n.memo(({definition:e,operation:t,innerQueryPlaceholder:s})=>{const l=(0,w.of)(Xt),[r,o]=(0,n.useState)(!1),{getTooltipProps:c,setTooltipRef:d,setTriggerRef:u,visible:g}=(0,Jt.usePopperTooltip)({placement:"top",visible:r,offset:[0,16],onVisibleChange:o,interactive:!0,trigger:["click"]});return n.createElement(n.Fragment,null,n.createElement(D.$n,{title:"Click to show description",ref:u,icon:"info-circle",size:"sm",variant:"secondary",fill:"text"}),g&&n.createElement(Zt.ZL,null,n.createElement("div",{ref:d,...c(),className:l.docBox},n.createElement("div",{className:l.docBoxHeader},n.createElement("span",null,e.renderer(t,e,s)),n.createElement(ue.Z,{grow:1}),n.createElement(D.$n,{icon:"times",onClick:()=>o(!1),fill:"text",variant:"secondary",title:"Remove operation"})),n.createElement("div",{className:l.docBoxBody,dangerouslySetInnerHTML:{__html:Yt(e,t)}}))))});Je.displayName="OperationDocs";const Xt=e=>({docBox:(0,p.css)({overflow:"hidden",background:e.colors.background.primary,border:`1px solid ${e.colors.border.strong}`,boxShadow:e.shadows.z3,maxWidth:"600px",padding:e.spacing(1),borderRadius:e.shape.radius.default,zIndex:e.zIndex.tooltip}),docBoxHeader:(0,p.css)({fontSize:e.typography.h5.fontSize,fontFamily:e.typography.fontFamilyMonospace,paddingBottom:e.spacing(1),display:"flex",alignItems:"center"}),docBoxBody:(0,p.css)({marginBottom:e.spacing(-1),color:e.colors.text.secondary}),signature:(0,p.css)({fontSize:e.typography.bodySmall.fontSize,fontFamily:e.typography.fontFamilyMonospace}),dropdown:(0,p.css)({opacity:0,color:e.colors.text.secondary})});function Yt(e,t){var s;return(0,Ke.G)(e.explainHandler?e.explainHandler(t,e):(s=e.documentation)!=null?s:"no docs")}const Ze=n.memo(({operation:e,definition:t,index:s,onChange:l,onRemove:r,onToggle:o,queryModeller:c,dragHandleProps:d})=>{var u;const g=(0,w.of)(qt),[f,m]=(0,n.useState)({}),S=()=>{if(f.isOpen)m({...f,isOpen:!1});else{const y=c.getAlternativeOperations(t.alternativesKey).map(C=>({label:C.name,value:C}));m({isOpen:!0,alternatives:y})}};return n.createElement("div",{className:g.header},!f.isOpen&&n.createElement(n.Fragment,null,n.createElement("div",{...d},(u=t.name)!=null?u:t.id),n.createElement(ue.Z,{grow:1}),n.createElement("div",{className:`${g.operationHeaderButtons} operation-header-show-on-hover`},n.createElement(D.$n,{icon:"angle-down",size:"sm",onClick:S,fill:"text",variant:"secondary",title:"Click to view alternative operations"}),n.createElement(Je,{definition:t,operation:e,innerQueryPlaceholder:c.innerQueryPlaceholder}),t.toggleable&&n.createElement(D.$n,{icon:e.disabled?"eye-slash":"eye",size:"sm",onClick:()=>o(s),fill:"text",variant:"secondary",title:e.disabled?"Enable operation":"Disable operation"}),n.createElement(D.$n,{icon:"times",size:"sm",onClick:()=>r(s),fill:"text",variant:"secondary",title:"Remove operation"}))),f.isOpen&&n.createElement("div",{className:g.selectWrapper},n.createElement(K.l6,{autoFocus:!0,openMenuOnFocus:!0,placeholder:"Replace with",options:f.alternatives,isOpen:!0,onCloseMenu:S,onChange:y=>{if(y.value){const C=c.getOperationDefinition(y.value.id),O=[...C.defaultParams];for(let v=0;v<Math.min(e.params.length,O.length);v++)C.params[v].type===t.params[v].type&&(O[v]=e.params[v]);const E={...e,params:O,id:y.value.id};l(s,t.changeTypeHandler?t.changeTypeHandler(E,C):E)}}})))});Ze.displayName="OperationHeader";const qt=e=>({header:(0,p.css)({borderBottom:`1px solid ${e.colors.border.medium}`,padding:e.spacing(.5,.5,.5,1),display:"flex",alignItems:"center"}),operationHeaderButtons:(0,p.css)({opacity:1}),selectWrapper:(0,p.css)({paddingRight:e.spacing(2)})});var se=i(33033),_t=i(32635);function ea(e){if(e.editor)return e.editor;if(e.options)return sa;switch(e.type){case"boolean":return aa;case"number":case"string":default:return ta}}function ta(e){var t;return n.createElement(se.D,{id:me(e.operationId,e.index),defaultValue:(t=e.value)==null?void 0:t.toString(),minWidth:e.paramDef.minWidth,placeholder:e.paramDef.placeholder,title:e.paramDef.description,maxWidth:(e.paramDef.minWidth||20)*3,onCommitChange:s=>{e.onChange(e.index,s.currentTarget.value),e.paramDef.runQueryOnEnter&&s.type==="keydown"&&e.onRunQuery()}})}function aa(e){return n.createElement(_t.S,{id:me(e.operationId,e.index),value:!!e.value,onChange:t=>e.onChange(e.index,t.currentTarget.checked)})}function sa({paramDef:e,value:t,index:s,operationId:l,onChange:r}){var o,c;const d=(0,w.of)(na);let u=e.options;(o=u[0])!=null&&o.label||(u=e.options.map(f=>({label:f.toString(),value:f})));let g=(c=u.find(f=>f.value===t))!=null?c:(0,q.z)(t);return!t&&e.optional?n.createElement("div",{className:d.optionalParam},n.createElement(D.$n,{size:"sm",variant:"secondary",title:`Add ${e.name}`,icon:"plus",onClick:()=>r(s,u[0].value)},e.name)):n.createElement(te.C,{gap:.5,direction:"row",alignItems:"center"},n.createElement(K.l6,{id:me(l,s),value:g,options:u,placeholder:e.placeholder,allowCustomValue:!0,onChange:f=>r(s,f.value),width:e.minWidth||"auto"}),e.optional&&n.createElement(D.$n,{"data-testid":`operations.${s}.remove-param`,size:"sm",fill:"text",icon:"times",variant:"secondary",title:`Remove ${e.name}`,onClick:()=>r(s,"")}))}const na=e=>({optionalParam:(0,p.css)({marginTop:e.spacing(1)})});function me(e,t){return`operations.${e}.param.${t}`}function ra({provided:e,flash:t,isConflicting:s,highlight:l,index:r,queryModeller:o,onChange:c,onRemove:d,onToggle:u,operation:g,definition:f,query:m,timeRange:S,onRunQuery:y,datasource:C}){const O=(0,w.$j)(),E=la(O,s),v=oa(t),{current:h}=(0,n.useRef)((0,He.A)()),j=(T,L)=>{const M={...g,params:[...g.params]};M.params[T]=L,Ne(f,M,r,T,c)},x=()=>{const T={...g,params:[...g.params,""]};Ne(f,T,r,g.params.length,c)},N=T=>{const L={...g,params:[...g.params.slice(0,T),...g.params.slice(T+1)]};Ne(f,L,r,T,c)};let b;if(f.params.length>0){const T=f.params[f.params.length-1];T.restParam&&(b=ia(T,x,r,g.params.length,E))}return n.createElement("div",{className:(0,p.cx)(E.card,{[E.cardHighlight]:v||l,[E.cardError]:s,[E.disabled]:g.disabled}),ref:e.innerRef,...e.draggableProps,"data-testid":`operations.${r}.wrapper`},n.createElement(Ze,{operation:g,dragHandleProps:e.dragHandleProps,definition:f,index:r,onChange:c,onRemove:d,onToggle:u,queryModeller:o}),n.createElement("div",{className:E.body},g.params.map((T,L)=>{const M=f.params[Math.min(f.params.length-1,L)],H=ea(M);return n.createElement("div",{className:E.paramRow,key:`${L}-1`},!M.hideName&&n.createElement("div",{className:E.paramName},n.createElement("label",{htmlFor:me(h,L)},M.name),M.description&&n.createElement(ge.m,{placement:"top",content:M.description,theme:"info"},n.createElement(Oe.I,{name:"info-circle",size:"sm",className:E.infoIcon}))),n.createElement("div",{className:E.paramValue},n.createElement(te.C,{gap:.5,direction:"row",alignItems:"center",wrap:!1},n.createElement(H,{index:L,paramDef:M,value:g.params[L],operation:g,operationId:h,onChange:j,onRunQuery:y,query:m,datasource:C,timeRange:S,queryModeller:o}),M.restParam&&(g.params.length>f.params.length||M.optional)&&n.createElement(D.$n,{"data-testid":`operations.${r}.remove-rest-param`,size:"sm",fill:"text",icon:"times",variant:"secondary",title:`Remove ${M.name}`,onClick:()=>N(L)}))))})),b,r<m.operations.length-1&&n.createElement("div",{className:E.arrow},n.createElement("div",{className:E.arrowLine}),n.createElement("div",{className:E.arrowArrow})))}const la=(e,t)=>({cardWrapper:(0,p.css)({alignItems:"stretch"}),error:(0,p.css)({marginBottom:e.spacing(1)}),card:(0,p.css)({background:e.colors.background.primary,border:`1px solid ${e.colors.border.medium}`,cursor:"grab",borderRadius:e.shape.radius.default,position:"relative",transition:"all 0.5s ease-in 0s",height:t?"auto":"100%"}),disabled:(0,p.css)({opacity:.5,transition:"none"}),cardError:(0,p.css)({boxShadow:`0px 0px 4px 0px ${e.colors.warning.main}`,border:`1px solid ${e.colors.warning.main}`}),cardHighlight:(0,p.css)({boxShadow:`0px 0px 4px 0px ${e.colors.primary.border}`,border:`1px solid ${e.colors.primary.border}`}),infoIcon:(0,p.css)({marginLeft:e.spacing(.5),color:e.colors.text.secondary,":hover":{color:e.colors.text.primary}}),body:(0,p.css)({margin:e.spacing(1,1,.5,1),display:"table"}),paramRow:(0,p.css)({label:"paramRow",display:"table-row",verticalAlign:"middle"}),paramName:(0,p.css)({display:"table-cell",padding:e.spacing(0,1,0,0),fontSize:e.typography.bodySmall.fontSize,fontWeight:e.typography.fontWeightMedium,verticalAlign:"middle",height:"32px"}),paramValue:(0,p.css)({label:"paramValue",display:"table-cell",verticalAlign:"middle"}),restParam:(0,p.css)({padding:e.spacing(0,1,1,1)}),arrow:(0,p.css)({position:"absolute",top:"0",right:"-18px",display:"flex"}),arrowLine:(0,p.css)({height:"2px",width:"8px",backgroundColor:e.colors.border.strong,position:"relative",top:"14px"}),arrowArrow:(0,p.css)({width:0,height:0,borderTop:"5px solid transparent",borderBottom:"5px solid transparent",borderLeft:`7px solid ${e.colors.border.strong}`,position:"relative",top:"10px"})});function oa(e){const[t,s]=(0,n.useState)(!0);return(0,n.useEffect)(()=>{let l;return e?l=setTimeout(()=>{s(!1)},1e3):s(!0),()=>clearTimeout(l)},[e]),t&&e}function Ne(e,t,s,l,r){e.paramChangedHandler?r(s,e.paramChangedHandler(l,t,e)):r(s,t)}function ia(e,t,s,l,r){return n.createElement("div",{className:r.restParam,key:`${l}-2`},n.createElement(D.$n,{size:"sm",icon:"plus",title:`Add ${e.name}`.trimEnd(),variant:"secondary",onClick:t,"data-testid":`operations.${s}.add-rest-param`},e.name))}function ca({operation:e,index:t,onRemove:s,onToggle:l,onChange:r,onRunQuery:o,queryModeller:c,query:d,datasource:u,flash:g,highlight:f,timeRange:m,isConflictingOperation:S}){const y=c.getOperationDefinition(e.id),C=(0,w.$j)(),O=S?S(e,d.operations):!1,E=da(C);if(!y)return n.createElement("span",null,"Operation ",e.id," not found");const v=h=>{if(!h)return O?!0:void 0};return n.createElement(Ce.Draggable,{draggableId:`operation-${t}`,index:t},(h,j)=>n.createElement(_.I,{error:"You have conflicting label filters",invalid:v(j.isDragging),className:(0,p.cx)(E.error,E.cardWrapper)},n.createElement(ra,{provided:h,flash:g,highlight:f,isConflicting:O,index:t,operation:e,definition:y,onChange:r,onRemove:s,onToggle:l,queryModeller:c,query:d,timeRange:m,onRunQuery:o,datasource:u})))}const da=(e,t)=>({cardWrapper:(0,p.css)({alignItems:"stretch"}),error:(0,p.css)({marginBottom:e.spacing(1)})});function ua({query:e,datasource:t,queryModeller:s,onChange:l,onRunQuery:r,highlightedOp:o,timeRange:c,isConflictingOperation:d}){const u=(0,w.of)(ma),{operations:g}=e,f=pa(g),[m,S]=(0,n.useState)(!1),y=(x,N)=>{const b=[...g];b.splice(x,1,N),l({...e,operations:b})},C=x=>{const N=[...g.slice(0,x),...g.slice(x+1)];l({...e,operations:N})},O=x=>{y(x,{...g[x],disabled:!g[x].disabled})},E=s.getCategories().map(x=>({value:x,label:x,items:s.getOperationsForCategory(x).map(N=>({value:N.id,label:N.name,isLeaf:!0}))})),v=x=>{const N=s.getOperationDefinition(x);N&&(l(N.addOperationHandler(N,e,s)),S(!1))},h=x=>{if(!x.destination)return;const N=[...g],b=N[x.source.index];N.splice(x.source.index,1),N.splice(x.destination.index,0,b),l({...e,operations:N})},j=()=>{S(!1)};return n.createElement(te.C,{gap:1,direction:"column"},n.createElement(te.C,{gap:1},g.length>0&&n.createElement(Ce.DragDropContext,{onDragEnd:h},n.createElement(Ce.Droppable,{droppableId:"sortable-field-mappings",direction:"horizontal"},x=>n.createElement("div",{className:u.operationList,ref:x.innerRef,...x.droppableProps},g.map((N,b)=>n.createElement(ca,{key:N.id+JSON.stringify(N.params)+b,queryModeller:s,index:b,operation:N,query:e,datasource:t,onChange:y,onRemove:C,onToggle:O,onRunQuery:r,flash:f[b],highlight:o===N,timeRange:c,isConflictingOperation:d})),x.placeholder))),n.createElement("div",{className:u.addButton},m?n.createElement(Kt.v,{options:E,onSelect:v,onBlur:j,autoFocus:!0,alwaysOpen:!0,hideActiveLevelLabel:!0,placeholder:"Search"}):n.createElement(D.$n,{icon:"plus",variant:"secondary",onClick:()=>S(!0),title:"Add operation"},"Operations"))))}function pa(e){const t=(0,Gt.A)(),s=(0,J.A)(e);if(!t())return e.map(()=>!1);if(!s)return e.map(()=>!0);let l=[];if(s.length-1===e.length&&e.every(r=>s.includes(r)))return e.map(()=>!1);if(s.length+1===e.length&&s.every(r=>e.includes(r))){const r=e.find(o=>!s.includes(o));l=e.map(o=>o===r)}else l=e.map((r,o)=>{var c;return!ga(r.id,(c=s[o])==null?void 0:c.id)});return l}function ga(e,t){return e===t||`__${e}_by`===t||e===`__${t}_by`}const ma=e=>({heading:(0,p.css)({label:"heading",fontSize:12,fontWeight:e.typography.fontWeightMedium,marginBottom:0}),operationList:(0,p.css)({label:"operationList",display:"flex",flexWrap:"wrap",gap:e.spacing(2)}),addButton:(0,p.css)({label:"addButton",width:126,paddingBottom:e.spacing(1)})}),Xe=({datasource:e,query:t,onChange:s,data:l,queryModeller:r,buildVisualQueryFromString:o,buildDataQueryFromQueryString:c,buildQueryStringFromDataQuery:d})=>{const[u,g]=(0,n.useState)([]),f=(0,w.of)(ha);return(0,n.useEffect)(()=>{var m;const S=c(r.renderQuery(t)),y=(m=e.getQueryHints)==null?void 0:m.call(e,S,l?.series||[]).filter(C=>{var O;return(O=C.fix)==null?void 0:O.action});g(y??[])},[e,t,l,r,c]),n.createElement(n.Fragment,null,u.length>0&&n.createElement("div",{className:f.container},u.map(m=>{var S,y,C,O;return n.createElement(ge.m,{content:`${m.label} ${(S=m.fix)==null?void 0:S.label}`,key:m.type},n.createElement(D.$n,{onClick:()=>{var E,v,h;if((0,k.rR)("grafana_query_builder_hints_clicked",{hint:m.type,datasourceType:e.type}),(E=m?.fix)!=null&&E.action){const j=c(r.renderQuery(t)),x=(v=e.modifyQuery)==null?void 0:v.call(e,j,m.fix.action);if(x){const N=o((h=d(x))!=null?h:"");return s(N.query)}}},fill:"outline",size:"sm",className:f.hint},"hint: ",((y=m.fix)==null?void 0:y.title)||((O=(C=m.fix)==null?void 0:C.action)==null?void 0:O.type.toLowerCase().replace("_"," "))))})))};Xe.displayName="QueryBuilderHints";const ha=e=>({container:(0,p.css)`
      display: flex;
      align-items: start;
    `,hint:(0,p.css)`
      margin-right: ${e.spacing(1)};
    `});var Fs=i(28848);function Ye({query:e,queryModeller:t,stepNumber:s,language:l,onMouseEnter:r,onMouseLeave:o}){return n.createElement(n.Fragment,null,e.operations.map((c,d)=>{var u;const g=t.getOperationDefinition(c.id);if(!g)return`Operation ${c.id} not found`;const f=g.renderer(c,g,t.innerQueryPlaceholder),m=g.explainHandler?g.explainHandler(c,g):(u=g.documentation)!=null?u:"no docs";return n.createElement("div",{key:d,onMouseEnter:()=>r?.(c,d),onMouseLeave:()=>o?.(c,d)},n.createElement(je,{stepNumber:d+s,title:n.createElement(oe.Z,{query:f,language:l}),markdown:m}))}))}var he=i(77236),fa=i(88744),ee=i(95826);const qe="Fetch all log lines matching label filters.",_e=(0,n.memo)(({query:e})=>{const t=(0,X.u_)(e||"").query,s={grammar:he.vB,name:"lokiql"};return(0,a.jsxs)(le.B,{gap:0,direction:"column",children:[(0,a.jsx)(je,{stepNumber:1,title:(0,a.jsx)(oe.Z,{query:`${P.y.renderLabels(t.labels)}`,language:s}),children:qe}),(0,a.jsx)(Ye,{stepNumber:2,queryModeller:P.y,query:t,language:s})]})});_e.displayName="LokiQueryBuilderExplained";var va=i(76319),ya=i(80124);const et=(0,n.memo)(({nestedQuery:e,index:t,datasource:s,onChange:l,onRemove:r,onRunQuery:o,showExplain:c})=>{const d=(0,w.of)(ba);return(0,a.jsxs)("div",{className:d.card,children:[(0,a.jsxs)("div",{className:d.header,children:[(0,a.jsx)("div",{className:d.name,children:"Operator"}),(0,a.jsx)(K.l6,{"aria-label":"Select operator",width:"auto",options:xa,value:(0,q.z)(e.operator),onChange:u=>{l(t,{...e,operator:u.value})}}),(0,a.jsx)("div",{className:d.name,children:"Vector matches"}),(0,a.jsxs)("div",{className:d.vectorMatchWrapper,children:[(0,a.jsx)(K.l6,{width:"auto",value:e.vectorMatchesType||"on",allowCustomValue:!0,options:[{value:"on",label:"on"},{value:"ignoring",label:"ignoring"}],onChange:u=>{l(t,{...e,vectorMatchesType:u.value})}}),(0,a.jsx)(se.D,{className:d.vectorMatchInput,minWidth:20,defaultValue:e.vectorMatches,onCommitChange:u=>{l(t,{...e,vectorMatches:u.currentTarget.value,vectorMatchesType:e.vectorMatchesType||"on"})}})]}),(0,a.jsx)(ue.Z,{grow:1}),(0,a.jsx)(va.K,{name:"times",size:"sm",onClick:()=>r(t),tooltip:"Remove nested query"})]}),(0,a.jsx)("div",{className:d.body,children:(0,a.jsx)(Ue.D,{children:(0,a.jsx)(Te,{showExplain:c,query:e.query,datasource:s,onRunQuery:o,onChange:u=>{l(t,{...e,query:u})}})})})]})}),xa=ya.C.map(e=>({label:e.sign,value:e.sign}));et.displayName="NestedQuery";const ba=e=>({card:(0,p.css)({label:"card",display:"flex",flexDirection:"column",gap:e.spacing(.5)}),header:(0,p.css)({label:"header",padding:e.spacing(.5,.5,.5,1),gap:e.spacing(1),display:"flex",alignItems:"center"}),name:(0,p.css)({label:"name",whiteSpace:"nowrap"}),body:(0,p.css)({label:"body",paddingLeft:e.spacing(2)}),vectorMatchInput:(0,p.css)({label:"vectorMatchInput",marginLeft:-1}),vectorMatchWrapper:(0,p.css)({label:"vectorMatchWrapper",display:"flex"})});function Ea({query:e,datasource:t,onChange:s,onRunQuery:l,showExplain:r}){const o=e.binaryQueries??[],c=(u,g)=>{const f=[...o];f.splice(u,1,g),s({...e,binaryQueries:f})},d=u=>{const g=[...o.slice(0,u),...o.slice(u+1)];s({...e,binaryQueries:g})};return(0,a.jsx)(le.B,{direction:"column",gap:1,children:o.map((u,g)=>(0,a.jsx)(et,{nestedQuery:u,index:g,onChange:c,datasource:t,onRemove:d,onRunQuery:l,showExplain:r},g.toString()))})}const tt=5*60*1e3,Te=(0,n.memo)(({datasource:e,query:t,onChange:s,onRunQuery:l,showExplain:r,timeRange:o})=>{const[c,d]=(0,n.useState)(),[u,g]=(0,n.useState)(void 0),f=(0,J.A)(t),m=(0,J.A)(o),S=h=>{s({...t,labels:h})},y=async h=>{const j=await h;return[...e.getVariables(),...j].map(x=>({label:x,value:x}))},C=async h=>{const j=t.labels.filter(L=>L!==h),x=j.find(L=>L.op==="="||L.op==="=~"&&new RegExp(L.value).test("")===!1);if(j.length===0||!x)return await e.languageProvider.fetchLabels({timeRange:o});const N=P.y.renderLabels(j),b=await e.languageProvider.fetchLabels({streamSelector:N,timeRange:o}),T=j.map(L=>L.label);return b.filter(L=>!T.includes(L)).sort()},O=async h=>{if(!h.label)return[];let j;const x=t.labels.filter(b=>b!==h),N=x.find(b=>b.op==="="||b.op==="=~"&&new RegExp(b.value).test("")===!1);if(x.length===0||!N)j=await e.languageProvider.fetchLabelValues(h.label,{timeRange:o});else{const b=P.y.renderLabels(x);j=await e.languageProvider.fetchLabelValues(h.label,{streamSelector:b,timeRange:o})}return j?j.map(b=>(0,Q.Bb)(b,h.op)):[]},E=(0,n.useMemo)(()=>{const{labels:h,operations:j}=t;return!h.length&&j.length?!(j.length===1&&j[0].id===ee.EF.LineContains&&j[0].params[0]===""):!1},[t]);(0,n.useEffect)(()=>{const h=async()=>{const N={expr:P.y.renderQuery(t),refId:"data-samples"},b=o??(0,Pt.E2)(),L={series:await e.getDataSamples(N,b),state:ve.Gu.Done,timeRange:b};d(L)},j=m&&o&&(Math.abs(o.to.valueOf()-m.to.valueOf())>tt||Math.abs(o.from.valueOf()-m.from.valueOf())>tt),x=!(0,I.isEqual)(f,t);Z.$.featureToggles.lokiQueryHints&&(j||x)&&h().catch(console.error)},[e,t,o,f,m]);const v={grammar:he.Ay,name:"logql"};return(0,a.jsxs)("div",{"data-testid":Me.editor,children:[(0,a.jsx)(Le.U,{children:(0,a.jsx)(Vt,{onGetLabelNames:h=>y(C(h)),onGetLabelValues:h=>y(O(h)),labelsFilters:t.labels,onChange:S,labelFilterRequired:E})}),r&&(0,a.jsx)(je,{stepNumber:1,title:(0,a.jsx)(oe.Z,{query:`${P.y.renderLabels(t.labels)}`,language:v}),children:qe}),(0,a.jsxs)(Ht.i,{children:[(0,a.jsx)(ua,{queryModeller:P.y,query:t,onChange:s,onRunQuery:l,datasource:e,highlightedOp:u,isConflictingOperation:(h,j)=>h.id===ee.EF.LabelFilter&&(0,fa.hh)(h,j)}),(0,a.jsx)(Xe,{datasource:e,query:t,onChange:s,data:c,queryModeller:P.y,buildVisualQueryFromString:X.u_,buildDataQueryFromQueryString:h=>({expr:h,refId:"hints"}),buildQueryStringFromDataQuery:h=>h.expr})]}),r&&(0,a.jsx)(Ye,{stepNumber:2,queryModeller:P.y,query:t,language:v,onMouseEnter:h=>{g(h)},onMouseLeave:()=>{g(void 0)}}),t.binaryQueries&&t.binaryQueries.length>0&&(0,a.jsx)(Ea,{query:t,datasource:e,onChange:s,onRunQuery:l,showExplain:r})]})});Te.displayName="LokiQueryBuilder";function Sa({query:e}){return(0,a.jsx)(Le.U,{children:(0,a.jsx)(We.B,{children:(0,a.jsx)(oe.Z,{query:e,language:{grammar:he.vB,name:"lokiql"}})})})}function La(e){const{query:t,onChange:s,onRunQuery:l,datasource:r,showExplain:o,timeRange:c}=e,[d,u]=(0,n.useReducer)(at.reducer,{expr:t.expr,visQuery:t.expr===""?{labels:[],operations:[{id:"__line_contains",params:[""]}]}:void 0});(0,n.useEffect)(()=>{u(Oa(t.expr))},[t.expr]);const g=f=>{const m=P.y.renderQuery(f);u(Ca({visQuery:f,expr:m})),s({...e.query,expr:m})};return d.visQuery?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(Te,{query:d.visQuery,datasource:r,onChange:g,onRunQuery:l,showExplain:o,"data-testid":Me.editor,timeRange:c}),t.expr!==""&&(0,a.jsx)(Sa,{query:t.expr})]}):null}const ja={expr:""},at=(0,Bt.Z0)({name:"loki-builder-container",initialState:ja,reducers:{visualQueryChange:(e,t)=>{e.expr=t.payload.expr,e.visQuery=t.payload.visQuery},exprChanged:(e,t)=>{if(!e.visQuery||e.expr!==t.payload){e.expr=t.payload;const s=(0,X.u_)(t.payload);e.visQuery=s.query}}}}),{visualQueryChange:Ca,exprChanged:Oa}=at.actions;var De=i(74529),Na=i(67770),we=i(739),Ta=i(78012),Da=i(42941),wa=i(55386),st=i(89599);function Ia({title:e,children:t,collapsedInfo:s,queryStats:l}){const[r,o]=(0,Da.A)(!1),c=(0,w.of)(Ma);return n.createElement("div",{className:c.wrapper},n.createElement(st.S,{className:c.collapse,collapsible:!0,isOpen:r,onToggle:o,label:n.createElement(te.C,{gap:0},n.createElement("h6",{className:c.title},e),!r&&n.createElement("div",{className:c.description},s.map((d,u)=>n.createElement("span",{key:u},d))))},n.createElement("div",{className:c.body},t)),l&&Z.$.featureToggles.lokiQuerySplitting&&n.createElement(ge.m,{content:"Note: the query will be split into multiple parts and executed in sequence. Query limits will only apply each individual part."},n.createElement(Oe.I,{tabIndex:0,name:"info-circle",className:c.tooltip,size:"sm"})),l&&n.createElement("p",{className:c.stats},ka(l)))}const Ma=e=>({collapse:(0,p.css)({backgroundColor:"unset",border:"unset",marginBottom:0,"> button":{padding:e.spacing(0,1)}}),wrapper:(0,p.css)({width:"100%",display:"flex",justifyContent:"space-between",alignItems:"baseline"}),title:(0,p.css)({flexGrow:1,overflow:"hidden",fontSize:e.typography.bodySmall.fontSize,fontWeight:e.typography.fontWeightMedium,margin:0}),description:(0,p.css)({color:e.colors.text.secondary,fontSize:e.typography.bodySmall.fontSize,fontWeight:e.typography.bodySmall.fontWeight,paddingLeft:e.spacing(2),gap:e.spacing(2),display:"flex"}),body:(0,p.css)({display:"flex",gap:e.spacing(2),flexWrap:"wrap"}),stats:(0,p.css)({margin:"0px",color:e.colors.text.secondary,fontSize:e.typography.bodySmall.fontSize}),tooltip:(0,p.css)({marginRight:e.spacing(.25)})}),ka=e=>e.message?e.message:`This query will process approximately ${Ba(e)}.`,Ba=e=>{const{text:t,suffix:s}=(0,wa.j_)("bytes")(e.bytes,1);return t+s};var ne=i(60093),nt=i(24162),$=i(12282);const rt=n.memo(({app:e,query:t,onChange:s,onRunQuery:l,maxLines:r,queryStats:o})=>{const[c,d]=(0,n.useState)(!0);(0,n.useEffect)(()=>{e!==z.Jk.Explore&&e!==z.Jk.Dashboard&&e!==z.Jk.PanelEditor||t.direction||s({...t,direction:lt(e)})},[e,s,t]),(0,n.useEffect)(()=>{t.step&&!(0,De.V3)(`${t.step}`)&&parseInt(t.step,10)&&s({...t,step:`${parseInt(t.step,10)}s`})},[s,t]);const u=h=>{s({...t,queryType:h}),l()},g=(0,n.useCallback)(h=>{s({...t,direction:h}),l()},[s,l,t]),f=h=>{const j=h.currentTarget.value;if(!(0,De.di)(j)){d(!1);return}d(!0),s({...t,splitDuration:j}),l()},m=h=>{s({...t,legendFormat:h.currentTarget.value}),l()};function S(h){const j=(0,ne.wU)(h.currentTarget.value);t.maxLines!==j&&(s({...t,maxLines:j}),l())}function y(h){s({...t,step:(0,I.trim)(h.currentTarget.value)}),l()}(0,n.useEffect)(()=>{if(e!==z.Jk.Dashboard&&e!==z.Jk.PanelEditor)return;const h=(0,U.J7)().subscribe(Na.Df,j=>{if(t.direction===$.ti.Scan)return;const x=j.payload.order===we.uH.Ascending?$.ti.Forward:$.ti.Backward;x!==t.direction&&g(x)});return()=>{h.unsubscribe()}},[e,g,t.direction]);let C=(0,nt.Io)(t);const O=(0,nt.sI)(t.expr),E=O?ne.TO.filter(h=>h.value!==$.U3.Instant):ne.TO;O&&C===$.U3.Instant&&(s({...t,queryType:$.U3.Range}),C=$.U3.Range);const v=(0,n.useMemo)(()=>t.step?typeof t.step=="string"&&(0,De.V3)(t.step)&&!isNaN(parseInt(t.step,10)):!0,[t.step]);return(0,a.jsx)(Le.U,{children:(0,a.jsxs)(Ia,{title:"Options",collapsedInfo:Pa(t,C,r,O,v,t.direction),queryStats:o,children:[(0,a.jsx)(Y.c,{label:"Legend",tooltip:"Series name override or template. Ex. {{hostname}} will be replaced with label value for hostname.",children:(0,a.jsx)(se.D,{placeholder:"{{label}}",type:"string",minWidth:14,defaultValue:t.legendFormat,onCommitChange:m})}),E.length>1&&(0,a.jsx)(Y.c,{label:"Type",children:(0,a.jsx)(ye.z,{options:E,value:C,onChange:u})}),O&&(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(Y.c,{label:"Line limit",tooltip:"Upper limit for number of log lines returned by query.",children:(0,a.jsx)(se.D,{className:"width-4",placeholder:r.toString(),type:"number",min:0,defaultValue:t.maxLines?.toString()??"",onCommitChange:S})}),(0,a.jsx)(Y.c,{label:"Direction",tooltip:"Direction to search for logs.",children:(0,a.jsx)(ye.z,{options:ne.BI,value:t.direction??lt(e),onChange:g})})]}),!O&&(0,a.jsx)(a.Fragment,{children:(0,a.jsx)(Y.c,{label:"Step",tooltip:"Use the step parameter when making metric queries to Loki. If not filled, Grafana's calculated interval will be used. Example valid values: 1s, 5m, 10h, 1d.",invalid:!v,error:"Invalid step. Example valid values: 1s, 5m, 10h, 1d.",children:(0,a.jsx)(se.D,{className:"width-6",placeholder:"auto",type:"string",value:t.step??"",onCommitChange:y})})}),Z.$.featureToggles.lokiQuerySplittingConfig&&Z.$.featureToggles.lokiQuerySplitting&&(0,a.jsx)(Y.c,{label:"Split Duration",tooltip:"Defines the duration of a single query when query splitting is enabled.",children:(0,a.jsx)(se.D,{minWidth:14,type:"string",min:0,defaultValue:t.splitDuration??"1d",onCommitChange:f,invalid:!c})})]})})});function Pa(e,t,s,l,r,o){const c=ne.TO.find(u=>u.value===t),d=[];return e.legendFormat&&d.push(`Legend: ${e.legendFormat}`),d.push(`Type: ${c?.label}`),l&&o?(d.push(`Line limit: ${e.maxLines??s}`),d.push(`Direction: ${(0,ne.w7)(o)}`)):e.step&&d.push(`Step: ${r?e.step:"Invalid value"}`),d}function lt(e){return e!==z.Jk.Explore?$.ti.Backward:(Ta.M.get("grafana.explore.logs.sortOrder")||we.uH.Descending)===we.uH.Ascending?$.ti.Forward:$.ti.Backward}rt.displayName="LokiQueryBuilderOptions";var ot=i(76864);function Qa({query:e,datasource:t,range:s,onRunQuery:l,onChange:r,data:o,app:c,showExplain:d,history:u}){const g=(0,w.of)(Ra);return(0,a.jsxs)("div",{className:g.wrapper,children:[(0,a.jsx)(ot.W,{datasource:t,query:e,range:s,onRunQuery:l,onChange:r,history:u,data:o,app:c,"data-testid":Me.editor}),d&&(0,a.jsx)(_e,{query:e.expr})]})}const Ra=e=>({wrapper:(0,p.css)({maxWidth:"100%",".gf-form":{marginBottom:.5}}),buttonGroup:(0,p.css)({border:`1px solid ${e.colors.border.medium}`,borderTop:"none",padding:e.spacing(.5,.5,.5,.5),marginBottom:e.spacing(.5),display:"flex",flexGrow:1,justifyContent:"end",fontSize:e.typography.bodySmall.fontSize}),hint:(0,p.css)({color:e.colors.text.disabled,whiteSpace:"nowrap",cursor:"help"})});var $a=i(39796),Fa=i(38903),Ie=i(8073);const Aa=e=>{const{pattern:t,onPatternSelect:s,hasNewQueryOption:l,hasPreviousQuery:r,selectedPatternName:o,setSelectedPatternName:c}=e,d=(0,w.of)(Ua),u={grammar:he.Ay,name:"logql"};return(0,a.jsxs)(Ie.Z,{className:d.card,children:[(0,a.jsx)(Ie.Z.Heading,{children:t.name}),(0,a.jsx)("div",{className:d.rawQueryContainer,children:(0,a.jsx)(oe.Z,{query:P.y.renderQuery({labels:[],operations:t.operations}),language:u,className:d.rawQuery})}),(0,a.jsx)(Ie.Z.Actions,{children:o!==t.name?(0,a.jsx)(D.$n,{size:"sm",onClick:()=>{r?c(t.name):s(t)},children:"Use this query"}):(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("div",{className:d.spacing,children:`If you would like to use this query, ${l?"you can either replace your current query or create a new query":"your current query will be replaced"}.`}),(0,a.jsx)(D.$n,{size:"sm",fill:"outline",onClick:()=>c(null),children:"Back"}),(0,a.jsx)(D.$n,{size:"sm",onClick:()=>{s(t)},children:"Apply to query"}),l&&(0,a.jsx)(D.$n,{size:"sm",onClick:()=>{s(t,!0)},children:"Create new query"})]})})]})},Ua=e=>({card:(0,p.css)({width:"49.5%",display:"flex",flexDirection:"column"}),rawQueryContainer:(0,p.css)({flexGrow:1}),rawQuery:(0,p.css)({backgroundColor:e.colors.background.primary,padding:e.spacing(1),marginTop:e.spacing(1)}),spacing:(0,p.css)({marginBottom:e.spacing(1)})}),za=[ee.Ln.Formats,ee.Ln.LineFilters,ee.Ln.LabelFilters],Va=[ee.EF.Unwrap],Wa=Fa.sp.filter(e=>e.category&&za.includes(e.category)&&!Va.includes(e.id)).map(e=>e.id),Ha=e=>{const{isOpen:t,onClose:s,onChange:l,onAddQuery:r,query:o,queries:c,app:d}=e,[u,g]=(0,n.useState)([]),[f,m]=(0,n.useState)(null),S=(0,w.of)(Ga),y=!!r,C=(0,n.useMemo)(()=>(0,X.u_)(o.expr).query.operations.length>0,[o.expr]),O=(E,v=!1)=>{const h=(0,X.u_)(v?"":o.expr);(0,k.rR)("grafana_loki_query_patterns_selected",{version:"v2",app:d??"",editorMode:o.editorMode,selectedPattern:E.name,preSelectedOperationsCount:h.query.operations.length,preSelectedLabelsCount:h.query.labels.length,createNewQuery:y&&v}),h.query.operations=h.query.operations.filter(x=>Wa.includes(x.id));const j=E.operations.filter(x=>h.query.operations.findIndex(N=>N.id===x.id)<0);h.query.operations=[...h.query.operations,...j],y&&v?r({...o,refId:(0,$a.M)(c??[o]),expr:P.y.renderQuery(h.query)}):l({...o,expr:P.y.renderQuery(h.query)}),m(null),s()};return(0,a.jsxs)(ze.a,{isOpen:t,title:"Kick start your query",onDismiss:s,className:S.modal,children:[(0,a.jsx)("div",{className:S.spacing,children:"Kick start your query by selecting one of these queries. You can then continue to complete your query."}),Object.values(ee.IQ).map(E=>(0,a.jsx)(st.S,{label:`${(0,I.capitalize)(E)} query starters`,isOpen:u.includes(E),collapsible:!0,onToggle:()=>g(v=>v.includes(E)?v.filter(h=>h!==E):[...v,E]),children:(0,a.jsx)("div",{className:S.cardsContainer,children:P.y.getQueryPatterns().filter(v=>v.type===E).map(v=>(0,a.jsx)(Aa,{pattern:v,hasNewQueryOption:y,hasPreviousQuery:C,onPatternSelect:O,selectedPatternName:f,setSelectedPatternName:m},v.name))})},E)),(0,a.jsx)(D.$n,{variant:"secondary",onClick:s,children:"Close"})]})},Ga=e=>({cardsContainer:(0,p.css)({display:"flex",flexDirection:"row",flexWrap:"wrap",justifyContent:"space-between"}),spacing:(0,p.css)({marginBottom:e.spacing(1)}),modal:(0,p.css)({width:"85vw",[e.breakpoints.down("md")]:{width:"100%"}})}),it="LokiQueryEditorModeDefault";function Ka(e,t,s){e.expr===""&&window.localStorage.setItem(it,t),s({...e,editorMode:t})}function Ja(e){if(e!=null&&e!=="")return V.f.Code;switch(window.localStorage.getItem(it)){case"code":return V.f.Code;case"builder":default:return V.f.Builder}}function Za(e){let t=e;return e.editorMode||(t={...e,editorMode:Ja(e.expr)}),e.expr==null&&(t={...t,expr:""}),e.queryType==null&&(t={...t,queryType:$.U3.Range}),t}var Xa=i(25229);function ct(e,t){return!e||!t?!1:(0,Xa.Ar)(e)?e.isSame(t):e===t}function Ya(e,t,s,l,r,o){return t===void 0||e.trim()!==t.trim()||r!==o?!0:!(ct(s?.raw.from,l?.raw.from)&&ct(s?.raw.to,l?.raw.to))}const Me={editor:"loki-editor"},dt="LokiQueryEditorExplainDefault",ut=(0,n.memo)(e=>{const t=(0,n.useId)(),{onChange:s,onRunQuery:l,onAddQuery:r,data:o,app:c,queries:d,datasource:u,range:g}=e,[f,m]=(0,n.useState)(!1),[S,y]=(0,n.useState)(!1),[C,O]=(0,n.useState)(!1),[E,v]=(0,n.useState)(!1),[h,j]=(0,n.useState)(null),[x,N]=(0,n.useState)(window.localStorage.getItem(dt)==="true"),b=u.predefinedOperations,T=(0,J.A)(g),L=Za(e.query);Z.$.featureToggles.lokiPredefinedOperations&&!L.expr&&b&&(L.expr=`{} ${b}`);const M=(0,J.A)(L.expr),H=(0,J.A)(L.queryType),Re=L.editorMode,ks=B=>{window.localStorage.setItem(dt,B.currentTarget.checked?"true":"false"),N(B.currentTarget.checked)},Bs=(0,n.useCallback)(B=>{if((0,k.rR)("grafana_loki_editor_mode_clicked",{newEditor:B,previousEditor:L.editorMode??"",newQuery:!L.expr,app:c??""}),B===V.f.Builder&&(0,X.u_)(L.expr||"").errors.length){m(!0);return}Ka(L,B,s)},[s,L,c]);(0,n.useEffect)(()=>{O(!1)},[o]);const $e=B=>{(0,I.isEqual)(B,e.query)||O(!0),s(B)},Ps=()=>{(0,k.rR)("grafana_loki_label_browser_opened",{app:c}),v(B=>!B)};return(0,n.useEffect)(()=>{Ya(L.expr,M,g,T,L.queryType,H)&&g&&(async()=>{const Qs=await u.getStats({...L,refId:`${t}_${L.refId}`},g);j(Qs)})()},[u,g,T,L,M,H,j,t]),(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(St.u,{isOpen:f,title:"Query parsing",body:"There were errors while trying to parse the query. Continuing to visual builder may lose some parts of the query.",confirmText:"Continue",onConfirm:()=>{s({...L,editorMode:V.f.Builder}),m(!1)},onDismiss:()=>m(!1)}),(0,a.jsx)(Ha,{isOpen:S,onClose:()=>y(!1),query:L,queries:d,app:c,onChange:s,onAddQuery:r}),(0,a.jsx)(Mt,{isOpen:E,datasource:u,query:L,app:c,onClose:()=>v(!1),onChange:$e,onRunQuery:l,timeRange:g}),(0,a.jsxs)(vt.X,{children:[(0,a.jsxs)(le.B,{gap:1,children:[(0,a.jsx)(D.$n,{"data-testid":ce.Tp.components.QueryBuilder.queryPatterns,variant:"secondary",size:"sm",onClick:()=>{y(Fe=>!Fe);const B=(0,X.u_)(L.expr||"");(0,k.rR)("grafana_loki_query_patterns_opened",{version:"v2",app:c??"",editorMode:L.editorMode,preSelectedOperationsCount:B.query.operations.length,preSelectedLabelsCount:B.query.labels.length})},children:"Kick start your query"}),(0,a.jsx)(D.$n,{variant:"secondary",size:"sm",onClick:Ps,"data-testid":"label-browser-button",children:"Label browser"})]}),(0,a.jsx)(yt,{label:"Explain query",value:x,onChange:ks}),(0,a.jsx)(ue.Z,{grow:1}),c!==z.Jk.Explore&&c!==z.Jk.Correlations&&(0,a.jsx)(D.$n,{variant:C?"primary":"secondary",size:"sm",onClick:l,icon:o?.state===ve.Gu.Loading?"spinner":void 0,disabled:o?.state===ve.Gu.Loading,children:d&&d.length>1?"Run queries":"Run query"}),(0,a.jsx)(Et,{mode:Re,onChange:Bs})]}),(0,a.jsx)(Lt.$,{v:.5}),(0,a.jsxs)(Ue.D,{children:[Re===V.f.Code&&(0,a.jsx)(Qa,{...e,query:L,onChange:$e,showExplain:x}),Re===V.f.Builder&&(0,a.jsx)(La,{datasource:e.datasource,query:L,onChange:$e,onRunQuery:e.onRunQuery,showExplain:x,timeRange:g}),(0,a.jsx)(rt,{query:L,onChange:s,onRunQuery:l,app:c,maxLines:u.maxLines,queryStats:h})]})]})});ut.displayName="LokiQueryEditor";function qa(e){const{query:t,data:s,datasource:l,onChange:r,onRunQuery:o,history:c}=e;return(0,a.jsx)(ot.W,{datasource:l,query:t,onChange:r,onRunQuery:o,history:c,data:s,placeholder:"Enter a Loki query","data-testid":_a.editor})}const _a={editor:"loki-editor-cloud-alerting"};function es(e){const{app:t}=e;switch(t){case z.Jk.CloudAlerting:return(0,a.jsx)(qa,{...e});default:return(0,a.jsx)(ut,{...e})}}const ts=(0,n.memo)(es),As={editor:"loki-editor"};var as=i(50532),ss=i(14141),ns=i(5518),rs=i(76229),ls=i(6370),os=i(80486),ke=i(3271),is=i(3936),Be=i(85480),Pe=i(44575);function cs({options:e,onOptionsChange:t}){return(0,a.jsx)(Be.I,{title:"Alerting",description:(0,a.jsx)(Pe.H,{description:"Manage alert rules for the Loki data source.",suffix:"loki/configure-loki-data-source/#alerting",feature:"alerting"}),children:(0,a.jsx)(_.I,{labelWidth:29,label:"Manage alert rules in Alerting UI",disabled:e.readOnly,tooltip:"Manage alert rules for this data source. To manage other alerting resources, add an Alertmanager data source.",children:(0,a.jsx)(de.K,{value:e.jsonData.manageAlerts!==!1,onChange:s=>t({...e,jsonData:{...e.jsonData,manageAlerts:s.currentTarget.checked}})})})})}var ds=i(38036),us=i(79609),ps=i(2863),gs=i(87105);const ms=e=>{const{derivedFields:t,className:s}=e,[l,r]=(0,n.useState)("");let o=[];return l&&t&&(o=fs(t,l)),(0,a.jsxs)("div",{className:s,children:[(0,a.jsx)(_.I,{label:"Debug log message",labelWidth:24,grow:!0,children:(0,a.jsx)(gs.f,{type:"text","aria-label":"Loki query",placeholder:"Paste an example log line here to test the regular expressions of your derived fields",value:l,onChange:c=>r(c.currentTarget.value)})}),!!o.length&&(0,a.jsx)(hs,{fields:o})]})},hs=({fields:e})=>(0,a.jsxs)("table",{className:"filter-table",children:[(0,a.jsx)("thead",{children:(0,a.jsxs)("tr",{children:[(0,a.jsx)("th",{children:"Name"}),(0,a.jsx)("th",{children:"Value"}),(0,a.jsx)("th",{children:"Url"})]})}),(0,a.jsx)("tbody",{children:e.map(t=>{let s=t.value;return t.error&&t.error instanceof Error?s=t.error.message:t.href&&(s=(0,a.jsx)("a",{href:t.href,children:s})),(0,a.jsxs)("tr",{children:[(0,a.jsx)("td",{children:t.name}),(0,a.jsx)("td",{children:s}),(0,a.jsx)("td",{children:t.href?(0,a.jsx)("a",{href:t.href,children:t.href}):""})]},`${t.name}=${t.value}`)})})]});function fs(e,t){return e.filter(s=>s.name&&s.matcherRegex).map(s=>{try{const l=t.match(s.matcherRegex);let r;const o=l&&l[1];return o&&(r=(0,ps.w)().replace(s.url,{__value:{value:{raw:o},text:"Raw value"}})),{name:s.name,value:o||"<no match>",href:r}}catch(l){return{name:s.name,error:l}}})}var vs=i(80839),W=i(37386),ys=i(81917);const xs=e=>({row:(0,p.css)({display:"flex",alignItems:"baseline"}),nameField:(0,p.css)({flex:2,marginRight:e.spacing(.5)}),regexField:(0,p.css)({flex:3,marginRight:e.spacing(.5)}),urlField:(0,p.css)({flex:1,marginRight:e.spacing(.5)}),urlDisplayLabelField:(0,p.css)({flex:1}),internalLink:(0,p.css)({marginRight:e.spacing(1)}),openNewTab:(0,p.css)({marginRight:e.spacing(1)}),dataSource:(0,p.css)({}),nameMatcherField:(0,p.css)({width:e.spacing(20),marginRight:e.spacing(.5)})}),bs=e=>{const{value:t,onChange:s,onDelete:l,suggestions:r,className:o,validateName:c}=e,d=(0,w.of)(xs),[u,g]=(0,n.useState)(!!t.datasourceUid),[f,m]=(0,n.useState)(!!t.targetBlank),S=(0,J.A)(t.datasourceUid),[y,C]=(0,n.useState)(t.matcherType??"regex");(0,n.useEffect)(()=>{!S&&t.datasourceUid&&!u&&g(!0),S&&!t.datasourceUid&&u&&g(!1)},[S,t.datasourceUid,u]);const O=v=>h=>{s({...t,[v]:h.currentTarget.value})},E=!c(t.name);return(0,a.jsxs)("div",{className:o,"data-testid":"derived-field",children:[(0,a.jsxs)("div",{className:"gf-form",children:[(0,a.jsx)(W.D,{className:d.nameField,label:"Name",invalid:E,error:"The name is already in use",children:(0,a.jsx)(ae.p,{value:t.name,onChange:O("name"),placeholder:"Field name",invalid:E})}),(0,a.jsx)(W.D,{className:d.nameMatcherField,label:(0,a.jsx)(fe,{label:"Type",content:"Derived fields can be created from labels or by applying a regular expression to the log message."}),children:(0,a.jsx)(K.l6,{options:[{label:"Regex in log line",value:"regex"},{label:"Label",value:"label"}],value:y,onChange:v=>{(v.value==="label"||v.value==="regex")&&(C(v.value),s({...t,matcherType:v.value}))}})}),(0,a.jsx)(W.D,{className:d.regexField,label:(0,a.jsxs)(a.Fragment,{children:[y==="regex"&&(0,a.jsx)(fe,{label:"Regex",content:"Use to parse and capture some part of the log message. You can use the captured groups in the template."}),y==="label"&&(0,a.jsx)(fe,{label:"Label",content:"Use to derive the field from a label."})]}),children:(0,a.jsx)(ae.p,{value:t.matcherRegex,onChange:O("matcherRegex")})}),(0,a.jsx)(W.D,{label:"",children:(0,a.jsx)(D.$n,{variant:"destructive",title:"Remove field",icon:"times",onClick:v=>{v.preventDefault(),l()}})})]}),(0,a.jsxs)("div",{className:"gf-form",children:[(0,a.jsx)(W.D,{label:u?"Query":"URL",className:d.urlField,children:(0,a.jsx)(ys.l,{placeholder:u?"${__value.raw}":"http://example.com/${__value.raw}",value:t.url||"",onChange:v=>s({...t,url:v}),suggestions:r})}),(0,a.jsx)(W.D,{className:d.urlDisplayLabelField,label:(0,a.jsx)(fe,{label:"URL Label",content:"Use to override the button label when this derived field is found in a log."}),children:(0,a.jsx)(ae.p,{value:t.urlDisplayLabel,onChange:O("urlDisplayLabel")})})]}),(0,a.jsxs)("div",{className:"gf-form",children:[(0,a.jsx)(W.D,{label:"Internal link",className:d.internalLink,children:(0,a.jsx)(de.d,{value:u,onChange:v=>{const{checked:h}=v.currentTarget;h||s({...t,datasourceUid:void 0}),g(h)}})}),u&&(0,a.jsx)(W.D,{label:"",className:d.dataSource,children:(0,a.jsx)(vs.s,{tracing:!0,onChange:v=>s({...t,datasourceUid:v.uid}),current:t.datasourceUid,noDefault:!0})})]}),(0,a.jsx)("div",{className:"gf-form",children:(0,a.jsx)(W.D,{label:"Open in new tab",className:d.openNewTab,children:(0,a.jsx)(de.d,{value:f,onChange:v=>{const{checked:h}=v.currentTarget;s({...t,targetBlank:h}),m(h)}})})})]})},fe=({content:e,label:t})=>(0,a.jsxs)(pe.J,{children:[t,(0,a.jsx)(ge.m,{placement:"top",content:e,theme:"info",children:(0,a.jsx)(Oe.I,{tabIndex:0,name:"info-circle",size:"sm",style:{marginLeft:"10px"}})})]}),Es=e=>({addButton:(0,p.css)({marginRight:"10px"}),derivedField:(0,p.css)({marginBottom:e.spacing(1)}),container:(0,p.css)({marginBottom:e.spacing(4)}),debugSection:(0,p.css)({marginTop:e.spacing(4)})}),Ss=({fields:e=[],onChange:t})=>{const s=(0,w.$j)(),l=Es(s),[r,o]=(0,n.useState)(!1),c=(0,n.useCallback)(d=>e.filter(u=>u.name&&u.name===d).length<=1,[e]);return(0,a.jsx)(Be.I,{title:"Derived fields",description:(0,a.jsx)(Pe.H,{description:"Derived fields can be used to extract new fields from a log message and create a link from its value.",suffix:"loki/configure-loki-data-source/#derived-fields",feature:"derived fields"}),children:(0,a.jsxs)("div",{className:l.container,children:[e.map((d,u)=>(0,a.jsx)(bs,{className:l.derivedField,value:d,onChange:g=>{const f=[...e];f.splice(u,1,g),t(f)},onDelete:()=>{const g=[...e];g.splice(u,1),t(g)},validateName:c,suggestions:[{value:ds.c.valueRaw,label:"Raw value",documentation:"Exact string captured by the regular expression",origin:us.$0.Value}]},u)),(0,a.jsxs)("div",{children:[(0,a.jsx)(D.$n,{variant:"secondary",className:l.addButton,icon:"plus",onClick:d=>{d.preventDefault();const u={name:"",matcherRegex:"",urlDisplayLabel:"",url:"",matcherType:"regex"},g=[...e,u];t(g)},children:"Add"}),e.length>0&&(0,a.jsx)(D.$n,{variant:"secondary",type:"button",onClick:()=>o(!r),children:r?"Hide example log message":"Show example log message"})]}),r&&(0,a.jsx)("div",{className:l.debugSection,children:(0,a.jsx)(ms,{className:(0,p.css)({marginBottom:"10px"}),derivedFields:e})})]})})};var Ls=i(97095),js=i(99887);const Cs=e=>{const{maxLines:t,onMaxLinedChange:s,predefinedOperations:l,onPredefinedOperationsChange:r}=e;return(0,a.jsxs)(Be.I,{title:"Queries",description:(0,a.jsx)(Pe.H,{description:"Additional options to customize your querying experience.",suffix:"loki/configure-loki-data-source/#queries",feature:"query settings"}),children:[(0,a.jsx)(_.I,{label:"Maximum lines",htmlFor:"loki_config_maxLines",labelWidth:22,tooltip:(0,a.jsx)(a.Fragment,{children:"Loki queries must contain a limit of the maximum number of lines returned (default: 1000). Increase this limit to have a bigger result set for ad-hoc analysis. Decrease this limit if your browser becomes sluggish when displaying the log results."}),children:(0,a.jsx)(ae.p,{type:"number",id:"loki_config_maxLines",value:t,onChange:o=>s(o.currentTarget.value),width:16,placeholder:"1000",spellCheck:!1})}),Z.$.featureToggles.lokiPredefinedOperations&&(0,a.jsxs)(Ls.C,{children:[(0,a.jsx)(_.I,{label:"Predefined operations",htmlFor:"loki_config_predefinedOperations",labelWidth:22,tooltip:(0,a.jsx)(a.Fragment,{children:'Predefined operations are used as an initial state for your queries. They are useful, if you want to unpack, parse or format all log lines. Currently we support only log operations starting with |. For example: | unpack | line_format "{{.message}}".'}),children:(0,a.jsx)(ae.p,{type:"string",id:"loki_config_predefinedOperations",value:l,onChange:o=>r(o.currentTarget.value),width:40,placeholder:"| unpack | line_format",spellCheck:!1})}),(0,a.jsx)(_.I,{children:(0,a.jsx)(js.E,{text:"Experimental",color:"orange",icon:"exclamation-triangle",tooltip:"Predefined operations is an experimental feature that may change in the future."})})]})]})},Qe=e=>(t,s)=>({...t,jsonData:{...t.jsonData,[e]:s}}),Os=Qe("maxLines"),Ns=Qe("predefinedOperations"),Ts=Qe("derivedFields"),Ds=e=>{const{options:t,onOptionsChange:s}=e,l=(0,n.useCallback)(r=>{(0,k.rR)("grafana_loki_predefined_operations_changed",{value:r}),s(Ns(t,r))},[t,s]);return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(as.I,{dataSourceName:"Loki",docsLink:"https://grafana.com/docs/grafana/latest/datasources/loki/configure-loki-data-source/",hasRequiredFields:!1}),(0,a.jsx)(ke.c,{spacing:4}),(0,a.jsx)(ss.u,{config:t,onChange:s,urlPlaceholder:"http://localhost:3100"}),(0,a.jsx)(ke.c,{spacing:4}),(0,a.jsx)(ns.N,{...(0,rs.pe)({config:t,onChange:s})}),(0,a.jsx)(ke.c,{spacing:4}),(0,a.jsx)(ls.A,{title:"Additional settings",description:"Additional settings are optional settings that can be configured for more control over your data source.",isCollapsible:!0,isInitiallyOpen:!0,children:(0,a.jsxs)(le.B,{gap:5,direction:"column",children:[(0,a.jsx)(os.g,{config:t,onChange:s}),Z.$.secureSocksDSProxyEnabled&&(0,a.jsx)(is.Y,{options:t,onOptionsChange:s}),(0,a.jsx)(cs,{options:t,onOptionsChange:s}),(0,a.jsx)(Cs,{maxLines:t.jsonData.maxLines||"",onMaxLinedChange:r=>s(Os(t,r)),predefinedOperations:t.jsonData.predefinedOperations||"",onPredefinedOperationsChange:l}),(0,a.jsx)(Ss,{fields:t.jsonData.derivedFields,onChange:r=>s(Ts(t,r))})]})})]})};var ws=i(76484),Is=i(47126);const Ms=new A.tD(ws.VQ).setQueryEditor(ts).setConfigEditor(Ds).setQueryEditorHelp(ft);(0,U.J7)().subscribe(R.gc,Is.jg)},44575:(ie,F,i)=>{i.d(F,{H:()=>a});var A=i(22803),R=i(96540),U=i(63142);function a(I){const{description:n,suffix:k,feature:w}=I,Q=`Learn more about ${w}`,re=(0,U.of)(p);return R.createElement("span",{className:re.container},n,R.createElement("a",{"aria-label":Q,href:`https://grafana.com/docs/grafana/next/datasources/${k}`,rel:"noreferrer",target:"_blank"},Q))}const p=I=>({container:(0,A.css)({color:I.colors.text.secondary,a:(0,A.css)({color:I.colors.text.link,textDecoration:"underline",marginLeft:"5px","&:hover":{textDecoration:"none"}})})})},6904:(ie,F,i)=>{i.d(F,{X:()=>a});var A=i(22803),R=i(96540),U=i(63142);const a=({children:I})=>{const n=(0,U.of)(p);return R.createElement("div",{className:n.root},I)},p=I=>({root:(0,A.css)({display:"flex",flexWrap:"wrap",alignItems:"center",gap:I.spacing(3),minHeight:I.spacing(4)})})},40263:(ie,F,i)=>{i.d(F,{Z:()=>R});var A=i(96540);const R=({grow:U,shrink:a})=>A.createElement("div",{style:{display:"block",flexGrow:U,flexShrink:a}})},62955:(ie,F,i)=>{i.d(F,{i:()=>k});var A=i(22803),R=i(96540),U=i(63142),a=i(2543),p=i(46936),I=i(70713),n=i(27633);function k({children:Q}){const re=(0,U.of)(w);return R.createElement("div",{className:re.root},R.createElement(p.C,{gap:1},Q))}const w=Q=>({root:(0,A.css)({padding:Q.spacing(1,1,0,1),backgroundColor:Q.colors.background.secondary,borderRadius:Q.shape.radius.default})})}}]);

//# sourceMappingURL=3273.5c07cd8b2e7d440d5743.js.map