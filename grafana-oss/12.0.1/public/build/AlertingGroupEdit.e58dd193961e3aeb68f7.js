"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[6102],{12266:(X,T,a)=>{a.d(T,{e:()=>I});var e=a(74848),f=a(45861);const I=({isCollapsed:h,onToggle:M,idControlled:O,className:G,text:A,size:B="xl",...S})=>(0,e.jsx)(f.$n,{type:"button",fill:"text",variant:"secondary","aria-expanded":!h,"aria-controls":O,className:G,icon:h?"angle-right":"angle-down",onClick:()=>M(!h),...S,children:A})},25521:(X,T,a)=>{a.d(T,{G:()=>B});var e=a(74848),f=a(22803),I=a(63142),h=a(59243),M=a(41654),O=a(30703),G=a(66404),A=a(56840);function B({contentText:D,externalLink:x,linkText:E,title:F="Need help?"}){const w=(0,I.of)(S);return(0,e.jsx)(h.G,{content:(0,e.jsx)("div",{className:w.mutedText,children:D}),title:(0,e.jsxs)(M.B,{gap:.5,direction:"row",alignItems:"center",children:[(0,e.jsx)(O.I,{name:"question-circle"}),F]}),footer:x?(0,e.jsx)("a",{href:x,target:"_blank",rel:"noreferrer",children:(0,e.jsx)(M.B,{direction:"row",gap:.5,alignItems:"center",children:(0,e.jsxs)(G.E,{color:"link",children:[E," ",(0,e.jsx)(O.I,{size:"sm",name:"external-link-alt"})]})})}):void 0,closeButton:!0,placement:"bottom-start",children:(0,e.jsx)("div",{className:w.helpInfo,children:(0,e.jsxs)(M.B,{direction:"row",alignItems:"center",gap:.5,children:[(0,e.jsx)(O.I,{name:"question-circle",size:"sm"}),(0,e.jsx)(G.E,{variant:"bodySmall",color:"primary",children:(0,e.jsx)(A.x6,{i18nKey:"alerting.need-help-info.need-help",children:"Need help?"})})]})})})}const S=D=>({mutedText:(0,f.css)({color:D.colors.text.secondary,fontSize:D.typography.size.sm}),helpInfo:(0,f.css)({cursor:"pointer",textDecoration:"underline"})})},58872:(X,T,a)=>{a.d(T,{P:()=>S});var e=a(74848),f=a(22803),I=a(85629),h=a(63142),M=a(16780),O=a(41654),G=a(66404),A=a(21285),B=a(56840);const S=({title:x,stepNo:E,children:F,fullWidth:w=!1,description:V,switchMode:W})=>{const i=(0,h.of)(D),H=I.Tp.components.AlertRules;return(0,e.jsx)("div",{className:i.parent,"data-testid":H.step(E.toString()),children:(0,e.jsx)(M.n,{className:(0,f.cx)(w&&i.fullWidth),label:(0,e.jsxs)(O.B,{direction:"row",alignItems:"center",justifyContent:"space-between",children:[(0,e.jsxs)(G.E,{variant:"h3",children:[E,". ",x]}),W&&(0,e.jsx)(G.E,{variant:"bodySmall",children:(0,e.jsx)(A.K,{"data-testid":H.stepAdvancedModeSwitch(E.toString()),value:W.isAdvancedMode,onChange:k=>{W.setAdvancedMode(k.currentTarget.checked)},label:(0,B.t)("alerting.rule-editor-section.label-advanced-options","Advanced options"),showLabel:!0,transparent:!0,className:i.reverse})})]}),children:(0,e.jsxs)(O.B,{direction:"column",children:[V&&(0,e.jsx)("div",{className:i.description,children:V}),F]})})})},D=x=>({parent:(0,f.css)({display:"flex",flexDirection:"row",border:`solid 1px ${x.colors.border.weak}`,borderRadius:x.shape.radius.default,padding:`${x.spacing(2)} ${x.spacing(3)}`}),description:(0,f.css)({marginTop:`-${x.spacing(2)}`}),fullWidth:(0,f.css)({width:"100%"}),reverse:(0,f.css)({flexDirection:"row-reverse",gap:x.spacing(1)})})},56638:(X,T,a)=>{a.r(T),a.d(T,{default:()=>Ae});var e=a(74848),f=a(22803),I=a(1932),h=a(96540),M=a(49785),O=a(54148),G=a(36490),A=a(34999),B=a(36303),S=a(63142),D=a(37386),x=a(63527),E=a(41654),F=a(45861),w=a(71599),V=a(1506),W=a(64762),i=a(56840),H=a(96673),k=a(86791),te=a(74268),U=a(70327),re=a(55143),ne=a(36826),de=a(44351),pe=a(8535),ge=a(11018),Q=a(80218),oe=a(71639);const{useDeleteRuleGroupFromNamespaceMutation:me}=U.hK,{useLazyDiscoverDsFeaturesQuery:fe}=re.L;function ve(){const[n]=me(),[r]=fe();return(0,Q.Yb)(async o=>{const{dataSourceName:s,namespaceName:u,groupName:l}=o,{rulerConfig:p}=await r({rulesSourceName:s}).unwrap();if(!p)throw(0,oe._)(s);const c=await n({rulerConfig:p,namespace:u,group:l}).unwrap();return await(0,pe.JD)((0,ge.Lc)({rulesSourceName:s})),c})}var he=a(62939),z=a(96137),xe=a(52161);const se=()=>t("alerting.rule-groups.update.success","Successfully updated rule group");function Re(){const[n]=(0,oe.D)(),[r]=U.hK.endpoints.getRuleGroupForNamespace.useLazyQuery(),[o]=U.hK.endpoints.upsertRuleGroupForNamespace.useMutation(),[s]=U.hK.endpoints.deleteRuleGroupFromNamespace.useMutation();return(0,Q.Yb)(async(u,l)=>{const p=[],c=(0,xe.z2)(u.dataSourceName);if(l.namespaceName){if(c)throw new Error("Moving a Grafana-managed rule group to another folder is currently not supported.");p.push((0,z.fO)({newNamespaceName:l.namespaceName}))}l.groupName&&p.push((0,z.KL)({groupName:l.groupName})),l.interval&&p.push((0,z.lF)({interval:l.interval})),l.ruleSwaps&&p.push((0,z.bw)({swaps:l.ruleSwaps}));const{newRuleGroupDefinition:g,rulerConfig:d}=await n(u,p),v=u.namespaceName,m=l.namespaceName??v,N=u.groupName,R=g.name,j=v!==m,y=N!==R;if(R&&y&&(await r({rulerConfig:d,namespace:m,group:R,notificationOptions:{showErrorAlert:!1}}).unwrap().catch(he.R))?.rules?.length)throw new Error("Target group already has rules, merging rule groups is currently not supported.");await o({rulerConfig:d,namespace:m,payload:g,notificationOptions:{showSuccessAlert:!1}}).unwrap();const K=d.dataSourceName==="grafana"?{groupName:R,namespace:{uid:m},groupOrigin:"grafana"}:{groupName:R,namespace:{name:m},groupOrigin:"datasource",rulesSource:{uid:d.dataSourceUid,name:d.dataSourceName,ruleSourceType:"datasource"}};return(j||y)&&!c&&await s({rulerConfig:d,namespace:v,group:N,notificationOptions:{showSuccessAlert:!1}}).unwrap().catch(P=>{(0,te.vV)(P)}),K})}function We(){const[n]=useProduceNewRuleGroup(),[r]=alertRuleApi.endpoints.upsertRuleGroupForNamespace.useMutation();return useAsync(async(o,s)=>{const{namespaceName:u}=o,l=updateRuleGroupAction({interval:s}),{newRuleGroupDefinition:p,rulerConfig:c}=await n(o,[l]);return r({rulerConfig:c,namespace:u,payload:p,notificationOptions:{successMessage:se()}}).unwrap()})}function Ue(){const[n]=useProduceNewRuleGroup(),[r]=alertRuleApi.endpoints.getRuleGroupForNamespace.useLazyQuery(),[o]=alertRuleApi.endpoints.upsertRuleGroupForNamespace.useMutation(),[s]=alertRuleApi.endpoints.deleteRuleGroupFromNamespace.useMutation(),u=t("alerting.rule-groups.move.success","Successfully moved rule group");return useAsync(async(l,p,c,g)=>{if(isGrafanaRulesSource(l.dataSourceName))throw new Error("Moving a Grafana-managed rule group to another folder is currently not supported.");const d=moveRuleGroupAction({newNamespaceName:p,groupName:c,interval:g}),{newRuleGroupDefinition:v,rulerConfig:m}=await n(l,[d]),N=l.namespaceName,R=d.payload.newNamespaceName,j=l.groupName,y=d.payload.groupName;if(y&&(!!y&&j!==y)&&(await r({rulerConfig:m,namespace:R,group:y,notificationOptions:{showErrorAlert:!1}}).unwrap().catch(notFoundToNullOrThrow))?.rules?.length)throw new Error("Target group already has rules, merging rule groups is currently not supported.");return await o({rulerConfig:m,namespace:R,payload:v,notificationOptions:{successMessage:u}}).unwrap(),await s({rulerConfig:m,namespace:N,group:j,notificationOptions:{showSuccessAlert:!1}}).unwrap()})}function ze(){const[n]=useProduceNewRuleGroup(),[r]=alertRuleApi.endpoints.getRuleGroupForNamespace.useLazyQuery(),[o]=alertRuleApi.endpoints.upsertRuleGroupForNamespace.useMutation(),[s]=alertRuleApi.endpoints.deleteRuleGroupFromNamespace.useMutation();return useAsync(async(u,l,p)=>{const c=renameRuleGroupAction({groupName:l,interval:p}),{newRuleGroupDefinition:g,rulerConfig:d}=await n(u,[c]),v=u.groupName,m=c.payload.groupName,N=u.namespaceName,R=t("alerting.rule-groups.rename.success","Successfully renamed rule group");if((await r({rulerConfig:d,namespace:N,group:m,notificationOptions:{showErrorAlert:!1}}).unwrap().catch(notFoundToNullOrThrow))?.rules?.length)throw new Error("Target group has existing rules, merging rule groups is currently not supported.");const y=await o({rulerConfig:d,namespace:N,payload:g,notificationOptions:{successMessage:R}}).unwrap();return await s({rulerConfig:d,namespace:N,group:v,notificationOptions:{showSuccessAlert:!1}}).unwrap(),y})}function be(){const[n]=useProduceNewRuleGroup(),[r]=alertRuleApi.endpoints.upsertRuleGroupForNamespace.useMutation();return useAsync(async(o,s)=>{const{namespaceName:u}=o,l=reorderRulesInRuleGroupAction({swaps:s}),{newRuleGroupDefinition:p,rulerConfig:c}=await n(o,[l]);return r({rulerConfig:c,namespace:u,payload:p,notificationOptions:{successMessage:se()}}).unwrap()})}var ie=a(18404),Ne=a(80276),ye=a(39187),Ee=a(84523),le=a(67598),q=a(77256),b=a(29442),_=a(57095),De=a(30703),je=a(99887),Ge=a(94646),J=a(29609);function Oe({rules:n,groupInterval:r,onSwap:o}){const s=(0,S.of)(ee),[u,l]=(0,h.useState)(n),p=(0,h.useCallback)(g=>{if(!g.destination)return;const d=[g.source.index,g.destination.index];o(d);const v=(0,I.jM)(u,m=>{(0,z.Ct)(m,d)});l(v)},[u,o]),c=(0,h.useMemo)(()=>u.map(g=>({...g,uid:(0,Ge.Ns)(g)})),[u]);return(0,e.jsxs)("div",{children:[(0,e.jsx)(ce,{ruleName:(0,i.t)("alerting.draggable-rules-table.rule-name","Rule name"),pendingPeriod:(0,i.t)("alerting.draggable-rules-table.pending-period","Pending period"),evalsToStartAlerting:(0,i.t)("alerting.draggable-rules-table.evals-to-start-alerting","Evaluations to start alerting"),className:s.listHeader}),(0,e.jsx)(_.DragDropContext,{onDragEnd:p,children:(0,e.jsx)(_.Droppable,{droppableId:"alert-list",mode:"standard",renderClone:(g,d,v)=>(0,e.jsx)(ue,{provided:g,rule:c[v.source.index],isClone:!0,groupInterval:r}),children:g=>(0,e.jsxs)(E.B,{direction:"column",gap:0,ref:g.innerRef,...g.droppableProps,children:[c.map((d,v)=>(0,e.jsx)(_.Draggable,{draggableId:d.uid,index:v,isDragDisabled:!1,children:m=>(0,e.jsx)(ue,{provided:m,rule:d,groupInterval:r},d.uid)},d.uid)),g.placeholder]})})})]})}const ue=({provided:n,rule:r,groupInterval:o,isClone:s=!1})=>{const u=(0,S.of)(ee),l=(0,J.qz)(r),p=J.p.any.alertingRule(r)?r.for:null,c=(0,J.O9)(p??"0s",o),g=J.p.any.recordingRule(r);return(0,e.jsx)(ce,{dragHandle:(0,e.jsx)(De.I,{name:"draggabledots"}),ruleName:l,pendingPeriod:p,evalsToStartAlerting:g?(0,e.jsx)(je.E,{text:(0,i.t)("alerting.draggable-rules-table.recording","Recording"),color:"purple"}):c,"data-testid":"reorder-alert-rule",className:(0,f.cx)(u.listItem,{[u.listItemClone]:s}),ref:n.innerRef,...n.draggableProps,...n.dragHandleProps})},ce=(0,h.forwardRef)(({dragHandle:n,ruleName:r,pendingPeriod:o,evalsToStartAlerting:s,className:u,...l},p)=>{const c=(0,S.of)(ee);return(0,e.jsxs)("div",{className:(0,f.cx)(c.listItem,u),ref:p,...l,children:[(0,e.jsx)(E.B,{flex:"0 0 24px",children:n}),(0,e.jsx)(E.B,{flex:1,children:r}),(0,e.jsx)(E.B,{basis:"30%",children:o}),(0,e.jsx)(E.B,{basis:"30%",children:s})]})}),ee=n=>({listItem:(0,f.css)({display:"flex",flexDirection:"row",alignItems:"center",gap:n.spacing(1),padding:`${n.spacing(1)} ${n.spacing(2)}`,"&:nth-child(even)":{background:n.colors.background.secondary}}),listItemClone:(0,f.css)({border:`solid 1px ${n.colors.primary.shade}`}),listHeader:(0,f.css)({fontWeight:n.typography.fontWeightBold,borderBottom:`1px solid ${n.colors.border.weak}`})});var Se=a(76944);const{useDiscoverDsFeaturesQuery:Pe}=re.L;function Me(){const n=(0,H.useDispatch)(),{dataSourceUid:r="",namespaceId:o="",groupName:s=""}=(0,O.g)(),{folder:u,loading:l}=(0,ie.a)(r==="grafana"?o:""),p=r==="grafana"?k.l$:r,{data:c,isLoading:g,error:d}=Pe({uid:p}),[v,m]=(0,Q.Yb)(async $=>n(U.hK.endpoints.getRuleGroupForNamespace.initiate({rulerConfig:$,namespace:o,group:s})).unwrap());(0,h.useEffect)(()=>{o&&s&&c?.rulerConfig&&v.execute(c.rulerConfig)},[o,s,c?.rulerConfig,v]);const N=l||g||(0,Q.VP)(m),{result:R,error:j}=m,y={text:(0,i.t)("alerting.group-edit.page-title","Edit rule group"),parentItem:{text:u?.title??o,url:(0,b.tx)([["namespace",u?.title??o],["group",s]])}};if(c&&!c.rulerConfig)return(0,e.jsx)(ne.d,{pageNav:y,title:s,navId:"alert-list",isLoading:N,children:(0,e.jsx)(A.F,{title:(0,i.t)("alerting.group-edit.group-not-editable","Selected group cannot be edited"),children:(0,e.jsx)(i.x6,{i18nKey:"alerting.group-edit.group-not-editable-description",children:"This group belongs to a data source that does not support editing."})})});const K=r==="grafana"?{namespace:{uid:o},groupName:s,groupOrigin:"grafana"}:{rulesSource:{uid:r,name:c?.name??"",ruleSourceType:"datasource"},namespace:{name:o},groupName:s,groupOrigin:"datasource"};return(0,e.jsxs)(ne.d,{pageNav:y,title:(0,i.t)("alerting.group-edit.title","Edit evaluation group"),navId:"alert-list",isLoading:N,children:[(0,e.jsxs)(e.Fragment,{children:[!!d&&(0,e.jsx)(A.F,{title:(0,i.t)("alerting.group-edit.ds-error","Error loading data source details"),bottomSpacing:0,topSpacing:2,children:(0,e.jsx)("div",{children:(0,q.JZ)(d)})}),!!j&&(0,e.jsx)(A.F,{title:(0,i.t)("alerting.group-edit.rule-group-error","Error loading rule group"),bottomSpacing:0,topSpacing:2,children:(0,q.JZ)(j)})]}),R&&(0,e.jsx)(Ce,{rulerGroup:R,groupIdentifier:K}),!R&&(0,e.jsx)(V.L,{entity:`${o}/${s}`})]})}const Ae=(0,B.Xc)(Me,{style:"page"});function Ce({rulerGroup:n,groupIdentifier:r}){const o=(0,S.of)(Te),s=(0,W._2)(),{returnTo:u}=(0,ye.h)(b.TN.detailsPageLinkFromGroupIdentifier(r)),{folder:l}=(0,ie.a)(r.groupOrigin==="grafana"?r.namespace.uid:""),{waitForGroupConsistency:p}=(0,Ne.zx)(),[c]=Re(),[g]=ve(),[d,v]=(0,h.useState)([]),[m,N]=(0,h.useState)(!1),R=n?.interval??Ee.T6,{register:j,handleSubmit:y,getValues:K,setValue:$,formState:{errors:P,dirtyFields:ae,isSubmitting:Y}}=(0,M.mN)({mode:"onBlur",shouldFocusError:!0,defaultValues:{name:n.name,interval:n.interval,namespace:r.groupOrigin==="datasource"?r.namespace.name:void 0}}),Le=(0,h.useCallback)(L=>{v(C=>(0,I.jM)(C,Z=>{Z.push(L)}))},[]),Be=async L=>{try{const C={namespaceName:ae.namespace?L.namespace:void 0,groupName:ae.name?L.name:void 0,interval:ae.interval?L.interval:void 0,ruleSwaps:d.length?d:void 0},Z=await c.execute((0,le.Rc)(r),C);(!!C.namespaceName||!!C.groupName)&&await p(Z);const Ke=(0,i.t)("alerting.group-edit.form.update-success","Successfully updated the rule group");s.success(Ke),Ie(Z)}catch(C){(0,te.vV)(C instanceof Error?C:new Error("Failed to update rule group")),s.error((0,i.t)("alerting.group-edit.form.update-error","Failed to update rule group"),(0,q.JZ)(C))}},we=async()=>{await g.execute((0,le.Rc)(r)),await p(r),Fe()};return(0,e.jsxs)(e.Fragment,{children:[(0,e.jsxs)("form",{onSubmit:y(Be),children:[r.groupOrigin==="datasource"&&(0,e.jsx)(D.D,{label:(0,i.t)("alerting.group-edit.form.namespace-label","Namespace"),required:!0,invalid:!!P.namespace,error:P.namespace?.message,className:o.input,children:(0,e.jsx)(x.p,{id:"namespace",...j("namespace",{required:(0,i.t)("alerting.group-edit.form.namespace-required","Namespace is required")})})}),r.groupOrigin==="grafana"&&(0,e.jsx)(D.D,{label:(0,i.t)("alerting.group-edit.form.folder-label","Folder"),required:!0,children:(0,e.jsx)(x.p,{id:"folder",value:l?.title??"",readOnly:!0})}),(0,e.jsx)(D.D,{label:(0,i.t)("alerting.group-edit.form.group-name-label","Evaluation group name"),required:!0,invalid:!!P.name,error:P.name?.message,className:o.input,children:(0,e.jsx)(x.p,{id:"group-name",...j("name",{required:(0,i.t)("alerting.group-edit.form.group-name-required","Group name is required")})})}),(0,e.jsx)(D.D,{label:(0,i.t)("alerting.group-edit.form.interval-label","Evaluation interval"),description:(0,i.t)("alerting.group-edit.form.interval-description","How often is the group evaluated"),invalid:!!P.interval,error:P.interval?.message,className:o.input,htmlFor:"interval",children:(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)(x.p,{id:"interval",...j("interval",(0,Se.i)(n.rules)),className:o.intervalInput}),(0,e.jsx)(de.gv,{currentInterval:K("interval"),onSelect:L=>$("interval",L,{shouldValidate:!0,shouldDirty:!0})})]})}),(0,e.jsx)(D.D,{label:(0,i.t)("alerting.group-edit.form.rules-label","Alerting and recording rules"),description:(0,i.t)("alerting.group-edit.form.rules-description","Drag rules to reorder"),children:(0,e.jsx)(Oe,{rules:n.rules,groupInterval:R,onSwap:Le})}),(0,e.jsxs)(E.B,{children:[(0,e.jsx)(F.$n,{type:"submit",disabled:Y,icon:Y?"spinner":void 0,children:(0,e.jsx)(i.x6,{i18nKey:"alerting.group-edit.form.save",children:"Save"})}),(0,e.jsx)(F.z9,{variant:"secondary",disabled:Y,href:u,children:(0,e.jsx)(i.x6,{i18nKey:"alerting.common.cancel",children:"Cancel"})})]})]}),r.groupOrigin==="datasource"&&(0,e.jsxs)(E.B,{direction:"row",justifyContent:"flex-end",children:[(0,e.jsx)(F.$n,{type:"button",variant:"destructive",onClick:()=>N(!0),disabled:Y,children:(0,e.jsx)(i.x6,{i18nKey:"alerting.group-edit.form.delete",children:"Delete"})}),(0,e.jsx)(w.u,{isOpen:m,title:(0,i.t)("alerting.group-edit.form.delete-title","Delete rule group"),body:(0,i.t)("alerting.group-edit.form.delete-body","Are you sure you want to delete this rule group?"),confirmText:(0,i.t)("alerting.group-edit.form.delete-confirm","Delete"),onConfirm:we,onDismiss:()=>N(!1)})]})]})}const Te=n=>({intervalInput:(0,f.css)({marginBottom:n.spacing(.5)}),input:(0,f.css)({maxWidth:"600px"})});function Ie(n){if(n.groupOrigin==="datasource"){const{rulesSource:r,namespace:o,groupName:s}=n;G.Ny.replace(b.TN.editPageLink(r.uid,o.name,s,{skipSubPath:!0}))}else{const{namespace:r,groupName:o}=n;G.Ny.replace(b.TN.editPageLink("grafana",r.uid,o,{skipSubPath:!0}))}}function Fe(){G.Ny.replace((0,b.Mo)(void 0,{skipSubPath:!0}))}}}]);

//# sourceMappingURL=AlertingGroupEdit.e58dd193961e3aeb68f7.js.map