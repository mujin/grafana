"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[5592],{83813:(q,C,t)=>{t.d(C,{F:()=>L});var e=t(74848),d=t(22803),S=t(96540),m=t(54148),D=t(22787),E=t(45861),v=t(56840),_=t(83560);const L=({confirmRedirect:r,onDiscard:p,onLocationChange:u})=>{const[g,P]=(0,S.useState)(!1),[F,x]=(0,S.useState)(null),[B,ee]=(0,S.useState)(!1);(0,S.useEffect)(()=>{const V=$=>{r&&($.preventDefault(),$.returnValue="")};return window.addEventListener("beforeunload",V),()=>{window.removeEventListener("beforeunload",V)}},[r]);const ge=V=>{const $=window.location.pathname,b=V.pathname;if($===b)return!0;const te=u?.(V);let H=r&&!B;return te!==void 0&&(H=H&&te),H?(P(!0),x(V),!1):(te&&p(),!0)},G=()=>{P(!1),x(null)},ve=()=>{P(!1),ee(!0),p()};return(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)(_.X,{when:!0,message:ge}),F&&B&&(0,e.jsx)(m.C5,{replace:!0,to:F}),(0,e.jsx)(M,{isOpen:g,onDiscard:ve,onBackToForm:G})]})},M=({onDiscard:r,onBackToForm:p,isOpen:u})=>(0,e.jsxs)(D.a,{isOpen:u,title:(0,v.t)("form-prompt.title","Leave page?"),onDismiss:p,icon:"exclamation-triangle",className:(0,d.css)({width:"500px"}),children:[(0,e.jsx)("h5",{children:(0,e.jsx)(v.x6,{i18nKey:"form-prompt.description",children:"Changes that you made may not be saved."})}),(0,e.jsxs)(D.a.ButtonRow,{children:[(0,e.jsx)(E.$n,{variant:"secondary",onClick:p,fill:"outline",children:(0,e.jsx)(v.x6,{i18nKey:"form-prompt.continue-button",children:"Continue editing"})}),(0,e.jsx)(E.$n,{variant:"destructive",onClick:r,children:(0,e.jsx)(v.x6,{i18nKey:"form-prompt.discard-button",children:"Discard unsaved changes"})})]})]})},83560:(q,C,t)=>{t.d(C,{X:()=>S});var e=t(96540),d=t(36490);const S=({message:m,when:D=!0})=>{const E=d.Ny.getHistory();return(0,e.useEffect)(()=>{if(!D)return;const v=E.block(m);return()=>{v()}},[D,m,E]),null}},53953:(q,C,t)=>{t.r(C),t.d(C,{AuthConfigPageUnconnected:()=>J,default:()=>Se});var e=t(74848),d=t(96540),S=t(71468),m=t(41607),D=t(27489),E=t(89640),v=t(7895),_=t(13943),L=t(13791),M=t(65642),r=t(56840),p=t(22803),u=t(63142),g=t(8207),P=t(66404),F=t(21285),x=t(45861),B=t(64762),ee=t(35991);const ge=l=>({allowInsecureEmail:l.authConfig.settings?.auth?.oauth_allow_insecure_email_lookup.toLowerCase()==="true"}),G={loadSettings:ee.M5,saveSettings:ee.DZ},$=(0,S.connect)(ge,G)(({allowInsecureEmail:l,loadSettings:U,onClose:K,saveSettings:T})=>{const k=(0,B._2)(),Y=async()=>{try{await T({updates:{auth:{oauth_allow_insecure_email_lookup:""+!l}}}),await U(!1),k.success("Settings saved")}catch{k.error("Failed to save settings")}},ie=async()=>{try{await T({removals:{auth:["oauth_allow_insecure_email_lookup"]}}),await U(!1),k.success("Settings saved")}catch{k.error("Failed to save settings")}},Z=(0,e.jsxs)(r.x6,{i18nKey:"auth-config.auth-drawer-unconneced.subtitle",children:["Configure auth settings. Find out more in our"," ",(0,e.jsx)(E.Y,{external:!0,href:"https://grafana.com/docs/grafana/next/setup-grafana/configure-security/configure-authentication/#settings",children:"documentation"}),"."]}),fe=(0,u.of)(b);return(0,e.jsxs)(g._,{title:(0,r.t)("auth-config.auth-drawer-unconnected.title-auth-settings","Auth settings"),subtitle:Z,size:"md",onClose:K,children:[(0,e.jsxs)("div",{className:fe.advancedAuth,children:[(0,e.jsx)(P.E,{variant:"h4",children:(0,e.jsx)(r.x6,{i18nKey:"auth-config.auth-drawer-unconnected.advanced-auth",children:"Advanced Auth"})}),(0,e.jsx)(P.E,{variant:"h5",children:(0,e.jsx)(r.x6,{i18nKey:"auth-config.auth-drawer-unconnected.enable-insecure-email-lookup",children:"Enable insecure email lookup"})}),(0,e.jsx)(P.E,{variant:"body",color:"secondary",children:(0,e.jsx)(r.x6,{i18nKey:"auth-config.auth-drawer-unconnected.enable-insecure-email-lookup-description",children:"Allow users to use the same email address to log into Grafana with different identity providers."})}),(0,e.jsx)(F.d,{value:l,onChange:Y})]}),(0,e.jsx)(x.$n,{size:"md",variant:"secondary",className:fe.button,onClick:ie,tooltip:(0,r.t)("auth-config.auth-drawer-unconnected.reset-tooltip","This action will disregard any saved changes and load the configuration from the configuration file."),children:(0,e.jsx)(r.x6,{i18nKey:"auth-config.auth-drawer-unconnected.reset",children:"Reset"})})]})}),b=l=>({advancedAuth:(0,p.css)({display:"flex",flexDirection:"column",gap:l.spacing(1)}),button:(0,p.css)({marginTop:l.spacing(2)})});var te=t(41654),H=t(30703);const Te=()=>{const l=(0,u.of)(xe);return(0,e.jsxs)("div",{className:l.container,children:[(0,e.jsxs)(te.B,{gap:1,alignItems:"center",children:[(0,e.jsx)(H.I,{name:"cog"}),(0,e.jsx)(P.E,{children:(0,e.jsx)(r.x6,{i18nKey:"auth-config.configure-auth-cta.configuration-required",children:"Configuration required"})})]}),(0,e.jsx)(P.E,{variant:"bodySmall",color:"secondary",children:(0,e.jsx)(r.x6,{i18nKey:"auth-config.configure-auth-cta.authentication-configuration-created-moment",children:"You have no authentication configuration created at the moment."})}),(0,e.jsx)(E.Y,{href:"https://grafana.com/docs/grafana/latest/auth/overview/",external:!0,children:(0,e.jsx)(r.x6,{i18nKey:"auth-config.configure-auth-cta.refer-documentation-configure-authentication",children:"Refer to the documentation on how to configure authentication"})})]})},xe=l=>({container:(0,p.css)({display:"flex",flexDirection:"column",gap:l.spacing(2),backgroundColor:l.colors.background.secondary,borderRadius:l.shape.radius.default,padding:l.spacing(3),width:"max-content",margin:l.spacing(3,"auto")})}),De=Te;var Ee=t(30360),ne=t(8073),be=t(99887),me=t(22011),Ae=t(74997);function pe({providerId:l,enabled:U,configPath:K,authType:T,onClick:k}){const Y=(0,Ae.h)({configPath:K,id:l}),[ie,Z]=me.L[l]||["lock",l.toUpperCase()];return(0,e.jsxs)(ne.Z,{href:Y,onClick:k,children:[(0,e.jsx)(ne.Z.Heading,{children:Z}),(0,e.jsx)(ne.Z.Meta,{children:T}),(0,Ee.n6)(ie)&&(0,e.jsx)(ne.Z.Figure,{children:(0,e.jsx)(H.I,{name:ie,size:"xxxl"})}),(0,e.jsx)(ne.Z.Actions,{children:(0,e.jsx)(be.E,{text:U?"Enabled":"Not enabled",color:U?"green":"blue"})})]})}var Ce=t(69874);function ae(l){const{isLoading:U,providerStatuses:K,providers:T}=l.authConfig;return{isLoading:U,providerStatuses:K,providers:T}}const Oe={loadSettings:ee.M5},Ue=(0,S.connect)(ae,Oe),J=({providerStatuses:l,isLoading:U,loadSettings:K,providers:T})=>{(0,d.useEffect)(()=>{K()},[K]);const[k,Y]=(0,d.useState)(!1),Z=(0,Ce.getRegisteredAuthProviders)().filter(y=>!l[y.id]?.hide),fe=(y,z)=>{(0,D.rR)("authentication_ui_provider_clicked",{provider:y,enabled:z})};T=T.filter(y=>y.provider!=="saml"),T=T.map(y=>y.provider==="ldap"?{...y,settings:{...y.settings,type:"LDAP"}}:y);const oe=Z.length?[...Z.map(y=>({provider:y.id,settings:{...l[y.id],configPath:y.configPath,type:y.type}})),...T]:T;return(0,e.jsx)(L.Y,{navId:"authentication",subTitle:(0,e.jsxs)(r.x6,{i18nKey:"auth-config-auth-config-page-unconnected.subtitle",children:["Manage your auth settings and configure single sign-on. Find out more in our"," ",(0,e.jsx)(E.Y,{external:!0,href:"https://grafana.com/docs/grafana/next/setup-grafana/configure-security/configure-authentication",children:"documentation"}),"."]}),actions:M.$W.buildInfo.edition!==m.r.OpenSource&&(0,e.jsx)(v.I,{icon:"cog",variant:"canvas",onClick:()=>Y(!0),children:(0,e.jsx)(r.x6,{i18nKey:"auth-config.auth-config-page-unconnected.auth-settings",children:"Auth settings"})}),children:(0,e.jsx)(L.Y.Contents,{isLoading:U,children:oe.length?(0,e.jsxs)(_.x,{gap:3,minColumnWidth:34,children:[oe.filter(({provider:y})=>!["grafana_com"].includes(y)).map(({provider:y,settings:z})=>(0,e.jsx)(pe,{authType:z.type||"OAuth",providerId:y,enabled:z.enabled,onClick:()=>fe(y,z.enabled),configPath:z.configPath},y)),k&&(0,e.jsx)($,{onClose:()=>Y(!1)})]}):(0,e.jsx)(De,{})})})},Se=Ue(J)},81172:(q,C,t)=>{t.r(C),t.d(C,{ProviderConfigPage:()=>Ge,default:()=>Fe});var e=t(74848),d=t(96540),S=t(54148),m=t(41654),D=t(66404),E=t(99887),v=t(13791),_=t(86678),L=t(96673),M=t(49785),r=t(32899),p=t(75234),u=t(68143),g=t(27489),P=t(36490),F=t(87063),x=t(37386),B=t(21285),ee=t(74475),ge=t(31286),G=t(45861),ve=t(88559),V=t(76319),$=t(71599),b=t(56840),te=t(83813),H=t(22803),Te=t(63142),xe=t(63527),De=t(48767),Ee=t(18857),ne=t(32635),be=t(41391),me=t(43173),Ae=t(89640),pe=t(73427),Ce=t(22787),ae=t(74997);const Oe=({isOpen:a,onClose:n,onSuccess:o,isLoading:i})=>{const{handleSubmit:f,register:A,formState:{errors:h}}=(0,M.mN)({mode:"onBlur",defaultValues:{url:""}}),I=O=>O===""?"Please enter the .well-known/openid-configuration endpoint for your IdP":(0,ae.K)(O)?!0:"Please enter a valid URL";return(0,e.jsx)(Ce.a,{title:(0,b.t)("auth-config.server-discovery-modal.title-open-id-connect-discovery-url","OpenID Connect Discovery URL"),onDismiss:n,onClickBackdrop:n,isOpen:a,children:(0,e.jsxs)("form",{onSubmit:O=>(O.stopPropagation(),f(o)(O)),children:[(0,e.jsx)(x.D,{label:(0,b.t)("auth-config.server-discovery-modal.label-the-wellknownopenidconfiguration-endpoint-for-your-id-p","The .well-known/openid-configuration endpoint for your IdP"),invalid:!!h.url,error:h.url?.message,htmlFor:"url",children:(0,e.jsx)(xe.p,{...A("url",{validate:I}),width:80,id:"url"})}),(0,e.jsxs)(Ce.a.ButtonRow,{children:[(0,e.jsx)(G.$n,{type:"submit",variant:"primary",disabled:i,children:i?(0,e.jsx)(b.x6,{i18nKey:"oauth.form.server-discovery-modal-loading",children:"Loading..."}):(0,e.jsx)(b.x6,{i18nKey:"oauth.form.server-discovery-modal-submit",children:"Submit"})}),(0,e.jsx)(G.$n,{type:"button",variant:"secondary",onClick:n,children:(0,e.jsx)(b.x6,{i18nKey:"oauth.form.server-discovery-modal-close",children:"Close"})})]})]})})},Ue=({setValue:a})=>{const n=(0,p.J7)(),[o,i]=(0,d.useState)(!1),[f,A]=(0,d.useState)(!1),h=()=>i(!1),I=async O=>{A(!0);try{const se="/.well-known/openid-configuration",he=new URL(O.url);he.pathname.includes(se)||(O.url=he.origin+se);const N=await(0,u.AI)().get(O.url);if(!N.token_endpoint||!N.authorization_endpoint){n.publish({type:r.r1.alertWarning.name,payload:["The URL provided is not a valid .well-known/openid-configuration endpoint"]});return}a("tokenUrl",N.token_endpoint),a("authUrl",N.authorization_endpoint),N.userinfo_endpoint&&a("apiUrl",N.userinfo_endpoint),n.publish({type:r.r1.alertSuccess.name,payload:["OpenID Connect Discovery URL has been successfully fetched."]})}catch{n.publish({type:r.r1.alertWarning.name,payload:["Failed to fetch URL or invalid content"]})}finally{h(),A(!1)}};return(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)(G.$n,{type:"button",variant:"secondary",onClick:()=>{i(!0)},children:(0,e.jsx)(b.x6,{i18nKey:"oauth.form.server-discovery-action-button",children:"Enter OpenID Connect Discovery URL"})}),(0,e.jsx)(Oe,{isOpen:o,onClose:h,onSuccess:I,isLoading:f})]})};function J(a){return Array.isArray(a)&&a.every(n=>typeof n=="object"&&n!==null&&"value"in n)}const Se={azuread:[{name:"General settings",id:"general",fields:["name","clientAuthentication","clientId","clientSecret","managedIdentityClientId","federatedCredentialAudience","scopes","authUrl","tokenUrl","allowSignUp","autoLogin","signoutRedirectUrl"]},{name:"User mapping",id:"user",fields:["roleAttributeStrict","orgMapping","allowAssignGrafanaAdmin","skipOrgRoleSync"]},{name:"Extra security measures",id:"extra",fields:["allowedOrganizations","allowedDomains","allowedGroups","forceUseGraphApi","usePkce","useRefreshToken","tlsSkipVerifyInsecure","tlsClientCert","tlsClientKey","tlsClientCa"]}],generic_oauth:[{name:"General settings",id:"general",fields:["name","clientId","clientSecret","authStyle","scopes","serverDiscoveryUrl","authUrl","tokenUrl","apiUrl","allowSignUp","autoLogin","signoutRedirectUrl"]},{name:"User mapping",id:"user",fields:["nameAttributePath","loginAttributePath","emailAttributeName","emailAttributePath","idTokenAttributeName","roleAttributePath","roleAttributeStrict","orgMapping","orgAttributePath","allowAssignGrafanaAdmin","skipOrgRoleSync"]},{name:"Extra security measures",id:"extra",fields:["allowedOrganizations","allowedDomains","defineAllowedGroups",{name:"allowedGroups",dependsOn:"defineAllowedGroups"},{name:"groupsAttributePath",dependsOn:"defineAllowedGroups"},"defineAllowedTeamsIds",{name:"teamIds",dependsOn:"defineAllowedTeamsIds"},{name:"teamsUrl",dependsOn:"defineAllowedTeamsIds"},{name:"teamIdsAttributePath",dependsOn:"defineAllowedTeamsIds"},"usePkce","useRefreshToken","tlsSkipVerifyInsecure","tlsClientCert","tlsClientKey","tlsClientCa"]}],google:[{name:"General settings",id:"general",fields:["name","clientId","clientSecret","scopes","allowSignUp","autoLogin","signoutRedirectUrl"]},{name:"User mapping",id:"user",fields:["roleAttributePath","roleAttributeStrict","orgMapping","allowAssignGrafanaAdmin","skipOrgRoleSync"]},{name:"Extra security measures",id:"extra",fields:["validateHd","hostedDomain","allowedDomains","allowedGroups","usePkce","useRefreshToken","tlsSkipVerifyInsecure","tlsClientCert","tlsClientKey","tlsClientCa"]}],github:[{name:"General settings",id:"general",fields:["name","clientId","clientSecret","scopes","allowSignUp","autoLogin","signoutRedirectUrl"]},{name:"User mapping",id:"user",fields:["roleAttributePath","roleAttributeStrict","orgMapping","allowAssignGrafanaAdmin","skipOrgRoleSync"]},{name:"Extra security measures",id:"extra",fields:["allowedOrganizations","allowedDomains","teamIds","usePkce","useRefreshToken","tlsSkipVerifyInsecure","tlsClientCert","tlsClientKey","tlsClientCa"]}],gitlab:[{name:"General settings",id:"general",fields:["name","clientId","clientSecret","scopes","allowSignUp","autoLogin","signoutRedirectUrl"]},{name:"User mapping",id:"user",fields:["roleAttributePath","roleAttributeStrict","orgMapping","allowAssignGrafanaAdmin","skipOrgRoleSync"]},{name:"Extra security measures",id:"extra",fields:["allowedDomains","allowedGroups","usePkce","useRefreshToken","tlsSkipVerifyInsecure","tlsClientCert","tlsClientKey","tlsClientCa"]}],okta:[{name:"General settings",id:"general",fields:["name","clientId","clientSecret","scopes","authUrl","tokenUrl","apiUrl","allowSignUp","autoLogin","signoutRedirectUrl"]},{name:"User mapping",id:"user",fields:["roleAttributePath","roleAttributeStrict","orgMapping","orgAttributePath","allowAssignGrafanaAdmin","skipOrgRoleSync"]},{name:"Extra security measures",id:"extra",fields:["allowedDomains","allowedGroups","usePkce","useRefreshToken","tlsSkipVerifyInsecure","tlsClientCert","tlsClientKey","tlsClientCa"]}]};function l(a){return{clientAuthentication:{label:"Client authentication",type:"select",description:"The client authentication method used to authenticate to the token endpoint.",multi:!1,options:T(a),defaultValue:{value:"none",label:"None"},validation:{required:!0,message:"This field is required"}},clientId:{label:"Client Id",type:"text",description:"The client Id of your OAuth2 app.",validation:{required:!0,message:"This field is required"}},clientSecret:{label:"Client secret",type:"secret",description:"The client secret of your OAuth2 app."},managedIdentityClientId:{label:"FIC managed identity client Id",type:"text",description:"The managed identity client Id of the federated identity credential of your OAuth2 app."},federatedCredentialAudience:{label:"FIC audience",type:"text",description:"The audience of the federated identity credential of your OAuth2 app."},allowedOrganizations:{label:"Allowed organizations",type:"select",description:`List of comma- or space-separated organizations. The user should be a member 
of at least one organization to log in.`,multi:!0,allowCustomValue:!0,options:[],placeholder:"Enter organizations (my-team, myteam...) and press Enter to add"},allowedDomains:{label:"Allowed domains",type:"select",description:`List of comma- or space-separated domains. The user should belong to at least 
one domain to log in.`,multi:!0,allowCustomValue:!0,options:[]},authUrl:{label:"Auth URL",type:"text",description:"The authorization endpoint of your OAuth2 provider.",validation:{required:!0,validate:n=>(0,ae.K)(n),message:"This field is required and must be a valid URL."}},authStyle:{label:"Auth style",type:"select",description:"It determines how client_id and client_secret are sent to Oauth2 provider. Default is AutoDetect.",multi:!1,options:[{value:"AutoDetect",label:"AutoDetect"},{value:"InParams",label:"InParams"},{value:"InHeader",label:"InHeader"}],defaultValue:{value:"AutoDetect",label:"AutoDetect"}},tokenUrl:{label:"Token URL",type:"text",description:"The token endpoint of your OAuth2 provider.",validation:{required:!0,validate:n=>(0,ae.K)(n),message:"This field is required and must be a valid URL."}},scopes:{label:"Scopes",type:"select",description:"List of comma- or space-separated OAuth2 scopes.",multi:!0,allowCustomValue:!0,options:[]},allowedGroups:{label:"Allowed groups",type:"select",description:(0,e.jsxs)(e.Fragment,{children:["List of comma- or space-separated groups. The user should be a member of at least one group to log in."," ",a==="generic_oauth"&&"If you configure allowed_groups, you must also configure groups_attribute_path."]}),multi:!0,allowCustomValue:!0,options:[],validation:a==="azuread"?{validate:n=>typeof n=="string"?(0,be.A)(n):J(n)?n.every(o=>o?.value&&(0,be.A)(o.value)):!0,message:"Allowed groups must be Object Ids."}:void 0},apiUrl:{label:"API URL",type:"text",description:(0,e.jsxs)(e.Fragment,{children:["The user information endpoint of your OAuth2 provider. Information returned by this endpoint must be compatible with"," ",(0,e.jsx)(Ae.Y,{href:"https://connect2id.com/products/server/docs/api/userinfo",external:!0,variant:"bodySmall",children:"OpenID UserInfo"}),"."]}),validation:{required:!1,validate:n=>typeof n!="string"?!1:n.length?(0,ae.K)(n):!0,message:"This field must be a valid URL if set."}},roleAttributePath:{label:"Role attribute path",description:"JMESPath expression to use for Grafana role lookup.",type:"text",validation:{required:!1}},name:{label:"Display name",description:'Will be displayed on the login page as "Sign in with ...". Helpful if you use more than one identity providers or SSO protocols.',type:"text"},allowSignUp:{label:"Allow sign up",description:"If not enabled, only existing Grafana users can log in using OAuth.",type:"switch"},autoLogin:{label:"Auto login",description:"Log in automatically, skipping the login screen.",type:"switch"},signoutRedirectUrl:{label:"Sign out redirect URL",description:"The URL to redirect the user to after signing out from Grafana.",type:"text",validation:{required:!1}},emailAttributeName:{label:"Email attribute name",description:"Name of the key to use for user email lookup within the attributes map of OAuth2 ID token.",type:"text"},emailAttributePath:{label:"Email attribute path",description:"JMESPath expression to use for user email lookup from the user information.",type:"text"},nameAttributePath:{label:"Name attribute path",description:`JMESPath expression to use for user name lookup from the user ID token. 
This name will be used as the user\u2019s display name.`,type:"text"},loginAttributePath:{label:"Login attribute path",description:"JMESPath expression to use for user login lookup from the user ID token.",type:"text"},idTokenAttributeName:{label:"ID token attribute name",description:"The name of the key used to extract the ID token from the returned OAuth2 token.",type:"text"},roleAttributeStrict:{label:"Role attribute strict mode",description:"If enabled, denies user login if the Grafana role cannot be extracted using Role attribute path.",type:"switch"},allowAssignGrafanaAdmin:{label:"Allow assign Grafana admin",description:"If enabled, it will automatically sync the Grafana server administrator role.",type:"switch",hidden:!pe.TP.isGrafanaAdmin},skipOrgRoleSync:{label:"Skip organization role sync",description:"Prevent synchronizing users\u2019 organization roles from your IdP.",type:"switch"},orgMapping:{label:"Organization mapping",description:K(a),type:"select",hidden:!pe.TP.isGrafanaAdmin,multi:!0,allowCustomValue:!0,options:[],placeholder:"Enter mappings (my-team:1:Viewer...) and press Enter to add"},orgAttributePath:{label:"Organization attribute path",description:"JMESPath expression to use for organization lookup.",type:"text",hidden:!(["generic_oauth","okta"].includes(a)&&pe.TP.isGrafanaAdmin)},defineAllowedGroups:{label:"Define allowed groups",type:"switch"},defineAllowedTeamsIds:{label:"Define allowed teams ids",type:"switch"},forceUseGraphApi:{label:"Force use Graph API",description:"If enabled, Grafana will fetch the users' groups using the Microsoft Graph API.",type:"checkbox"},usePkce:{label:"Use PKCE",description:(0,e.jsxs)(e.Fragment,{children:["If enabled, Grafana will use"," ",(0,e.jsx)(Ae.Y,{external:!0,variant:"bodySmall",href:"https://datatracker.ietf.org/doc/html/rfc7636",children:"Proof Key for Code Exchange (PKCE)"})," ","with the OAuth2 Authorization Code Grant."]}),type:"checkbox"},useRefreshToken:{label:"Use refresh token",description:"If enabled, Grafana will fetch a new access token using the refresh token provided by the OAuth2 provider.",type:"checkbox"},tlsClientCa:{label:"TLS client ca",description:"The file path to the trusted certificate authority list. Is not applicable on Grafana Cloud.",type:"text",hidden:!me.$.localFileSystemAvailable},tlsClientCert:{label:"TLS client cert",description:"The file path to the certificate. Is not applicable on Grafana Cloud.",type:"text",hidden:!me.$.localFileSystemAvailable},tlsClientKey:{label:"TLS client key",description:"The file path to the key. Is not applicable on Grafana Cloud.",type:"text",hidden:!me.$.localFileSystemAvailable},tlsSkipVerifyInsecure:{label:"TLS skip verify",description:`If enabled, the client accepts any certificate presented by the server and any host 
name in that certificate. You should only use this for testing, because this mode leaves 
SSL/TLS susceptible to man-in-the-middle attacks.`,type:"switch"},groupsAttributePath:{label:"Groups attribute path",description:`JMESPath expression to use for user group lookup. If you configure allowed_groups, 
you must also configure groups_attribute_path.`,type:"text"},teamsUrl:{label:"Teams URL",description:(0,e.jsxs)(e.Fragment,{children:["The URL used to query for Team Ids. If not set, the default value is /teams."," ",a==="generic_oauth"&&"If you configure teams_url, you must also configure team_ids_attribute_path."]}),type:"text",validation:{validate:(n,o)=>{let i=!0;return o.teamIds.length&&(i=!!n),typeof n=="string"&&n.length&&(i=(0,ae.K)(n)),i},message:"This field must be set if Team Ids are configured and must be a valid URL."}},teamIdsAttributePath:{label:"Team Ids attribute path",description:"The JMESPath expression to use for Grafana Team Id lookup within the results returned by the teams_url endpoint.",type:"text",validation:{validate:(n,o)=>o.teamIds.length?!!n:!0,message:"This field must be set if Team Ids are configured."}},teamIds:{label:"Team Ids",type:"select",description:(0,e.jsxs)(e.Fragment,{children:[a==="github"?"Integer":"String"," list of Team Ids. If set, the user must be a member of one of the given teams to log in."," ",a==="generic_oauth"&&"If you configure team_ids, you must also configure teams_url and team_ids_attribute_path."]}),multi:!0,allowCustomValue:!0,options:[],placeholder:"Enter Team Ids and press Enter to add",validation:a==="github"?{validate:n=>typeof n=="string"?U(n):J(n)?n.every(o=>o?.value&&U(o.value)):!0,message:"Team Ids must be numbers."}:void 0},hostedDomain:{label:"Hosted domain",description:"The domain under which Grafana is hosted and accessible.",type:"text"},validateHd:{label:"Validate hosted domain",description:"If enabled, Grafana will match the Hosted Domain retrieved from the Google ID Token against the Allowed Domains list specified by the user.",type:"checkbox"},serverDiscoveryUrl:{label:"OpenID Connect Discovery URL",description:"The .well-known/openid-configuration endpoint for your IdP. The info extracted from this URL will be used to populate the Auth URL, Token URL and API URL fields.",type:"custom",content:n=>(0,e.jsx)(Ue,{setValue:n})}}}function U(a){return/^-?\d+$/.test(a)}function K(a){switch(a){case"azuread":return'List of "<GroupID>:<OrgIdOrName>:<Role>" mappings.';case"github":return'List of "<GitHubTeamName>:<OrgIdOrName>:<Role>" mappings.';case"gitlab":return'List of "<GitlabGroupName>:<OrgIdOrName>:<Role>';case"google":return'List of "<GoogleGroupName>:<OrgIdOrName>:<Role>';default:return'List of "<ExternalName>:<OrgIdOrName>:<Role>" mappings.'}}function T(a){switch(a){case"azuread":return[{value:"none",label:"None"},{value:"client_secret_post",label:"Client secret"},{value:"managed_identity",label:"Managed identity"}];default:return[{value:"none",label:"None"},{value:"client_secret_post",label:"Client secret"}]}}const k=({field:a,register:n,errors:o,watch:i,setValue:f,getValues:A,control:h,unregister:I,secretConfigured:O,provider:se})=>{const[he,N]=(0,d.useState)(O),re=typeof a!="string",s=re?a.name:a,le=re?i(a.dependsOn):null,c=l(se)[s],Re=(0,Te.$j)();(0,d.useEffect)(()=>{re&&(le||I(s))},[I,s,le,re]);const Ie=R=>Array.isArray(R)&&R.length>0&&"value"in R[0];if((0,d.useEffect)(()=>{if(c.defaultValue){const R=A(s),de=c.options?.find(ue=>ue.value===(Ie(R)?R[0].value:void 0));f(s,de?.value||c.defaultValue.value)}},[]),!a)return console.log("missing field:",s),null;if(c.hidden||re&&!i(a.dependsOn))return null;const X={label:c.label,required:!!c.validation?.required,invalid:!!o[s],error:c.validation?.message,description:c.description,defaultValue:c.defaultValue?.value};switch(c.type){case"text":return(0,e.jsx)(x.D,{...X,children:(0,e.jsx)(xe.p,{...n(s,c.validation),type:c.type,id:s,autoComplete:"off"})},s);case"secret":return(0,e.jsx)(x.D,{...X,htmlFor:s,children:(0,e.jsx)(M.xI,{name:s,control:h,rules:c.validation,render:({field:{ref:ue,value:ce,...ye}})=>(0,e.jsx)(De.L4,{...ye,autoComplete:"off",id:s,value:typeof ce=="string"?ce:"",isConfigured:he,onReset:()=>{N(!1),f(s,"")}})})},s);case"select":const R=i(s);let de=c.options;return c.options?.length||(de=J(R)?R:[]),(0,e.jsx)(x.D,{...X,htmlFor:s,children:(0,e.jsx)(M.xI,{rules:c.validation,name:s,control:h,render:({field:{ref:ue,onChange:ce,...ye},fieldState:{invalid:we}})=>(0,e.jsx)(Ee.l6,{...ye,placeholder:c.placeholder,isMulti:c.multi,invalid:we,inputId:s,options:de,allowCustomValue:!!c.allowCustomValue,defaultValue:c.defaultValue,onChange:ce,onCreateOption:W=>{const je={value:W,label:W};ce([...de||[],je])}})})},s);case"switch":return(0,e.jsx)(x.D,{...X,children:(0,e.jsx)(B.d,{...n(s),id:s})},s);case"checkbox":return(0,e.jsx)(ne.S,{...n(s),id:s,...X,className:(0,H.css)({marginBottom:Re.spacing(2)})},s);case"custom":return(0,e.jsx)(x.D,{...X,children:c.content?c.content(f):(0,e.jsx)(e.Fragment,{})},s);default:return console.error(`Unknown field type: ${c.type}`),null}},Y={allowAssignGrafanaAdmin:!1,allowSignUp:!1,allowedDomains:[],allowedGroups:[],allowedOrganizations:[],apiUrl:"",authStyle:"",authUrl:"",autoLogin:!1,clientAuthentication:"",clientId:"",clientSecret:"",managedIdentityClientId:"",federatedCredentialAudience:"",emailAttributeName:"",emailAttributePath:"",emptyScopes:!1,enabled:!1,extra:{},groupsAttributePath:"",hostedDomain:"",icon:"shield",name:"",roleAttributePath:"",roleAttributeStrict:!1,scopes:[],signoutRedirectUrl:"",skipOrgRoleSync:!1,teamIds:[],teamIdsAttributePath:"",teamsUrl:"",tlsClientCa:"",tlsClientCert:"",tlsClientKey:"",tlsSkipVerify:!1,tokenUrl:"",type:"",usePkce:!1,useRefreshToken:!1},ie=a=>{if(!a?.length)return[];if(Array.isArray(a))return a.map(n=>({label:n,value:n}));if(a.startsWith("[")&&a.endsWith("]"))try{return JSON.parse(a).map(n=>({label:n,value:n}))}catch{}return a.split(/[\s,]/).map(n=>({label:n,value:n}))};function Z(a){if(!a)return Y;const n=oe(a.provider),o=z(l(a.provider),n),i={...a.settings};for(const f of o)i[f]=ie(i[f]);return i}const fe=a=>JSON.stringify(a.map(({value:n})=>n)),oe=a=>{const n=Se[a],o=["enabled"];return Object.values(n).reduce((i,f)=>[...i,...f.fields.map(A=>typeof A=="string"?A:A.name)],o)};function y(a,n){let o=a;const i=oe(n),f=z(l(n),i),A=Object.keys(o).filter(h=>i.includes(h)).reduce((h,I)=>({...h,[I]:o[I]}),{});for(const h of f){const I=o[h];I&&(J(I)?A[h]=fe(I):J([I])&&(A[h]=I.value))}return A}function z(a,n){return Object.entries(a).filter(([o,i])=>n.includes(o)&&i.type==="select").map(([o])=>o)}const Pe=(0,p.J7)(),Ke=({config:a,provider:n,isLoading:o})=>{const{register:i,handleSubmit:f,control:A,reset:h,watch:I,setValue:O,getValues:se,unregister:he,formState:{errors:N,dirtyFields:re,isSubmitted:s}}=(0,M.mN)({defaultValues:Z(a),mode:"onSubmit",reValidateMode:"onChange"}),[le,c]=(0,d.useState)(!1),[Re,Ie]=(0,d.useState)(!1),X=s&&!Re,R=Se[n],[de,ue]=(0,d.useState)(!1),ce=(0,e.jsx)(F.W,{children:(0,e.jsx)(F.W.Item,{label:(0,b.t)("auth-config.provider-config-form.additional-actions-menu.label-reset-to-default-values","Reset to default values"),icon:"history-alt",onClick:()=>{ue(!0)}})}),ye=async j=>{c(!0),Ie(!1);const Q=y(j,n);try{await(0,u.AI)().put(`/api/v1/sso-settings/${n}`,{id:a?.id,provider:a?.provider,settings:{...Q}},{showErrorAlert:!1}),(0,g.rR)("grafana_authentication_ssosettings_saved",{provider:n,enabled:Q.enabled}),Pe.publish({type:r.r1.alertSuccess.name,payload:["Settings saved"]}),h(j),setTimeout(()=>{P.Ny.push("/admin/authentication")},300)}catch(w){let Le="";(0,u.NF)(w)?Le=w.data.message:w instanceof Error&&(Le=w.message),Pe.publish({type:r.r1.alertError.name,payload:[Le]}),Ie(!0),c(!1)}},we=async()=>{try{await(0,u.AI)().delete(`/api/v1/sso-settings/${n}`,void 0,{showSuccessAlert:!1}),(0,g.rR)("grafana_authentication_ssosettings_removed",{provider:n}),Pe.publish({type:r.r1.alertSuccess.name,payload:["Settings reset to defaults"]}),setTimeout(()=>{P.Ny.push("/admin/authentication")})}catch(j){let Q="";(0,u.NF)(j)?Q=j.data.message:j instanceof Error&&(Q=j.message),Pe.publish({type:r.r1.alertError.name,payload:[Q]})}},W=a?.settings.enabled,je=j=>{(0,g.rR)("grafana_authentication_ssosettings_save_attempt",{provider:n,enabled:j?!W:W}),j&&O("enabled",!W)};return(0,e.jsxs)(v.Y.Contents,{isLoading:o,children:[(0,e.jsxs)("form",{onSubmit:f(ye),style:{maxWidth:"600px"},children:[(0,e.jsx)(te.F,{confirmRedirect:!!Object.keys(re).length&&!X,onDiscard:()=>{(0,g.rR)("grafana_authentication_ssosettings_abandoned",{provider:n}),h()}}),(0,e.jsx)(x.D,{label:(0,b.t)("auth-config.provider-config-form.label-enabled","Enabled"),hidden:!0,children:(0,e.jsx)(B.d,{...i("enabled"),id:"enabled",label:(0,b.t)("auth-config.provider-config-form.enabled-label-enabled","Enabled")})}),(0,e.jsx)(m.B,{gap:2,direction:"column",children:R.filter(j=>!j.hidden).map((j,Q)=>(0,e.jsx)(ee.M,{label:j.name,isOpen:Q===0,children:j.fields.filter(w=>typeof w!="string"?!w.hidden:!0).map(w=>(0,e.jsx)(k,{field:w,control:A,errors:N,setValue:O,getValues:se,register:i,watch:I,unregister:he,provider:n,secretConfigured:!!a?.settings.clientSecret},typeof w=="string"?w:w.name))},j.name))}),(0,e.jsx)(ge.a,{display:"flex",gap:2,marginTop:5,children:(0,e.jsxs)(m.B,{alignItems:"center",gap:2,children:[(0,e.jsx)(G.$n,{type:"submit",disabled:le,onClick:()=>je(!0),variant:W?"secondary":void 0,children:le?W?"Disabling...":"Saving...":W?"Disable":"Save and enable"}),(0,e.jsx)(G.$n,{type:"submit",disabled:le,variant:"secondary",onClick:()=>je(!1),children:le?"Saving...":"Save"}),(0,e.jsx)(G.z9,{href:"/admin/authentication",variant:"secondary",children:(0,e.jsx)(b.x6,{i18nKey:"auth-config.provider-config-form.discard",children:"Discard"})}),(0,e.jsx)(ve.m,{overlay:ce,placement:"bottom-start",children:(0,e.jsx)(V.K,{tooltip:(0,b.t)("auth-config.provider-config-form.tooltip-more-actions","More actions"),title:(0,b.t)("auth-config.provider-config-form.title-more-actions","More actions"),tooltipPlacement:"top",size:"md",variant:"secondary",name:"ellipsis-v",hidden:a?.source==="system"})})]})})]}),de&&(0,e.jsx)($.u,{isOpen:!0,icon:"trash-alt",title:(0,b.t)("auth-config.provider-config-form.title-reset","Reset"),body:(0,e.jsxs)(m.B,{direction:"column",gap:3,children:[(0,e.jsx)("span",{children:(0,e.jsx)(b.x6,{i18nKey:"auth-config.provider-config-form.reset-configuration",children:"Are you sure you want to reset this configuration?"})}),(0,e.jsx)("small",{children:(0,e.jsx)(b.x6,{i18nKey:"auth-config.provider-config-form.reset-configuration-description",children:"After resetting these settings Grafana will use the provider configuration from the system (config file/environment variables) if any."})})]}),confirmText:"Reset",onDismiss:()=>ue(!1),onConfirm:async()=>{await we(),ue(!1)}})]})};var Me=t(22011),ke=t(35991);const Ne=a=>{if(!a)return{text:"Authentication",subTitle:"Configure authentication providers",icon:"shield",id:"authentication"};const n=Me.L[a.provider][1]||a.provider.toUpperCase();return{text:n||"",subTitle:`To configure ${n} OAuth2 you must register your application with ${n}. The provider will generate a Client ID and Client Secret for you to use.`,icon:a.settings.icon||"shield",id:a.provider}},Ge=()=>{const a=(0,L.useDispatch)(),{isLoading:n,providers:o}=(0,L.useSelector)(h=>h.authConfig),{provider:i=""}=(0,S.g)(),f=o.find(h=>h.provider===i);if((0,d.useEffect)(()=>{a((0,ke.TD)(i))},[a,i]),!f||!f.provider||!Me.L[f.provider])return(0,e.jsx)(_.H,{});const A=Ne(f);return(0,e.jsx)(v.Y,{navId:"authentication",pageNav:A,renderTitle:h=>(0,e.jsxs)(m.B,{gap:2,alignItems:"center",children:[(0,e.jsx)(D.E,{variant:"h1",children:h}),(0,e.jsx)(E.E,{text:f.settings.enabled?"Enabled":"Not enabled",color:f.settings.enabled?"green":"blue",icon:f.settings.enabled?"check":void 0})]}),children:(0,e.jsx)(Ke,{config:f,isLoading:n,provider:i})})},Fe=Ge},22011:(q,C,t)=>{t.d(C,{L:()=>d,o:()=>e});const e="admin/authentication/",d={github:["github","GitHub"],gitlab:["gitlab","GitLab"],google:["google","Google"],generic_oauth:["lock","Generic OAuth"],grafana_com:["grafana","Grafana.com"],azuread:["microsoft","Azure AD"],okta:["okta","Okta"]}},35991:(q,C,t)=>{t.d(C,{DZ:()=>r,M5:()=>_,TD:()=>L});var e=t(75505),d=t(68143),S=t(43173),m=t(73427),D=t(96673),E=t(69874),v=t(21875);function _(p=!0){return async u=>{if(m.TP.hasPermission(D.AccessControlAction.SettingsRead)){p&&u((0,v.sr)()),u(L());const g=await(0,d.AI)().get("/api/admin/settings");return u((0,v.jA)(g)),await u(M()),p&&u((0,v.MH)()),g}}}function L(p=""){return async u=>{if(!S.$.featureToggles.ssoSettingsApi)return[];const g=await(0,d.AI)().get(`/api/v1/sso-settings${p?`/${p}`:""}`);return u((0,v.Oy)(p?[g]:g)),g}}function M(){return async p=>{const u=(0,E.getRegisteredAuthProviders)(),g={},P=[];for(const x of u)P.push((0,E.getAuthProviderStatus)(x.id));const F=await Promise.all(P);for(let x=0;x<u.length;x++){const B=u[x];g[B.id]=F[x]}p((0,v.TO)(g))}}function r(p){return async u=>{if(m.TP.hasPermission(D.AccessControlAction.SettingsWrite))try{return await(0,e.s)((0,d.AI)().fetch({url:"/api/admin/settings",method:"PUT",data:p,showSuccessAlert:!1,showErrorAlert:!1})),u((0,v.SH)()),!0}catch(g){if(console.log(g),(0,d.NF)(g)){g.isHandled=!0;const P={message:g.data?.message,errors:g.data?.errors};return u((0,v.Nh)(P)),!1}}return!1}}},74997:(q,C,t)=>{t.d(C,{K:()=>S,h:()=>d});var e=t(22011);function d(m){return e.o+(m.configPath||m.id)}const S=m=>{if(typeof m!="string")return!1;try{return new URL(m).protocol.includes("http")}catch{return!1}}},41391:(q,C,t)=>{t.d(C,{A:()=>S});const e=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-8][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000|ffffffff-ffff-ffff-ffff-ffffffffffff)$/i;function d(m){return typeof m=="string"&&e.test(m)}const S=d}}]);

//# sourceMappingURL=AdminAuthentication.4b371a770bd8334739ee.js.map