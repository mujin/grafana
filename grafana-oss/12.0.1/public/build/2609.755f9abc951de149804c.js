(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[2609],{11908:(I,x,c)=>{"use strict";c.d(x,{s:()=>n});var n;(function(i){i[i.UNSET=0]="UNSET",i[i.OK=1]="OK",i[i.ERROR=2]="ERROR"})(n||(n={}))},75888:(I,x,c)=>{"use strict";I.exports=function(n,i){var h=this,S=h.constructor;return h.options=Object.assign({storeInstancesGlobally:!0},i||{}),h.callbacks={},h.directMap={},h.sequenceLevels={},h.resetTimer=null,h.ignoreNextKeyup=!1,h.ignoreNextKeypress=!1,h.nextExpectedAction=!1,h.element=n,h.addEvents(),h.options.storeInstancesGlobally&&S.instances.push(h),h},I.exports.prototype.bind=c(61210),I.exports.prototype.bindMultiple=c(74382),I.exports.prototype.unbind=c(43709),I.exports.prototype.trigger=c(43149),I.exports.prototype.reset=c(26726),I.exports.prototype.stopCallback=c(84446),I.exports.prototype.handleKey=c(94320),I.exports.prototype.addEvents=c(96687),I.exports.prototype.bindSingle=c(22214),I.exports.prototype.getKeyInfo=c(84174),I.exports.prototype.pickBestAction=c(16004),I.exports.prototype.getReverseMap=c(95193),I.exports.prototype.getMatches=c(19132),I.exports.prototype.resetSequences=c(55610),I.exports.prototype.fireCallback=c(7922),I.exports.prototype.bindSequence=c(90875),I.exports.prototype.resetSequenceTimer=c(80602),I.exports.prototype.detach=c(93502),I.exports.instances=[],I.exports.reset=c(6255),I.exports.REVERSE_MAP=null},96687:(I,x,c)=>{"use strict";I.exports=function(){var n=this,i=c(12904),h=n.element;n.eventHandler=c(88178).bind(n),i(h,"keypress",n.eventHandler),i(h,"keydown",n.eventHandler),i(h,"keyup",n.eventHandler)}},61210:I=>{"use strict";I.exports=function(x,c,n){var i=this;return x=x instanceof Array?x:[x],i.bindMultiple(x,c,n),i}},74382:I=>{"use strict";I.exports=function(x,c,n){for(var i=this,h=0;h<x.length;++h)i.bindSingle(x[h],c,n)}},90875:(I,x,c)=>{"use strict";I.exports=function(n,i,h,S){var A=this;A.sequenceLevels[n]=0;function D(L){return function(){A.nextExpectedAction=L,++A.sequenceLevels[n],A.resetSequenceTimer()}}function R(L){var N;A.fireCallback(h,L,n),S!=="keyup"&&(N=c(23970),A.ignoreNextKeyup=N(L)),setTimeout(function(){A.resetSequences()},10)}for(var m=0;m<i.length;++m){var U=m+1===i.length,P=U?R:D(S||A.getKeyInfo(i[m+1]).action);A.bindSingle(i[m],P,S,n,m)}}},22214:I=>{"use strict";I.exports=function(x,c,n,i,h){var S=this;S.directMap[x+":"+n]=c,x=x.replace(/\s+/g," ");var A=x.split(" "),D;if(A.length>1){S.bindSequence(x,A,c,n);return}D=S.getKeyInfo(x,n),S.callbacks[D.key]=S.callbacks[D.key]||[],S.getMatches(D.key,D.modifiers,{type:D.action},i,x,h),S.callbacks[D.key][i?"unshift":"push"]({callback:c,modifiers:D.modifiers,action:D.action,seq:i,level:h,combo:x})}},93502:(I,x,c)=>{var n=c(12904).off;I.exports=function(){var i=this,h=i.element;n(h,"keypress",i.eventHandler),n(h,"keydown",i.eventHandler),n(h,"keyup",i.eventHandler)}},12904:I=>{I.exports=x,I.exports.on=x,I.exports.off=c;function x(n,i,h,S){return!n.addEventListener&&(i="on"+i),(n.addEventListener||n.attachEvent).call(n,i,h,S),h}function c(n,i,h,S){return!n.removeEventListener&&(i="on"+i),(n.removeEventListener||n.detachEvent).call(n,i,h,S),h}},7922:(I,x,c)=>{"use strict";I.exports=function(n,i,h,S){var A=this,D,R;A.stopCallback(i,i.target||i.srcElement,h,S)||n(i,h)===!1&&(D=c(12156),D(i),R=c(31849),R(i))}},84174:(I,x,c)=>{"use strict";I.exports=function(n,i){var h=this,S,A,D,R,m=[],U,P,L;for(S=c(27486),A=S(n),U=c(7641),P=c(57984),L=c(95962),R=0;R<A.length;++R)D=A[R],U[D]&&(D=U[D]),i&&i!=="keypress"&&P[D]&&(D=P[D],m.push("shift")),L(D)&&m.push(D);return i=h.pickBestAction(D,m,i),{key:D,modifiers:m,action:i}}},19132:(I,x,c)=>{"use strict";I.exports=function(n,i,h,S,A,D){var R=this,m,U,P=[],L=h.type,N,k;if(L==="keypress"&&!(h.code&&h.code.slice(0,5)==="Arrow")){var X=R.callbacks["any-character"]||[];X.forEach(function(ue){P.push(ue)})}if(!R.callbacks[n])return P;for(N=c(95962),L==="keyup"&&N(n)&&(i=[n]),m=0;m<R.callbacks[n].length;++m)if(U=R.callbacks[n][m],!(!S&&U.seq&&R.sequenceLevels[U.seq]!==U.level)&&L===U.action&&(k=c(27238),L==="keypress"&&!h.metaKey&&!h.ctrlKey||k(i,U.modifiers))){var z=!S&&U.combo===A,le=S&&U.seq===S&&U.level===D;(z||le)&&R.callbacks[n].splice(m,1),P.push(U)}return P}},95193:(I,x,c)=>{"use strict";I.exports=function(){var n=this,i=n.constructor,h;if(!i.REVERSE_MAP){i.REVERSE_MAP={},h=c(56814);for(var S in h)S>95&&S<112||h.hasOwnProperty(S)&&(i.REVERSE_MAP[h[S]]=S)}return i.REVERSE_MAP}},94320:(I,x,c)=>{"use strict";I.exports=function(n,i,h){var S=this,A,D,R={},m=0,U=!1,P,L;for(A=S.getMatches(n,i,h),D=0;D<A.length;++D)A[D].seq&&(m=Math.max(m,A[D].level));for(D=0;D<A.length;++D){if(A[D].seq){if(A[D].level!==m)continue;U=!0,R[A[D].seq]=1,S.fireCallback(A[D].callback,h,A[D].combo,A[D].seq);continue}U||S.fireCallback(A[D].callback,h,A[D].combo)}L=h.type==="keypress"&&S.ignoreNextKeypress,P=c(95962),h.type===S.nextExpectedAction&&!P(n)&&!L&&S.resetSequences(R),S.ignoreNextKeypress=U&&h.type==="keydown"}},88178:(I,x,c)=>{"use strict";I.exports=function(n){var i=this,h,S;typeof n.which!="number"&&(n.which=n.keyCode),h=c(23970);var A=h(n);if(A!==void 0){if(n.type==="keyup"&&i.ignoreNextKeyup===A){i.ignoreNextKeyup=!1;return}S=c(25273),i.handleKey(A,S(n),n)}}},27238:I=>{"use strict";I.exports=function(x,c){return x.sort().join(",")===c.sort().join(",")}},16004:I=>{"use strict";I.exports=function(x,c,n){var i=this;return n||(n=i.getReverseMap()[x]?"keydown":"keypress"),n==="keypress"&&c.length&&(n="keydown"),n}},26726:I=>{"use strict";I.exports=function(){var x=this;return x.callbacks={},x.directMap={},this}},80602:I=>{"use strict";I.exports=function(){var x=this;clearTimeout(x.resetTimer),x.resetTimer=setTimeout(function(){x.resetSequences()},1e3)}},55610:I=>{"use strict";I.exports=function(x){var c=this;x=x||{};var n=!1,i;for(i in c.sequenceLevels){if(x[i]){n=!0;continue}c.sequenceLevels[i]=0}n||(c.nextExpectedAction=!1)}},84446:I=>{"use strict";I.exports=function(x,c){if((" "+c.className+" ").indexOf(" combokeys ")>-1)return!1;var n=c.tagName.toLowerCase();return n==="input"||n==="select"||n==="textarea"||c.isContentEditable}},43149:I=>{"use strict";I.exports=function(x,c){var n=this;return n.directMap[x+":"+c]&&n.directMap[x+":"+c]({},x),this}},43709:I=>{"use strict";I.exports=function(x,c){var n=this;return n.bind(x,function(){},c)}},6255:I=>{"use strict";I.exports=function(){var x=this;x.instances.forEach(function(c){c.reset()})}},23970:(I,x,c)=>{"use strict";I.exports=function(n){var i,h;if(i=c(56814),h=c(14082),n.type==="keypress"){var S=String.fromCharCode(n.which);return n.shiftKey||(S=S.toLowerCase()),S}return i[n.which]!==void 0?i[n.which]:h[n.which]!==void 0?h[n.which]:String.fromCharCode(n.which).toLowerCase()}},25273:I=>{"use strict";I.exports=function(x){var c=[];return x.shiftKey&&c.push("shift"),x.altKey&&c.push("alt"),x.ctrlKey&&c.push("ctrl"),x.metaKey&&c.push("meta"),c}},95962:I=>{"use strict";I.exports=function(x){return x==="shift"||x==="ctrl"||x==="alt"||x==="meta"}},27486:I=>{"use strict";I.exports=function(x){return x==="+"?["+"]:x.split("+")}},12156:I=>{"use strict";I.exports=function(x){if(x.preventDefault){x.preventDefault();return}x.returnValue=!1}},57984:I=>{"use strict";I.exports={"~":"`","!":"1","@":"2","#":"3",$:"4","%":"5","^":"6","&":"7","*":"8","(":"9",")":"0",_:"-","+":"=",":":";",'"':"'","<":",",">":".","?":"/","|":"\\"}},7641:I=>{"use strict";I.exports={option:"alt",command:"meta",return:"enter",escape:"esc",mod:/Mac|iPod|iPhone|iPad/.test(navigator.platform)?"meta":"ctrl"}},14082:I=>{"use strict";I.exports={106:"*",107:"plus",109:"minus",110:".",111:"/",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'"}},56814:I=>{"use strict";I.exports={8:"backspace",9:"tab",13:"enter",16:"shift",17:"ctrl",18:"alt",20:"capslock",27:"esc",32:"space",33:"pageup",34:"pagedown",35:"end",36:"home",37:"left",38:"up",39:"right",40:"down",45:"ins",46:"del",91:"meta",93:"meta",173:"minus",187:"plus",189:"minus",224:"meta"};for(var x=1;x<20;++x)I.exports[111+x]="f"+x;for(x=0;x<=9;++x)I.exports[x+96]=x},31849:I=>{"use strict";I.exports=function(x){if(x.stopPropagation){x.stopPropagation();return}x.cancelBubble=!0}},51603:(I,x,c)=>{"use strict";c.d(x,{V:()=>Et});var n=c(74848),i=c(22803),h=c(96540),S=c(42941),A=c(1906),D=c(38036);function R(p){if(p?.tracesToLogsV2)return p.tracesToLogsV2;if(!p?.tracesToLogs)return;const v={customQuery:!1};return v.datasourceUid=p.tracesToLogs.datasourceUid,v.tags=p.tracesToLogs.mapTagNamesEnabled?p.tracesToLogs.mappedTags:p.tracesToLogs.tags?.map(b=>({key:b})),v.filterByTraceID=p.tracesToLogs.filterByTraceID,v.filterBySpanID=p.tracesToLogs.filterBySpanID,v.spanStartTimeShift=p.tracesToLogs.spanStartTimeShift,v.spanEndTimeShift=p.tracesToLogs.spanEndTimeShift,v}function m({options:p,onOptionsChange:v}){const b=["loki","elasticsearch","grafana-splunk-datasource","grafana-opensearch-datasource","grafana-falconlogscale-datasource","googlecloud-logging-datasource"],T=useMemo(()=>R(p.jsonData)||{customQuery:!1},[p.jsonData]),{query:E="",tags:y,customQuery:O}=T,B=useCallback(K=>{v({...p,jsonData:{...p.jsonData,tracesToLogsV2:{...T,...K},tracesToLogs:void 0}})},[v,p,T]);return jsxs("div",{className:css({width:"100%"}),children:[jsx(InlineFieldRow,{children:jsx(InlineField,{tooltip:"The logs data source the trace is going to navigate to",label:"Data source",labelWidth:26,children:jsx(DataSourcePicker,{inputId:"trace-to-logs-data-source-picker",filter:K=>b.includes(K.type),current:T.datasourceUid,noDefault:!0,width:40,onChange:K=>B({datasourceUid:K.uid}),onClear:()=>B({datasourceUid:void 0})})})}),jsx(InlineFieldRow,{children:jsx(IntervalInput,{label:P("start"),tooltip:L("start","0"),value:T.spanStartTimeShift||"",onChange:K=>{B({spanStartTimeShift:K})},isInvalidError:N})}),jsx(InlineFieldRow,{children:jsx(IntervalInput,{label:P("end"),tooltip:L("end","0"),value:T.spanEndTimeShift||"",onChange:K=>{B({spanEndTimeShift:K})},isInvalidError:N})}),jsx(InlineFieldRow,{children:jsx(InlineField,{tooltip:"Tags that will be used in the query. Default tags: 'cluster', 'hostname', 'namespace', 'pod', 'service.name', 'service.namespace'",label:"Tags",labelWidth:26,children:jsx(TagMappingInput,{values:y??[],onChange:K=>B({tags:K})})})}),jsx(U,{disabled:O,type:"trace",id:"filterByTraceID",value:!!T.filterByTraceID,onChange:K=>B({filterByTraceID:K})}),jsx(U,{disabled:O,type:"span",id:"filterBySpanID",value:!!T.filterBySpanID,onChange:K=>B({filterBySpanID:K})}),jsx(InlineFieldRow,{children:jsx(InlineField,{tooltip:"Use a custom query with the possibility to interpolate variables from the trace or span",label:"Use custom query",labelWidth:26,children:jsx(InlineSwitch,{id:"customQuerySwitch",value:O,onChange:K=>B({customQuery:K.currentTarget.checked})})})}),O&&jsx(InlineField,{label:"Query",labelWidth:26,tooltip:"The query that will run when navigating from a trace to logs data source. Interpolate tags using the `$__tags` keyword",grow:!0,children:jsx(Input,{label:"Query",type:"text",allowFullScreen:!0,value:E,onChange:K=>B({query:K.currentTarget.value})})})]})}function U(p){return jsx(InlineFieldRow,{children:jsx(InlineField,{disabled:p.disabled,label:`Filter by ${p.type} ID`,labelWidth:26,grow:!0,tooltip:`Filters logs by ${p.type} ID, where the ${p.type} ID should be part of the log line`,children:jsx(InlineSwitch,{id:p.id,value:p.value,onChange:v=>p.onChange(v.currentTarget.checked)})})})}const P=p=>`Span ${p} time shift`,L=(p,v)=>`Shifts the ${p} time of the span. Default: ${v} (Time units can be used here, for example: 5s, -1m, 3h)`,N="Invalid time shift. See tooltip for examples.",k=({options:p,onOptionsChange:v})=>{let b=p.type;return b+=p.type==="tempo"?"/configure-tempo-data-source/#trace-to-logs":"/#trace-to-logs",jsx(ConfigSection,{title:"Trace to logs",description:jsx(ConfigDescriptionLink,{description:"Navigate from a trace span to the selected data source's logs.",suffix:b,feature:"trace to logs"}),isCollapsible:!0,isInitiallyOpen:!0,children:jsx(m,{options:p,onOptionsChange:v})})};var X=c(2863),z=c(63142),le=c(56840),ue=c(28998),ae=c(34984),Ie=c(96673),me=c(51845),fe=c(28941),Fe=c(41811);const Ue=(p,v,b)=>{let T;return b?T=v?.childSpanIds.find(E=>p.has(E)&&p.get(E).startTime+p.get(E).duration<b):T=v.childSpanIds[0],T?p.get(T):void 0},be=p=>{const v=[],b=[];p.forEach(y=>{if(y.references[0]?.refType==="FOLLOWS_FROM"){v.push(y.spanID);const O=p.get(y.references[0].spanID);O.childSpanIds=O.childSpanIds.filter(B=>B!==y.spanID),p.set(O.spanID,{...O})}});const T=y=>{y.forEach(O=>{const B=p.get(O);B.hasChildren&&(b.push(...B.childSpanIds),T(B.childSpanIds))})};return T(v),[...v,...b].forEach(y=>p.delete(y)),p},V=p=>{let v=[...p.keys()];return v.forEach(b=>{const T=p.get(b);if(!(T&&T.references.length&&T.depth))return;const E=p.get(T.references[0].spanID);if(!E){p.delete(T.spanID);return}const y=T.startTime+T.duration,O=E.startTime+E.duration;if(T.startTime>=E.startTime){if(T.startTime>=O){p.delete(T.spanID),E.childSpanIds=E.childSpanIds.filter(B=>B!==T.spanID);return}if(y>O){p.set(T.spanID,{...T,duration:O-T.startTime});return}return}y<=E.startTime?(p.delete(T.spanID),E.childSpanIds=E.childSpanIds.filter(B=>B!==T.spanID)):y<=O?p.set(T.spanID,{...T,startTime:E.startTime,duration:y-E.startTime}):p.set(T.spanID,{...T,startTime:E.startTime,duration:O-E.startTime})}),v=[...p.keys()],v.forEach(b=>{const T=p.get(b);if(T.references.length){const E=p.get(T.references[0].spanID);T.references[0].span=E,p.set(b,{...T})}}),p},xe=(p,v,b,T)=>{const E=p.get(v);if(!E)return b;const y=Ue(p,E,T);let O;if(y)O={spanId:E.spanID,section_start:y.startTime+y.duration,section_end:T||E.startTime+E.duration},O.section_start!==O.section_end&&b.push(O),xe(p,y.spanID,b);else if(O={spanId:E.spanID,section_start:E.startTime,section_end:T||E.startTime+E.duration},O.section_start!==O.section_end&&b.push(O),E.references.length){const B=E.references.filter(K=>K.refType==="CHILD_OF")[0].spanID;xe(p,B,b,E.startTime)}return b};function _(p){let v=[];const b=p?.spans[0].spanID;if(b){const T=p.spans.reduce((E,y)=>(E.set(y.spanID,y),E),new Map);try{const E=be(T),y=V(E);v=xe(y,b,v)}catch(E){console.log("error while computing critical path for a trace",E)}}return v}const G=(0,Fe.default)(_);var Q=c(65240),ne=c(11065),ce=c(29617);const ee=.8,He=2,Te=200,It=10,he=60,Y=6;function $e(p,v,b,T,E){const y=new Map,O=v.length<he?he:Math.min(v.length,Te),B=window.innerWidth*2;p.width=B,p.height=O;const K=Math.min(Y,Math.max(He,O/v.length)),ie=O/v.length,pe=p.getContext("2d",{alpha:!1});if(pe){pe.fillStyle=E,pe.fillRect(0,0,B,O);for(let Se=0;Se<v.length;Se++){const{valueWidth:ke,valueOffset:We,serviceName:st}=v[Se],nt=We/b*B;let Ge=ke/b*B;Ge<It&&(Ge=It);let Be=y.get(st);Be||(Be=`rgba(${T(st).concat(ee).join()})`,y.set(st,Be)),pe.fillStyle=Be,pe.fillRect(nt,Se*ie,Ge,K)}}}const Pe=(0,Q.N)(p=>({CanvasSpanGraph:(0,i.css)({label:"CanvasSpanGraph",background:(0,ne.R)(p,"#fafafa"),height:"60px",position:"absolute",width:"100%"})}));class ze extends h.PureComponent{constructor(v){super(v),this.getColor=b=>(0,ce.rY)(b,this.props.theme),this._setCanvasRef=b=>{this._canvasElm=b},this._canvasElm=void 0}componentDidMount(){this._draw()}componentDidUpdate(){this._draw()}_draw(){if(this._canvasElm){const{valueWidth:v,items:b}=this.props;$e(this._canvasElm,b,v,this.getColor,(0,ne.R)(this.props.theme,"#fff"))}}render(){return(0,n.jsx)("canvas",{className:Pe(this.props.theme).CanvasSpanGraph,ref:this._setCanvasRef,"data-testid":"CanvasSpanGraph"})}}const we=(0,z.cV)(ze);var Le=c(44722);const Ne=()=>({TickLabels:(0,i.css)({label:"TickLabels",height:"1rem",position:"relative"}),TickLabelsLabel:(0,i.css)({label:"TickLabelsLabel",color:"#717171",fontSize:"0.7rem",position:"absolute",userSelect:"none"})});function Xe(p){const{numTicks:v,duration:b}=p,T=(0,z.of)(Ne),E=[];for(let y=0;y<v+1;y++){const O=y/v,B=O===1?{right:"0%"}:{left:`${O*100}%`};E.push((0,n.jsx)("div",{className:T.TickLabelsLabel,style:B,"data-testid":"tick",children:(0,Le.a3)(b*O)},O))}return(0,n.jsx)("div",{className:T.TickLabels,"data-testid":"TickLabels",children:E})}var it=c(46942),Re=c.n(it),Mt=c(45861),pt=c(20047);const ds=()=>({GraphTick:(0,i.css)({label:"GraphTick",stroke:"#aaa",strokeWidth:"1px"})});function us(p){const{numTicks:v}=p,b=(0,z.of)(ds),T=[];for(let E=1;E<v;E++){const y=`${E/v*100}%`;T.push((0,n.jsx)("line",{className:b.GraphTick,x1:y,y1:"0%",x2:y,y2:"100%"},E/v))}return(0,n.jsx)("g",{"data-testid":"ticks","aria-hidden":"true",children:T})}const hs=()=>({ScrubberHandleExpansion:Re()((0,i.css)({label:"ScrubberHandleExpansion",cursor:"col-resize",fillOpacity:0,fill:"#44f"}),"scrubber-handle-expansion"),ScrubberHandle:Re()((0,i.css)({label:"ScrubberHandle",cursor:"col-resize",fill:"#555"}),"scrubber-handle"),ScrubberLine:Re()((0,i.css)({label:"ScrubberLine",pointerEvents:"none",stroke:"#555"}),"scrubber-line"),ScrubberDragging:(0,i.css)({label:"ScrubberDragging","& .scrubber-handle-expansion":{fillOpacity:1},"& .scrubber-handle":{fill:"#44f"},"& > .scrubber-line":{stroke:"#44f"}}),ScrubberHandles:(0,i.css)({label:"ScrubberHandles","&:hover > .scrubber-handle-expansion":{fillOpacity:1},"&:hover > .scrubber-handle":{fill:"#44f"},"&:hover + .scrubber.line":{stroke:"#44f"}})});function Me({isDragging:p,onMouseDown:v,onMouseEnter:b,onMouseLeave:T,position:E}){const y=`${E*100}%`,O=(0,z.of)(hs),B=Re()({[O.ScrubberDragging]:p});return(0,n.jsxs)("g",{className:B,"data-testid":"scrubber-component",children:[(0,n.jsxs)("g",{"data-testid":"scrubber-component-g",className:O.ScrubberHandles,onMouseDown:v,onMouseEnter:b,onMouseLeave:T,children:[(0,n.jsx)("rect",{"data-testid":"scrubber-component-rect-1",x:y,className:O.ScrubberHandleExpansion,style:{transform:"translate(-4.5px)"},width:"9",height:"20"}),(0,n.jsx)("rect",{"data-testid":"scrubber-component-rect-2",x:y,className:O.ScrubberHandle,style:{transform:"translate(-1.5px)"},width:"3",height:"20"})]}),(0,n.jsx)("line",{className:O.ScrubberLine,y2:"100%",x1:y,x2:y,"data-testid":"scrubber-component-line"})]})}const vt=(0,Q.N)(p=>{const v="JaegerUiComponents__ViewingLayerResetZoomHoverClassName",b=(0,i.css)({label:"ViewingLayerResetZoom",display:"none",position:"absolute",right:"1%",top:"10%",zIndex:1});return{ViewingLayer:(0,i.css)({label:"ViewingLayer",cursor:"vertical-text",position:"relative",zIndex:1,[`&:hover > .${v}`]:{display:"unset"}}),ViewingLayerGraph:(0,i.css)({label:"ViewingLayerGraph",border:`1px solid ${(0,ne.R)(p,"#999")}`,overflow:"visible !important",position:"relative",transformOrigin:"0 0",width:"100%"}),ViewingLayerInactive:(0,i.css)({label:"ViewingLayerInactive",fill:(0,ne.R)(p,"rgba(214, 214, 214, 0.5)")}),ViewingLayerCursorGuide:(0,i.css)({label:"ViewingLayerCursorGuide",stroke:(0,ne.R)(p,"#f44"),strokeWidth:1}),ViewingLayerDraggedShift:(0,i.css)({label:"ViewingLayerDraggedShift",fillOpacity:.2}),ViewingLayerDrag:(0,i.css)({label:"ViewingLayerDrag",fill:(0,ne.R)(p,"#44f")}),ViewingLayerFullOverlay:(0,i.css)({label:"ViewingLayerFullOverlay",bottom:0,cursor:"col-resize",left:0,position:"fixed",right:0,top:0,userSelect:"none"}),ViewingLayerResetZoom:b,ViewingLayerResetZoomHoverClassName:v}}),Ye={SHIFT_END:"SHIFT_END",SHIFT_START:"SHIFT_START",REFRAME:"REFRAME"};function ps(p,v){const[b,T]=p<v?[p,v]:[v,p];return{x:`${b*100}%`,width:`${(T-b)*100}%`,leadingX:`${v*100}%`}}class Rt extends h.PureComponent{constructor(v){super(v),this._setRoot=b=>{this._root=b},this._getDraggingBounds=b=>{if(!this._root)throw new Error("invalid state");const{left:T,width:E}=this._root.getBoundingClientRect(),[y,O]=this.props.viewRange.time.current;let B=1,K=0;return b===Ye.SHIFT_START?B=O:b===Ye.SHIFT_END&&(K=y),{clientXLeft:T,maxValue:B,minValue:K,width:E}},this._handleReframeMouseMove=({value:b})=>{this.props.updateNextViewRangeTime({cursor:b})},this._handleReframeMouseLeave=()=>{this._draggerReframe.resetBounds(),this.props.updateNextViewRangeTime({cursor:null})},this._handleReframeDragUpdate=({value:b})=>{const T=b,{time:E}=this.props.viewRange,O={reframe:{anchor:E.reframe?E.reframe.anchor:T,shift:T}};this.props.updateNextViewRangeTime(O)},this._handleReframeDragEnd=({manager:b,value:T})=>{const{time:E}=this.props.viewRange,y=E.reframe?E.reframe.anchor:T,[O,B]=T<y?[T,y]:[y,T];b.resetBounds(),this.props.updateViewRangeTime(O,B,"minimap")},this._handleScrubberEnterLeave=({type:b})=>{const T=b===pt.EUpdateTypes.MouseEnter;this.setState({preventCursorLine:T})},this._handleScrubberDragUpdate=({event:b,tag:T,type:E,value:y})=>{E===pt.EUpdateTypes.DragStart&&b.stopPropagation(),T===Ye.SHIFT_START?this.props.updateNextViewRangeTime({shiftStart:y}):T===Ye.SHIFT_END&&this.props.updateNextViewRangeTime({shiftEnd:y})},this._handleScrubberDragEnd=({manager:b,tag:T,value:E})=>{const[y,O]=this.props.viewRange.time.current;let B;if(T===Ye.SHIFT_START)B=[E,O];else if(T===Ye.SHIFT_END)B=[y,E];else throw new Error("bad state");b.resetBounds(),this.setState({preventCursorLine:!1}),this.props.updateViewRangeTime(B[0],B[1],"minimap")},this._resetTimeZoomClickHandler=()=>{this.props.updateViewRangeTime(0,1)},this._draggerReframe=new pt.default({getBounds:this._getDraggingBounds,onDragEnd:this._handleReframeDragEnd,onDragMove:this._handleReframeDragUpdate,onDragStart:this._handleReframeDragUpdate,onMouseMove:this._handleReframeMouseMove,onMouseLeave:this._handleReframeMouseLeave,tag:Ye.REFRAME}),this._draggerStart=new pt.default({getBounds:this._getDraggingBounds,onDragEnd:this._handleScrubberDragEnd,onDragMove:this._handleScrubberDragUpdate,onDragStart:this._handleScrubberDragUpdate,onMouseEnter:this._handleScrubberEnterLeave,onMouseLeave:this._handleScrubberEnterLeave,tag:Ye.SHIFT_START}),this._draggerEnd=new pt.default({getBounds:this._getDraggingBounds,onDragEnd:this._handleScrubberDragEnd,onDragMove:this._handleScrubberDragUpdate,onDragStart:this._handleScrubberDragUpdate,onMouseEnter:this._handleScrubberEnterLeave,onMouseLeave:this._handleScrubberEnterLeave,tag:Ye.SHIFT_END}),this._root=void 0,this.state={preventCursorLine:!1}}componentWillUnmount(){this._draggerReframe.dispose(),this._draggerEnd.dispose(),this._draggerStart.dispose()}_getMarkers(v,b){const T=vt(this.props.theme),E=ps(v,b);return[(0,n.jsx)("rect",{className:Re()(T.ViewingLayerDraggedShift,T.ViewingLayerDrag),x:E.x,y:"0",width:E.width,height:this.props.height-2},"fill"),(0,n.jsx)("rect",{className:Re()(T.ViewingLayerDrag),x:E.leadingX,y:"0",width:"1",height:this.props.height-2},"edge")]}render(){const{height:v,viewRange:b,numTicks:T,theme:E}=this.props,{preventCursorLine:y}=this.state,{current:O,cursor:B,shiftStart:K,shiftEnd:ie,reframe:pe}=b.time,Se=K!=null||ie!=null||pe!=null,[ke,We]=O;let st=0;ke&&(st=ke*100);let nt=100;We&&(nt=100-We*100);let Ge;!Se&&B!=null&&!y&&(Ge=`${B*100}%`);const Be=vt(E);return(0,n.jsxs)("div",{"aria-hidden":!0,className:Be.ViewingLayer,style:{height:v},children:[(ke!==0||We!==1)&&(0,n.jsx)(Mt.$n,{onClick:this._resetTimeZoomClickHandler,className:Re()(Be.ViewingLayerResetZoom,Be.ViewingLayerResetZoomHoverClassName),type:"button",variant:"secondary",children:(0,n.jsx)(le.x6,{i18nKey:"explore.unthemed-viewing-layer.reset-selection",children:"Reset selection"})}),(0,n.jsxs)("svg",{height:v,className:Be.ViewingLayerGraph,ref:this._setRoot,onMouseDown:this._draggerReframe.handleMouseDown,onMouseLeave:this._draggerReframe.handleMouseLeave,onMouseMove:this._draggerReframe.handleMouseMove,children:[st>0&&(0,n.jsx)("rect",{x:0,y:0,height:"100%",width:`${st}%`,className:Be.ViewingLayerInactive,"data-testid":"left-ViewingLayerInactive"}),nt>0&&(0,n.jsx)("rect",{x:`${100-nt}%`,y:0,height:"100%",width:`${nt}%`,className:Be.ViewingLayerInactive,"data-testid":"right-ViewingLayerInactive"}),(0,n.jsx)(us,{numTicks:T}),Ge&&(0,n.jsx)("line",{className:Be.ViewingLayerCursorGuide,x1:Ge,y1:"0",x2:Ge,y2:v-2,strokeWidth:"1","data-testid":"ViewingLayerCursorGuide"}),K!=null&&this._getMarkers(ke,K),ie!=null&&this._getMarkers(We,ie),(0,n.jsx)(Me,{isDragging:K!=null,onMouseDown:this._draggerStart.handleMouseDown,onMouseEnter:this._draggerStart.handleMouseEnter,onMouseLeave:this._draggerStart.handleMouseLeave,position:ke||0}),(0,n.jsx)(Me,{isDragging:ie!=null,position:We||1,onMouseDown:this._draggerEnd.handleMouseDown,onMouseEnter:this._draggerEnd.handleMouseEnter,onMouseLeave:this._draggerEnd.handleMouseLeave}),pe!=null&&this._getMarkers(pe.anchor,pe.shift)]}),Se&&(0,n.jsx)("div",{className:Be.ViewingLayerFullOverlay})]})}}const gs=(0,z.cV)(Rt),Ht=()=>({container:(0,i.css)({padding:"0 0.5rem 0.5rem 0.5rem"}),canvasContainer:(0,i.css)({position:"relative"})}),$t=60,Ot=4;function Wt(p){return{valueOffset:p.relativeStartTime,valueWidth:p.duration,serviceName:p.process.serviceName}}function At(p){return p.spans.map(Wt)}const fs=(0,Fe.default)(At);class en extends h.PureComponent{static{this.defaultProps={height:$t}}render(){const{height:v,trace:b,viewRange:T,updateNextViewRangeTime:E,updateViewRangeTime:y}=this.props,O=Ht();if(!b)return(0,n.jsx)("div",{});const B=fs(b);return(0,n.jsxs)("div",{className:O.container,children:[(0,n.jsx)(Xe,{numTicks:Ot,duration:b.duration}),(0,n.jsxs)("div",{className:O.canvasContainer,children:[(0,n.jsx)(we,{valueWidth:b.duration,items:B}),(0,n.jsx)(gs,{viewRange:T,numTicks:Ot,height:v||$t,updateViewRangeTime:y,updateNextViewRangeTime:E})]})]})}}var ms=c(82899);function Ee(){const[p,v]=(0,h.useState)(new Set),b=(0,h.useCallback)(function(K){if(p.size===0)return;let ie=-1,pe=!0;const Se=K.reduce((ke,We)=>(We.depth<=ie&&(pe=!0),pe&&ke.has(We.spanID)&&(ke.delete(We.spanID),pe=!1,ie=We.depth),ke),new Set(p));v(Se)},[p]),T=(0,h.useCallback)(function(K){if(Kt(K,p))return;let ie;const pe=K.reduce((Se,ke)=>(ie&&ke.depth<=ie.depth?(Se.add(ie.spanID),ke.hasChildren&&(ie=ke)):ke.hasChildren&&!Se.has(ke.spanID)&&(ie=ke),Se),new Set(p));ie&&pe.add(ie.spanID),v(pe)},[p]),E=(0,h.useCallback)(function(){v(new Set)},[]),y=(0,h.useCallback)(function(K){if(Kt(K,p))return;const ie=K.reduce((pe,Se)=>(Se.hasChildren&&pe.add(Se.spanID),pe),new Set);v(ie)},[p]),O=(0,h.useCallback)(function(K){const ie=new Set(p);p.has(K)?ie.delete(K):ie.add(K),v(ie)},[p]);return{childrenHiddenIDs:p,expandOne:b,collapseOne:T,expandAll:E,collapseAll:y,childrenToggle:O}}function Kt(p,v){return p.filter(T=>T.hasChildren).length===v.size}function gt(p){const[v,b]=(0,h.useState)(new Map);(0,h.useEffect)(()=>{b(new Map)},[p,b]);const T=(0,h.useCallback)(function(B){const K=new Map(v);K.has(B)?K.delete(B):K.set(B,new fe.DetailState),b(K)},[v]),E=(0,h.useCallback)(function(B,K){const ie=v.get(B);if(!ie)return;const pe=ie.toggleLogItem(K),Se=new Map(v);return Se.set(B,pe),b(Se)},[v]),y=(0,h.useCallback)(function(B,K){const ie=v.get(B);if(!ie)return;const pe=ie.toggleReferenceItem(K),Se=new Map(v);return Se.set(B,pe),b(Se)},[v]);return{detailStates:v,toggleDetail:T,detailLogItemToggle:E,detailLogsToggle:(0,h.useCallback)(O=>xt("logs",v,b)(O),[v]),detailWarningsToggle:(0,h.useCallback)(O=>xt("warnings",v,b)(O),[v]),detailStackTracesToggle:(0,h.useCallback)(O=>xt("stackTraces",v,b)(O),[v]),detailReferenceItemToggle:y,detailReferencesToggle:(0,h.useCallback)(O=>xt("references",v,b)(O),[v]),detailProcessToggle:(0,h.useCallback)(O=>xt("process",v,b)(O),[v]),detailTagsToggle:(0,h.useCallback)(O=>xt("tags",v,b)(O),[v])}}function xt(p,v,b){return T=>{const E=v.get(T);if(!E)return;let y;p==="tags"?y=E.toggleTags():p==="process"?y=E.toggleProcess():p==="warnings"?y=E.toggleWarnings():p==="references"?y=E.toggleReferences():p==="stackTraces"?y=E.toggleStackTraces():y=E.toggleLogs();const O=new Map(v);O.set(T,y),b(O)}}function vs(){const[p,v]=(0,h.useState)(new Set),b=(0,h.useCallback)(function(y){v(O=>{const B=new Set(O);return B.add(y),B})},[]),T=(0,h.useCallback)(function(y){v(O=>{const B=new Set(O);return B.delete(y),B})},[]);return{hoverIndentGuideIds:p,addHoverIndentGuideId:b,removeHoverIndentGuideId:T}}var xs=c(77806);function ys(){const[p,v]=(0,h.useState)({time:{current:[0,1]}}),b=(0,h.useCallback)(function(y){v(O=>{const B={...O.time,...y};return{...O,time:B}})},[]),T=(0,h.useCallback)(function(y,O){const K={current:[y,O]};v(ie=>({...ie,time:K}))},[]);return{viewRange:p,updateViewRangeTime:T,updateNextViewRangeTime:b}}const bs=p=>({noDataMsg:(0,i.css)({height:"100%",width:"100%",display:"grid",placeItems:"center",fontSize:p.typography.h4.fontSize,color:p.colors.text.secondary})});function Et(p){const{traceProp:v,datasource:b,topOfViewRef:T,exploreId:E,createSpanLink:y,focusedSpanId:O,createFocusSpanLink:B,spanFilters:K}=p,{detailStates:ie,toggleDetail:pe,detailLogItemToggle:Se,detailLogsToggle:ke,detailProcessToggle:We,detailReferencesToggle:st,detailReferenceItemToggle:nt,detailTagsToggle:Ge,detailWarningsToggle:Be,detailStackTracesToggle:Ss}=gt(p.dataFrames[0]),{removeHoverIndentGuideId:Is,addHoverIndentGuideId:Ts,hoverIndentGuideIds:Ft}=vs(),{viewRange:Ut,updateViewRangeTime:Gt,updateNextViewRangeTime:_e}=ys(),{expandOne:Qt,collapseOne:ws,childrenToggle:Ds,collapseAll:Cs,childrenHiddenIDs:Zt,expandAll:Rs}=Ee(),{search:ft,setSearch:Es,spanFilterMatches:Xt}=(0,xs.SQ)(v?.spans,K),[Yt,ks]=(0,h.useState)(""),[Ls,Ns]=(0,S.A)(!1),[Jt,js]=(0,h.useState)(100),[Ms,Os]=(0,h.useState)({}),[yt,As]=(0,h.useState)({}),Fs=(0,z.of)(bs),[kt,Ps]=(0,h.useState)(.4),[Lt,Bs]=zt({refId:p.dataFrames[0]?.refId,exploreId:p.exploreId,datasource:b,splitOpenFn:p.splitOpenFn}),qt=O??Lt,Pt=B??Bs,Tt=(0,h.useMemo)(()=>({childrenHiddenIDs:Zt,detailStates:ie,hoverIndentGuideIds:Ft,spanNameColumnWidth:kt,traceID:p.traceProp?.traceID}),[Zt,ie,Ft,kt,p.traceProp?.traceID]),wt=(0,ue.tR)().getInstanceSettings(b?.name),es=R(wt?.jsonData),ts=wt?.jsonData?.tracesToMetrics,Bt=wt?.jsonData?.tracesToProfiles,_s=wt?.jsonData,Vs=(0,h.useMemo)(()=>y??(0,ms.lU)({splitOpenFn:p.splitOpenFn,traceToLogsOptions:es,traceToMetricsOptions:ts,traceToProfilesOptions:Bt,dataFrame:p.dataFrames[0],createFocusSpanLink:Pt,trace:v}),[p.splitOpenFn,es,ts,Bt,p.dataFrames,Pt,v,y]),_t=(0,Ie.useSelector)(ns=>(0,ae.O)(ns.user)),ss=b?b?.type:"unknown",Hs=p.scrollElement?p.scrollElement:document.getElementsByClassName(p.scrollElementClass??"")[0],$s=G(v);return(0,n.jsx)(n.Fragment,{children:p.dataFrames?.length&&v?(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(fe.TracePageHeader,{trace:v,data:p.dataFrames[0],timeZone:_t,search:ft,setSearch:Es,showSpanFilters:Ls,setShowSpanFilters:Ns,setFocusedSpanIdForSearch:ks,spanFilterMatches:Xt,datasourceType:ss,setHeaderHeight:js,app:E?A.Jk.Explore:A.Jk.Unknown}),(0,n.jsx)(en,{trace:v,viewRange:Ut,updateNextViewRangeTime:_e,updateViewRangeTime:Gt}),(0,n.jsx)(fe.TraceTimelineViewer,{findMatchesIDs:Xt,trace:v,traceToProfilesOptions:Bt,datasourceType:ss,spanBarOptions:_s?.spanBar,traceTimeline:Tt,updateNextViewRangeTime:_e,updateViewRangeTime:Gt,viewRange:Ut,timeZone:_t,setSpanNameColumnWidth:Ps,collapseAll:Cs,collapseOne:ws,expandAll:Rs,expandOne:Qt,childrenToggle:Ds,detailLogItemToggle:Se,detailLogsToggle:ke,detailWarningsToggle:Be,detailStackTracesToggle:Ss,detailReferencesToggle:st,detailReferenceItemToggle:nt,detailProcessToggle:We,detailTagsToggle:Ge,detailToggle:pe,addHoverIndentGuideId:Ts,removeHoverIndentGuideId:Is,linksGetter:()=>[],createSpanLink:Vs,scrollElement:Hs,focusedSpanId:qt,focusedSpanIdForSearch:Yt,showSpanFilterMatchesOnly:ft.matchesOnly,showCriticalPathSpansOnly:ft.criticalPathOnly,createFocusSpanLink:Pt,topOfViewRef:T,headerHeight:Jt,criticalPath:$s,traceFlameGraphs:Ms,setTraceFlameGraphs:Os,redrawListView:yt,setRedrawListView:As,timeRange:p.timeRange,app:E?A.Jk.Explore:A.Jk.Unknown})]}):(0,n.jsx)("div",{className:Fs.noDataMsg,children:(0,n.jsx)(le.x6,{i18nKey:"explore.trace-view.no-data",children:"No data"})})})}function zt(p){const v=(0,Ie.useSelector)(B=>B.explore.panes[p.exploreId]?.panelsState.trace),b=v?.spanId,T=(0,Ie.useDispatch)(),E=B=>T((0,me.EA)(p.exploreId,"trace",{...v,spanId:B})),y=(0,Ie.useSelector)(B=>B.explore.panes[p.exploreId]?.queries.find(K=>K.refId===p.refId));return[b,(B,K)=>{const ie={title:"Deep link to this span",url:"",internal:{datasourceUid:p.datasource?.uid,datasourceName:p.datasource?.name,query:{...y,query:B},panelsState:{trace:{spanId:K}}}},pe=y?.queryType==="traceql"&&y.query===B;return(0,D.u)({link:ie,internalLink:ie.internal,scopedVars:{},field:{},onClickFn:pe?()=>E(b===K?void 0:K):p.splitOpenFn?()=>p.splitOpenFn({datasourceUid:p.datasource?.uid,queries:[{...y,query:B}],panelsState:{trace:{spanId:K}}}):void 0,replaceVariables:(0,X.w)().replace.bind((0,X.w)())})}]}},11065:(I,x,c)=>{"use strict";c.d(x,{R:()=>i});var n=c(84140);function i(h,S,A){if(h.isLight)return S;{if(A){const m=(0,n.A)(S);return n.A.mostReadable(A,[m.clone().lighten(25),m.clone().lighten(10),m,m.clone().darken(10),m.clone().darken(25)],{includeFallbackColors:!1}).toHex8String()}const D=(0,n.A)(S).toHsl();D.l=1-D.l;const R=(0,n.A)(D);return R.isLight()?R.darken(5).toHex8String():R.lighten(5).toHex8String()}}},69192:(I,x,c)=>{"use strict";c.d(x,{T:()=>k});var n=c(74848),i=c(22803),h=c(4392),S=c(47184),A=c(20301),D=c(63142),R=c(41654),m=c(18857),U=c(63527),P=c(56840),L=c(77806),N=c(87826);const k=({search:z,trace:le,setSearch:ue,tagKeys:ae,setTagKeys:Ie,tagValues:me,setTagValues:fe})=>{const Fe={...(0,D.of)(X)},ht=()=>{ae||Ie((0,N._g)(le).map(S.z))},Ue=V=>(0,N.Io)(le,V).map(S.z);(0,h.A)(()=>{z.tags&&z.tags.forEach(V=>{V.key&&fe({...me,[V.id]:Ue(V.key)})})});const q=(V,xe)=>{ue({...z,tags:z.tags?.map(F=>F.id===V.id?{...F,key:xe?.value||"",value:void 0}:F)}),(async()=>{if(xe?.value)fe({...me,[V.id]:Ue(xe.value)});else{const F={...me};F[V.id]&&delete F[V.id],fe(F)}})()},be=()=>{const V={id:(0,L.zE)(),operator:"="};ue({...z,tags:[...z.tags,V]})},ve=V=>{let xe=z.tags.filter(_=>_.id!==V);xe.length===0&&(xe=[{id:(0,L.zE)(),operator:"="}]),ue({...z,tags:xe})};return(0,n.jsx)("div",{children:z.tags?.map((V,xe)=>(0,n.jsx)("div",{children:(0,n.jsxs)(R.B,{gap:0,width:"auto",justifyContent:"flex-start",alignItems:"center",children:[(0,n.jsx)("div",{children:(0,n.jsx)(m.l6,{"aria-label":(0,P.t)("explore.span-filters-tags.aria-label-select-tag-key","Select tag key"),isClearable:!0,onChange:_=>q(V,_),onOpenMenu:ht,options:ae||(V.key?[V.key].map(S.z):[]),placeholder:(0,P.t)("explore.span-filters-tags.placeholder-select-tag","Select tag"),value:V.key||null},V.key)}),(0,n.jsx)("div",{children:(0,n.jsx)(m.l6,{"aria-label":(0,P.t)("explore.span-filters-tags.aria-label-select-tag-operator","Select tag operator"),onChange:_=>{ue({...z,tags:z.tags?.map(F=>F.id===V.id?{...F,operator:_.value}:F)})},options:[(0,S.z)("="),(0,S.z)("!="),(0,S.z)("=~"),(0,S.z)("!~")],value:V.operator})}),(0,n.jsxs)("span",{className:Fe.tagValues,children:[(V.operator==="="||V.operator==="!=")&&(0,n.jsx)(m.l6,{"aria-label":(0,P.t)("explore.span-filters-tags.aria-label-select-tag-value","Select tag value"),isClearable:!0,onChange:_=>{ue({...z,tags:z.tags?.map(F=>F.id===V.id?{...F,value:_?.value||""}:F)})},options:me[V.id]?me[V.id]:V.value?[V.value].map(S.z):[],placeholder:(0,P.t)("explore.span-filters-tags.placeholder-select-value","Select value"),value:V.value},V.value),(V.operator==="=~"||V.operator==="!~")&&(0,n.jsx)(U.p,{"aria-label":(0,P.t)("explore.span-filters-tags.aria-label-input-tag-value","Input tag value"),onChange:_=>{ue({...z,tags:z.tags?.map(F=>F.id===V.id?{...F,value:_?.currentTarget?.value||""}:F)})},placeholder:(0,P.t)("explore.span-filters-tags.placeholder-tag-value","Tag value"),width:18,value:V.value||""})]}),(V.key||V.value||z.tags.length>1)&&(0,n.jsx)(A.Z,{"aria-label":(0,P.t)("explore.span-filters-tags.aria-label-remove-tag","Remove tag"),variant:"secondary",icon:"times",onClick:()=>ve(V.id),tooltip:(0,P.t)("explore.span-filters-tags.tooltip-remove-tag","Remove tag")}),(V.key||V.value)&&xe===z.tags.length-1&&(0,n.jsx)("span",{className:Fe.addTag,children:(0,n.jsx)(A.Z,{"aria-label":(0,P.t)("explore.span-filters-tags.aria-label-add-tag","Add tag"),variant:"secondary",icon:"plus",onClick:be,tooltip:(0,P.t)("explore.span-filters-tags.tooltip-add-tag","Add tag")})})]})},V.id))})},X=z=>({addTag:(0,i.css)({marginLeft:z.spacing(1)}),tagValues:(0,i.css)({maxWidth:"200px"})})},21961:(I,x,c)=>{"use strict";c.d(x,{Ay:()=>Ue});var n=c(74848),i=c(22803),h=c(46942),S=c.n(h),A=c(30703),D=c(63142),R=c(11065),m=c(96540),U=c(45967),P=c(45861);const L=()=>({CopyIcon:(0,i.css)({backgroundColor:"transparent",border:"none",color:"inherit",height:"100%",overflow:"hidden","&:focus":{backgroundColor:"rgba(255, 255, 255, 0.25)",color:"inherit"}})});function N({copyText:q,icon:be="copy",tooltipTitle:ve}){const V=(0,D.of)(L),[xe,_]=(0,m.useState)(!1),F=()=>{navigator.clipboard.writeText(q),_(!0)};return(0,n.jsx)(U.m,{content:xe?"Copied":ve,children:(0,n.jsx)(P.$n,{className:S()(V.CopyIcon),type:"button",icon:be,onClick:F})})}const k="    ";function X(q){let be="";return q&&Object.keys(q).forEach(function(ve){be+=ve+":"+q[ve]+";"}),be}function z(q){function be(V){return'class="'+V+'"'}function ve(V){return'style="'+X(q["."+V])+'"'}return q?ve:be}function le(q){return q===null?"null":Array.isArray(q)?"array":typeof q=="string"&&/^https?:/.test(q)?"link":typeof q=="object"&&typeof q.toISOString=="function"?"date":typeof q}function ue(q){return q.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")}function ae(q,be){let ve="";const V=z(be);let xe=function(F,G,Q,ne){if(!F.length)return G+" "+Q;let ce=G+`
`;return ve+=k,F.forEach(function(ee,He){ce+=ve+ne(ee)+(He<F.length-1?",":"")+`
`}),ve=ve.slice(0,-k.length),ce+ve+Q};function _(F){if(F===void 0)return"";switch(le(F)){case"boolean":return"<span "+V("json-markup-bool")+">"+F+"</span>";case"number":return"<span "+V("json-markup-number")+">"+F+"</span>";case"date":return'<span class="json-markup-string">"'+ue(F.toISOString())+'"</span>';case"null":return"<span "+V("json-markup-null")+">null</span>";case"string":return"<span "+V("json-markup-string")+'>"'+ue(F.replace(/\n/g,`
`+ve))+'"</span>';case"link":return"<span "+V("json-markup-string")+'>"<a href="'+encodeURI(F)+'">'+ue(F)+'</a>"</span>';case"array":return xe(F,"[","]",_);case"object":const G=Object.keys(F).filter(function(Q){return F[Q]!==void 0});return xe(G,"{","}",function(Q){return"<span "+V("json-markup-key")+'>"'+ue(Q)+'":</span> '+_(F[Q])})}return""}return"<div "+V("json-markup")+">"+_(q)+"</div>"}const Ie="copyIcon",me=q=>({KeyValueTable:(0,i.css)({label:"KeyValueTable",background:(0,R.R)(q,"#fff"),border:`1px solid ${(0,R.R)(q,"#ddd")}`,marginBottom:"0.5rem",maxHeight:"450px",overflow:"auto"}),table:(0,i.css)({width:"100%"}),body:(0,i.css)({label:"body",verticalAlign:"baseline"}),row:(0,i.css)({label:"row","& > td":{padding:"0.5rem 0.5rem",height:"30px"},"&:nth-child(2n) > td":{background:(0,R.R)(q,"#f5f5f5")},[`&:not(:hover) .${Ie}`]:{visibility:"hidden"}}),keyColumn:(0,i.css)({label:"keyColumn",color:(0,R.R)(q,"#888"),whiteSpace:"pre",width:"125px",verticalAlign:"top"}),copyColumn:(0,i.css)({label:"copyColumn",textAlign:"right"}),linkIcon:(0,i.css)({label:"linkIcon",verticalAlign:"middle",fontWeight:"bold"}),jsonTable:(0,i.css)({display:"inline-block"})}),fe=/^(\[|\{)/;function Fe(q){if(typeof q=="string"&&fe.test(q))try{return JSON.parse(q)}catch{}return q}const ht=({href:q,title:be="",children:ve})=>(0,n.jsxs)("a",{href:q,title:be,target:"_blank",rel:"noopener noreferrer",children:[ve," ",(0,n.jsx)(A.I,{name:"external-link-alt"})]});function Ue(q){const{data:be,linksGetter:ve}=q,V=(0,D.of)(me);return(0,n.jsx)("div",{className:S()(V.KeyValueTable),"data-testid":"KeyValueTable",children:(0,n.jsx)("table",{className:V.table,children:(0,n.jsx)("tbody",{className:V.body,children:be.map((xe,_)=>{const F={__html:ae(Fe(xe.value))},G=(0,n.jsx)("div",{className:V.jsonTable,dangerouslySetInnerHTML:F}),Q=ve?ve(be,_):null;let ne;return Q&&Q.length?ne=(0,n.jsx)("div",{children:(0,n.jsx)(ht,{href:Q[0].url,title:Q[0].text,children:G})}):ne=G,(0,n.jsxs)("tr",{className:V.row,children:[(0,n.jsx)("td",{className:V.keyColumn,"data-testid":"KeyValueTable--keyColumn",children:xe.key}),(0,n.jsx)("td",{children:ne}),(0,n.jsx)("td",{className:V.copyColumn,children:(0,n.jsx)(N,{className:Ie,copyText:JSON.stringify(xe,null,2),tooltipTitle:"Copy JSON"})})]},`${xe.key}-${_}`)})})})})}},34282:(I,x,c)=>{"use strict";c.d(x,{ID:()=>R,Nd:()=>n,XQ:()=>i,Zh:()=>A,gz:()=>D,mT:()=>S,x9:()=>h});const n="kind",i="status",h="status.message",S="library.name",A="library.version",D="trace.state",R="id"},28941:(I,x,c)=>{"use strict";c.d(x,{DetailState:()=>ot,TracePageHeader:()=>Tn,TraceTimelineViewer:()=>Un,filterSpans:()=>Oa,transformTraceData:()=>sr});var n=c(74848),i=c(22803),h=c(96540),S=c(27489),A=c(43173),D=c(65240),R=c(63142),m=c(11065),U=c(75888),P=c.n(U);const N={scrollPageDown:{binding:"s",label:"Scroll down"},scrollPageUp:{binding:"w",label:"Scroll up"},scrollToNextVisibleSpan:{binding:"f",label:"Scroll to the next visible span"},scrollToPrevVisibleSpan:{binding:"b",label:"Scroll to the previous visible span"},panLeft:{binding:["a","left"],label:"Pan left"},panLeftFast:{binding:["shift+a","shift+left"],label:"Pan left \u2014 Large"},panRight:{binding:["d","right"],label:"Pan right"},panRightFast:{binding:["shift+d","shift+right"],label:"Pan right \u2014 Large"},zoomIn:{binding:"up",label:"Zoom in"},zoomInFast:{binding:"shift+up",label:"Zoom in \u2014 Large"},zoomOut:{binding:"down",label:"Zoom out"},zoomOutFast:{binding:"shift+down",label:"Zoom out \u2014 Large"},collapseAll:{binding:"]",label:"Collapse All"},expandAll:{binding:"[",label:"Expand All"},collapseOne:{binding:"p",label:"Collapse One Level"},expandOne:{binding:"o",label:"Expand One Level"},searchSpans:{binding:"ctrl+b",label:"Search Spans"},clearSearch:{binding:"escape",label:"Clear Search"}};let k;function X(){if(k)return k;const e=new(P())(document.body);return k=e,e}function z(e){const s=X();Object.keys(e).forEach(a=>{const r=e[a];r&&s.bind(N[a].binding,r)})}function le(){X().reset()}var ue=c(46942),ae=c.n(ue),Ie=c(44722);function me(e){const{min:s,max:a,viewStart:r,viewEnd:o}=e,l=a-s,d=s+r*l,g=a-(1-o)*l-d;return(f,w)=>({start:(f-d)/g,end:(w-d)/g})}function fe(e,s,a){return!Array.isArray(a.tags)||!a.tags.length?!1:a.tags.some(r=>r.key===e&&r.value===s)}const Fe=e=>e.kind==="client",ht=fe.bind(null,"span.kind","client"),Ue=e=>Fe(e)||ht(e),q=e=>e.kind==="server",be=fe.bind(null,"span.kind","server"),ve=e=>q(e)||be(e),V=e=>e.statusCode===2,xe=fe.bind(null,"error",!0),_=fe.bind(null,"error","true"),F=e=>V(e)||xe(e)||_(e);function G(e,s){const{depth:a}=e[s];let r=s+1;for(;r<e.length&&e[r].depth>a;r++)if(F(e[r]))return!0;return!1}function Q(e){if(e.length<=1||!Ue(e[0]))return!1;const a=e[0].depth+1;let r=1;for(;r<e.length&&e[r].depth===a;){if(ve(e[r]))return e[r];r++}return null}const ne=e=>e.kind?e.kind==="client":e.tags.some(({key:s,value:a})=>s==="span.kind"&&a==="client"),ce=e=>({Ticks:(0,i.css)({label:"Ticks",pointerEvents:"none"}),TicksTick:(0,i.css)({label:"TicksTick",position:"absolute",height:"100%",width:"1px",background:(0,m.R)(e,"#d8d8d8"),"&:last-child":{width:0}}),TicksTickLabel:(0,i.css)({label:"TicksTickLabel",left:"0.25rem",position:"absolute"}),TicksTickLabelEndAnchor:(0,i.css)({label:"TicksTickLabelEndAnchor",left:"initial",right:"0.25rem"})});function ee({endTime:e=null,numTicks:s,showLabels:a=null,startTime:r=null}){let o;if(a){o=[];const u=(e||0)-(r||0);for(let g=0;g<s;g++){const f=(r||0)+g/(s-1)*u;o.push((0,Ie.a3)(f))}}const l=(0,R.of)(ce),d=[];for(let u=0;u<s;u++){const g=u/(s-1);d.push((0,n.jsx)("div",{"data-testid":"TicksID",className:l.TicksTick,style:{left:`${g*100}%`},children:o&&(0,n.jsx)("span",{className:ae()(l.TicksTickLabel,{[l.TicksTickLabelEndAnchor]:g>=1}),children:o[u]})},g))}return(0,n.jsx)("div",{className:l.Ticks,children:d})}const He=()=>({row:(0,i.css)({display:"flex",flex:"0 1 auto",flexDirection:"row"}),rowCell:(0,i.css)({position:"relative"})});function Te({children:e,className:s="",...a}){const r=(0,R.of)(He);return(0,n.jsx)("div",{className:ae()(r.row,s),...a,children:e})}function It({children:e,className:s="",width:a,style:r={},...o}){const l=`${a*100}%`,d={...r,flexBasis:l,maxWidth:l},u=(0,R.of)(He);return(0,n.jsx)("div",{className:ae()(u.rowCell,s),style:d,"data-testid":"TimelineRowCell",...o,children:e})}Te.Cell=It;var he=c(76319),Y=c(56840);const $e=()=>({TimelineCollapser:(0,i.css)({alignItems:"center",display:"flex",flex:"none",justifyContent:"center",marginRight:"0.5rem"})});function Pe(e){const{onExpandAll:s,onExpandOne:a,onCollapseAll:r,onCollapseOne:o}=e,l=(0,R.of)($e);return(0,n.jsxs)("div",{className:l.TimelineCollapser,"data-testid":"TimelineCollapser",children:[(0,n.jsx)(he.K,{tooltip:(0,Y.t)("explore.timeline-collapser.tooltip-expand","Expand +1"),size:"xl",tooltipPlacement:"top",name:"angle-down",onClick:a}),(0,n.jsx)(he.K,{tooltip:(0,Y.t)("explore.timeline-collapser.tooltip-collapse","Collapse +1"),size:"xl",tooltipPlacement:"top",name:"angle-right",onClick:o}),(0,n.jsx)(he.K,{tooltip:(0,Y.t)("explore.timeline-collapser.tooltip-expand-all","Expand all"),size:"xl",tooltipPlacement:"top",name:"angle-double-down",onClick:s}),(0,n.jsx)(he.K,{tooltip:(0,Y.t)("explore.timeline-collapser.tooltip-collapse-all","Collapse all"),size:"xl",tooltipPlacement:"top",name:"angle-double-right",onClick:r})]})}var ze=c(20047);const we=()=>({TimelineColumnResizer:(0,i.css)({left:0,position:"absolute",right:0,top:0}),wrapper:(0,i.css)({bottom:0,position:"absolute",top:0}),dragger:(0,i.css)({borderLeft:"2px solid transparent",cursor:"col-resize",height:"5000px",marginLeft:"-1px",position:"absolute",top:0,width:"1px",zIndex:10,"&:hover":{borderLeft:"2px solid rgba(0, 0, 0, 0.3)"},"&::before":{position:"absolute",top:0,bottom:0,left:"-8px",right:0,content:'" "'}}),draggerDragging:(0,i.css)({background:"rgba(136, 0, 136, 0.05)",width:"unset","&::before":{left:-2e3,right:-2e3}}),draggerDraggingLeft:(0,i.css)({borderLeft:"2px solid #808",borderRight:"1px solid #999"}),draggerDraggingRight:(0,i.css)({borderLeft:"1px solid #999",borderRight:"2px solid #808"}),gripIcon:(0,i.css)({position:"absolute",top:0,bottom:0,"&::before, &::after":{borderRight:"1px solid #ccc",content:'" "',height:"9px",position:"absolute",right:"9px",top:"25px"},"&::after":{right:"5px"}}),gripIconDragging:(0,i.css)({"&::before, &::after":{borderRight:"1px solid rgba(136, 0, 136, 0.5)"}})});class Le extends h.PureComponent{constructor(s){super(s),this._setRootElm=a=>{this._rootElm=a},this._getDraggingBounds=()=>{if(!this._rootElm)throw new Error("invalid state");const{left:a,width:r}=this._rootElm.getBoundingClientRect(),{min:o,max:l}=this.props;return{clientXLeft:a,width:r,maxValue:l,minValue:o}},this._handleDragUpdate=({value:a})=>{this.setState({dragPosition:a})},this._handleDragEnd=({manager:a,value:r})=>{a.resetBounds(),this.setState({dragPosition:null}),this.props.onChange(r)},this._dragManager=new ze.default({getBounds:this._getDraggingBounds,onDragEnd:this._handleDragEnd,onDragMove:this._handleDragUpdate,onDragStart:this._handleDragUpdate}),this._rootElm=void 0,this.state={dragPosition:null}}componentWillUnmount(){this._dragManager.dispose()}render(){let s,a;const{position:r,columnResizeHandleHeight:o}=this.props,{dragPosition:l}=this.state;s=`${r*100}%`;const d={left:s};let u=!1,g=!1;const f=we();if(this._dragManager.isDragging()&&this._rootElm&&l!=null){u=l<r,g=l>r;const j=`${Math.min(r,l)*100}%`,C=`calc(${(1-Math.max(r,l))*100}% - 1px)`;a={left:j,right:C}}else a=d;a.height=o;const w=u||g;return(0,n.jsxs)("div",{className:f.TimelineColumnResizer,ref:this._setRootElm,"data-testid":"TimelineColumnResizer",children:[(0,n.jsx)("div",{className:ae()(f.gripIcon,w&&f.gripIconDragging),style:d,"data-testid":"TimelineColumnResizer--gripIcon"}),(0,n.jsx)("div",{"aria-hidden":!0,className:ae()(f.dragger,w&&f.draggerDragging,g&&f.draggerDraggingRight,u&&f.draggerDraggingLeft),onMouseDown:this._dragManager.handleMouseDown,style:a,"data-testid":"TimelineColumnResizer--dragger"})]})}}const Ne=(0,D.N)(()=>({TimelineViewingLayer:(0,i.css)({label:"TimelineViewingLayer",bottom:0,cursor:"vertical-text",left:0,position:"absolute",right:0,top:0}),TimelineViewingLayerCursorGuide:(0,i.css)({label:"TimelineViewingLayerCursorGuide",position:"absolute",top:0,bottom:0,left:0,width:"1px",backgroundColor:"red"}),TimelineViewingLayerDragged:(0,i.css)({label:"TimelineViewingLayerDragged",position:"absolute",top:0,bottom:0}),TimelineViewingLayerDraggedDraggingLeft:(0,i.css)({label:"TimelineViewingLayerDraggedDraggingLeft",borderLeft:"1px solid"}),TimelineViewingLayerDraggedDraggingRight:(0,i.css)({label:"TimelineViewingLayerDraggedDraggingRight",borderRight:"1px solid"}),TimelineViewingLayerDraggedShiftDrag:(0,i.css)({label:"TimelineViewingLayerDraggedShiftDrag",backgroundColor:"rgba(68, 68, 255, 0.2)",borderColor:"#44f"}),TimelineViewingLayerDraggedReframeDrag:(0,i.css)({label:"TimelineViewingLayerDraggedReframeDrag",backgroundColor:"rgba(255, 68, 68, 0.2)",borderColor:"#f44"}),TimelineViewingLayerFullOverlay:(0,i.css)({label:"TimelineViewingLayerFullOverlay",bottom:0,cursor:"col-resize",left:0,position:"fixed",right:0,top:0,userSelect:"none"})}));function Xe(e){return Reflect.has(e,"isOutOfView")}function it(e,s,a){return e+a*(s-e)}function Re(e,s,a){return(a-e)/(s-e)}function Mt(e,s){let[a,r]=e<s?[e,s]:[s,e];return a>=1||r<=0?{isOutOfView:!0}:(a<0&&(a=0),r>1&&(r=1),{isDraggingLeft:e>s,left:`${a*100}%`,width:`${(r-a)*100}%`})}function pt(e,s,a,r,o){const l=Re(e,s,a),d=Re(e,s,r),u=Mt(l,d);if(Xe(u))return null;const{isDraggingLeft:g,left:f,width:w}=u,j=Ne(),C=(0,i.cx)({[j.TimelineViewingLayerDraggedDraggingRight]:!g,[j.TimelineViewingLayerDraggedReframeDrag]:!o,[j.TimelineViewingLayerDraggedShiftDrag]:o});return(0,n.jsx)("div",{className:(0,i.cx)(j.TimelineViewingLayerDragged,j.TimelineViewingLayerDraggedDraggingLeft,C),style:{left:f,width:w},"data-testid":"Dragged"})}class ds extends h.PureComponent{constructor(s){super(s),this._setRoot=a=>{this._root=a},this._getDraggingBounds=()=>{if(!this._root)throw new Error("invalid state");const{left:a,width:r}=this._root.getBoundingClientRect();return{clientXLeft:a,width:r}},this._handleReframeMouseMove=({value:a})=>{const[r,o]=this.props.viewRangeTime.current,l=it(r,o,a);this.props.updateNextViewRangeTime({cursor:l})},this._handleReframeMouseLeave=()=>{this.props.updateNextViewRangeTime({cursor:void 0})},this._handleReframeDragUpdate=({value:a})=>{const{current:r,reframe:o}=this.props.viewRangeTime,[l,d]=r,u=it(l,d,a),f={reframe:{anchor:o?o.anchor:u,shift:u}};this.props.updateNextViewRangeTime(f)},this._handleReframeDragEnd=({manager:a,value:r})=>{const{current:o,reframe:l}=this.props.viewRangeTime,[d,u]=o,g=it(d,u,r),f=l?l.anchor:g,[w,j]=g<f?[g,f]:[f,g];a.resetBounds(),this.props.updateViewRangeTime(w,j,"timeline-header")},this._draggerReframe=new ze.default({getBounds:this._getDraggingBounds,onDragEnd:this._handleReframeDragEnd,onDragMove:this._handleReframeDragUpdate,onDragStart:this._handleReframeDragUpdate,onMouseLeave:this._handleReframeMouseLeave,onMouseMove:this._handleReframeMouseMove}),this._root=void 0}UNSAFE_componentWillReceiveProps(s){const{boundsInvalidator:a}=this.props;a!==s.boundsInvalidator&&this._draggerReframe.resetBounds()}componentWillUnmount(){this._draggerReframe.dispose()}render(){const{viewRangeTime:s}=this.props,{current:a,cursor:r,reframe:o,shiftEnd:l,shiftStart:d}=s,[u,g]=a,f=o!=null||l!=null||d!=null;let w;!f&&r!=null&&r>=u&&r<=g&&(w=`${Re(u,g,r)*100}%`);const j=Ne();return(0,n.jsxs)("div",{"aria-hidden":!0,className:j.TimelineViewingLayer,ref:this._setRoot,onMouseDown:this._draggerReframe.handleMouseDown,onMouseLeave:this._draggerReframe.handleMouseLeave,onMouseMove:this._draggerReframe.handleMouseMove,"data-testid":"TimelineViewingLayer",children:[w!=null&&(0,n.jsx)("div",{className:j.TimelineViewingLayerCursorGuide,style:{left:w},"data-testid":"TimelineViewingLayer--cursorGuide"}),o!=null&&pt(u,g,o.anchor,o.shift,!1),l!=null&&pt(u,g,g,l,!0),d!=null&&pt(u,g,u,d,!0)]})}}const us=e=>({TimelineHeaderRow:(0,i.css)({label:"TimelineHeaderRow",background:(0,m.R)(e,"#ececec"),borderBottom:`1px solid ${(0,m.R)(e,"#ccc")}`,height:"38px",lineHeight:"38px",width:"100%",zIndex:4,position:"relative"}),TimelineHeaderRowTitle:(0,i.css)({label:"TimelineHeaderRowTitle",flex:1,overflow:"hidden",margin:0,textOverflow:"ellipsis",whiteSpace:"nowrap"}),TimelineHeaderWrapper:(0,i.css)({label:"TimelineHeaderWrapper",alignItems:"center",display:"flex",paddingLeft:e.spacing(1),paddingRight:e.spacing(1)})});function hs(e){const{duration:s,nameColumnWidth:a,numTicks:r,onCollapseAll:o,onCollapseOne:l,onColummWidthChange:d,onExpandAll:u,onExpandOne:g,updateViewRangeTime:f,updateNextViewRangeTime:w,viewRangeTime:j,columnResizeHandleHeight:C}=e,[M,$]=j.current,H=(0,R.of)(us);return(0,n.jsxs)(Te,{className:H.TimelineHeaderRow,"data-testid":"TimelineHeaderRow",children:[(0,n.jsxs)(Te.Cell,{className:H.TimelineHeaderWrapper,width:a,children:[(0,n.jsx)("h4",{className:H.TimelineHeaderRowTitle,children:"Service & Operation"}),(0,n.jsx)(Pe,{onCollapseAll:o,onExpandAll:u,onCollapseOne:l,onExpandOne:g})]}),(0,n.jsxs)(Te.Cell,{width:1-a,children:[(0,n.jsx)(ds,{boundsInvalidator:a,updateNextViewRangeTime:w,updateViewRangeTime:f,viewRangeTime:j}),(0,n.jsx)(ee,{numTicks:r,startTime:M*s,endTime:$*s,showLabels:!0})]}),(0,n.jsx)(Le,{columnResizeHandleHeight:C,position:a,onChange:d,min:.2,max:.85})]})}var Me=c(2543),vt=c(41811),Ye=c(7895);const ps="peer.service";var Rt=c(29617);class gs{constructor(s){this.ys=[],this.heights=[],this.bufferLen=s,this.dataLen=-1,this.lastI=-1}profileData(s){s!==this.dataLen&&(this.dataLen=s,this.ys.length=s,this.heights.length=s,this.lastI>=s&&(this.lastI=s-1))}calcHeights(s,a,r){r!=null&&(this.lastI=r);let o=s+this.bufferLen;if(o<=this.lastI)return;o>=this.heights.length&&(o=this.heights.length-1);let l=this.lastI;for(this.lastI===-1&&(l=0,this.ys[0]=0);l<=o;){const d=this.heights[l]=a(l);this.ys[l+1]=this.ys[l]+d,l++}this.lastI=o}calcYs(s,a){for(;(this.ys[this.lastI]==null||s>this.ys[this.lastI])&&this.lastI<this.dataLen-1;)this.calcHeights(this.lastI,a)}confirmHeight(s,a){let r=s;if(r>this.lastI){this.calcHeights(r,a);return}const o=a(r);if(o===this.heights[r])return;const l=o-this.heights[r];for(this.heights[r]=o;++r<=this.lastI;)this.ys[r]+=l;this.ys[this.lastI+1]!=null&&(this.ys[this.lastI+1]+=l)}findFloorIndex(s,a){this.calcYs(s,a);let r=0,o=this.lastI;if(this.ys.length<2||s<this.ys[1])return 0;if(s>this.ys[o])return o;let l;for(;r<o;)if(l=r+.5*(o-r)|0,s>this.ys[l]){if(s<=this.ys[l+1])return l;r=l}else if(s<this.ys[l]){if(s>=this.ys[l-1])return l-1;o=l}else return l;throw new Error(`unable to find floor index for y=${s}`)}getRowPosition(s,a){return this.confirmHeight(s,a),{height:this.heights[s],y:this.ys[s]}}getEstimatedHeight(){const s=this.ys[this.lastI]+this.heights[this.lastI];return this.lastI>=this.dataLen-1?s|0:s/(this.lastI+1)*this.heights.length|0}}const Ht=100;class $t extends h.Component{constructor(s){super(s),this.getViewHeight=()=>this._viewHeight,this.getBottomVisibleIndex=()=>{const a=this._scrollTop+this._viewHeight;return this._yPositions.findFloorIndex(a,this._getHeight)},this.getTopVisibleIndex=()=>this._yPositions.findFloorIndex(this._scrollTop,this._getHeight),this.getRowPosition=a=>this._yPositions.getRowPosition(a,this._getHeight),this.scrollToIndex=(a,r)=>{const{scrollElement:o}=this.props,l=o?.getBoundingClientRect().top||0,u=(o?.scrollTop||0)+(this._itemHolderElm?.getBoundingClientRect().top||0)-l,g=this.getRowPosition(a).y;this.props.scrollElement?.scrollTo({top:g+u-r-80})},this._onScroll=()=>{this._isScrolledOrResized||(this._isScrolledOrResized=!0,window.requestAnimationFrame(this._positionList))},this._positionList=()=>{if(this._isScrolledOrResized=!1,!this._wrapperElm)return;this._calcViewIndexes();const a=this.props.viewBufferMin>this._startIndex?0:this._startIndex-this.props.viewBufferMin,r=this.props.viewBufferMin<this.props.dataLength-this._endIndex?this._endIndex+this.props.viewBufferMin:this.props.dataLength-1;(a<this._startIndexDrawn||r>this._endIndexDrawn)&&this.forceUpdate()},this._initWrapper=a=>{this.props.windowScroller&&(this._wrapperElm=a,a&&(this._viewHeight=a.clientHeight))},this._initItemHolder=a=>{this._itemHolderElm=a,this._scanItemHeights()},this._scanItemHeights=()=>{const a=this.props.getIndexFromKey;if(!this._itemHolderElm)return;let r=null,o=null,l=!1;const d=this._itemHolderElm.childNodes,u=d.length;for(let g=0;g<u;g++){const f=d[g];if(f instanceof HTMLElement){const w=f.getAttribute("data-item-key");if(!w){console.warn("itemKey not found");continue}const C=(f.firstElementChild||f).clientHeight,M=this._knownHeights.get(w);C!==M&&(this._knownHeights.set(w,C),l?o=w:(l=!0,r=o=w))}}if(r!=null&&o!=null){const g=a(r),f=o===r?g:a(o);this._yPositions.calcHeights(f,this._getHeight,g),this.forceUpdate()}},this._getHeight=a=>{const r=this.props.getKeyFromIndex(a),o=this._knownHeights.get(r);return o!=null&&o===o?o:this.props.itemHeightGetter(a,r)},this._yPositions=new gs(200),this._knownHeights=new Map,this._startIndexDrawn=2**20,this._endIndexDrawn=-(2**20),this._startIndex=0,this._endIndex=0,this._viewHeight=-1,this._scrollTop=-1,this._isScrolledOrResized=!1,this._htmlTopOffset=-1,this._windowScrollListenerAdded=!1,this._htmlElm=document.documentElement,this._wrapperElm=void 0,this._itemHolderElm=void 0}static{this.defaultProps={initialDraw:Ht,itemsWrapperClassName:"",windowScroller:!1}}componentDidMount(){if(this.props.windowScroller){if(this._wrapperElm){const{top:s}=this._wrapperElm.getBoundingClientRect();this._htmlTopOffset=s+this._htmlElm.scrollTop}window.addEventListener("scroll",this._onScroll),this._windowScrollListenerAdded=!0}else this._wrapperElm=this.props.scrollElement,this._wrapperElm?.addEventListener("scroll",this._onScroll)}componentDidUpdate(s){this._itemHolderElm&&this._scanItemHeights(),!this.props.windowScroller&&s.scrollElement!==this.props.scrollElement&&(s.scrollElement?.removeEventListener("scroll",this._onScroll),this._wrapperElm=this.props.scrollElement,this._wrapperElm?.addEventListener("scroll",this._onScroll))}componentWillUnmount(){this._windowScrollListenerAdded?window.removeEventListener("scroll",this._onScroll):this._wrapperElm?.removeEventListener("scroll",this._onScroll)}_isViewChanged(){if(!this._wrapperElm)return!1;const s=this.props.windowScroller,a=s?this._htmlElm.clientHeight:this._wrapperElm.clientHeight,r=s?this._htmlElm.scrollTop:this._wrapperElm.scrollTop;return a!==this._viewHeight||r!==this._scrollTop}_calcViewIndexes(){if(this.props.windowScroller)this._viewHeight=window.innerHeight-this._htmlTopOffset,this._scrollTop=window.scrollY;else{if(!this._wrapperElm){this._viewHeight=-1,this._startIndex=0,this._endIndex=0;return}this._viewHeight=this._wrapperElm.clientHeight,this._scrollTop=this._wrapperElm.scrollTop}const a=this._scrollTop,r=this._scrollTop+this._viewHeight;this._startIndex=this._yPositions.findFloorIndex(a,this._getHeight),this._endIndex=this._yPositions.findFloorIndex(r,this._getHeight)}render(){const{dataLength:s,getKeyFromIndex:a,initialDraw:r=Ht,itemRenderer:o,viewBuffer:l,viewBufferMin:d}=this.props,u=this._getHeight,g=[];let f,w;if(this._yPositions.profileData(s),!this._wrapperElm)f=0,w=(r<s?r:s)-1;else{this._isViewChanged()&&this._calcViewIndexes();const M=d>this._startIndex?0:this._startIndex-d,$=d<s-this._endIndex?this._endIndex+d:s-1;M<this._startIndexDrawn||$>this._endIndexDrawn?(f=l>this._startIndex?0:this._startIndex-l,w=this._endIndex+l,w>=s&&(w=s-1)):(f=this._startIndexDrawn>s-1?0:this._startIndexDrawn,w=this._endIndexDrawn>s-1?s-1:this._endIndexDrawn)}this._yPositions.calcHeights(w,u,f||-1),this._startIndexDrawn=f,this._endIndexDrawn=w,g.length=w-f+1;for(let M=f;M<=w;M++){const{y:$,height:H}=this._yPositions.getRowPosition(M,u),te={height:H,top:$,position:"absolute"},J=a(M),Z={"data-item-key":J};g.push(o(J,te,M,Z))}const j={style:{position:"relative"},ref:this._initWrapper};this.props.windowScroller||(j.onScroll=this._onScroll,j.style.height="100%",j.style.overflowY="auto");const C={position:"relative",height:this._yPositions.getEstimatedHeight()};return(0,n.jsx)("div",{...j,"data-testid":"ListView",children:(0,n.jsx)("div",{style:C,children:(0,n.jsx)("div",{style:{position:"absolute",top:0,margin:0,padding:0},className:this.props.itemsWrapperClassName,ref:this._initItemHolder,children:g})})})}}const Ot="None",Wt="Duration",At="Tag";function fs({options:e,onOptionsChange:s}){const a=useStyles2(ms),r=[Ot,Wt,At].map(toOption);return jsxs("div",{className:css({width:"100%"}),children:[jsx(InlineFieldRow,{className:a.row,children:jsx(InlineField,{label:"Label",labelWidth:26,tooltip:"Default: duration",grow:!0,children:jsx(Select,{inputId:"label",options:r,value:e.jsonData.spanBar?.type||"",onChange:o=>{updateDatasourcePluginJsonDataOption({onOptionsChange:s,options:e},"spanBar",{...e.jsonData.spanBar,type:o?.value??""})},placeholder:"Duration",isClearable:!0,"aria-label":"select-label-name",width:40})})}),e.jsonData.spanBar?.type===At&&jsx(InlineFieldRow,{className:a.row,children:jsx(InlineField,{label:"Tag key",labelWidth:26,tooltip:"Tag key which will be used to get the tag value. A span's attributes and resources will be searched for the tag key",children:jsx(Input,{type:"text",placeholder:"Enter tag key",onChange:o=>updateDatasourcePluginJsonDataOption({onOptionsChange:s,options:e},"spanBar",{...e.jsonData.spanBar,tag:o.currentTarget.value}),value:e.jsonData.spanBar?.tag||"",width:40})})})]})}const en=({options:e,onOptionsChange:s})=>{let a=e.type;return a+=e.type==="tempo"?"/configure-tempo-data-source/#span-bar":"/#span-bar",jsx(ConfigSubSection,{title:"Span bar",description:jsx(ConfigDescriptionLink,{description:"Add additional info next to the service and operation on a span bar row in the trace view.",suffix:a,feature:"the span bar"}),children:jsx(fs,{options:e,onOptionsChange:s})})},ms=e=>({infoText:css({label:"infoText",paddingBottom:e.spacing(2),color:e.colors.text.secondary}),row:css({label:"row",alignItems:"baseline"})});var Ee=c(30703),Kt=c(85629),gt=c(45967),xt=c(43533),vs=c(2381);function xs({children:e,content:s,overlayClassName:a}){const r=(0,h.useRef)(null);return(0,n.jsx)(xt.I,{content:s,hideAfter:300,children:(o,l,d)=>(0,n.jsxs)(n.Fragment,{children:[r.current&&(0,n.jsx)(vs.A,{...d,referenceElement:r.current,wrapperClassName:a,onMouseLeave:l,onMouseEnter:o}),(0,h.cloneElement)(e,{ref:r,onMouseEnter:o,onMouseLeave:l})]})})}const ys="label";var bs=c(21961),Et=c(11908),zt=c(80011),p=c(3271),v=c(87105),b=c(82899);const T=e=>s=>({LabeledList:(0,i.css)({label:"LabeledList",listStyle:"none",margin:0,padding:0,...e?{marginRight:"-8px",display:"flex",flexWrap:"wrap",justifyContent:"flex-end"}:{}}),LabeledListItem:(0,i.css)({label:"LabeledListItem",display:"inline-block",...e?{borderRight:`1px solid ${(0,m.R)(s,"#ddd")}`,padding:"0 8px"}:{}}),LabeledListLabel:(0,i.css)({label:"LabeledListLabel",color:s.isLight?"#999":"#666",marginRight:"0.25rem"}),LabeledListValue:(0,i.css)({label:"LabeledListValue",marginRight:e?void 0:"0.55rem"})});function E(e){const{className:s,divider:a=!1,items:r}=e,o=(0,R.of)(T(a));return(0,n.jsx)("ul",{className:ae()(o.LabeledList,s),children:r.map(({key:l,label:d,value:u})=>(0,n.jsxs)("li",{className:o.LabeledListItem,children:[(0,n.jsx)("span",{className:o.LabeledListLabel,children:d}),(0,n.jsx)("strong",{className:o.LabeledListValue,children:u})]},`${l}`))})}var y=c(34282);function O(e){const{reference:s,children:a,createFocusSpanLink:r}=e,o=r(s.traceID,s.spanID);return(0,n.jsx)("a",{href:o.href,target:o.target,rel:"noopener noreferrer",onClick:o.onClick?l=>{l.preventDefault(),o.onClick(l)}:void 0,children:a})}const B=e=>({AccordianReferenceItem:(0,i.css)({borderBottom:`1px solid ${(0,m.R)(e,"#d8d8d8")}`}),AccordianKeyValues:(0,i.css)({marginLeft:"10px"}),AccordianReferences:(0,i.css)({label:"AccordianReferences",border:`1px solid ${(0,m.R)(e,"#d8d8d8")}`,position:"relative",marginBottom:"0.25rem"}),AccordianReferencesHeader:(0,i.css)({label:"AccordianReferencesHeader",background:(0,m.R)(e,"#e4e4e4"),color:"inherit",display:"block",padding:"0.25rem 0.5rem","&:hover":{background:(0,m.R)(e,"#dadada")}}),AccordianReferencesContent:(0,i.css)({label:"AccordianReferencesContent",background:(0,m.R)(e,"#f0f0f0"),borderTop:`1px solid ${(0,m.R)(e,"#d8d8d8")}`,padding:"0.5rem 0.5rem 0.25rem 0.5rem"}),AccordianReferencesFooter:(0,i.css)({label:"AccordianReferencesFooter",color:(0,m.R)(e,"#999")}),AccordianKeyValuesItem:(0,i.css)({marginBottom:e.spacing(.5)}),ReferencesList:(0,i.css)({background:"#fff",border:"1px solid #ddd",marginBottom:"0.7em",maxHeight:"450px",overflow:"auto"}),list:(0,i.css)({width:"100%",listStyle:"none",padding:0,margin:0,background:"#fff"}),itemContent:(0,i.css)({padding:"0.25rem 0.5rem",display:"flex",width:"100%",justifyContent:"space-between"}),item:(0,i.css)({"&:nth-child(2n)":{background:"#f5f5f5"}}),debugInfo:(0,i.css)({letterSpacing:"0.25px",margin:"0.5em 0 0",flexWrap:"wrap",display:"flex",justifyContent:"flex-end"}),debugLabel:(0,i.css)({margin:"0 5px 0 5px","&::before":{color:"#bbb",content:"attr(data-label)"}}),serviceName:(0,i.css)({marginRight:"8px"}),title:(0,i.css)({display:"flex",alignItems:"center",gap:"4px"})});function K(e){const{data:s,createFocusSpanLink:a,openedItems:r,onItemToggle:o,interactive:l}=e,d=(0,R.of)(B);return(0,n.jsx)("div",{className:d.AccordianReferencesContent,children:s.map((u,g)=>(0,n.jsxs)("div",{className:g<s.length-1?d.AccordianReferenceItem:void 0,children:[(0,n.jsx)("div",{className:d.item,children:(0,n.jsx)(O,{reference:u,createFocusSpanLink:a,children:(0,n.jsxs)("span",{className:d.itemContent,children:[u.span?(0,n.jsxs)("span",{children:[(0,n.jsx)("span",{className:(0,i.cx)("span-svc-name",d.serviceName),children:u.span.process.serviceName}),(0,n.jsx)("small",{className:"endpoint-name",children:u.span.operationName})]}):(0,n.jsxs)("span",{className:(0,i.cx)("span-svc-name",d.title),children:["View Linked Span ",(0,n.jsx)(Ee.I,{name:"external-link-alt"})]}),(0,n.jsxs)("small",{className:d.debugInfo,children:[(0,n.jsx)("span",{className:d.debugLabel,"data-label":"TraceID:",children:u.traceID}),(0,n.jsx)("span",{className:d.debugLabel,"data-label":"SpanID:",children:u.spanID})]})]})})},`${u.spanID}`),!!u.tags?.length&&(0,n.jsx)("div",{className:d.AccordianKeyValues,children:(0,n.jsx)(Lt,{className:g<s.length-1?d.AccordianKeyValuesItem:null,data:u.tags||[],highContrast:!0,interactive:l,isOpen:r?r.has(u):!1,label:(0,Y.t)("explore.references.label-attributes","attributes"),linksGetter:null,onToggle:l&&o?()=>o(u):null})})]},g))})}const ie=({data:e,interactive:s=!0,isOpen:a,onToggle:r,onItemToggle:o,openedItems:l,createFocusSpanLink:d})=>{const u=!Array.isArray(e)||!e.length;let g=null,f="span",w=null;s&&(g=a?(0,n.jsx)(Ee.I,{name:"angle-down",className:yt}):(0,n.jsx)(Ee.I,{name:"angle-right",className:yt}),f="a",w={"aria-checked":a,onClick:u?null:r,role:"switch"});const j=(0,R.of)(B);return(0,n.jsxs)("div",{className:j.AccordianReferences,children:[(0,n.jsxs)(f,{className:j.AccordianReferencesHeader,...w,children:[g,(0,n.jsx)("strong",{children:(0,n.jsx)("span",{children:(0,n.jsx)(Y.x6,{i18nKey:"explore.accordian-references.references",children:"References"})})})," ","(",e.length,")"]}),a&&(0,n.jsx)(K,{data:e,openedItems:l,createFocusSpanLink:d,onItemToggle:o,interactive:s})]})},pe=h.memo(ie),Se=()=>({TextList:(0,i.css)({maxHeight:"450px",overflow:"auto"}),List:(0,i.css)({width:"100%",listStyle:"none",padding:0,margin:0}),item:(0,i.css)({padding:"0.25rem 0.5rem",verticalAlign:"top","&:nth-child(2n)":{background:"#f5f5f5"}})});function ke(e){const{data:s}=e,a=(0,R.of)(Se);return(0,n.jsx)("div",{className:ae()(a.TextList),"data-testid":"TextList",children:(0,n.jsx)("ul",{className:a.List,children:s.map((r,o)=>(0,n.jsx)("li",{className:a.item,children:r},`${o}`))})})}const We=e=>({header:(0,i.css)({cursor:"pointer",overflow:"hidden",padding:"0.25em 0.1em",textOverflow:"ellipsis",whiteSpace:"nowrap","&:hover":{background:(0,m.R)(e,"#e8e8e8")}})});function st({data:e}){return(0,n.jsx)(ke,{data:e})}function nt({className:e=null,data:s,headerClassName:a,highContrast:r=!1,interactive:o=!0,isOpen:l,label:d,onToggle:u=null,TextComponent:g=st}){const f=!Array.isArray(s)||!s.length,w=(0,R.of)(kt),j=ae()(yt,{[w.emptyIcon]:f});let C=null,M=null;o&&(C=l?(0,n.jsx)(Ee.I,{name:"angle-down",className:j}):(0,n.jsx)(Ee.I,{name:"angle-right",className:j}),M={"aria-checked":l,onClick:f?null:u,role:"switch"});const $=(0,R.of)(We);return(0,n.jsxs)("div",{className:e||"",children:[(0,n.jsxs)("div",{className:ae()($.header,a),...M,"data-testid":"AccordianText--header",children:[C,(0,n.jsx)("strong",{children:d})," (",s.length,")"]}),l&&(0,n.jsx)(g,{data:s})]})}var Ge=c(1906),Be=c(54092),Ss=c(46907),Is=c(36490),Ts=c(28134),Ft=c(87063),Ut=c(88559),Gt=c(25192),_e=c(80897);const Qt=[_e.N.Metrics,_e.N.Logs,_e.N.Profiles,_e.N.ProfilesDrilldown,_e.N.Session],ws=3,Ds=/^https?:\/\//i,Cs=e=>{const{span:s,createSpanLink:a,traceToProfilesOptions:r,timeRange:o,datasourceType:l,app:d}=e;let u;if(a){const g=(a(s)||[]).filter(f=>f.type!==_e.N.Traces).map(f=>f.type===_e.N.Logs?ft(f,_e.N.Logs,"Logs for this span","gf-logs",l):f.type===_e.N.Profiles&&f.title===Gt.cd?(u=f,ft(f,_e.N.Profiles,"Profiles for this span","link",l)):f.type===_e.N.Session?ft(f,_e.N.Session,"Session for this span","frontend-observability",l):ft(f,_e.N.Unknown,f.title||"","link",l));if(u&&d===Ge.Jk.Explore){const f="grafana-pyroscope-app",w=Rs(s,r,o),j=Be.S.TraceViewDetails,{links:C}=(0,Ss.U)({extensionPointId:j,context:w,limitPerPlugin:1}),M=C&&C.length>0?C.find(te=>te.pluginId===f):null,$="Open in Profiles Drilldown",H={...u,href:"",onClick:()=>{M?.onClick?.()}};g.push(ft(H,_e.N.ProfilesDrilldown,$,"link",l))}return g.sort((f,w)=>{const j=Qt.indexOf(f.type),C=Qt.indexOf(w.type),M=j===-1?Number.MAX_SAFE_INTEGER:j,$=C===-1?Number.MAX_SAFE_INTEGER:C;return M-$}),g.length>ws?(0,n.jsx)(Zt,{links:g}):(0,n.jsx)(n.Fragment,{children:g.map(({linkModel:f,icon:w,className:j},C)=>(0,n.jsx)(Ts.R,{link:f,buttonProps:{icon:w,className:j}},C))})}return(0,n.jsx)(n.Fragment,{})},Zt=({links:e})=>{const[s,a]=h.useState(!1),r=(0,n.jsx)(Ft.W,{children:e.map(({linkModel:o},l)=>(0,n.jsx)(Ft.W.Item,{label:o.title,onClick:d=>o.onClick?.(d)},l))});return(0,n.jsx)(Ut.m,{overlay:r,placement:"bottom-start",onVisibleChange:a,children:(0,n.jsx)(Ye.I,{variant:"primary",icon:"link",isOpen:s,"aria-label":(0,Y.t)("explore.drop-down-menu.aria-label-links","Links"),children:(0,n.jsx)(Y.x6,{i18nKey:"explore.drop-down-menu.links",children:"Links"})})})},Rs=(e,s,a)=>{const r=e.tags.filter(l=>l.key===b.QW);return{serviceName:e.process.serviceName??"",profileTypeId:s?.profileTypeId??"",spanSelector:r.length===1&&r[0].value?r[0].value:"",explorationType:"flame-graph",timeRange:{from:a.from.toISOString(),to:a.to.toISOString()},datasource:{uid:s?.datasourceUid}}},ft=(e,s,a,r,o,l)=>({icon:r,className:l,type:s,linkModel:{...e,title:a,target:"_blank",origin:e.field,onClick:d=>{(0,S.rR)("grafana_traces_trace_view_span_link_clicked",{datasourceType:o,grafana_version:A.$.buildInfo.version,type:s,location:"spanDetails"}),e.onClick?e.onClick?.(d):Ds.test(e.href)?window.open(e.href,"_blank","noopener,noreferrer"):Is.Ny.push(e.href)}}});var Es=c(49185),Xt=c(75505),Yt=c(25229),ks=c(10020),Ls=c(36580),Ns=c(2863),Jt=c(28998);function js(e){const{span:s,traceToProfilesOptions:a,timeZone:r,traceFlameGraphs:o,setTraceFlameGraphs:l,setRedrawListView:d,traceDuration:u,traceName:g}=e,[f,{height:w}]=(0,Es.A)(),j=(0,R.of)(Ms),C=s.tags.filter(J=>J.key===b.QW),M=C.length>0?C[0].value:void 0,$=(0,h.useCallback)(()=>{const J=Math.floor(s.startTime/1e3)-3e4,Z=(s.startTime+s.duration)/1e3+3e4,se=(0,Yt.KQ)(Z),W=(0,Yt.KQ)(J);return{from:W,to:se,raw:{from:W,to:se}}},[s.duration,s.startTime]),H=async(J,Z)=>{const se=await(0,Jt.tR)().get(Z);if(se instanceof Ls.iy){const oe=(await(0,Xt.s)(se.query(J))).data.find(ge=>ge.name==="response");if(oe&&oe.length>1)return oe}},te=(0,h.useCallback)(async(J,Z,se)=>{let W="{}";if(Z.customQuery&&Z.query){const De={...(0,b.gt)(u,g,se.traceID),...(0,b.hv)(se),...(0,b.Cr)(se,Z)};W=(0,Ns.w)().replace(Z.query,De)}else{const De=Z.tags&&Z.tags.length>0?Z.tags:b.i0;W=`{${(0,b._o)(se,De)}}`}const oe={requestId:"span-flamegraph-requestId",interval:"2s",intervalMs:2e3,range:$(),scopedVars:{},app:Ge.Jk.Unknown,timezone:r,startTime:se.startTime,targets:[{labelSelector:W,groupBy:[],profileTypeId:Z.profileTypeId??"",queryType:"profile",spanSelector:[M],refId:"span-flamegraph-refId",datasource:{type:J.type,uid:J.uid}}]},ge=await H(oe,J.uid);ge&&ge.length>0&&l({...o,[M]:ge})},[$,M,l,r,u,o,g]);return(0,h.useEffect)(()=>{if(!Object.keys(o).includes(M)){let J;a&&a?.datasourceUid&&(J=(0,Jt.tR)().getInstanceSettings(a.datasourceUid)),a&&J&&te(J,a,s)}},[l,s,o,a,$,r,te,M]),(0,h.useEffect)(()=>{d({})},[w,d]),o[M]?(0,n.jsxs)("div",{className:j.flameGraph,ref:f,children:[(0,n.jsx)("div",{className:j.flameGraphTitle,children:(0,n.jsx)(Y.x6,{i18nKey:"explore.span-flame-graph.flame-graph",children:"Flame graph"})}),(0,n.jsx)(ks.A,{data:o[M],getTheme:()=>A.$.theme2,showFlameGraphOnly:!0,disableCollapsing:!0})]}):(0,n.jsx)(n.Fragment,{})}const Ms=()=>({flameGraph:(0,i.css)({label:"flameGraphInSpan",margin:"5px"}),flameGraphTitle:(0,i.css)({label:"flameGraphTitleInSpan",marginBottom:"5px",fontWeight:"bold"})}),Os=e=>({header:(0,i.css)({display:"flex",alignItems:"flex-start",justifyContent:"space-between",gap:"0 1rem",marginBottom:"0.25rem"}),listWrapper:(0,i.css)({overflow:"hidden"}),list:(0,i.css)({textAlign:"right"}),operationName:(0,i.css)({margin:0,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",flexBasis:"50%",flexGrow:0,flexShrink:0}),debugInfo:(0,i.css)({label:"debugInfo",display:"block",letterSpacing:"0.25px",margin:"0.5em 0 -0.75em",textAlign:"right"}),debugLabel:(0,i.css)({label:"debugLabel","&::before":{color:(0,m.R)(e,"#bbb"),content:"attr(data-label)"}}),debugValue:(0,i.css)({label:"debugValue",backgroundColor:"inherit",border:"none",color:(0,m.R)(e,"#888"),cursor:"pointer","&:hover":{color:(0,m.R)(e,"#333")}}),AccordianWarnings:(0,i.css)({label:"AccordianWarnings",background:(0,m.R)(e,"#fafafa"),border:`1px solid ${(0,m.R)(e,"#e4e4e4")}`,marginBottom:"0.25rem"}),AccordianWarningsHeader:(0,i.css)({label:"AccordianWarningsHeader",background:(0,m.R)(e,"#fff7e6"),padding:"0.25rem 0.5rem","&:hover":{background:(0,m.R)(e,"#ffe7ba")}}),AccordianWarningsHeaderOpen:(0,i.css)({label:"AccordianWarningsHeaderOpen",borderBottom:`1px solid ${(0,m.R)(e,"#e8e8e8")}`}),AccordianWarningsLabel:(0,i.css)({label:"AccordianWarningsLabel",color:(0,m.R)(e,"#d36c08")}),AccordianKeyValuesItem:(0,i.css)({marginBottom:e.spacing(.5)}),Textarea:(0,i.css)({wordBreak:"break-all",whiteSpace:"pre"}),LinkIcon:(0,i.css)({fontSize:"1.5em"}),linkList:(0,i.css)({display:"flex",flexWrap:"wrap",gap:"10px"})}),yt=(0,i.css)({margin:"-0.2rem 0.25rem 0 0"});function As(e){const{detailState:s,linksGetter:a,logItemToggle:r,logsToggle:o,processToggle:l,span:d,tagsToggle:u,traceStartTime:g,traceDuration:f,traceName:w,warningsToggle:j,stackTracesToggle:C,referencesToggle:M,referenceItemToggle:$,createSpanLink:H,createFocusSpanLink:te,datasourceType:J,traceFlameGraphs:Z,setTraceFlameGraphs:se,traceToProfilesOptions:W,setRedrawListView:oe,timeRange:ge,app:De}=e,{isTagsOpen:ye,isProcessOpen:je,logs:Ke,isWarningsOpen:at,references:de,isStackTracesOpen:Qe}=s,{operationName:rt,process:qe,duration:Ze,relativeStartTime:St,startTime:mt,traceID:ct,spanID:re,logs:et,tags:dt,warnings:ut,references:Ae,stackTraces:Ct}=d,{timeZone:Ce}=e;let tt=[{key:"svc",label:"Service:",value:qe.serviceName},{key:"duration",label:"Duration:",value:(0,Ie.a3)(Ze)},{key:"start",label:"Start Time:",value:(0,Ie.a3)(St)+Fs(mt,Ce)},...d.childSpanCount>0?[{key:"child_count",label:"Child Count:",value:d.childSpanCount}]:[]];const Ve=(0,R.of)(Os);d.kind&&tt.push({key:y.Nd,label:"Kind:",value:d.kind}),d.statusCode!==void 0&&tt.push({key:y.XQ,label:"Status:",value:Et.s[d.statusCode].toLowerCase()}),d.statusMessage&&tt.push({key:y.x9,label:"Status Message:",value:d.statusMessage}),d.instrumentationLibraryName&&tt.push({key:y.mT,label:"Library Name:",value:d.instrumentationLibraryName}),d.instrumentationLibraryVersion&&tt.push({key:y.Zh,label:"Library Version:",value:d.instrumentationLibraryVersion}),d.traceState&&tt.push({key:y.gz,label:"Trace State:",value:d.traceState});const nr=Cs({span:d,createSpanLink:H,datasourceType:J,traceToProfilesOptions:W,timeRange:ge,app:De}),Js=te(ct,re);return(0,n.jsxs)("div",{"data-testid":"span-detail-component",children:[(0,n.jsxs)("div",{className:Ve.header,children:[(0,n.jsx)("h2",{className:Ve.operationName,title:rt,children:rt}),(0,n.jsx)("div",{className:Ve.listWrapper,children:(0,n.jsx)(E,{className:Ve.list,divider:!0,items:tt})})]}),(0,n.jsx)("div",{className:Ve.linkList,children:nr}),(0,n.jsx)(p.c,{spacing:1}),(0,n.jsxs)("div",{children:[(0,n.jsxs)("div",{children:[(0,n.jsx)(Lt,{data:dt,label:(0,Y.t)("explore.span-detail.label-span-attributes","Span attributes"),linksGetter:a,isOpen:ye,onToggle:()=>u(re)}),qe.tags&&(0,n.jsx)(Lt,{className:Ve.AccordianKeyValuesItem,data:qe.tags,label:(0,Y.t)("explore.span-detail.label-resource-attributes","Resource attributes"),linksGetter:a,isOpen:je,onToggle:()=>l(re)})]}),et&&et.length>0&&(0,n.jsx)(qt,{linksGetter:a,logs:et,isOpen:Ke.isOpen,openedItems:Ke.openedItems,onToggle:()=>o(re),onItemToggle:Oe=>r(re,Oe),timestamp:g}),ut&&ut.length>0&&(0,n.jsx)(nt,{className:Ve.AccordianWarnings,headerClassName:Ve.AccordianWarningsHeader,label:(0,n.jsx)("span",{className:Ve.AccordianWarningsLabel,children:(0,n.jsx)(Y.x6,{i18nKey:"explore.span-detail.warnings",children:"Warnings"})}),data:ut,isOpen:at,onToggle:()=>j(re)}),Ct?.length?(0,n.jsx)(nt,{label:(0,Y.t)("explore.span-detail.label-stack-trace","Stack trace"),data:Ct,isOpen:Qe,TextComponent:Oe=>{let qs;return Oe.data?.length>1?qs=Oe.data.map((ar,rr)=>`StackTrace ${rr+1}:
${ar}`).join(`
`):qs=Oe.data?.[0],(0,n.jsx)(v.f,{className:Ve.Textarea,style:{cursor:"unset"},readOnly:!0,cols:10,rows:10,value:qs})},onToggle:()=>C(re)}):null,Ae&&Ae.length>0&&(Ae.length>1||Ae[0].refType!=="CHILD_OF")&&(0,n.jsx)(pe,{data:Ae,isOpen:de.isOpen,openedItems:de.openedItems,onToggle:()=>M(re),onItemToggle:Oe=>$(re,Oe),createFocusSpanLink:te}),d.tags.some(Oe=>Oe.key===b.QW)&&(0,n.jsx)(js,{span:d,timeZone:Ce,traceFlameGraphs:Z,setTraceFlameGraphs:se,traceToProfilesOptions:W,setRedrawListView:oe,traceDuration:f,traceName:w}),(0,n.jsxs)("small",{className:Ve.debugInfo,children:[(0,n.jsx)("a",{...Js,onClick:Oe=>{Js.onClick&&Oe.button===0&&(!Oe.currentTarget.target||Oe.currentTarget.target==="_self")&&!(Oe.metaKey||Oe.altKey||Oe.ctrlKey||Oe.shiftKey)&&(Oe.preventDefault(),Js.onClick(Oe))},children:(0,n.jsx)(Ee.I,{name:"link",className:ae()(yt,Ve.LinkIcon)})}),(0,n.jsx)("span",{className:Ve.debugLabel,"data-label":"SpanID:"})," ",re]})]})]})}const Fs=(e,s)=>{const a=(0,zt.LE)(e/1e3,{timeZone:s,defaultWithMS:!0}),r=a.split(" ");return` (${r[1]?r[1]:a})`},kt=e=>({container:(0,i.css)({textOverflow:"ellipsis"}),header:(0,i.css)({label:"header",cursor:"pointer",overflow:"hidden",padding:"0.25em 0.1em",textOverflow:"ellipsis",whiteSpace:"nowrap","&:hover":{background:(0,m.R)(e,"#e8e8e8")}}),headerEmpty:(0,i.css)({label:"headerEmpty",background:"none",cursor:"initial"}),headerHighContrast:(0,i.css)({label:"headerHighContrast","&:hover":{background:(0,m.R)(e,"#ddd")}}),emptyIcon:(0,i.css)({label:"emptyIcon",color:(0,m.R)(e,"#aaa")}),summary:(0,i.css)({label:"summary",display:"inline",listStyle:"none",padding:0}),summaryItem:(0,i.css)({label:"summaryItem",display:"inline",paddingRight:"0.5rem",borderRight:`1px solid ${(0,m.R)(e,"#ddd")}`,"&:last-child":{paddingRight:0,borderRight:"none"}}),summaryLabel:(0,i.css)({label:"summaryLabel",color:(0,m.R)(e,"#777")}),summaryDelim:(0,i.css)({label:"summaryDelim",color:(0,m.R)(e,"#bbb"),padding:"0 0.2em"})});function Ps({data:e=null}){const s=(0,R.of)(kt);return!Array.isArray(e)||!e.length?null:(0,n.jsx)("ul",{className:s.summary,children:e.map((a,r)=>(0,n.jsxs)("li",{className:s.summaryItem,children:[(0,n.jsx)("span",{className:s.summaryLabel,children:a.key}),(0,n.jsx)("span",{className:s.summaryDelim,children:"="}),String(a.value)]},`${a.key}-${r}`))})}function Lt({className:e=null,data:s,logName:a,highContrast:r=!1,interactive:o=!0,isOpen:l,label:d,linksGetter:u,onToggle:g=null}){const f=(!Array.isArray(s)||!s.length)&&!a,w=(0,R.of)(kt),j=ae()(yt,{[w.emptyIcon]:f});let C=null,M=null;const $=a?[{key:"event name",value:a},...s]:s;o&&(C=l?(0,n.jsx)(Ee.I,{name:"angle-down",className:j}):(0,n.jsx)(Ee.I,{name:"angle-right",className:j}),M={"aria-checked":l,onClick:f?null:g,role:"switch"});const H=s.length>0&&!l;return(0,n.jsxs)("div",{className:ae()(e,w.container),children:[(0,n.jsxs)("div",{className:ae()(w.header,{[w.headerEmpty]:f,[w.headerHighContrast]:r&&!f}),...M,"data-testid":"AccordianKeyValues--header",children:[C,(0,n.jsxs)("strong",{"data-test":ys,children:[d,H&&":"]}),H&&(0,n.jsx)("span",{className:(0,i.css)({marginLeft:"0.7em"}),children:(0,n.jsx)(Ps,{data:s})})]}),l&&(0,n.jsx)(bs.Ay,{data:$,linksGetter:u})]})}const Bs=e=>({AccordianLogs:(0,i.css)({label:"AccordianLogs",border:`1px solid ${(0,m.R)(e,"#d8d8d8")}`,position:"relative",marginBottom:"0.25rem"}),AccordianLogsHeader:(0,i.css)({label:"AccordianLogsHeader",background:(0,m.R)(e,"#e4e4e4"),color:"inherit",display:"block",padding:"0.25rem 0.5rem","&:hover":{background:(0,m.R)(e,"#dadada")}}),AccordianLogsContent:(0,i.css)({label:"AccordianLogsContent",background:(0,m.R)(e,"#f0f0f0"),borderTop:`1px solid ${(0,m.R)(e,"#d8d8d8")}`,padding:"0.5rem 0.5rem 0.25rem 0.5rem"}),AccordianLogsFooter:(0,i.css)({label:"AccordianLogsFooter",color:(0,m.R)(e,"#999")}),AccordianKeyValuesItem:(0,i.css)({marginBottom:e.spacing(.5)}),parenthesis:(0,i.css)({color:`${(0,m.R)(e,"#777")}`})});function qt({interactive:e=!0,isOpen:s,linksGetter:a,logs:r,openedItems:o,onItemToggle:l,onToggle:d,timestamp:u}){let g=null,f="span",w=null;e&&(g=s?(0,n.jsx)(Ee.I,{name:"angle-down",className:yt}):(0,n.jsx)(Ee.I,{name:"angle-right",className:"u-align-icon"}),f="a",w={"aria-checked":s,onClick:d,role:"switch"});const j=(0,R.of)(Bs);return(0,n.jsxs)("div",{className:j.AccordianLogs,children:[(0,n.jsxs)(f,{className:j.AccordianLogsHeader,...w,children:[g," ",(0,n.jsx)("strong",{children:"Events"})," (",r.length,")"]}),s&&(0,n.jsxs)("div",{className:j.AccordianLogsContent,children:[(0,Me.sortBy)(r,"timestamp").map((C,M)=>{const $=(0,Ie.a3)(C.timestamp-u),H=C.name&&C.name.length>20,te=C.name&&H?C.name.slice(0,20)+"...":C.name,J=te?(0,n.jsxs)("span",{children:[$," ",(0,n.jsxs)("span",{children:["(",te,")"]})]}):$;return(0,n.jsx)(Lt,{className:M<r.length-1?j.AccordianKeyValuesItem:null,data:C.fields||[],logName:H?C.name:void 0,highContrast:!0,interactive:e,isOpen:o?o.has(C):!1,label:J,linksGetter:a,onToggle:e&&l?()=>l(C):null},`${C.timestamp}-${M}`)}),(0,n.jsx)("small",{className:j.AccordianLogsFooter,children:"Event timestamps are relative to the start time of the full trace."})]})]})}const Pt=e=>({wrapper:(0,i.css)({label:"wrapper",bottom:0,left:0,position:"absolute",right:0,top:0,overflow:"hidden",zIndex:0}),bar:(0,i.css)({label:"bar",borderRadius:e.shape.radius.default,minWidth:"2px",position:"absolute",height:"36%",top:"32%"}),rpc:(0,i.css)({label:"rpc",position:"absolute",top:"35%",bottom:"35%",zIndex:1}),label:(0,i.css)({label:"label",color:"#aaa",fontSize:"12px",fontFamily:"'Helvetica Neue', Helvetica, Arial, sans - serif",lineHeight:"1em",whiteSpace:"nowrap",padding:"0 0.5em",position:"absolute"}),logMarker:(0,i.css)({label:"logMarker",backgroundColor:(0,m.R)(e,"#2c3235"),cursor:"pointer",height:"60%",minWidth:"1px",position:"absolute",top:"20%","&:hover":{backgroundColor:(0,m.R)(e,"#464c54")},"&::before, &::after":{content:"''",position:"absolute",top:0,bottom:0,right:0,border:"1px solid transparent"},"&::after":{left:0}}),criticalPath:(0,i.css)({position:"absolute",top:"45%",height:"11%",zIndex:2,overflow:"hidden",background:(0,m.R)(e,"#f1f1f1"),borderLeft:`1px solid ${(0,m.R)(e,"#2c3235")}`,borderRight:`1px solid ${(0,m.R)(e,"#2c3235")}`})});function Tt(e){return`${(e*100).toFixed(1)}%`}function wt(e){return`${e*100}%`}function es({criticalPath:e,viewEnd:s,viewStart:a,getViewedBounds:r,color:o,shortLabel:l,longLabel:d,onClick:u,rpc:g,traceStartTime:f,span:w,className:j,labelClassName:C}){const[M,$]=(0,h.useState)(l),H=()=>$(l),te=()=>$(d),J=(0,Me.groupBy)(w.logs,se=>{const W=r(se.timestamp,se.timestamp).start;return Tt(Math.round(W*500)/500)}),Z=(0,R.of)(Pt);return(0,n.jsxs)("div",{className:ae()(Z.wrapper,j),onBlur:H,onClick:u,onFocus:te,onMouseOut:H,onMouseOver:te,"aria-hidden":!0,"data-testid":Kt.Tp.components.TraceViewer.spanBar,children:[(0,n.jsx)("div",{"aria-label":M,className:ae()(Z.bar),style:{background:o,left:Tt(a),width:Tt(s-a)},children:(0,n.jsx)("div",{className:ae()(Z.label,C),"data-testid":"SpanBar--label",children:M})}),(0,n.jsx)("div",{children:Object.keys(J).map(se=>(0,n.jsx)(xs,{content:(0,n.jsx)(qt,{interactive:!1,isOpen:!0,logs:J[se],timestamp:f}),children:(0,n.jsx)("div",{"data-testid":"SpanBar--logMarker",className:ae()(Z.logMarker),style:{left:se}})},se))}),g&&(0,n.jsx)("div",{className:ae()(Z.rpc),style:{background:g.color,left:Tt(g.viewStart),width:Tt(g.viewEnd-g.viewStart)}}),e?.map((se,W)=>{const oe=r(se.section_start,se.section_end),ge=oe.start,De=oe.end,ye=`${se.spanId}-${W}`;return(0,n.jsx)(gt.m,{placement:"top",content:(0,n.jsxs)("div",{children:["A segment on the ",(0,n.jsx)("em",{children:"critical path"})," of the overall trace / request / workflow."]}),children:(0,n.jsx)("div",{"data-testid":"SpanBar--criticalPath",className:Z.criticalPath,style:{left:wt(ge),width:wt(De-ge)}})},ye)})]})}const tn=h.memo(es);var ts=c(94535),sn=c(97375);const Bt=(e,s,a,r)=>(e.sort(function(o,l){return(o.title||"link").toLowerCase().localeCompare((l.title||"link").toLowerCase())}),e.map((o,l)=>(0,n.jsx)(ts.D,{label:o.title||"Link",onClick:o.onClick?d=>{(0,S.rR)("grafana_traces_trace_view_span_link_clicked",{datasourceType:r,grafana_version:A.$.buildInfo.version,type:o.type,location:"menu"}),d?.preventDefault(),o.onClick(d),a()}:void 0,url:o.href,target:o.target,className:s.menuItem},l))),_s=({links:e,datasourceType:s,color:a})=>{const r=(0,R.of)(()=>Vs(a)),[o,l]=(0,h.useState)(!1),[d,u]=(0,h.useState)({x:0,y:0}),g=()=>l(!1);return(0,n.jsxs)("div",{"data-testid":"SpanLinksMenu",className:r.wrapper,children:[(0,n.jsx)("button",{onClick:f=>{l(!0),u({x:f.clientX,y:f.clientY})},className:r.button,children:(0,n.jsx)(Ee.I,{name:"link",className:r.icon})}),o?(0,n.jsx)(sn.t,{onClose:()=>l(!1),renderMenuItems:()=>Bt(e,r,g,s),focusOnOpen:!1,x:d.x,y:d.y}):null]})},Vs=e=>({wrapper:(0,i.css)({border:"none",background:`${e}10`,borderBottom:`1px solid ${e}CF`,paddingRight:"4px"}),button:(0,i.css)({background:"transparent",border:"none",padding:0}),icon:(0,i.css)({background:"transparent",border:"none",padding:0}),menuItem:(0,i.css)({maxWidth:"60ch",overflow:"hidden"})});function _t(e){return(0,Me.get)((0,Me.find)(e.references,({span:s,refType:a})=>s&&s.spanID&&(a==="CHILD_OF"||a==="FOLLOWS_FROM")),"span")}function ss(e){const s=[];if(!e)return s;let a=_t(e);for(;a;)s.push(a.spanID),a=_t(a);return s}const Hs=(0,D.N)(e=>({SpanTreeOffset:(0,i.css)({label:"SpanTreeOffset",color:(0,m.R)(e,"#000"),position:"relative"}),SpanTreeOffsetParent:(0,i.css)({label:"SpanTreeOffsetParent","&:hover":{cursor:"pointer"}}),indentGuide:(0,i.css)({label:"indentGuide",paddingRight:"1rem",height:"100%",display:"inline-flex",[e.transitions.handleMotion("no-preference")]:{transition:"padding 300ms ease-out"},"&::before":{content:'""',paddingLeft:"1px",backgroundColor:(0,m.R)(e,"lightgrey")}}),indentGuideActive:(0,i.css)({label:"indentGuideActive","&::before":{backgroundColor:(0,m.R)(e,"#777")}}),indentGuideThin:(0,i.css)({paddingRight:"0.3rem"}),iconWrapper:(0,i.css)({label:"iconWrapper",position:"absolute",right:0})}));class $s extends h.PureComponent{constructor(s){super(s),this.handleMouseLeave=(a,r)=>{(!(a.relatedTarget instanceof HTMLSpanElement)||(0,Me.get)(a,"relatedTarget.dataset.ancestorId")!==r)&&this.props.removeHoverIndentGuideId(r)},this.handleMouseEnter=(a,r)=>{(!(a.relatedTarget instanceof HTMLSpanElement)||(0,Me.get)(a,"relatedTarget.dataset.ancestorId")!==r)&&this.props.addHoverIndentGuideId(r)},this.ancestorIds=ss(s.span),this.ancestorIds.push("root"),this.ancestorIds.reverse()}static{this.displayName="UnthemedSpanTreeOffset"}static{this.defaultProps={childrenVisible:!1,showChildrenIcon:!0}}render(){const{childrenVisible:s,onClick:a,showChildrenIcon:r,span:o,theme:l,visibleSpanIds:d}=this.props,{hasChildren:u,spanID:g}=o,f=u?{onClick:a,role:"switch","aria-checked":s}:null,w=r&&u&&(s?(0,n.jsx)(Ee.I,{name:"angle-down","data-testid":"icon-arrow-down",size:"sm"}):(0,n.jsx)(Ee.I,{name:"angle-right","data-testid":"icon-arrow-right",size:"sm"})),j=Hs(l);return(0,n.jsxs)("span",{className:ae()(j.SpanTreeOffset,{[j.SpanTreeOffsetParent]:u}),...f,children:[this.ancestorIds.map((C,M)=>(0,n.jsx)("span",{className:ae()(j.indentGuide,{[j.indentGuideActive]:this.props.hoverIndentGuideIds.has(C),[j.indentGuideThin]:M!==this.ancestorIds.length-1&&C!=="root"&&!d.includes(C)}),"data-ancestor-id":C,"data-testid":"SpanTreeOffset--indentGuide",onMouseEnter:$=>this.handleMouseEnter($,C),onMouseLeave:$=>this.handleMouseLeave($,C)},C)),w&&(0,n.jsx)("span",{className:j.iconWrapper,onMouseEnter:C=>this.handleMouseEnter(C,g),onMouseLeave:C=>this.handleMouseLeave(C,g),"data-testid":"icon-wrapper",children:w})]})}}const ns=(0,R.cV)($s),as="spanBar",rs="spanBarLabel",Nt="nameWrapper",nn="nameWrapperMatchingFilter",Dt="jaegerView",an="nameColumn",Cn=(0,D.N)((e,s)=>{const a={label:"flash",flash:(0,i.keyframes)`
    from {
      background-color: ${(0,m.R)(e,"#68b9ff")};
    }
    to {
      background-color: 'default';
    }
  `},r=s?"":(0,m.R)(e,"#fffce4");return{nameWrapper:(0,i.css)({label:"nameWrapper",lineHeight:"27px",overflow:"hidden",display:"flex"}),nameWrapperMatchingFilter:(0,i.css)({label:"nameWrapperMatchingFilter",backgroundColor:r}),nameColumn:(0,i.css)({label:"nameColumn",position:"relative",whiteSpace:"nowrap",zIndex:1,"&:hover":{zIndex:1}}),endpointName:(0,i.css)({label:"endpointName",color:(0,m.R)(e,"#484848"),fontSize:"0.9em"}),view:(0,i.css)({label:"view",position:"relative"}),viewExpanded:(0,i.css)({label:"viewExpanded",background:(0,m.R)(e,"#f8f8f8"),outline:`1px solid ${(0,m.R)(e,"#ddd")}`}),viewExpandedAndMatchingFilter:(0,i.css)({label:"viewExpandedAndMatchingFilter",background:(0,m.R)(e,"#fff3d7"),outline:`1px solid ${(0,m.R)(e,"#ddd")}`}),row:(0,i.css)({label:"row",fontSize:"0.9em",[`&:hover .${as}`]:{opacity:1},[`&:hover .${rs}`]:{color:(0,m.R)(e,"#000")},[`&:hover .${Nt}`]:{background:`linear-gradient(
          90deg,
          ${(0,m.R)(e,"#fafafa")},
          ${(0,m.R)(e,"#f8f8f8")} 75%,
          ${(0,m.R)(e,"#eee")}
        )`},[`&:hover .${Dt}`]:{backgroundColor:(0,m.R)(e,"#f5f5f5"),outline:`1px solid ${(0,m.R)(e,"#ddd")}`}}),rowClippingLeft:(0,i.css)({label:"rowClippingLeft",[`& .${an}::before`]:{content:'" "',height:"100%",position:"absolute",width:"6px",backgroundImage:`linear-gradient(
          to right,
          ${(0,m.R)(e,"rgba(25, 25, 25, 0.25)")},
          ${(0,m.R)(e,"rgba(32, 32, 32, 0)")}
        )`,left:"100%",zIndex:-1}}),rowClippingRight:(0,i.css)({label:"rowClippingRight",[`& .${Dt}::before`]:{content:'" "',height:"100%",position:"absolute",width:"6px",backgroundImage:`linear-gradient(
          to left,
          ${(0,m.R)(e,"rgba(25, 25, 25, 0.25)")},
          ${(0,m.R)(e,"rgba(25, 25, 25, 0.25)")}
        )`,right:"0%",zIndex:1}}),rowExpanded:(0,i.css)({label:"rowExpanded",[`& .${as}`]:{opacity:1},[`& .${rs}`]:{color:(0,m.R)(e,"#000")},[`& .${Nt}, &:hover .${Nt}`]:{background:(0,m.R)(e,"#f0f0f0"),boxShadow:`0 1px 0 ${(0,m.R)(e,"#ddd")}`},[`& .${nn}`]:{background:(0,m.R)(e,"#fff3d7")},[`&:hover .${Dt}`]:{background:(0,m.R)(e,"#eee")}}),rowMatchingFilter:(0,i.css)({label:"rowMatchingFilter",[`&:hover .${Nt}`]:{background:`linear-gradient(
          90deg,
          ${(0,m.R)(e,"#fffbde")},
          ${(0,m.R)(e,"#fffbde")} 75%,
          ${(0,m.R)(e,"#f7f1c6")}
        )`},[`&:hover .${Dt}`]:{backgroundColor:(0,m.R)(e,"#f7f1c6"),outline:`1px solid ${(0,m.R)(e,"#ddd")}`}}),rowFocused:(0,i.css)({label:"rowFocused",backgroundColor:(0,m.R)(e,"#cbe7ff"),[e.transitions.handleMotion("no-preference","reduce")]:{animation:`${a.flash} 1s cubic-bezier(0.12, 0, 0.39, 0)`},[`& .${Nt}, .${Dt}, .${nn}`]:{backgroundColor:(0,m.R)(e,"#cbe7ff"),animation:`${a.flash} 1s cubic-bezier(0.12, 0, 0.39, 0)`},[`& .${as}`]:{opacity:1},[`& .${rs}`]:{color:(0,m.R)(e,"#000")},"&:hover .${nameWrapperClassName}, :hover .${viewClassName}":{background:(0,m.R)(e,"#d5ebff"),boxShadow:`0 1px 0 ${(0,m.R)(e,"#ddd")}`}}),rowExpandedAndMatchingFilter:(0,i.css)({label:"rowExpandedAndMatchingFilter",[`&:hover .${Dt}`]:{background:(0,m.R)(e,"#ffeccf")}}),name:(0,i.css)({label:"name",color:(0,m.R)(e,"#000"),cursor:"pointer",flex:"1 1 auto",outline:"none",overflowY:"hidden",overflowX:"auto",paddingLeft:"4px",paddingRight:"0.25em",position:"relative","-ms-overflow-style":"none",scrollbarWidth:"none","&::-webkit-scrollbar":{display:"none"},"&:focus":{textDecoration:"none"},"&:hover > span":{color:(0,m.R)(e,"#000")},textAlign:"left",background:"transparent",border:"none",borderBottomWidth:"1px",borderBottomStyle:"solid"}),nameDetailExpanded:(0,i.css)({label:"nameDetailExpanded","&::before":{bottom:0}}),svcName:(0,i.css)({label:"svcName",fontSize:"0.9em",fontWeight:"bold",marginRight:"0.25rem"}),svcNameChildrenCollapsed:(0,i.css)({label:"svcNameChildrenCollapsed",fontWeight:"bold",fontStyle:"italic"}),errorIcon:(0,i.css)({label:"errorIcon",borderRadius:"6.5px",color:(0,m.R)(e,"#fff"),fontSize:"0.85em",marginRight:"0.25rem",padding:"1px"}),rpcColorMarker:(0,i.css)({label:"rpcColorMarker",borderRadius:"6.5px",display:"inline-block",fontSize:"0.85em",height:"1em",marginRight:"0.25rem",padding:"1px",width:"1em",verticalAlign:"middle"}),labelRight:(0,i.css)({label:"labelRight",left:"100%"}),labelLeft:(0,i.css)({label:"labelLeft",right:"100%"})}});class Rn extends h.PureComponent{constructor(){super(...arguments),this._detailToggle=()=>{this.props.onDetailToggled(this.props.span.spanID)},this._childrenToggle=()=>{this.props.onChildrenToggled(this.props.span.spanID)},this.getSpanBarLabel=(s,a,r)=>{const o=a?.type??"";if(o===Ot)return"";if(o===""||o===Wt)return`(${r})`;if(o===At){const l=a?.tag?.trim()??"";if(l!==""&&s.tags){const d=s.tags?.find(g=>g.key===l);if(d)return`(${d.value})`;const u=s.process?.tags?.find(g=>g.key===l);if(u)return`(${u.value})`}}return""}}static{this.displayName="UnthemedSpanBarRow"}static{this.defaultProps={className:"",rpc:null}}render(){const{className:s,color:a,spanBarOptions:r,columnDivision:o,isChildrenExpanded:l,isDetailExpanded:d,isMatchingFilter:u,showSpanFilterMatchesOnly:g,isFocused:f,numTicks:w,rpc:j,noInstrumentedServer:C,showErrorIcon:M,getViewedBounds:$,traceStartTime:H,span:te,hoverIndentGuideIds:J,addHoverIndentGuideId:Z,removeHoverIndentGuideId:se,clippingLeft:W,clippingRight:oe,theme:ge,createSpanLink:De,datasourceType:ye,showServiceName:je,visibleSpanIds:Ke,criticalPath:at}=this.props,{duration:de,hasChildren:Qe,operationName:rt,process:{serviceName:qe}}=te,Ze=(0,Ie.a3)(de),St=$(te.startTime,te.startTime+te.duration),mt=St.start,ct=St.end,re=Cn(ge,g),et=`${qe}::${rt}`;let dt,ut;return mt>1-ct?(dt=`${et} | ${Ze}`,ut=re.labelLeft):(dt=`${Ze} | ${et}`,ut=re.labelRight),(0,n.jsxs)(Te,{className:ae()(re.row,{[re.rowExpanded]:d,[re.rowMatchingFilter]:u,[re.rowExpandedAndMatchingFilter]:u&&d,[re.rowFocused]:f,[re.rowClippingLeft]:W,[re.rowClippingRight]:oe},s),children:[(0,n.jsx)(Te.Cell,{className:ae()(re.nameColumn,an),width:o,children:(0,n.jsxs)("div",{className:ae()(re.nameWrapper,Nt,{[re.nameWrapperMatchingFilter]:u,nameWrapperMatchingFilter:u}),children:[(0,n.jsx)(ns,{onClick:Qe?this._childrenToggle:void 0,childrenVisible:l,span:te,hoverIndentGuideIds:J,addHoverIndentGuideId:Z,removeHoverIndentGuideId:se,visibleSpanIds:Ke}),(0,n.jsxs)("button",{type:"button",className:ae()(re.name,{[re.nameDetailExpanded]:d}),"aria-checked":d,title:et,onClick:this._detailToggle,role:"switch",style:{background:`${a}10`,borderBottomColor:`${a}CF`},tabIndex:0,children:[M&&(0,n.jsx)(Ee.I,{name:"exclamation-circle",style:{backgroundColor:te.errorIconColor?(0,m.R)(ge,te.errorIconColor):(0,m.R)(ge,"#db2828")},className:re.errorIcon}),je&&(0,n.jsx)("span",{className:ae()(re.svcName,{[re.svcNameChildrenCollapsed]:Qe&&!l}),children:`${qe} `}),j&&(0,n.jsxs)("span",{children:[(0,n.jsx)(Ee.I,{name:"arrow-right"})," ",(0,n.jsx)("i",{className:re.rpcColorMarker,style:{background:j.color}}),j.serviceName]}),C&&(0,n.jsxs)("span",{children:[(0,n.jsx)(Ee.I,{name:"arrow-right"})," ",(0,n.jsx)("i",{className:re.rpcColorMarker,style:{background:C.color}}),C.serviceName]}),(0,n.jsx)("span",{className:re.endpointName,children:j?j.operationName:rt}),(0,n.jsxs)("span",{className:re.endpointName,children:[" ",this.getSpanBarLabel(te,r,Ze)]})]}),De&&(()=>{const Ae=De(te),Ct=Ae?.length||0;return Ae&&Ct===1?Ae[0]?(0,n.jsx)("a",{href:Ae[0].href,target:"_blank",style:{background:`${a}10`,borderBottom:`1px solid ${a}CF`,paddingRight:"4px"},rel:"noopener noreferrer",onClick:Ae[0].onClick?Ce=>{!(Ce.ctrlKey||Ce.metaKey||Ce.shiftKey)&&Ae[0].onClick&&(Ce.preventDefault(),Ae[0].onClick(Ce))}:void 0,children:Ae[0].content}):null:Ae&&Ct>1?(0,n.jsx)(_s,{links:Ae,datasourceType:ye,color:a}):null})()]})}),(0,n.jsxs)(Te.Cell,{className:ae()(re.view,Dt,{[re.viewExpanded]:d,[re.viewExpandedAndMatchingFilter]:u&&d}),"data-testid":"span-view",style:{cursor:"pointer"},width:1-o,onClick:this._detailToggle,children:[(0,n.jsx)(ee,{numTicks:w}),(0,n.jsx)(tn,{criticalPath:at,rpc:j,viewStart:mt,viewEnd:ct,getViewedBounds:$,color:a,shortLabel:Ze,longLabel:dt,traceStartTime:H,span:te,labelClassName:`${rs} ${ut}`,className:as})]})]})}}const En=(0,R.cV)(Rn);var bt=c(45861);const kn=(0,D.N)(e=>({expandedAccent:(0,i.css)({cursor:"pointer",height:"100%",overflow:"hidden",position:"absolute",width:"100%","&::before":{borderLeft:"1px solid",pointerEvents:"none",width:"1000px"},"&::after":{borderRight:"1000px solid",borderColor:"inherit",cursor:"pointer",opacity:.2},"&::before, &::after":{borderColor:"inherit",content:'" "',position:"absolute",height:"100%"},"&:hover::after":{opacity:.35}}),infoWrapper:(0,i.css)({label:"infoWrapper",border:`1px solid ${(0,m.R)(e,"#d3d3d3")}`,borderTop:"3px solid",padding:"0.75rem"})}));class Ln extends h.PureComponent{constructor(){super(...arguments),this._detailToggle=()=>{this.props.onDetailToggled(this.props.span.spanID)},this._linksGetter=(s,a)=>{const{linksGetter:r,span:o}=this.props;return r(o,s,a)}}render(){const{color:s,columnDivision:a,detailState:r,logItemToggle:o,logsToggle:l,processToggle:d,referenceItemToggle:u,referencesToggle:g,warningsToggle:f,stackTracesToggle:w,span:j,traceToProfilesOptions:C,timeZone:M,tagsToggle:$,traceStartTime:H,traceDuration:te,traceName:J,hoverIndentGuideIds:Z,addHoverIndentGuideId:se,removeHoverIndentGuideId:W,theme:oe,createSpanLink:ge,focusedSpanId:De,createFocusSpanLink:ye,datasourceType:je,visibleSpanIds:Ke,traceFlameGraphs:at,setTraceFlameGraphs:de,setRedrawListView:Qe,timeRange:rt,app:qe}=this.props,Ze=kn(oe);return(0,n.jsxs)(Te,{children:[(0,n.jsxs)(Te.Cell,{width:a,style:{overflow:"hidden"},children:[(0,n.jsx)(ns,{span:j,showChildrenIcon:!1,hoverIndentGuideIds:Z,addHoverIndentGuideId:se,removeHoverIndentGuideId:W,visibleSpanIds:Ke}),(0,n.jsx)(bt.$n,{fill:"text",onClick:this._detailToggle,className:ae()(Ze.expandedAccent,(0,bt.my)(oe)),style:{borderColor:s},"data-testid":"detail-row-expanded-accent"})]}),(0,n.jsx)(Te.Cell,{width:1-a,children:(0,n.jsx)("div",{className:Ze.infoWrapper,style:{borderTopColor:s},children:(0,n.jsx)(As,{detailState:r,linksGetter:this._linksGetter,logItemToggle:o,logsToggle:l,processToggle:d,referenceItemToggle:u,referencesToggle:g,warningsToggle:f,stackTracesToggle:w,span:j,traceToProfilesOptions:C,timeZone:M,tagsToggle:$,traceStartTime:H,traceDuration:te,traceName:J,createSpanLink:ge,focusedSpanId:De,createFocusSpanLink:ye,datasourceType:je,traceFlameGraphs:at,setTraceFlameGraphs:de,setRedrawListView:Qe,timeRange:rt,app:qe})})})]})}}const Nn=(0,R.cV)(Ln),Ws=(0,D.N)(()=>({rowsWrapper:(0,i.css)({width:"100%"}),row:(0,i.css)({width:"100%"}),scrollToTopButton:(0,i.css)({display:"flex",flexDirection:"column",justifyContent:"center",alignItems:"center",width:"40px",height:"40px",position:"absolute",bottom:"30px",right:"30px",zIndex:1})})),Ks={bar:28,detail:161,detailWithLogs:197},jn=5,is=33;function Mn(e,s,a,r,o,l,d){if(!e)return[];o&&r&&(e=e.filter(f=>r.has(f.spanID))),l&&d&&(e=e.filter(f=>d.find(w=>w.spanId===f.spanID)));let u=null;const g=[];for(let f=0;f<e.length;f++){const w=e[f],{spanID:j,depth:C}=w;let M=!1;u!=null&&(C>=u?M=!0:u=null),!M&&(s.has(j)&&(u=C+1),g.push({span:w,isDetail:!1,spanIndex:f}),a.has(j)&&g.push({span:w,isDetail:!0,spanIndex:f}))}return g}function On(e){const[s,a]=e;return{left:s>0,right:a<1}}function An(e,s,a,r,o,l,d){return e?Mn(e.spans,s,a,r,o,l,d):[]}function Fn(e){const s=new Map;return e&&e.spans.forEach(a=>{a.childSpanIds.length&&s.set(a.spanID,a.childSpanIds)}),s}const Pn=(0,vt.default)(An),Bn=(0,vt.default)(me,Me.isEqual),_n=(0,vt.default)(On,Me.isEqual),Vn=(0,vt.default)(Fn);class Hn extends h.Component{constructor(){super(...arguments),this.hasScrolledToSpan=!1,this.getViewRange=()=>this.props.currentViewRangeTime,this.getSearchedSpanIDs=()=>this.props.findMatchesIDs,this.getCollapsedChildren=()=>this.props.childrenHiddenIDs,this.mapRowIndexToSpanIndex=s=>this.getRowStates()[s].spanIndex,this.mapSpanIndexToRowIndex=s=>{const a=this.getRowStates().length;for(let r=0;r<a;r++){const{spanIndex:o}=this.getRowStates()[r];if(o===s)return r}throw new Error(`unable to find row for span index: ${s}`)},this.setListView=s=>{this.listView=s},this.getKeyFromIndex=s=>{const{isDetail:a,span:r}=this.getRowStates()[s];return`${r.traceID}--${r.spanID}--${a?"detail":"bar"}`},this.getIndexFromKey=s=>{const a=s.split("--"),r=a[0],o=a[1],l=a[2]==="detail",d=this.getRowStates().length;for(let u=0;u<d;u++){const{span:g,isDetail:f}=this.getRowStates()[u];if(g.spanID===o&&g.traceID===r&&f===l)return u}return-1},this.getRowHeight=s=>{const{span:a,isDetail:r}=this.getRowStates()[s];return r?Array.isArray(a.logs)&&a.logs.length?Ks.detailWithLogs:Ks.detail:Ks.bar},this.renderRow=(s,a,r,o)=>{const{isDetail:l,span:d,spanIndex:u}=this.getRowStates()[r],g=Math.max((this.listView?.getTopVisibleIndex()||0)-is,0),f=(this.listView?.getBottomVisibleIndex()||0)+is,w=this.getVisibleSpanIds(g,f);return l?this.renderSpanDetailRow(d,s,a,o,w):this.renderSpanBarRow(d,u,s,a,o,w)},this.scrollToSpan=(s,a)=>{if(a==null)return;const r=this.getRowStates().findIndex(o=>o.span.spanID===a);r>=0&&this.listView?.scrollToIndex(r,s)},this.scrollToTop=()=>{const{topOfViewRef:s,datasourceType:a,trace:r}=this.props;s?.current?.scrollIntoView({behavior:"smooth"}),(0,S.rR)("grafana_traces_trace_view_scroll_to_top_clicked",{datasourceType:a,grafana_version:A.$.buildInfo.version,numServices:r.services.length,numSpans:r.spans.length})},this.getVisibleSpanIds=(0,vt.default)((s,a)=>{const r=[];for(let o=s;o<a;o++){const l=this.getRowStates()[o];l?.span&&r.push(l.span.spanID)}return r})}componentDidMount(){this.scrollToSpan(this.props.headerHeight,this.props.focusedSpanId)}shouldComponentUpdate(s){let a;for(a in s)if(s[a]!==this.props[a])return!0;return!1}componentDidUpdate(s){const{headerHeight:a,focusedSpanId:r,focusedSpanIdForSearch:o}=this.props;this.hasScrolledToSpan||(this.scrollToSpan(a,r),this.hasScrolledToSpan=!0),r!==s.focusedSpanId&&this.scrollToSpan(a,r),o!==s.focusedSpanIdForSearch&&this.scrollToSpan(a,o)}getRowStates(){const{childrenHiddenIDs:s,detailStates:a,trace:r,findMatchesIDs:o,showSpanFilterMatchesOnly:l,showCriticalPathSpansOnly:d,criticalPath:u}=this.props;return Pn(r,s,a,o,l,d,u)}getClipping(){const{currentViewRangeTime:s}=this.props;return _n(s)}getViewedBounds(){const{currentViewRangeTime:s,trace:a}=this.props,[r,o]=s;return Bn({min:a.startTime,max:a.endTime,viewStart:r,viewEnd:o})}getChildSpansMap(){return Vn(this.props.trace)}getAccessors(){const s=this.listView;if(!s)throw new Error("ListView unavailable");return{getViewRange:this.getViewRange,getSearchedSpanIDs:this.getSearchedSpanIDs,getCollapsedChildren:this.getCollapsedChildren,getViewHeight:s.getViewHeight,getBottomRowIndexVisible:s.getBottomVisibleIndex,getTopRowIndexVisible:s.getTopVisibleIndex,getRowPosition:s.getRowPosition,mapRowIndexToSpanIndex:this.mapRowIndexToSpanIndex,mapSpanIndexToRowIndex:this.mapSpanIndexToRowIndex}}renderSpanBarRow(s,a,r,o,l,d){const{spanID:u,childSpanIds:g}=s,{serviceName:f}=s.process,{childrenHiddenIDs:w,childrenToggle:j,detailStates:C,detailToggle:M,findMatchesIDs:$,spanNameColumnWidth:H,trace:te,spanBarOptions:J,hoverIndentGuideIds:Z,addHoverIndentGuideId:se,removeHoverIndentGuideId:W,createSpanLink:oe,focusedSpanId:ge,focusedSpanIdForSearch:De,showSpanFilterMatchesOnly:ye,theme:je,datasourceType:Ke,criticalPath:at}=this.props;if(!te)return null;const de=(0,Rt.Kv)(f,je),Qe=w.has(u),rt=C.has(u),qe=$?$.has(u):!1,Ze=u===ge||u===De,St=F(s)||Qe&&G(te.spans,a);let mt=null;if(Qe){const Ce=Q(te.spans.slice(a));if(Ce){const tt=this.getViewedBounds()(Ce.startTime,Ce.startTime+Ce.duration);mt={color:(0,Rt.Kv)(Ce.process.serviceName,je),operationName:Ce.operationName,serviceName:Ce.process.serviceName,viewEnd:tt.end,viewStart:tt.start}}}const ct=s.tags.find(Ce=>Ce.key===ps);let re=null;!s.hasChildren&&ct&&ne(s)&&(re={serviceName:ct.value,color:(0,Rt.Kv)(ct.value,je)});const et=a>0?te.spans[a-1]:null,dt=[u,...g],ut=Ce=>{Ce.forEach(tt=>{const Ve=this.getChildSpansMap().get(tt);Ve?.length&&(dt.push(...Ve),ut(Ve))})};ut(g);const Ae=at?.filter(Ce=>Qe?dt.includes(Ce.spanId):Ce.spanId===u),Ct=Ws();return(0,n.jsx)("div",{className:Ct.row,style:o,...l,children:(0,n.jsx)(En,{clippingLeft:this.getClipping().left,clippingRight:this.getClipping().right,color:de,spanBarOptions:J,columnDivision:H,isChildrenExpanded:!Qe,isDetailExpanded:rt,isMatchingFilter:qe,isFocused:Ze,showSpanFilterMatchesOnly:ye,numTicks:jn,onDetailToggled:M,onChildrenToggled:j,rpc:mt,noInstrumentedServer:re,showErrorIcon:St,getViewedBounds:this.getViewedBounds(),traceStartTime:te.startTime,span:s,hoverIndentGuideIds:Z,addHoverIndentGuideId:se,removeHoverIndentGuideId:W,createSpanLink:oe,datasourceType:Ke,showServiceName:et===null||et.process.serviceName!==s.process.serviceName,visibleSpanIds:d,criticalPath:Ae})},r)}renderSpanDetailRow(s,a,r,o,l){const{spanID:d}=s,{serviceName:u}=s.process,{detailLogItemToggle:g,detailLogsToggle:f,detailProcessToggle:w,detailReferencesToggle:j,detailReferenceItemToggle:C,detailWarningsToggle:M,detailStackTracesToggle:$,detailStates:H,detailTagsToggle:te,detailToggle:J,spanNameColumnWidth:Z,trace:se,traceToProfilesOptions:W,timeZone:oe,hoverIndentGuideIds:ge,addHoverIndentGuideId:De,removeHoverIndentGuideId:ye,linksGetter:je,createSpanLink:Ke,focusedSpanId:at,createFocusSpanLink:de,theme:Qe,datasourceType:rt,traceFlameGraphs:qe,setTraceFlameGraphs:Ze,setRedrawListView:St,timeRange:mt,app:ct}=this.props,re=H.get(d);if(!se||!re)return null;const et=(0,Rt.Kv)(u,Qe),dt=Ws();return(0,n.jsx)("div",{className:(0,i.cx)(dt.row,"span-detail-row"),style:{...r,zIndex:1},...o,children:(0,n.jsx)(Nn,{color:et,columnDivision:Z,onDetailToggled:J,detailState:re,linksGetter:je,logItemToggle:g,logsToggle:f,processToggle:w,referenceItemToggle:C,referencesToggle:j,warningsToggle:M,stackTracesToggle:$,span:s,traceToProfilesOptions:W,timeZone:oe,tagsToggle:te,traceStartTime:se.startTime,traceDuration:se.duration,traceName:se.traceName,hoverIndentGuideIds:ge,addHoverIndentGuideId:De,removeHoverIndentGuideId:ye,createSpanLink:Ke,focusedSpanId:at,createFocusSpanLink:de,datasourceType:rt,visibleSpanIds:l,traceFlameGraphs:qe,setTraceFlameGraphs:Ze,setRedrawListView:St,timeRange:mt,app:ct})},a)}render(){const s=Ws(),{scrollElement:a,redrawListView:r}=this.props;return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)($t,{ref:this.setListView,dataLength:this.getRowStates().length,itemHeightGetter:this.getRowHeight,itemRenderer:this.renderRow,viewBuffer:is,viewBufferMin:is,itemsWrapperClassName:s.rowsWrapper,getKeyFromIndex:this.getKeyFromIndex,getIndexFromKey:this.getIndexFromKey,windowScroller:!1,scrollElement:a,redraw:r}),this.props.topOfViewRef&&(0,n.jsx)(Ye.I,{className:s.scrollToTopButton,onClick:this.scrollToTop,title:(0,Y.t)("explore.unthemed-virtualized-trace-view.title-scroll-to-top","Scroll to top"),icon:"arrow-up"})]})}}const $n=(0,R.cV)(Hn),Wn=(0,D.N)(e=>({TraceTimelineViewer:(0,i.css)({label:"TraceTimelineViewer",borderBottom:`1px solid ${(0,m.R)(e,"#bbb")}`,"& .json-markup":{lineHeight:"17px",fontSize:"13px",fontFamily:"monospace",whiteSpace:"pre-wrap"},"& .json-markup-key":{fontWeight:"bold"},"& .json-markup-bool":{color:(0,m.R)(e,"firebrick")},"& .json-markup-string":{color:(0,m.R)(e,"teal")},"& .json-markup-null":{color:(0,m.R)(e,"teal")},"& .json-markup-number":{color:(0,m.R)(e,"blue","black")}})})),Kn=5;class zn extends h.PureComponent{constructor(s){super(s),this.collapseAll=()=>{this.props.collapseAll(this.props.trace.spans),(0,S.rR)("grafana_traces_traceID_expand_collapse_clicked",{datasourceType:this.props.datasourceType,grafana_version:A.$.buildInfo.version,type:"collapseAll"})},this.collapseOne=()=>{this.props.collapseOne(this.props.trace.spans),(0,S.rR)("grafana_traces_traceID_expand_collapse_clicked",{datasourceType:this.props.datasourceType,grafana_version:A.$.buildInfo.version,type:"collapseOne"})},this.expandAll=()=>{this.props.expandAll(),(0,S.rR)("grafana_traces_traceID_expand_collapse_clicked",{datasourceType:this.props.datasourceType,grafana_version:A.$.buildInfo.version,type:"expandAll"})},this.expandOne=()=>{this.props.expandOne(this.props.trace.spans),(0,S.rR)("grafana_traces_traceID_expand_collapse_clicked",{datasourceType:this.props.datasourceType,grafana_version:A.$.buildInfo.version,type:"expandOne"})},this.state={height:0}}componentDidMount(){z({collapseAll:this.collapseAll,expandAll:this.expandAll,collapseOne:this.collapseOne,expandOne:this.expandOne})}render(){const{setSpanNameColumnWidth:s,updateNextViewRangeTime:a,updateViewRangeTime:r,viewRange:o,traceTimeline:l,theme:d,topOfViewRef:u,focusedSpanIdForSearch:g,...f}=this.props,{trace:w}=f,j=Wn(d);return(0,n.jsxs)("div",{className:j.TraceTimelineViewer,ref:C=>C&&this.setState({height:C.getBoundingClientRect().height}),children:[(0,n.jsx)(hs,{duration:w.duration,nameColumnWidth:l.spanNameColumnWidth,numTicks:Kn,onCollapseAll:this.collapseAll,onCollapseOne:this.collapseOne,onColummWidthChange:s,onExpandAll:this.expandAll,onExpandOne:this.expandOne,viewRangeTime:o.time,updateNextViewRangeTime:a,updateViewRangeTime:r,columnResizeHandleHeight:this.state.height}),(0,n.jsx)($n,{...f,...l,setSpanNameColumnWidth:s,currentViewRangeTime:o.time.current,topOfViewRef:u,focusedSpanIdForSearch:g,datasourceType:this.props.datasourceType})]})}}const Un=(0,R.cV)(zn);var zs=c(99887);const Gn=()=>({NewWindowIconLarge:(0,i.css)({label:"NewWindowIconLarge",fontSize:"1.5em"})});function Qn({isLarge:e=!1,className:s}){const a=(0,R.of)(Gn),r=ae()({[a.NewWindowIconLarge]:e},s);return(0,n.jsx)(Ee.I,{className:r,name:"anchor"})}const Zn=e=>(0,n.jsxs)("a",{href:e.href,title:e.title,target:"_blank",rel:"noopener noreferrer",className:e.className,children:[e.children," ",(0,n.jsx)(Qn,{})]});function Xn(e){const{links:s}=e;return(0,n.jsx)(Zn,{href:s[0].url,title:s[0].text,className:e.className})}const Yn=100,Jn="<trace-without-root-span>",qn=()=>({BreakableText:(0,i.css)({label:"BreakableText",display:"inline-block",whiteSpace:"pre"})}),ea=/\W*\w+\W*/g;function ta({text:e,className:s,wordRegexp:a=ea}){const r=(0,R.of)(qn);if(!e)return null;const o=[];a.exec("");let l=a.exec(e)||[e];for(;l;)o.push((0,n.jsx)("span",{className:s||r.BreakableText,children:l[0]},`${e}-${o.length}`)),l=a.exec(e);return(0,n.jsx)(n.Fragment,{children:o})}const sa=e=>({TraceName:(0,i.css)({label:"TraceName",fontSize:e.typography.size.lg})});function na(e){const{className:s,traceName:a}=e,r=(0,R.of)(sa),o=String(a||Jn),l=(0,n.jsx)(ta,{text:o});return(0,n.jsx)("span",{className:ae()(r.TraceName,s),children:l})}var rn=function(s,a){return Object.prototype.hasOwnProperty.call(s,a)};function aa(e,s){function a(r,o){if(e(r,o))return!0;if(Array.isArray(r))return!(!Array.isArray(o)||r.length!==o.length||!r.every(function(w,j){return a(w,o[j])}));if(Array.isArray(o))return!1;if(typeof r=="object"){if(typeof o!="object")return!1;var l=r===null,d=o===null;if(l||d)return l===d;var u=Object.keys(r),g=Object.keys(o);if(u.length!==g.length)return!1;var f=s?a:e;return!!u.every(function(w){return rn(r,w)&&rn(o,w)&&f(r[w],o[w])})}return!1}return a}var ra=function(s,a){for(var r=0;r<s.length;r++)if(a(s[r]))return r;return-1};function ia(e,s){var a=[];function r(l){var d=ra(a,function(g){return s(l,g.key)});if(d>-1){var u=a[d];return d>0&&(a.splice(d,1),a.unshift(u)),u.value}}function o(l,d){r(l)||(a.unshift({key:l,value:d}),a.length>e&&a.pop())}return{get:r,put:o}}function oa(e){var s;return{get:function(r){if(s&&e(r,s.key))return s.value},put:function(r,o){s={key:r,value:o}}}}function la(e,s){return e===1?oa(s):ia(e,s)}function ca(e,s){var a=s?aa(e,s):e;return function(r,o){if(r.length!==o.length)return!1;for(var l=0;l<r.length;l+=1)if(!a(r[l],o[l]))return!1;return!0}}function da(){for(var e=1,s=function(g,f){return g===f},a=!1,r=arguments.length,o=new Array(r),l=0;l<r;l++)o[l]=arguments[l];typeof o[0]=="number"&&(e=o.shift()),typeof o[0]=="function"?s=o.shift():typeof o[0]>"u"&&o.shift(),typeof o[0]=="boolean"&&(a=o[0]);var d=la(e,ca(s,a));return function(u){return function(){for(var g=arguments.length,f=new Array(g),w=0;w<g;w++)f[w]=arguments[w];var j=d.get(f);return j===void 0&&(j=u.apply(u,f),d.put(f,j)),j}}}const ua=da,ha=Object.defineProperty({archiveEnabled:!1,dependencies:{dagMaxNumServices:Yn,menuEnabled:!0},linkPatterns:[],search:{maxLookback:{label:"2 Days",value:"2d"},maxLimit:1500},tracking:{gaID:null,trackErrors:!0}},"__mergeFields",{value:["dependencies","search","tracking"]});function pa(){return ha}function on(e){return(0,Me.get)(pa(),e)}const ln=/#\{([^{}]*)\}/g;function ga(e){const s=new Set;return e.replace(ln,(a,r)=>(s.add(r),a)),Array.from(s)}function fa(e,s,a){return e.replace(ln,(r,o)=>{const l=a[o];return l==null?"":s(l)})}function cn(e,s){if(typeof e!="string")throw new Error("Invalid template");return{parameters:ga(e),template:fa.bind(null,e,s)}}function Us(e){if(typeof e=="string")return s=>s===e;if(Array.isArray(e))return s=>e.indexOf(s)>-1;if(e==null)return()=>!0;throw new Error(`Invalid value: ${e}`)}const ma=e=>e;function va(e){try{const s=cn(e.url,encodeURIComponent),a=cn(e.text,ma);return{object:e,type:Us(e.type),key:Us(e.key),value:Us(e.value),url:s,text:a,parameters:(0,Me.uniq)(s.parameters.concat(a.parameters))}}catch(s){return console.error(`Ignoring invalid link pattern: ${s}`,e),null}}function dn(e,s){return e.template(s)}function xa(e,s){const a=[],r=Object.keys(s).filter(o=>typeof s[o]=="string"||typeof s[o]=="number");return e?.filter(o=>o?.type("traces")).forEach(o=>{const l={};o?.parameters.every(u=>{const g=u;return r.includes(g)?(l[u]=s[g],!0):!1})&&a.push({url:dn(o.url,l),text:dn(o.text,l)})}),a}const ya=(on("linkPatterns")||[]).map(va).filter(e=>!!e),ba=ua(10)(e=>{const s=[];return e?xa(ya,e):s});function Sa(e){let s;const a=new Set(e.map(({spanID:r})=>r));for(let r=0;r<e.length;r++){if(e[r].references&&e[r].references.some(({traceID:u,spanID:g})=>u===e[r].traceID&&a.has(g)))continue;if(!s){s=e[r];continue}const l=e[r].references&&e[r].references.length||0,d=s.references&&s.references.length||0;(l<d||l===d&&e[r].startTime<s.startTime)&&(s=e[r])}return s?`${s.process.serviceName}: ${s.operationName}`:""}const un=(0,Me.memoize)(Sa,e=>e.length?e[0].traceID:0);function Ia(e){for(let s=0;s<e.length;s++){const a=e[s].tags.filter(l=>l.key==="http.request.method"),r=e[s].tags.filter(l=>l.key==="http.response.status_code"),o=e[s].tags.filter(l=>l.key==="http.route");if(a.length>0||r.length>0||o.length>0)return{method:a,status:r,url:o}}for(let s=0;s<e.length;s++){const a=e[s].tags.filter(l=>l.key==="http.method"),r=e[s].tags.filter(l=>l.key==="http.status_code"),o=e[s].tags.filter(l=>l.key==="http.url"||l.key==="http.target"||l.key==="http.path");if(a.length>0||r.length>0||o.length>0)return{method:a,status:r,url:o}}return{}}const Ta=(0,Me.memoize)(Ia,e=>e.length?e[0].traceID:0);var hn=c(65642),wa=c(54334);const Da=e=>({ActionButton:(0,i.css)({label:"ActionButton",overflow:"hidden",position:"relative","&:after":{content:'""',background:e.colors.primary.main,display:"block",position:"absolute",right:0,width:"100%",height:"100%",opacity:0,transition:"all 0.8s"},"&:active:after":{margin:0,opacity:.3,transition:"0s"}})});function pn(e){const{onClick:s,ariaLabel:a,label:r,icon:o}=e,l=(0,R.of)(Da);return(0,n.jsx)(bt.$n,{className:l.ActionButton,size:"sm",variant:"secondary",fill:"outline",type:"button",icon:o,"aria-label":a,onClick:s,children:r})}const Ca=e=>({TracePageActions:(0,i.css)({label:"TracePageActions",display:"flex",alignItems:"center",justifyContent:"center",gap:"4px",marginBottom:"10px"}),feedbackContainer:(0,i.css)({color:e.colors.text.link}),feedback:(0,i.css)({margin:"6px",color:e.colors.text.link,fontSize:e.typography.bodySmall.fontSize,"&:hover":{textDecoration:"underline"}})});function Ra(e){const{traceId:s,data:a,app:r}=e,o=(0,R.$j)(),l=Ca(o),[d,u]=(0,h.useState)(!1),g=()=>{navigator.clipboard.writeText(s),u(!0),setTimeout(()=>{u(!1)},5e3)},f=()=>{const w=(0,wa.ek)(a,"Trace-"+s.substring(s.length-6));(0,S.rR)("grafana_traces_download_traces_clicked",{app:r,grafana_version:hn.$W.buildInfo.version,trace_format:w,location:"trace-view"})};return(0,n.jsxs)("div",{className:l.TracePageActions,children:[hn.$W.feedbackLinksEnabled&&(0,n.jsxs)("div",{className:l.feedbackContainer,children:[(0,n.jsx)(Ee.I,{name:"comment-alt-message"}),(0,n.jsx)("a",{href:"https://forms.gle/RZDEx8ScyZNguDoC8",className:l.feedback,title:(0,Y.t)("explore.trace-page-actions.title-share-thoughts-about-tracing-grafana","Share your thoughts about tracing in Grafana."),target:"_blank",rel:"noreferrer noopener",children:(0,n.jsx)(Y.x6,{i18nKey:"explore.trace-page-actions.give-feedback",children:"Give feedback"})})]}),(0,n.jsx)(pn,{onClick:g,ariaLabel:"Copy Trace ID",label:d?"Copied!":"Trace ID",icon:"copy"}),(0,n.jsx)(pn,{onClick:f,ariaLabel:"Export Trace",label:(0,Y.t)("explore.trace-page-actions.label-export","Export"),icon:"save"})]})}var Je=c(47184),Ea=c(40996),Vt=c(18027),gn=c(63527);const ka=/^(-?\d+(?:\.\d+)?)(ms|[Mwdhmsy])$/,fn=(e,s=ka)=>!(e.match(s)||!e),mn=e=>{const[s,a]=(0,h.useState)(()=>e.value?fn(e.value,e.validationRegex):!1);(0,Ea.A)(()=>{a(fn(e.value,e.validationRegex))},500,[e.value]);const r={labelWidth:26,disabled:e.disabled??!1,invalid:s,error:e.isInvalidError};return e.label&&(r.label=e.label,r.tooltip=e.tooltip||""),(0,n.jsx)(Vt.I,{...r,children:(0,n.jsx)(gn.p,{type:"text",placeholder:e.placeholder||"0",width:e.width||40,onChange:o=>{e.onChange(o.currentTarget.value)},value:e.value,"aria-label":e.ariaLabel||"interval input"})})};var La=c(89599),os=c(97095),Gs=c(32881),jt=c(18857),Na=c(77806),vn=c(87826);class ja extends h.PureComponent{constructor(){super(...arguments),this.clearUiFind=()=>{this.props.onChange("")}}static{this.defaultProps={value:void 0}}render(){const{value:s}=this.props,a=(0,n.jsx)(n.Fragment,{children:s&&s.length&&(0,n.jsx)(he.K,{name:"times",onClick:this.clearUiFind,tooltip:(0,Y.t)("explore.search-bar-input.suffix.tooltip-clear-input","Clear input")})});return(0,n.jsx)("div",{style:{width:"200px"},children:(0,n.jsx)(gn.p,{placeholder:(0,Y.t)("explore.search-bar-input.placeholder-find","Find..."),onChange:r=>this.props.onChange(r.currentTarget.value),suffix:a,value:s})})}}const xn=(0,h.memo)(function(s){const{trace:a,spanFilterMatches:r,setFocusedSpanIdForSearch:o,focusedSpanIndexForSearch:l,setFocusedSpanIndexForSearch:d,datasourceType:u,showSpanFilters:g}=s,f=Ma((0,R.$j)(),g);(0,h.useEffect)(()=>{if(r&&l!==-1){const W=Array.from(r);o(W[l])}},[l,o,r]);const w=(W,oe)=>{if(W.preventDefault(),W.stopPropagation(),oe){if((0,S.rR)("grafana_traces_trace_view_find_next_prev_clicked",{datasourceType:u,grafana_version:A.$.buildInfo.version,direction:"next"}),l===-1||r&&l===r.size-1){d(0);return}d(l+1)}},j=(W,oe)=>{if(W.preventDefault(),W.stopPropagation(),oe){if((0,S.rR)("grafana_traces_trace_view_find_next_prev_clicked",{datasourceType:u,grafana_version:A.$.buildInfo.version,direction:"prev"}),r&&(l===-1||l===0)){d(r.size-1);return}d(l-1)}},C=(W,oe)=>{W.key==="Enter"&&w(W,oe)},M=(W,oe)=>{W.key==="Enter"&&j(W,oe)},$=(r&&r?.size>0)??!1,H=$?f.button:(0,i.cx)(f.button,f.buttonDisabled),te=(0,h.useCallback)(W=>(0,n.jsx)(gt.m,{content:W,placement:"top",children:(0,n.jsx)("span",{className:f.tooltip,children:(0,n.jsx)(Ee.I,{name:"info-circle",size:"md"})})}),[f.tooltip]),J=(0,h.useCallback)((W,oe)=>{let ge=(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)("span",{children:`${a.spans.length} spans`}),te((0,n.jsxs)(n.Fragment,{children:[(0,n.jsxs)("div",{children:["Services: ",oe]}),(0,n.jsxs)("div",{children:["Depth: ",W]})]}))]});if(r)if(r.size===0)ge=(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)("span",{children:(0,n.jsx)(Y.x6,{i18nKey:"explore.get-matches-metadata.matches",children:"0 matches"})}),te("There are 0 span matches for the filters selected. Please try removing some of the selected filters.")]});else{const De=r.size===1?"match":"matches",ye=l!==-1?`${l+1}/${r.size} ${De}`:`${r.size} ${De}`,je=[];r.forEach(Ke=>{a.processes[Ke]&&je.push(a.processes[Ke].serviceName)}),ge=(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)("span",{children:ye}),te((0,n.jsxs)(n.Fragment,{children:[(0,n.jsxs)("div",{children:["Services: ",new Set(je).size,"/",oe]}),(0,n.jsxs)("div",{children:["Depth: ",W]})]}))]})}return ge},[l,te,r,a.processes,a.spans]),Z=new Set((0,Me.values)(a.processes).map(W=>W.serviceName)).size,se=(0,Me.get)((0,Me.maxBy)(a.spans,"depth"),"depth",0)+1;return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)("span",{className:f.matches,children:J(se,Z)}),(0,n.jsxs)("div",{className:$?f.buttons:(0,i.cx)(f.buttons,f.buttonsDisabled),children:[(0,n.jsx)("div",{"aria-label":"Prev result button",className:H,onClick:W=>j(W,$),onKeyDown:W=>M(W,$),role:"button",tabIndex:$?0:-1,children:(0,n.jsx)(Y.x6,{i18nKey:"explore.prev",children:"Prev"})}),(0,n.jsx)("div",{"aria-label":"Next result button",className:H,onClick:W=>w(W,$),onKeyDown:W=>C(W,$),role:"button",tabIndex:$?0:-1,children:(0,n.jsx)(Y.x6,{i18nKey:"explore.next",children:"Next"})})]})]})}),Ma=(e,s)=>{const a=(0,bt.hs)({theme:e,variant:"secondary",size:s?"md":"sm",iconOnly:!1,fill:"outline"});return{buttons:(0,i.css)({display:"inline-flex",gap:"4px"}),buttonsDisabled:(0,i.css)({cursor:"not-allowed"}),button:a.button,buttonDisabled:(0,i.css)(a.disabled,{pointerEvents:"none"}),matches:(0,i.css)({marginRight:e.spacing(2),textWrap:"nowrap"}),tooltip:(0,i.css)({color:"#aaa",margin:"0 0 0 5px"})}};var yn=c(21285);function Oa(e,s){if(!s)return;let a=!1;e.serviceName&&(s=Pa(s,e),a=!0),e.spanName&&(s=Ba(s,e),a=!0),(e.from||e.to)&&(s=_a(s,e),a=!0);const r=Fa(s,e.tags);if(r&&(s=r,a=!0),e.query){const o=Aa(e.query,s);o&&(s=o,a=!0)}return a?new Set(s.map(o=>o.spanID)):void 0}function Aa(e,s){if(!s)return;const a=[];e.split(/\s+/).filter(Boolean).forEach(d=>{a.push(d.toLowerCase())});const r=(d,u)=>d.some(g=>u.toLowerCase().includes(g)),o=d=>d?d.some(u=>r(a,u.key)||r(a,Ys(u.value))):!1,l=d=>r(a,d.operationName)||r(a,d.process.serviceName)||o(d.tags)||d.kind&&r(a,d.kind)||d.statusCode!==void 0&&r(a,Et.s[d.statusCode])||d.statusMessage&&r(a,d.statusMessage)||d.instrumentationLibraryName&&r(a,d.instrumentationLibraryName)||d.instrumentationLibraryVersion&&r(a,d.instrumentationLibraryVersion)||d.traceState&&r(a,d.traceState)||d.logs!==null&&d.logs.some(u=>u.name&&r(a,u.name)||o(u.fields))||o(d.process.tags)||a.some(u=>u===d.spanID);return s.filter(l)}const Fa=(e,s)=>{if(s=s.filter(a=>a.key&&a.key!==""||a.value),s.length>0)return e.filter(a=>s.every(r=>r.key&&r.value?!!(r.operator==="="&&Sn(r,a)||r.operator==="=~"&&bn(r,a)||r.operator==="!="&&!Sn(r,a)||r.operator==="!~"&&!bn(r,a)):r.key?a.tags.some(o=>Qs(r.key,o.key))||a.process.tags.some(o=>Qs(r.key,o.key))||a.logs&&a.logs.some(o=>o.fields.some(l=>Qs(r.key,l.key)))||a.kind&&r.key===y.Nd||a.statusCode!==void 0&&r.key===y.XQ||a.statusMessage&&r.key===y.x9||a.instrumentationLibraryName&&r.key===y.mT||a.instrumentationLibraryVersion&&r.key===y.Zh||a.traceState&&r.key===y.gz||r.key===y.ID?r.operator==="="||r.operator==="=~":!(r.operator==="="||r.operator==="=~"):!1))},bn=(e,s)=>s.tags.some(a=>Xs(e,a))||s.process.tags.some(a=>Xs(e,a))||s.logs&&s.logs.some(a=>a.fields.some(r=>Xs(e,r)))||s.kind&&e.key===y.Nd&&e.value?.includes(s.kind)||s.statusCode!==void 0&&e.key===y.XQ&&e.value?.includes(Et.s[s.statusCode].toLowerCase())||s.statusMessage&&e.key===y.x9&&e.value?.includes(s.statusMessage)||s.instrumentationLibraryName&&e.key===y.mT&&e.value?.includes(s.instrumentationLibraryName)||s.instrumentationLibraryVersion&&e.key===y.Zh&&e.value?.includes(s.instrumentationLibraryVersion)||s.traceState&&e.key===y.gz&&e.value?.includes(s.traceState)||e.key===y.ID&&e.value?.includes(s.spanID),Sn=(e,s)=>s.tags.some(a=>Zs(e,a))||s.process.tags.some(a=>Zs(e,a))||s.logs&&s.logs.some(a=>a.fields.some(r=>Zs(e,r)))||s.kind&&e.key===y.Nd&&e.value===s.kind||s.statusCode!==void 0&&e.key===y.XQ&&e.value===Et.s[s.statusCode].toLowerCase()||s.statusMessage&&e.key===y.x9&&e.value===s.statusMessage||s.instrumentationLibraryName&&e.key===y.mT&&e.value===s.instrumentationLibraryName||s.instrumentationLibraryVersion&&e.key===y.Zh&&e.value===s.instrumentationLibraryVersion||s.traceState&&e.key===y.gz&&e.value===s.traceState||e.key===y.ID&&e.value===s.spanID,Qs=(e,s)=>e===s.toString(),Zs=(e,s)=>e.key===s.key&&e.value===Ys(s.value),Xs=(e,s)=>s.key.includes(e.key||"")&&Ys(s.value).includes(e.value||""),Ys=e=>e?e.toString():"",Pa=(e,s)=>e.filter(a=>s.serviceNameOperator==="="?a.process.serviceName===s.serviceName:a.process.serviceName!==s.serviceName),Ba=(e,s)=>e.filter(a=>s.spanNameOperator==="="?a.operationName===s.spanName:a.operationName!==s.spanName),_a=(e,s)=>{const a=ls(s?.from||""),r=ls(s?.to||"");let o=[];if(a&&(o=e.filter(l=>s.fromOperator===">"?l.duration>a:l.duration>=a)),r){const l=d=>s.toOperator==="<"?d.duration<r:d.duration<=r;o=o.length>0?o.filter(d=>l(d)):e.filter(d=>l(d))}return o},ls=e=>{if(e.includes("ns"))return parseFloat(e.split("ns")[0])/1e3;if(e.includes("us"))return parseFloat(e.split("us")[0]);if(e.includes("\xB5s"))return parseFloat(e.split("\xB5s")[0]);if(e.includes("ms"))return parseFloat(e.split("ms")[0])*1e3;if(e.includes("s"))return parseFloat(e.split("s")[0])*1e3*1e3;if(e.includes("m"))return parseFloat(e.split("m")[0])*1e3*1e3*60;if(e.includes("h"))return parseFloat(e.split("h")[0])*1e3*1e3*60*60},Va=(0,h.memo)(function(s){const{trace:a,search:r,spanFilterMatches:o,setShowSpanFilterMatchesOnly:l,setShowCriticalPathSpansOnly:d,focusedSpanIndexForSearch:u,setFocusedSpanIndexForSearch:g,setFocusedSpanIdForSearch:f,datasourceType:w,clear:j,showSpanFilters:C}=s,M=(0,R.of)(Ha),$=(0,h.useMemo)(()=>r.serviceName&&r.serviceName!==""||r.spanName&&r.spanName!==""||ls(r.from||"")||ls(r.to||"")||r.tags.length>1||r.tags.some(H=>H.key)||r.query&&r.query!==""||r.matchesOnly,[r.serviceName,r.spanName,r.from,r.to,r.tags,r.query,r.matchesOnly]);return(0,n.jsx)("div",{className:M.container,children:(0,n.jsx)("div",{className:M.controls,children:(0,n.jsxs)(n.Fragment,{children:[(0,n.jsxs)("div",{children:[(0,n.jsx)(bt.$n,{variant:"destructive",disabled:!$,type:"button",fill:"outline","aria-label":"Clear filters button",onClick:j,children:(0,n.jsx)(Y.x6,{i18nKey:"explore.clear",children:"Clear"})}),(0,n.jsxs)("div",{className:M.matchesOnly,children:[(0,n.jsx)(yn.d,{value:r.matchesOnly,onChange:H=>l(H.currentTarget.checked??!1),label:"Show matches only switch",disabled:!o?.size}),(0,n.jsx)(bt.$n,{onClick:()=>l(!r.matchesOnly),className:M.clearMatchesButton,variant:"secondary",fill:"text",disabled:!o?.size,children:(0,n.jsx)(Y.x6,{i18nKey:"explore.show-matches-only",children:"Show matches only"})})]}),(0,n.jsxs)("div",{className:M.matchesOnly,children:[(0,n.jsx)(yn.d,{value:r.criticalPathOnly,onChange:H=>d(H.currentTarget.checked??!1),label:"Show critical path only switch"}),(0,n.jsx)(bt.$n,{onClick:()=>d(!r.criticalPathOnly),className:M.clearMatchesButton,variant:"secondary",fill:"text",children:(0,n.jsx)(Y.x6,{i18nKey:"explore.show-critical-path-only",children:"Show critical path only"})})]})]}),(0,n.jsx)("div",{className:M.nextPrevResult,children:(0,n.jsx)(xn,{trace:a,spanFilterMatches:o,setFocusedSpanIdForSearch:f,focusedSpanIndexForSearch:u,setFocusedSpanIndexForSearch:g,datasourceType:w,showSpanFilters:C})})]})})})}),Ha=e=>{const s=(0,bt.hs)({theme:e,variant:"secondary",size:"md",iconOnly:!1,fill:"outline"});return{button:(0,i.css)(s.button),buttonDisabled:(0,i.css)(s.disabled,{pointerEvents:"none",cursor:"not-allowed"}),container:(0,i.css)({display:"inline"}),controls:(0,i.css)({display:"flex",justifyContent:"flex-end",margin:"5px 0 0 0"}),matchesOnly:(0,i.css)({display:"inline-flex",margin:"0 0 0 25px",verticalAlign:"middle",alignItems:"center"}),clearMatchesButton:(0,i.css)({color:e.colors.text.primary,"&:hover":{background:"inherit"}}),nextPrevResult:(0,i.css)({marginLeft:"auto",display:"flex",alignItems:"center"})}};var $a=c(69192);const In=(0,h.memo)(e=>{const{trace:s,search:a,setSearch:r,showSpanFilters:o,setShowSpanFilters:l,setFocusedSpanIdForSearch:d,spanFilterMatches:u,datasourceType:g}=e,f={...(0,R.of)(Wa)},[w,j]=(0,h.useState)(),[C,M]=(0,h.useState)(),[$,H]=(0,h.useState)(-1),[te,J]=(0,h.useState)(),[Z,se]=(0,h.useState)({}),W=/^\d+(?:\.\d)?\d*(?:ns|us|s|ms|s|m|h)$/,oe=(0,h.useCallback)(()=>{j(void 0),M(void 0),J(void 0),se({}),r(Na.Ji)},[r]);(0,h.useEffect)(()=>{oe()},[oe,s]);const ge=(0,h.useCallback)(de=>{r({...a,matchesOnly:de})},[a,r]),De=(0,h.useCallback)(de=>{r({...a,criticalPathOnly:de})},[a,r]);if(!s)return null;const ye=de=>{H(-1),d(""),r(de)},je=()=>{w||j((0,vn.pG)(s).map(Je.z))},Ke=()=>{C||M((0,vn.m8)(s).map(Je.z))},at=(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(gt.m,{content:"Filter your spans below. You can continue to apply filters until you have narrowed down your resulting spans to the select few you are most interested in.",placement:"right",children:(0,n.jsxs)("span",{className:f.collapseLabel,children:["Span Filters",(0,n.jsx)(Ee.I,{size:"md",name:"info-circle"})]})}),!o&&(0,n.jsx)("div",{className:f.nextPrevResult,children:(0,n.jsx)(xn,{trace:s,spanFilterMatches:u,setFocusedSpanIdForSearch:d,focusedSpanIndexForSearch:$,setFocusedSpanIndexForSearch:H,datasourceType:g,showSpanFilters:o})})]});return(0,n.jsx)("div",{className:f.container,children:(0,n.jsxs)(La.S,{label:at,collapsible:!0,isOpen:o,onToggle:l,children:[(0,n.jsxs)(os.C,{className:f.flexContainer,children:[(0,n.jsx)(Vt.I,{label:(0,Y.t)("explore.span-filters.label-service-name","Service name"),labelWidth:16,children:(0,n.jsxs)(Gs.Gy,{spacing:"xs",children:[(0,n.jsx)(jt.l6,{"aria-label":(0,Y.t)("explore.span-filters.aria-label-select-service-name-operator","Select service name operator"),onChange:de=>ye({...a,serviceNameOperator:de.value}),options:[(0,Je.z)("="),(0,Je.z)("!=")],value:a.serviceNameOperator}),(0,n.jsx)(jt.l6,{"aria-label":(0,Y.t)("explore.span-filters.aria-label-select-service-name","Select service name"),isClearable:!0,onChange:de=>ye({...a,serviceName:de?.value||""}),onOpenMenu:je,options:w||(a.serviceName?[a.serviceName].map(Je.z):[]),placeholder:(0,Y.t)("explore.span-filters.placeholder-all-service-names","All service names"),value:a.serviceName||null,defaultValue:a.serviceName||null})]})}),(0,n.jsx)(ja,{onChange:de=>{ye({...a,query:de,matchesOnly:de!==""})},value:a.query||""})]}),(0,n.jsx)(os.C,{children:(0,n.jsx)(Vt.I,{label:(0,Y.t)("explore.span-filters.label-span-name","Span name"),labelWidth:16,children:(0,n.jsxs)(Gs.Gy,{spacing:"xs",children:[(0,n.jsx)(jt.l6,{"aria-label":(0,Y.t)("explore.span-filters.aria-label-select-span-name-operator","Select span name operator"),onChange:de=>ye({...a,spanNameOperator:de.value}),options:[(0,Je.z)("="),(0,Je.z)("!=")],value:a.spanNameOperator}),(0,n.jsx)(jt.l6,{"aria-label":(0,Y.t)("explore.span-filters.aria-label-select-span-name","Select span name"),isClearable:!0,onChange:de=>ye({...a,spanName:de?.value||""}),onOpenMenu:Ke,options:C||(a.spanName?[a.spanName].map(Je.z):[]),placeholder:(0,Y.t)("explore.span-filters.placeholder-all-span-names","All span names"),value:a.spanName||null})]})})}),(0,n.jsx)(os.C,{children:(0,n.jsx)(Vt.I,{label:(0,Y.t)("explore.span-filters.label-duration","Duration"),labelWidth:16,tooltip:"Filter by duration. Accepted units are ns, us, ms, s, m, h",children:(0,n.jsxs)(Gs.Gy,{spacing:"xs",align:"flex-start",children:[(0,n.jsx)(jt.l6,{"aria-label":(0,Y.t)("explore.span-filters.aria-label-select-min-span-operator","Select min span operator"),onChange:de=>ye({...a,fromOperator:de.value}),options:[(0,Je.z)(">"),(0,Je.z)(">=")],value:a.fromOperator}),(0,n.jsx)("div",{className:f.intervalInput,children:(0,n.jsx)(mn,{ariaLabel:"Select min span duration",onChange:de=>ye({...a,from:de}),isInvalidError:"Invalid duration",placeholder:"e.g. 100ms, 1.2s",width:18,value:a.from||"",validationRegex:W})}),(0,n.jsx)(jt.l6,{"aria-label":(0,Y.t)("explore.span-filters.aria-label-select-max-span-operator","Select max span operator"),onChange:de=>ye({...a,toOperator:de.value}),options:[(0,Je.z)("<"),(0,Je.z)("<=")],value:a.toOperator}),(0,n.jsx)(mn,{ariaLabel:"Select max span duration",onChange:de=>ye({...a,to:de}),isInvalidError:"Invalid duration",placeholder:"e.g. 100ms, 1.2s",width:18,value:a.to||"",validationRegex:W})]})})}),(0,n.jsx)(os.C,{className:f.tagsRow,children:(0,n.jsx)(Vt.I,{label:(0,Y.t)("explore.span-filters.label-tags","Tags"),labelWidth:16,tooltip:"Filter by tags, process tags or log fields in your spans.",children:(0,n.jsx)($a.T,{search:a,setSearch:ye,trace:s,tagKeys:te,setTagKeys:J,tagValues:Z,setTagValues:se})})}),(0,n.jsx)(Va,{trace:s,search:a,spanFilterMatches:u,setShowSpanFilterMatchesOnly:ge,setShowCriticalPathSpansOnly:De,setFocusedSpanIdForSearch:d,focusedSpanIndexForSearch:$,setFocusedSpanIndexForSearch:H,datasourceType:g,clear:oe,showSpanFilters:o})]})})});In.displayName="SpanFilters";const Wa=e=>({container:(0,i.css)({label:"SpanFilters",margin:`0.5em 0 -${e.spacing(1)} 0`,zIndex:5,"& > div":{borderLeft:"none",borderRight:"none"}}),collapseLabel:(0,i.css)({svg:{color:"#aaa",margin:"-2px 0 0 10px"}}),flexContainer:(0,i.css)({display:"flex",justifyContent:"space-between"}),intervalInput:(0,i.css)({margin:"0 -4px 0 0"}),tagsRow:(0,i.css)({margin:"-4px 0 0 0"}),nextPrevResult:(0,i.css)({flex:1,alignItems:"center",display:"flex",justifyContent:"flex-end",marginRight:e.spacing(1)})}),Tn=(0,h.memo)(e=>{const{trace:s,data:a,app:r,timeZone:o,search:l,setSearch:d,showSpanFilters:u,setShowSpanFilters:g,setFocusedSpanIdForSearch:f,spanFilterMatches:w,datasourceType:j,setHeaderHeight:C}=e,M=(0,R.of)(Ka);(0,h.useEffect)(()=>{C(document.querySelector("."+M.header)?.scrollHeight??0)},[C,u,M.header]);const $=(0,h.useMemo)(()=>s?ba(s):[],[s]);if(!s)return null;const H=(ge,De)=>{const ye=(0,zt.LE)(ge.startTime/1e3,{timeZone:De,defaultWithMS:!0}),je=ye.match(/^(.+)(:\d\d\.\d+)$/);return je?(0,n.jsxs)("span",{className:M.TracePageHeaderOverviewItemValue,children:[je[1],(0,n.jsx)("span",{className:M.TracePageHeaderOverviewItemValueDetail,children:je[2]})]}):ye},te=(0,n.jsxs)("h1",{className:ae()(M.title),children:[(0,n.jsx)(na,{traceName:un(s.spans)}),(0,n.jsx)("small",{className:M.duration,children:(0,Ie.a3)(s.duration)})]}),{method:J,status:Z,url:se}=Ta(s.spans);let W="green";Z&&Z.length>0&&(Z[0].value.toString().charAt(0)==="4"?W="orange":Z[0].value.toString().charAt(0)==="5"&&(W="red"));const oe=ge=>(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)("div",{children:"http.url or http.target or http.path"}),(0,n.jsxs)("div",{children:["(",ge,")"]})]});return(0,n.jsxs)("header",{className:M.header,children:[(0,n.jsxs)("div",{className:M.titleRow,children:[$&&$.length>0&&(0,n.jsx)(Xn,{links:$,className:M.TracePageHeaderBack}),te,(0,n.jsx)(Ra,{traceId:s.traceID,data:a,app:r})]}),(0,n.jsxs)("div",{className:M.subtitle,children:[(0,n.jsx)("span",{className:M.timestamp,children:H(s,o)}),(0,n.jsxs)("span",{className:M.tagMeta,children:[a.meta?.custom?.partial&&(0,n.jsx)(gt.m,{content:a.meta?.custom?.message,interactive:!0,children:(0,n.jsx)("span",{className:M.tag,children:(0,n.jsx)(zs.E,{icon:"info-circle",text:(0,Y.t)("explore.trace-page-header.text-partial-trace","Partial trace"),color:"orange"})})}),J&&J.length>0&&(0,n.jsx)(gt.m,{content:"http.method",interactive:!0,children:(0,n.jsx)("span",{className:M.tag,children:(0,n.jsx)(zs.E,{text:J[0].value,color:"blue"})})}),Z&&Z.length>0&&(0,n.jsx)(gt.m,{content:"http.status_code",interactive:!0,children:(0,n.jsx)("span",{className:M.tag,children:(0,n.jsx)(zs.E,{text:Z[0].value,color:W})})}),se&&se.length>0&&(0,n.jsx)(gt.m,{content:oe(se[0].value),interactive:!0,children:(0,n.jsx)("span",{className:M.url,children:se[0].value})})]})]}),(0,n.jsx)(In,{trace:s,showSpanFilters:u,setShowSpanFilters:g,search:l,setSearch:d,spanFilterMatches:w,setFocusedSpanIdForSearch:f,datasourceType:j})]})});Tn.displayName="TracePageHeader";const Ka=e=>({TracePageHeaderBack:(0,i.css)({label:"TracePageHeaderBack",alignItems:"center",alignSelf:"stretch",backgroundColor:"#fafafa",borderBottom:"1px solid #ddd",borderRight:"1px solid #ddd",color:"inherit",display:"flex",fontSize:"1.4rem",padding:"0 1rem",marginBottom:"-1px","&:hover":{backgroundColor:"#f0f0f0",borderColor:"#ccc"}}),TracePageHeaderOverviewItemValueDetail:ae()((0,i.css)({label:"TracePageHeaderOverviewItemValueDetail",color:"#aaa"}),"trace-item-value-detail"),TracePageHeaderOverviewItemValue:(0,i.css)({label:"TracePageHeaderOverviewItemValue","&:hover > .trace-item-value-detail":{color:"unset"}}),header:(0,i.css)({label:"TracePageHeader",backgroundColor:e.colors.background.primary,padding:"0.5em 0 0 0",position:"sticky",top:0,zIndex:5,textAlign:"left"}),titleRow:(0,i.css)({alignItems:"flex-start",display:"flex",padding:"0 8px",flexWrap:"wrap"}),title:(0,i.css)({color:"inherit",flex:1,fontSize:"1.7em",lineHeight:"1em",marginBottom:0,minWidth:"200px"}),subtitle:(0,i.css)({flex:1,lineHeight:"1em",margin:"-0.5em 0.5em 0.75em 0.5em"}),tag:(0,i.css)({margin:"0 0.5em 0 0"}),duration:(0,i.css)({color:"#aaa",margin:"0 0.75em"}),timestamp:(0,i.css)({verticalAlign:"middle"}),tagMeta:(0,i.css)({margin:"0 0.75em",verticalAlign:"text-top"}),url:(0,i.css)({margin:"-2.5px 0.3em",height:"15px",overflow:"hidden",textOverflow:"ellipsis",maxWidth:"700px",display:"inline-block"}),TracePageHeaderTraceId:(0,i.css)({label:"TracePageHeaderTraceId",whiteSpace:"nowrap",textOverflow:"ellipsis",maxWidth:"30%",display:"inline-block"})}),za="None",Ua="Duration",wn="Tag";function Ga({options:e,onOptionsChange:s}){const a=useStyles2(Qa),r=[za,Ua,wn].map(toOption);return jsxs("div",{className:css({width:"100%"}),children:[jsx(InlineFieldRow,{className:a.row,children:jsx(InlineField,{label:t("explore.span-bar-settings.label-label","Label"),labelWidth:26,tooltip:t("explore.span-bar-settings.tooltip-default-duration","Default: duration"),grow:!0,children:jsx(Select,{inputId:"label",options:r,value:e.jsonData.spanBar?.type||"",onChange:o=>{updateDatasourcePluginJsonDataOption({onOptionsChange:s,options:e},"spanBar",{...e.jsonData.spanBar,type:o?.value??""})},placeholder:t("explore.span-bar-settings.placeholder-duration","Duration"),isClearable:!0,"aria-label":t("explore.span-bar-settings.aria-label-selectlabelname","Select label name"),width:40})})}),e.jsonData.spanBar?.type===wn&&jsx(InlineFieldRow,{className:a.row,children:jsx(InlineField,{label:t("explore.span-bar-settings.label-tag-key","Tag key"),labelWidth:26,tooltip:"Tag key which will be used to get the tag value. A span's attributes and resources will be searched for the tag key",children:jsx(Input,{type:"text",placeholder:t("explore.span-bar-settings.placeholder-enter-tag-key","Enter tag key"),onChange:o=>updateDatasourcePluginJsonDataOption({onOptionsChange:s,options:e},"spanBar",{...e.jsonData.spanBar,tag:o.currentTarget.value}),value:e.jsonData.spanBar?.tag||"",width:40})})})]})}const ir=({options:e,onOptionsChange:s})=>{let a=e.type;return a+=e.type==="tempo"?"/configure-tempo-data-source/#span-bar":"/#span-bar",jsx(ConfigSubSection,{title:t("explore.span-bar-section.title-span-bar","Span bar"),description:jsx(ConfigDescriptionLink,{description:"Add additional info next to the service and operation on a span bar row in the trace view.",suffix:a,feature:"the span bar"}),children:jsx(Ga,{options:e,onOptionsChange:s})})},Qa=e=>({infoText:css({label:"infoText",paddingBottom:e.spacing(2),color:e.colors.text.secondary}),row:css({label:"row",alignItems:"baseline"})});class ot{constructor(s){const{isTagsOpen:a,isProcessOpen:r,isReferencesOpen:o,isWarningsOpen:l,isStackTracesOpen:d,logs:u,references:g}=s||{};this.isTagsOpen=!!a,this.isProcessOpen=!!r,this.isReferencesOpen=!!o,this.isWarningsOpen=!!l,this.isStackTracesOpen=!!d,this.logs={isOpen:!!(u&&u.isOpen),openedItems:u&&u.openedItems?new Set(u.openedItems):new Set},this.references={isOpen:!!(g&&g.isOpen),openedItems:g&&g.openedItems?new Set(g.openedItems):new Set}}toggleTags(){const s=new ot(this);return s.isTagsOpen=!this.isTagsOpen,s}toggleProcess(){const s=new ot(this);return s.isProcessOpen=!this.isProcessOpen,s}toggleReferences(){const s=new ot(this);return s.references.isOpen=!this.references.isOpen,s}toggleReferenceItem(s){const a=new ot(this);return a.references.openedItems.has(s)?a.references.openedItems.delete(s):a.references.openedItems.add(s),a}toggleWarnings(){const s=new ot(this);return s.isWarningsOpen=!this.isWarningsOpen,s}toggleStackTraces(){const s=new ot(this);return s.isStackTracesOpen=!this.isStackTracesOpen,s}toggleLogs(){const s=new ot(this);return s.logs.isOpen=!this.logs.isOpen,s}toggleLogItem(s){const a=new ot(this);return a.logs.openedItems.has(s)?a.logs.openedItems.delete(s):a.logs.openedItems.add(s),a}}var cs=c(25508);class lt{static iterFunction(s,a=0){return r=>s(r.value,r,a)}static searchFunction(s){return typeof s=="function"?s:(a,r)=>s instanceof lt?r===s:a===s}constructor(s,a=[]){this.value=s,this.children=a}get depth(){return this.children.reduce((s,a)=>Math.max(a.depth+1,s),1)}get size(){let s=0;return this.walk(()=>s++),s}addChild(s){return this.children.push(s instanceof lt?s:new lt(s)),this}find(s){if(lt.iterFunction(lt.searchFunction(s))(this))return this;for(let r=0;r<this.children.length;r++){const o=this.children[r].find(s);if(o)return o}return null}getPath(s){const a=lt.iterFunction(lt.searchFunction(s)),r=(o,l)=>{const d=l.concat([o]);if(a(o))return d;for(let u=0;u<o.children.length;u++){const g=o.children[u],f=r(g,d);if(f)return f}return null};return r(this,[])}walk(s,a=0){const r=[];let o=a;for(r.push({node:this,depth:o});r.length;){const l=r[r.length-1];r.pop();const{node:d,depth:u}=l;s(d.value,d,u),o=u+1;let g=d.children.length-1;for(;g>=0;)r.push({node:d.children[g],depth:o}),g--}}paths(s){const a=[];a.push({node:this,childIndex:0});const r=[];for(;a.length;){const{node:o,childIndex:l}=a[a.length-1];if(o.children.length>=l+1)a[a.length-1].childIndex++,a.push({node:o.children[l],childIndex:0});else{if(o.children.length===0){const d=a.map(u=>u.node.value);s(d)}a.pop()}}return r}}const Za=e=>e.spanID,Xa=e=>e.references||[],Ya=(0,cs.Mz)((0,cs.Mz)(({span:e})=>e,Xa),({type:e})=>e,(e,s)=>e.find(a=>a.refType===s)),or=(0,cs.Mz)(e=>Ya({span:e,type:"CHILD_OF"}),e=>e?e.spanID:null),Ja=e=>e.spans,lr=(0,cs.Mz)(Ja,e=>e.reduce((s,a)=>s.set(Za(a),a),new Map)),qa="__root__";function er(e,s=null){const a=new Map(e.spans.map(d=>[d.spanID,new lt(d.spanID)])),r=s??new Map(e.spans.map(d=>[d.spanID,d])),o=new lt(qa);e.spans.forEach(d=>{const u=a.get(d.spanID);if(Array.isArray(d.references)&&d.references.length){const{refType:g,spanID:f}=d.references[0];if(g==="CHILD_OF"||g==="FOLLOWS_FROM")(a.get(f)||o).children?.push(u);else throw new Error(`Unrecognized ref type: ${g}`)}else o.children.push(u)});const l=(d,u)=>{const g=d?.value?r.get(d.value.toString()):void 0,f=u?.value?r.get(u.value.toString()):void 0;return+(g?.startTime>f?.startTime)||+(g?.startTime===f?.startTime)-1};return e.spans.forEach(d=>{const u=a.get(d.spanID);u.children.length>1&&u?.children.sort(l)}),o.children.sort(l),o}function tr(e){const s=new Map,a=e.reduce((o,l)=>(o.some(d=>d.key===l.key&&d.value===l.value)?s.set(`${l.key}:${l.value}`,`Duplicate tag "${l.key}:${l.value}"`):o.push(l),o),[]),r=Array.from(s.values());return{dedupedTags:a,warnings:r}}function Dn(e,s){const a=e?.slice()??[],r=(s||[]).map(o=>o.toLowerCase());return a.sort((o,l)=>{const d=o.key.toLowerCase(),u=l.key.toLowerCase();for(let g=0;g<r.length;g++){const f=r[g];if(d.startsWith(f)&&!u.startsWith(f))return-1;if(!d.startsWith(f)&&u.startsWith(f))return 1}return d>u?1:d<u?-1:0}),a}function sr(e){if(!e?.traceID)return null;const s=e.traceID.toLowerCase();let a=0,r=Number.MAX_SAFE_INTEGER;const o=new Map,l=new Map;e.spans=e.spans.filter(C=>!!C.startTime),e.processes=Object.entries(e.processes).reduce((C,[M,$])=>(C[M]={...$,tags:Dn($.tags)},C),{});const d=e.spans.length;for(let C=0;C<d;C++){const M=e.spans[C],{startTime:$,duration:H,processID:te}=M;let J=M.spanID;$<r&&(r=$),$+H>a&&(a=$+H);const Z=o.get(J);Z!=null?(console.warn(`Dupe spanID, ${Z+1} x ${J}`,M,l.get(J)),(0,Me.isEqual)(M,l.get(J))&&console.warn("	 two spans with same ID have `isEqual(...) === true`"),o.set(J,Z+1),J=`${J}_${Z}`,M.spanID=J):o.set(J,1),M.process=e.processes[te],l.set(J,M)}const u=er(e,l),g=[],f={};u.walk((C,M,$=0)=>{if(C==="__root__"||typeof C!="string")return;const H=l.get(C);if(!H)return;const{serviceName:te}=H.process;f[te]=(f[te]||0)+1,H.relativeStartTime=H.startTime-r,H.depth=$-1,H.hasChildren=M.children.length>0,H.childSpanCount=M.children.length,H.warnings=H.warnings||[],H.tags=H.tags||[],H.references=H.references||[],H.childSpanIds=M.children.slice().sort((Z,se)=>{const W=l.get(Z.value),oe=l.get(se.value);return oe.startTime+oe.duration-(W.startTime+W.duration)}).map(Z=>Z.value);const J=tr(H.tags);H.tags=Dn(J.dedupedTags,on("topTagPrefixes")),H.warnings=H.warnings.concat(J.warnings),H.references.forEach((Z,se)=>{const W=l.get(Z.spanID);W&&(Z.span=W,se>0&&(W.subsidiarilyReferencedBy=W.subsidiarilyReferencedBy||[],W.subsidiarilyReferencedBy.push({spanID:C,traceID:s,span:H,refType:Z.refType})))}),g.push(H)});const w=un(g);return{services:Object.keys(f).map(C=>({name:C,numberOfSpans:f[C]})),spans:g,traceID:s,traceName:w,processes:e.processes,duration:a-r,startTime:r,endTime:a}}},80897:(I,x,c)=>{"use strict";c.d(x,{N:()=>n});var n=(i=>(i.Logs="log",i.Traces="trace",i.Metrics="metric",i.Profiles="profile",i.ProfilesDrilldown="profile-drilldown",i.Session="session",i.Unknown="unknown",i))(n||{})},20047:(I,x,c)=>{"use strict";c.d(x,{EUpdateTypes:()=>i,default:()=>A});var n=(D=>(D.DragEnd="DragEnd",D.DragMove="DragMove",D.DragStart="DragStart",D.MouseEnter="MouseEnter",D.MouseLeave="MouseLeave",D.MouseMove="MouseMove",D))(n||{});const i=n;var h=c(2543);const S=0;class A{constructor({getBounds:R,tag:m,resetBoundsOnResize:U=!0,...P}){this.resetBounds=()=>{this._bounds=void 0},this._handleMinorMouseEvent=L=>{const{button:N,clientX:k,type:X}=L;if(this._isDragging||N!==S)return;let z=null,le;if(X==="mouseenter")z=i.MouseEnter,le=this._onMouseEnter;else if(X==="mouseleave")z=i.MouseLeave,le=this._onMouseLeave;else if(X==="mousemove")z=i.MouseMove,le=this._onMouseMove;else throw new Error(`invalid event type: ${X}`);if(!le)return;const{value:ue,x:ae}=this._getPosition(k);le({event:L,type:z,value:ue,x:ae,manager:this,tag:this.tag})},this._handleDragEvent=L=>{const{button:N,clientX:k,type:X}=L;let z=null,le;if(X==="mousedown"){if(this._isDragging||N!==S)return;window.addEventListener("mousemove",this._handleDragEvent),window.addEventListener("mouseup",this._handleDragEvent);const Ie=(0,h.get)(document,"body.style");Ie&&(Ie.userSelect="none"),this._isDragging=!0,z=i.DragStart,le=this._onDragStart}else if(X==="mousemove"){if(!this._isDragging)return;z=i.DragMove,le=this._onDragMove}else if(X==="mouseup"){if(!this._isDragging)return;this._stopDragging(),z=i.DragEnd,le=this._onDragEnd}else throw new Error(`invalid event type: ${X}`);if(!le)return;const{value:ue,x:ae}=this._getPosition(k);le({event:L,type:z,value:ue,x:ae,manager:this,tag:this.tag})},this.handleMouseDown=this._handleDragEvent,this.handleMouseEnter=this._handleMinorMouseEvent,this.handleMouseMove=this._handleMinorMouseEvent,this.handleMouseLeave=this._handleMinorMouseEvent,this.getBounds=R,this.tag=m,this._isDragging=!1,this._bounds=void 0,this._resetBoundsOnResize=!!U,this._resetBoundsOnResize&&window.addEventListener("resize",this.resetBounds),this._onMouseEnter=P.onMouseEnter,this._onMouseLeave=P.onMouseLeave,this._onMouseMove=P.onMouseMove,this._onDragStart=P.onDragStart,this._onDragMove=P.onDragMove,this._onDragEnd=P.onDragEnd}_getBounds(){return this._bounds||(this._bounds=this.getBounds(this.tag)),this._bounds}_getPosition(R){const{clientXLeft:m,maxValue:U,minValue:P,width:L}=this._getBounds();let N=R-m,k=N/L;return P!=null&&k<P?(k=P,N=P*L):U!=null&&k>U&&(k=U,N=U*L),{value:k,x:N}}_stopDragging(){window.removeEventListener("mousemove",this._handleDragEvent),window.removeEventListener("mouseup",this._handleDragEvent);const R=(0,h.get)(document,"body.style");R&&(R.userSelect="auto"),this._isDragging=!1}isDragging(){return this._isDragging}dispose(){this._isDragging&&this._stopDragging(),this._resetBoundsOnResize&&window.removeEventListener("resize",this.resetBounds),this._bounds=void 0,this._onMouseEnter=void 0,this._onMouseLeave=void 0,this._onMouseMove=void 0,this._onDragStart=void 0,this._onDragMove=void 0,this._onDragEnd=void 0}}},29617:(I,x,c)=>{"use strict";c.d(x,{Kv:()=>m,rY:()=>U});var n=c(41811),i=c(84140),h=c(8255);function S(L){if(L.length!==7)return[0,0,0];const N=L.slice(1,3),k=L.slice(3,5),X=L.slice(5);return[parseInt(N,16),parseInt(k,16),parseInt(X,16)]}class A{constructor(N,k){const X=P(N,k);this.colorsHex=X,this.colorsRgb=X.map(S),this.cache=new Map,this.prevColorIndex=void 0}_getColorIndex(N){let k=this.cache.get(N);if(k==null){const X=this.hashCode(N?N.toLowerCase():"");if(k=Math.abs(X%this.colorsHex.length),this.prevColorIndex!==void 0){this.prevColorIndex===k&&(k=this.getNextIndex(k));const z=this.colorsHex[this.prevColorIndex];if(i.A.readability(z,this.colorsHex[k])<1.5){let le=k;for(let ue=0;ue<this.colorsHex.length;ue++)if(le=this.getNextIndex(le),i.A.readability(z,this.colorsHex[le])>1.5){k=le;break}}}this.cache.set(N,k),this.prevColorIndex=k}return k}getNextIndex(N){return N+1<this.colorsHex.length?N+1:0}hashCode(N){let k=0,X,z;for(X=0;X<N.length;X++)z=N.charCodeAt(X),k=(k<<5)-k+z;return k}getColorByKey(N){const k=this._getColorIndex(N);return this.colorsHex[k]}getRgbColorByKey(N){const k=this._getColorIndex(N);return this.colorsRgb[k]}clear(){this.cache.clear()}}const D=(0,n.default)((L,N)=>new A(L,N));function R(L){D([],L)}function m(L,N){return D(h.Tj,N).getColorByKey(L)}function U(L,N){return D(h.Tj,N).getRgbColorByKey(L)}function P(L,N){const k=[...L],X=k.indexOf("#E24D42");X>-1&&k.splice(X,1);const z=L.indexOf("#BF1B00");z>-1&&k.splice(z,1);let le=[];for(const ue of k)i.A.readability(N.colors.background.primary,ue)>=3&&le.push(ue);return le}},44722:(I,x,c)=>{"use strict";c.d(x,{a3:()=>Ie});var n=c(2543),i=c.n(n),h=c(84743),S=c.n(h);const A="YYYY-MM-DD",D="HH:mm",R=1e3,m=1e3*R,U=60*m,P=60*U,L=24*P,N=Math.log10(R),k=[{unit:"d",microseconds:L,ofPrevious:24},{unit:"h",microseconds:P,ofPrevious:60},{unit:"m",microseconds:U,ofPrevious:60},{unit:"s",microseconds:m,ofPrevious:1e3},{unit:"ms",microseconds:R,ofPrevious:1e3},{unit:"\u03BCs",microseconds:1,ofPrevious:1e3}],X=(me,fe,Fe)=>toFloatPrecision(me/Fe,fe)*Fe;function z(me){return moment(me/R).format(A)}function le(me){return moment(me/R).format(D)}function ue(me){const fe=X(me,N,R);return`${moment.duration(fe/R).asMilliseconds()}ms`}function ae(me){const fe=X(me,N,m);return`${moment.duration(fe/R).asSeconds()}s`}function Ie(me){const[fe,Fe]=(0,n.dropWhile)(k,({microseconds:ve},V)=>V<k.length-1&&ve>me);if(fe.ofPrevious===1e3)return`${(0,n.round)(me/fe.microseconds,2)}${fe.unit}`;const Ue=`${Math.floor(me/fe.microseconds)}${fe.unit}`,q=Math.round(me/Fe.microseconds%fe.ofPrevious),be=`${q}${Fe.unit}`;return q===0?Ue:`${Ue} ${be}`}},82899:(I,x,c)=>{"use strict";c.d(x,{Cr:()=>xe,QW:()=>z,_o:()=>q,gt:()=>ve,hv:()=>V,i0:()=>X,lU:()=>L});var n=c(74848),i=c(38036),h=c(17548),S=c(25229),A=c(2863),D=c(30703),R=c(56840),m=c(28998),U=c(78529),P=c(80897);function L({splitOpenFn:_,traceToLogsOptions:F,traceToMetricsOptions:G,traceToProfilesOptions:Q,dataFrame:ne,createFocusSpanLink:ce,trace:ee}){if(!ne)return;let He=ve(ee.duration,ee.traceName,ee.traceID);const Te=ne.fields.some(he=>!!he.config.links?.length),It=ue(_,ne.fields[0],F,G,ce,He);return function(Y){let $e=It(Y);if(Te){He={...He,...V(Y),...xe(Y,Q)};const Pe=ne.fields.filter(ze=>!!ze.config.links?.length);try{let ze;Q?.datasourceUid&&(ze=(0,m.tR)().getInstanceSettings(Q.datasourceUid));const we=ze?.type==="grafana-pyroscope-datasource",Le=Y.tags.some(Re=>Re.key===z),Ne=we&&Le;let Xe=[];Pe.forEach(Re=>{const Mt=(0,U.QL)({field:Re,rowIndex:Y.dataFrameRowIndex,splitOpenFn:_,range:be(Y,void 0,void 0,Ne),dataFrame:ne,vars:He});Xe=Xe.concat(Mt)});const it=Xe.map(Re=>({title:Re.title,href:Re.href,onClick:Re.onClick,content:(0,n.jsx)(D.I,{name:"link",title:Re.title||"Link"}),field:Re.origin,type:Ne?P.N.Profiles:P.N.Unknown,target:Re.target}));$e.push.apply($e,it)}catch(ze){return console.error(ze),$e}}return $e}}const N=_=>_.map(F=>({key:F,value:F.includes(".")?F.replace(".","_"):void 0})),k=N(["cluster","hostname","namespace","pod","service.name","service.namespace"]),X=N(["service.name","service.namespace"]),z="pyroscope.profile.id",le="gf.feo11y.app.id";function ue(_,F,G,Q,ne,ce){let ee;G?.datasourceUid&&(ee=(0,m.tR)().getInstanceSettings(G.datasourceUid));const He=ee?.type==="grafana-splunk-datasource";let Te;return Q?.datasourceUid&&(Te=(0,m.tR)().getInstanceSettings(Q.datasourceUid)),function(he){ce={...ce,...V(he)};const Y=[];let $e,Pe="";if(ee&&G){const we=G.customQuery?G.query:void 0,Le=G.tags&&G.tags.length>0?G.tags:k;switch(ee?.type){case"loki":Pe=q(he,Le),$e=Ie(he,G,Pe,we);break;case"grafana-splunk-datasource":Pe=q(he,Le,{joinBy:" "}),$e=Fe(he,G,Pe,we);break;case"elasticsearch":case"grafana-opensearch-datasource":Pe=q(he,Le,{labelValueSign:":",joinBy:" AND "}),$e=fe(he,G,Pe,we);break;case"grafana-falconlogscale-datasource":Pe=q(he,Le,{joinBy:" OR "}),$e=Ue(he,G,Pe,we);break;case"googlecloud-logging-datasource":Pe=q(he,Le,{joinBy:" AND "}),$e=ht(he,G,Pe,we)}if($e){const Ne={title:ee.name,url:"",internal:{datasourceUid:ee.uid,datasourceName:ee.name,query:$e}};if(ce={...ce,__tags:{text:"Tags",value:Pe}},(0,U.O1)(Ne.internal.query,ce).allVariablesDefined){const Xe=(0,i.u)({link:Ne,internalLink:Ne.internal,scopedVars:ce,range:be(he,{startMs:G.spanStartTimeShift?h.intervalToMs(G.spanStartTimeShift):0,endMs:G.spanEndTimeShift?h.intervalToMs(G.spanEndTimeShift):0},He),field:{},onClickFn:_,replaceVariables:(0,A.w)().replace.bind((0,A.w)())});Y.push({href:Xe.href,title:"Related logs",onClick:Xe.onClick,content:(0,n.jsx)(D.I,{name:"gf-logs",title:(0,R.t)("explore.legacy-create-span-link-factory.title-explore-split","Explore the logs for this in split view")}),field:F,type:P.N.Logs})}}}if(Te&&Q?.queries)for(const we of Q.queries){const Le=we.query||`histogram_quantile(0.5, sum(rate(traces_spanmetrics_latency_bucket{service="${he.process.serviceName}"}[5m])) by (le))`,Ne={title:Te.name,url:"",internal:{datasourceUid:Te.uid,datasourceName:Te.name,query:{expr:Le,refId:"A"}}},Xe=Q.tags&&Q.tags.length>0?Q.tags:k;ce={...ce,__tags:{text:"Tags",value:q(he,Xe)}};const it=(0,i.u)({link:Ne,internalLink:Ne.internal,scopedVars:ce,range:be(he,{startMs:Q.spanStartTimeShift?h.intervalToMs(Q.spanStartTimeShift):-12e4,endMs:Q.spanEndTimeShift?h.intervalToMs(Q.spanEndTimeShift):12e4}),field:{},onClickFn:_,replaceVariables:(0,A.w)().replace.bind((0,A.w)())});Y.push({title:we?.name,href:it.href,onClick:it.onClick,content:(0,n.jsx)(D.I,{name:"chart-line",title:(0,R.t)("explore.legacy-create-span-link-factory.title-explore-metrics-for-this-span","Explore metrics for this span")}),field:F,type:P.N.Metrics})}if(he.references&&ne)for(const we of he.references){if(we.refType==="CHILD_OF")continue;const Le=ne(we.traceID,we.spanID),Ne=ae(we);Y.push({href:Le.href,title:Ne,content:(0,n.jsx)(D.I,{name:"link",title:Ne}),onClick:Le.onClick,field:Le.origin,type:P.N.Traces})}if(he.subsidiarilyReferencedBy&&ne)for(const we of he.subsidiarilyReferencedBy){const Le=ne(we.traceID,we.spanID),Ne=ae(we);Y.push({href:Le.href,title:Ne,content:(0,n.jsx)(D.I,{name:"link",title:Ne}),onClick:Le.onClick,field:Le.origin,type:P.N.Traces})}const ze=me(he);return ze&&Y.push({title:"Session for this span",href:ze,content:(0,n.jsx)(D.I,{name:"frontend-observability",title:(0,R.t)("explore.legacy-create-span-link-factory.title-session-for-this-span","Session for this span")}),field:F,type:P.N.Session}),Y}}const ae=_=>{let F=_.span?_.span.operationName:"View linked span";return _.refType==="EXTERNAL"&&(F="View linked span"),F};function Ie(_,F,G,Q){const{filterByTraceID:ne,filterBySpanID:ce}=F;if(Q)return{expr:Q,refId:""};if(!G)return;let ee="{${__tags}}";return ne&&_.traceID&&(ee+=' | label_format log_line_contains_trace_id=`{{ contains "${__span.traceId}" __line__  }}` | log_line_contains_trace_id="true" OR trace_id="${__span.traceId}"'),ce&&_.spanID&&(ee+=' | label_format log_line_contains_span_id=`{{ contains "${__span.spanId}" __line__  }}` | log_line_contains_span_id="true" OR span_id="${__span.spanId}"'),{expr:ee,refId:""}}function me(_){const F=_.process.tags.find(Q=>Q.key===le)?.value,G=_.tags.find(Q=>Q.key==="session_id"||Q.key==="session.id")?.value;return F&&G?`/a/grafana-kowalski-app/apps/${F}/sessions/${G}`:void 0}function fe(_,F,G,Q){const{filterByTraceID:ne,filterBySpanID:ce}=F;if(Q)return{query:Q,refId:"",metrics:[{id:"1",type:"logs"}]};let ee=[];return ce&&_.spanID&&ee.push('"${__span.spanId}"'),ne&&_.traceID&&ee.push('"${__span.traceId}"'),G&&ee.push("${__tags}"),{query:ee.join(" AND "),refId:"",metrics:[{id:"1",type:"logs"}]}}function Fe(_,F,G,Q){const{filterByTraceID:ne,filterBySpanID:ce}=F;if(Q)return{query:Q,refId:""};let ee="";return G&&(ee+="${__tags}"),ne&&_.traceID&&(ee+=' "${__span.traceId}"'),ce&&_.spanID&&(ee+=' "${__span.spanId}"'),{query:ee,refId:""}}function ht(_,F,G,Q){const{filterByTraceID:ne,filterBySpanID:ce}=F;if(Q)return{query:Q,refId:""};let ee=[];return ce&&_.spanID&&ee.push('"${__span.spanId}"'),ne&&_.traceID&&ee.push('"${__span.traceId}"'),G&&ee.push("${__tags}"),{query:ee.join(" AND "),refId:""}}function Ue(_,F,G,Q){const{filterByTraceID:ne,filterBySpanID:ce}=F;if(Q)return{lsql:Q,refId:""};if(!G)return;let ee="${__tags}";return ne&&_.traceID&&(ee+=' or "${__span.traceId}"'),ce&&_.spanID&&(ee+=' or "${__span.spanId}"'),{lsql:ee,refId:""}}function q(_,F,{labelValueSign:G="=",joinBy:Q=", "}={}){return[..._.process.tags,..._.tags,{key:"spanId",value:_.spanID},{key:"traceId",value:_.traceID},{key:"name",value:_.operationName},{key:"duration",value:_.duration}].map(ne=>{const ce=F.find(ee=>ee.key===ne.key);if(ce)return`${ce.value?ce.value:ce.key}${G}"${ne.value}"`}).filter(ne=>!!ne).join(Q)}function be(_,F={startMs:0,endMs:0},G=!1,Q=!1){let ne=Math.floor(_.startTime/1e3+F.startMs);const ce=(_.startTime+_.duration)/1e3;let ee=Math.floor(ce+F.endMs);G&&ee-ne<1e3?ee=ne+1e3:Q?(ne=ne-6e4,ee=ee+6e4):ne===ee&&ee++;const He=(0,S.KQ)(ee),Te=(0,S.KQ)(ne);return{from:Te,to:He,raw:{from:Te,to:He}}}function ve(_,F,G){return{__trace:{text:"Trace",value:{duration:_,name:F,traceId:G}}}}function V(_){const F={};for(const G of _.process.tags)F[G.key]=G.value;for(const G of _.tags)F[G.key]=G.value;return{__span:{text:"Span",value:{spanId:_.spanID,traceId:_.traceID,duration:_.duration,name:_.operationName,tags:F}}}}function xe(_,F){let G={};if(F){const Q=F.tags&&F.tags.length>0?F.tags:X;G={__tags:{text:"Tags",value:q(_,Q)}}}return G}},77806:(I,x,c)=>{"use strict";c.d(x,{Ji:()=>m,Qh:()=>P,SQ:()=>U,_g:()=>R,zE:()=>D});var n=c(2543),i=c.n(n),h=c(96540),S=c(24726),A=c(28941);const D=()=>(0,S.A)().slice(0,12),R={id:D(),operator:"="},m={spanNameOperator:"=",serviceNameOperator:"=",fromOperator:">",toOperator:"<",tags:[R],matchesOnly:!1,criticalPathOnly:!1};function U(L,N){const[k,X]=(0,h.useState)((0,n.merge)((0,n.cloneDeep)(m),N??{}));(0,h.useEffect)(()=>{N&&X(le=>(0,n.merge)((0,n.cloneDeep)(le),N))},[N]);const z=(0,h.useMemo)(()=>L&&(0,A.filterSpans)(k,L),[k,L]);return{search:k,setSearch:X,spanFilterMatches:z}}function P(L,N){if(!N)return N;const k={...N};return k.query&&(k.query=L(k.query)),k.serviceNameOperator&&(k.serviceNameOperator=L(k.serviceNameOperator)),k.serviceName&&(k.serviceName=L(k.serviceName)),k.spanNameOperator&&(k.spanNameOperator=L(k.spanNameOperator)),k.spanName&&(k.spanName=L(k.spanName)),k.from&&(k.from=L(k.from)),k.to&&(k.to=L(k.to)),k.tags&&(k.tags=k.tags.map(X=>({...X,key:L(X.key??""),value:L(X.value??"")}))),k}},87826:(I,x,c)=>{"use strict";c.d(x,{Io:()=>m,_g:()=>R,m8:()=>D,pG:()=>A});var n=c(11908),i=c(2543),h=c.n(i),S=c(34282);const A=U=>{const P=U.spans.map(L=>L.process.serviceName);return(0,i.uniq)(P).sort()},D=U=>{const P=U.spans.map(L=>L.operationName);return(0,i.uniq)(P).sort()},R=U=>{let P=[],L=[];return U.spans.forEach(N=>{N.tags.forEach(k=>{P.push(k.key)}),N.process.tags.forEach(k=>{P.push(k.key)}),N.logs!==null&&N.logs.forEach(k=>{k.fields.forEach(X=>{L.push(X.key)})}),N.kind&&P.push(S.Nd),N.statusCode!==void 0&&P.push(S.XQ),N.statusMessage&&P.push(S.x9),N.instrumentationLibraryName&&P.push(S.mT),N.instrumentationLibraryVersion&&P.push(S.Zh),N.traceState&&P.push(S.gz),P.push(S.ID)}),P=(0,i.uniq)(P).sort(),L=(0,i.uniq)(L).sort(),[...P,...L]},m=(U,P)=>{const L=[];return U.spans.forEach(N=>{const k=N.tags.find(z=>z.key===P)?.value;k&&L.push(k.toString());const X=N.process.tags.find(z=>z.key===P)?.value;switch(X&&L.push(X.toString()),N.logs!==null&&N.logs.forEach(z=>{const le=z.fields.find(ue=>ue.key===P)?.value;le&&L.push(le.toString())}),P){case S.Nd:N.kind&&L.push(N.kind);break;case S.XQ:N.statusCode!==void 0&&L.push(n.s[N.statusCode].toLowerCase());break;case S.x9:N.statusMessage&&L.push(N.statusMessage);break;case S.mT:N.instrumentationLibraryName&&L.push(N.instrumentationLibraryName);break;case S.Zh:N.instrumentationLibraryVersion&&L.push(N.instrumentationLibraryVersion);break;case S.gz:N.traceState&&L.push(N.traceState);break;case S.ID:L.push(N.spanID);break;default:break}}),(0,i.uniq)(L).sort()}},17523:(I,x,c)=>{"use strict";c.d(x,{L:()=>h});var n=c(88673),i=c(28941);function h(A){if(!A)return null;let D=A.fields.length===1?A.fields[0].values[0]:S(A);return D?(0,i.transformTraceData)(D):null}function S(A){const D=new n.R(A),R={};for(let m=0;m<D.length;m++){const U=D.get(m);if(!U.spanID)return null;R[U.spanID]||(R[U.spanID]={serviceName:U.serviceName,tags:U.serviceTags})}return{traceID:D.get(0).traceID,processes:R,spans:D.toArray().map((m,U)=>{const P=[];return m.parentSpanID&&P.push({refType:"CHILD_OF",spanID:m.parentSpanID,traceID:m.traceID}),m.references&&P.push(...m.references.map(L=>({refType:"FOLLOWS_FROM",...L}))),{...m,duration:m.duration*1e3,startTime:m.startTime*1e3,processID:m.spanID,flags:0,references:P,logs:m.logs?.map(L=>({...L,timestamp:L.timestamp*1e3}))||[],dataFrameRowIndex:U}})}}},4392:(I,x,c)=>{"use strict";c.d(x,{A:()=>h});var n=c(94701),i=function(S){(0,n.A)(function(){S()})};const h=i}}]);

//# sourceMappingURL=2609.755f9abc951de149804c.js.map