"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[4302],{47220:(z,C,e)=>{e.d(C,{o:()=>r});var t=e(74848),E=e(96540),g=e(36638),c=e(57866),I=e(95004),f=e(60519),j=e(54735),M=e(36192),P=e(92790),i=e(17669);function p(d,n,a=[]){for(const s of a)if(typeof s=="function"){if(!s(d,n))return!1}else if(n[s]!==d[s])return!1;return!0}const m={x:g.sJ.get(c.Ct.firstTimeField).get({}),y:g.sJ.get(c.Ct.byTypes).get(new Set([I.PU.number,I.PU.enum]))};class r extends E.Component{constructor(n){super(n),this.getTimeRange=()=>this.props.timeRange;let a=this.prepState(n);a.alignedData=a.config.prepData([a.alignedFrame]),this.state=a,this.plotInstance=E.createRef()}prepState(n,a=!0){let s=null;const{frames:u,fields:o=m,preparePlotFrame:A,replaceVariables:L,dataLinkPostProcessor:O}=n,U=A??i.m,N=u.some(D=>D.fields.some(_=>(_.config.links?.length??0)>0)),h=U(u,{...o,y:N?()=>!0:o.y},n.timeRange);if((0,M.uY)("GraphNG",!1,"data aligned",h),h){let D=h;if(N){const G=Array.isArray(this.props.timeZone)?this.props.timeZone[0]:this.props.timeZone;let b=u.map((T,B)=>({...T,fields:h.fields.filter((W,$)=>$===0||W.state?.origin?.frameIndex===B),length:h.length}));b.forEach((T,B)=>{T.fields.forEach(W=>{W.getLinks=(0,f._M)(T,W,{...W.state?.scopedVars,__dataContext:{value:{data:b,field:W,frame:T,frameIndex:B}}},L,G,O)})}),D={...h,fields:h.fields.filter((T,B)=>B===0||o.y(T,h,[h]))}}if(n.omitHideFromViz){const G=D.fields.filter(b=>b.config.custom?.hideFrom?.viz!==!0);D={...D,fields:G,length:G.length}}let _=this.state?.config;a&&(_=n.prepConfig(D,this.props.frames,this.getTimeRange),(0,M.uY)("GraphNG",!1,"config prepared",_)),s={alignedFrame:D,config:_},(0,M.uY)("GraphNG",!1,"data prepared",s.alignedData)}return s}componentDidUpdate(n){const{frames:a,structureRev:s,timeZone:u,cursorSync:o,propsToDiff:A}=this.props,L=!p(n,this.props,A);if(a!==n.frames||L||u!==n.timeZone||o!==n.cursorSync){let O=this.prepState(this.props,!1);O&&((this.state.config===void 0||u!==n.timeZone||o!==n.cursorSync||s!==n.structureRev||!s||L)&&(O.config=this.props.prepConfig(O.alignedFrame,this.props.frames,this.getTimeRange),(0,M.uY)("GraphNG",!1,"config recreated",O.config)),O.alignedData=O.config.prepData([O.alignedFrame]),this.setState(O))}}render(){const{width:n,height:a,children:s,renderLegend:u}=this.props,{config:o,alignedFrame:A,alignedData:L}=this.state;return o?(0,t.jsx)(j.KU,{width:n,height:a,legend:u(o),children:(O,U)=>(0,t.jsx)(P.Z,{config:o,data:L,width:O,height:U,plotRef:N=>this.plotInstance.current=N,children:s?s(o,A):null})}):null}}},17669:(z,C,e)=>{e.d(C,{m:()=>P});var t=e(95004),E=e(63409),g=e(8721);function c(i,p,m){let r,d;for(let n=0;n<p.length;n++)if(p[n]==null)d==null&&r!=null&&(d=n);else{if(d!=null&&r!=null){if(i[n]-r<m)for(;d<n;)p[d++]=void 0;d=null}r=i[n]}return p}var I=e(739);function f(i){return i.type===t.PU.number&&i.config.custom?.drawStyle===I.GR.Bars&&!i.config.custom?.hideFrom?.viz}function j(i,p){return i.fields.find(m=>p!=null?m.name===p:m.type===t.PU.time)}function M(i,p){const m=j(i,p);let r=m?.values;for(let d=0;d<i.fields.length;d++){let n=i.fields[d];if(n===m||f(n))continue;let a=n.config.custom?.spanNulls;typeof a=="number"&&a!==-1&&r&&(n.values=c(r,n.values,a))}return i}function P(i,p,m){let r;e:for(let s of i)for(let u of s.fields)if(p.x(u,s,i)){r=u;break e}i=i.map(s=>r?.state?.nullThresholdApplied?s:(0,E.M)({frame:s,refFieldName:r.name,refFieldPseudoMin:m?.from.valueOf(),refFieldPseudoMax:m?.to.valueOf()}));let d=i.reduce((s,u)=>s+u.fields.reduce((o,A)=>o+(f(A)?1:0),0),0),n=1/0;d>1&&i.forEach(s=>{if(!s.fields.some(f))return;const u=r.values;for(let o=0;o<u.length;o++)o>0&&(n=Math.min(n,u[o]-u[o-1]))});let a=(0,g.Fd)({frames:i,joinBy:p.x,keep:p.y,keepOriginIndices:!0,keepDisplayNames:!0,nullMode:s=>{if(f(s))return g.WO;let u=s.config.custom?.spanNulls;return u===!0?g.RC:u===-1?g.WO:g.JI}});return a?(a=M(a,r.name),n!==1/0&&(a.fields.forEach((s,u)=>{let o=s.values;if(u===0){let A=o[o.length-1];o.push(A+n,A+2*n)}else f(s)?o.push(null,null):o.push(void 0,void 0)}),a.length+=2),a):null}},16608:(z,C,e)=>{e.d(C,{I:()=>p});var t=e(74848),E=e(96540),g=e(64394),c=e(95004),I=e(739),f=e(54735),j=e(78055),M=e(47220),P=e(68706);const i=["rowHeight","colWidth","showValue","mergeValues","alignValue","tooltip","paginationRev"];class p extends E.Component{constructor(){super(...arguments),this.getValueColor=(r,d,n)=>{const a=this.props.frames[r]?.fields[d];if(a?.display){const s=a.display(n);if(s.color)return s.color}return g.F},this.prepConfig=(r,d,n)=>(0,P.iE)({frame:r,getTimeRange:n,allFrames:this.props.frames,...this.props,timeZones:Array.isArray(this.props.timeZone)?this.props.timeZone:[this.props.timeZone],rowHeight:r.fields.length>2?this.props.rowHeight:1,getValueColor:this.getValueColor,hoverMulti:this.props.tooltip?.mode===I.$N.Multi}),this.renderLegend=r=>{const{legend:d,legendItems:n}=this.props;return!r||!n||!d||d.showLegend===!1?null:(0,t.jsx)(f.KU.Legend,{placement:d.placement,children:(0,t.jsx)(j.t,{placement:d.placement,items:n,displayMode:d.displayMode,readonly:!0})})}}render(){return(0,t.jsx)(M.o,{...this.props,fields:{x:r=>r.type===c.PU.time,y:r=>r.type===c.PU.number||r.type===c.PU.boolean||r.type===c.PU.string||r.type===c.PU.enum},prepConfig:this.prepConfig,propsToDiff:i,renderLegend:this.renderLegend,omitHideFromViz:!0})}}},59614:(z,C,e)=>{e.d(C,{U:()=>E});var t=e(5709);const E=t.H.injectEndpoints({endpoints:g=>({getRuleHistory:g.query({query:({ruleUid:c,from:I,to:f,limit:j=100})=>({url:"/api/v1/rules/history",params:{ruleUID:c,from:I,to:f,limit:j}})})})})},88215:(z,C,e)=>{e.d(C,{A:()=>P});var t=e(74848),E=e(96540),g=e(70713),c=e(739),I=e(63142),f=e(16608),j=e(68706);const M=i=>i,P=(0,E.memo)(({frames:i,timeRange:p})=>{const m=(0,I.$j)();return(0,t.jsx)(g.default,{disableHeight:!0,children:({width:r})=>(0,t.jsx)(f.I,{frames:i,timeRange:p,timeZone:"browser",mode:j.pm.Changes,height:18*i.length+50,width:r,showValue:c.yL.Never,theme:m,rowHeight:.8,legend:{calcs:[],displayMode:c.lm.List,placement:"bottom",showLegend:!0},legendItems:[{label:"Normal",color:m.colors.success.main,yAxis:1},{label:"Pending",color:m.colors.warning.main,yAxis:1},{label:"Recovering",color:m.colors.warning.main,yAxis:1},{label:"Firing",color:m.colors.error.main,yAxis:1},{label:"No Data",color:m.colors.info.main,yAxis:1},{label:"Mixed",color:m.colors.text.secondary,yAxis:1}],replaceVariables:M})})});P.displayName="LogTimelineViewer"},54302:(z,C,e)=>{e.r(C),e.d(C,{default:()=>de,getStyles:()=>te,useFrameSubset:()=>q});var t=e(74848),E=e(22803),g=e(2543),c=e(96540),I=e(49785),f=e(25229),j=e(63142),M=e(34999),P=e(41654),i=e(66404),p=e(45967),m=e(30703),r=e(45861),d=e(37386),n=e(72636),a=e(63527),s=e(56840),u=e(59614),o=e(86017),A=e(7840),L=e(38055),O=e(74226),U=e(80011),N=e(37658),h=e(78793),D=e(65420),_=e(19161);function G(l){const x=l.reduce((y,v)=>{const S=y.get(v.timestamp);return S?S.push(v):y.set(v.timestamp,[v]),y},new Map);return new Map([...x].sort((y,v)=>v[0]-y[0]))}const b=(0,c.memo)(({records:l,commonLabels:x,onLabelClick:y,onRecordsRendered:v})=>{const S=(0,j.of)($),V=G(l),R=new Map;return(0,c.useEffect)(()=>{v&&v(R)}),(0,t.jsx)("ul",{className:S.logsScrollable,"aria-label":(0,s.t)("alerting.log-record-viewer-by-timestamp.aria-label-state-history-by-timestamp","State history by timestamp"),children:Array.from(V.entries()).map(([F,H])=>(0,t.jsxs)("li",{id:F.toString(10),"data-testid":F,ref:K=>K&&R.set(F,K),className:S.listItemWrapper,children:[(0,t.jsx)(B,{time:F}),(0,t.jsx)("div",{className:S.logsContainer,children:H.map(({line:K})=>(0,t.jsxs)(c.Fragment,{children:[(0,t.jsx)(D.C,{state:K.previous,size:"sm",muted:!0}),(0,t.jsx)(m.I,{name:"arrow-right",size:"sm"}),(0,t.jsx)(D.C,{state:K.current}),(0,t.jsx)(P.B,{children:K.values&&(0,t.jsx)(W,{record:K.values})}),(0,t.jsx)("div",{children:K.labels&&(0,t.jsx)(N.L,{tags:(0,_.$)(Object.entries(K.labels),x).map(([Z,Y])=>`${Z}=${Y}`),onClick:y})})]},(0,g.uniqueId)()))})]},F))})});b.displayName="LogRecordViewerByTimestamp";function T({records:l,commonLabels:x}){const y=useStyles2($),v=groupBy(l,S=>JSON.stringify(S.line.labels));return jsx(Fragment,{children:Object.entries(v).map(([S,V])=>jsxs(Stack,{direction:"column",children:[jsx("h4",{children:jsx(TagList,{tags:omitLabels(Object.entries(V[0].line.labels??{}),x).map(([R,F])=>`${R}=${F}`)})}),jsx("div",{className:y.logsContainer,children:V.map(({line:R,timestamp:F})=>jsxs("div",{children:[jsx(AlertStateTag,{state:R.previous,size:"sm",muted:!0}),jsx(Icon,{name:"arrow-right",size:"sm"}),jsx(AlertStateTag,{state:R.current}),jsx(Stack,{children:R.values&&jsx(W,{record:R.values})}),jsx("div",{children:dateTimeFormat(F)})]},uniqueId()))})]},S))})}const B=({time:l})=>{const x=new Date(l),y=(0,j.of)($);return(0,t.jsx)("div",{className:y.timestampWrapper,children:(0,t.jsxs)(P.B,{alignItems:"center",gap:1,children:[(0,t.jsx)(m.I,{name:"clock-nine",size:"sm"}),(0,t.jsx)("span",{className:y.timestampText,children:(0,U.LE)(x)}),(0,t.jsxs)("small",{children:["(",(0,O.B)(x)," ago)"]})]})})},W=(0,c.memo)(({record:l})=>{const x=Object.entries(l);return(0,t.jsx)(t.Fragment,{children:x.map(([y,v])=>(0,t.jsx)(h.J,{label:y,value:v},y))})});W.displayName="AlertInstanceValues";const $=l=>({logsContainer:(0,E.css)({display:"grid",gridTemplateColumns:"max-content max-content max-content auto max-content",gap:l.spacing(2,1),alignItems:"center"}),logsScrollable:(0,E.css)({height:"500px",overflow:"scroll",flex:1}),timestampWrapper:(0,E.css)({color:l.colors.text.secondary}),timestampText:(0,E.css)({color:l.colors.text.primary,fontSize:l.typography.bodySmall.fontSize,fontWeight:l.typography.fontWeightBold}),listItemWrapper:(0,E.css)({background:"transparent",outline:"1px solid transparent",padding:`${l.spacing(1)} ${l.spacing(1.5)}`,[l.transitions.handleMotion("no-preference","reduce")]:{transition:"background 150ms, outline 150ms"}})});var re=e(88215),oe=e(93571);const ie=10*1e3,le=12,ce=({ruleUID:l})=>{const x=(0,j.of)(te),[y,v]=(0,c.useState)(""),S=(0,c.useRef)(new Map),{getValues:V,setValue:R,register:F,handleSubmit:H}=(0,I.mN)({defaultValues:{query:""}}),{useGetRuleHistoryQuery:K}=u.U,Z=(0,c.useMemo)(()=>me(),[]),{currentData:Y,isLoading:ue,isError:ge,error:se}=K({ruleUid:l,from:Z.from.unix(),to:Z.to.unix(),limit:250},{refetchOnFocus:!0,refetchOnReconnect:!0,pollingInterval:ie}),{dataFrames:X,historyRecords:fe,commonLabels:w,totalRecordsCount:k}=(0,oe.mW)(Y,y),{frameSubset:Q,frameTimeRange:he}=q(X),pe=(0,c.useCallback)(J=>{const ae=(0,o.EU)(V("query"),J);v(ae),R("query",ae)},[v,R,V]),ne=(0,c.useCallback)(()=>{v(""),R("query","")},[v,R]);if(ue)return(0,t.jsx)("div",{children:(0,t.jsx)(s.x6,{i18nKey:"alerting.loki-state-history.loading",children:"Loading..."})});if(ge)return(0,t.jsx)(M.F,{title:(0,s.t)("alerting.loki-state-history.title-error-fetching-the-state-history","Error fetching the state history"),severity:"error",children:se instanceof Error?se.message:"Unable to fetch alert state history"});const ye=Q.length<X.length,Ee=k>0?`No matches were found for the given filters among the ${k} instances`:"No state transitions have occurred in the last 30 days";return(0,t.jsxs)("div",{className:x.fullSize,children:[(0,t.jsxs)("form",{onSubmit:H(J=>v(J.query)),children:[(0,t.jsx)(ee,{...F("query"),showClearFilterSuffix:!!y,onClearFilterClick:ne}),(0,t.jsx)("input",{type:"submit",hidden:!0})]}),!(0,g.isEmpty)(w)&&(0,t.jsxs)(P.B,{gap:1,alignItems:"center",wrap:"wrap",children:[(0,t.jsxs)(P.B,{gap:.5,alignItems:"center",minWidth:"fit-content",children:[(0,t.jsx)(i.E,{variant:"bodySmall",children:(0,t.jsx)(s.x6,{i18nKey:"alerting.loki-state-history.common-labels",children:"Common labels"})}),(0,t.jsx)(p.m,{content:"Common labels are the ones attached to all of the alert instances",children:(0,t.jsx)(m.I,{name:"info-circle",size:"sm"})})]}),(0,t.jsx)(A.m,{labels:(0,g.fromPairs)(w),size:"sm"})]}),(0,g.isEmpty)(Q)?(0,t.jsxs)("div",{className:x.emptyState,children:[Ee,k>0&&(0,t.jsx)(r.$n,{variant:"secondary",type:"button",onClick:ne,children:(0,t.jsx)(s.x6,{i18nKey:"alerting.loki-state-history.clear-filters",children:"Clear filters"})})]}):(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)("div",{className:x.graphWrapper,children:(0,t.jsx)(re.A,{frames:Q,timeRange:he})}),ye&&(0,t.jsx)("div",{className:x.moreInstancesWarning,children:(0,t.jsxs)(P.B,{direction:"row",alignItems:"center",gap:1,children:[(0,t.jsx)(m.I,{name:"exclamation-triangle",size:"sm"}),(0,t.jsx)("small",{children:`Only showing ${Q.length} out of ${X.length} instances. Click on the labels to narrow down the results`})]})}),(0,t.jsx)(b,{records:fe,commonLabels:w,onRecordsRendered:J=>S.current=J,onLabelClick:pe})]})]})};function q(l){return(0,c.useMemo)(()=>{const x=(0,g.take)(l,le),y=(0,g.sortBy)((0,g.uniq)(x.flatMap(H=>H.fields[0].values))),v=Math.min(...y),S=Math.max(...y),V=(0,f.KQ)(v),R=(0,f.KQ)(S);return{frameSubset:x,frameSubsetTimestamps:y,frameTimeRange:{from:V,to:R,raw:{from:V,to:R}}}},[l])}const ee=c.forwardRef(({showClearFilterSuffix:l,onClearFilterClick:x,...y},v)=>(0,t.jsx)(d.D,{label:(0,t.jsx)(n.J,{htmlFor:"instancesSearchInput",children:(0,t.jsxs)(P.B,{gap:.5,children:[(0,t.jsx)("span",{children:(0,t.jsx)(s.x6,{i18nKey:"alerting.search-field-input.filter-instances",children:"Filter instances"})}),(0,t.jsx)(L.B,{content:(0,t.jsxs)(t.Fragment,{children:["Use label matcher expression (like ",(0,t.jsx)("code",{children:"{foo=bar}"}),") or click on an instance label to filter instances"]}),children:(0,t.jsx)(m.I,{name:"info-circle",size:"sm"})})]})}),children:(0,t.jsx)(a.p,{id:"instancesSearchInput",prefix:(0,t.jsx)(m.I,{name:"search"}),suffix:l&&(0,t.jsx)(r.$n,{fill:"text",icon:"times",size:"sm",onClick:x,children:(0,t.jsx)(s.x6,{i18nKey:"alerting.search-field-input.clear",children:"Clear"})}),placeholder:(0,s.t)("alerting.search-field-input.instancesSearchInput-placeholder-filter-instances","Filter instances"),ref:v,...y})}));ee.displayName="SearchFieldInput";function me(){const l=(0,f.KQ)().subtract(30,"days"),x=(0,f.KQ)();return{from:l,to:x,raw:{from:l,to:x}}}const te=l=>({fullSize:(0,E.css)({minWidth:"100%",height:"100%",display:"flex",flexDirection:"column"}),graphWrapper:(0,E.css)({padding:`${l.spacing()} 0`}),emptyState:(0,E.css)({color:l.colors.text.secondary,display:"flex",flexDirection:"column",gap:l.spacing(2),alignItems:"center",margin:"auto auto"}),moreInstancesWarning:(0,E.css)({color:l.colors.warning.text,padding:l.spacing()}),highlightedLogRecord:(0,E.css)({background:`${l.colors.primary.transparent} !important`,outline:`1px solid ${l.colors.primary.shade} !important`})}),de=ce},19161:(z,C,e)=>{e.d(C,{$:()=>g,Q:()=>c});var t=e(2543),E=e.n(t);function g(I,f){return I.filter(j=>!f.find(M=>JSON.stringify(M)===JSON.stringify(j)))}function c(I){const f=I.flatMap(M=>M);return(0,t.uniqBy)(f.filter(M=>f.filter(i=>(0,t.isEqual)(M,i)).length===Object.keys(I).length),M=>JSON.stringify(M))}},93571:(z,C,e)=>{e.d(C,{PA:()=>d,bF:()=>r,mW:()=>m});var t=e(2543),E=e.n(t),g=e(96540),c=e(95004),I=e(11576),f=e(92446),j=e(21275),M=e(63142),P=e(86017),i=e(63895),p=e(19161);function m(a,s){const u=(0,M.$j)();return(0,g.useMemo)(()=>{const o=a?.data?.values[0]??[],A=r(o)?o:[],L=a?.data?.values[1]??[],O=A.reduce((T,B,W)=>{const $=L[W];return d($)&&T.push({timestamp:B,line:$}),T},[]),U=(0,t.groupBy)(O,T=>JSON.stringify(T.line.labels)),h=Object.keys(U).map(T=>Object.entries(JSON.parse(T))),D=(0,p.Q)(h),_=s?(0,i.Zc)(s):[],b=Object.entries(U).filter(([T])=>{const B=JSON.parse(T);return(0,P.Av)(B,_)}).map(([T,B])=>n(T,B,D,u));return{historyRecords:O.filter(({line:T})=>T.labels&&(0,P.Av)(T.labels,_)),dataFrames:b,commonLabels:D,totalRecordsCount:O.length}},[a,s,u])}function r(a){return a.every(s=>typeof s=="number")}function d(a){return typeof a=="object"&&a!==null&&"current"in a&&"previous"in a}function n(a,s,u,o){const A=Object.entries(JSON.parse(a)),L={name:"time",type:c.PU.time,values:[...s.map(h=>h.timestamp),Date.now()],config:{displayName:"Time",custom:{fillOpacity:100}}},O=L.values.map((h,D)=>D);O.sort((0,f.i)(L));const U=[...s.map(h=>h.line.current),s.at(-1)?.line.current],N={fields:[{...L,values:L.values.map((h,D)=>L.values[O[D]])},{name:"State",type:c.PU.string,values:U.map((h,D)=>U[O[D]]),config:{displayName:(0,p.$)(A,u).map(([h,D])=>`${h}=${D}`).join(", "),color:{mode:"thresholds"},custom:{fillOpacity:100},mappings:[{type:j.dM.RegexToText,options:{pattern:"/^normal/i",result:{color:o.colors.success.main}}},{type:j.dM.RegexToText,options:{pattern:"/Alerting/",result:{color:o.colors.error.main}}},{type:j.dM.ValueToText,options:{Pending:{color:o.colors.warning.main},Recovering:{color:o.colors.warning.main},NoData:{color:o.colors.info.main}}}],thresholds:{mode:j.Ol.Absolute,steps:[]}}}],length:L.values.length,name:a};return N.fields.forEach(h=>{h.display=(0,I.J)({field:h,theme:o})}),N}}}]);

//# sourceMappingURL=4302.7f6b0ba3e4c245f87fc3.js.map