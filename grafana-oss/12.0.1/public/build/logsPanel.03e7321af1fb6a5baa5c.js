"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[1477,7884,9604],{78368:(B,M,e)=>{e.d(M,{q:()=>De,g:()=>_});var l=e(74848),r=e(22803),S=e(2543),s=e(96540),R=e(50832),w=e(75505),k=e(739),y=e(67770),d=e(57852),u=e(1906),H=e(28105),I=e(5556),J=e(25229),fe=e(17548),ge=e(75234),me=e(43173),pe=e(63142),ve=e(64400),he=e(92807),Ce=e(78529),Se=e(17896),ye=e(27789),Le=e(88642),Fe=e(23235),X=e(71673),Pe=e(59896),xe=e(20444),z=e(37234);function be(t){return typeof t=="function"}function Re(t){return typeof t=="function"}function Oe(t){return typeof t=="function"}function Ee(t){return typeof t=="function"}function Me(t){return typeof t=="function"}function we(t){return typeof t=="function"}function ke(t){return typeof t=="function"}function Ie(t){return typeof t=="function"}function Z(t){return Array.isArray(t)&&t.every(s.isValidElement)}var Ve=e(24567);const Te={},De=({data:t,timeZone:i,fieldConfig:v,options:{showLabels:V,showTime:h,wrapLogMessage:T,showCommonLabels:A,prettifyLogMessage:U,sortOrder:L,dedupStrategy:F,enableLogDetails:O,showLogContextToggle:P,onClickFilterLabel:ee,onClickFilterOutLabel:te,onClickFilterOutString:ne,onClickFilterString:se,isFilterLabelActive:ae,logRowMenuIconsBefore:oe,logRowMenuIconsAfter:le,enableInfiniteScrolling:He,onNewLogsReceived:G,...x},id:Je})=>{const m=L===k.uH.Ascending,N=(0,pe.of)(Ae),Q=(0,s.useRef)(null),[Y,re]=(0,s.useState)(null),[c,Ue]=(0,s.useState)(null),[C,$]=(0,s.useState)(x.displayedFields??[]),[Ne,ie]=(0,s.useState)(!1),q=(0,s.useRef)(!1),[a,ce]=(0,s.useState)(t),g=(0,Ve.O)(a.request?.targets),b=(0,s.useRef)(null);let j=(0,s.useRef)();const{eventBus:W,onAddAdHocFilter:D}=(0,ve.d2)();(0,s.useEffect)(()=>{(0,ge.J7)().publish(new y.Df({order:L}))},[L]);const Ye=(0,s.useCallback)(n=>{n&&W.publish(new d.b_({point:{time:n.timeEpochMs}}))},[W]),We=(0,s.useCallback)(()=>{W.publish(new d.ql)},[W]),Ke=(0,s.useCallback)(()=>{re(null),j.current&&j.current()},[j]),ze=(0,s.useCallback)((n,o)=>{re(n),j.current=o},[j]),Ge=(0,s.useCallback)(n=>{if(!n.dataFrame.refId||!g||!P&&a.request?.app!==u.Jk.Dashboard&&a.request?.app!==u.Jk.PanelEditor&&a.request?.app!==u.Jk.PanelViewer)return!1;const o=g.get(n.dataFrame.refId);return(0,y.Ol)(o)},[g,P,a.request?.app]),Qe=(0,s.useCallback)(()=>!(a.request?.app!==u.Jk.Dashboard&&a.request?.app!==u.Jk.PanelEditor&&a.request?.app!==u.Jk.PanelViewer),[a.request?.app]),$e=(0,s.useCallback)(async(n,o,f)=>{if(!o.dataFrame.refId||!g)return Promise.resolve({data:[]});const p=a.request?.targets[0];if(!p)return Promise.resolve({data:[]});const K=g.get(o.dataFrame.refId);return(0,y.Ol)(K)?(f.scopedVars=a.request?.scopedVars,K.getLogRowContext(n,f,p)):Promise.resolve({data:[]})},[a.request?.targets,a.request?.scopedVars,g]),qe=(0,s.useCallback)((n,o)=>{if(!n.dataFrame.refId||!g)return(0,l.jsx)(l.Fragment,{});const f=a.request?.targets[0];if(!f)return(0,l.jsx)(l.Fragment,{});const p=g.get(n.dataFrame.refId);return(0,y.wj)(p)?p.getLogRowContextUi?p.getLogRowContextUi(n,o,f,a.request?.scopedVars):(0,l.jsx)(l.Fragment,{}):(0,l.jsx)(l.Fragment,{})},[a.request?.targets,a.request?.scopedVars,g]),[E,Xe,ue]=(0,s.useMemo)(()=>{const n=a?(0,z.HT)(a.series,a.request?.intervalMs,void 0,a.request?.targets):null,o=n?.rows||[],f=n?.meta?.find(K=>K.label===z.yR),p=(0,z.M0)(o,F);return[o,p,f]},[F,a]),Ze=(0,s.useCallback)(async n=>await Be(n,E,a.timeRange),[a.timeRange,E]);(0,s.useEffect)(()=>{t.state!==H.Gu.Loading&&ce(t)},[t]),(0,s.useLayoutEffect)(()=>{if(!Q.current||!c||b.current){b.current=b.current==="infinite-scroll"?null:b.current;return}(a.request?.app===u.Jk.Dashboard||a.request?.app===u.Jk.PanelEditor)&&c.scrollTo(0,m?Q.current.scrollHeight:0)},[a.request?.app,m,c,E]);const _e=(0,s.useCallback)((n,o)=>(0,Ce.QL)({field:n,rowIndex:o,range:a.timeRange}),[a]),et=(0,s.useCallback)(n=>{c?.scrollTo({top:n.offsetTop,behavior:"smooth"})},[c]),tt=(0,s.useCallback)((n,o)=>{D?.({key:n,value:o,operator:"="})},[D]),nt=(0,s.useCallback)((n,o)=>{D?.({key:n,value:o,operator:"!="})},[D]),st=(0,s.useCallback)(n=>{C?.indexOf(n)===-1&&$(C?.concat(n))},[C]),at=(0,s.useCallback)(n=>{const o=C?.indexOf(n);o!==void 0&&o>-1&&$(C?.filter(f=>n!==f))},[C]);(0,s.useEffect)(()=>{x.displayedFields&&$(x.displayedFields)},[x.displayedFields]),(0,s.useEffect)(()=>{function n(){if(!c)return;b.current="user";const o=c.scrollHeight-c.scrollTop-c.clientHeight===0;(c.scrollTop===0&&!m||o&&m)&&(b.current=null)}return c?.addEventListener("scroll",n),c?.addEventListener("wheel",n),()=>{c?.removeEventListener("scroll",n),c?.removeEventListener("wheel",n)}},[m,c]);const ot=(0,s.useCallback)(async n=>{if(!t.request||!me.$.featureToggles.logsInfiniteScrolling||q.current)return;q.current=!0,ie(!0);const o=Ie(G)?G:void 0;let f=[];try{f=await _(g,a,n,i,o)}catch(p){console.error(p)}finally{ie(!1),q.current=!1}b.current="infinite-scroll",ce({...a,series:f})},[t.request,g,G,a,i]);if(!t||E.length===0)return(0,l.jsx)(Le.a,{fieldConfig:v,panelId:Je,data:t,needsStringField:!0});const de=()=>(0,l.jsxs)("div",{className:(0,r.cx)(N.labelContainer,m&&N.labelContainerAscending),children:[(0,l.jsx)("span",{className:N.label,children:"Common labels:"}),(0,l.jsx)(Pe.h,{labels:typeof ue?.value=="object"?ue?.value:Te,emptyMessage:"(no common labels)"})]}),lt=D?tt:void 0,rt=D?nt:void 0,it=we(x.onClickShowField)?x.onClickShowField:st,ct=ke(x.onClickHideField)?x.onClickHideField:at;return(0,l.jsxs)(l.Fragment,{children:[Y&&(0,l.jsx)(ye.V,{open:Y!==null,row:Y,onClose:Ke,getRowContext:(n,o)=>$e(n,Y,o),logsSortOrder:L,timeZone:i,getLogRowContextUi:qe}),(0,l.jsx)(he.P,{ref:n=>Ue(n),children:(0,l.jsxs)("div",{onMouseLeave:We,className:N.container,ref:Q,children:[A&&!m&&de(),(0,l.jsx)(Se.u8,{loading:Ne,loadMoreLogs:He?ot:void 0,range:t.timeRange,timeZone:i,rows:E,scrollElement:c,sortOrder:L,children:(0,l.jsx)(xe.k,{scrollElement:c,scrollIntoView:et,permalinkedRowId:je()?.logs?.id??void 0,onPermalinkClick:Qe()?Ze:void 0,logRows:E,showContextToggle:Ge,deduplicatedRows:Xe,dedupStrategy:F,showLabels:V,showTime:h,wrapLogMessage:T,prettifyLogMessage:U,timeZone:i,getFieldLinks:_e,logsSortOrder:L,enableLogDetails:O,previewLimit:m?E.length:void 0,onLogRowHover:Ye,app:u.Jk.Dashboard,onOpenContext:ze,onClickFilterLabel:be(ee)?ee:lt,onClickFilterOutLabel:Re(te)?te:rt,onClickFilterString:Oe(se)?se:void 0,onClickFilterOutString:Ee(ne)?ne:void 0,isFilterLabelActive:Me(ae)?ae:void 0,displayedFields:C,onClickShowField:C!==void 0?it:void 0,onClickHideField:C!==void 0?ct:void 0,logRowMenuIconsBefore:Z(oe)?oe:void 0,logRowMenuIconsAfter:Z(le)?le:void 0,renderPreview:!m})}),A&&m&&de()]})})]})},Ae=t=>({container:(0,r.css)({marginBottom:t.spacing(1.5)}),labelContainer:(0,r.css)({margin:t.spacing(0,0,.5,.5),display:"flex",alignItems:"center"}),labelContainerAscending:(0,r.css)({margin:t.spacing(.5,0,.5,0)}),label:(0,r.css)({marginRight:t.spacing(.5),fontSize:t.typography.bodySmall.fontSize,fontWeight:t.typography.fontWeightMedium})});function je(){const i=I.kM.getUrlSearchParams()?.panelState;if(i&&Array.isArray(i)&&i?.length>0&&typeof i[0]=="string")try{return JSON.parse(i[0])}catch(v){console.error("error parsing logsPanelState",v)}}async function Be(t,i,v){if(t.rowId===void 0||!t.dataFrame.refId)return;const V={logs:{id:t.uid}},h=new URL(window.location.href);h.searchParams.set("panelState",JSON.stringify(V));const T=(0,X.sU)(t,i,{from:(0,J.yT)(v.from).valueOf(),to:(0,J.yT)(v.to).valueOf()});return h.searchParams.set("from",T.from.toString()),h.searchParams.set("to",T.to.toString()),await(0,X.VP)(h.toString()),Promise.resolve()}async function _(t,i,v,V,h){if(!i.request)return[];const T=fe.convertRawToRange({from:(0,J.oZ)(V,v.from),to:(0,J.oZ)(V,v.to)}),A=(0,S.groupBy)(i.request.targets,"datasource.uid"),U=[];for(const O in A){const P=t.get(i.request.targets[0].refId);if(!P){console.warn(`Could not resolve data source for target ${i.request.targets[0].refId}`);continue}U.push(P.query({...i.request,range:T,targets:A[O]}))}const L=await Promise.all(U);let F=i.series;for(const O of L){const P=(0,R.A)(O)?await(0,w.s)(O):O;F=(0,Fe.Wn)({data:F},{data:P.data}).data,h&&h(F,P.data)}return F}},2001:(B,M,e)=>{e.r(M),e.d(M,{plugin:()=>y});var l=e(16207),r=e(739),S=e(67770),s=e(78368),R=e(38919),w=e(73495);class k{getSuggestionsForData(u){const H=u.getListAppender({name:"",pluginId:"logs",options:{},fieldConfig:{defaults:{custom:{}},overrides:[]}}),{dataSummary:I}=u;!I.hasData||!I.hasTimeField||!I.hasStringField||(I.preferredVisualisationType==="logs"?H.append({name:w.m.Logs,score:R.nQ.Best}):H.append({name:w.m.Logs}))}}const y=new l.m(s.q).setPanelOptions(d=>{d.addBooleanSwitch({path:"showTime",name:"Time",description:"",defaultValue:!1}).addBooleanSwitch({path:"showLabels",name:"Unique labels",description:"",defaultValue:!1}).addBooleanSwitch({path:"showCommonLabels",name:"Common labels",description:"",defaultValue:!1}).addBooleanSwitch({path:"wrapLogMessage",name:"Wrap lines",description:"",defaultValue:!1}).addBooleanSwitch({path:"prettifyLogMessage",name:"Prettify JSON",description:"",defaultValue:!1}).addBooleanSwitch({path:"enableLogDetails",name:"Enable log details",description:"",defaultValue:!0}).addBooleanSwitch({path:"enableInfiniteScrolling",name:"Enable infinite scrolling",description:"Experimental. Request more results by scrolling to the bottom of the logs list.",defaultValue:!1}).addRadio({path:"dedupStrategy",name:"Deduplication",description:"",settings:{options:[{value:r.fY.none,label:"None",description:S._C[r.fY.none]},{value:r.fY.exact,label:"Exact",description:S._C[r.fY.exact]},{value:r.fY.numbers,label:"Numbers",description:S._C[r.fY.numbers]},{value:r.fY.signature,label:"Signature",description:S._C[r.fY.signature]}]},defaultValue:r.fY.none}).addRadio({path:"sortOrder",name:"Order",description:"",settings:{options:[{value:r.uH.Descending,label:"Newest first"},{value:r.uH.Ascending,label:"Oldest first"}]},defaultValue:r.uH.Descending})}).setSuggestionsSupplier(new k)},24567:(B,M,e)=>{e.d(M,{O:()=>s});var l=e(96540),r=e(16817),S=e(78282);const s=R=>{const[w,k]=(0,l.useState)(new Map);return(0,r.A)(async()=>{if(!R){k(new Map);return}const y=await Promise.all(R.filter(d=>!!d.datasource?.uid).map(d=>(0,S.l)().get(d.datasource?.uid).then(u=>({key:d.refId,ds:u}))));k(new Map(y.map(({key:d,ds:u})=>[d,u])))},[R]),w}},51814:B=>{B.exports={id:"loki"}}}]);

//# sourceMappingURL=logsPanel.03e7321af1fb6a5baa5c.js.map