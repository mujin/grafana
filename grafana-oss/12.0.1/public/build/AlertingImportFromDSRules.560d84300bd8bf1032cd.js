"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[9886],{61293:(Y,S,t)=>{t.d(S,{x:()=>J});var e=t(74848),v=t(22803),I=t(96540),x=t(85629),C=t(45861),B=t(63142),D=t(22787),R=t(41654),M=t(37386),T=t(72636),O=t(63527),U=t(64762),G=t(73427),W=t(56840),X=t(15203),r=t(96673);const J=({onCreate:n})=>{const[l,o]=(0,I.useState)(!1),d=c=>{n(c),o(!1)};return(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)(C.$n,{onClick:()=>o(!0),type:"button",icon:"plus",fill:"outline",variant:"secondary",disabled:!G.TP.hasPermission(r.AccessControlAction.FoldersCreate),children:(0,e.jsx)(W.x6,{i18nKey:"alerting.create-new-folder.new-folder",children:"New folder"})}),l&&(0,e.jsx)(V,{onCreate:d,onClose:()=>o(!1)})]})};function V({onClose:n,onCreate:l}){const o=(0,B.of)(u),d=(0,U._2)(),[c,p]=(0,I.useState)(""),[h]=(0,X.Vc)(),H=async()=>{const{data:N,error:k}=await h({title:c});k?d.error("Failed to create folder"):N&&(l({title:N.title,uid:N.uid}),d.success("Folder created"))};return(0,e.jsx)(D.a,{className:o.modal,isOpen:!0,title:(0,W.t)("alerting.create-new-folder.title-new-folder","New folder"),onDismiss:n,onClickBackdrop:n,children:(0,e.jsxs)(R.B,{direction:"column",gap:2,children:[(0,e.jsx)(M.D,{label:(0,e.jsx)(T.J,{htmlFor:"folder",children:(0,e.jsx)(W.x6,{i18nKey:"alerting.create-new-folder.folder.name",children:"Folder name"})}),children:(0,e.jsx)(O.p,{"data-testid":x.Tp.components.AlertRules.newFolderNameField,autoFocus:!0,id:"folderName",placeholder:(0,W.t)("alerting.create-new-folder.placeholder-enter-a-name","Enter a name"),value:c,onChange:N=>p(N.currentTarget.value)})}),(0,e.jsxs)(D.a.ButtonRow,{children:[(0,e.jsx)(C.$n,{variant:"secondary",type:"button",onClick:n,children:(0,e.jsx)(W.x6,{i18nKey:"alerting.create-new-folder.folder.cancel",children:"Cancel"})}),(0,e.jsx)(C.$n,{onClick:H,disabled:!c,"data-testid":x.Tp.components.AlertRules.newFolderNameCreateButton,children:(0,e.jsx)(W.x6,{i18nKey:"alerting.create-new-folder.folder.create",children:"Create"})})]})]})})}const u=n=>({modal:(0,v.css)({width:`${n.breakpoints.values.sm}px`})})},34184:(Y,S,t)=>{t.r(S),t.d(S,{default:()=>Be,supportedImportTypes:()=>de});var e=t(74848),v=t(49785),I=t(42941),x=t(41654),C=t(37386),B=t(89599),D=t(31286),R=t(66404),M=t(3271),T=t(18027),O=t(21285),U=t(45861),G=t(68079),W=t(39989),X=t(70958),r=t(56840),J=t(76792),V=t(42227),u=t(52161),n=t(88547),l=t(36826),o=t(61293),d=t(38133),c=t(22803),p=t(2543),h=t(96540),H=t(36490),N=t(34999),k=t(63142),ae=t(22787),ce=t(71599),me=t(50992),ge=t(64762),fe=t(77256),se=t(74268),pe=t(5709);const he=pe.H.injectEndpoints({endpoints:a=>({convertToGMA:a.mutation({query:({payload:s,targetFolderUID:f,pauseRecordingRules:m,pauseAlerts:i,dataSourceUID:E,targetDatasourceUID:P})=>({url:"/api/convert/prometheus/config/v1/rules",method:"POST",body:s,headers:{"X-Grafana-Alerting-Datasource-UID":E,"X-Grafana-Alerting-Recording-Rules-Paused":m,"X-Grafana-Alerting-Alert-Rules-Paused":i,"X-Disable-Provenance":!0,...f?{"X-Grafana-Alerting-Folder-UID":f}:{},...P?{"X-Grafana-Alerting-Target-Datasource-UID":P}:{}}})})})});var ve=t(39659),xe=t(29442),De=t(75505),Ee=t(68143),Re=t(70327),je=t(55143),oe=t(59672);async function ye(a){return(await(0,De.s)((0,Ee.AI)().fetch({url:"/api/folders",params:{parentUid:a},method:"GET",showErrorAlert:!1,showSuccessAlert:!1})))?.data}function Ce(a,s=!1){const[f,m]=(0,h.useState)([]);return(0,h.useEffect)(()=>{(async()=>{const i=s?[]:await ye(a);m(i)})()},[a,s]),f}function Pe(a,s,f){const m=Ce(s?.uid||"",a),i=a||m.length===0;return{rulesThatMightBeOverwritten:Me(m,f,i)}}function Te(a,s){const f=a?void 0:s,{rulerRules:m,isLoading:i}=(0,oe.h$)(f);return{rulesToBeImported:m,isloadingCloudRules:i}}function Me(a,s,f=!0){const[m]=Re.hK.endpoints.rulerNamespace.useLazyQuery(),[i,E]=(0,h.useState)({});return(0,h.useEffect)(()=>{if(f||(0,p.isEmpty)(a)||(0,p.isEmpty)(s)){E({});return}const P=a.filter(j=>Object.keys(s).includes(j.title));(async()=>{const j={};await Promise.all(P.map(async y=>{const{data:g}=await m({namespace:y.uid,rulerConfig:je.b});if(g){const F=Object.keys(g)[0];F&&(j[F]=g[F]||[])}})),E(j)})()},[a,s,f,m]),i}const ne=()=>(0,e.jsx)(N.F,{title:(0,r.t)("alerting.import-to-gma.confirm-modal.plugin-rules-warning.title","Some rules are excluded from import"),severity:"info",children:(0,e.jsx)(R.E,{variant:"body",children:(0,e.jsx)(r.x6,{i18nKey:"alerting.import-to-gma.confirm-modal.plugin-rules-warning.text",children:"We have detected that some rules are managed by plugins. These rules will not be imported."})})}),Oe=({isOpen:a,onDismiss:s})=>{const{watch:f}=(0,v.xW)(),m=(0,k.of)(ie),[i,E,P,L,j,y,g,F]=f(["targetFolder","selectedDatasourceName","selectedDatasourceUID","pauseRecordingRules","pauseAlertingRules","namespace","ruleGroup","targetDatasourceUID"]),b=a?E??"":void 0,{rulesToBeImported:z,isloadingCloudRules:ee}=Te(!a,b),{filteredConfig:K,someRulesAreSkipped:q}=(0,h.useMemo)(()=>Ae(z,y,g),[z,y,g]),{rulesThatMightBeOverwritten:Z}=Pe(!a,i,K),[te]=he.useConvertToGMAMutation(),w=(0,ge._2)();if(ee)return(0,e.jsx)(ae.a,{isOpen:a,title:(0,r.t)("alerting.import-to-gma.confirm-modal.loading","Loading..."),onDismiss:s,onClickBackdrop:s,children:(0,e.jsx)(R.E,{children:(0,r.t)("alerting.import-to-gma.confirm-modal.loading-body","Preparing data to be imported.This can take a while...")})});async function _(){try{await te({dataSourceUID:P,targetFolderUID:i?.uid,pauseRecordingRules:L,pauseAlerts:j,payload:K,targetDatasourceUID:F}).unwrap();const re=(0,p.isEmpty)(i?.uid);(0,se.iF)();const Se=(0,xe.tx)(re?[]:[["namespace",i?.title??""]],{skipSubPath:!0});w.success((0,r.t)("alerting.import-to-gma.success","Successfully imported alert rules to Grafana-managed rules.")),H.Ny.push(Se)}catch(re){(0,se.Tc)(),w.error((0,r.t)("alerting.import-to-gma.error","Failed to import alert rules: {{error}}",{error:(0,fe.JZ)(re)}))}}if((0,p.isEmpty)(K))return(0,e.jsx)(ae.a,{isOpen:a,title:(0,r.t)("alerting.import-to-gma.confirm-modal.no-rules-title","No rules to import"),onDismiss:s,onClickBackdrop:s,children:(0,e.jsxs)(x.B,{direction:"column",gap:2,children:[q&&(0,e.jsx)(ne,{}),(0,e.jsx)(R.E,{children:(0,r.t)("alerting.import-to-gma.confirm-modal.no-rules-body","There are no rules to import. Please select a different namespace or rule group.")})]})});const A=(0,r.t)("alerting.import-to-gma.confirm-modal.title","Confirm import"),Q=(0,r.t)("alerting.import-to-gma.confirm-modal.confirm","Import");return(0,e.jsx)(ce.u,{isOpen:a,title:A,confirmText:Q,confirmButtonVariant:"primary",modalClass:m.modal,body:(0,e.jsxs)(x.B,{direction:"column",gap:2,children:[!(0,p.isEmpty)(Z)&&(0,e.jsx)(Ie,{targetFolderRules:Z}),q&&(0,e.jsx)(ne,{}),(0,e.jsx)(R.E,{variant:"h6",children:(0,e.jsx)(r.x6,{i18nKey:"alerting.to-gma.confirm-modal.summary",children:"The following alert rules will be imported:"})}),K&&(0,e.jsx)(le,{rules:K})]}),onConfirm:_,onDismiss:s})};function Ae(a,s,f){const m={};let i=!1;return Object.entries(a).forEach(([E,P])=>{if(s&&E!==s)return;const L=P.filter(j=>{if(f&&j.name!==f)return!1;const y=j.rules.filter(g=>g.labels?.[ve.lL]?(i=!0,!1):!0);return{...j,rules:y}});L.length>0&&(m[E]=L)}),{filteredConfig:m,someRulesAreSkipped:i}}function le({rules:a}){const s=(0,k.of)(ie);return(0,e.jsx)("div",{className:s.content,children:(0,e.jsx)(me.B,{width:"100%",height:500,language:"json",value:JSON.stringify(a,null,4),monacoOptions:{minimap:{enabled:!1},scrollBeyondLastLine:!1,lineNumbers:"on",readOnly:!0}})})}const ie=()=>({content:(0,c.css)({flex:"1 1 100%"}),modal:(0,c.css)({width:"800px"})});function Ie({targetFolderRules:a}){const[s,f]=(0,I.A)(!1);return(0,e.jsxs)(x.B,{direction:"column",gap:2,children:[(0,e.jsx)(N.F,{title:(0,r.t)("alerting.to-gma.confirm-modal.title-warning","Warning"),severity:"warning",children:(0,e.jsx)(R.E,{variant:"body",children:(0,e.jsx)(r.x6,{i18nKey:"alerting.to-gma.confirm-modal.body",children:"The target folder is not empty, some rules may be overwritten or removed. Are you sure you want to import these alert rules to Grafana-managed rules?"})})}),a&&(0,e.jsx)(B.S,{label:(0,r.t)("alerting.import-to-gma.confirm-modal.target-folder-rules","Target folder rules that might be overwritten"),isOpen:s,onToggle:f,collapsible:!0,children:(0,e.jsx)(le,{rules:a})})]})}var ue=t(43243);const Le=({rulesSourceName:a})=>{const{control:s,watch:f,formState:{errors:m},setValue:i}=(0,v.xW)(),E=f("namespace"),{namespaceGroups:P,isLoading:L}=(0,oe.$i)(a),j=(0,h.useMemo)(()=>Array.from(P.keys()).map(g=>({label:g,value:g})),[P]),y=(0,h.useMemo)(()=>E&&P.get(E)?.map(g=>({label:g,value:g}))||[],[E,P]);return(0,h.useEffect)(()=>{i("namespace",""),i("ruleGroup","")},[a,i]),(0,e.jsxs)(x.B,{direction:"row",gap:2,children:[(0,e.jsx)(C.D,{htmlFor:"namespace-picker","data-testid":"namespace-picker",label:(0,r.t)("alerting.import-to-gma.namespace.label","Namespace"),description:(0,r.t)("alerting.import-to-gma.namespace.description","Type to search for an existing namespace"),error:m.namespace?.message,invalid:!!m.namespace?.message,children:(0,e.jsx)(v.xI,{render:({field:{onChange:g,ref:F,...b}})=>(0,e.jsx)(ue.G,{...b,onChange:z=>{i("ruleGroup",""),g(z.value)},id:"namespace-picker",placeholder:(0,r.t)("alerting.namespace-and-group-filter.select-namespace","Select namespace"),options:j,width:42,loading:L,disabled:L||!a}),name:"namespace",control:s})}),(0,e.jsx)(C.D,{htmlFor:"group-picker","data-testid":"group-picker",label:(0,r.t)("alerting.import-to-gma.group.label","Group"),description:(0,r.t)("alerting.import-to-gma.group.description","Type to search for an existing group"),error:m.ruleGroup?.message,invalid:!!m.ruleGroup?.message,children:(0,e.jsx)(v.xI,{render:({field:{ref:g,...F}})=>(0,e.jsx)(ue.G,{...F,options:y,width:42,onChange:b=>{i("ruleGroup",b.value??"")},id:"group-picker",placeholder:(0,r.t)("alerting.namespace-and-group-filter.select-group","Select group"),loading:L,disabled:L||!E||!a}),name:"ruleGroup",control:s})})]})},de=[u.ol.Prometheus,u.ol.Loki],Fe=()=>{const[a]=(0,X.s)(),s=String(a.datasourceUid)||"",f=(0,V.ps)(s),m=de.includes(f?.type||"")?f:void 0,i=(0,v.mN)({defaultValues:{selectedDatasourceUID:m?.uid,selectedDatasourceName:m?.name,pauseAlertingRules:!0,pauseRecordingRules:!0,targetFolder:void 0,targetDatasourceUID:void 0}}),{register:E,handleSubmit:P,watch:L,control:j,setValue:y,formState:{errors:g,isSubmitting:F}}=i,[b,z]=(0,I.A)(!0),[ee,K]=L(["targetFolder","selectedDatasourceName"]),[q,Z]=(0,I.A)(!1),te=async()=>{Z(!0)};return(0,e.jsx)(l.d,{navId:"alert-list",pageNav:{text:(0,r.t)("alerting.import-to-gma.pageTitle","Import alert rules from a data source to Grafana-managed rules")},children:(0,e.jsx)(x.B,{gap:2,direction:"column",children:(0,e.jsx)(v.Op,{...i,children:(0,e.jsxs)("form",{onSubmit:P(te),children:[(0,e.jsxs)(x.B,{direction:"column",gap:1,children:[(0,e.jsx)(C.D,{label:(0,r.t)("alerting.import-to-gma.datasource.label","Data source"),invalid:!!g.selectedDatasourceName,error:g.selectedDatasourceName?.message,htmlFor:"datasource-picker",children:(0,e.jsx)(v.xI,{render:({field:{onChange:w,ref:_,...$}})=>(0,e.jsx)(d.q,{...$,width:50,inputId:"datasource-picker",onChange:A=>{y("selectedDatasourceUID",A.uid),y("selectedDatasourceName",A.name);const Q=A.type===u.ol.Prometheus?A.uid:void 0;y("targetDatasourceUID",Q)}}),name:"selectedDatasourceName",rules:{required:{value:!0,message:(0,r.t)("alerting.import-to-gma.datasource.required-message","Please select a data source")}},control:j})}),(0,e.jsxs)(B.S,{label:(0,r.t)("alerting.import-to-gma.additional-settings","Additional settings"),isOpen:b,onToggle:z,collapsible:!0,children:[(0,e.jsxs)(D.a,{marginLeft:1,children:[(0,e.jsx)(D.a,{marginBottom:2,children:(0,e.jsx)(R.E,{variant:"h5",children:(0,r.t)("alerting.import-to-gma.import-location-and-filters","Import location and filters")})}),(0,e.jsx)(C.D,{label:(0,r.t)("alerting.import-to-gma.target-folder.label","Target folder"),description:(0,r.t)("alerting.import-from-dsrules.description-folder-import-rules","The folder to import the rules to"),error:g.selectedDatasourceName?.message,htmlFor:"folder-picker",children:(0,e.jsxs)(x.B,{gap:2,children:[(0,e.jsx)(v.xI,{render:({field:{onChange:w,ref:_,...$}})=>(0,e.jsx)(x.B,{width:42,children:(0,e.jsx)(W.NestedFolderPicker,{showRootFolder:!1,invalid:!!g.targetFolder?.message,...$,value:ee?.uid,onChange:(A,Q)=>{A&&Q?y("targetFolder",{title:Q,uid:A}):y("targetFolder",void 0)}})}),name:"targetFolder",control:j}),(0,e.jsx)(o.x,{onCreate:w=>{y("targetFolder",w)}})]})}),(0,e.jsx)(Le,{rulesSourceName:K||void 0})]}),(0,e.jsx)(M.c,{}),(0,e.jsxs)(D.a,{children:[(0,e.jsx)(D.a,{marginLeft:1,marginBottom:1,children:(0,e.jsx)(R.E,{variant:"h5",children:(0,r.t)("alerting.import-to-gma.alert-rules","Alert rules")})}),(0,e.jsx)(T.I,{transparent:!0,label:(0,r.t)("alerting.import-to-gma.pause.label","Pause imported alerting rules"),labelWidth:30,htmlFor:"pause-alerting-rules",children:(0,e.jsx)(O.K,{transparent:!0,id:"pause-alerting-rules",...E("pauseAlertingRules")})})]}),(0,e.jsx)(M.c,{}),(0,e.jsxs)(D.a,{children:[(0,e.jsx)(D.a,{marginBottom:1,marginLeft:1,children:(0,e.jsx)(R.E,{variant:"h5",children:(0,r.t)("alerting.import-to-gma.recording-rules","Recording rules")})}),(0,e.jsx)(T.I,{transparent:!0,label:(0,r.t)("alerting.import-to-gma.pause-recording.label","Pause imported recording rules"),labelWidth:30,htmlFor:"pause-recording-rules",children:(0,e.jsx)(O.K,{transparent:!0,id:"pause-recording-rules",...E("pauseRecordingRules")})}),(0,e.jsx)(D.a,{marginLeft:1,width:50,children:(0,e.jsx)(C.D,{required:!0,id:"target-data-source",label:(0,r.t)("alerting.recording-rules.label-target-data-source","Target data source"),description:(0,r.t)("alerting.recording-rules.description-target-data-source","The Prometheus data source to store recording rules in"),error:g.targetDatasourceUID?.message,invalid:!!g.targetDatasourceUID?.message,children:(0,e.jsx)(v.xI,{render:({field:{onChange:w,ref:_,...$}})=>(0,e.jsx)(J.s,{...$,current:$.value,noDefault:!0,filter:A=>A.type==="prometheus",onChange:A=>{y("targetDatasourceUID",A.uid)}}),name:"targetDatasourceUID",control:j,rules:{required:{value:!0,message:"Please select a target data source"}}})})})]})]})]}),(0,e.jsx)(D.a,{marginTop:2,children:(0,e.jsxs)(x.B,{gap:1,children:[(0,e.jsx)(U.$n,{type:"submit",variant:"primary",disabled:F||!K,children:(0,e.jsxs)(x.B,{direction:"row",gap:2,alignItems:"center",children:[F&&(0,e.jsx)(G.y,{inline:!0}),(0,e.jsx)(r.x6,{i18nKey:"alerting.import-to-gma.action-button",children:"Import"})]})}),(0,e.jsx)(U.z9,{variant:"secondary",href:"/alerting/list",children:(0,e.jsx)(r.x6,{i18nKey:"common.cancel",children:"Cancel"})})]})}),(0,e.jsx)(Oe,{isOpen:q,onDismiss:()=>Z(!1)})]})})})})},Be=(0,n.S)(Fe)},38133:(Y,S,t)=>{t.d(S,{q:()=>C});var e=t(74848),v=t(96540),I=t(76792),x=t(24296);function C({value:B,disabled:D,...R}){const{rulesSourcesWithRuler:M,isLoading:T}=(0,x.z)(),O=(0,v.useCallback)(U=>M.some(({uid:G})=>G===U.uid),[M]);return(0,e.jsx)(I.s,{disabled:T||D,noDefault:!0,alerting:!0,filter:O,current:B,...R})}},59672:(Y,S,t)=>{t.d(S,{$i:()=>G,DJ:()=>U,h$:()=>W});var e=t(10378),v=t(96540),I=t(70327),x=t(55143),C=t(74869);const{usePrometheusRuleNamespacesQuery:B,useLazyRulerRulesQuery:D,useRulerRulesQuery:R}=I.hK,{useDiscoverDsFeaturesQuery:M}=x.L,T=(0,C.wS)(),O={};function U(u){const{data:n,isLoading:l}=M({rulesSourceName:u}),[o,{data:d=O,isLoading:c}]=D(),{data:p=[],isLoading:h}=B({ruleSourceName:u},{skip:!T});return(0,v.useEffect)(()=>{n?.rulerConfig&&!T&&o({rulerConfig:n.rulerConfig})},[n?.rulerConfig,o]),{labels:(0,v.useMemo)(()=>h||c?new Map:T?J(p):V(d),[p,d,h,c]),isLoading:h||c||l}}function G(u){const{data:n,isLoading:l}=M(u?{rulesSourceName:u}:e.hT,{skip:!u}),[o,{data:d=O,isLoading:c}]=D(),{data:p=[],isLoading:h}=B(u&&T?{ruleSourceName:u}:e.hT);return(0,v.useEffect)(()=>{n?.rulerConfig&&!T&&o({rulerConfig:n.rulerConfig})},[n?.rulerConfig,o]),{namespaceGroups:(0,v.useMemo)(()=>h||c?new Map:T?X(p):r(d),[p,d,h,c]),isLoading:h||c||l,promNamespaces:p}}function W(u){const{data:n,isLoading:l}=M(u?{rulesSourceName:u}:e.hT),{data:o=O,isLoading:d}=R(n?.rulerConfig?{rulerConfig:n.rulerConfig}:e.hT);return{isLoading:d||l,rulerRules:o}}function X(u){const n=new Map;return u.forEach(l=>{n.set(l.name,l.groups.map(o=>o.name))}),n}function r(u){const n=new Map;return Object.entries(u).forEach(([l,o])=>{n.set(l,o.map(d=>d.name))}),n}function J(u){return u.flatMap(l=>l.groups).flatMap(l=>l.rules).reduce((l,o)=>(o.labels&&Object.entries(o.labels).forEach(([d,c])=>{if(!d||!c)return;const p=l.get(d);p?p.add(c):l.set(d,new Set([c]))}),l),new Map)}function V(u){const n=new Map;return Object.entries(u).flatMap(([o,d])=>d).flatMap(o=>o.rules).reduce((o,d)=>(d.labels&&Object.entries(d.labels).forEach(([c,p])=>{if(!c||!p)return;const h=o.get(c);h?h.add(p):o.set(c,new Set([p]))}),o),n)}},24296:(Y,S,t)=>{t.d(S,{z:()=>C});var e=t(96540),v=t(55143),I=t(52161);const{useLazyDiscoverDsFeaturesQuery:x}=v.L;function C(){const[B,D]=(0,e.useState)([]),[R,{isLoading:M}]=x();return(0,e.useEffect)(()=>{(0,I.qi)().forEach(async O=>{const{data:U}=await R({uid:O.uid},!0);U?.rulerConfig&&D(G=>[...G,O])})},[R]),{rulesSourcesWithRuler:B,isLoading:M}}}}]);

//# sourceMappingURL=AlertingImportFromDSRules.560d84300bd8bf1032cd.js.map