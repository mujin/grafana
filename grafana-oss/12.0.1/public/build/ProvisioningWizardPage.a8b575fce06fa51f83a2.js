"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[252],{83813:(k,b,r)=>{r.d(b,{F:()=>y});var e=r(74848),x=r(22803),v=r(96540),i=r(54148),c=r(22787),a=r(45861),j=r(56840),R=r(83560);const y=({confirmRedirect:p,onDiscard:I,onLocationChange:h})=>{const[F,U]=(0,v.useState)(!1),[D,Z]=(0,v.useState)(null),[t,ee]=(0,v.useState)(!1);(0,v.useEffect)(()=>{const N=H=>{p&&(H.preventDefault(),H.returnValue="")};return window.addEventListener("beforeunload",N),()=>{window.removeEventListener("beforeunload",N)}},[p]);const $=N=>{const H=window.location.pathname,Q=N.pathname;if(H===Q)return!0;const w=h?.(N);let z=p&&!t;return w!==void 0&&(z=z&&w),z?(U(!0),Z(N),!1):(w&&I(),!0)},te=()=>{U(!1),Z(null)},ne=()=>{U(!1),ee(!0),I()};return(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)(R.X,{when:!0,message:$}),D&&t&&(0,e.jsx)(i.C5,{replace:!0,to:D}),(0,e.jsx)(T,{isOpen:F,onDiscard:ne,onBackToForm:te})]})},T=({onDiscard:p,onBackToForm:I,isOpen:h})=>(0,e.jsxs)(c.a,{isOpen:h,title:(0,j.t)("form-prompt.title","Leave page?"),onDismiss:I,icon:"exclamation-triangle",className:(0,x.css)({width:"500px"}),children:[(0,e.jsx)("h5",{children:(0,e.jsx)(j.x6,{i18nKey:"form-prompt.description",children:"Changes that you made may not be saved."})}),(0,e.jsxs)(c.a.ButtonRow,{children:[(0,e.jsx)(a.$n,{variant:"secondary",onClick:I,fill:"outline",children:(0,e.jsx)(j.x6,{i18nKey:"form-prompt.continue-button",children:"Continue editing"})}),(0,e.jsx)(a.$n,{variant:"destructive",onClick:p,children:(0,e.jsx)(j.x6,{i18nKey:"form-prompt.discard-button",children:"Discard unsaved changes"})})]})]})},83560:(k,b,r)=>{r.d(b,{X:()=>v});var e=r(96540),x=r(36490);const v=({message:i,when:c=!0})=>{const a=x.Ny.getHistory();return(0,e.useEffect)(()=>{if(!c)return;const j=a.block(i);return()=>{j()}},[c,i,a]),null}},47987:(k,b,r)=>{r.d(b,{w:()=>x});var e=r(79162);function x(v){return v?(0,e.B)(v):{type:"github",title:"Repository",token:"",url:"",branch:"main",generateDashboardPreviews:!1,readOnly:!1,prWorkflow:!0,path:"grafana/",sync:{enabled:!1,target:"instance",intervalSeconds:60}}}},34888:(k,b,r)=>{r.d(b,{c:()=>c});var e=r(74848),x=r(41654),v=r(27594);const i=()=>[{id:"resource",header:"Resource",cell:({row:{original:a}})=>a.resource},{id:"created",header:"Created",cell:({row:{original:a}})=>a.create?.toString()||"-"},{id:"deleted",header:"Deleted",cell:({row:{original:a}})=>a.delete?.toString()||"-"},{id:"updated",header:"Updated",cell:({row:{original:a}})=>a.update?.toString()||"-"},{id:"unchanged",header:"Unchanged",cell:({row:{original:a}})=>a.noop?.toString()||"-"},{id:"errors",header:"Errors",cell:({row:{original:a}})=>a.error?.toString()||"-"},{id:"total",header:"Total",cell:({row:{original:a}})=>((a.create||0)+(a.delete||0)+(a.update||0)+(a.noop||0)+(a.error||0)).toString()}];function c({summary:a}){return(0,e.jsx)(x.B,{direction:"column",gap:2,children:(0,e.jsx)(v.j,{data:a,columns:i(),getRowId:j=>j.resource||"",pageSize:10})})}},48485:(k,b,r)=>{r.d(b,{c:()=>j});var e=r(74848),x=r(22803),v=r(63142),i=r(41654),c=r(89640),a=r(56840);function j(){const y=(0,v.of)(R);return(0,e.jsxs)("div",{className:y.container,children:[(0,e.jsxs)(i.B,{gap:.5,wrap:"wrap",children:[(0,e.jsx)(a.x6,{i18nKey:"provisioning.token-permissions-info.go-to",children:"Go to"}),(0,e.jsx)(c.Y,{external:!0,href:"https://github.com/settings/personal-access-tokens/new",children:"GitHub Personal Access Tokens"}),(0,e.jsx)(a.x6,{i18nKey:"provisioning.token-permissions-info.and-click",children:"and click"}),(0,e.jsx)("strong",{children:'"Fine-grained token".'}),(0,e.jsx)(a.x6,{i18nKey:"provisioning.token-permissions-info.make-sure",children:"Make sure to include these permissions"}),":"]}),(0,e.jsxs)("ul",{className:y.permissionsList,children:[(0,e.jsxs)("li",{children:["Content: ",(0,e.jsx)("span",{className:y.accessLevel,children:"Read and write"})]}),(0,e.jsxs)("li",{children:["Metadata: ",(0,e.jsx)("span",{className:y.accessLevel,children:"Read only"})]}),(0,e.jsxs)("li",{children:["Pull requests: ",(0,e.jsx)("span",{className:y.accessLevel,children:"Read and write"})]}),(0,e.jsxs)("li",{children:["Webhooks: ",(0,e.jsx)("span",{className:y.accessLevel,children:"Read and write"})]})]})]})}function R(y){return{container:(0,x.css)({marginBottom:y.spacing(1),position:"relative",width:"100%",display:"flex",flexDirection:"column",flex:"1 1 0",padding:y.spacing(y.components.panel.padding)}),permissionsList:(0,x.css)({marginTop:y.spacing(2),marginBottom:y.spacing(1),paddingLeft:y.spacing(3),li:(0,x.css)({marginBottom:y.spacing(1)})}),accessLevel:(0,x.css)({fontFamily:y.typography.fontFamilyMonospace,background:"#22262B",borderRadius:y.shape.radius.default,padding:y.spacing(.25,.5)})}}},36474:(k,b,r)=>{r.r(b),r.d(b,{default:()=>We});var e=r(74848),x=r(54148),v=r(13791),i=r(22803),c=r(96540),a=r(49785),j=r(32899),R=r(75234),y=r(68143),T=r(63142),p=r(41654),I=r(31286),h=r(66404),F=r(34999),U=r(45861),D=r(19164),Z=r(83813),t=r(56840),ee=r(47987),$=r(91555),te=r(67170),ne=r(79162);const N=n=>{const o=["local.path","github.branch","github.url","github.token"],l={path:"repository.path",branch:"repository.branch",url:"repository.url",token:"repository.token"};for(const s of n)if(s.field){const d=s.field.replace("spec.","");if(o.includes(d)){const u=d.split("."),g=u[u.length-1];if(g in l)return[l[g],{message:s.detail||`Invalid ${g}`}]}}return[null,null]};var H=r(6975),Q=r(8073),w=r(37386),z=r(63527);function ue(n,o,l){const s=l?.items?.some(d=>d.target==="folder"&&d.name!==o);return n.filter(d=>l?.legacyStorage?d.target==="instance":d.target==="folder"?!0:d.target==="instance"?!s:!1)}function ge(n,o){return(0,c.useMemo)(()=>{const l=[{target:"instance",label:(0,t.t)("provisioning.mode-options.instance.label","Sync all resources with external storage"),description:(0,t.t)("provisioning.mode-options.instance.description","Resources will be synced with external storage and provisioned into this instance. Existing Grafana resources will be migrated and merged if needed. After setup, all new resources and changes will be saved to external storage and automatically provisioned back into the instance."),subtitle:(0,t.t)("provisioning.mode-options.instance.subtitle","Use this option if you want to sync and manage your entire Grafana instance through external storage.")},{target:"folder",label:(0,t.t)("provisioning.mode-options.folder.label","Sync external storage to a new Grafana folder"),description:(0,t.t)("provisioning.mode-options.folder.description","After setup, a new Grafana folder will be created and synced with external storage. If any resources are present in external storage, they will be provisioned to this new folder. All new resources created in this folder will be stored and versioned in external storage."),subtitle:(0,t.t)("provisioning.mode-options.folder.subtitle","Use this option to sync external resources into a new folder without affecting the rest of your instance. You can repeat this process for up to 10 folders.")}];return ue(l,n,o)},[n,o])}function he(n,o){const l=n?.items?.reduce((u,g)=>{const f=g.path??"";return f.endsWith(".json")||f.endsWith(".yaml")?u+1:u},0)??0;let s=[],d=0;return o?.instance?.forEach(u=>{switch(u.group){case"folders":case"folder.grafana.app":d+=u.count,s.push(`${u.count} ${u.count>1?"folders":"folder"}`);break;case"dashboard.grafana.app":d+=u.count,s.push(`${u.count} ${u.count>1?"dashboards":"dashboard"}`);break}}),{fileCount:l,resourceCount:d,resourceCountString:s.join(`,
`)}}function fe({onOptionSelect:n,settingsData:o,repoName:l,onStepStatusUpdate:s}){const{register:d,control:u,setValue:g,watch:f,getValues:m,formState:{errors:P}}=(0,a.xW)(),S=(0,D.v$)(),C=(0,D.Bm)({name:l}),G=f("repository.sync.target"),B=ge(l,o),{resourceCount:K,resourceCountString:O,fileCount:V}=(0,c.useMemo)(()=>he(C.data,S.data),[C.data,S.data]);return(0,c.useEffect)(()=>{const M=m("repository");switch(M.type){case"github":const J=M.url??"github";g("repository.title",J.replace("https://github.com/",""));break;case"local":g("repository.title",M.path??"local");break}},[m,g]),(0,c.useEffect)(()=>{const M=S.isLoading||C.isLoading;s({status:M?"running":"idle"})},[C.isLoading,s,S.isLoading]),(0,c.useEffect)(()=>{const{target:M}=B[0];g("repository.sync.target",M),n(o?.legacyStorage||K>0)},[]),S.isLoading||C.isLoading?(0,e.jsx)(I.a,{padding:4,children:(0,e.jsx)(H._,{text:(0,t.t)("provisioning.bootstrap-step.text-loading-resource-information","Loading resource information...")})}):(0,e.jsx)(p.B,{direction:"column",gap:2,children:(0,e.jsxs)(p.B,{direction:"column",gap:2,children:[(0,e.jsx)(I.a,{alignItems:"center",padding:4,children:(0,e.jsxs)(p.B,{direction:"row",gap:4,alignItems:"flex-start",justifyContent:"center",children:[(0,e.jsxs)(p.B,{direction:"column",gap:1,alignItems:"center",children:[(0,e.jsx)(h.E,{color:"secondary",children:(0,e.jsx)(t.x6,{i18nKey:"provisioning.bootstrap-step.grafana",children:"Grafana instance"})}),(0,e.jsx)(p.B,{direction:"row",gap:2,children:(0,e.jsx)(h.E,{variant:"h4",children:K>0?O:(0,t.t)("provisioning.bootstrap-step.empty","Empty")})})]}),(0,e.jsxs)(p.B,{direction:"column",gap:1,alignItems:"center",children:[(0,e.jsx)(h.E,{color:"secondary",children:(0,e.jsx)(t.x6,{i18nKey:"provisioning.bootstrap-step.ext-storage",children:"External storage"})}),(0,e.jsx)(h.E,{variant:"h4",children:V>0?(0,t.t)("provisioning.bootstrap-step.files-count","{{count}} files",{count:V}):(0,t.t)("provisioning.bootstrap-step.empty","Empty")})]})]})}),(0,e.jsx)(a.xI,{name:"repository.sync.target",control:u,render:({field:{ref:M,onChange:J,...se}})=>(0,e.jsx)(e.Fragment,{children:B.map((W,ae)=>(0,e.jsxs)(Q.Z,{isSelected:W.target===G,onClick:()=>{J(W.target)},...se,children:[(0,e.jsx)(Q.Z.Heading,{children:W.label}),(0,e.jsx)(Q.Z.Description,{children:(0,e.jsxs)(p.B,{direction:"column",gap:3,children:[W.description,(0,e.jsx)(h.E,{color:"primary",children:W.subtitle})]})})]},W.target))})}),G==="folder"&&(0,e.jsx)(w.D,{label:(0,t.t)("provisioning.bootstrap-step.label-display-name","Display name"),description:(0,t.t)("provisioning.bootstrap-step.description-clear-repository-connection","Add a clear name for this repository connection"),error:P.repository?.title?.message,invalid:!!P.repository?.title,required:!0,children:(0,e.jsx)(z.p,{...d("repository.title",{required:(0,t.t)("provisioning.bootstrap-step.error-field-required","This field is required.")}),placeholder:(0,t.t)("provisioning.bootstrap-step.placeholder-my-repository-connection","My repository connection"),autoFocus:B.length===1&&B[0].target==="folder"})})]})})}var ye=r(48767),me=r(48485);function xe(){const{register:n,control:o,setValue:l,formState:{errors:s},getValues:d}=(0,a.xW)(),[u,g]=(0,c.useState)(!1),f=d("repository.type"),m=f==="github";return(0,e.jsxs)(p.B,{direction:"column",children:[m&&(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)(me.c,{}),(0,e.jsx)(w.D,{label:(0,t.t)("provisioning.connect-step.label-access-token","GitHub access token"),required:!0,description:(0,t.t)("provisioning.connect-step.description-paste-your-git-hub-personal-access-token","Paste your GitHub personal access token"),error:s.repository?.token?.message,invalid:!!s.repository?.token,children:(0,e.jsx)(a.xI,{name:"repository.token",control:o,rules:{required:(0,t.t)("provisioning.connect-step.error-field-required","This field is required.")},render:({field:{ref:P,...S}})=>(0,e.jsx)(ye.L4,{...S,id:"token",placeholder:(0,t.t)("provisioning.connect-step.placeholder-github-token","github_pat_yourTokenHere1234567890abcdEFGHijklMNOP"),isConfigured:u,onReset:()=>{l("repository.token",""),g(!1)}})})}),(0,e.jsx)(w.D,{label:(0,t.t)("provisioning.connect-step.label-repository-url","GitHub repository URL"),error:s.repository?.url?.message,invalid:!!s.repository?.url,description:(0,t.t)("provisioning.connect-step.description-repository-url","Paste the URL of your GitHub repository"),required:!0,children:(0,e.jsx)(z.p,{...n("repository.url",{required:(0,t.t)("provisioning.connect-step.error-field-required","This field is required."),pattern:{value:/^(?:https:\/\/github\.com\/)?[^/]+\/[^/]+$/,message:(0,t.t)("provisioning.connect-step.error-invalid-github-url","Please enter a valid GitHub repository URL")}}),placeholder:(0,t.t)("provisioning.connect-step.placeholder-github-url","https://github.com/username/repo")})}),(0,e.jsx)(w.D,{label:(0,t.t)("provisioning.connect-step.label-branch","Branch name"),description:(0,t.t)("provisioning.connect-step.description-branch","Branch to use for the GitHub repository"),error:s.repository?.branch?.message,invalid:!!s.repository?.branch,children:(0,e.jsx)(z.p,{...n("repository.branch"),placeholder:(0,t.t)("provisioning.connect-step.placeholder-branch","main")})}),(0,e.jsx)(w.D,{label:(0,t.t)("provisioning.connect-step.label-path","Path to subdirectory in repository"),error:s.repository?.path?.message,invalid:!!s.repository?.path,description:(0,t.t)("provisioning.connect-step.description-github-path","This is the path to a subdirectory in your GitHub repository where dashboards will be stored and provisioned from"),children:(0,e.jsx)(z.p,{...n("repository.path")})})]}),f==="local"&&(0,e.jsx)(w.D,{label:(0,t.t)("provisioning.connect-step.label-local-path","Local path"),error:s.repository?.path?.message,invalid:!!s.repository?.path,children:(0,e.jsx)(z.p,{...n("repository.path",{required:(0,t.t)("provisioning.connect-step.error-field-required","This field is required.")}),placeholder:(0,t.t)("provisioning.connect-step.placeholder-local-path","/path/to/repo")})})]})}var X=r(32635),re=r(89640),ie=r(53247);function ve(){const{register:n,watch:o,setValue:l}=(0,a.xW)(),[s,d]=o(["repository.type","repository.readOnly"]),u=s==="github",g=(0,ie.ED)(),f=(0,ie.hF)();return(0,c.useEffect)(()=>{l("repository.sync.enabled",!0)},[l]),(0,e.jsxs)(p.B,{direction:"column",children:[u&&(0,e.jsx)(w.D,{label:(0,t.t)("provisioning.finish-step.label-update-instance-interval-seconds","Update instance interval (seconds)"),description:(0,t.t)("provisioning.finish-step.description-often-shall-instance-updates-git-hub","How often shall the instance pull updates from GitHub?"),required:!0,children:(0,e.jsx)(z.p,{...n("repository.sync.intervalSeconds",{valueAsNumber:!0}),type:"number",placeholder:(0,t.t)("provisioning.finish-step.placeholder","60")})}),(0,e.jsx)(w.D,{children:(0,e.jsx)(X.S,{...n("repository.readOnly",{onChange:m=>{m.target.checked&&l("repository.prWorkflow",!1)}}),label:(0,t.t)("provisioning.finish-step.label-read-only","Read only"),description:(0,t.t)("provisioning.finish-step.description-read-only","Resources can't be modified through Grafana.")})}),u&&(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)(w.D,{children:(0,e.jsx)(X.S,{...n("repository.prWorkflow"),disabled:d,label:(0,t.t)("provisioning.finish-step.label-pr-workflow","Enable pull request option when saving"),description:(0,e.jsx)(t.x6,{i18nKey:"provisioning.finish-step.description-pr-enable-description",children:"Allows users to choose whether to open a pull request when saving changes. If the repository does not allow direct changes to the main branch, a pull request may still be required."})})}),(0,e.jsxs)(p.B,{direction:"column",gap:2,children:[(0,e.jsxs)(p.B,{direction:"column",gap:0,children:[(0,e.jsx)(h.E,{element:"h4",children:(0,e.jsx)(t.x6,{i18nKey:"provisioning.finish-step.title-enhance-github",children:"Enhance your GitHub experience"})}),(0,e.jsx)(h.E,{color:"secondary",variant:"bodySmall",children:(0,e.jsx)(t.x6,{i18nKey:"provisioning.finish-step.text-setup-later",children:"You can always set this up later"})})]}),(0,e.jsx)(w.D,{children:(0,e.jsx)(X.S,{disabled:!f||!g,label:(0,t.t)("provisioning.finish-step.label-enable-previews","Enable dashboard previews in pull requests"),description:(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)(t.x6,{i18nKey:"provisioning.finish-step.description-enable-previews",children:"Adds an image preview of dashboard changes in pull requests. Images of your Grafana dashboards will be shared in your Git repository and visible to anyone with repository access."})," ",(0,e.jsx)(h.E,{italic:!0,children:(0,e.jsxs)(t.x6,{i18nKey:"provisioning.finish-step.description-image-rendering",children:["Requires image rendering."," ",(0,e.jsx)(re.Y,{variant:"bodySmall",external:!0,href:"https://grafana.com/grafana/plugins/grafana-image-renderer",children:"Set up image rendering"})]})})]}),...n("repository.generateDashboardPreviews")})})]})]})]})}var je=r(30703);function be({visitedSteps:n=[],steps:o,activeStep:l=o[0]?.id}){const s=(0,T.of)(we);return(0,e.jsx)("ol",{className:s.container,children:o.map((d,u)=>{const g=d.id===l,f=n.includes(d.id)&&!g,m=u===o.length-1,P=(0,i.cx)(s.stepText,{[s.activeStepText]:g});return(0,e.jsxs)("li",{className:s.stepContainer,children:[(0,e.jsxs)("div",{className:s.stepContent,children:[f?(0,e.jsx)("div",{className:(0,i.cx)(s.stepNumber,s.completedStepNumber),children:(0,e.jsx)(je.I,{name:"check",size:"sm"})}):(0,e.jsx)("div",{className:s.stepNumber,children:u+1}),(0,e.jsx)("div",{className:P,children:d.name})]}),!m&&(0,e.jsx)("div",{className:s.connector})]},d.id)})})}const we=n=>({container:(0,i.css)({display:"flex",flexDirection:"column",margin:n.spacing(2,0),padding:0,listStyle:"none",width:200}),stepContainer:(0,i.css)({display:"flex",flexDirection:"column",alignItems:"flex-start",position:"relative"}),stepContent:(0,i.css)({display:"flex",alignItems:"center",padding:n.spacing(.5,0)}),stepNumber:(0,i.css)({display:"flex",justifyContent:"center",alignItems:"center",height:n.spacing(3),width:n.spacing(3),color:n.colors.text.secondary,fontSize:n.typography.size.sm,fontWeight:n.typography.fontWeightMedium,marginRight:n.spacing(1)}),completedStepNumber:(0,i.css)({color:n.colors.success.main}),stepText:(0,i.css)({color:n.colors.text.secondary,fontSize:n.typography.size.md}),activeStepText:(0,i.css)({color:n.colors.text.primary,fontWeight:n.typography.fontWeightMedium}),connector:(0,i.css)({width:"1px",backgroundColor:n.colors.border.medium,height:n.spacing(2),marginLeft:n.spacing(1.5),marginTop:n.spacing(.5)})});var q=r(68079),Ee=r(89599),Ce=r(10378),Se=r(92784);function De({name:n}){const o=(0,D.Sw)(n?{name:n}:Ce.hT),l=o.data;if(!l||o.isLoading)return null;const s=(0,Se.a)(l.spec?.github);return(0,e.jsxs)(p.B,{direction:"column",gap:1,children:[(0,e.jsx)(h.E,{children:(0,e.jsx)(t.x6,{i18nKey:"provisioning.repository-link.grafana-repository-synced",children:"Your resources are now in your external storage and provisioned into your instance. From now on, your instance and the external storage will be synchronized."})}),s&&(0,e.jsx)(p.B,{direction:"row",gap:2,children:(0,e.jsx)(re.Y,{href:s,external:!0,children:(0,e.jsx)(t.x6,{i18nKey:"provisioning.repository-link.view-repository",children:"View repository"})})})]})}const Pe=({progress:n})=>{const o=(0,T.of)(Be);return n===void 0?null:(0,e.jsx)("div",{className:o.container,children:(0,e.jsx)("div",{className:o.filler,style:{width:`${n}%`}})})},Be=n=>({container:(0,i.css)({height:"10px",width:"400px",backgroundColor:n.colors.background.secondary,borderRadius:n.shape.radius.pill,overflow:"hidden",margin:n.spacing(2,0)}),filler:(0,i.css)({height:"100%",background:n.colors.success.text,[n.transitions.handleMotion("no-preference","reduce")]:{transition:"width 0.5s ease-in-out"}})}),Oe=Pe;var Le=r(34888);function oe({job:n,isFinishedJob:o=!1}){if(!n?.status)return null;const{state:l,message:s,progress:d,summary:u,errors:g}=n.status,f=n.metadata?.labels?.["provisioning.grafana.app/repository"],m=()=>{switch(l){case"success":return(0,e.jsx)(F.F,{severity:"success",title:(0,t.t)("provisioning.job-status.status.title-job-completed-successfully","Job completed successfully")});case"error":return(0,e.jsx)(F.F,{severity:"error",title:(0,t.t)("provisioning.job-status.status.title-error-running-job","Error running job"),children:s??g?.join(`
`)})}return(0,e.jsxs)(p.B,{direction:"row",alignItems:"center",justifyContent:"center",gap:2,children:[["working","pending"].includes(l??"")&&(0,e.jsx)(q.y,{size:24}),(0,e.jsx)(h.E,{element:"h4",color:"secondary",children:s??l??""})]})};return(0,e.jsx)(p.B,{direction:"column",gap:2,children:(0,e.jsxs)(p.B,{direction:"column",gap:2,children:[m(),l&&!["success","error"].includes(l)&&(0,e.jsx)(p.B,{direction:"row",alignItems:"center",justifyContent:"center",gap:2,children:(0,e.jsx)(Oe,{progress:d??0})}),o&&u&&(0,e.jsxs)(p.B,{direction:"column",gap:2,children:[(0,e.jsx)(h.E,{variant:"h3",children:(0,e.jsx)(t.x6,{i18nKey:"provisioning.job-status.summary",children:"Summary"})}),(0,e.jsx)(Le.c,{summary:u})]}),l==="success"?(0,e.jsx)(De,{name:f}):(0,e.jsx)(Ee.a,{label:(0,t.t)("provisioning.job-status.label-view-details","View details"),isOpen:!1,children:(0,e.jsx)("pre",{children:JSON.stringify(n,null,2)})})]})})}function Ie({jobUid:n,repositoryName:o,onStatusChange:l}){const s=(0,c.useRef)(!1),d=(0,D.$9)({name:o,uid:n}),u=s.current&&d.isError,g=d.data;return(0,c.useEffect)(()=>{const f=!g&&!s.current&&!d.isFetching;let m;return f&&(s.current=!0,m=setTimeout(()=>{d.refetch()},1e3)),d.isSuccess&&l({status:"success"}),()=>{m&&clearTimeout(m)}},[d,g,l]),u?(l({status:"error"}),(0,e.jsx)(F.F,{severity:"error",title:(0,t.t)("provisioning.job-status.no-job-found","No job found"),children:(0,e.jsx)(t.x6,{i18nKey:"provisioning.job-status.no-job-found-message",children:"The job may have been deleted or could not be retrieved. Cancel the current process and start again."})})):!g||d.isLoading||d.isFetching?(0,e.jsxs)(p.B,{direction:"row",alignItems:"center",justifyContent:"center",gap:2,children:[(0,e.jsx)(q.y,{size:24}),(0,e.jsx)(h.E,{element:"h4",color:"secondary",children:(0,e.jsx)(t.x6,{i18nKey:"provisioning.job-status.loading-finished-job",children:"Loading finished job..."})})]}):(0,e.jsx)(oe,{job:g,isFinishedJob:!0})}function ze({watch:n,onStatusChange:o}){const l=(0,D.L3)({fieldSelector:`metadata.name=${n.metadata?.name}`,watch:!0}),s=l?.data?.items?.[0],d=n.metadata?.labels?.["provisioning.grafana.app/repository"],g=!l.isUninitialized&&!l.isLoading&&!s&&!!d;return l.isLoading?(0,e.jsxs)(p.B,{direction:"row",alignItems:"center",justifyContent:"center",gap:2,children:[(0,e.jsx)(q.y,{size:24}),(0,e.jsx)(h.E,{element:"h4",color:"secondary",children:(0,e.jsx)(t.x6,{i18nKey:"provisioning.job-status.starting",children:"Starting..."})})]}):l.isError?(o({status:"error",error:"Error fetching active job"}),null):s?(0,e.jsx)(oe,{job:s,isFinishedJob:!1}):g?(0,e.jsx)(Ie,{jobUid:n.metadata?.uid,repositoryName:d,onStatusChange:o}):(0,e.jsxs)(p.B,{direction:"row",alignItems:"center",justifyContent:"center",gap:2,children:[(0,e.jsx)(q.y,{size:24}),(0,e.jsx)(h.E,{element:"h4",weight:"bold",children:(0,e.jsx)(t.x6,{i18nKey:"provisioning.job-status.starting",children:"Starting..."})})]})}function Me({onStepStatusUpdate:n,requiresMigration:o}){const[l]=(0,D.bS)(),{getValues:s,register:d,watch:u}=(0,a.xW)(),g=u("repository.sync.target"),[f,m]=(0,c.useState)(),P=async()=>{const[S,C]=s(["migrate.history","repositoryName"]);if(!C){n({status:"error",error:(0,t.t)("provisioning.synchronize-step.error-no-repository-name","No repository name provided")});return}try{n({status:"running"});const B=await l({name:C,jobSpec:o?{migrate:{history:S}}:{pull:{incremental:!1}}}).unwrap();if(!B?.metadata?.name)return n({status:"error",error:(0,t.t)("provisioning.synchronize-step.error-no-job-id","Failed to start job")});m(B)}catch{n({status:"error",error:(0,t.t)("provisioning.synchronize-step.error-starting-job","Error starting job")})}};return f?(0,e.jsx)(ze,{watch:f,onStatusChange:n}):(0,e.jsxs)(p.B,{direction:"column",gap:3,alignItems:"flex-start",children:[(0,e.jsx)(h.E,{color:"secondary",children:(0,e.jsx)(t.x6,{i18nKey:"provisioning.wizard.sync-description",children:"Sync resources with external storage. After this one-time step, all future updates will be automatically saved to the repository and provisioned back into the instance."})}),(0,e.jsx)(F.F,{title:(0,t.t)("provisioning.wizard.alert-title","Important: No data or configuration will be lost, but dashboards will be temporarily unavailable for a few minutes."),severity:"info",children:(0,e.jsxs)("ul",{style:{marginLeft:"16px"},children:[(0,e.jsx)("li",{children:(0,e.jsx)(t.x6,{i18nKey:"provisioning.wizard.alert-point-1",children:"Resources won't be able to be created, edited, or deleted during this process. In the last step, they will disappear."})}),(0,e.jsx)("li",{children:(0,e.jsx)(t.x6,{i18nKey:"provisioning.wizard.alert-point-2",children:"Once provisioning is complete, resources will reappear and be managed through external storage."})}),(0,e.jsx)("li",{children:(0,e.jsx)(t.x6,{i18nKey:"provisioning.wizard.alert-point-3",children:"The duration of this process depends on the number of resources involved."})}),(0,e.jsx)("li",{children:(0,e.jsxs)(t.x6,{i18nKey:"provisioning.wizard.alert-point-4",children:["Enterprise instance administrators can display an announcement banner to users. See"," ",(0,e.jsx)(re.Y,{external:!0,href:"https://grafana.com/docs/grafana/latest/administration/announcement-banner/",children:"this guide"})," ","for step-by-step instructions."]})})]})}),o&&g!=="folder"&&(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)(h.E,{element:"h3",children:(0,e.jsx)(t.x6,{i18nKey:"provisioning.synchronize-step.synchronization-options",children:"Synchronization options"})}),(0,e.jsx)(w.D,{children:(0,e.jsx)(X.S,{...d("migrate.history"),label:(0,t.t)("provisioning.wizard.sync-option-history","History"),description:(0,e.jsx)(t.x6,{i18nKey:"provisioning.synchronize-step.synchronization-description",children:"Include commits for each historical value"})})})]}),(0,e.jsx)(U.$n,{variant:"primary",onClick:P,children:(0,e.jsx)(t.x6,{i18nKey:"provisioning.wizard.button-start",children:"Begin synchronization"})})]})}const Re=(0,R.J7)(),Te=()=>[{id:"connection",name:(0,t.t)("provisioning.wizard.step-connect","Connect"),title:(0,t.t)("provisioning.wizard.title-connect","Connect to external storage"),submitOnNext:!0},{id:"bootstrap",name:(0,t.t)("provisioning.wizard.step-bootstrap","Choose what to synchronize"),title:(0,t.t)("provisioning.wizard.title-bootstrap","Choose what to synchronize"),submitOnNext:!0},{id:"synchronize",name:(0,t.t)("provisioning.wizard.step-synchronize","Synchronize with external storage"),title:(0,t.t)("provisioning.wizard.title-synchronize","Synchronize with external storage"),submitOnNext:!1},{id:"finish",name:(0,t.t)("provisioning.wizard.step-finish","Choose additional settings"),title:(0,t.t)("provisioning.wizard.title-finish","Choose additional settings"),submitOnNext:!0}];function Ne({type:n}){const[o,l]=(0,c.useState)("connection"),[s,d]=(0,c.useState)([]),[u,g]=(0,c.useState)(!1),[f,m]=(0,c.useState)({status:"idle"}),[P,S]=(0,c.useState)(!1),[C,G]=(0,c.useState)(!1),B=(0,D.F9)(),K=(0,x.Zp)(),O=Te(),V=(0,T.of)(Ke),M=(0,ee.w)(),J=(0,a.mN)({defaultValues:{repository:{...M,type:n},migrate:{history:!0}}}),{watch:se,setValue:W,getValues:ae,trigger:Ae,setError:ke,formState:{isDirty:Fe},handleSubmit:Ue}=J,Y=se("repositoryName"),[Ge]=(0,te.A)(Y),[$e]=(0,D.So)(),_=O.findIndex(E=>E.id===o),ce=O[_],He=f.status==="success";(0,c.useEffect)(()=>{B.data?.items.some(E=>E.target==="instance"&&E.name!==Y)&&(Re.publish({type:j.r1.alertError.name,payload:[(0,t.t)("provisioning.wizard-content.error-instance-repository-exists","Instance repository already exists")]}),K($.mL))},[K,Y,B.data?.items]);const Ve=async E=>{try{await $e({name:E}),setTimeout(()=>{K($.mL)},1e3)}catch{G(!1)}},le=async()=>{if(o==="connection"||!Y){K($.mL);return}G(!0),Ve(Y)},Je=(0,c.useCallback)(E=>{const L=O.findIndex(A=>A.id===E);return L===-1||L>=O.length-1?(0,t.t)("provisioning.wizard.button-next","Finish"):O[L+1].name},[O]),de=async()=>{_===O.length-1?K($.mL):(l(O[_+1].id),d(L=>[...new Set([...L,o])]),m({status:"idle"}))},Ye=async()=>{if(ce?.submitOnNext){if((o==="connection"||o==="bootstrap")&&!await Ae(["repository","repository.title"]))return;S(!0);try{const E=ae(),L=(0,ne.t)(E.repository),A=await Ge(L);if(A.error){m({status:"error",error:"Repository request failed"});return}const pe=A.data?.metadata?.name;pe?(W("repositoryName",pe),m({status:"success"}),de()):console.error("Saved repository without a name:",A)}catch(E){if((0,y.NF)(E)){const[L,A]=N(E.data.errors);L&&A&&ke(L,A)}else m({status:"error",error:"Repository connection failed"})}finally{S(!1)}}else He&&de()},Qe=()=>o==="synchronize"?f.status!=="success":P||C||f.status==="running"||o!=="connection"&&f.status==="error";return(0,e.jsx)(a.Op,{...J,children:(0,e.jsxs)(p.B,{gap:6,direction:"row",alignItems:"flex-start",children:[(0,e.jsx)(be,{steps:O,activeStep:o,visitedSteps:s}),(0,e.jsx)("div",{className:V.divider}),(0,e.jsxs)("form",{onSubmit:Ue(Ye),className:V.form,children:[(0,e.jsx)(Z.F,{onDiscard:le,confirmRedirect:Fe&&o!=="finish"&&!C}),(0,e.jsxs)(p.B,{direction:"column",children:[(0,e.jsx)(I.a,{marginBottom:2,children:(0,e.jsxs)(h.E,{element:"h2",children:[_+1,". ",ce?.title]})}),f.status==="error"&&(0,e.jsx)(F.F,{severity:"error",title:"error"in f?f.error:""}),(0,e.jsxs)("div",{className:V.content,children:[o==="connection"&&(0,e.jsx)(xe,{}),o==="bootstrap"&&(0,e.jsx)(fe,{onOptionSelect:g,onStepStatusUpdate:m,settingsData:B.data,repoName:Y??""}),o==="synchronize"&&(0,e.jsx)(Me,{onStepStatusUpdate:m,requiresMigration:u}),o==="finish"&&(0,e.jsx)(ve,{})]}),(0,e.jsxs)(p.B,{gap:2,justifyContent:"flex-end",children:[(0,e.jsx)(U.$n,{variant:"secondary",onClick:le,disabled:P||C,children:C?(0,t.t)("provisioning.wizard-content.button-cancelling","Cancelling..."):(0,t.t)("provisioning.wizard-content.button-cancel","Cancel")}),(0,e.jsx)(U.$n,{type:"submit",disabled:Qe(),children:P?(0,t.t)("provisioning.wizard-content.button-submitting","Submitting..."):Je(o)})]})]})]})]})})}const Ke=n=>({form:(0,i.css)({maxWidth:"900px",flexGrow:1}),divider:(0,i.css)({width:1,alignSelf:"stretch",backgroundColor:n.colors.border.weak,marginBottom:n.spacing(13)}),content:(0,i.css)({borderBottom:`1px solid ${n.colors.border.weak}`,paddingBottom:n.spacing(4),marginBottom:n.spacing(4)})});function We(){const{type:n}=(0,x.g)();return n?(0,e.jsx)(v.Y,{navId:"provisioning",pageNav:{text:n==="github"?"Configure Git Sync":"Configure local file path",subTitle:"Connect to an external storage to manage your resources"},children:(0,e.jsx)(v.Y.Contents,{children:(0,e.jsx)(Ne,{type:n})})}):null}},67170:(k,b,r)=>{r.d(b,{A:()=>v});var e=r(96540),x=r(19164);function v(c){const[a,j]=(0,x.ZL)(),[R,y]=(0,x.hD)(),[T,p]=(0,x.L)();return[(0,e.useCallback)(async h=>(await T({name:c||"new",body:{spec:h}}).unwrap(),c?R({name:c,repository:{metadata:{name:c,finalizers:["cleanup","remove-orphan-resources"]},spec:h}}):a({repository:{metadata:i(h),spec:h}})),[a,c,R,T]),c?y:j,p]}const i=c=>{const a=c.title.toLowerCase().replaceAll(/[^a-z0-9\-_]+/g,"");if(crypto.randomUUID&&a&&a.charAt(0)>="a"&&a.charAt(0)<="z"&&a.replaceAll(/[^a-z]/g,"").length>=3){const j=crypto.randomUUID().substring(0,7);return{name:`${a.substring(0,62-j.length)}-${j}`}}else return{generateName:"r"}}},79162:(k,b,r)=>{r.d(b,{B:()=>v,t:()=>x});const e=i=>{if(i.readOnly)return[];const c=["write"];return i.prWorkflow?[...c,"branch"]:c},x=i=>{const c={type:i.type,sync:i.sync,title:i.title||"",workflows:e(i)};switch(i.type){case"github":c.github={generateDashboardPreviews:i.generateDashboardPreviews,url:i.url||"",branch:i.branch,token:i.token,path:i.path};break;case"local":c.local={path:i.path},c.workflows=c.workflows.filter(a=>a!=="branch");break}return structuredClone(c)},v=i=>structuredClone({...i,...i.github,...i.local,branch:i.github?.branch||"",url:i.github?.url||"",generateDashboardPreviews:i.github?.generateDashboardPreviews||!1,readOnly:!i.workflows.length,prWorkflow:i.workflows.includes("write")})}}]);

//# sourceMappingURL=ProvisioningWizardPage.a8b575fce06fa51f83a2.js.map