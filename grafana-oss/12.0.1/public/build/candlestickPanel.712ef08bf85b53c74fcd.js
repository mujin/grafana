"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[3090],{80959:(el,Pe,s)=>{s.r(Pe),s.d(Pe,{plugin:()=>_e});var ie=s(95004),me=s(16515),Fe=s(16207),ye=s(43173),Oe=s(79277),Ae=s(41069),Se=s(12241),S=s(74848),ve=s(96540),De=s(11576),Ie=s(14477),we=s(21275),J=s(739),Te=s(64400),je=s(63142),ke=s(93630),Ne=s(18667),ge=s(69234),Re=s(3041),de=s(65642),$e=s(78308),Be=s(36327),We=s(57632),Le=s(13507),Ue=s(66881),Me=s(8721),He=s(40665),ze=s(76234),g=(l=>(l.Candles="candles",l.CandlesVolume="candles+volume",l.Volume="volume",l))(g||{}),re=(l=>(l.Candles="candles",l.OHLCBars="ohlcbars",l))(re||{}),B=(l=>(l.CloseClose="close-close",l.OpenClose="open-close",l))(B||{});const pe={down:"red",flat:"gray",up:"green"},Q={...{candleStyle:"candles",colorStrategy:"open-close",colors:{down:"red",up:"green",flat:"gray"},fields:{},includeAllFields:!1,mode:"candles+volume"},legend:{displayMode:J.lm.List,showLegend:!0,placement:"bottom",calcs:[]},tooltip:{mode:J.$N.Multi,sort:J.xB.None}},Y={open:{key:"open",name:"Open",defaults:["open","o"],description:"Value at the start of the period"},high:{key:"high",name:"High",defaults:["high","h","max"],description:"Maximum value within the period"},low:{key:"low",name:"Low",defaults:["low","l","min"],description:"Minimum value within the period"},close:{key:"close",name:"Close",defaults:["close","c"],description:"Value at the end of the period"},volume:{key:"volume",name:"Volume",defaults:["volume","v"],description:"Sample count within the period"}};function Ee(l,i,r){const t=(0,He.findField)(l,r[i.key]);if(!t)for(const f of l.fields){const M=(0,me.Ct)(f,l).toLowerCase();if(i.defaults.includes(M)||i.defaults.includes(f.name))return f}return t}function xe(l,i,r,t){if(!l?.length)return null;const f=i.fields??{},M=l.length===1?(0,Me.Yj)(l[0],l[0].fields.findIndex(o=>o.type===ie.PU.time)):(0,Me.Fd)({frames:l});if(!M?.length)return null;const e={aligned:M,frame:M,names:{}},W=(0,ze.B_)([M],r,t);if(!W)return null;const m=e.frame=W[0],L=m.fields.findIndex(o=>o.type===ie.PU.time);if(L<0)return null;const c=new Set;for(const o of Object.values(Y)){const p=Ee(m,o,f);p&&(e[o.key]=p,c.add(p))}if(!e.open&&!e.close&&(e.open=m.fields.find(o=>o.type===ie.PU.number),e.open&&c.add(e.open)),e.open&&!e.close&&!f.close){const o=e.open.values.slice(1);o.push(o[o.length-1]),e.close={...e.open,values:o,name:"Next open",state:void 0},c.add(e.close),m.fields.push(e.close),e.autoOpenClose=!0}if(e.close&&!e.open&&!f.open){const o=e.close.values.slice();o.unshift(o[0]),o.length=m.length,e.open={...e.close,values:o,name:"Previous close",state:void 0},c.add(e.open),m.fields.push(e.open),e.autoOpenClose=!0}!e.high&&!f.high&&(e.high=e.open),!e.low&&!f.low&&(e.low=e.open),i.mode===g.Volume?(e.high&&(e.high!==e.open&&c.delete(e.high),e.high=void 0),e.low&&(e.low!==e.open&&c.delete(e.low),e.low=void 0)):i.mode===g.Candles&&e.volume&&(c.delete(e.volume),e.volume=void 0);for(const o of Object.values(Y)){const p=e[o.key];p&&(e.names[o.key]=(0,me.Ct)(p,e.frame))}const X=m.fields[L],D=[X];i.includeAllFields?D.push(...m.fields.filter(o=>o!==X)):D.push(...c),e.frame={...e.frame,fields:D};for(let o=0;o<e.frame.fields.length;o++){const p=e.frame.fields[o];p.state={...p.state,seriesIndex:o-1,origin:{fieldIndex:o,frameIndex:0}}}return e}var Ke=s(6773);const{alpha:Ce}=Ke.MV;function Qe(l){let{mode:i,candleStyle:r,fields:t,colorStrategy:f,upColor:M,downColor:e,flatColor:W,volumeAlpha:m,flatAsUp:L=!0}=l;const c=i!==g.Volume&&t.high!=null&&t.low!=null,X=c&&r===re.Candles,D=i!==g.Candles&&t.volume!=null;function o(n,V,w,I,k){return n>0?w:n<0?I:k?w:V}let p=0,fe=t.open,ue=t.high,ce=t.low,te=t.close,C=t.volume;return n=>{let V,w,I,k,Z,G;c&&(I=new Path2D,w=new Path2D,V=new Path2D),D&&(k=new Path2D,Z=new Path2D,G=new Path2D);let oe=new Path2D,a=n.ctx,P=n.data[p],y=n.data[fe],F=n.data[te],U=c?n.data[ue]:null,ne=c?n.data[ce]:null,b=D?n.data[C]:null,H=C!=null?Math.round(n.valToPos(0,n.series[C].scale,!0)):null,[O,q]=n.series[0].idxs,A=n.data[0],N=y,se=n.bbox.width;if(A.length>1){let d=null;for(let h=0,u=1/0;h<A.length;h++)if(N[h]!==void 0){if(d!=null){let x=Math.abs(A[h]-A[d]);x<u&&(u=x,se=Math.abs(n.valToPos(A[h],"x",!0)-n.valToPos(A[d],"x",!0)))}d=h}}let z=Math.round(.6*se),E=2,T=2;z<=12&&(E=T=1);let j=Math.floor(z/2);for(let d=O;d<=q;d++){let h=Math.round(n.valToPos(P[d],"x",!0)),u=d===O?0:Math.sign(F[d]-F[d-1]),x=Math.sign(F[d]-y[d]);if(D&&G&&Z&&k){let v=o(f===B.CloseClose?u:x,G,Z,k,d===O&&B.CloseClose?!1:L),R=Math.round(n.valToPos(b[d],n.series[C].scale,!0));v.rect(h-j,R,z,H-R)}if(c&&I&&w&&V){let v=o(f===B.CloseClose?u:x,I,w,V,d===O&&B.CloseClose?!1:L),R=Math.round(n.valToPos(U[d],n.series[ue].scale,!0)),ae=Math.round(n.valToPos(ne[d],n.series[ce].scale,!0));v.rect(h-Math.floor(E/2),R,E,ae-R);let _=Math.round(n.valToPos(y[d],n.series[fe].scale,!0)),$=Math.round(n.valToPos(F[d],n.series[te].scale,!0));if(X){let ee=Math.min(_,$),he=Math.max(_,$),K=Math.max(1,he-ee);v.rect(h-j,ee,z,K),f===B.CloseClose&&x>=0&&K>T*2&&oe.rect(h-j+T,ee+T,z-T*2,K-T*2)}else v.rect(h-j,_,j,E),v.rect(h,$,j,E)}}a.save(),a.rect(n.bbox.left,n.bbox.top,n.bbox.width,n.bbox.height),a.clip(),D&&G&&Z&&k&&(a.fillStyle=Ce(M,m),a.fill(Z),a.fillStyle=Ce(e,m),a.fill(k),a.fillStyle=Ce(W,m),a.fill(G)),c&&I&&w&&V&&(a.fillStyle=M,a.fill(w),a.fillStyle=e,a.fill(V),a.fillStyle=W,a.fill(I),a.globalCompositeOperation="destination-out",a.fill(oe)),a.restore()}}const Ye=({data:l,id:i,timeRange:r,timeZone:t,width:f,height:M,options:e,fieldConfig:W,onChangeTimeRange:m,replaceVariables:L})=>{const{sync:c,eventsScope:X,canAddAnnotations:D,onThresholdsChange:o,canEditThresholds:p,showThresholds:fe,dataLinkPostProcessor:ue,eventBus:ce}=(0,Te.d2)(),te=(0,je.$j)(),C=(0,ve.useMemo)(()=>xe(l.series,e,te,r),[l.series,e,te,r]),[n,V]=(0,ve.useState)(null),w=c?.()??we.yV.Off,{renderers:I,tweakScale:k,tweakAxis:Z,shouldRenderPrice:G}=(0,ve.useMemo)(()=>{let a=(u,x)=>u,P=(u,x)=>u,y={renderers:[],tweakScale:a,tweakAxis:P,shouldRenderPrice:!1};if(!C)return y;const F=C.names;if(!Object.keys(F).length)return y;const{mode:U,candleStyle:ne,colorStrategy:b}=e,H={...pe,...e.colors};let{open:O,high:q,low:A,close:N,volume:se}=F;if(O==null||N==null)return y;let z=.5,E=-1,T=!1;if(se!=null&&U!==g.Candles){let u=C.volume;if(u!=null){T=!0;let{fillOpacity:x}=u.config.custom;x&&(z=x/100),U!==g.Volume&&(u.config={...u.config},u.config.unit="short",u.display=(0,De.J)({field:u,theme:de.$W.theme2}),P=(v,R)=>{if(R.name===C.volume?.name){let ae=(_,$)=>{let ee=[],he=_.series[E].max;for(let K=0;K<$.length&&(ee.push($[K]),!(he&&$[K]>he));K++);return ee};v.space=20,v.filter=ae,v.ticks={...v.ticks,filter:ae}}return v},a=(v,R)=>(R.name===C.volume?.name&&(v.range=(ae,_,$)=>[0,$*7]),v))}}let j=U!==g.Volume&&q!=null&&A!=null;if(!j&&!T)return y;let d={},h=[];return j?d={open:O,high:q,low:A,close:N}:h.push(O,N),T&&(d.volume=se,d.open=O,d.close=N),{shouldRenderPrice:j,renderers:[{fieldMap:d,indicesOnly:h,init:(u,x)=>{E=x.volume,u.addHook("drawAxes",Qe({mode:U,fields:x,upColor:de.$W.theme2.visualization.getColorByName(H.up),downColor:de.$W.theme2.visualization.getColorByName(H.down),flatColor:de.$W.theme2.visualization.getColorByName(H.flat),volumeAlpha:z,colorStrategy:b,candleStyle:ne,flatAsUp:!0}))}}],tweakScale:a,tweakAxis:P}},[e,l.structureRev,l.series.length]);if(!C)return(0,S.jsx)(Ie.a,{panelId:i,fieldConfig:W,data:l,needsTimeField:!0,needsNumberField:!0});if(G)for(let a in I[0].fieldMap){let P=C[a];P.config={...P.config,custom:{...P.config.custom,hideFrom:{legend:!0,tooltip:!1,viz:!1}}}}const oe=!!D?.();return(0,S.jsx)(Re.Z,{frames:[C.frame],structureRev:l.structureRev,timeRange:r,timeZone:t,width:f,height:M,legend:e.legend,renderers:I,tweakAxis:Z,tweakScale:k,options:e,replaceVariables:L,dataLinkPostProcessor:ue,cursorSync:w,children:(a,P)=>(0,S.jsxs)(S.Fragment,{children:[(0,S.jsx)(ke.Z,{config:a}),w!==we.yV.Off&&(0,S.jsx)(Ne.K,{config:a,eventBus:ce,frame:P}),e.tooltip.mode!==J.$N.None&&(0,S.jsx)(ge.xl,{config:a,hoverMode:e.tooltip.mode===J.$N.Single?ge.b3.xOne:ge.b3.xAll,queryZoom:m,clientZoom:!0,syncMode:w,syncScope:X,getDataLinks:(y,F)=>P.fields[y].getLinks?.({valueRowIndex:F})??[],render:(y,F,U,ne=!1,b,H,O,q)=>{if(oe&&H!=null){V(H),b();return}const A=()=>{let N=y.posToVal(y.cursor.left,"x");V({from:N,to:N}),b()};return(0,S.jsx)($e.k,{series:P,dataIdxs:F,seriesIdx:U,mode:O?J.$N.Multi:e.tooltip.mode,sortOrder:e.tooltip.sort,isPinned:ne,annotate:oe?A:void 0,maxHeight:e.tooltip.maxHeight,replaceVariables:L,dataLinks:q})},maxWidth:e.tooltip.maxWidth}),(0,S.jsx)(Be.W,{annotations:l.annotations??[],config:a,timeZone:t,newRange:n,setNewRange:V}),(0,S.jsx)(Le.U,{config:a,onChangeTimeRange:m}),l.annotations&&(0,S.jsx)(We.z,{config:a,exemplars:l.annotations,timeZone:t}),(p&&o||fe)&&(0,S.jsx)(Ue.p,{config:a,fieldConfig:W,onThresholdsChange:p?o:void 0})]})})};var Ve=s(38919),Ze=s(73495);class Ge{getSuggestionsForData(i){const{dataSummary:r}=i;if(!i.data?.series||!r.hasData||r.timeFieldCount<1||r.numberFieldCount<2||r.numberFieldCount>10)return;const t=xe(i.data.series,Q,ye.$.theme2);if(!t||t.open===t.high&&t.open===t.low)return;i.getListAppender({name:"",pluginId:"candlestick",options:{},fieldConfig:{defaults:{custom:{}},overrides:[]}}).append({name:Ze.m.Candlestick,options:Q,fieldConfig:{defaults:{},overrides:[]},score:t.autoOpenClose?Ve.nQ.Good:Ve.nQ.Best})}}const Je=[{label:"Candles",value:g.Candles},{label:"Volume",value:g.Volume},{label:"Both",value:g.CandlesVolume}],Xe=[{label:"Candles",value:re.Candles},{label:"OHLC Bars",value:re.OHLCBars}],be=[{label:"Since Open",value:B.OpenClose},{label:"Since Prior Close",value:B.CloseClose}],qe=l=>l.type===ie.PU.number;function le(l,i,r){let t="Auto ";if(r){const f=r[i.key];f?.config?(t+="= "+(0,me.Ct)(f),f===r?.open&&i.key!=="open"&&(t+=` (${i.defaults.join(",")})`)):t+=`(${i.defaults.join(",")})`}l.addFieldNamePicker({path:`fields.${i.key}`,name:i.name,description:i.description,settings:{filter:qe,placeholderText:t}})}const _e=new Fe.m(Ye).useFieldConfig((0,Se.V)(Se.S)).setPanelOptions((l,i)=>{const r=i.options??Q,t=xe(i.data,r,ye.$.theme2);l.addRadio({path:"mode",name:"Mode",description:"",defaultValue:Q.mode,settings:{options:Je}}).addRadio({path:"candleStyle",name:"Candle style",description:"",defaultValue:Q.candleStyle,settings:{options:Xe},showIf:f=>f.mode!==g.Volume}).addRadio({path:"colorStrategy",name:"Color strategy",description:"",defaultValue:Q.colorStrategy,settings:{options:be}}).addColorPicker({path:"colors.up",name:"Up color",defaultValue:pe.up}).addColorPicker({path:"colors.down",name:"Down color",defaultValue:pe.down}),le(l,Y.open,t),r.mode!==g.Volume&&(le(l,Y.high,t),le(l,Y.low,t)),le(l,Y.close,t),r.mode!==g.Candles&&le(l,Y.volume,t),l.addRadio({path:"includeAllFields",name:"Additional fields",description:"Use standard timeseries options to configure any fields not mapped above",defaultValue:Q.includeAllFields,settings:{options:[{label:"Ignore",value:!1},{label:"Include",value:!0}]}}),Oe.D(l,!1,!0),Ae.H(l)}).setDataSupport({annotations:!0,alertStates:!0}).setSuggestionsSupplier(new Ge)}}]);

//# sourceMappingURL=candlestickPanel.712ef08bf85b53c74fcd.js.map