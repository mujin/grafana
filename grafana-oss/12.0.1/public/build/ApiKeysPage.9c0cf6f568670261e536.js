"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[4196],{77125:(le,x,a)=>{a.r(x),a.d(x,{ApiKeysPageUnconnected:()=>C,MigrationSummary:()=>E,default:()=>ne});var e=a(74848),u=a(96540),D=a(71468),j=a(18027),b=a(21285),T=a(50201),f=a(22787),g=a(45861),v=a(13791),A=a(73427),t=a(56840),w=a(34984),k=a(96673),R=a(12737);const F=({searchQuery:i,disabled:s,onSearchChange:n})=>(0,e.jsx)("div",{className:"page-action-bar",children:(0,e.jsx)(j.I,{grow:!0,children:(0,e.jsx)(R.Z,{placeholder:(0,t.t)("api-keys.api-keys-action-bar.placeholder-search-keys","Search keys"),value:i,onChange:n})})});var y=a(22803),K=a(80011),I=a(63142),N=a(45967),B=a(30703),Q=a(41654),L=a(44458);const O=({apiKeys:i,timeZone:s,onDelete:n,onMigrate:o})=>{const c=(0,I.$j)(),l=U(c);return(0,e.jsxs)("table",{className:"filter-table",children:[(0,e.jsx)("thead",{children:(0,e.jsxs)("tr",{children:[(0,e.jsx)("th",{children:(0,e.jsx)(t.x6,{i18nKey:"api-keys.api-keys-table.name",children:"Name"})}),(0,e.jsx)("th",{children:(0,e.jsx)(t.x6,{i18nKey:"api-keys.api-keys-table.role",children:"Role"})}),(0,e.jsx)("th",{children:(0,e.jsx)(t.x6,{i18nKey:"api-keys.api-keys-table.expires",children:"Expires"})}),(0,e.jsx)("th",{children:(0,e.jsx)(t.x6,{i18nKey:"api-keys.api-keys-table.last-used-at",children:"Last used at"})}),(0,e.jsx)("th",{style:{width:"34px"}})]})}),i.length>0?(0,e.jsx)("tbody",{children:i.map(r=>{const d=!!(r.expiration&&Date.now()>new Date(r.expiration).getTime());return(0,e.jsxs)("tr",{className:l.tableRow(d),children:[(0,e.jsx)("td",{children:r.name}),(0,e.jsx)("td",{children:r.role}),(0,e.jsxs)("td",{children:[z(r.expiration,s),d&&(0,e.jsx)("span",{className:l.tooltipContainer,children:(0,e.jsx)(N.m,{content:"This API key has expired.",children:(0,e.jsx)(B.I,{name:"exclamation-triangle"})})})]}),(0,e.jsx)("td",{children:$(s,r.lastUsedAt)}),(0,e.jsx)("td",{children:(0,e.jsxs)(Q.B,{justifyContent:"flex-end",children:[(0,e.jsx)(g.$n,{size:"sm",onClick:()=>o(r),children:(0,e.jsx)(t.x6,{i18nKey:"api-keys.api-keys-table.migrate-to-service-account",children:"Migrate to service account"})}),(0,e.jsx)(L.e,{"aria-label":(0,t.t)("api-keys.api-keys-table.aria-label-delete-api-key","Delete API key"),size:"sm",onConfirm:()=>n(r),disabled:!A.TP.hasPermissionInMetadata(k.AccessControlAction.ActionAPIKeysDelete,r)})]})})]},r.id)})}):null]})};function $(i,s){return s?(0,K.LE)(s,{timeZone:i}):"Never"}function z(i,s){return i?(0,K.LE)(i,{timeZone:s}):"No expiration date"}const U=i=>({tableRow:s=>(0,y.css)({color:s?i.colors.text.secondary:i.colors.text.primary}),tooltipContainer:(0,y.css)({marginLeft:i.spacing(1)})});var P=a(34999),V=a(71599);const Y=({onMigrate:i,apikeysCount:s,disabled:n})=>{const[o,c]=(0,u.useState)(!1),l=(0,I.of)(Z),r=(0,e.jsx)("a",{className:"external-link",href:"https://grafana.com/docs/grafana/latest/administration/service-accounts/migrate-api-keys/",target:"_blank",rel:"noopener noreferrer",children:(0,e.jsx)(t.x6,{i18nKey:"api-keys.migrate-to-service-accounts-card.docs-link.about-migration",children:"Find out more about the migration here."})}),d=(0,e.jsx)("span",{children:(0,e.jsx)(t.x6,{i18nKey:"api-keys.migrate-to-service-accounts-card.migration-box-desc.migrating",children:"Migrating all API keys will hide the API keys tab."})});return(0,e.jsxs)(e.Fragment,{children:[s>0&&(0,e.jsxs)(P.F,{title:(0,t.t)("api-keys.migrate-to-service-accounts-card.title-switch-service-accounts","Switch from API keys to service accounts"),severity:"warning",children:[(0,e.jsx)("div",{className:l.text,children:(0,e.jsxs)(t.x6,{i18nKey:"api-keys.migrate-to-service-accounts-card.body-switch-service-accounts",components:{docsLink:r},children:["API keys are deprecated and will be removed from Grafana on Jan 31, 2025. Each API key will be migrated into a service account with a token and will continue to work as they were. We encourage you to migrate your API keys to service accounts now. ","<docsLink />"]})}),(0,e.jsxs)("div",{className:l.actionRow,children:[(0,e.jsx)(g.$n,{className:l.actionButton,onClick:()=>c(!0),children:(0,e.jsx)(t.x6,{i18nKey:"api-keys.migrate-to-service-accounts-card.migrate-all-service-accounts",children:"Migrate all service accounts"})}),(0,e.jsx)(V.u,{title:(0,t.t)("api-keys.migrate-to-service-accounts-card.modal-title","Migrate API keys to service accounts"),isOpen:o,body:d,confirmText:"Yes, migrate now",onConfirm:i,onDismiss:()=>c(!1),confirmVariant:"primary",confirmButtonVariant:"primary"})]})]}),s===0&&(0,e.jsx)(e.Fragment,{children:(0,e.jsx)(P.F,{title:(0,t.t)("api-keys.migrate-to-service-accounts-card.title-no-api-keys-found","No API keys found"),severity:"warning",children:(0,e.jsx)("div",{className:l.text,children:(0,e.jsx)(t.x6,{i18nKey:"api-keys.migrate-to-service-accounts-card.body-no-api-keys-found",children:"No API keys were found. If you reload the browser, this page will not be available anymore."})})})})]})},Z=i=>({text:(0,y.css)({marginBottom:i.spacing(2)}),actionRow:(0,y.css)({display:"flex",alignItems:"center"}),actionButton:(0,y.css)({marginRight:i.spacing(2)})});var h=a(83873),p=a(78653);function m(){return async i=>{i((0,p.h8)());const[s,n]=await Promise.all([(0,h.AI)().get("/api/auth/keys?includeExpired=false&accesscontrol=true"),(0,h.AI)().get("/api/auth/keys?includeExpired=true&accesscontrol=true")]);i((0,p.Sf)({keys:s,keysIncludingExpired:n}))}}function G(i){return async s=>{(0,h.AI)().delete(`/api/auth/keys/${i}`).then(()=>s(m()))}}function J(i){return async s=>{try{await(0,h.AI)().post(`/api/serviceaccounts/migrate/${i}`)}finally{s(m())}}}function W(){return async i=>{try{const s=await(0,h.AI)().post("/api/serviceaccounts/migrate");i((0,p.QB)(s))}finally{i(m())}}}function H(){return i=>{i((0,p.cV)())}}const X=i=>i.includeExpired?i.keysIncludingExpired.length:i.keys.length,q=i=>{const s=RegExp(i.searchQuery,"i");return(i.includeExpired?i.keysIncludingExpired:i.keys).filter(o=>s.test(o.name)||s.test(o.role))},_=i=>i.includeExpired,ee=i=>i.keys.length===0&&i.keysIncludingExpired.length>0;function ie(i){const s=A.TP.hasPermission(k.AccessControlAction.ActionAPIKeysCreate);return{apiKeys:q(i.apiKeys),searchQuery:i.apiKeys.searchQuery,apiKeysCount:X(i.apiKeys),hasFetched:i.apiKeys.hasFetched,timeZone:(0,w.O)(i.user),includeExpired:_(i.apiKeys),includeExpiredDisabled:ee(i.apiKeys),canCreate:s,migrationResult:i.apiKeys.migrationResult}}const se={navId:"apikeys"},te={loadApiKeys:m,deleteApiKey:G,migrateApiKey:J,migrateAll:W,setSearchQuery:p.Ri,toggleIncludeExpired:H},ae=(0,D.connect)(ie,te);class C extends u.PureComponent{constructor(s){super(s),this.onDeleteApiKey=n=>{this.props.deleteApiKey(n.id)},this.onMigrateApiKey=n=>{this.props.migrateApiKey(n.id)},this.onSearchQueryChange=n=>{this.props.setSearchQuery(n)},this.onIncludeExpiredChange=n=>{this.props.toggleIncludeExpired()},this.onMigrateApiKeys=async()=>{try{await this.props.migrateAll(),this.setState({showMigrationResult:!0})}catch(n){console.error(n)}},this.dismissModal=async()=>{this.setState({showMigrationResult:!1})},this.state={showMigrationResult:!1}}componentDidMount(){this.fetchApiKeys()}async fetchApiKeys(){await this.props.loadApiKeys()}render(){const{hasFetched:s,apiKeysCount:n,apiKeys:o,searchQuery:c,timeZone:l,includeExpired:r,includeExpiredDisabled:d,canCreate:re,migrationResult:S}=this.props,oe=n>0;return(0,e.jsxs)(v.Y,{...se,children:[(0,e.jsxs)(v.Y.Contents,{isLoading:!s,children:[(0,e.jsx)(Y,{onMigrate:this.onMigrateApiKeys,apikeysCount:n}),oe?(0,e.jsx)(F,{searchQuery:c,disabled:!re,onSearchChange:this.onSearchQueryChange}):null,(0,e.jsx)(j.I,{disabled:d,label:(0,t.t)("api-keys.api-keys-page-unconnected.label-include-expired-keys","Include expired keys"),children:(0,e.jsx)(b.K,{id:"showExpired",value:r,onChange:this.onIncludeExpiredChange})}),o.length>0?(0,e.jsx)(O,{apiKeys:o,timeZone:l,onMigrate:this.onMigrateApiKey,onDelete:this.onDeleteApiKey}):(0,e.jsx)(T.p,{variant:"not-found",message:(0,t.t)("api-keys.empty-state.message","No API keys found")})]}),S&&(0,e.jsx)(E,{visible:this.state.showMigrationResult,data:S,onDismiss:this.dismissModal})]})}}const M={migrationSummary:{padding:"20px"},infoText:{color:"#007bff"},summaryDetails:{marginTop:"20px"},summaryParagraph:{margin:"10px 0"}},E=({visible:i,data:s,onDismiss:n})=>(0,e.jsxs)(f.a,{title:(0,t.t)("api-keys.migration-summary.title-migration-summary","Migration summary"),isOpen:i,closeOnBackdropClick:!0,onDismiss:n,children:[s.failedApikeyIDs.length===0&&(0,e.jsxs)("div",{style:M.migrationSummary,children:[(0,e.jsx)("p",{children:(0,e.jsx)(t.x6,{i18nKey:"api-keys.migration-summary.migration-successful",children:"Migration Successful!"})}),(0,e.jsx)("p",{children:(0,e.jsxs)(t.x6,{i18nKey:"api-keys.migration-summary.total",values:{total:s.total},children:[(0,e.jsx)("strong",{children:"Total: "}),"{{total}}"]})}),(0,e.jsx)("p",{children:(0,e.jsxs)(t.x6,{i18nKey:"api-keys.migration-summary.migrated",values:{migrated:s.migrated},children:[(0,e.jsx)("strong",{children:"Migrated: "}),"{{migrated}}"]})})]}),s.failedApikeyIDs.length!==0&&(0,e.jsxs)("div",{style:M.migrationSummary,children:[(0,e.jsx)("p",{children:(0,e.jsx)(t.x6,{i18nKey:"api-keys.migration-summary.migration-complete",children:"Migration complete! Please note, while there might be a few API keys flagged as `failed migrations`, rest assured, all of your API keys are fully functional and operational. Please try again or contact support."})}),(0,e.jsx)("hr",{}),(0,e.jsx)("p",{children:(0,e.jsxs)(t.x6,{i18nKey:"api-keys.migration-summary.total",values:{total:s.total},children:[(0,e.jsx)("strong",{children:"Total: "}),"{{total}}"]})}),(0,e.jsx)("p",{children:(0,e.jsxs)(t.x6,{i18nKey:"api-keys.migration-summary.migrated",values:{migrated:s.migrated},children:[(0,e.jsx)("strong",{children:"Migrated: "}),"{{migrated}}"]})}),(0,e.jsx)("p",{children:(0,e.jsxs)(t.x6,{i18nKey:"api-keys.migration-summary.failed",values:{failed:s.failed},children:[(0,e.jsx)("strong",{children:"Failed: "}),"{{failed}}"]})}),(0,e.jsx)("p",{children:(0,e.jsxs)(t.x6,{i18nKey:"api-keys.migration-summary.failed-ids",values:{ids:s.failedApikeyIDs.join(", ")},children:[(0,e.jsx)("strong",{children:"Failed api key IDs: "}),"{{ids}}"]})}),(0,e.jsx)("p",{children:(0,e.jsxs)(t.x6,{i18nKey:"api-keys.migration-summary.failed-details",values:{details:s.failedDetails.join(", ")},children:[(0,e.jsx)("strong",{children:"Failed details: "}),"{{details}}"]})})]}),(0,e.jsx)(f.a.ButtonRow,{children:(0,e.jsx)(g.$n,{variant:"secondary",onClick:n,children:(0,e.jsx)(t.x6,{i18nKey:"api-keys.migration-summary.close",children:"Close"})})})]}),ne=ae(C)}}]);

//# sourceMappingURL=ApiKeysPage.9c0cf6f568670261e536.js.map